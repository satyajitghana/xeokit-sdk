var t=function(t,e){this.items=t||[],this._lastUniqueId=(e||0)+1};t.prototype.addItem=function(){var t;if(2===arguments.length){var e=arguments[0];if(t=arguments[1],this.items[e])throw"ID clash: '"+e+"'";return this.items[e]=t,e}for(t=arguments[0]||{};;){var i=this._lastUniqueId++;if(!this.items[i])return this.items[i]=t,i}},t.prototype.removeItem=function(t){var e=this.items[t];return delete this.items[t],e};var e=new t,i=function(t){this.id=t,this.parentItem=null,this.groups=[],this.menuElement=null,this.shown=!1,this.mouseOver=0},r=function(){this.items=[]},s=function(t,e,i,r){this.id=t,this.getTitle=e,this.doAction=i,this.getEnabled=r,this.itemElement=null,this.subMenu=null,this.enabled=!0},o=function(t){var i=this;void 0===t&&(t={}),this._id=e.addItem(),this._context=null,this._enabled=!1,this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={},this._shown=!1,this._nextId=0,this._eventSubs={},!1!==t.hideOnMouseDown&&(document.addEventListener("mousedown",(function(t){t.target.classList.contains("xeokit-context-menu-item")||i.hide()})),document.addEventListener("touchstart",this._canvasTouchStartHandler=function(t){t.target.classList.contains("xeokit-context-menu-item")||i.hide()})),t.items&&(this.items=t.items),this.context=t.context,this.enabled=!1!==t.enabled,this.hide()},a={items:{configurable:!0},enabled:{configurable:!0},context:{configurable:!0},shown:{configurable:!0}};o.prototype.on=function(t,e){var i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)},o.prototype.fire=function(t,e){var i=this._eventSubs[t];if(i)for(var r=0,s=i.length;r<s;r++)i[r](e)},a.items.set=function(t){this._clear(),this._itemsCfg=t||[],this._parseItems(t),this._createUI()},a.items.get=function(){return this._itemsCfg},a.enabled.set=function(t){(t=!!t)!==this._enabled&&(this._enabled=t,this._enabled||this.hide())},a.enabled.get=function(){return this._enabled},a.context.set=function(t){this._context=t},a.context.get=function(){return this._context},o.prototype.show=function(t,e){this._context?this._enabled&&(this._shown||(this._hideAllMenus(),this._updateItemsTitles(),this._updateItemsEnabledStatus(),this._showMenu(this._rootMenu.id,t,e),this._shown=!0,this.fire("shown",{}))):console.error("ContextMenu cannot be shown without a context - set context first")},a.shown.get=function(){return this._shown},o.prototype.hide=function(){this._enabled&&this._shown&&(this._hideAllMenus(),this._shown=!1,this.fire("hidden",{}))},o.prototype.destroy=function(){this._context=null,this._clear(),null!==this._id&&(e.removeItem(this._id),this._id=null)},o.prototype._clear=function(){for(var t=0,e=this._menuList.length;t<e;t++){var i=this._menuList[t].menuElement;i.parentElement.removeChild(i)}this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={}},o.prototype._parseItems=function(t){var e=this,o=function(t){for(var a=e._getNextId(),n=new i(a),l=0,h=t.length;l<h;l++){var u=t[l],c=new r;n.groups.push(c);for(var p=function(t,i){var r=u[t],a=r.items,l=a&&a.length>0,h=e._getNextId(),p=r.getTitle||function(){return r.title||""},d=r.doAction||r.callback||function(){},f=r.getEnabled||function(){return!0},_=new s(h,p,d,f);if(_.parentMenu=n,c.items.push(_),l){var g=o(a);_.subMenu=g,g.parentItem=_}e._itemList.push(_),e._itemMap[_.id]=_},d=0,f=u.length;d<f;d++)p(d)}return e._menuList.push(n),e._menuMap[n.id]=n,n};this._rootMenu=o(t)},o.prototype._getNextId=function(){return"ContextMenu_"+this._id+this._nextId++},o.prototype._createUI=function(){var t=this,e=function(i){t._createMenuUI(i);for(var r=i.groups,s=0,o=r.length;s<o;s++)for(var a=r[s].items,n=0,l=a.length;n<l;n++){var h=a[n].subMenu;h&&e(h)}};e(this._rootMenu)},o.prototype._createMenuUI=function(t){var e=t.groups,i=[];if(i.push('<div class="xeokit-context-menu '+t.id+'" style="z-index:300000; position: absolute;">'),i.push("<ul>"),e)for(var r=0,s=e.length;r<s;r++){var o=r,a=s,n=e[r].items;if(n)for(var l=0,h=n.length;l<h;l++){var u=n[l],c=u.subMenu,p=u.title||"";c?i.push('<li id="'+u.id+'" class="xeokit-context-menu-item" style="'+(o===a-1||l<h-1?"border-bottom: 0":"border-bottom: 1px solid black")+'">'+p+" [MORE]</li>"):i.push('<li id="'+u.id+'" class="xeokit-context-menu-item" style="'+(o===a-1||l<h-1?"border-bottom: 0":"border-bottom: 1px solid black")+'">'+p+"</li>")}}i.push("</ul>"),i.push("</div>");var d=i.join("");document.body.insertAdjacentHTML("beforeend",d);var f=document.querySelector("."+t.id);t.menuElement=f,f.style["border-radius"]="4px",f.style.display="none",f.style["z-index"]=3e5,f.style.background="white",f.style.border="1px solid black",f.style["box-shadow"]="0 4px 5px 0 gray",f.oncontextmenu=function(t){t.preventDefault()};var _=this,g=null;if(e)for(var m=0,v=e.length;m<v;m++){var b=e[m].items;if(b)for(var y=function(t,e){var i=b[t],r=i.subMenu;i.itemElement=document.getElementById(i.id),i.itemElement?(i.itemElement.addEventListener("mouseenter",(function(t){if(t.preventDefault(),!1!==i.enabled){var e=i.subMenu;if(e){g&&g.id!==e.id&&(_._hideMenu(g.id),g=null);var r=i.itemElement,s=e.menuElement,o=r.getBoundingClientRect();s.getBoundingClientRect();o.right+200>window.innerWidth?_._showMenu(e.id,o.left-200,o.top-1):_._showMenu(e.id,o.right-5,o.top-1),g=e}else g&&(_._hideMenu(g.id),g=null)}})),r||(i.itemElement.addEventListener("click",(function(t){t.preventDefault(),_.hide(),_._context&&!1!==i.enabled&&i.doAction&&i.doAction(_._context)})),i.itemElement.addEventListener("mouseenter",(function(t){t.preventDefault(),!1!==i.enabled&&i.doHover&&i.doHover(_._context)})))):console.error("ContextMenu item element not found: "+i.id)},P=0,M=b.length;P<M;P++)y(P)}},o.prototype._updateItemsTitles=function(){if(this._context)for(var t=0,e=this._itemList.length;t<e;t++){var i=this._itemList[t],r=i.itemElement;if(r){var s=i.getTitle(this._context);i.subMenu,r.innerText=s}}},o.prototype._updateItemsEnabledStatus=function(){if(this._context)for(var t=0,e=this._itemList.length;t<e;t++){var i=this._itemList[t],r=i.itemElement;if(r){var s=i.getEnabled;if(s){var o=s(this._context);i.enabled=o,o?r.classList.remove("disabled"):r.classList.add("disabled")}}}},o.prototype._showMenu=function(t,e,i){var r=this._menuMap[t];if(r){if(!r.shown){var s=r.menuElement;s&&(this._showMenuElement(s,e,i),r.shown=!0)}}else console.error("Menu not found: "+t)},o.prototype._hideMenu=function(t){var e=this._menuMap[t];if(e){if(e.shown){var i=e.menuElement;i&&(this._hideMenuElement(i),e.shown=!1)}}else console.error("Menu not found: "+t)},o.prototype._hideAllMenus=function(){for(var t=0,e=this._menuList.length;t<e;t++){var i=this._menuList[t];this._hideMenu(i.id)}},o.prototype._showMenuElement=function(t,e,i){t.style.display="block";var r=t.offsetHeight,s=t.offsetWidth;i+r>window.innerHeight&&(i=window.innerHeight-r),e+s>window.innerWidth&&(e=window.innerWidth-s),t.style.left=e+"px",t.style.top=i+"px"},o.prototype._hideMenuElement=function(t){t.style.display="none"},Object.defineProperties(o.prototype,a);var n=function(t,e,i){this.id=i&&i.id?i.id:t,this.viewer=e,this._eventSubs={},e.addPlugin(this)};n.prototype.on=function(t,e){var i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)},n.prototype.fire=function(t,e){var i=this._eventSubs[t];if(i)for(var r=0,s=i.length;r<s;r++)i[r](e)},n.prototype.log=function(t){console.log("[xeokit plugin "+this.id+"]: "+t)},n.prototype.warn=function(t){console.warn("[xeokit plugin "+this.id+"]: "+t)},n.prototype.error=function(t){console.error("[xeokit plugin "+this.id+"]: "+t)},n.prototype.send=function(t,e){},n.prototype.destroy=function(){this.viewer.removePlugin(this)};var l,h,u,c,p,d,f,_,g,m,v,b,y,P=Float64Array,M=new P(16),x=new P(16),w=new P(4),E={MIN_DOUBLE:-Number.MAX_SAFE_INTEGER,MAX_DOUBLE:Number.MAX_SAFE_INTEGER,DEGTORAD:.0174532925,RADTODEG:57.295779513,unglobalizeObjectId:function(t,e){var i=e.indexOf("#");return i===t.length&&e.startsWith(t)?e.substring(i+1):e},globalizeObjectId:function(t,e){return t+"#"+e},vec2:function(t){return new P(t||2)},vec3:function(t){return new P(t||3)},vec4:function(t){return new P(t||4)},mat3:function(t){return new P(t||9)},mat3ToMat4:function(t,e){return void 0===e&&(e=new P(16)),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},mat4:function(t){return new P(t||16)},mat4ToMat3:function(t,e){},doublesToFloats:function(t,e,i){for(var r=new P(2),s=0,o=t.length;s<o;s++)E.splitDouble(t[s],r),e[s]=r[0],i[s]=r[1]},splitDouble:function(t,e){var i=P.from([t])[0],r=t-i;e[0]=i,e[1]=r},createUUID:function(){for(var t=[],e=0;e<256;e++)t[e]=(e<16?"0":"")+e.toString(16);return function(){var e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,r=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return t[255&e]+t[e>>8&255]+t[e>>16&255]+t[e>>24&255]+"-"+t[255&i]+t[i>>8&255]+"-"+t[i>>16&15|64]+t[i>>24&255]+"-"+t[63&r|128]+t[r>>8&255]+"-"+t[r>>16&255]+t[r>>24&255]+t[255&s]+t[s>>8&255]+t[s>>16&255]+t[s>>24&255]}}(),clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},fmod:function(t,e){if(t<e)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),t;for(;e<=t;)t-=e;return t},compareVec3:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},negateVec3:function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},negateVec4:function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},addVec4:function(t,e,i){return i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i},addVec4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i[3]=t[3]+e,i},addVec3:function(t,e,i){return i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i},addVec3Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i},subVec4:function(t,e,i){return i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i},subVec3:function(t,e,i){return i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i},subVec2:function(t,e,i){return i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i},geometricMeanVec2:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];for(var i=new P(t[0]),r=1;r<t.length;r++)i[0]+=t[r][0],i[1]+=t[r][1];return i[0]/=t.length,i[1]/=t.length,i},subVec4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]-e,i[1]=t[1]-e,i[2]=t[2]-e,i[3]=t[3]-e,i},subScalarVec4:function(t,e,i){return i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i},mulVec4:function(t,e,i){return i||(i=t),i[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i[3]=t[3]*e[3],i},mulVec4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i},mulVec3Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i},mulVec2Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i},divVec3:function(t,e,i){return i||(i=t),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i[2]=t[2]/e[2],i},divVec4:function(t,e,i){return i||(i=t),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i[2]=t[2]/e[2],i[3]=t[3]/e[3],i},divScalarVec3:function(t,e,i){return i||(i=e),i[0]=t/e[0],i[1]=t/e[1],i[2]=t/e[2],i},divVec3Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]/e,i[1]=t[1]/e,i[2]=t[2]/e,i},divVec4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]/e,i[1]=t[1]/e,i[2]=t[2]/e,i[3]=t[3]/e,i},divScalarVec4:function(t,e,i){return i||(i=e),i[0]=t/e[0],i[1]=t/e[1],i[2]=t/e[2],i[3]=t/e[3],i},dotVec4:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},cross3Vec4:function(t,e){var i=t[0],r=t[1],s=t[2],o=e[0],a=e[1],n=e[2];return[r*n-s*a,s*o-i*n,i*a-r*o,0]},cross3Vec3:function(t,e,i){i||(i=t);var r=t[0],s=t[1],o=t[2],a=e[0],n=e[1],l=e[2];return i[0]=s*l-o*n,i[1]=o*a-r*l,i[2]=r*n-s*a,i},sqLenVec4:function(t){return E.dotVec4(t,t)},lenVec4:function(t){return Math.sqrt(E.sqLenVec4(t))},dotVec3:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},dotVec2:function(t,e){return t[0]*e[0]+t[1]*e[1]},sqLenVec3:function(t){return E.dotVec3(t,t)},sqLenVec2:function(t){return E.dotVec2(t,t)},lenVec3:function(t){return Math.sqrt(E.sqLenVec3(t))},distVec3:(y=new P(3),function(t,e){return E.lenVec3(E.subVec3(t,e,y))}),lenVec2:function(t){return Math.sqrt(E.sqLenVec2(t))},distVec2:function(){var t=new P(2);return function(e,i){return E.lenVec2(E.subVec2(e,i,t))}}(),rcpVec3:function(t,e){return E.divScalarVec3(1,t,e)},normalizeVec4:function(t,e){var i=1/E.lenVec4(t);return E.mulVec4Scalar(t,i,e)},normalizeVec3:function(t,e){var i=1/E.lenVec3(t);return E.mulVec3Scalar(t,i,e)},normalizeVec2:function(t,e){var i=1/E.lenVec2(t);return E.mulVec2Scalar(t,i,e)},angleVec3:function(t,e){var i=E.dotVec3(t,e)/Math.sqrt(E.sqLenVec3(t)*E.sqLenVec3(e));return i=i<-1?-1:i>1?1:i,Math.acos(i)},vec3FromMat4Scale:function(){var t=new P(3);return function(e,i){return t[0]=e[0],t[1]=e[1],t[2]=e[2],i[0]=E.lenVec3(t),t[0]=e[4],t[1]=e[5],t[2]=e[6],i[1]=E.lenVec3(t),t[0]=e[8],t[1]=e[9],t[2]=e[10],i[2]=E.lenVec3(t),i}}(),vecToArray:function(){function t(t){return Math.round(1e5*t)/1e5}return function(e){for(var i=0,r=(e=Array.prototype.slice.call(e)).length;i<r;i++)e[i]=t(e[i]);return e}}(),xyzArrayToObject:function(t){return{x:t[0],y:t[1],z:t[2]}},xyzObjectToArray:function(t,e){return(e=e||E.vec3())[0]=t.x,e[1]=t.y,e[2]=t.z,e},dupMat4:function(t){return t.slice(0,16)},mat4To3:function(t){return[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]]},m4s:function(t){return[t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t]},setMat4ToZeroes:function(){return E.m4s(0)},setMat4ToOnes:function(){return E.m4s(1)},diagonalMat4v:function(t){return new P([t[0],0,0,0,0,t[1],0,0,0,0,t[2],0,0,0,0,t[3]])},diagonalMat4c:function(t,e,i,r){return E.diagonalMat4v([t,e,i,r])},diagonalMat4s:function(t){return E.diagonalMat4c(t,t,t,t)},identityMat4:function(t){return void 0===t&&(t=new P(16)),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},identityMat3:function(t){return void 0===t&&(t=new P(9)),t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},isIdentityMat4:function(t){return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]},negateMat4:function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e},addMat4:function(t,e,i){return i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i[4]=t[4]+e[4],i[5]=t[5]+e[5],i[6]=t[6]+e[6],i[7]=t[7]+e[7],i[8]=t[8]+e[8],i[9]=t[9]+e[9],i[10]=t[10]+e[10],i[11]=t[11]+e[11],i[12]=t[12]+e[12],i[13]=t[13]+e[13],i[14]=t[14]+e[14],i[15]=t[15]+e[15],i},addMat4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i[3]=t[3]+e,i[4]=t[4]+e,i[5]=t[5]+e,i[6]=t[6]+e,i[7]=t[7]+e,i[8]=t[8]+e,i[9]=t[9]+e,i[10]=t[10]+e,i[11]=t[11]+e,i[12]=t[12]+e,i[13]=t[13]+e,i[14]=t[14]+e,i[15]=t[15]+e,i},addScalarMat4:function(t,e,i){return E.addMat4Scalar(e,t,i)},subMat4:function(t,e,i){return i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i[4]=t[4]-e[4],i[5]=t[5]-e[5],i[6]=t[6]-e[6],i[7]=t[7]-e[7],i[8]=t[8]-e[8],i[9]=t[9]-e[9],i[10]=t[10]-e[10],i[11]=t[11]-e[11],i[12]=t[12]-e[12],i[13]=t[13]-e[13],i[14]=t[14]-e[14],i[15]=t[15]-e[15],i},subMat4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]-e,i[1]=t[1]-e,i[2]=t[2]-e,i[3]=t[3]-e,i[4]=t[4]-e,i[5]=t[5]-e,i[6]=t[6]-e,i[7]=t[7]-e,i[8]=t[8]-e,i[9]=t[9]-e,i[10]=t[10]-e,i[11]=t[11]-e,i[12]=t[12]-e,i[13]=t[13]-e,i[14]=t[14]-e,i[15]=t[15]-e,i},subScalarMat4:function(t,e,i){return i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i[4]=t-e[4],i[5]=t-e[5],i[6]=t-e[6],i[7]=t-e[7],i[8]=t-e[8],i[9]=t-e[9],i[10]=t-e[10],i[11]=t-e[11],i[12]=t-e[12],i[13]=t-e[13],i[14]=t-e[14],i[15]=t-e[15],i},mulMat4:function(t,e,i){i||(i=t);var r=t[0],s=t[1],o=t[2],a=t[3],n=t[4],l=t[5],h=t[6],u=t[7],c=t[8],p=t[9],d=t[10],f=t[11],_=t[12],g=t[13],m=t[14],v=t[15],b=e[0],y=e[1],P=e[2],M=e[3],x=e[4],w=e[5],E=e[6],C=e[7],A=e[8],S=e[9],D=e[10],L=e[11],B=e[12],R=e[13],T=e[14],F=e[15];return i[0]=b*r+y*n+P*c+M*_,i[1]=b*s+y*l+P*p+M*g,i[2]=b*o+y*h+P*d+M*m,i[3]=b*a+y*u+P*f+M*v,i[4]=x*r+w*n+E*c+C*_,i[5]=x*s+w*l+E*p+C*g,i[6]=x*o+w*h+E*d+C*m,i[7]=x*a+w*u+E*f+C*v,i[8]=A*r+S*n+D*c+L*_,i[9]=A*s+S*l+D*p+L*g,i[10]=A*o+S*h+D*d+L*m,i[11]=A*a+S*u+D*f+L*v,i[12]=B*r+R*n+T*c+F*_,i[13]=B*s+R*l+T*p+F*g,i[14]=B*o+R*h+T*d+F*m,i[15]=B*a+R*u+T*f+F*v,i},mulMat3:function(t,e,i){i||(i=new P(9));var r=t[0],s=t[3],o=t[6],a=t[1],n=t[4],l=t[7],h=t[2],u=t[5],c=t[8],p=e[0],d=e[3],f=e[6],_=e[1],g=e[4],m=e[7],v=e[2],b=e[5],y=e[8];return i[0]=r*p+s*_+o*v,i[3]=r*d+s*g+o*b,i[6]=r*f+s*m+o*y,i[1]=a*p+n*_+l*v,i[4]=a*d+n*g+l*b,i[7]=a*f+n*m+l*y,i[2]=h*p+u*_+c*v,i[5]=h*d+u*g+c*b,i[8]=h*f+u*m+c*y,i},mulMat4Scalar:function(t,e,i){return i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i[4]=t[4]*e,i[5]=t[5]*e,i[6]=t[6]*e,i[7]=t[7]*e,i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11]*e,i[12]=t[12]*e,i[13]=t[13]*e,i[14]=t[14]*e,i[15]=t[15]*e,i},mulMat4v4:function(t,e,i){void 0===i&&(i=E.vec4());var r=e[0],s=e[1],o=e[2],a=e[3];return i[0]=t[0]*r+t[4]*s+t[8]*o+t[12]*a,i[1]=t[1]*r+t[5]*s+t[9]*o+t[13]*a,i[2]=t[2]*r+t[6]*s+t[10]*o+t[14]*a,i[3]=t[3]*r+t[7]*s+t[11]*o+t[15]*a,i},transposeMat4:function(t,e){var i=t[4],r=t[14],s=t[8],o=t[13],a=t[12],n=t[9];if(!e||t===e){var l=t[1],h=t[2],u=t[3],c=t[6],p=t[7],d=t[11];return t[1]=i,t[2]=s,t[3]=a,t[4]=l,t[6]=n,t[7]=o,t[8]=h,t[9]=c,t[11]=r,t[12]=u,t[13]=p,t[14]=d,t}return e[0]=t[0],e[1]=i,e[2]=s,e[3]=a,e[4]=t[1],e[5]=t[5],e[6]=n,e[7]=o,e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=r,e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},transposeMat3:function(t,e){if(e===t){var i=t[1],r=t[2],s=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=r,e[7]=s}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},determinantMat4:function(t){var e=t[0],i=t[1],r=t[2],s=t[3],o=t[4],a=t[5],n=t[6],l=t[7],h=t[8],u=t[9],c=t[10],p=t[11],d=t[12],f=t[13],_=t[14],g=t[15];return d*u*n*s-h*f*n*s-d*a*c*s+o*f*c*s+h*a*_*s-o*u*_*s-d*u*r*l+h*f*r*l+d*i*c*l-e*f*c*l-h*i*_*l+e*u*_*l+d*a*r*p-o*f*r*p-d*i*n*p+e*f*n*p+o*i*_*p-e*a*_*p-h*a*r*g+o*u*r*g+h*i*n*g-e*u*n*g-o*i*c*g+e*a*c*g},inverseMat4:function(t,e){e||(e=t);var i=t[0],r=t[1],s=t[2],o=t[3],a=t[4],n=t[5],l=t[6],h=t[7],u=t[8],c=t[9],p=t[10],d=t[11],f=t[12],_=t[13],g=t[14],m=t[15],v=i*n-r*a,b=i*l-s*a,y=i*h-o*a,P=r*l-s*n,M=r*h-o*n,x=s*h-o*l,w=u*_-c*f,E=u*g-p*f,C=u*m-d*f,A=c*g-p*_,S=c*m-d*_,D=p*m-d*g,L=1/(v*D-b*S+y*A+P*C-M*E+x*w);return e[0]=(n*D-l*S+h*A)*L,e[1]=(-r*D+s*S-o*A)*L,e[2]=(_*x-g*M+m*P)*L,e[3]=(-c*x+p*M-d*P)*L,e[4]=(-a*D+l*C-h*E)*L,e[5]=(i*D-s*C+o*E)*L,e[6]=(-f*x+g*y-m*b)*L,e[7]=(u*x-p*y+d*b)*L,e[8]=(a*S-n*C+h*w)*L,e[9]=(-i*S+r*C-o*w)*L,e[10]=(f*M-_*y+m*v)*L,e[11]=(-u*M+c*y-d*v)*L,e[12]=(-a*A+n*E-l*w)*L,e[13]=(i*A-r*E+s*w)*L,e[14]=(-f*P+_*b-g*v)*L,e[15]=(u*P-c*b+p*v)*L,e},traceMat4:function(t){return t[0]+t[5]+t[10]+t[15]},translationMat4v:function(t,e){var i=e||E.identityMat4();return i[12]=t[0],i[13]=t[1],i[14]=t[2],i},translationMat3v:function(t,e){var i=e||E.identityMat3();return i[6]=t[0],i[7]=t[1],i},translationMat4c:(b=new P(3),function(t,e,i,r){return b[0]=t,b[1]=e,b[2]=i,E.translationMat4v(b,r)}),translationMat4s:function(t,e){return E.translationMat4c(t,t,t,e)},translateMat4v:function(t,e){return E.translateMat4c(t[0],t[1],t[2],e)},OLDtranslateMat4c:function(t,e,i,r){var s=r[12];r[0]+=s*t,r[4]+=s*e,r[8]+=s*i;var o=r[13];r[1]+=o*t,r[5]+=o*e,r[9]+=o*i;var a=r[14];r[2]+=a*t,r[6]+=a*e,r[10]+=a*i;var n=r[15];return r[3]+=n*t,r[7]+=n*e,r[11]+=n*i,r},translateMat4c:function(t,e,i,r){var s=r[3];r[0]+=s*t,r[1]+=s*e,r[2]+=s*i;var o=r[7];r[4]+=o*t,r[5]+=o*e,r[6]+=o*i;var a=r[11];r[8]+=a*t,r[9]+=a*e,r[10]+=a*i;var n=r[15];return r[12]+=n*t,r[13]+=n*e,r[14]+=n*i,r},setMat4Translation:function(t,e,i){return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=t[15],i},rotationMat4v:function(t,e,i){var r,s,o,a,n,l,h=E.normalizeVec4([e[0],e[1],e[2],0],[]),u=Math.sin(t),c=Math.cos(t),p=1-c,d=h[0],f=h[1],_=h[2];return r=d*f,s=f*_,o=_*d,a=d*u,n=f*u,l=_*u,(i=i||E.mat4())[0]=p*d*d+c,i[1]=p*r+l,i[2]=p*o-n,i[3]=0,i[4]=p*r-l,i[5]=p*f*f+c,i[6]=p*s+a,i[7]=0,i[8]=p*o+n,i[9]=p*s-a,i[10]=p*_*_+c,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:function(t,e,i,r,s){return E.rotationMat4v(t,[e,i,r],s)},scalingMat4v:function(t,e){return void 0===e&&(e=E.identityMat4()),e[0]=t[0],e[5]=t[1],e[10]=t[2],e},scalingMat3v:function(t,e){return void 0===e&&(e=E.identityMat3()),e[0]=t[0],e[4]=t[1],e},scalingMat4c:function(){var t=new P(3);return function(e,i,r,s){return t[0]=e,t[1]=i,t[2]=r,E.scalingMat4v(t,s)}}(),scaleMat4c:function(t,e,i,r){return r[0]*=t,r[4]*=e,r[8]*=i,r[1]*=t,r[5]*=e,r[9]*=i,r[2]*=t,r[6]*=e,r[10]*=i,r[3]*=t,r[7]*=e,r[11]*=i,r},scaleMat4v:function(t,e){var i=t[0],r=t[1],s=t[2];return e[0]*=i,e[4]*=r,e[8]*=s,e[1]*=i,e[5]*=r,e[9]*=s,e[2]*=i,e[6]*=r,e[10]*=s,e[3]*=i,e[7]*=r,e[11]*=s,e},scalingMat4s:function(t){return E.scalingMat4c(t,t,t)},rotationTranslationMat4:function(t,e,i){void 0===i&&(i=E.mat4());var r=t[0],s=t[1],o=t[2],a=t[3],n=r+r,l=s+s,h=o+o,u=r*n,c=r*l,p=r*h,d=s*l,f=s*h,_=o*h,g=a*n,m=a*l,v=a*h;return i[0]=1-(d+_),i[1]=c+v,i[2]=p-m,i[3]=0,i[4]=c-v,i[5]=1-(u+_),i[6]=f+g,i[7]=0,i[8]=p+m,i[9]=f-g,i[10]=1-(u+d),i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i},mat4ToEuler:function(t,e,i){void 0===i&&(i=E.vec4());var r=E.clamp,s=t[0],o=t[4],a=t[8],n=t[1],l=t[5],h=t[9],u=t[2],c=t[6],p=t[10];return"XYZ"===e?(i[1]=Math.asin(r(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(-h,p),i[2]=Math.atan2(-o,s)):(i[0]=Math.atan2(c,l),i[2]=0)):"YXZ"===e?(i[0]=Math.asin(-r(h,-1,1)),Math.abs(h)<.99999?(i[1]=Math.atan2(a,p),i[2]=Math.atan2(n,l)):(i[1]=Math.atan2(-u,s),i[2]=0)):"ZXY"===e?(i[0]=Math.asin(r(c,-1,1)),Math.abs(c)<.99999?(i[1]=Math.atan2(-u,p),i[2]=Math.atan2(-o,l)):(i[1]=0,i[2]=Math.atan2(n,s))):"ZYX"===e?(i[1]=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(i[0]=Math.atan2(c,p),i[2]=Math.atan2(n,s)):(i[0]=0,i[2]=Math.atan2(-o,l))):"YZX"===e?(i[2]=Math.asin(r(n,-1,1)),Math.abs(n)<.99999?(i[0]=Math.atan2(-h,l),i[1]=Math.atan2(-u,s)):(i[0]=0,i[1]=Math.atan2(a,p))):"XZY"===e&&(i[2]=Math.asin(-r(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(c,l),i[1]=Math.atan2(a,s)):(i[0]=Math.atan2(-h,p),i[1]=0)),i},composeMat4:function(t,e,i,r){return void 0===r&&(r=E.mat4()),E.quaternionToRotationMat4(e,r),E.scaleMat4v(i,r),E.translateMat4v(t,r),r},decomposeMat4:function(){var t=new P(3),e=new P(16);return function(i,r,s,o){t[0]=i[0],t[1]=i[1],t[2]=i[2];var a=E.lenVec3(t);t[0]=i[4],t[1]=i[5],t[2]=i[6];var n=E.lenVec3(t);t[8]=i[8],t[9]=i[9],t[10]=i[10];var l=E.lenVec3(t);E.determinantMat4(i)<0&&(a=-a),r[0]=i[12],r[1]=i[13],r[2]=i[14],e.set(i);var h=1/a,u=1/n,c=1/l;return e[0]*=h,e[1]*=h,e[2]*=h,e[4]*=u,e[5]*=u,e[6]*=u,e[8]*=c,e[9]*=c,e[10]*=c,E.mat4ToQuaternion(e,s),o[0]=a,o[1]=n,o[2]=l,this}}(),getColMat4:function(t,e){var i=4*e;return[t[i],t[i+1],t[i+2],t[i+3]]},setRowMat4:function(t,e,i){t[e]=i[0],t[e+4]=i[1],t[e+8]=i[2],t[e+12]=i[3]},lookAtMat4v:function(t,e,i,r){r||(r=E.mat4());var s,o,a,n,l,h,u,c,p,d,f=t[0],_=t[1],g=t[2],m=i[0],v=i[1],b=i[2],y=e[0],P=e[1],M=e[2];return f===y&&_===P&&g===M?E.identityMat4():(s=f-y,o=_-P,a=g-M,n=v*(a*=d=1/Math.sqrt(s*s+o*o+a*a))-b*(o*=d),l=b*(s*=d)-m*a,h=m*o-v*s,(d=Math.sqrt(n*n+l*l+h*h))?(n*=d=1/d,l*=d,h*=d):(n=0,l=0,h=0),u=o*h-a*l,c=a*n-s*h,p=s*l-o*n,(d=Math.sqrt(u*u+c*c+p*p))?(u*=d=1/d,c*=d,p*=d):(u=0,c=0,p=0),r[0]=n,r[1]=u,r[2]=s,r[3]=0,r[4]=l,r[5]=c,r[6]=o,r[7]=0,r[8]=h,r[9]=p,r[10]=a,r[11]=0,r[12]=-(n*f+l*_+h*g),r[13]=-(u*f+c*_+p*g),r[14]=-(s*f+o*_+a*g),r[15]=1,r)},lookAtMat4c:function(t,e,i,r,s,o,a,n,l){return E.lookAtMat4v([t,e,i],[r,s,o],[a,n,l],[])},orthoMat4c:function(t,e,i,r,s,o,a){a||(a=E.mat4());var n=e-t,l=r-i,h=o-s;return a[0]=2/n,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/l,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/h,a[11]=0,a[12]=-(t+e)/n,a[13]=-(r+i)/l,a[14]=-(o+s)/h,a[15]=1,a},frustumMat4v:function(t,e,i){i||(i=E.mat4());var r=[t[0],t[1],t[2],0],s=[e[0],e[1],e[2],0];E.addVec4(s,r,M),E.subVec4(s,r,x);var o=2*r[2],a=x[0],n=x[1],l=x[2];return i[0]=o/a,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=o/n,i[6]=0,i[7]=0,i[8]=M[0]/a,i[9]=M[1]/n,i[10]=-M[2]/l,i[11]=-1,i[12]=0,i[13]=0,i[14]=-o*s[2]/l,i[15]=0,i},frustumMat4:function(t,e,i,r,s,o,a){a||(a=E.mat4());var n=e-t,l=r-i,h=o-s;return a[0]=2*s/n,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*s/l,a[6]=0,a[7]=0,a[8]=(e+t)/n,a[9]=(r+i)/l,a[10]=-(o+s)/h,a[11]=-1,a[12]=0,a[13]=0,a[14]=-o*s*2/h,a[15]=0,a},perspectiveMat4:function(t,e,i,r,s){var o=[],a=[];return o[2]=i,a[2]=r,a[1]=o[2]*Math.tan(t/2),o[1]=-a[1],a[0]=a[1]*e,o[0]=-a[0],E.frustumMat4v(o,a,s)},compareMat4:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},transformPoint3:function(t,e,i){void 0===i&&(i=E.vec3());var r=e[0],s=e[1],o=e[2];return i[0]=t[0]*r+t[4]*s+t[8]*o+t[12],i[1]=t[1]*r+t[5]*s+t[9]*o+t[13],i[2]=t[2]*r+t[6]*s+t[10]*o+t[14],i},transformPoint4:function(t,e,i){return void 0===i&&(i=E.vec4()),i[0]=t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12]*e[3],i[1]=t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13]*e[3],i[2]=t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14]*e[3],i[3]=t[3]*e[0]+t[7]*e[1]+t[11]*e[2]+t[15]*e[3],i},transformPoints3:function(t,e,i){for(var r,s,o,a,n,l=i||[],h=e.length,u=t[0],c=t[1],p=t[2],d=t[3],f=t[4],_=t[5],g=t[6],m=t[7],v=t[8],b=t[9],y=t[10],P=t[11],M=t[12],x=t[13],w=t[14],E=t[15],C=0;C<h;++C)r=(a=e[C])[0],s=a[1],o=a[2],(n=l[C]||(l[C]=[0,0,0]))[0]=u*r+f*s+v*o+M,n[1]=c*r+_*s+b*o+x,n[2]=p*r+g*s+y*o+w,n[3]=d*r+m*s+P*o+E;return l.length=h,l},transformPositions3:function(t,e,i){var r;void 0===i&&(i=e);var s,o,a,n=e.length,l=t[0],h=t[1],u=t[2],c=t[3],p=t[4],d=t[5],f=t[6],_=t[7],g=t[8],m=t[9],v=t[10],b=t[11],y=t[12],P=t[13],M=t[14],x=t[15];for(r=0;r<n;r+=3)s=e[r+0],o=e[r+1],a=e[r+2],i[r+0]=l*s+p*o+g*a+y,i[r+1]=h*s+d*o+m*a+P,i[r+2]=u*s+f*o+v*a+M,i[r+3]=c*s+_*o+b*a+x;return i},transformPositions4:function(t,e,i){var r;void 0===i&&(i=e);var s,o,a,n=e.length,l=t[0],h=t[1],u=t[2],c=t[3],p=t[4],d=t[5],f=t[6],_=t[7],g=t[8],m=t[9],v=t[10],b=t[11],y=t[12],P=t[13],M=t[14],x=t[15];for(r=0;r<n;r+=4)s=e[r+0],o=e[r+1],a=e[r+2],i[r+0]=l*s+p*o+g*a+y,i[r+1]=h*s+d*o+m*a+P,i[r+2]=u*s+f*o+v*a+M,i[r+3]=c*s+_*o+b*a+x;return i},transformVec3:function(t,e,i){var r=e[0],s=e[1],o=e[2];return(i=i||this.vec3())[0]=t[0]*r+t[4]*s+t[8]*o,i[1]=t[1]*r+t[5]*s+t[9]*o,i[2]=t[2]*r+t[6]*s+t[10]*o,i},transformVec4:function(t,e,i){var r=e[0],s=e[1],o=e[2],a=e[3];return(i=i||E.vec4())[0]=t[0]*r+t[4]*s+t[8]*o+t[12]*a,i[1]=t[1]*r+t[5]*s+t[9]*o+t[13]*a,i[2]=t[2]*r+t[6]*s+t[10]*o+t[14]*a,i[3]=t[3]*r+t[7]*s+t[11]*o+t[15]*a,i},rotateVec3X:function(t,e,i,r){var s=[],o=[];return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],o[0]=s[0],o[1]=s[1]*Math.cos(i)-s[2]*Math.sin(i),o[2]=s[1]*Math.sin(i)+s[2]*Math.cos(i),r[0]=o[0]+e[0],r[1]=o[1]+e[1],r[2]=o[2]+e[2],r},rotateVec3Y:function(t,e,i,r){var s=[],o=[];return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],o[0]=s[2]*Math.sin(i)+s[0]*Math.cos(i),o[1]=s[1],o[2]=s[2]*Math.cos(i)-s[0]*Math.sin(i),r[0]=o[0]+e[0],r[1]=o[1]+e[1],r[2]=o[2]+e[2],r},rotateVec3Z:function(t,e,i,r){var s=[],o=[];return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],o[0]=s[0]*Math.cos(i)-s[1]*Math.sin(i),o[1]=s[0]*Math.sin(i)+s[1]*Math.cos(i),o[2]=s[2],r[0]=o[0]+e[0],r[1]=o[1]+e[1],r[2]=o[2]+e[2],r},projectVec4:function(t,e){var i=1/t[3];return(e=e||E.vec2())[0]=t[0]*i,e[1]=t[1]*i,e},unprojectVec3:(g=new P(16),m=new P(16),v=new P(16),function(t,e,i,r){return this.transformVec3(this.mulMat4(this.inverseMat4(e,g),this.inverseMat4(i,m),v),t,r)}),lerpVec3:function(t,e,i,r,s,o){var a=o||E.vec3(),n=(t-e)/(i-e);return a[0]=r[0]+n*(s[0]-r[0]),a[1]=r[1]+n*(s[1]-r[1]),a[2]=r[2]+n*(s[2]-r[2]),a},lerpMat4:function(t,e,i,r,s,o){var a=o||E.mat4(),n=(t-e)/(i-e);return a[0]=r[0]+n*(s[0]-r[0]),a[1]=r[1]+n*(s[1]-r[1]),a[2]=r[2]+n*(s[2]-r[2]),a[3]=r[3]+n*(s[3]-r[3]),a[4]=r[4]+n*(s[4]-r[4]),a[5]=r[5]+n*(s[5]-r[5]),a[6]=r[6]+n*(s[6]-r[6]),a[7]=r[7]+n*(s[7]-r[7]),a[8]=r[8]+n*(s[8]-r[8]),a[9]=r[9]+n*(s[9]-r[9]),a[10]=r[10]+n*(s[10]-r[10]),a[11]=r[11]+n*(s[11]-r[11]),a[12]=r[12]+n*(s[12]-r[12]),a[13]=r[13]+n*(s[13]-r[13]),a[14]=r[14]+n*(s[14]-r[14]),a[15]=r[15]+n*(s[15]-r[15]),a},flatten:function(t){var e,i,r,s,o,a=[];for(e=0,i=t.length;e<i;e++)for(r=0,s=(o=t[e]).length;r<s;r++)a.push(o[r]);return a},identityQuaternion:function(t){return void 0===t&&(t=E.vec4()),t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},eulerToQuaternion:function(t,e,i){void 0===i&&(i=E.vec4());var r=t[0]*E.DEGTORAD/2,s=t[1]*E.DEGTORAD/2,o=t[2]*E.DEGTORAD/2,a=Math.cos(r),n=Math.cos(s),l=Math.cos(o),h=Math.sin(r),u=Math.sin(s),c=Math.sin(o);return"XYZ"===e?(i[0]=h*n*l+a*u*c,i[1]=a*u*l-h*n*c,i[2]=a*n*c+h*u*l,i[3]=a*n*l-h*u*c):"YXZ"===e?(i[0]=h*n*l+a*u*c,i[1]=a*u*l-h*n*c,i[2]=a*n*c-h*u*l,i[3]=a*n*l+h*u*c):"ZXY"===e?(i[0]=h*n*l-a*u*c,i[1]=a*u*l+h*n*c,i[2]=a*n*c+h*u*l,i[3]=a*n*l-h*u*c):"ZYX"===e?(i[0]=h*n*l-a*u*c,i[1]=a*u*l+h*n*c,i[2]=a*n*c-h*u*l,i[3]=a*n*l+h*u*c):"YZX"===e?(i[0]=h*n*l+a*u*c,i[1]=a*u*l+h*n*c,i[2]=a*n*c-h*u*l,i[3]=a*n*l-h*u*c):"XZY"===e&&(i[0]=h*n*l-a*u*c,i[1]=a*u*l-h*n*c,i[2]=a*n*c+h*u*l,i[3]=a*n*l+h*u*c),i},mat4ToQuaternion:function(t,e){void 0===e&&(e=E.vec4());var i,r=t[0],s=t[4],o=t[8],a=t[1],n=t[5],l=t[9],h=t[2],u=t[6],c=t[10],p=r+n+c;return p>0?(i=.5/Math.sqrt(p+1),e[3]=.25/i,e[0]=(u-l)*i,e[1]=(o-h)*i,e[2]=(a-s)*i):r>n&&r>c?(i=2*Math.sqrt(1+r-n-c),e[3]=(u-l)/i,e[0]=.25*i,e[1]=(s+a)/i,e[2]=(o+h)/i):n>c?(i=2*Math.sqrt(1+n-r-c),e[3]=(o-h)/i,e[0]=(s+a)/i,e[1]=.25*i,e[2]=(l+u)/i):(i=2*Math.sqrt(1+c-r-n),e[3]=(a-s)/i,e[0]=(o+h)/i,e[1]=(l+u)/i,e[2]=.25*i),e},vec3PairToQuaternion:function(t,e,i){void 0===i&&(i=E.vec4());var r=Math.sqrt(E.dotVec3(t,t)*E.dotVec3(e,e)),s=r+E.dotVec3(t,e);return s<1e-8*r?(s=0,Math.abs(t[0])>Math.abs(t[2])?(i[0]=-t[1],i[1]=t[0],i[2]=0):(i[0]=0,i[1]=-t[2],i[2]=t[1])):E.cross3Vec3(t,e,i),i[3]=s,E.normalizeQuaternion(i)},angleAxisToQuaternion:function(t,e){void 0===e&&(e=E.vec4());var i=t[3]/2,r=Math.sin(i);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(i),e},quaternionToEuler:function(){var t=new P(16);return function(e,i,r){return r=r||E.vec3(),E.quaternionToRotationMat4(e,t),E.mat4ToEuler(t,i,r),r}}(),mulQuaternions:function(t,e,i){void 0===i&&(i=E.vec4());var r=t[0],s=t[1],o=t[2],a=t[3],n=e[0],l=e[1],h=e[2],u=e[3];return i[0]=a*n+r*u+s*h-o*l,i[1]=a*l+s*u+o*n-r*h,i[2]=a*h+o*u+r*l-s*n,i[3]=a*u-r*n-s*l-o*h,i},vec3ApplyQuaternion:function(t,e,i){void 0===i&&(i=E.vec3());var r=e[0],s=e[1],o=e[2],a=t[0],n=t[1],l=t[2],h=t[3],u=h*r+n*o-l*s,c=h*s+l*r-a*o,p=h*o+a*s-n*r,d=-a*r-n*s-l*o;return i[0]=u*h+d*-a+c*-l-p*-n,i[1]=c*h+d*-n+p*-a-u*-l,i[2]=p*h+d*-l+u*-n-c*-a,i},quaternionToMat4:function(t,e){e=E.identityMat4(e);var i=t[0],r=t[1],s=t[2],o=t[3],a=2*i,n=2*r,l=2*s,h=a*o,u=n*o,c=l*o,p=a*i,d=n*i,f=l*i,_=n*r,g=l*r,m=l*s;return e[0]=1-(_+m),e[1]=d+c,e[2]=f-u,e[4]=d-c,e[5]=1-(p+m),e[6]=g+h,e[8]=f+u,e[9]=g-h,e[10]=1-(p+_),e},quaternionToRotationMat4:function(t,e){var i=t[0],r=t[1],s=t[2],o=t[3],a=i+i,n=r+r,l=s+s,h=i*a,u=i*n,c=i*l,p=r*n,d=r*l,f=s*l,_=o*a,g=o*n,m=o*l;return e[0]=1-(p+f),e[4]=u-m,e[8]=c+g,e[1]=u+m,e[5]=1-(h+f),e[9]=d-_,e[2]=c-g,e[6]=d+_,e[10]=1-(h+p),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},normalizeQuaternion:function(t,e){void 0===e&&(e=t);var i=E.lenVec4([t[0],t[1],t[2],t[3]]);return e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i,e[3]=t[3]/i,e},conjugateQuaternion:function(t,e){return void 0===e&&(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},inverseQuaternion:function(t,e){return E.normalizeQuaternion(E.conjugateQuaternion(t,e))},quaternionToAngleAxis:function(t,e){void 0===e&&(e=E.vec4());var i=(t=E.normalizeQuaternion(t,w))[3],r=2*Math.acos(i),s=Math.sqrt(1-i*i);return s<.001?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=t[0]/s,e[1]=t[1]/s,e[2]=t[2]/s),e[3]=r,e},AABB3:function(t){return new P(t||6)},AABB2:function(t){return new P(t||4)},OBB3:function(t){return new P(t||32)},OBB2:function(t){return new P(t||16)},Sphere3:function(t,e,i,r){return new P([t,e,i,r])},transformOBB3:function(t,e,i){var r;void 0===i&&(i=e);var s,o,a,n=e.length,l=t[0],h=t[1],u=t[2],c=t[3],p=t[4],d=t[5],f=t[6],_=t[7],g=t[8],m=t[9],v=t[10],b=t[11],y=t[12],P=t[13],M=t[14],x=t[15];for(r=0;r<n;r+=4)s=e[r+0],o=e[r+1],a=e[r+2],i[r+0]=l*s+p*o+g*a+y,i[r+1]=h*s+d*o+m*a+P,i[r+2]=u*s+f*o+v*a+M,i[r+3]=c*s+_*o+b*a+x;return i},containsAABB3:function(t,e){return t[0]<=e[0]&&e[3]<=t[3]&&t[1]<=e[1]&&e[4]<=t[4]&&t[2]<=e[2]&&e[5]<=t[5]},getAABB3Diag:function(){var t=new P(3),e=new P(3),i=new P(3);return function(r){return t[0]=r[0],t[1]=r[1],t[2]=r[2],e[0]=r[3],e[1]=r[4],e[2]=r[5],E.subVec3(e,t,i),Math.abs(E.lenVec3(i))}}(),getAABB3DiagPoint:function(){var t=new P(3),e=new P(3),i=new P(3);return function(r,s){t[0]=r[0],t[1]=r[1],t[2]=r[2],e[0]=r[3],e[1]=r[4],e[2]=r[5];var o=E.subVec3(e,t,i),a=s[0]-r[0],n=r[3]-s[0],l=s[1]-r[1],h=r[4]-s[1],u=s[2]-r[2],c=r[5]-s[2];return o[0]+=a>n?a:n,o[1]+=l>h?l:h,o[2]+=u>c?u:c,Math.abs(E.lenVec3(o))}}(),getAABB3Area:function(t){return(t[3]-t[0])*(t[4]-t[1])*(t[5]-t[2])},getAABB3Center:function(t,e){var i=e||E.vec3();return i[0]=(t[0]+t[3])/2,i[1]=(t[1]+t[4])/2,i[2]=(t[2]+t[5])/2,i},getAABB2Center:function(t,e){var i=e||E.vec2();return i[0]=(t[2]+t[0])/2,i[1]=(t[3]+t[1])/2,i},collapseAABB3:function(t){return void 0===t&&(t=E.AABB3()),t[0]=E.MAX_DOUBLE,t[1]=E.MAX_DOUBLE,t[2]=E.MAX_DOUBLE,t[3]=E.MIN_DOUBLE,t[4]=E.MIN_DOUBLE,t[5]=E.MIN_DOUBLE,t},AABB3ToOBB3:function(t,e){return void 0===e&&(e=E.OBB3()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=1,e[4]=t[3],e[5]=t[1],e[6]=t[2],e[7]=1,e[8]=t[3],e[9]=t[4],e[10]=t[2],e[11]=1,e[12]=t[0],e[13]=t[4],e[14]=t[2],e[15]=1,e[16]=t[0],e[17]=t[1],e[18]=t[5],e[19]=1,e[20]=t[3],e[21]=t[1],e[22]=t[5],e[23]=1,e[24]=t[3],e[25]=t[4],e[26]=t[5],e[27]=1,e[28]=t[0],e[29]=t[4],e[30]=t[5],e[31]=1,e},positions3ToAABB3:function(){var t=new P(3);return function(e,i,r){i=i||E.AABB3();for(var s,o,a,n=E.MAX_DOUBLE,l=E.MAX_DOUBLE,h=E.MAX_DOUBLE,u=E.MIN_DOUBLE,c=E.MIN_DOUBLE,p=E.MIN_DOUBLE,d=0,f=e.length;d<f;d+=3)r?(t[0]=e[d+0],t[1]=e[d+1],t[2]=e[d+2],E.decompressPosition(t,r,t),s=t[0],o=t[1],a=t[2]):(s=e[d+0],o=e[d+1],a=e[d+2]),s<n&&(n=s),o<l&&(l=o),a<h&&(h=a),s>u&&(u=s),o>c&&(c=o),a>p&&(p=a);return i[0]=n,i[1]=l,i[2]=h,i[3]=u,i[4]=c,i[5]=p,i}}(),OBB3ToAABB3:function(t,e){void 0===e&&(e=E.AABB3());for(var i,r,s,o=E.MAX_DOUBLE,a=E.MAX_DOUBLE,n=E.MAX_DOUBLE,l=E.MIN_DOUBLE,h=E.MIN_DOUBLE,u=E.MIN_DOUBLE,c=0,p=t.length;c<p;c+=4)(i=t[c+0])<o&&(o=i),(r=t[c+1])<a&&(a=r),(s=t[c+2])<n&&(n=s),i>l&&(l=i),r>h&&(h=r),s>u&&(u=s);return e[0]=o,e[1]=a,e[2]=n,e[3]=l,e[4]=h,e[5]=u,e},points3ToAABB3:function(t,e){void 0===e&&(e=E.AABB3());for(var i,r,s,o=E.MAX_DOUBLE,a=E.MAX_DOUBLE,n=E.MAX_DOUBLE,l=E.MIN_DOUBLE,h=E.MIN_DOUBLE,u=E.MIN_DOUBLE,c=0,p=t.length;c<p;c++)(i=t[c][0])<o&&(o=i),(r=t[c][1])<a&&(a=r),(s=t[c][2])<n&&(n=s),i>l&&(l=i),r>h&&(h=r),s>u&&(u=s);return e[0]=o,e[1]=a,e[2]=n,e[3]=l,e[4]=h,e[5]=u,e},points3ToSphere3:function(){var t=new P(3);return function(e,i){i=i||E.vec4();var r,s=0,o=0,a=0,n=e.length;for(r=0;r<n;r++)s+=e[r][0],o+=e[r][1],a+=e[r][2];i[0]=s/n,i[1]=o/n,i[2]=a/n;var l,h=0;for(r=0;r<n;r++)(l=Math.abs(E.lenVec3(E.subVec3(e[r],i,t))))>h&&(h=l);return i[3]=h,i}}(),positions3ToSphere3:function(){var t=new P(3),e=new P(3);return function(i,r){r=r||E.vec4();var s,o=0,a=0,n=0,l=i.length,h=0;for(s=0;s<l;s+=3)o+=i[s],a+=i[s+1],n+=i[s+2];var u,c=l/3;for(r[0]=o/c,r[1]=a/c,r[2]=n/c,s=0;s<l;s+=3)t[0]=i[s],t[1]=i[s+1],t[2]=i[s+2],(u=Math.abs(E.lenVec3(E.subVec3(t,r,e))))>h&&(h=u);return r[3]=h,r}}(),OBB3ToSphere3:function(){var t=new P(3),e=new P(3);return function(i,r){r=r||E.vec4();var s,o=0,a=0,n=0,l=i.length,h=l/4;for(s=0;s<l;s+=4)o+=i[s+0],a+=i[s+1],n+=i[s+2];r[0]=o/h,r[1]=a/h,r[2]=n/h;var u,c=0;for(s=0;s<l;s+=4)t[0]=i[s+0],t[1]=i[s+1],t[2]=i[s+2],(u=Math.abs(E.lenVec3(E.subVec3(t,r,e))))>c&&(c=u);return r[3]=c,r}}(),getSphere3Center:function(t,e){return void 0===e&&(e=E.vec3()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e},getPositionsCenter:function(t,e){void 0===e&&(e=E.vec3());for(var i=0,r=0,s=0,o=0,a=t.length;o<a;o+=3)i+=t[o+0],r+=t[o+1],s+=t[o+2];var n=t.length/3;return e[0]=i/n,e[1]=r/n,e[2]=s/n,e},expandAABB3:function(t,e){return t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]>e[2]&&(t[2]=e[2]),t[3]<e[3]&&(t[3]=e[3]),t[4]<e[4]&&(t[4]=e[4]),t[5]<e[5]&&(t[5]=e[5]),t},expandAABB3Point3:function(t,e){return t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]>e[2]&&(t[2]=e[2]),t[3]<e[0]&&(t[3]=e[0]),t[4]<e[1]&&(t[4]=e[1]),t[5]<e[2]&&(t[5]=e[2]),t},expandAABB3Points3:function(t,e){for(var i,r,s,o=0,a=e.length;o<a;o+=3)i=e[o],r=e[o+1],s=e[o+2],t[0]>i&&(t[0]=i),t[1]>r&&(t[1]=r),t[2]>s&&(t[2]=s),t[3]<i&&(t[3]=i),t[4]<r&&(t[4]=r),t[5]<s&&(t[5]=s);return t},collapseAABB2:function(t){return void 0===t&&(t=E.AABB2()),t[0]=E.MAX_DOUBLE,t[1]=E.MAX_DOUBLE,t[2]=E.MIN_DOUBLE,t[3]=E.MIN_DOUBLE,t},point3AABB3Intersect:function(t,e){return t[0]>e[0]||t[3]<e[0]||t[1]>e[1]||t[4]<e[1]||t[2]>e[2]||t[5]<e[2]},planeAABB3Intersect:function(t,e,i){var r,s;return t[0]>0?(r=t[0]*i[0],s=t[0]*i[3]):(r=t[0]*i[3],s=t[0]*i[0]),t[1]>0?(r+=t[1]*i[1],s+=t[1]*i[4]):(r+=t[1]*i[4],s+=t[1]*i[1]),t[2]>0?(r+=t[2]*i[2],s+=t[2]*i[5]):(r+=t[2]*i[5],s+=t[2]*i[2]),r<=-e&&s<=-e?-1:r>=-e&&s>=-e?1:0},OBB3ToAABB2:function(t,e){void 0===e&&(e=E.AABB2());for(var i,r,s,o=E.MAX_DOUBLE,a=E.MAX_DOUBLE,n=E.MIN_DOUBLE,l=E.MIN_DOUBLE,h=0,u=t.length;h<u;h+=4)i=t[h+0],r=t[h+1],(i*=s=1/(t[h+3]||1))<o&&(o=i),(r*=s)<a&&(a=r),i>n&&(n=i),r>l&&(l=r);return e[0]=o,e[1]=a,e[2]=n,e[3]=l,e},expandAABB2:function(t,e){return t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[2]&&(t[2]=e[2]),t[3]<e[3]&&(t[3]=e[3]),t},expandAABB2Point2:function(t,e){return t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[0]&&(t[2]=e[0]),t[3]<e[1]&&(t[3]=e[1]),t},AABB2ToCanvas:function(t,e,i,r){void 0===r&&(r=t);var s=.5*(t[0]+1),o=.5*(t[1]+1),a=.5*(t[2]+1),n=.5*(t[3]+1);return r[0]=Math.floor(s*e),r[1]=i-Math.floor(n*i),r[2]=Math.floor(a*e),r[3]=i-Math.floor(o*i),r},tangentQuadraticBezier:function(t,e,i,r){return 2*(1-t)*(i-e)+2*t*(r-i)},tangentQuadraticBezier3:function(t,e,i,r,s){return-3*e*(1-t)*(1-t)+3*i*(1-t)*(1-t)-6*t*i*(1-t)+6*t*r*(1-t)-3*t*t*r+3*t*t*s},tangentSpline:function(t){return 6*t*t-6*t+(3*t*t-4*t+1)+(-6*t*t+6*t)+(3*t*t-2*t)},catmullRomInterpolate:function(t,e,i,r,s){var o=.5*(i-t),a=.5*(r-e),n=s*s;return(2*e-2*i+o+a)*(s*n)+(-3*e+3*i-2*o-a)*n+o*s+e},b2p0:function(t,e){var i=1-t;return i*i*e},b2p1:function(t,e){return 2*(1-t)*t*e},b2p2:function(t,e){return t*t*e},b2:function(t,e,i,r){return this.b2p0(t,e)+this.b2p1(t,i)+this.b2p2(t,r)},b3p0:function(t,e){var i=1-t;return i*i*i*e},b3p1:function(t,e){var i=1-t;return 3*i*i*t*e},b3p2:function(t,e){return 3*(1-t)*t*t*e},b3p3:function(t,e){return t*t*t*e},b3:function(t,e,i,r,s){return this.b3p0(t,e)+this.b3p1(t,i)+this.b3p2(t,r)+this.b3p3(t,s)},triangleNormal:function(t,e,i,r){void 0===r&&(r=E.vec3());var s=e[0]-t[0],o=e[1]-t[1],a=e[2]-t[2],n=i[0]-t[0],l=i[1]-t[1],h=i[2]-t[2],u=o*h-a*l,c=a*n-s*h,p=s*l-o*n,d=Math.sqrt(u*u+c*c+p*p);return 0===d?(r[0]=0,r[1]=0,r[2]=0):(r[0]=u/d,r[1]=c/d,r[2]=p/d),r},rayTriangleIntersect:function(){var t=new P(3),e=new P(3),i=new P(3),r=new P(3),s=new P(3);return function(o,a,n,l,h,u){u=u||E.vec3();var c=E.subVec3(l,n,t),p=E.subVec3(h,n,e),d=E.cross3Vec3(a,p,i),f=E.dotVec3(c,d);if(f<1e-6)return null;var _=E.subVec3(o,n,r),g=E.dotVec3(_,d);if(g<0||g>f)return null;var m=E.cross3Vec3(_,c,s),v=E.dotVec3(a,m);if(v<0||g+v>f)return null;var b=E.dotVec3(p,m)/f;return u[0]=o[0]+b*a[0],u[1]=o[1]+b*a[1],u[2]=o[2]+b*a[2],u}}(),rayPlaneIntersect:function(){var t=new P(3),e=new P(3),i=new P(3),r=new P(3);return function(s,o,a,n,l,h){h=h||E.vec3(),o=E.normalizeVec3(o,t);var u=E.subVec3(n,a,e),c=E.subVec3(l,a,i),p=E.cross3Vec3(u,c,r);E.normalizeVec3(p,p);var d=-E.dotVec3(a,p),f=-(E.dotVec3(s,p)+d)/E.dotVec3(o,p);return h[0]=s[0]+f*o[0],h[1]=s[1]+f*o[1],h[2]=s[2]+f*o[2],h}}(),cartesianToBarycentric:function(){var t=new P(3),e=new P(3),i=new P(3);return function(r,s,o,a,n){var l=E.subVec3(a,s,t),h=E.subVec3(o,s,e),u=E.subVec3(r,s,i),c=E.dotVec3(l,l),p=E.dotVec3(l,h),d=E.dotVec3(l,u),f=E.dotVec3(h,h),_=E.dotVec3(h,u),g=c*f-p*p;if(0===g)return null;var m=1/g,v=(f*d-p*_)*m,b=(c*_-p*d)*m;return n[0]=1-v-b,n[1]=b,n[2]=v,n}}(),barycentricInsideTriangle:function(t){var e=t[1],i=t[2];return i>=0&&e>=0&&i+e<1},barycentricToCartesian:function(t,e,i,r,s){void 0===s&&(s=E.vec3());var o=t[0],a=t[1],n=t[2];return s[0]=e[0]*o+i[0]*a+r[0]*n,s[1]=e[1]*o+i[1]*a+r[1]*n,s[2]=e[2]*o+i[2]*a+r[2]*n,s},mergeVertices:function(t,e,i,r){var s,o,a,n,l,h,u={},c=[],p=[],d=e?[]:null,f=i?[]:null,_=[],g=Math.pow(10,4),m=0;for(l=0,h=t.length;l<h;l+=3)s=t[l],o=t[l+1],a=t[l+2],void 0===u[n=Math.round(s*g)+"_"+Math.round(o*g)+"_"+Math.round(a*g)]&&(u[n]=p.length/3,p.push(s),p.push(o),p.push(a),e&&(d.push(e[l]),d.push(e[l+1]),d.push(e[l+2])),i&&(f.push(i[m]),f.push(i[m+1]))),c[l/3]=u[n],m+=2;for(l=0,h=r.length;l<h;l++)_[l]=c[r[l]];var v={positions:p,indices:_};return d&&(v.normals=d),f&&(v.uv=f),v},buildNormals:(u=new P(3),c=new P(3),p=new P(3),d=new P(3),f=new P(3),_=new P(3),function(t,e,i){var r,s,o,a,n,l,h,g,m,v=new Array(t.length/3);for(r=0,s=e.length;r<s;r+=3){o=e[r],a=e[r+1],n=e[r+2],u[0]=t[3*o],u[1]=t[3*o+1],u[2]=t[3*o+2],c[0]=t[3*a],c[1]=t[3*a+1],c[2]=t[3*a+2],p[0]=t[3*n],p[1]=t[3*n+1],p[2]=t[3*n+2],E.subVec3(c,u,d),E.subVec3(p,u,f);var b=E.vec3();E.normalizeVec3(E.cross3Vec3(d,f,_),b),v[o]||(v[o]=[]),v[a]||(v[a]=[]),v[n]||(v[n]=[]),v[o].push(b),v[a].push(b),v[n].push(b)}for(i=i&&i.length===t.length?i:new Float32Array(t.length),r=0,s=v.length;r<s;r++){l=v[r].length,h=0,g=0,m=0;for(var y=0;y<l;y++)h+=v[r][y][0],g+=v[r][y][1],m+=v[r][y][2];i[3*r]=h/l,i[3*r+1]=g/l,i[3*r+2]=m/l}return i}),buildTangents:function(){var t=new P(3),e=new P(3),i=new P(3),r=new P(3),s=new P(3),o=new P(3),a=new P(3);return function(n,l,h){for(var u=new Float32Array(n.length),c=0;c<l.length;c+=3){var p=l[c],d=n.subarray(3*p,3*p+3),f=h.subarray(2*p,2*p+2);p=l[c+1];var _=n.subarray(3*p,3*p+3),g=h.subarray(2*p,2*p+2);p=l[c+2];for(var m=n.subarray(3*p,3*p+3),v=h.subarray(2*p,2*p+2),b=E.subVec3(_,d,t),y=E.subVec3(m,d,e),P=E.subVec2(g,f,i),M=E.subVec2(v,f,r),x=1/(P[0]*M[1]-P[1]*M[0]),w=E.mulVec3Scalar(E.subVec3(E.mulVec3Scalar(b,M[1],s),E.mulVec3Scalar(y,P[1],o),a),x,o),C=void 0,A=0;A<3;A++)u[C=3*l[c+A]]+=w[0],u[C+1]+=w[1],u[C+2]+=w[2]}return u}}(),buildPickTriangles:function(t,e,i){for(var r,s,o,a,n,l=e.length,h=i?new Uint16Array(9*l):new Float32Array(9*l),u=new Uint8Array(12*l),c=0,p=0,d=0,f=0;f<l;f+=3)n=c>>24&255,a=c>>16&255,o=c>>8&255,s=255&c,r=3*e[f],h[p++]=t[r],h[p++]=t[r+1],h[p++]=t[r+2],u[d++]=s,u[d++]=o,u[d++]=a,u[d++]=n,r=3*e[f+1],h[p++]=t[r],h[p++]=t[r+1],h[p++]=t[r+2],u[d++]=s,u[d++]=o,u[d++]=a,u[d++]=n,r=3*e[f+2],h[p++]=t[r],h[p++]=t[r+1],h[p++]=t[r+2],u[d++]=s,u[d++]=o,u[d++]=a,u[d++]=n,c++;return{positions:h,colors:u}},faceToVertexNormals:function(t,e,i){void 0===i&&(i={});var r,s,o,a,n,l,h,u,c,p,d,f=i.smoothNormalsAngleThreshold||20,_={},g=[],m={},v=Math.pow(10,4);for(h=0,c=t.length;h<c;h+=3){l=h/3,s=t[h],o=t[h+1],a=t[h+2],void 0===_[n=Math.round(s*v)+"_"+Math.round(o*v)+"_"+Math.round(a*v)]?_[n]=[l]:_[n].push(l);var b=E.normalizeVec3([e[h],e[h+1],e[h+2]]);g[l]=b,r=E.vec4([b[0],b[1],b[2],1]),m[l]=r}for(n in _)if(_.hasOwnProperty(n)){var y=_[n],P=y.length;for(h=0;h<P;h++){var M=y[h];for(r=m[M],u=0;u<P;u++)if(h!==u){var x=y[u];p=g[M],d=g[x],Math.abs(E.angleVec3(p,d)/E.DEGTORAD)<f&&(r[0]+=d[0],r[1]+=d[1],r[2]+=d[2],r[3]+=1)}}}for(h=0,c=e.length;h<c;h+=3)r=m[h/3],e[h+0]=r[0]/r[3],e[h+1]=r[1]/r[3],e[h+2]=r[2]/r[3]},transformRay:function(){var t=new P(4),e=new P(4);return function(i,r,s,o,a){t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=1,E.transformVec4(i,t,e),o[0]=e[0],o[1]=e[1],o[2]=e[2],t[0]=s[0],t[1]=s[1],t[2]=s[2],E.transformVec3(i,t,e),E.normalizeVec3(e),a[0]=e[0],a[1]=e[1],a[2]=e[2]}}(),canvasPosToWorldRay:function(){var t=new P(16),e=new P(16),i=new P(4),r=new P(4),s=new P(4),o=new P(4);return function(a,n,l,h,u,c){var p=E.mulMat4(l,n,t),d=E.inverseMat4(p,e),f=a.width,_=a.height,g=(h[0]-f/2)/(f/2),m=-(h[1]-_/2)/(_/2);i[0]=g,i[1]=m,i[2]=-1,i[3]=1,E.transformVec4(d,i,r),E.mulVec4Scalar(r,1/r[3]),s[0]=g,s[1]=m,s[2]=1,s[3]=1,E.transformVec4(d,s,o),E.mulVec4Scalar(o,1/o[3]),u[0]=o[0],u[1]=o[1],u[2]=o[2],E.subVec3(o,r,c),E.normalizeVec3(c)}}(),canvasPosToLocalRay:(l=new P(3),h=new P(3),function(t,e,i,r,s,o,a){E.canvasPosToWorldRay(t,e,i,s,l,h),E.worldRayToLocalRay(r,l,h,o,a)}),worldRayToLocalRay:function(){var t=new P(16),e=new P(4),i=new P(4);return function(r,s,o,a,n){var l=E.inverseMat4(r,t);e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=1,E.transformVec4(l,e,i),a[0]=i[0],a[1]=i[1],a[2]=i[2],E.transformVec3(l,o,n)}}(),buildKDTree:function(){var t=new Float32Array;function e(i,r,s,o){var a,n,l=new P(6),h={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:l};for(l[0]=l[1]=l[2]=Number.POSITIVE_INFINITY,l[3]=l[4]=l[5]=Number.NEGATIVE_INFINITY,a=0,n=i.length;a<n;++a)for(var u=3*i[a],c=0;c<3;++c){var p=3*r[u+c];s[p]<l[0]&&(l[0]=s[p]),s[p]>l[3]&&(l[3]=s[p]),s[p+1]<l[1]&&(l[1]=s[p+1]),s[p+1]>l[4]&&(l[4]=s[p+1]),s[p+2]<l[2]&&(l[2]=s[p+2]),s[p+2]>l[5]&&(l[5]=s[p+2])}if(i.length<20||o>10)return h.triangles=i,h.leaf=!0,h;t[0]=l[3]-l[0],t[1]=l[4]-l[1],t[2]=l[5]-l[2];var d=0;t[1]>t[d]&&(d=1),t[2]>t[d]&&(d=2),h.splitDim=d;var f=(l[d]+l[d+3])/2,_=new Array(i.length),g=0,m=new Array(i.length),v=0;for(a=0,n=i.length;a<n;++a){var b=r[u=3*i[a]],y=3*r[u+1],M=3*r[u+2];s[3*b+d]<=f||s[y+d]<=f||s[M+d]<=f?_[g++]=i[a]:m[v++]=i[a]}return _.length=g,m.length=v,h.left=e(_,r,s,o+1),h.right=e(m,r,s,o+1),h}return function(t,i){for(var r=t.length/3,s=new Array(r),o=0;o<r;++o)s[o]=o;return e(s,t,i,0)}}(),decompressPosition:function(t,e,i){(i=i||t)[0]=t[0]*e[0]+e[12],i[1]=t[1]*e[5]+e[13],i[2]=t[2]*e[10]+e[14]},decompressPositions:function(t,e,i){void 0===i&&(i=new Float32Array(t.length));for(var r=0,s=t.length;r<s;r+=3)i[r+0]=t[r+0]*e[0]+e[12],i[r+1]=t[r+1]*e[5]+e[13],i[r+2]=t[r+2]*e[10]+e[14];return i},decompressUV:function(t,e,i){i[0]=t[0]*e[0]+e[6],i[1]=t[1]*e[4]+e[7]},decompressUVs:function(t,e,i){void 0===i&&(i=new Float32Array(t.length));for(var r=0,s=t.length;r<s;r+=3)i[r+0]=t[r+0]*e[0]+e[6],i[r+1]=t[r+1]*e[4]+e[7];return i},octDecodeVec2:function(t,e){var i=t[0],r=t[1];i=(2*i+1)/255,r=(2*r+1)/255;var s=1-Math.abs(i)-Math.abs(r);s<0&&(i=(1-Math.abs(r))*(i>=0?1:-1),r=(1-Math.abs(i))*(r>=0?1:-1));var o=Math.sqrt(i*i+r*r+s*s);return e[0]=i/o,e[1]=r/o,e[2]=s/o,e},octDecodeVec2s:function(t,e){for(var i=0,r=0,s=t.length;i<s;i+=2){var o=t[i+0],a=t[i+1];o=(2*o+1)/255,a=(2*a+1)/255;var n=1-Math.abs(o)-Math.abs(a);n<0&&(o=(1-Math.abs(a))*(o>=0?1:-1),a=(1-Math.abs(o))*(a>=0?1:-1));var l=Math.sqrt(o*o+a*a+n*n);e[r+0]=o/l,e[r+1]=a/l,e[r+2]=n/l,r+=3}return e}};E.buildEdgeIndices=function(){var t=[],e=[],i=[],r=[],s=[],o=0,a=new Uint16Array(3),n=new Uint16Array(3),l=new Uint16Array(3),h=E.vec3(),u=E.vec3(),c=E.vec3(),p=E.vec3(),d=E.vec3(),f=E.vec3(),_=E.vec3();return function(g,m,v,b){!function(s,o){var a,n,l,h,u,c,p={},d=Math.pow(10,4),f=0;for(u=0,c=s.length;u<c;u+=3)a=s[u],n=s[u+1],l=s[u+2],void 0===p[h=Math.round(a*d)+"_"+Math.round(n*d)+"_"+Math.round(l*d)]&&(p[h]=f/3,t[f++]=a,t[f++]=n,t[f++]=l),e[u/3]=p[h];for(u=0,c=o.length;u<c;u++)r[u]=e[o[u]],i[r[u]]=o[u]}(g,m),function(e,i){o=0;for(var g=0,m=e;g<m;g+=3){var v=3*r[g],b=3*r[g+1],y=3*r[g+2];i?(a[0]=t[v],a[1]=t[v+1],a[2]=t[v+2],n[0]=t[b],n[1]=t[b+1],n[2]=t[b+2],l[0]=t[y],l[1]=t[y+1],l[2]=t[y+2],E.decompressPosition(a,i,h),E.decompressPosition(n,i,u),E.decompressPosition(l,i,c)):(h[0]=t[v],h[1]=t[v+1],h[2]=t[v+2],u[0]=t[b],u[1]=t[b+1],u[2]=t[b+2],c[0]=t[y],c[1]=t[y+1],c[2]=t[y+2]),E.subVec3(c,u,p),E.subVec3(h,u,d),E.cross3Vec3(p,d,f),E.normalizeVec3(f,_);var P=s[o]||(s[o]={normal:E.vec3()});P.normal[0]=_[0],P.normal[1]=_[1],P.normal[2]=_[2],o++}}(m.length,v);for(var y,P,M,x,w,C,A,S,D,L,B=[],R=Math.cos(E.DEGTORAD*b),T={},F=!1,N=0,I=m.length;N<I;N+=3)for(var k=N/3,O=0;O<3;O++)y=r[N+O],P=r[N+(O+1)%3],void 0===T[w=(M=Math.min(y,P))+","+(x=Math.max(y,P))]?T[w]={index1:M,index2:x,face1:k,face2:void 0}:T[w].face2=k;for(w in T)void 0!==(C=T[w]).face2&&(A=s[C.face1].normal,S=s[C.face2].normal,E.dotVec3(A,S)>R)||(D=i[C.index1],L=i[C.index2],(!F&&D>65535||L>65535)&&(F=!0),B.push(D),B.push(L));return F?new Uint32Array(B):new Uint16Array(B)}}();var C=function(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0},A={length:{configurable:!0}};A.length.get=function(){return this._length},C.prototype.shift=function(){if(this._index>=this._headLength){var t=this._head;if(t.length=0,this._head=this._tail,this._tail=t,this._index=0,this._headLength=this._head.length,!this._headLength)return}var e=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,e},C.prototype.push=function(t){return this._length++,this._tail.push(t),this},C.prototype.unshift=function(t){return this._head[--this._index]=t,this._length++,this},Object.defineProperties(C.prototype,A);var S={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};var D=[["0",10],["A",26],["a",26],["_",1],["$",1]].map((function(t){for(var e=[],i=t[0].charCodeAt(0),r=i+t[1],s=i;s<r;++s)e.push(s);return String.fromCharCode.apply(null,e)})).join("");function L(t,e){return(e&&4!==e?[0,6]:[0,6,12,18]).map((function(e){return D.substr(parseInt(t/(1<<e))%64,1)})).reverse().join("")}var B={xmlToJson:function t(e,i){if(e.nodeType===e.TEXT_NODE){var r=e.nodeValue;if(null===r.match(/^\s+$/))return r}else if(e.nodeType===e.ELEMENT_NODE||e.nodeType===e.DOCUMENT_NODE){var s={type:e.nodeName,children:[]};if(e.nodeType===e.ELEMENT_NODE)for(var o=0;o<e.attributes.length;o++){var a=e.attributes[o];s[i[a.nodeName]||a.nodeName]=a.nodeValue}for(var n=0;n<e.childNodes.length;n++){(o=t(e.childNodes[n],i))&&s.children.push(o)}return s}},clone:function(t){return JSON.parse(JSON.stringify(t))},compressGuid:function(t){var e=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map((function(e){return parseInt(t.substr(e,2),16)}));return L(e[0],2)+[1,4,7,10,13].map((function(t){return L((e[t]<<16)+(e[t+1]<<8)+e[t+2])})).join("")},findNodeOfType:function(t,e){var i=[],r=function(t){t.type===e&&i.push(t),(t.children||[]).forEach((function(t){r(t)}))};return r(t),i},timeout:function(t){return new Promise((function(e,i){setTimeout(e,t)}))},httpRequest:function(t){return new Promise((function(e,i){var r=new XMLHttpRequest;r.open(t.method||"GET",t.url,!0),r.onload=function(s){console.log(t.url,r.readyState,r.status),4===r.readyState&&(200===r.status?e(r.responseXML):i(r.statusText))},r.send(null)}))},loadJSON:function(t,e,i){var r=function(t){};e=e||r,i=i||r;var s=new XMLHttpRequest;s.overrideMimeType("application/json"),s.open("GET",t,!0),s.addEventListener("load",(function(t){var r=t.target.response;if(200===this.status){var s;try{s=JSON.parse(r)}catch(t){i("utils.loadJSON(): Failed to parse JSON response - "+t)}e(s)}else if(0===this.status){console.warn("loadFile: HTTP Status 0 received.");try{e(JSON.parse(r))}catch(t){i("utils.loadJSON(): Failed to parse JSON response - "+t)}}else i(t)}),!1),s.addEventListener("error",(function(t){i(t)}),!1),s.send(null)},loadArraybuffer:function(t,e,i){var r=function(t){};e=e||r,i=i||r;var s=t.match(/^data:(.*?)(;base64)?,(.*)$/);if(s){var o=!!s[2],a=s[3];a=window.decodeURIComponent(a),o&&(a=window.atob(a));try{for(var n=new ArrayBuffer(a.length),l=new Uint8Array(n),h=0;h<a.length;h++)l[h]=a.charCodeAt(h);window.setTimeout((function(){e(n)}),0)}catch(t){window.setTimeout((function(){i(t)}),0)}}else{var u=new XMLHttpRequest;u.open("GET",t,!0),u.responseType="arraybuffer",u.onreadystatechange=function(){4===u.readyState&&(200===u.status?e(u.response):i("loadArrayBuffer error : "+u.response))},u.send(null)}},queryString:function(){for(var t={},e=window.location.search.substring(1).split("&"),i=0;i<e.length;i++){var r=e[i].split("=");if(void 0===t[r[0]])t[r[0]]=decodeURIComponent(r[1]);else if("string"==typeof t[r[0]]){var s=[t[r[0]],decodeURIComponent(r[1])];t[r[0]]=s}else t[r[0]].push(decodeURIComponent(r[1]))}return t}(),isArray:function(t){return t&&!t.propertyIsEnumerable("length")&&"object"==typeof t&&"number"==typeof t.length},isString:function(t){return"string"==typeof t||t instanceof String},isNumeric:function(t){return!isNaN(parseFloat(t))&&isFinite(t)},isID:function(t){return B.isString(t)||B.isNumeric(t)},isSameComponent:function(t,e){return!(!t||!e)&&(B.isNumeric(t)||B.isString(t)?""+t:t.id)===(B.isNumeric(e)||B.isString(e)?""+e:e.id)},isFunction:function(t){return"function"==typeof t},isObject:function(t){var e={}.constructor;return!!t&&t.constructor===e},copy:function(t){return B.apply(t,{})},apply:function(t,e){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},apply2:function(t,e){for(var i in t)t.hasOwnProperty(i)&&void 0!==t[i]&&null!==t[i]&&(e[i]=t[i]);return e},applyIf:function(t,e){for(var i in t)t.hasOwnProperty(i)&&(void 0!==e[i]&&null!==e[i]||(e[i]=t[i]));return e},isEmptyObject:function(t){for(var e in t)if(t.hasOwnProperty(e))return!1;return!0},inQuotes:function(t){return B.isNumeric(t)?""+t:"'"+t+"'"},concat:function(t,e){var i=new t.constructor(t.length+e.length);return i.set(t),i.set(e,t.length),i},flattenParentChildHierarchy:function(t){var e=[];return function t(i){i.id=i.uuid,delete i.oid,e.push(i);var r=i.children;if(r)for(var s=0,o=r.length;s<o;s++){r[s].parent=i.id,t(r[s])}i.children=[]}(t),e}},R={},T=new t,F=new C,N={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},I=[],k=0,O=0;var V=new function(){this.version="1.0.0",this.scenes={},this._superTypes={},this._addScene=function(t){if(t.id){if(V.scenes[t.id])return void console.error("[ERROR] Scene "+B.inQuotes(t.id)+" already exists")}else t.id=T.addItem({});V.scenes[t.id]=t;var e=t.ticksPerOcclusionTest,i=t.ticksPerRender;R[t.id]={ticksPerOcclusionTest:e,ticksPerRender:i,renderCountdown:i},S.components.scenes++,t.once("destroyed",(function(){T.removeItem(t.id),delete V.scenes[t.id],delete R[t.id],S.components.scenes--}))},this.clear=function(){var t;for(var e in V.scenes)V.scenes.hasOwnProperty(e)&&(t=V.scenes[e],"default.scene"===e?t.clear():(t.destroy(),delete V.scenes[t.id]))},this.scheduleTask=function(t,e){F.push(t),F.push(e)},this.runTasks=function(t){void 0===t&&(t=-1);for(var e,i,r=(new Date).getTime(),s=0;F.length>0&&(t<0||r<t);)e=F.shift(),(i=F.shift())?e.call(i):e(),r=(new Date).getTime(),s++;return s},this.getNumTasks=function(){return F.length}},z=function(){var t=Date.now();if(k>0){var e=1e3/(t-k);O+=e,I.push(e),I.length>=30&&(O-=I.shift()),S.frame.fps=Math.round(O/I.length)}!function(t){var e=V.runTasks(t+10),i=V.getNumTasks();S.frame.tasksRun=e,S.frame.tasksScheduled=i,S.frame.tasksBudget=10}(t),function(t){for(var e in N.time=t,V.scenes)if(V.scenes.hasOwnProperty(e)){var i=V.scenes[e];N.sceneId=e,N.startTime=i.startTime,N.deltaTime=null!=N.prevTime?N.time-N.prevTime:0,i.fire("tick",N,!0)}N.prevTime=t}(t),function(){var t,e,i,r,s,o=V.scenes,a=!1;for(s in o)o.hasOwnProperty(s)&&(t=o[s],(e=R[s])||(e=R[s]={}),i=t.ticksPerOcclusionTest,e.ticksPerOcclusionTest!==i&&(e.ticksPerOcclusionTest=i,e.renderCountdown=i),--t.occlusionTestCountdown<=0&&(t.doOcclusionTest(),t.occlusionTestCountdown=i),r=t.ticksPerRender,e.ticksPerRender!==r&&(e.ticksPerRender=r,e.renderCountdown=r),0==--e.renderCountdown&&(t.render(a),e.renderCountdown=r))}(),k=t,window.requestAnimationFrame(z)};window.requestAnimationFrame(z);var U=function t(e,i){if(void 0===e&&(e=null),void 0===i&&(i={}),this.scene=null,"Scene"===this.type)this.scene=this,this.viewer=i.viewer;else{if("Scene"===e.type)this.scene=e;else{if(!(e instanceof t))throw"Invalid param: owner must be a Component";this.scene=e.scene}this._owner=e,this._renderer=this.scene._renderer}this._dontClear=!!i.dontClear,this._renderer=this.scene._renderer,this.meta=i.meta||{},this.id=i.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,e&&e._own(this)},j={type:{configurable:!0},isComponent:{configurable:!0},owner:{configurable:!0}};j.type.get=function(){return"Component"},j.isComponent.get=function(){return!0},U.prototype.glRedraw=function(){this._renderer&&(this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty())},U.prototype.glResort=function(){this._renderer&&this._renderer.needStateSort()},j.owner.get=function(){return this._owner},U.prototype.isType=function(t){return this.type===t},U.prototype.fire=function(t,e,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),!0!==i&&(this._events[t]=e||!0);var r,s=this._eventSubs[t];if(s)for(var o in s)s.hasOwnProperty(o)&&(r=s[o],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,e):this.error("fire: potential stack overflow from recursive event '"+t+"' - dropping this event"),this._eventCallDepth--)},U.prototype.on=function(e,i,r){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new t),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});var s=this._eventSubs[e];s?this._eventSubsNum[e]++:(s={},this._eventSubs[e]=s,this._eventSubsNum[e]=1);var o=this._subIdMap.addItem();s[o]={callback:i,scope:r||this},this._subIdEvents[o]=e;var a=this._events[e];return void 0!==a&&i.call(r||this,a),o},U.prototype.off=function(t){if(null!=t&&this._subIdEvents){var e=this._subIdEvents[t];if(e){delete this._subIdEvents[t];var i=this._eventSubs[e];i&&(delete i[t],this._eventSubsNum[e]--),this._subIdMap.removeItem(t)}}},U.prototype.once=function(t,e,i){var r=this,s=this.on(t,(function(t){r.off(s),e.call(i||this,t)}),i)},U.prototype.hasSubs=function(t){return this._eventSubsNum&&this._eventSubsNum[t]>0},U.prototype.log=function(t){t="[LOG]"+this._message(t),window.console.log(t),this.scene.fire("log",t)},U.prototype._message=function(t){return" ["+this.type+" "+B.inQuotes(this.id)+"]: "+t},U.prototype.warn=function(t){t="[WARN]"+this._message(t),window.console.warn(t),this.scene.fire("warn",t)},U.prototype.error=function(t){t="[ERROR]"+this._message(t),window.console.error(t),this.scene.fire("error",t)},U.prototype._attach=function(t){var e=t.name;if(e){var i=t.component,r=t.sceneDefault,s=t.sceneSingleton,o=t.type,a=t.on,n=!1!==t.recompiles;if(i&&(B.isNumeric(i)||B.isString(i))){var l=i;if(!(i=this.scene.components[l]))return void this.error("Component not found: "+B.inQuotes(l))}if(!i)if(!0===s){var h=this.scene.types[o];for(var u in h)if(h.hasOwnProperty){i=h[u];break}if(!i)return this.error("Scene has no default component for '"+e+"'"),null}else if(!0===r&&!(i=this.scene[e]))return this.error("Scene has no default component for '"+e+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+B.inQuotes(i.id));if(o&&!i.isType(o))return void this.error("Expected a "+o+" type or subtype: "+i.type+" "+B.inQuotes(i.id))}this._attachments||(this._attachments={});var c,p,d,f=this._attached[e];if(f){if(i&&f.id===i.id)return;var _=this._attachments[f.id];for(p=0,d=(c=_.subs).length;p<d;p++)f.off(c[p]);delete this._attached[e],delete this._attachments[f.id];var g=_.params.onDetached;g&&(B.isFunction(g)?g(f):g.scope?g.callback.call(g.scope,f):g.callback(f)),_.managingLifecycle&&f.destroy()}if(i){var m={params:t,component:i,subs:[],managingLifecycle:!1};m.subs.push(i.once("destroyed",(function(){m.params.component=null,this._attach(m.params)}),this)),n&&m.subs.push(i.on("dirty",(function(){this.fire("dirty",this)}),this)),this._attached[e]=i,this._attachments[i.id]=m;var v,b,y,P,M=t.onAttached;if(M&&(B.isFunction(M)?M(i):M.scope?M.callback.call(M.scope,i):M.callback(i)),a)for(v in a)if(a.hasOwnProperty(v)){if(b=a[v],B.isFunction(b)?(y=b,P=null):(y=b.callback,P=b.scope),!y)continue;m.subs.push(i.on(v,y,P))}}return n&&this.fire("dirty",this),this.fire(e,i),i}this.error("Component 'name' expected")},U.prototype._checkComponent=function(t,e){if(!e.isComponent){if(!B.isID(e))return void this.error("Expected a Component or ID");var i=e;if(!(e=this.scene.components[i]))return void this.error("Component not found: "+i)}if(t===e.type){if(e.scene.id===this.scene.id)return e;this.error("Not in same scene: "+e.type)}else this.error("Expected a "+t+" Component")},U.prototype._checkComponent2=function(t,e){if(!e.isComponent){if(!B.isID(e))return void this.error("Expected a Component or ID");var i=e;if(!(e=this.scene.components[i]))return void this.error("Component not found: "+i)}if(e.scene.id===this.scene.id){for(var r=0,s=t.length;r<s;r++)if(t[r]===e.type)return e;return this.error("Expected component types: "+t),null}this.error("Not in same scene: "+e.type)},U.prototype._own=function(t){var e=this;this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[t.id]||(this._ownedComponents[t.id]=t),t.once("destroyed",(function(){delete e._ownedComponents[t.id]}),this)},U.prototype._needUpdate=function(t){this._updateScheduled||(this._updateScheduled=!0,0===t?this._doUpdate():V.scheduleTask(this._doUpdate,this))},U.prototype._doUpdate=function(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())},U.prototype._update=function(){},U.prototype.clear=function(){if(this._ownedComponents)for(var t in this._ownedComponents){if(this._ownedComponents.hasOwnProperty(t))this._ownedComponents[t].destroy(),delete this._ownedComponents[t]}},U.prototype.destroy=function(){if(!this.destroyed){var t,e,i,r,s,o;if(this.fire("destroyed",this.destroyed=!0),this._attachments)for(t in this._attachments)if(this._attachments.hasOwnProperty(t)){for(i=(e=this._attachments[t]).component,s=0,o=(r=e.subs).length;s<o;s++)i.off(r[s]);e.managingLifecycle&&i.destroy()}if(this._ownedComponents)for(t in this._ownedComponents)this._ownedComponents.hasOwnProperty(t)&&((i=this._ownedComponents[t]).destroy(),delete this._ownedComponents[t]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1}},Object.defineProperties(U.prototype,j);var G=1,X=4,W=8,H=16,Y=32,K=256,q=512,Z=1024,Q=2048,J=new Float32Array([0,0,0]),$=new Uint16Array([0,0,0]),tt=function(t,e,i,r,s,o){this._isObject=e,this.scene=t.scene,this.model=t,this.meshes=r,this._numTriangles=0;for(var a=0,n=this.meshes.length;a<n;a++){var l=this.meshes[a];l.parent=this,this._numTriangles+=l.numTriangles}this.id=i,this.originalSystemId=E.unglobalizeObjectId(t.id,i),this._flags=s,this._aabb=o,this._offsetAABB=E.AABB3(o),this._offset=E.vec3(),this._isObject&&t.scene._registerObject(this)},et={isEntity:{configurable:!0},isModel:{configurable:!0},isObject:{configurable:!0},aabb:{configurable:!0},numTriangles:{configurable:!0},visible:{configurable:!0},highlighted:{configurable:!0},xrayed:{configurable:!0},selected:{configurable:!0},edges:{configurable:!0},culled:{configurable:!0},clippable:{configurable:!0},collidable:{configurable:!0},pickable:{configurable:!0},colorize:{configurable:!0},opacity:{configurable:!0},offset:{configurable:!0},castsShadow:{configurable:!0},receivesShadow:{configurable:!0},saoEnabled:{configurable:!0}};et.isEntity.get=function(){return!0},et.isModel.get=function(){return!1},et.isObject.get=function(){return this._isObject},et.aabb.get=function(){return this._offsetAABB},et.numTriangles.get=function(){return this._numTriangles},et.visible.set=function(t){if(!!(this._flags&G)!==t){this._flags=t?this._flags|G:this._flags&~G;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}},et.visible.get=function(){return this._getFlag(G)},tt.prototype._getFlag=function(t){return!!(this._flags&t)},et.highlighted.set=function(t){if(!!(this._flags&q)!==t){this._flags=t?this._flags|q:this._flags&~q;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}},et.highlighted.get=function(){return this._getFlag(q)},et.xrayed.set=function(t){if(!!(this._flags&K)!==t){this._flags=t?this._flags|K:this._flags&~K;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}},et.xrayed.get=function(){return this._getFlag(K)},et.selected.set=function(t){if(!!(this._flags&Z)!==t){this._flags=t?this._flags|Z:this._flags&~Z;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}},et.selected.get=function(){return this._getFlag(Z)},et.edges.set=function(t){if(!!(this._flags&Q)!==t){this._flags=t?this._flags|Q:this._flags&~Q;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setEdges(this._flags);this.model.glRedraw()}},et.edges.get=function(){return this._getFlag(Q)},et.culled.set=function(t){if(!!(this._flags&X)!==t){this._flags=t?this._flags|X:this._flags&~X;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setCulled(this._flags);this.model.glRedraw()}},et.culled.get=function(){return this._getFlag(X)},et.clippable.set=function(t){if(!!(this._flags&H)!==t){this._flags=t?this._flags|H:this._flags&~H;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setClippable(this._flags);this.model.glRedraw()}},et.clippable.get=function(){return this._getFlag(H)},et.collidable.set=function(t){if(!!(this._flags&Y)!==t){this._flags=t?this._flags|Y:this._flags&~Y;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setCollidable(this._flags)}},et.collidable.get=function(){return this._getFlag(Y)},et.pickable.set=function(t){if(!!(this._flags&W)!==t){this._flags=t?this._flags|W:this._flags&~W;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setPickable(this._flags)}},et.pickable.get=function(){return this._getFlag(W)},et.colorize.set=function(t){if(t){$[0]=Math.floor(255*t[0]),$[1]=Math.floor(255*t[1]),$[2]=Math.floor(255*t[2]);for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setColorize($)}else for(var r=0,s=this.meshes.length;r<s;r++)this.meshes[r]._setColorize(null);if(this._isObject){var o=!!t;this.scene._objectColorizeUpdated(this,o)}this.model.glRedraw()},et.colorize.get=function(){if(0===this.meshes.length)return null;var t=this.meshes[0]._colorize;return J[0]=t[0]/255,J[1]=t[1]/255,J[2]=t[2]/255,J},et.opacity.set=function(t){if(0!==this.meshes.length){var e=null!=t,i=this.meshes[0]._colorize[3],r=255;if(e){if(t<0?t=0:t>1&&(t=1),i===(r=Math.floor(255*t)))return}else if(i===(r=255))return;for(var s=0,o=this.meshes.length;s<o;s++)this.meshes[s]._setOpacity(r,this._flags);this._isObject&&this.scene._objectOpacityUpdated(this,e),this.model.glRedraw()}},et.opacity.get=function(){return this.meshes.length>0?this.meshes[0]._colorize[3]/255:1},et.offset.set=function(t){t?(this._offset[0]=t[0],this._offset[1]=t[1],this._offset[2]=t[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setOffset(this._offset);this._offsetAABB[0]=this._aabb[0]+this._offset[0],this._offsetAABB[1]=this._aabb[1]+this._offset[1],this._offsetAABB[2]=this._aabb[2]+this._offset[2],this._offsetAABB[3]=this._aabb[3]+this._offset[0],this._offsetAABB[4]=this._aabb[4]+this._offset[1],this._offsetAABB[5]=this._aabb[5]+this._offset[2],this.scene._aabbDirty=!0,this.scene._objectOffsetUpdated(this,t),this.model._aabbDirty=!0,this.model.glRedraw()},et.offset.get=function(){return this._offset},et.castsShadow.set=function(t){},et.castsShadow.get=function(){return!1},et.receivesShadow.set=function(t){},et.receivesShadow.get=function(){return!1},et.saoEnabled.get=function(){return this.model.saoEnabled},tt.prototype._finalize=function(){var t=this.model.scene;this._isObject&&(this.visible&&t._objectVisibilityUpdated(this),this.highlighted&&t._objectHighlightedUpdated(this),this.xrayed&&t._objectXRayedUpdated(this),this.selected&&t._objectSelectedUpdated(this));for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._finalize(this._flags)},tt.prototype._destroy=function(){var t=this.model.scene;this._isObject&&(t._deregisterObject(this),this.visible&&t._objectVisibilityUpdated(this,!1),this.xrayed&&t._objectXRayedUpdated(this),this.selected&&t._objectSelectedUpdated(this),this.highlighted&&t._objectHighlightedUpdated(this),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1));for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._destroy();t._aabbDirty=!0},Object.defineProperties(tt.prototype,et);var it=E.vec3(),rt=function(){var t=new Float32Array(16),e=new Float64Array(4),i=new Float64Array(4);return function(r,s,o){return void 0===o&&(o=t),e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=1,E.transformVec4(r,e,i),E.setMat4Translation(r,i,o),o}}();function st(t,e,i){var r=Float32Array.from([t[0]])[0],s=t[0]-r,o=Float32Array.from([t[1]])[0],a=t[1]-o,n=Float32Array.from([t[2]])[0],l=t[2]-n;e[0]=r,e[1]=o,e[2]=n,i[0]=s,i[1]=a,i[2]=l}function ot(t,e,i,r){void 0===r&&(r=1e7);for(var s=E.getPositionsCenter(t,it),o=Math.round(s[0]/r)*r,a=Math.round(s[1]/r)*r,n=Math.round(s[2]/r)*r,l=0,h=t.length;l<h;l+=3)e[l+0]=t[l+0]-o,e[l+1]=t[l+1]-a,e[l+2]=t[l+2]-n;return i[0]=o,i[1]=a,i[2]=n,0!==i[0]||0!==i[1]||0!==i[2]}function at(t,e,i,r){var s=E.dotVec3(e,i)+t,o=E.normalizeVec3(e,it);return E.mulVec3Scalar(o,-s,r),r}var nt=E.vec4(),lt=E.vec4(),ht=function(t){function e(e,i){var r=this;t.call(this,e,i),this._entity=null,this._visible=null,this._worldPos=E.vec3(),this._rtcCenter=E.vec3(),this._rtcPos=E.vec3(),this._viewPos=E.vec3(),this._canvasPos=E.vec2(),this._occludable=!1,this._onCameraViewMatrix=this.scene.camera.on("matrix",(function(){r._viewPosDirty=!0,r._needUpdate()})),this._onCameraProjMatrix=this.scene.camera.on("projMatrix",(function(){r._canvasPosDirty=!0,r._needUpdate()})),this._onEntityDestroyed=null,this._onEntityModelDestroyed=null,this._renderer.addMarker(this),this.entity=i.entity,this.worldPos=i.worldPos,this.occludable=i.occludable}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={entity:{configurable:!0},occludable:{configurable:!0},worldPos:{configurable:!0},rtcCenter:{configurable:!0},rtcPos:{configurable:!0},viewPos:{configurable:!0},canvasPos:{configurable:!0},visible:{configurable:!0}};return e.prototype._update=function(){if(this._viewPosDirty&&(E.transformPoint3(this.scene.camera.viewMatrix,this._worldPos,this._viewPos),this._viewPosDirty=!1,this._canvasPosDirty=!0,this.fire("viewPos",this._viewPos)),this._canvasPosDirty){nt.set(this._viewPos),nt[3]=1,E.transformPoint4(this.scene.camera.projMatrix,nt,lt);var t=this.scene.canvas.boundary;this._canvasPos[0]=Math.floor((1+lt[0]/lt[3])*t[2]/2),this._canvasPos[1]=Math.floor((1-lt[1]/lt[3])*t[3]/2),this._canvasPosDirty=!1,this.fire("canvasPos",this._canvasPos)}},e.prototype._setVisible=function(t){this._visible,this._visible=t,this.fire("visible",this._visible)},i.entity.set=function(t){var e=this;if(this._entity){if(this._entity===t)return;null!==this._onEntityDestroyed&&(this._entity.off(this._onEntityDestroyed),this._onEntityDestroyed=null),null!==this._onEntityModelDestroyed&&(this._entity.model.off(this._onEntityModelDestroyed),this._onEntityModelDestroyed=null)}this._entity=t,this._entity&&(this._entity instanceof tt?this._onEntityModelDestroyed=this._entity.model.on("destroyed",(function(){e._entity=null,e._onEntityModelDestroyed=null})):this._onEntityDestroyed=this._entity.on("destroyed",(function(){e._entity=null,e._onEntityDestroyed=null}))),this.fire("entity",this._entity,!0)},i.entity.get=function(){return this._entity},i.occludable.set=function(t){(t=!!t)!==this._occludable&&(this._occludable=t)},i.occludable.get=function(){return this._occludable},i.worldPos.set=function(t){this._worldPos.set(t||[0,0,0]),st(this._worldPos,this._rtcCenter,this._rtcPos),this._occludable&&this._renderer.markerWorldPosUpdated(this),this._viewPosDirty=!0,this.fire("worldPos",this._worldPos)},i.worldPos.get=function(){return this._worldPos},i.rtcCenter.get=function(){return this._rtcCenter},i.rtcPos.get=function(){return this._rtcPos},i.viewPos.get=function(){return this._update(),this._viewPos},i.canvasPos.get=function(){return this._update(),this._canvasPos},i.visible.get=function(){return!!this._visible},e.prototype.destroy=function(){this.fire("destroyed",!0),this.scene.camera.off(this._onCameraViewMatrix),this.scene.camera.off(this._onCameraProjMatrix),this._entity&&(null!==this._onEntityDestroyed&&this._entity.off(this._onEntityDestroyed),null!==this._onEntityModelDestroyed&&this._entity.model.off(this._onEntityModelDestroyed)),this._renderer.removeMarker(this),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(U),ut=function(t,e){void 0===e&&(e={}),this._wire=document.createElement("div"),this._wire.className+=this._wire.className?" viewer-ruler-wire":"viewer-ruler-wire",this._visible=!0;var i=this._wire,r=i.style;this._thickness=e.thickness||1,r.border="solid "+this._thickness+"px "+(e.color||"black"),r.position="absolute",r["z-index"]="2000001",r.width="0px",r.height="0px",r.visibility="visible",r.top="0px",r.left="0px",r["pointer-events"]="none",r["-webkit-transform-origin"]="0 0",r["-moz-transform-origin"]="0 0",r["-ms-transform-origin"]="0 0",r["-o-transform-origin"]="0 0",r["transform-origin"]="0 0",r["-webkit-transform"]="rotate(0deg)",r["-moz-transform"]="rotate(0deg)",r["-ms-transform"]="rotate(0deg)",r["-o-transform"]="rotate(0deg)",r.transform="rotate(0deg)",r.opacity=1,t.appendChild(i),this._x1=0,this._y1=0,this._x2=0,this._y2=0,this._update()};ut.prototype._update=function(){var t=Math.abs(Math.sqrt((this._x1-this._x2)*(this._x1-this._x2)+(this._y1-this._y2)*(this._y1-this._y2))),e=180*Math.atan2(this._y2-this._y1,this._x2-this._x1)/Math.PI,i=this._wire.style;i.width=Math.round(t)+"px",i.left=Math.round(this._x1)+"px",i.top=Math.round(this._y1)+"px",i["-webkit-transform"]="rotate("+e+"deg)",i["-moz-transform"]="rotate("+e+"deg)",i["-ms-transform"]="rotate("+e+"deg)",i["-o-transform"]="rotate("+e+"deg)",i.transform="rotate("+e+"deg)",i["pointer-events"]="none"},ut.prototype.setStartAndEnd=function(t,e,i,r){this._x1=t,this._y1=e,this._x2=i,this._y2=r,this._update()},ut.prototype.setColor=function(t){this._wire.style.border="solid "+this._thickness+"px "+(t||"black")},ut.prototype.setOpacity=function(t){this._wire.style.opacity=t},ut.prototype.setVisible=function(t){t=!!t,this._visible!==t&&(this._visible=t,this._wire.style.visibility=this._visible?"visible":"hidden")},ut.prototype.destroy=function(t){this._wire.parentElement.removeChild(this._wire)};var ct=function(t,e){void 0===e&&(e={}),this._x=0,this._y=0,this._visible=!0,this._dot=document.createElement("div"),this._dot.className+=this._dot.className?" viewer-ruler-dot":"viewer-ruler-dot";var i=this._dot,r=i.style;r["border-radius"]="25px",r.border="solid 2px white",r.background="lightgreen",r.position="absolute",r["z-index"]="40000005",r.width="8px",r.height="8px",r.visibility="visible",r.top="0px",r.left="0px",r["box-shadow"]="0 2px 5px 0 #182A3D;",r["pointer-events"]="none",r.opacity=1,t.appendChild(i),this.setPos(e.x||0,e.y||0),this.setFillColor(e.fillColor),this.setBorderColor(e.borderColor),this.setClickable(!1)};ct.prototype.setPos=function(t,e){this._x=t,this._y=e;var i=this._dot.style;i.left=Math.round(t)-5+"px",i.top=Math.round(e)-5+"px"},ct.prototype.setFillColor=function(t){this._dot.style.background=t||"lightgreen"},ct.prototype.setBorderColor=function(t){this._dot.style.border="solid 2px"+(t||"black")},ct.prototype.setOpacity=function(t){this._dot.style.opacity=t},ct.prototype.setVisible=function(t){this._visible!==t&&(this._visible=!!t,this._dot.style.visibility=this._visible?"visible":"hidden")},ct.prototype.setClickable=function(t){this._dot.style["pointer-events"]=t?"all":"none"},ct.prototype.destroy=function(){this.setVisible(!1),this._dot.parentElement.removeChild(this._dot)};var pt=function(t,e){void 0===e&&(e={}),this._prefix=e.prefix||"",this._x=0,this._y=0,this._visible=!0,this._label=document.createElement("div"),this._label.className+=this._label.className?" viewer-ruler-label":"viewer-ruler-label";var i=this._label,r=i.style;r["border-radius"]="5px",r.color="white",r.padding="4px",r.border="solid 0px white",r.background="lightgreen",r.position="absolute",r["z-index"]="5000005",r.width="auto",r.height="auto",r.visibility="visible",r.top="0px",r.left="0px",r["pointer-events"]="none",r.opacity=1,i.innerText="",t.appendChild(i),this.setPos(e.x||0,e.y||0),this.setFillColor(e.fillColor),this.setBorderColor(e.borderColor),this.setText(e.text)};pt.prototype.setPos=function(t,e){this._x=t,this._y=e;var i=this._label.style;i.left=Math.round(t)-20+"px",i.top=Math.round(e)-12+"px"},pt.prototype.setPosOnWire=function(t,e,i,r){var s=t+.5*(i-t),o=e+.5*(r-e),a=this._label.style;a.left=Math.round(s)-20+"px",a.top=Math.round(o)-12+"px"},pt.prototype.setPosBetweenWires=function(t,e,i,r,s,o){var a=(t+i+s)/3,n=(e+r+o)/3,l=this._label.style;l.left=Math.round(a)-20+"px",l.top=Math.round(n)-12+"px"},pt.prototype.setText=function(t){this._label.innerHTML=this._prefix+(t||"")},pt.prototype.setFillColor=function(t){this._label.style.background=t||"lightgreen"},pt.prototype.setBorderColor=function(t){this._label.style.border="solid 2px"+(t||"black")},pt.prototype.setOpacity=function(t){this._label.style.opacity=t},pt.prototype.setVisible=function(t){this._visible!==t&&(this._visible=!!t,this._label.style.visibility=this._visible?"visible":"hidden")},pt.prototype.destroy=function(){this._label.parentElement.removeChild(this._label)};var dt=E.vec3(),ft=E.vec3(),_t=function(t){function e(e,i){var r=this;if(void 0===i&&(i={}),t.call(this,e.viewer.scene,i),this.plugin=e,this._container=i.container,!this._container)throw"config missing: container";var s=this.plugin.viewer.scene;this._originMarker=new ht(s,i.origin),this._cornerMarker=new ht(s,i.corner),this._targetMarker=new ht(s,i.target),this._originWorld=E.vec3(),this._cornerWorld=E.vec3(),this._targetWorld=E.vec3(),this._wp=new Float64Array(12),this._vp=new Float64Array(12),this._pp=new Float64Array(12),this._cp=new Int16Array(6),this._originDot=new ct(this._container,{}),this._cornerDot=new ct(this._container,{}),this._targetDot=new ct(this._container,{}),this._originWire=new ut(this._container,{color:"blue",thickness:1}),this._targetWire=new ut(this._container,{color:"red",thickness:1}),this._angleLabel=new pt(this._container,{fillColor:"#00BBFF",prefix:"",text:""}),this._wpDirty=!1,this._vpDirty=!1,this._cpDirty=!1,this._visible=!1,this._originVisible=!1,this._cornerVisible=!1,this._targetVisible=!1,this._originWireVisible=!1,this._targetWireVisible=!1,this._angleVisible=!1,this._originMarker.on("worldPos",(function(t){r._originWorld.set(t||[0,0,0]),r._wpDirty=!0,r._needUpdate(0)})),this._cornerMarker.on("worldPos",(function(t){r._cornerWorld.set(t||[0,0,0]),r._wpDirty=!0,r._needUpdate(0)})),this._targetMarker.on("worldPos",(function(t){r._targetWorld.set(t||[0,0,0]),r._wpDirty=!0,r._needUpdate(0)})),this._onViewMatrix=s.camera.on("viewMatrix",(function(){r._vpDirty=!0,r._needUpdate(0)})),this._onProjMatrix=s.camera.on("projMatrix",(function(){r._cpDirty=!0,r._needUpdate()})),this._onCanvasBoundary=s.canvas.on("boundary",(function(){r._cpDirty=!0,r._needUpdate(0)})),this.approximate=i.approximate,this.visible=i.visible,this.originVisible=i.originVisible,this.cornerVisible=i.cornerVisible,this.targetVisible=i.targetVisible,this.originWireVisible=i.originWireVisible,this.targetWireVisible=i.targetWireVisible,this.angleVisible=i.angleVisible}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={approximate:{configurable:!0},origin:{configurable:!0},corner:{configurable:!0},target:{configurable:!0},angle:{configurable:!0},visible:{configurable:!0},originVisible:{configurable:!0},cornerVisible:{configurable:!0},targetVisible:{configurable:!0},originWireVisible:{configurable:!0},targetWireVisible:{configurable:!0},angleVisible:{configurable:!0}};return e.prototype._update=function(){if(this._visible){var t=this.plugin.viewer.scene;if(this._wpDirty&&(this._wp[0]=this._originWorld[0],this._wp[1]=this._originWorld[1],this._wp[2]=this._originWorld[2],this._wp[3]=1,this._wp[4]=this._cornerWorld[0],this._wp[5]=this._cornerWorld[1],this._wp[6]=this._cornerWorld[2],this._wp[7]=1,this._wp[8]=this._targetWorld[0],this._wp[9]=this._targetWorld[1],this._wp[10]=this._targetWorld[2],this._wp[11]=1,this._wpDirty=!1,this._vpDirty=!0),this._vpDirty&&(E.transformPositions4(t.camera.viewMatrix,this._wp,this._vp),this._vp[3]=1,this._vp[7]=1,this._vp[11]=1,this._vpDirty=!1,this._cpDirty=!0),this._cpDirty){var e=-.3,i=this._originMarker.viewPos[2],r=this._cornerMarker.viewPos[2],s=this._targetMarker.viewPos[2];if(i>e||r>e||s>e)return this._originDot.setVisible(!1),this._cornerDot.setVisible(!1),this._targetDot.setVisible(!1),this._originWire.setVisible(!1),this._targetWire.setVisible(!1),void this._angleLabel.setVisible(!1);E.transformPositions4(t.camera.project.matrix,this._vp,this._pp);for(var o=this._pp,a=this._cp,n=t.canvas.canvas.getBoundingClientRect(),l=n.top,h=n.left,u=t.canvas.boundary,c=u[2],p=u[3],d=0,f=0,_=o.length;f<_;f+=4)a[d]=h+Math.floor((1+o[f+0]/o[f+3])*c/2),a[d+1]=l+Math.floor((1-o[f+1]/o[f+3])*p/2),d+=2;if(this._originDot.setPos(a[0],a[1]),this._cornerDot.setPos(a[2],a[3]),this._targetDot.setPos(a[4],a[5]),this._originWire.setStartAndEnd(a[0],a[1],a[2],a[3]),this._targetWire.setStartAndEnd(a[2],a[3],a[4],a[5]),this._angleLabel.setPosBetweenWires(a[0],a[1],a[2],a[3],a[4],a[5]),E.subVec3(this._originWorld,this._cornerWorld,dt),E.subVec3(this._targetWorld,this._cornerWorld,ft),!(0===dt[0]&&0===dt[1]&&0===dt[2]||0===ft[0]&&0===ft[1]&&0===ft[2])){var g=this._approximate?" ~ ":" = ";E.normalizeVec3(dt),E.normalizeVec3(ft);var m=Math.abs(E.angleVec3(dt,ft));this._angle=m/E.DEGTORAD,this._angleLabel.setText(g+this._angle.toFixed(2)+"°")}else this._angleLabel.setText("");this._originDot.setVisible(this._visible&&this._originVisible),this._cornerDot.setVisible(this._visible&&this._cornerVisible),this._targetDot.setVisible(this._visible&&this._targetVisible),this._originWire.setVisible(this._visible&&this._originWireVisible),this._targetWire.setVisible(this._visible&&this._targetWireVisible),this._angleLabel.setVisible(this._visible&&this._angleVisible),this._cpDirty=!1}}},i.approximate.set=function(t){t=!1!==t,this._approximate!==t&&(this._approximate=t,this._cpDirty=!0,this._needUpdate(0))},i.approximate.get=function(){return this._approximate},i.origin.get=function(){return this._originMarker},i.corner.get=function(){return this._cornerMarker},i.target.get=function(){return this._targetMarker},i.angle.get=function(){return this._update(),this._angle},i.visible.set=function(t){t=!1!==t,this._visible=t,this._originDot.setVisible(this._visible&&this._originVisible),this._cornerDot.setVisible(this._visible&&this._cornerVisible),this._targetDot.setVisible(this._visible&&this._targetVisible),this._originWire.setVisible(this._visible&&this._originWireVisible),this._targetWire.setVisible(this._visible&&this._targetWireVisible),this._angleLabel.setVisible(this._visible&&this._angleVisible)},i.visible.get=function(){return this._visible},i.originVisible.set=function(t){t=!1!==t,this._originVisible=t,this._originDot.setVisible(this._visible&&this._originVisible)},i.originVisible.get=function(){return this._originVisible},i.cornerVisible.set=function(t){t=!1!==t,this._cornerVisible=t,this._cornerDot.setVisible(this._visible&&this._cornerVisible)},i.cornerVisible.get=function(){return this._cornerVisible},i.targetVisible.set=function(t){t=!1!==t,this._targetVisible=t,this._targetDot.setVisible(this._visible&&this._targetVisible)},i.targetVisible.get=function(){return this._targetVisible},i.originWireVisible.set=function(t){t=!1!==t,this._originWireVisible=t,this._originWire.setVisible(this._visible&&this._originWireVisible)},i.originWireVisible.get=function(){return this._originWireVisible},i.targetWireVisible.set=function(t){t=!1!==t,this._targetWireVisible=t,this._targetWire.setVisible(this._visible&&this._targetWireVisible)},i.targetWireVisible.get=function(){return this._targetWireVisible},i.angleVisible.set=function(t){t=!1!==t,this._angleVisible=t,this._angleLabel.setVisible(this._visible&&this._angleVisible)},i.angleVisible.get=function(){return this._angleVisible},e.prototype.destroy=function(){var e=this.plugin.viewer.scene;this._onViewMatrix&&e.camera.off(this._onViewMatrix),this._onProjMatrix&&e.camera.off(this._onProjMatrix),this._onCanvasBoundary&&e.canvas.off(this._onCanvasBoundary),this._originDot.destroy(),this._cornerDot.destroy(),this._targetDot.destroy(),this._originWire.destroy(),this._targetWire.destroy(),this._angleLabel.destroy(),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(U),gt=function(t){function e(e){t.call(this,e.viewer.scene),this.plugin=e,this._active=!1,this._state=0,this._currentAngleMeasurement=null,this._previousAngleMeasurement=null,this._onhoverSurface=null,this._onHoverNothing=null}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={active:{configurable:!0}};return i.active.get=function(){return this._active},e.prototype.activate=function(){var t=this;if(!this._active){var e,i,r=this.plugin.viewer.cameraControl,s=!1,o=null,a=E.vec3(),n=E.vec2(),l=this.plugin.viewer.scene.pickSurfacePrecisionEnabled;this._onhoverSurface=r.on("hoverSurface",(function(e){if(s=!0,o=e.entity,a.set(e.worldPos),n.set(e.canvasPos),0!==t._state){if(t._currentAngleMeasurement)switch(t._state){case 2:t._currentAngleMeasurement.originWireVisible=!0,t._currentAngleMeasurement.targetWireVisible=!1,t._currentAngleMeasurement.cornerVisible=!0,t._currentAngleMeasurement.angleVisible=!1,t._currentAngleMeasurement.corner.entity=e.entity,t._currentAngleMeasurement.corner.worldPos=e.worldPos,document.body.style.cursor="pointer";break;case 3:t._currentAngleMeasurement.targetWireVisible=!0,t._currentAngleMeasurement.targetVisible=!0,t._currentAngleMeasurement.angleVisible=!0,t._currentAngleMeasurement.target.entity=e.entity,t._currentAngleMeasurement.target.worldPos=e.worldPos,document.body.style.cursor="pointer"}}else document.body.style.cursor="pointer"}));this._onInputMouseDown=this.plugin.viewer.scene.input.on("mousedown",(function(t){e=t[0],i=t[1]})),this._onInputMouseUp=this.plugin.viewer.scene.input.on("mouseup",(function(r){if(!(r[0]>e+5||r[0]<e-5||r[1]>i+5||r[1]<i-5))switch(t._state){case 0:if(t._previousAngleMeasurement&&(t._previousAngleMeasurement.originVisible=!0,t._previousAngleMeasurement.cornerVisible=!0,t._previousAngleMeasurement.targetVisible=!0),s){if(l){var h=t.plugin.viewer.scene.pick({canvasPos:n,pickSurface:!0,pickSurfacePrecision:!0});h&&h.worldPos&&a.set(h.worldPos)}t._currentAngleMeasurement=t.plugin.createMeasurement({id:E.createUUID(),origin:{entity:o,worldPos:a},corner:{entity:o,worldPos:a},target:{entity:o,worldPos:a},approximate:!0}),t._currentAngleMeasurement.originVisible=!0,t._currentAngleMeasurement.originWireVisible=!0,t._currentAngleMeasurement.cornerVisible=!1,t._currentAngleMeasurement.targetWireVisible=!1,t._currentAngleMeasurement.targetVisible=!1,t._currentAngleMeasurement.angleVisible=!1,t._previousAngleMeasurement=t._currentAngleMeasurement,t._state=2}break;case 2:if(s){if(l){var u=t.plugin.viewer.scene.pick({canvasPos:n,pickSurface:!0,pickSurfacePrecision:!0});u&&u.worldPos&&(t._currentAngleMeasurement.corner.worldPos=u.worldPos)}t._currentAngleMeasurement.targetWireVisible=!1,t._currentAngleMeasurement.targetVisible=!0,t._currentAngleMeasurement.angleVisible=!0,t._state=3}else t._currentAngleMeasurement&&(t._currentAngleMeasurement.destroy(),t._currentAngleMeasurement=null,t._previousAngleMeasurement=null,t._state=0);break;case 3:if(s){if(l){var c=t.plugin.viewer.scene.pick({canvasPos:n,pickSurface:!0,pickSurfacePrecision:!0});c&&c.worldPos&&(t._currentAngleMeasurement.target.worldPos=c.worldPos,t._currentAngleMeasurement.approximate=!1)}t._currentAngleMeasurement.targetVisible=!0,t._currentAngleMeasurement.angleVisible=!0,t._currentAngleMeasurement=null,t._previousAngleMeasurement=null,t._state=0}else t._currentAngleMeasurement&&(t._currentAngleMeasurement.destroy(),t._currentAngleMeasurement=null,t._previousAngleMeasurement=null,t._state=0)}})),this._onHoverNothing=r.on("hoverOff",(function(e){if(s=!1,t._currentAngleMeasurement){switch(t._state){case 0:case 1:t._currentAngleMeasurement.originVisible=!1;break;case 2:t._currentAngleMeasurement.cornerVisible=!1,t._currentAngleMeasurement.originWireVisible=!1,t._currentAngleMeasurement.targetVisible=!1,t._currentAngleMeasurement.targetWireVisible=!1,t._currentAngleMeasurement.angleVisible=!1;break;case 3:t._currentAngleMeasurement.targetVisible=!1,t._currentAngleMeasurement.targetWireVisible=!1,t._currentAngleMeasurement.angleVisible=!1}document.body.style.cursor="default"}})),this._active=!0}},e.prototype.deactivate=function(){if(this._active){this.reset();var t=this.plugin.viewer.cameraControl,e=this.plugin.viewer.scene.input;e.off(this._onInputMouseDown),e.off(this._onInputMouseUp),t.off(this._onhoverSurface),t.off(this._onHoverNothing),this._currentAngleMeasurement=null,this._active=!1}},e.prototype.reset=function(){this._active&&(this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null),this._previousAngleMeasurement=null,this._state=0)},e.prototype.destroy=function(){this.deactivate(),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(U),mt=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,"AngleMeasurements",e),this._container=i.container||document.body,this._control=new gt(this),this._measurements={}}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={control:{configurable:!0},measurements:{configurable:!0}};return e.prototype.send=function(t,e){},i.control.get=function(){return this._control},i.measurements.get=function(){return this._measurements},e.prototype.createMeasurement=function(t){var e=this;void 0===t&&(t={}),this.viewer.scene.components[t.id]&&(this.error("Viewer scene component with this ID already exists: "+t.id),delete t.id);var i=t.origin,r=t.corner,s=t.target,o=new _t(this,{id:t.id,plugin:this,container:this._container,origin:{entity:i.entity,worldPos:i.worldPos},corner:{entity:r.entity,worldPos:r.worldPos},target:{entity:s.entity,worldPos:s.worldPos},visible:t.visible,originVisible:!0,originWireVisible:!0,cornerVisible:!0,targetWireVisible:!0,targetVisible:!0});return this._measurements[o.id]=o,o.on("destroyed",(function(){delete e._measurements[o.id]})),o},e.prototype.destroyMeasurement=function(t){var e=this._measurements[t];e?e.destroy():this.log("AngleMeasurement not found: "+t)},e.prototype.clear=function(){for(var t=Object.keys(this._measurements),e=0,i=t.length;e<i;e++)this.destroyMeasurement(t[e])},e.prototype.destroy=function(){this.clear(),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(n),vt=function(t){function e(e,i){var r=this;if(t.call(this,e,i),this.plugin=i.plugin,this._container=i.container,!this._container)throw"config missing: container";if(!i.markerElement&&!i.markerHTML)throw"config missing: need either markerElement or markerHTML";if(!i.labelElement&&!i.labelHTML)throw"config missing: need either labelElement or labelHTML";this._htmlDirty=!1,i.markerElement?(this._marker=i.markerElement,this._marker.addEventListener("click",this._onMouseClickedExternalMarker=function(){r.plugin.fire("markerClicked",r)}),this._marker.addEventListener("mouseenter",this._onMouseEnterExternalMarker=function(){r.plugin.fire("markerMouseEnter",r)}),this._marker.addEventListener("mouseleave",this._onMouseLeaveExternalMarker=function(){r.plugin.fire("markerMouseLeave",r)}),this._markerExternal=!0):(this._markerHTML=i.markerHTML,this._htmlDirty=!0,this._markerExternal=!1),i.labelElement?(this._label=i.labelElement,this._labelExternal=!0):(this._labelHTML=i.labelHTML,this._htmlDirty=!0,this._labelExternal=!1),this._markerShown=!!i.markerShown,this._labelShown=!!i.labelShown,this._values=i.values||{},this._layoutDirty=!0,this._visibilityDirty=!0,this._buildHTML(),this._onTick=this.scene.on("tick",(function(){r._htmlDirty&&(r._buildHTML(),r._htmlDirty=!1,r._layoutDirty=!0,r._visibilityDirty=!0),(r._layoutDirty||r._visibilityDirty)&&(r._markerShown||r._labelShown)&&(r._updatePosition(),r._layoutDirty=!1),r._visibilityDirty&&(r._marker.style.visibility=r.visible&&r._markerShown?"visible":"hidden",r._label.style.visibility=r.visible&&r._markerShown&&r._labelShown?"visible":"hidden",r._visibilityDirty=!1)})),this.on("canvasPos",(function(){r._layoutDirty=!0})),this.on("visible",(function(){r._visibilityDirty=!0})),this.setMarkerShown(!1!==i.markerShown),this.setLabelShown(i.labelShown),this.eye=i.eye?i.eye.slice():null,this.look=i.look?i.look.slice():null,this.up=i.up?i.up.slice():null,this.projection=i.projection}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype._buildHTML=function(){var t=this;if(!this._markerExternal){this._marker&&(this._container.removeChild(this._marker),this._marker=null);var e=this._markerHTML||"<p></p>";B.isArray(e)&&(e=e.join("")),e=this._renderTemplate(e);var i=document.createRange().createContextualFragment(e);this._marker=i.firstChild,this._container.appendChild(this._marker),this._marker.style.visibility=this._markerShown?"visible":"hidden",this._marker.addEventListener("click",(function(){t.plugin.fire("markerClicked",t)})),this._marker.addEventListener("mouseenter",(function(){t.plugin.fire("markerMouseEnter",t)})),this._marker.addEventListener("mouseleave",(function(){t.plugin.fire("markerMouseLeave",t)}))}if(!this._labelExternal){this._label&&(this._container.removeChild(this._label),this._label=null);var r=this._labelHTML||"<p></p>";B.isArray(r)&&(r=r.join("")),r=this._renderTemplate(r);var s=document.createRange().createContextualFragment(r);this._label=s.firstChild,this._container.appendChild(this._label),this._label.style.visibility=this._markerShown&&this._labelShown?"visible":"hidden"}},e.prototype._updatePosition=function(){var t=this.scene.canvas.boundary,e=t[0],i=t[1],r=this.canvasPos;this._marker.style.left=Math.floor(e+r[0])-12+"px",this._marker.style.top=Math.floor(i+r[1])-12+"px",this._marker.style["z-index"]=90005+Math.floor(this._viewPos[2])+1;this._label.style.left=20+Math.floor(e+r[0]+20)+"px",this._label.style.top=Math.floor(i+r[1]+-17)+"px",this._label.style["z-index"]=90005+Math.floor(this._viewPos[2])+1},e.prototype._renderTemplate=function(t){for(var e in this._values)if(this._values.hasOwnProperty(e)){var i=this._values[e];t=t.replace(new RegExp("{{"+e+"}}","g"),i)}return t},e.prototype.setMarkerShown=function(t){t=!!t,this._markerShown!==t&&(this._markerShown=t,this._visibilityDirty=!0)},e.prototype.getMarkerShown=function(){return this._markerShown},e.prototype.setLabelShown=function(t){t=!!t,this._labelShown!==t&&(this._labelShown=t,this._visibilityDirty=!0)},e.prototype.getLabelShown=function(){return this._labelShown},e.prototype.setField=function(t,e){this._values[t]=e||"",this._htmlDirty=!0},e.prototype.getField=function(t){return this._values[t]},e.prototype.setValues=function(t){for(var e in t)if(t.hasOwnProperty(e)){var i=t[e];this.setField(e,i)}},e.prototype.getValues=function(){return this._values},e.prototype.destroy=function(){this._marker&&(this._markerExternal?(this._marker.removeEventListener("click",this._onMouseClickedExternalMarker),this._marker.removeEventListener("mouseenter",this._onMouseEnterExternalMarker),this._marker.removeEventListener("mouseleave",this._onMouseLeaveExternalMarker),this._marker=null):this._marker.parentNode.removeChild(this._marker)),this._label&&(this._labelExternal||this._label.parentNode.removeChild(this._label),this._label=null),this.scene.off(this._onTick),t.prototype.destroy.call(this)},e}(ht),bt=E.vec3(),yt=E.vec3(),Pt=E.vec3(),Mt=function(t){function e(e,i){t.call(this,"Annotations",e),this._labelHTML=i.labelHTML||"<div></div>",this._markerHTML=i.markerHTML||"<div></div>",this._container=i.container||document.body,this._values=i.values||{},this.annotations={},this.surfaceOffset=i.surfaceOffset}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={surfaceOffset:{configurable:!0}};return e.prototype.send=function(t,e){switch(t){case"clearAnnotations":this.clear()}},i.surfaceOffset.set=function(t){null==t&&(t=.3),this._surfaceOffset=t},i.surfaceOffset.get=function(){return this._surfaceOffset},e.prototype.createAnnotation=function(t){var e,i,r=this;if(this.viewer.scene.components[t.id]&&(this.error("Viewer component with this ID already exists: "+t.id),delete t.id),t.pickResult=t.pickResult||t.pickRecord,t.pickResult){var s=t.pickResult;if(s.worldPos&&s.worldNormal){var o=E.normalizeVec3(s.worldNormal,bt),a=E.mulVec3Scalar(o,this._surfaceOffset,yt);e=E.addVec3(s.worldPos,a,Pt),i=s.entity}else this.error("Param 'pickResult' does not have both worldPos and worldNormal")}else e=t.worldPos,i=t.entity;var n=null;t.markerElementId&&((n=document.getElementById(t.markerElementId))||this.error("Can't find DOM element for 'markerElementId' value '"+t.markerElementId+"' - defaulting to internally-generated empty DIV"));var l=null;t.labelElementId&&((l=document.getElementById(t.labelElementId))||this.error("Can't find DOM element for 'labelElementId' value '"+t.labelElementId+"' - defaulting to internally-generated empty DIV"));var h=new vt(this.viewer.scene,{id:t.id,plugin:this,entity:i,worldPos:e,container:this._container,markerElement:n,labelElement:l,markerHTML:t.markerHTML||this._markerHTML,labelHTML:t.labelHTML||this._labelHTML,occludable:t.occludable,values:B.apply(t.values,B.apply(this._values,{})),markerShown:t.markerShown,labelShown:t.labelShown,eye:t.eye,look:t.look,up:t.up,projection:t.projection,visible:!1!==t.visible});return this.annotations[h.id]=h,h.on("destroyed",(function(){delete r.annotations[h.id],r.fire("annotationDestroyed",h.id)})),this.fire("annotationCreated",h.id),h},e.prototype.destroyAnnotation=function(t){var e=this.annotations[t];e?e.destroy():this.log("Annotation not found: "+t)},e.prototype.clear=function(){for(var t=Object.keys(this.annotations),e=0,i=t.length;e<i;e++)this.destroyAnnotation(t[e])},e.prototype.destroy=function(){this.clear(),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(n),xt=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._canvas=i.canvas,this._element=null,this._isCustom=!1,i.elementId&&(this._element=document.getElementById(i.elementId),this._element?this._adjustPosition():this.error("Can't find given Spinner HTML element: '"+i.elementId+"' - will automatically create default element")),this._element||this._createDefaultSpinner(),this.processes=0}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},processes:{configurable:!0}};return i.type.get=function(){return"Spinner"},e.prototype._createDefaultSpinner=function(){this._injectDefaultCSS();var t=document.createElement("div"),e=t.style;e["z-index"]="9000",e.position="absolute",t.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(t),this._element=t,this._isCustom=!1,this._adjustPosition()},e.prototype._injectDefaultCSS=function(){var t="xeokit-spinner-css";if(!document.getElementById(t)){var e=document.createElement("style");e.innerHTML=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }",e.id=t,document.body.appendChild(e)}},e.prototype._adjustPosition=function(){if(!this._isCustom){var t=this._canvas,e=this._element,i=e.style;i.left=t.offsetLeft+.5*t.clientWidth-.5*e.clientWidth+"px",i.top=t.offsetTop+.5*t.clientHeight-.5*e.clientHeight+"px"}},i.processes.set=function(t){if(t=t||0,this._processes!==t&&!(t<0)){var e=this._processes;this._processes=t;var i=this._element;i&&(i.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),0===this._processes&&this._processes!==e&&this.fire("zeroProcesses",this._processes)}},i.processes.get=function(){return this._processes},e.prototype._destroy=function(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null);var t=document.getElementById("xeokit-spinner-css");t&&t.parentNode.removeChild(t)},Object.defineProperties(e.prototype,i),e}(U),wt={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},Et=document.createElement("canvas");if(Et){var Ct=Et.getContext("webgl",{antialias:!0})||Et.getContext("experimental-webgl",{antialias:!0});wt.WEBGL=!!Ct,wt.WEBGL&&(wt.ANTIALIAS=Ct.getContextAttributes().antialias,Ct.getShaderPrecisionFormat?Ct.getShaderPrecisionFormat(Ct.FRAGMENT_SHADER,Ct.HIGH_FLOAT).precision>0?wt.FS_MAX_FLOAT_PRECISION="highp":Ct.getShaderPrecisionFormat(Ct.FRAGMENT_SHADER,Ct.MEDIUM_FLOAT).precision>0?wt.FS_MAX_FLOAT_PRECISION="mediump":wt.FS_MAX_FLOAT_PRECISION="lowp":wt.FS_MAX_FLOAT_PRECISION="mediump",wt.DEPTH_BUFFER_BITS=Ct.getParameter(Ct.DEPTH_BITS),wt.MAX_TEXTURE_SIZE=Ct.getParameter(Ct.MAX_TEXTURE_SIZE),wt.MAX_CUBE_MAP_SIZE=Ct.getParameter(Ct.MAX_CUBE_MAP_TEXTURE_SIZE),wt.MAX_RENDERBUFFER_SIZE=Ct.getParameter(Ct.MAX_RENDERBUFFER_SIZE),wt.MAX_TEXTURE_UNITS=Ct.getParameter(Ct.MAX_COMBINED_TEXTURE_IMAGE_UNITS),wt.MAX_TEXTURE_IMAGE_UNITS=Ct.getParameter(Ct.MAX_TEXTURE_IMAGE_UNITS),wt.MAX_VERTEX_ATTRIBS=Ct.getParameter(Ct.MAX_VERTEX_ATTRIBS),wt.MAX_VERTEX_UNIFORM_VECTORS=Ct.getParameter(Ct.MAX_VERTEX_UNIFORM_VECTORS),wt.MAX_FRAGMENT_UNIFORM_VECTORS=Ct.getParameter(Ct.MAX_FRAGMENT_UNIFORM_VECTORS),wt.MAX_VARYING_VECTORS=Ct.getParameter(Ct.MAX_VARYING_VECTORS),Ct.getSupportedExtensions().forEach((function(t){wt.SUPPORTED_EXTENSIONS[t]=!0})),wt.depthTexturesSupported=wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture)}var At=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],St=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._backgroundColor=E.vec3([i.backgroundColor?i.backgroundColor[0]:1,i.backgroundColor?i.backgroundColor[1]:1,i.backgroundColor?i.backgroundColor[2]:1]),this._backgroundColorFromAmbientLight=!!i.backgroundColorFromAmbientLight,this.canvas=i.canvas,this.gl=null,this.webgl2=!1,this.transparent=!!i.transparent,this.contextAttr=i.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!!this.contextAttr.preserveDrawingBuffer,this.contextAttr.stencil=!1,this.contextAttr.premultipliedAlpha=!!this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=!1!==this.contextAttr.antialias,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._initWebGL(i);var r=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(t){console.time("webglcontextrestored"),r.scene._webglContextLost(),r.fire("webglcontextlost"),t.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(t){r._initWebGL(),r.gl&&(r.scene._webglContextRestored(r.gl),r.fire("webglcontextrestored",r.gl),t.preventDefault()),console.timeEnd("webglcontextrestored")},!1);var s=null,o=null,a=null,n=null,l=null,h=null,u=null;this._tick=this.scene.on("tick",(function(){var t=r.canvas,e=window.innerWidth!==s||window.innerHeight!==o,i=t.clientWidth!==a||t.clientHeight!==n,c=t.offsetLeft!==l||t.offsetTop!==h,p=t.parentElement;if(e||i||c||p!==u){if(r._spinner._adjustPosition(),i||c){var d=t.clientWidth,f=t.clientHeight;if(i){var _,g=0;for(var m in V.scenes)V.scenes.hasOwnProperty(m)&&(g+=(_=V.scenes[m]).canvas.canvas.clientWidth*_.canvas.canvas.clientHeight);S.memory.pixels=g,t.width=t.clientWidth,t.height=t.clientHeight}var v=r.boundary;v[0]=t.offsetLeft,v[1]=t.offsetTop,v[2]=d,v[3]=f,r.fire("boundary",v),a=d,n=f}e&&(s=window.innerWidth,o=window.innerHeight),c&&(l=t.offsetLeft,h=t.offsetTop),u=p}})),this._spinner=new xt(this.scene,{canvas:this.canvas,elementId:i.spinnerElementId})}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},backgroundColorFromAmbientLight:{configurable:!0},backgroundColor:{configurable:!0},spinner:{configurable:!0}};return i.type.get=function(){return"Canvas"},e.prototype._createCanvas=function(){var t="xeokit-canvas-"+E.createUUID(),e=document.getElementsByTagName("body")[0],i=document.createElement("div"),r=i.style;r.height="100%",r.width="100%",r.padding="0",r.margin="0",r.background="rgba(0,0,0,0);",r.float="left",r.left="0",r.top="0",r.position="absolute",r.opacity="1.0",r["z-index"]="-10000",i.innerHTML+='<canvas id="'+t+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',e.appendChild(i),this.canvas=document.getElementById(t)},e.prototype._getElementXY=function(t){for(var e=0,i=0;t;)e+=t.offsetLeft-t.scrollLeft,i+=t.offsetTop-t.scrollTop,t=t.offsetParent;return{x:e,y:i}},e.prototype._initWebGL=function(){if(!this.gl)for(var t=0;!this.gl&&t<At.length;t++)try{this.gl=this.canvas.getContext(At[t],this.contextAttr)}catch(t){}if(this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0)),this.gl)if(this.webgl2)this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST);else{if(wt.SUPPORTED_EXTENSIONS.OES_standard_derivatives){var e=this.gl.getExtension("OES_standard_derivatives");this.gl.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,this.gl.FASTEST)}wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&this.gl.getExtension("EXT_frag_depth"),wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&this.gl.getExtension("WEBGL_depth_texture")}},i.backgroundColorFromAmbientLight.set=function(t){this._backgroundColorFromAmbientLight=!1!==t},i.backgroundColorFromAmbientLight.get=function(){return this._backgroundColorFromAmbientLight},i.backgroundColor.set=function(t){t?(this._backgroundColor[0]=t[0],this._backgroundColor[1]=t[1],this._backgroundColor[2]=t[2]):(this._backgroundColor[0]=1,this._backgroundColor[1]=1,this._backgroundColor[2]=1),this.glRedraw()},i.backgroundColor.get=function(){return this._backgroundColor},e.prototype.getSnapshot=function(t){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."},e.prototype.readPixels=function(t,e,i,r){return this.scene._renderer.readPixels(t,e,i,r)},e.prototype.loseWebGLContext=function(){this.canvas.loseContext&&this.canvas.loseContext()},i.spinner.get=function(){return this._spinner},e.prototype.destroy=function(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.gl=null,t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(U),Dt=function(t){this._scene=t,this._matPool=[],this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.reset()};Dt.prototype.reset=function(){this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.gl=this._scene.canvas.gl,this.lastProgramId=null,this.pbrEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.lineWidth=1},Dt.prototype.getRTCViewMatrix=function(t,e){var i=this._rtcViewMats[t];return i||(i=this._getNewMat(),rt(this._scene.camera.viewMatrix,e,i),this._rtcViewMats[t]=i),i},Dt.prototype.getRTCPickViewMatrix=function(t,e){var i=this._rtcPickViewMats[t];if(!i){i=this._getNewMat();var r=this.pickViewMatrix||this._scene.camera.viewMatrix;rt(r,e,i),this._rtcPickViewMats[t]=i}return i},Dt.prototype._getNewMat=function(){var t=this._matPool[this._matPoolNextFreeIndex];return t||(t=E.mat4(),this._matPool[this._matPoolNextFreeIndex]=t),this._matPoolNextFreeIndex++,t};var Lt=function(){var t=document.createElement("canvas"),e=String.fromCharCode;if(!t.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var i=!!t.getContext("2d").getImageData,r=!!t.toDataURL,s=!!window.btoa,o=function(t){var i="",r=t.width,s=t.height;i+="BM";var o=r*s*4+54;i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),i+=e(0,0,0,0,54,0,0,0),i+=e(40,0,0,0);var a=r;i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256);var n=s;i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),i+=e(1,0,32,0),i+=e(0,0,0,0);var l=r*s*4;i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),i+=e(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var h,u,c,p,d=t.data,f="",_=s;do{for(c=r*(_-1)*4,p="",h=0;h<r;h++)p+=e(d[c+(u=4*h)+2],d[c+u+1],d[c+u],d[c+u+3]);f+=p}while(--_);return function(t){var i,r,s="";if("string"==typeof t)s=t;else for(r=t,i=0;i<r.length;i++)s+=e(r[i]);return btoa(s)}(i+f)},a=function(t){window.open(t)||(document.location.href=t)},n=function(t,e){return"data:"+e+";base64,"+t},l=function(t){var e=document.createElement("img");return e.src=t,e},h=function(t,e,i,r){if(e&&i){var s=document.createElement("canvas");s.width=e,s.height=i,s.style.width=e+"px",s.style.height=i+"px";var o=s.getContext("2d");return r?(o.save(),o.scale(1,-1),o.imageSmoothingEnabled=!0,o.drawImage(t,0,0,t.width,t.height,0,0,e,-i),o.restore()):(o.imageSmoothingEnabled=!0,o.drawImage(t,0,0,t.width,t.height,0,0,e,i)),s}return t};return{saveAsPNG:function(t,e,i,s,o){if(!r)return!1;var n=h(t,i,s,o).toDataURL("image/png");return e?l(n):(a(n),!0)},saveAsJPEG:function(t,e,i,s,o){if(!r)return!1;var n="image/jpeg",u=h(t,i,s,o).toDataURL(n);return 5==u.indexOf(n)&&(e?l(u):(a(u),!0))},saveAsBMP:function(t,e,u,c,p){if(!(r&&i&&s))return!1;var d="image/bmp",f=function(t){var e=parseInt(t.width),i=parseInt(t.height);return t.getContext("2d").getImageData(0,0,e,i)}(h(t,u,c,p)),_=o(f);return e?l(n(_,d)):(a(n(_,d)),!0)}}}(),Bt=function(t,e,i){i=i||{},this.gl=e,this.allocated=!1,this.canvas=t,this.buffer=null,this.bound=!1,this.size=i.size,this._hasDepthTexture=!!i.depthTexture};Bt.prototype.setSize=function(t){this.size=t},Bt.prototype.webglContextRestored=function(t){this.gl=t,this.buffer=null,this.allocated=!1,this.bound=!1},Bt.prototype.bind=function(){if(this._touch(),!this.bound){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}},Bt.prototype._touch=function(){var t,e,i=this.gl;if(this.size?(t=this.size[0],e=this.size[1]):(t=i.drawingBufferWidth,e=i.drawingBufferHeight),this.buffer){if(this.buffer.width===t&&this.buffer.height===e)return;i.deleteTexture(this.buffer.texture),i.deleteFramebuffer(this.buffer.framebuf),i.deleteRenderbuffer(this.buffer.renderbuf)}var r,s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),this._hasDepthTexture&&(r=i.createTexture(),i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.DEPTH_COMPONENT,t,e,0,i.DEPTH_COMPONENT,i.UNSIGNED_INT,null));var o=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,o),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,t,e);var a=i.createFramebuffer();if(i.bindFramebuffer(i.FRAMEBUFFER,a),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0),this._hasDepthTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,r,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,o),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,a),!i.isFramebuffer(a))throw"Invalid framebuffer";i.bindFramebuffer(i.FRAMEBUFFER,null);var n=i.checkFramebufferStatus(i.FRAMEBUFFER);switch(n){case i.FRAMEBUFFER_COMPLETE:break;case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case i.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+n}this.buffer={framebuf:a,renderbuf:o,texture:s,depthTexture:r,width:t,height:e},this.bound=!1},Bt.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";var t=this.gl;t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)},Bt.prototype.read=function(t,e){var i=t,r=this.gl.drawingBufferHeight-e,s=new Uint8Array(4),o=this.gl;return o.readPixels(i,r,1,1,o.RGBA,o.UNSIGNED_BYTE,s),s},Bt.prototype.readImage=function(t){var e=this.gl,i=this._getImageDataCache(),r=i.pixelData,s=i.canvas,o=i.imageData,a=i.context;e.readPixels(0,0,this.buffer.width,this.buffer.height,e.RGBA,e.UNSIGNED_BYTE,r),o.data.set(r),a.putImageData(o,0,0);var n,l=t.width||s.width,h=t.height||s.height,u=t.format||"jpeg",c=!0;switch(u){case"jpeg":n=Lt.saveAsJPEG(s,!0,l,h,c);break;case"png":n=Lt.saveAsPNG(s,!0,l,h,c);break;case"bmp":n=Lt.saveAsBMP(s,!0,l,h,c);break;default:console.error("Unsupported image format: '"+u+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),n=Lt.saveAsJPEG(s,!0,l,h,c)}return n.src},Bt.prototype._getImageDataCache=function(){var t=this.buffer.width,e=this.buffer.height,i=this._imageDataCache;if(i&&(i.width===t&&i.height===e||(this._imageDataCache=null,i=null)),!i){var r=document.createElement("canvas");r.width=t,r.height=e;var s=r.getContext("2d"),o=s.createImageData(t,e);i={pixelData:new Uint8Array(t*e*4),canvas:r,context:s,imageData:o,width:t,height:e},this._imageDataCache=i}return i},Bt.prototype.unbind=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),this.bound=!1},Bt.prototype.getTexture=function(){var t=this;return this._texture||(this._texture={renderBuffer:this,bind:function(e){return!(!t.buffer||!t.buffer.texture)&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.texture),!0)},unbind:function(e){t.buffer&&t.buffer.texture&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}})},Bt.prototype.hasDepthTexture=function(){return this._hasDepthTexture},Bt.prototype.getDepthTexture=function(){if(!this._hasDepthTexture)return null;var t=this;return this._depthTexture||(this._dethTexture={renderBuffer:this,bind:function(e){return!(!t.buffer||!t.buffer.depthTexture)&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.depthTexture),!0)},unbind:function(e){t.buffer&&t.buffer.depthTexture&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}})},Bt.prototype.destroy=function(){if(this.allocated){var t=this.gl;t.deleteTexture(this.buffer.texture),t.deleteTexture(this.buffer.depthTexture),t.deleteFramebuffer(this.buffer.framebuf),t.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}this._imageDataCache=null,this._texture=null,this._depthTexture=null};var Rt=function(){this.entity=null,this.primitive=null,this.primIndex=-1,this.pickSurfacePrecision=!1,this._canvasPos=new Int16Array([0,0]),this._origin=new Float64Array([0,0,0]),this._direction=new Float64Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float64Array([0,0,0]),this._worldPos=new Float64Array([0,0,0]),this._viewPos=new Float64Array([0,0,0]),this._bary=new Float64Array([0,0,0]),this._worldNormal=new Float64Array([0,0,0]),this._uv=new Float64Array([0,0]),this.reset()},Tt={canvasPos:{configurable:!0},origin:{configurable:!0},direction:{configurable:!0},indices:{configurable:!0},localPos:{configurable:!0},worldPos:{configurable:!0},viewPos:{configurable:!0},bary:{configurable:!0},worldNormal:{configurable:!0},uv:{configurable:!0}};Tt.canvasPos.get=function(){return this._gotCanvasPos?this._canvasPos:null},Tt.canvasPos.set=function(t){t?(this._canvasPos[0]=t[0],this._canvasPos[1]=t[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1},Tt.origin.get=function(){return this._gotOrigin?this._origin:null},Tt.origin.set=function(t){t?(this._origin[0]=t[0],this._origin[1]=t[1],this._origin[2]=t[2],this._gotOrigin=!0):this._gotOrigin=!1},Tt.direction.get=function(){return this._gotDirection?this._direction:null},Tt.direction.set=function(t){t?(this._direction[0]=t[0],this._direction[1]=t[1],this._direction[2]=t[2],this._gotDirection=!0):this._gotDirection=!1},Tt.indices.get=function(){return this.entity&&this._gotIndices?this._indices:null},Tt.indices.set=function(t){t?(this._indices[0]=t[0],this._indices[1]=t[1],this._indices[2]=t[2],this._gotIndices=!0):this._gotIndices=!1},Tt.localPos.get=function(){return this.entity&&this._gotLocalPos?this._localPos:null},Tt.localPos.set=function(t){t?(this._localPos[0]=t[0],this._localPos[1]=t[1],this._localPos[2]=t[2],this._gotLocalPos=!0):this._gotLocalPos=!1},Tt.worldPos.get=function(){return this.entity&&this._gotWorldPos?this._worldPos:null},Tt.worldPos.set=function(t){t?(this._worldPos[0]=t[0],this._worldPos[1]=t[1],this._worldPos[2]=t[2],this._gotWorldPos=!0):this._gotWorldPos=!1},Tt.viewPos.get=function(){return this.entity&&this._gotViewPos?this._viewPos:null},Tt.viewPos.set=function(t){t?(this._viewPos[0]=t[0],this._viewPos[1]=t[1],this._viewPos[2]=t[2],this._gotViewPos=!0):this._gotViewPos=!1},Tt.bary.get=function(){return this.entity&&this._gotBary?this._bary:null},Tt.bary.set=function(t){t?(this._bary[0]=t[0],this._bary[1]=t[1],this._bary[2]=t[2],this._gotBary=!0):this._gotBary=!1},Tt.worldNormal.get=function(){return this.entity&&this._gotWorldNormal?this._worldNormal:null},Tt.worldNormal.set=function(t){t?(this._worldNormal[0]=t[0],this._worldNormal[1]=t[1],this._worldNormal[2]=t[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1},Tt.uv.get=function(){return this.entity&&this._gotUV?this._uv:null},Tt.uv.set=function(t){t?(this._uv[0]=t[0],this._uv[1]=t[1],this._gotUV=!0):this._gotUV=!1},Rt.prototype.reset=function(){this.entity=null,this.primIndex=-1,this.primitive=null,this.pickSurfacePrecision=!1,this._gotCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1},Object.defineProperties(Rt.prototype,Tt);var Ft=function(t,e,i){if(this.allocated=!1,this.compiled=!1,this.handle=t.createShader(e),this.handle){if(this.allocated=!0,t.shaderSource(this.handle,i),t.compileShader(this.handle),this.compiled=t.getShaderParameter(this.handle,t.COMPILE_STATUS),!this.compiled&&!t.isContextLost()){for(var r=i.split("\n"),s=[],o=0;o<r.length;o++)s.push(o+1+": "+r[o]+"\n");this.errors=[],this.errors.push(""),this.errors.push(t.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(s.join(""))}}else this.errors=["Failed to allocate"]};Ft.prototype.destroy=function(){};var Nt=function(t,e){this.bindTexture=function(i,r){return!!i.bind(r)&&(t.uniform1i(e,r),!0)}},It=function(t,e){this._gl=t,this.location=e};It.prototype.bindArrayBuffer=function(t){t&&(t.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,t.itemSize,t.itemType,t.normalized,t.stride,t.offset))};var kt=new t({});function Ot(t){for(var e,i,r=[],s=0,o=t.length;s<o;s++)(i=(e=t[s]).indexOf("/"))>0&&"/"===e.charAt(i+1)&&(e=e.substring(0,i)),r.push(e);return r.join("\n")}function Vt(t){console.error(t.join("\n"))}var zt=function(t,e){this.id=kt.addItem({}),this.source=e,this.init(t)};zt.prototype.init=function(t){if(this.gl=t,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new Ft(t,t.VERTEX_SHADER,Ot(this.source.vertex)),this._fragmentShader=new Ft(t,t.FRAGMENT_SHADER,Ot(this.source.fragment)),!this._vertexShader.allocated)return this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors),void Vt(this.errors);if(!this._fragmentShader.allocated)return this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors),void Vt(this.errors);if(this.allocated=!0,!this._vertexShader.compiled)return this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors),void Vt(this.errors);if(!this._fragmentShader.compiled)return this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors),void Vt(this.errors);var e,i,r,s,o;if(this.compiled=!0,this.handle=t.createProgram(),this.handle){if(t.attachShader(this.handle,this._vertexShader.handle),t.attachShader(this.handle,this._fragmentShader.handle),t.linkProgram(this.handle),this.linked=t.getProgramParameter(this.handle,t.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(t.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(this.source.vertex),this.errors.push("\nFragment shader:\n"),this.errors=this.errors.concat(this.source.fragment),void Vt(this.errors);var a=t.getProgramParameter(this.handle,t.ACTIVE_UNIFORMS);for(i=0;i<a;++i)(r=t.getActiveUniform(this.handle,i))&&("\0"===(s=r.name)[s.length-1]&&(s=s.substr(0,s.length-1)),o=t.getUniformLocation(this.handle,s),r.type===t.SAMPLER_2D||r.type===t.SAMPLER_CUBE||35682===r.type?this.samplers[s]=new Nt(t,o):this.uniforms[s]=o);var n=t.getProgramParameter(this.handle,t.ACTIVE_ATTRIBUTES);for(i=0;i<n;i++)(e=t.getActiveAttrib(this.handle,i))&&(o=t.getAttribLocation(this.handle,e.name),this.attributes[e.name]=new It(t,o));this.allocated=!0}else this.errors=["Failed to allocate program"]},zt.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},zt.prototype.getLocation=function(t){if(this.allocated)return this.uniforms[t]},zt.prototype.getAttribute=function(t){if(this.allocated)return this.attributes[t]},zt.prototype.bindTexture=function(t,e,i){if(!this.allocated)return!1;var r=this.samplers[t];return!!r&&r.bindTexture(e,i)},zt.prototype.destroy=function(){this.allocated&&(kt.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)};var Ut=function(t,e,i,r,s,o,a,n,l){switch(this._gl=t,this.type=e,this.allocated=!1,i.constructor){case Uint8Array:this.itemType=t.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=t.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=t.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=t.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=t.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=t.INT,this.itemByteSize=4;break;default:this.itemType=t.FLOAT,this.itemByteSize=4}this.usage=o,this.length=0,this.dataLength=r,this.numItems=0,this.itemSize=s,this.normalized=!!a,this.stride=n||0,this.offset=l||0,this._allocate(i)};Ut.prototype._allocate=function(t){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,t.length>this.dataLength?t.slice(0,this.dataLength):t,this.usage),this._gl.bindBuffer(this.type,null),this.length=t.length,this.numItems=this.length/this.itemSize,this.allocated=!0)},Ut.prototype.setData=function(t,e){this.allocated&&(t.length+(e||0)>this.length?(this.destroy(),this._allocate(t)):(this._gl.bindBuffer(this.type,this._handle),e||0===e?this._gl.bufferSubData(this.type,e*this.itemByteSize,t):this._gl.bufferData(this.type,t,this.usage),this._gl.bindBuffer(this.type,null)))},Ut.prototype.bind=function(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)},Ut.prototype.unbind=function(){this.allocated&&this._gl.bindBuffer(this.type,null)},Ut.prototype.destroy=function(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)};var jt=function(t,e){this.scene=t,this.aabb=E.AABB3(),this.rtcCenter=E.vec3(e),this.rtcCenterHash=this.rtcCenter.join(),this.numMarkers=0,this.markers={},this.markerList=[],this.markerIndices={},this.positions=[],this.indices=[],this.positionsBuf=null,this.lenPositionsBuf=0,this.indicesBuf=null,this.sectionPlanesActive=[],this.culledBySectionPlanes=!1,this.occlusionTestList=[],this.lenOcclusionTestList=0,this.pixels=[],this.aabbDirty=!1,this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!1};jt.prototype.addMarker=function(t){this.markers[t.id]=t,this.markerListDirty=!0,this.numMarkers++},jt.prototype.markerWorldPosUpdated=function(t){if(this.markers[t.id]){var e=this.markerIndices[t.id];this.positions[3*e+0]=t.worldPos[0],this.positions[3*e+1]=t.worldPos[1],this.positions[3*e+2]=t.worldPos[2],this.positionsDirty=!0}},jt.prototype.removeMarker=function(t){delete this.markers[t.id],this.markerListDirty=!0,this.numMarkers--},jt.prototype.update=function(){this.markerListDirty&&(this._buildMarkerList(),this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!0),this.positionsDirty&&(this._buildPositions(),this.positionsDirty=!1,this.aabbDirty=!0,this.vbosDirty=!0),this.aabbDirty&&(this._buildAABB(),this.aabbDirty=!1),this.vbosDirty&&(this._buildVBOs(),this.vbosDirty=!1),this.occlusionTestListDirty&&this._buildOcclusionTestList(),this._updateActiveSectionPlanes()},jt.prototype._buildMarkerList=function(){for(var t in this.numMarkers=0,this.markers)this.markers.hasOwnProperty(t)&&(this.markerList[this.numMarkers]=this.markers[t],this.markerIndices[t]=this.numMarkers,this.numMarkers++);this.markerList.length=this.numMarkers},jt.prototype._buildPositions=function(){for(var t=0,e=0;e<this.numMarkers;e++)if(this.markerList[e]){var i=this.markerList[e].worldPos;this.positions[t++]=i[0],this.positions[t++]=i[1],this.positions[t++]=i[2],this.indices[e]=e}this.positions.length=3*this.numMarkers,this.indices.length=this.numMarkers},jt.prototype._buildAABB=function(){var t=this.aabb;E.collapseAABB3(t),E.expandAABB3Points3(t,this.positions);var e=this.rtcCenter;t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[0],t[4]+=e[1],t[5]+=e[2]},jt.prototype._buildVBOs=function(){if(this.positionsBuf){if(this.lenPositionsBuf===this.positions.length)return void this.positionsBuf.setData(this.positions);this.positionsBuf.destroy(),this.positionsBuf=null,this.indicesBuf.destroy(),this.indicesBuf=null}var t=this.scene.canvas.gl,e=3*this.numMarkers,i=this.numMarkers;this.positionsBuf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this.positions),e,3,t.STATIC_DRAW),this.indicesBuf=new Ut(t,t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),i,1,t.STATIC_DRAW),this.lenPositionsBuf=this.positions.length},jt.prototype._buildOcclusionTestList=function(){var t=this.scene.canvas,e=this.scene.camera.perspective.near,i=t.boundary,r=i[2],s=i[3],o=0;this.lenOcclusionTestList=0;for(var a=0;a<this.numMarkers;a++){var n=this.markerList[a];if(n.viewPos[2]>-e)n._setVisible(!1);else{var l=n.canvasPos,h=l[0],u=l[1];h+10<0||u+10<0||h-10>r||u-10>s?n._setVisible(!1):!n.entity||n.entity.visible?n.occludable?(this.occlusionTestList[this.lenOcclusionTestList++]=n,this.pixels[o++]=h,this.pixels[o++]=u):n._setVisible(!0):n._setVisible(!1)}}},jt.prototype._updateActiveSectionPlanes=function(){var t=this.scene._sectionPlanesState.sectionPlanes,e=t.length;if(e>0)for(var i=0;i<e;i++){var r=t[i];if(r.active){var s=E.planeAABB3Intersect(r.dir,r.dist,this.aabb);if(-1===s)return void(this.culledBySectionPlanes=!0);var o=0===s;this.sectionPlanesActive[i]=o}else this.sectionPlanesActive[i]=!1}this.culledBySectionPlanes=!1},jt.prototype.destroy=function(){this.markers={},this.markerList.length=0,this.positionsBuf&&this.positionsBuf.destroy(),this.indicesBuf&&this.indicesBuf.destroy()};var Gt=E.vec3([1,0,0]),Xt=E.vec3(),Wt=function(t){var e=this;this._scene=t,this._occlusionLayers={},this._occlusionLayersList=[],this._occlusionLayersListDirty=!1,this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markersToOcclusionLayersMap={},this._onCameraViewMatrix=t.camera.on("viewMatrix",(function(){e._occlusionTestListDirty=!0})),this._onCameraProjMatrix=t.camera.on("projMatrix",(function(){e._occlusionTestListDirty=!0})),this._onCanvasBoundary=t.canvas.on("boundary",(function(){e._occlusionTestListDirty=!0}))},Ht={needOcclusionTest:{configurable:!0}};Wt.prototype.addMarker=function(t){var e=t.rtcCenter.join(),i=this._occlusionLayers[e];i||(i=new jt(this._scene,t.rtcCenter),this._occlusionLayers[i.rtcCenterHash]=i,this._occlusionLayersListDirty=!0),i.addMarker(t),this._markersToOcclusionLayersMap[t.id]=i,this._occlusionTestListDirty=!0},Wt.prototype.markerWorldPosUpdated=function(t){var e=this._markersToOcclusionLayersMap[t.id];if(e){var i=t.rtcCenter.join();if(i!==e.rtcCenterHash){1===e.numMarkers?(e.destroy(),delete this._occlusionLayers[e.rtcCenterHash],this._occlusionLayersListDirty=!0):e.removeMarker(t);var r=this._occlusionLayers[i];r||(r=new jt(this._scene,t.rtcCenter),this._occlusionLayers[i]=e,this._occlusionLayersListDirty=!0),r.addMarker(t),this._markersToOcclusionLayersMap[t.id]=r}else e.markerWorldPosUpdated(t)}else t.error("Marker has not been added to OcclusionTester")},Wt.prototype.removeMarker=function(t){var e=t.rtcCenter.join(),i=this._occlusionLayers[e];i&&(1===i.numMarkers?(i.destroy(),delete this._occlusionLayers[i.rtcCenterHash],this._occlusionLayersListDirty=!0):i.removeMarker(t),delete this._markersToOcclusionLayersMap[t.id])},Ht.needOcclusionTest.get=function(){return this._occlusionTestListDirty},Wt.prototype.bindRenderBuf=function(){var t=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");if(t!==this._shaderSourceHash&&(this._shaderSourceHash=t,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._occlusionLayersListDirty&&(this._buildOcclusionLayersList(),this._occlusionLayersListDirty=!1),this._occlusionTestListDirty){for(var e=0,i=this._occlusionLayersList.length;e<i;e++){this._occlusionLayersList[e].occlusionTestListDirty=!0}this._occlusionTestListDirty=!1}this._readPixelBuf=this._readPixelBuf||(this._readPixelBuf=new Bt(this._scene.canvas.canvas,this._scene.canvas.gl)),this._readPixelBuf.bind(),this._readPixelBuf.clear()},Wt.prototype._buildOcclusionLayersList=function(){var t=0;for(var e in this._occlusionLayers)this._occlusionLayers.hasOwnProperty(e)&&(this._occlusionLayersList[t++]=this._occlusionLayers[e]);this._occlusionLayersList.length=t},Wt.prototype._buildShaderSource=function(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}},Wt.prototype._buildVertexShaderSource=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// OcclusionTester vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("attribute vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&i.push("varying vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("vec4 worldPosition = vec4(position, 1.0); "),i.push("   vec4 viewPosition = viewMatrix * worldPosition;"),e&&i.push("   vWorldPosition = worldPosition;"),i.push("   vec4 clipPos = projMatrix * viewPosition;"),i.push("   gl_Position = clipPos;"),i.push("   gl_PointSize = 20.0;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("}"),i},Wt.prototype._buildFragmentShaderSource=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// OcclusionTester fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("void main(void) {"),i){r.push("  float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0); "),r.push("}"),r},Wt.prototype._buildProgram=function(){this._program&&this._program.destroy();var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Wt.prototype.drawMarkers=function(){var t=this._scene,e=t.canvas.gl,i=this._program,r=t._sectionPlanesState,s=t.camera,o=t.camera.project;if(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&t.logarithmicDepthBufferEnabled&&e.getExtension("EXT_frag_depth"),i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,s._project._state.matrix),t.logarithmicDepthBufferEnabled){var a=2/(Math.log(o.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,a)}for(var n=0,l=this._occlusionLayersList.length;n<l;n++){var h=this._occlusionLayersList[n];if(h.update(),!h.culledBySectionPlanes){var u=h.rtcCenter;e.uniformMatrix4fv(this._uViewMatrix,!1,rt(s.viewMatrix,u));var c=r.sectionPlanes.length;if(c>0)for(var p=r.sectionPlanes,d=0;d<c;d++){var f=this._uSectionPlanes[d];if(f){var _=h.sectionPlanesActive[d];if(e.uniform1i(f.active,_?1:0),_){var g=p[d];e.uniform3fv(f.pos,at(g.dist,g.dir,u,Xt)),e.uniform3fv(f.dir,g.dir)}}}this._aPosition.bindArrayBuffer(h.positionsBuf);var m=h.indicesBuf;m.bind(),e.drawElements(e.POINTS,m.numItems,m.itemType,0)}}},Wt.prototype.doOcclusionTest=function(){for(var t=255*Gt[0],e=255*Gt[1],i=255*Gt[2],r=0,s=this._occlusionLayersList.length;r<s;r++)for(var o=this._occlusionLayersList[r],a=0;a<o.lenOcclusionTestList;a++){var n=o.occlusionTestList[a],l=2*a,h=this._readPixelBuf.read(o.pixels[l],o.pixels[l+1]),u=h[0]===t&&h[1]===e&&h[2]===i;n._setVisible(u)}},Wt.prototype.unbindRenderBuf=function(){this._readPixelBuf.unbind()},Wt.prototype.destroy=function(){if(!this.destroyed){for(var t=0,e=this._occlusionLayersList.length;t<e;t++){this._occlusionLayersList[t].destroy()}this._program&&this._program.destroy(),this._scene.camera.off(this._onCameraViewMatrix),this._scene.camera.off(this._onCameraProjMatrix),this._scene.canvas.off(this._onCanvasBoundary),this.destroyed=!0}},Object.defineProperties(Wt.prototype,Ht);var Yt=E.vec2(),Kt=function(t){this._scene=t,this._numSamples=null,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uRandomSeed=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null};Kt.prototype.render=function(t){var e=this;if(this._build(),!this._programError){this._getInverseProjectMat||(this._getInverseProjectMat=function(){var t=!0;e._scene.camera.on("projMatrix",(function(){t=!0}));var i=E.mat4();return function(){return t&&E.inverseMat4(s.camera.projMatrix,i),i}}());var i=this._scene.canvas.gl,r=this._program,s=this._scene,o=s.sao,a=i.drawingBufferWidth,n=i.drawingBufferHeight,l=s.camera.project._state,h=l.near,u=l.far,c=l.matrix,p=this._getInverseProjectMat(),d=Math.random(),f="perspective"===s.camera.projection;Yt[0]=a,Yt[1]=n,i.getExtension("OES_standard_derivatives"),i.viewport(0,0,a,n),i.clearColor(0,0,0,1),i.disable(i.DEPTH_TEST),i.disable(i.BLEND),i.frontFace(i.CCW),i.clear(i.COLOR_BUFFER_BIT),r.bind(),i.uniform1f(this._uCameraNear,h),i.uniform1f(this._uCameraFar,u),i.uniformMatrix4fv(this._uCameraProjectionMatrix,!1,c),i.uniformMatrix4fv(this._uCameraInverseProjectionMatrix,!1,p),i.uniform1i(this._uPerspective,f),i.uniform1f(this._uScale,o.scale*(u/5)),i.uniform1f(this._uIntensity,o.intensity),i.uniform1f(this._uBias,o.bias),i.uniform1f(this._uKernelRadius,o.kernelRadius),i.uniform1f(this._uMinResolution,o.minResolution),i.uniform2fv(this._uViewport,Yt),i.uniform1f(this._uRandomSeed,d);var _=wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?t.getDepthTexture():t.getTexture();r.bindTexture(this._uDepthTexture,_,0),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),i.drawElements(i.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}},Kt.prototype._build=function(){var t=!1,e=this._scene.sao;if(e.numSamples!==this._numSamples&&(this._numSamples=Math.floor(e.numSamples),t=!0),t){var i=this._scene.canvas.gl;if(this._program&&(this._program.destroy(),this._program=null),this._program=new zt(i,{vertex:["precision highp float;\n                    precision highp int;\n                    \n                    attribute vec3 aPosition;\n                    attribute vec2 aUV;            \n                    \n                    varying vec2 vUV;\n                    \n                    void main () {\n                        gl_Position = vec4(aPosition, 1.0);\n                        vUV = aUV;\n                    }"],fragment:["#extension GL_OES_standard_derivatives : require              \n                precision highp float;\n                precision highp int;           \n                \n                #define NORMAL_TEXTURE 0\n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n                #define NUM_SAMPLES "+this._numSamples+"\n                #define NUM_RINGS 4              \n            \n                varying vec2        vUV;\n            \n                uniform sampler2D   uDepthTexture;\n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;\n                uniform mat4        uProjectMatrix;\n                uniform mat4        uInverseProjectMatrix;\n                \n                uniform bool        uPerspective;\n\n                uniform float       uScale;\n                uniform float       uIntensity;\n                uniform float       uBias;\n                uniform float       uKernelRadius;\n                uniform float       uMinResolution;\n                uniform vec2        uViewport;\n                uniform float       uRandomSeed;\n\n                float pow2( const in float x ) { return x*x; }\n                \n                highp float rand( const in vec2 uv ) {\n                    const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n                    highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n                    return fract(sin(sn) * c);\n                }\n\n                vec3 packNormalToRGB( const in vec3 normal ) {\n                    return normalize( normal ) * 0.5 + 0.5;\n                }\n\n                vec3 unpackRGBToNormal( const in vec3 rgb ) {\n                    return 2.0 * rgb.xyz - 1.0;\n                }\n\n                const float packUpscale = 256. / 255.;\n                const float unpackDownScale = 255. / 256.; \n\n                const vec3 packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4 unPackFactors = unpackDownScale / vec4( packFactors, 1. );   \n\n                const float shiftRights = 1. / 256.;\n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float unpackRGBAToFloat( const in vec4 v ) {                   \n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unPackFactors );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n                    return ( near * far ) / ( ( far - near ) * invClipZ - far );\n                }\n\n                float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n                    return linearClipZ * ( near - far ) - near;\n                }\n                \n                float getDepth( const in vec2 screenPosition ) {"+(wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?"return texture2D(uDepthTexture, screenPosition).r;":"return unpackRGBAToFloat(texture2D( uDepthTexture, screenPosition));")+"}\n\n                float getViewZ( const in float depth ) {\n                     if (uPerspective) {\n                         return perspectiveDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     } else {\n                        return orthographicDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     }\n                }\n\n                vec3 getViewPos( const in vec2 screenPos, const in float depth, const in float viewZ ) {\n                \tfloat clipW = uProjectMatrix[2][3] * viewZ + uProjectMatrix[3][3];\n                \tvec4 clipPosition = vec4( ( vec3( screenPos, depth ) - 0.5 ) * 2.0, 1.0 );\n                \tclipPosition *= clipW; \n                \treturn ( uInverseProjectMatrix * clipPosition ).xyz;\n                }\n\n                vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPos ) {               \n                    return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );\n                }\n\n                float scaleDividedByCameraFar;\n                float minResolutionMultipliedByCameraFar;\n\n                float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {\n                \tvec3 viewDelta = sampleViewPosition - centerViewPosition;\n                \tfloat viewDistance = length( viewDelta );\n                \tfloat scaledScreenDistance = scaleDividedByCameraFar * viewDistance;\n                \treturn max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - uBias) / (1.0 + pow2( scaledScreenDistance ) );\n                }\n\n                const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );\n                const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );\n\n                float getAmbientOcclusion( const in vec3 centerViewPosition ) {\n            \n                \tscaleDividedByCameraFar = uScale / uCameraFar;\n                \tminResolutionMultipliedByCameraFar = uMinResolution * uCameraFar;\n                \tvec3 centerViewNormal = getViewNormal( centerViewPosition, vUV );\n\n                \tfloat angle = rand( vUV + uRandomSeed ) * PI2;\n                \tvec2 radius = vec2( uKernelRadius * INV_NUM_SAMPLES ) / uViewport;\n                \tvec2 radiusStep = radius;\n\n                \tfloat occlusionSum = 0.0;\n                \tfloat weightSum = 0.0;\n\n                \tfor( int i = 0; i < NUM_SAMPLES; i ++ ) {\n                \t\tvec2 sampleUv = vUV + vec2( cos( angle ), sin( angle ) ) * radius;\n                \t\tradius += radiusStep;\n                \t\tangle += ANGLE_STEP;\n\n                \t\tfloat sampleDepth = getDepth( sampleUv );\n                \t\tif( sampleDepth >= ( 1.0 - EPSILON ) ) {\n                \t\t\tcontinue;\n                \t\t}\n\n                \t\tfloat sampleViewZ = getViewZ( sampleDepth );\n                \t\tvec3 sampleViewPosition = getViewPos( sampleUv, sampleDepth, sampleViewZ );\n                \t\tocclusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );\n                \t\tweightSum += 1.0;\n                \t}\n\n                \tif( weightSum == 0.0 ) discard;\n\n                \treturn occlusionSum * ( uIntensity / weightSum );\n                }\n\n                void main() {\n                \n                \tfloat centerDepth = getDepth( vUV );\n                \t\n                \tif( centerDepth >= ( 1.0 - EPSILON ) ) {\n                \t\tdiscard;\n                \t}\n\n                \tfloat centerViewZ = getViewZ( centerDepth );\n                \tvec3 viewPosition = getViewPos( vUV, centerDepth, centerViewZ );\n\n                \tfloat ambientOcclusion = getAmbientOcclusion( viewPosition );\n                \n                \tgl_FragColor = packFloatToRGBA(  1.0- ambientOcclusion );\n                }"]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);var r=new Float32Array([1,1,0,1,0,0,1,0]),s=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),o=new Uint8Array([0,1,2,0,2,3]);this._positionsBuf=new Ut(i,i.ARRAY_BUFFER,s,s.length,3,i.STATIC_DRAW),this._uvBuf=new Ut(i,i.ARRAY_BUFFER,r,r.length,2,i.STATIC_DRAW),this._indicesBuf=new Ut(i,i.ELEMENT_ARRAY_BUFFER,o,o.length,1,i.STATIC_DRAW),this._program.bind(),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uCameraProjectionMatrix=this._program.getLocation("uProjectMatrix"),this._uCameraInverseProjectionMatrix=this._program.getLocation("uInverseProjectMatrix"),this._uPerspective=this._program.getLocation("uPerspective"),this._uScale=this._program.getLocation("uScale"),this._uIntensity=this._program.getLocation("uIntensity"),this._uBias=this._program.getLocation("uBias"),this._uKernelRadius=this._program.getLocation("uKernelRadius"),this._uMinResolution=this._program.getLocation("uMinResolution"),this._uViewport=this._program.getLocation("uViewport"),this._uRandomSeed=this._program.getLocation("uRandomSeed"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV"),this._dirty=!1}},Kt.prototype.destroy=function(){this._program&&(this._program.destroy(),this._program=null)};var qt=new Float32Array(ee(17,[0,1])),Zt=new Float32Array(ee(17,[1,0])),Qt=new Float32Array(function(t,e){for(var i=[],r=0;r<=t;r++)i.push(te(r,e));return i}(17,4)),Jt=new Float32Array(2),$t=function(t){this._scene=t,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uOcclusionTexture="uOcclusionTexture",this._uViewport=null,this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()};function te(t,e){return Math.exp(-t*t/(e*e*2))/(Math.sqrt(2*Math.PI)*e)}function ee(t,e){for(var i=[],r=0;r<=t;r++)i.push(e[0]*r),i.push(e[1]*r);return i}$t.prototype.init=function(){var t=this._scene.canvas.gl;if(this._program=new zt(t,{vertex:["precision highp float;\n                precision highp int;\n                    \n                attribute vec3 aPosition;\n                attribute vec2 aUV;\n                uniform vec2 uViewport;\n                varying vec2 vUV;\n                varying vec2 vInvSize;\n                void main () {\n                    vUV = aUV;\n                    vInvSize = 1.0 / uViewport;\n                    gl_Position = vec4(aPosition, 1.0);\n                }"],fragment:["precision highp float;\n                precision highp int;\n                    \n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n\n                #define KERNEL_RADIUS 16\n\n                varying vec2        vUV;\n                varying vec2        vInvSize;\n            \n                uniform sampler2D   uDepthTexture;\n                uniform sampler2D   uOcclusionTexture;              \n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;               \n                uniform float       uDepthCutoff;\n\n                uniform vec2        uSampleOffsets[ KERNEL_RADIUS + 1 ];\n                uniform float       uSampleWeights[ KERNEL_RADIUS + 1 ];\n\n                const float         unpackDownscale = 255. / 256.; \n\n                const vec3          packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4          unpackFactors = unpackDownscale / vec4( packFactors, 1. );   \n\n                const float packUpscale = 256. / 255.;\n       \n                const float shiftRights = 1. / 256.;\n                \n                float unpackRGBAToFloat( const in vec4 v ) {\n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unpackFactors );\n                }               \n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float viewZToOrthographicDepth( const in float viewZ) {\n                    return ( viewZ + uCameraNear ) / ( uCameraNear - uCameraFar );\n                }\n              \n                float orthographicDepthToViewZ( const in float linearClipZ) {\n                    return linearClipZ * ( uCameraNear - uCameraFar ) - uCameraNear;\n                }\n\n                float viewZToPerspectiveDepth( const in float viewZ) {\n                    return (( uCameraNear + viewZ ) * uCameraFar ) / (( uCameraFar - uCameraNear ) * viewZ );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ) {\n                    return ( uCameraNear * uCameraFar ) / ( ( uCameraFar - uCameraNear ) * invClipZ - uCameraFar );\n                }\n\n                float getDepth( const in vec2 screenPosition ) {"+(wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?"return texture2D(uDepthTexture, screenPosition).r;":"return unpackRGBAToFloat(texture2D( uDepthTexture, screenPosition));")+"}\n\n                float getViewZ( const in float depth ) {\n                     return perspectiveDepthToViewZ( depth );\n                }\n\n                void main() {\n                \n                    float depth = getDepth( vUV );\n                    if( depth >= ( 1.0 - EPSILON ) ) {\n                        discard;\n                    }\n\n                    float centerViewZ = -getViewZ( depth );\n                    bool rBreak = false;\n                    bool lBreak = false;\n\n                    float weightSum = uSampleWeights[0];\n                    float occlusionSum = unpackRGBAToFloat(texture2D( uOcclusionTexture, vUV )) * weightSum;\n\n                    for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {\n\n                        float sampleWeight = uSampleWeights[i];\n                        vec2 sampleUVOffset = uSampleOffsets[i] * vInvSize;\n\n                        vec2 sampleUV = vUV + sampleUVOffset;\n                        float viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            rBreak = true;\n                        }\n\n                        if( ! rBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture2D( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n\n                        sampleUV = vUV - sampleUVOffset;\n                        viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            lBreak = true;\n                        }\n\n                        if( ! lBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture2D( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n                    }\n\n                    gl_FragColor = packFloatToRGBA(occlusionSum / weightSum);\n                }"]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);var e=new Float32Array([1,1,0,1,0,0,1,0]),i=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),r=new Uint8Array([0,1,2,0,2,3]);this._positionsBuf=new Ut(t,t.ARRAY_BUFFER,i,i.length,3,t.STATIC_DRAW),this._uvBuf=new Ut(t,t.ARRAY_BUFFER,e,e.length,2,t.STATIC_DRAW),this._indicesBuf=new Ut(t,t.ELEMENT_ARRAY_BUFFER,r,r.length,1,t.STATIC_DRAW),this._program.bind(),this._uViewport=this._program.getLocation("uViewport"),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uDepthCutoff=this._program.getLocation("uDepthCutoff"),this._uSampleOffsets=t.getUniformLocation(this._program.handle,"uSampleOffsets"),this._uSampleWeights=t.getUniformLocation(this._program.handle,"uSampleWeights"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV")},$t.prototype.render=function(t,e,i){var r=this;if(!this._programError){this._getInverseProjectMat||(this._getInverseProjectMat=function(){var t=!0;r._scene.camera.on("projMatrix",(function(){t=!0}));var e=E.mat4();return function(){return t&&E.inverseMat4(a.camera.projMatrix,e),e}}());var s=this._scene.canvas.gl,o=this._program,a=this._scene,n=s.drawingBufferWidth,l=s.drawingBufferHeight,h=a.camera.project._state,u=h.near,c=h.far;s.viewport(0,0,n,l),s.clearColor(0,0,0,1),s.enable(s.DEPTH_TEST),s.disable(s.BLEND),s.frontFace(s.CCW),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),o.bind(),Jt[0]=n,Jt[1]=l,s.uniform2fv(this._uViewport,Jt),s.uniform1f(this._uCameraNear,u),s.uniform1f(this._uCameraFar,c),s.uniform1f(this._uDepthCutoff,.01),0===i?s.uniform2fv(this._uSampleOffsets,Zt):s.uniform2fv(this._uSampleOffsets,qt),s.uniform1fv(this._uSampleWeights,Qt);var p=wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?t.getDepthTexture():t.getTexture(),d=e.getTexture();o.bindTexture(this._uDepthTexture,p,0),o.bindTexture(this._uOcclusionTexture,d,1),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),s.drawElements(s.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}},$t.prototype.destroy=function(){this._program.destroy()};var ie=function(e,i){i=i||{};var r=new Dt(e),s=e.canvas.canvas,o=e.canvas.gl,a=!!i.transparent,n=i.alphaDepthMask,l=new t({}),h={},u={},c=!0,p=!0,d=!0,f=new Bt(s,o,{depthTexture:wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture}),_=new Bt(s,o),g=new Bt(s,o),m=new Bt(s,o),v=new Bt(s,o),b=!1,y=new Kt(e),P=new $t(e);function M(){c&&(!function(){for(var t in h)if(h.hasOwnProperty(t)){var e=h[t],i=e.drawableMap,r=e.drawableListPreCull,s=0;for(var o in i)i.hasOwnProperty(o)&&(r[s++]=i[o]);r.length=s}}(),c=!1,p=!0),p&&(!function(){for(var t in h)if(h.hasOwnProperty(t)){var e=h[t];e.isStateSortable&&e.drawableListPreCull.sort(e.stateSortCompare)}}(),p=!1,d=!0),d&&function(){for(var t in h)if(h.hasOwnProperty(t)){for(var e=h[t],i=e.drawableListPreCull,r=e.drawableList,s=0,o=0,a=i.length;o<a;o++){var n=i[o];n.rebuildRenderFlags(),n.renderFlags.culled||(r[s++]=n)}r.length=s}}()}function x(t){if(t.castsShadow){var e=t.getShadowRenderBuf();if(e){for(var i in e.bind(),r.reset(),r.backfaces=!0,r.frontface=!0,r.shadowViewMatrix=t.getShadowViewMatrix(),r.shadowProjMatrix=t.getShadowProjMatrix(),o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,1),o.enable(o.DEPTH_TEST),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),h)if(h.hasOwnProperty(i))for(var s=h[i].drawableList,a=0,n=s.length;a<n;a++){var l=s[a];!1!==l.visible&&l.castsShadow&&l.drawShadow&&(l.renderFlags.colorOpaque&&l.drawShadow(r))}e.unbind()}}}this._occlusionTester=null,this.needStateSort=function(){p=!0},this.shadowsDirty=function(){},this.imageDirty=function(){d=!0},this.webglContextLost=function(){},this.webglContextRestored=function(t){m.webglContextRestored(t),v.webglContextRestored(t),f.webglContextRestored(t),_.webglContextRestored(t),g.webglContextRestored(t),y.init(),P.init(),d=!0},this.addDrawable=function(t,e){var i=e.type;if(i){var r=h[i];r||(r={type:e.type,count:0,isStateSortable:e.isStateSortable,stateSortCompare:e.stateSortCompare,drawableMap:{},drawableListPreCull:[],drawableList:[]},h[i]=r),r.count++,r.drawableMap[t]=e,u[t]=e,c=!0}else console.error("Renderer#addDrawable() : drawable with ID "+t+" has no 'type' - ignoring")},this.removeDrawable=function(t){var e=u[t];if(e){var i=e.type,r=h[i];--r.count<=0?delete h[i]:delete r.drawableMap[t],delete u[t],c=!0}else console.error("Renderer#removeDrawable() : drawable not found with ID "+t+" - ignoring")},this.getPickID=function(t){return l.addItem(t)},this.putPickID=function(t){l.removeItem(t)},this.clear=function(t){if(o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),a)o.clearColor(1,1,1,1);else{var i=e.canvas.backgroundColorFromAmbientLight?this.lights.getAmbientColorAndIntensity():e.canvas.backgroundColor;o.clearColor(i[0],i[1],i[2],1)}o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)},this.render=function(t){(t=t||{}).force&&(d=!0),M(),d&&(!function(t){wt.SUPPORTED_EXTENSIONS.OES_element_index_uint&&o.getExtension("OES_element_index_uint");e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.getExtension("EXT_frag_depth");wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&o.getExtension("WEBGL_depth_texture");e.sao.possible&&function(t){var i=e.sao;f.bind(),f.clear(),function(t){r.reset(),r.pass=t.pass,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.frontFace(o.CCW),o.enable(o.CULL_FACE),o.depthMask(!0),!1!==t.clear&&o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(var e in h)if(h.hasOwnProperty(e))for(var i=h[e].drawableList,s=0,a=i.length;s<a;s++){var n=i[s];!0!==n.culled&&!1!==n.visible&&n.drawDepth&&(n.renderFlags.colorOpaque&&n.drawDepth(r))}}(t),f.unbind(),_.bind(),_.clear(),y.render(f),_.unbind(),i.blur&&(g.bind(),g.clear(),P.render(f,_,0),g.unbind(),_.bind(),_.clear(),P.render(f,g,1),_.unbind())}(t);(function(){for(var t=e._lightsState.lights,i=0,r=t.length;i<r;i++){var s=t[i];s.castsShadow&&x(s)}})(),j(t)}(t),S.frame.frameCount++,d=!1)};var w,C,A,D,L,B,R,T,F,N,I,k,O,V,z,U,j=(w=[],C=[],A=[],D=[],L=[],B=[],R=[],T=[],F=[],N=[],I=[],k=[],O=[],V=[],z=[],U=[],function(t){var i=e._lightsState.getAmbientColorAndIntensity();if(r.reset(),r.pass=t.pass,r.withSAO=!1,r.pbrEnabled=!!e.pbrEnabled,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),a)o.clearColor(0,0,0,0);else{var s=e.canvas.backgroundColorFromAmbientLight?i:e.canvas.backgroundColor;o.clearColor(s[0],s[1],s[2],1)}o.enable(o.DEPTH_TEST),o.frontFace(o.CCW),o.enable(o.CULL_FACE),o.depthMask(!0),o.lineWidth(1),r.lineWidth=1;var l,u,c,p=e.sao.possible;r.occlusionTexture=p?_.getTexture():null;var d=Date.now();!1!==t.clear&&o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);var f=0,g=0,m=0,v=0,b=0,y=0,P=0,M=0,x=0,E=0,j=0,G=0,X=0,W=0,H=0,Y=0;for(var K in h)if(h.hasOwnProperty(K)){var q=h[K].drawableList;for(l=0,u=q.length;l<u;l++)if(!0!==(c=q[l]).culled&&!1!==c.visible){var Z=c.renderFlags;Z.colorOpaque&&(p&&c.saoEnabled?w[f++]=c:c.drawColorOpaque(r)),Z.colorTransparent&&(A[m++]=c),Z.xrayedSilhouetteTransparent&&(R[P++]=c),Z.xrayedSilhouetteOpaque&&(L[b++]=c),Z.highlightedSilhouetteTransparent&&(I[j++]=c),Z.highlightedSilhouetteOpaque&&(F[x++]=c),Z.selectedSilhouetteTransparent&&(z[H++]=c),Z.selectedSilhouetteOpaque&&(O[X++]=c),Z.edgesOpaque&&(C[g++]=c),Z.edgesTransparent&&(D[v++]=c),Z.selectedEdgesTransparent&&(U[Y++]=c),Z.selectedEdgesOpaque&&(V[W++]=c),Z.xrayedEdgesTransparent&&(T[M++]=c),Z.xrayedEdgesOpaque&&(B[y++]=c),Z.highlightedEdgesTransparent&&(k[G++]=c),Z.highlightedEdgesOpaque&&(N[E++]=c)}}if(f>0)for(r.withSAO=!0,l=0;l<f;l++)w[l].drawColorOpaque(r);if(g>0)for(l=0;l<g;l++)C[l].drawEdgesColorOpaque(r);if(b>0)for(l=0;l<b;l++)L[l].drawSilhouetteXRayed(r);if(y>0)for(l=0;l<y;l++)B[l].drawEdgesXRayed(r);if(P>0||M>0||m>0||v>0){if(o.enable(o.CULL_FACE),o.enable(o.BLEND),a?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):(o.blendEquation(o.FUNC_ADD),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA)),r.backfaces=!1,n||o.depthMask(!1),M>0)for(l=0;l<M;l++)T[l].drawEdgesXRayed(r);if(P>0)for(l=0;l<P;l++)R[l].drawSilhouetteXRayed(r);if((m>0||v>0)&&o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),v>0)for(l=0;l<v;l++)(c=D[l]).drawEdgesColorTransparent(r);if(m>0)for(l=0;l<m;l++)(c=A[l]).drawColorTransparent(r);o.disable(o.BLEND),n||o.depthMask(!0)}if(x>0||E>0){if(r.lastProgramId=null,o.clear(o.DEPTH_BUFFER_BIT),E>0)for(l=0;l<E;l++)N[l].drawEdgesHighlighted(r);if(x>0)for(l=0;l<x;l++)F[l].drawSilhouetteHighlighted(r)}if(j>0||G>0||x>0){if(r.lastProgramId=null,o.clear(o.DEPTH_BUFFER_BIT),o.enable(o.CULL_FACE),o.enable(o.BLEND),a?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),G>0)for(l=0;l<G;l++)k[l].drawEdgesHighlighted(r);if(j>0)for(l=0;l<j;l++)I[l].drawSilhouetteHighlighted(r);o.disable(o.BLEND)}if(X>0||W>0){if(r.lastProgramId=null,o.clear(o.DEPTH_BUFFER_BIT),W>0)for(l=0;l<W;l++)V[l].drawEdgesSelected(r);if(X>0)for(l=0;l<X;l++)O[l].drawSilhouetteSelected(r)}if(H>0||Y>0){if(r.lastProgramId=null,o.clear(o.DEPTH_BUFFER_BIT),o.enable(o.CULL_FACE),o.enable(o.BLEND),a?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),Y>0)for(l=0;l<Y;l++)U[l].drawEdgesSelected(r);if(H>0)for(l=0;l<H;l++)z[l].drawSilhouetteSelected(r);o.disable(o.BLEND)}var Q=Date.now(),J=S.frame;J.renderTime=(Q-d)/1e3,J.drawElements=r.drawElements,J.useProgram=r.useProgram,J.bindTexture=r.bindTexture,J.bindArray=r.bindArray;for(var $=wt.MAX_TEXTURE_UNITS,tt=0;tt<$;tt++)o.activeTexture(o.TEXTURE0+tt);o.bindTexture(o.TEXTURE_CUBE_MAP,null),o.bindTexture(o.TEXTURE_2D,null);for(var et=wt.MAX_VERTEX_ATTRIBS,it=0;it<et;it++)o.disableVertexAttribArray(it)});this.pick=function(){var t=E.vec3(),i=E.mat4(),a=E.mat4(),n=E.vec3([0,1,0]),u=new Rt,c=E.vec2(),p=E.vec3(),d=E.vec3(),f=E.vec3(),_=E.vec3();return function(g,v){var b;void 0===v&&(v=u),v.reset(),M(),wt.SUPPORTED_EXTENSIONS.OES_element_index_uint&&o.getExtension("OES_element_index_uint"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.getExtension("EXT_frag_depth"),wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&o.getExtension("WEBGL_depth_texture");var y=null,P=null;if(v.pickSurface=g.pickSurface,g.canvasPos)p[0]=g.canvasPos[0],p[1]=g.canvasPos[1],y=e.camera.viewMatrix,P=e.camera.projMatrix,v.canvasPos=g.canvasPos;else{var x=E.frustumMat4(-1,1,-1,1,e.camera.project.near,e.camera.project.far,i);g.matrix?(y=g.matrix,P=x):(d.set(g.origin||[0,0,0]),f.set(g.direction||[0,0,1]),b=E.addVec3(d,f,t),y=E.lookAtMat4v(d,b,n,a),P=x,v.origin=d,v.direction=f),p[0]=.5*s.clientWidth,p[1]=.5*s.clientHeight}m.bind();var w=function(t,e,i,s){r.reset(),r.backfaces=!0,r.frontface=!0,r.pickViewMatrix=e,r.pickProjMatrix=i,r.pickInvisible=!!s.pickInvisible,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);var a=s.includeEntityIds,n=s.excludeEntityIds;for(var u in h)if(h.hasOwnProperty(u))for(var c=h[u].drawableList,p=0,d=c.length;p<d;p++){var f=c[p];!f.drawPickMesh||!0===f.culled||!0!==s.pickInvisible&&!1===f.visible||!1===f.pickable||(a&&!a[f.id]||n&&n[f.id]||f.drawPickMesh(r))}var _=m.read(Math.round(t[0]),Math.round(t[1])),g=_[0]+256*_[1]+256*_[2]*256+256*_[3]*256*256;if(g<0)return;return l.items[g]}(p,y,P,g);if(!w)return m.unbind(),null;var C=w.delegatePickedEntity?w.delegatePickedEntity():w;return C?(g.pickSurface&&(g.pickSurfacePrecision&&e.pickSurfacePrecisionEnabled?(g.canvasPos&&E.canvasPosToWorldRay(e.canvas.canvas,y,P,p,d,f),w.precisionRayPickSurface(d,f,_)&&(v.worldPos=_,!1!==g.pickSurfaceNormal&&X(w,p,y,P,v),v.pickSurfacePrecision=!0)):w.canPickTriangle&&w.canPickTriangle()?(!function(t,e,i,s,a){if(!t.drawPickTriangles)return;r.reset(),r.backfaces=!0,r.frontface=!0,r.pickViewMatrix=i,r.pickProjMatrix=s,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),t.drawPickTriangles(r);var n=m.read(e[0],e[1]),l=n[0]+256*n[1]+256*n[2]*256+256*n[3]*256*256;l*=3,a.primIndex=l}(w,p,y,P,v),w.pickTriangleSurface(y,P,v),v.pickSurfacePrecision=!1):w.canPickWorldPos&&w.canPickWorldPos()&&(c[0]=e.camera.project.near,c[1]=e.camera.project.far,G(w,p,y,P,c,v),!1!==g.pickSurfaceNormal&&X(w,p,y,P,v),v.pickSurfacePrecision=!1)),m.unbind(),v.entity=C,v):(m.unbind(),null)}}();var G=function(){var t=E.vec4(),e=E.vec4(),i=E.vec4(),a=E.vec4(),n=E.vec4(),l=E.mat4(),h=E.mat4(),u=E.mat4();return function(c,p,d,f,_,g){r.reset(),r.backfaces=!0,r.frontface=!0,r.pickViewMatrix=d,r.pickProjMatrix=f,r.pickZNear=_[0],r.pickZFar=_[1],o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),c.drawPickDepths(r);var v,b=function(t){var e=[t[0]/256,t[1]/256,t[2]/256,t[3]/256],i=[1/16777216,1/65536,1/256,1];return E.dotVec4(e,i)}(m.read(Math.round(p[0]),Math.round(p[1]))),y=(p[0]-s.width/2)/(s.width/2),P=-(p[1]-s.height/2)/(s.height/2),M=c.rtcCenter;if(M){var x=rt(d,M,l);v=E.mulMat4(f,x,h)}else v=E.mulMat4(f,d,h);var w=E.inverseMat4(v,u);t[0]=y,t[1]=P,t[2]=-1,t[3]=1;var C=E.transformVec4(w,t);C=E.mulVec4Scalar(C,1/C[3]),e[0]=y,e[1]=P,e[2]=1,e[3]=1;var A=E.transformVec4(w,e);A=E.mulVec4Scalar(A,1/A[3]);var S=E.subVec3(A,C,i),D=E.addVec3(C,E.mulVec4Scalar(S,b,a),n);M&&E.addVec3(D,M),g.worldPos=D}}();function X(t,e,i,s,a){r.reset(),r.backfaces=!0,r.frontface=!0,r.pickViewMatrix=i,r.pickProjMatrix=s,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),t.drawPickNormals(r);var n=m.read(Math.round(e[0]),Math.round(e[1])),l=[n[0]/256-.5,n[1]/256-.5,n[2]/256-.5];E.normalizeVec3(l),a.worldNormal=l}this.addMarker=function(t){this._occlusionTester=this._occlusionTester||new Wt(e),this._occlusionTester.addMarker(t),e.occlusionTestCountdown=0},this.markerWorldPosUpdated=function(t){this._occlusionTester.markerWorldPosUpdated(t)},this.removeMarker=function(t){this._occlusionTester.removeMarker(t)},this.doOcclusionTest=function(){if(this._occlusionTester&&this._occlusionTester.needOcclusionTest){for(var t in M(),this._occlusionTester.bindRenderBuf(),r.reset(),r.backfaces=!0,r.frontface=!0,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),h)if(h.hasOwnProperty(t))for(var e=h[t].drawableList,i=0,s=e.length;i<s;i++){var a=e[i];a.drawOcclusion&&!0!==a.culled&&!1!==a.visible&&!1!==a.pickable&&a.drawOcclusion(r)}this._occlusionTester.drawMarkers(r),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(t,e,i,r){var s,o,a,n;for(v.bind(),v.clear(),this.render({force:!0,opaqueOnly:r}),o=0;o<i;o++)a=2*o,n=4*o,s=v.read(t[a],t[a+1]),e[n]=s[0],e[n+1]=s[1],e[n+2]=s[2],e[n+3]=s[3];v.unbind(),d=!0},this.beginSnapshot=function(){v.bind(),v.clear(),b=!0},this.renderSnapshot=function(){b&&(v.clear(),this.render({force:!0,opaqueOnly:!1}),d=!0)},this.readSnapshot=function(t){return v.readImage(t)},this.endSnapshot=function(){b&&(v.unbind(),b=!1)},this.destroy=function(){h={},u={},m.destroy(),v.destroy(),f.destroy(),_.destroy(),g.destroy(),y.destroy(),P.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}},re=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.element=i.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.keyboardEnabled=!0,this.mouseover=!1,this.mouseCanvasPos=E.vec2(),this._bindEvents()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype._bindEvents=function(){var t=this;if(!this._eventsBound){document.addEventListener("keydown",this._keyDownListener=function(e){t.enabled&&t.keyboardEnabled&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.keyCode===t.KEY_CTRL?t.ctrlDown=!0:e.keyCode===t.KEY_ALT?t.altDown=!0:e.keyCode===t.KEY_SHIFT&&(t.shiftDown=!0),t.keyDown[e.keyCode]=!0,t.fire("keydown",e.keyCode,!0))},!1),document.addEventListener("keyup",this._keyUpListener=function(e){t.enabled&&t.keyboardEnabled&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.keyCode===t.KEY_CTRL?t.ctrlDown=!1:e.keyCode===t.KEY_ALT?t.altDown=!1:e.keyCode===t.KEY_SHIFT&&(t.shiftDown=!1),t.keyDown[e.keyCode]=!1,t.fire("keyup",e.keyCode,!0))}),this.element.addEventListener("mouseenter",this._mouseEnterListener=function(e){t.enabled&&(t.mouseover=!0,t._getMouseCanvasPos(e),t.fire("mouseenter",t.mouseCanvasPos,!0))}),this.element.addEventListener("mouseleave",this._mouseLeaveListener=function(e){t.enabled&&(t.mouseover=!1,t._getMouseCanvasPos(e),t.fire("mouseleave",t.mouseCanvasPos,!0))}),this.element.addEventListener("mousedown",this._mouseDownListener=function(e){if(t.enabled){switch(e.which){case 1:t.mouseDownLeft=!0;break;case 2:t.mouseDownMiddle=!0;break;case 3:t.mouseDownRight=!0}t._getMouseCanvasPos(e),t.element.focus(),t.fire("mousedown",t.mouseCanvasPos,!0),t.mouseover&&e.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=function(e){if(t.enabled){switch(e.which){case 1:t.mouseDownLeft=!1;break;case 2:t.mouseDownMiddle=!1;break;case 3:t.mouseDownRight=!1}t.fire("mouseup",t.mouseCanvasPos,!0)}},!0),document.addEventListener("click",this._clickListener=function(e){if(t.enabled){switch(e.which){case 1:t.mouseDownLeft=!1,t.mouseDownRight=!1;break;case 2:t.mouseDownMiddle=!1;break;case 3:t.mouseDownLeft=!1,t.mouseDownRight=!1}t._getMouseCanvasPos(e),t.fire("click",t.mouseCanvasPos,!0),t.mouseover&&e.preventDefault()}}),document.addEventListener("dblclick",this._dblClickListener=function(e){if(t.enabled){switch(e.which){case 1:t.mouseDownLeft=!1,t.mouseDownRight=!1;break;case 2:t.mouseDownMiddle=!1;break;case 3:t.mouseDownLeft=!1,t.mouseDownRight=!1}t._getMouseCanvasPos(e),t.fire("dblclick",t.mouseCanvasPos,!0),t.mouseover&&e.preventDefault()}}),this.element.addEventListener("mousemove",this._mouseMoveListener=function(e){t.enabled&&(t._getMouseCanvasPos(e),t.fire("mousemove",t.mouseCanvasPos,!0),t.mouseover&&e.preventDefault())}),this.element.addEventListener("wheel",this._mouseWheelListener=function(e,i){if(t.enabled){var r=Math.max(-1,Math.min(1,40*-e.deltaY));t.fire("mousewheel",r,!0)}},{passive:!0});var e,i;this.on("mousedown",(function(t){e=t[0],i=t[1]})),this.on("mouseup",(function(r){e>=r[0]-2&&e<=r[0]+2&&i>=r[1]-2&&i<=r[1]+2&&t.fire("mouseclicked",r,!0)}));var r,s,o={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0},a=E.vec3(),n=E.vec3(),l={orientation:null,orientationAngle:0},h={orientationAngle:0,acceleration:null,accelerationIncludingGravity:n,rotationRate:E.vec3(),interval:0},u={alpha:0,beta:0,gamma:0,absolute:!1};window.OrientationChangeEvent&&window.addEventListener("orientationchange",this._orientationchangedListener=function(){r=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,s=r&&o[r]||0,l.orientation=r,l.orientationAngle=s,t.fire("orientationchange",l)},!1),window.DeviceMotionEvent&&window.addEventListener("devicemotion",this._deviceMotionListener=function(e){h.interval=e.interval,h.orientationAngle=s;var i=e.acceleration;i?(a[0]=i.x,a[1]=i.y,a[2]=i.z,h.acceleration=a):h.acceleration=null;var r=e.accelerationIncludingGravity;r?(n[0]=r.x,n[1]=r.y,n[2]=r.z,h.accelerationIncludingGravity=n):h.accelerationIncludingGravity=null,h.rotationRate=e.rotationRate,t.fire("devicemotion",h)},!1),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",this._deviceOrientListener=function(e){u.gamma=e.gamma,u.beta=e.beta,u.alpha=e.alpha,u.absolute=e.absolute,t.fire("deviceorientation",u)},!1),this._eventsBound=!0}},e.prototype._unbindEvents=function(){this._eventsBound&&(document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener),this.element.removeEventListener("mouseenter",this._mouseEnterListener),this.element.removeEventListener("mouseleave",this._mouseLeaveListener),this.element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("click",this._clickListener),document.removeEventListener("dblclick",this._dblClickListener),this.element.removeEventListener("mousemove",this._mouseMoveListener),this.element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener),this._eventsBound=!1)},e.prototype._getMouseCanvasPos=function(t){if(t){for(var e=t.target,i=0,r=0;e.offsetParent;)i+=e.offsetLeft,r+=e.offsetTop,e=e.offsetParent;this.mouseCanvasPos[0]=t.pageX-i,this.mouseCanvasPos[1]=t.pageY-r}else t=window.event,this.mouseCanvasPos[0]=t.x,this.mouseCanvasPos[1]=t.y},e.prototype.setEnabled=function(t){this.enabled!==t&&this.fire("enabled",this.enabled=t)},e.prototype.getEnabled=function(){return this.enabled},e.prototype.setKeyboardEnabled=function(t){this.keyboardEnabled=t},e.prototype.getKeyboardEnabled=function(){return this.keyboardEnabled},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._unbindEvents()},e}(U),se=new t({}),oe=function(t){for(var e in this.id=se.addItem({}),t)t.hasOwnProperty(e)&&(this[e]=t[e])};oe.prototype.destroy=function(){se.removeItem(this.id)};var ae=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({boundary:[0,0,100,100]}),this.boundary=i.boundary,this.autoBoundary=i.autoBoundary}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},boundary:{configurable:!0},autoBoundary:{configurable:!0}};return i.type.get=function(){return"Viewport"},i.boundary.set=function(t){if(!this._autoBoundary){if(!t){var e=this.scene.canvas.boundary;t=[0,0,e[2],e[3]]}this._state.boundary=t,this.glRedraw(),this.fire("boundary",this._state.boundary)}},i.boundary.get=function(){return this._state.boundary},i.autoBoundary.set=function(t){(t=!!t)!==this._autoBoundary&&(this._autoBoundary=t,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",(function(t){var e=t[2],i=t[3];this._state.boundary=[0,0,e,i],this.glRedraw(),this.fire("boundary",this._state.boundary)}),this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))},i.autoBoundary.get=function(){return this._autoBoundary},e.prototype._getState=function(){return this._state},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy()},Object.defineProperties(e.prototype,i),e}(U),ne=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this.camera=e,this._state=new oe({matrix:E.mat4(),inverseMatrix:E.mat4(),transposedMatrix:E.mat4(),near:.1,far:2e3}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this._fov=60,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=i.fov,this.fovAxis=i.fovAxis,this.near=i.near,this.far=i.far}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},fov:{configurable:!0},fovAxis:{configurable:!0},near:{configurable:!0},far:{configurable:!0},matrix:{configurable:!0},inverseMatrix:{configurable:!0},transposedMatrix:{configurable:!0}};return i.type.get=function(){return"Perspective"},e.prototype._update=function(){var t=this.scene.viewport.boundary,e=t[2]/t[3],i=this._fovAxis,r=this._fov;("x"===i||"min"===i&&e<1||"max"===i&&e>1)&&(r/=e),r=Math.min(r,120),E.perspectiveMat4(r*(Math.PI/180),e,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)},i.fov.set=function(t){(t=null!=t?t:60)!==this._fov&&(this._fov=t,this._needUpdate(0),this.fire("fov",this._fov))},i.fov.get=function(){return this._fov},i.fovAxis.set=function(t){t=t||"min",this._fovAxis!==t&&("x"!==t&&"y"!==t&&"min"!==t&&(this.error("Unsupported value for 'fovAxis': "+t+" - defaulting to 'min'"),t="min"),this._fovAxis=t,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))},i.fovAxis.get=function(){return this._fovAxis},i.near.set=function(t){var e=null!=t?t:.1;this._state.near!==e&&(this._state.near=e,this._needUpdate(0),this.fire("near",this._state.near))},i.near.get=function(){return this._state.near},i.far.set=function(t){var e=null!=t?t:2e3;this._state.far!==e&&(this._state.far=e,this._needUpdate(0),this.fire("far",this._state.far))},i.far.get=function(){return this._state.far},i.matrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix},i.inverseMatrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(E.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix},i.transposedMatrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(E.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix},e.prototype.unproject=function(t,e,i,r,s){var o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-n)/n,i[2]=e,i[3]=1,E.mulMat4v4(this.inverseMatrix,i,r),E.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1,E.mulMat4v4(this.camera.inverseViewMatrix,r,s),s},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy(),this.scene.canvas.off(this._canvasResized)},Object.defineProperties(e.prototype,i),e}(U),le=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this.camera=e,this._state=new oe({matrix:E.mat4(),inverseMatrix:E.mat4(),transposedMatrix:E.mat4(),near:.1,far:2e3}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.scale=i.scale,this.near=i.near,this.far=i.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},scale:{configurable:!0},near:{configurable:!0},far:{configurable:!0},matrix:{configurable:!0},inverseMatrix:{configurable:!0},transposedMatrix:{configurable:!0}};return i.type.get=function(){return"Ortho"},e.prototype._update=function(){var t,e,i,r,s=this.scene,o=.5*this._scale,a=s.viewport.boundary,n=a[2],l=a[3],h=n/l;n>l?(t=-o,e=o,i=o/h,r=-o/h):(t=-o*h,e=o*h,i=o,r=-o),E.orthoMat4c(t,e,r,i,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)},i.scale.set=function(t){null==t&&(t=1),t<=0&&(t=.01),this._scale=t,this._needUpdate(0),this.fire("scale",this._scale)},i.scale.get=function(){return this._scale},i.near.set=function(t){var e=null!=t?t:.1;this._state.near!==e&&(this._state.near=e,this._needUpdate(0),this.fire("near",this._state.near))},i.near.get=function(){return this._state.near},i.far.set=function(t){var e=null!=t?t:2e3;this._state.far!==e&&(this._state.far=e,this._needUpdate(0),this.fire("far",this._state.far))},i.far.get=function(){return this._state.far},i.matrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix},i.inverseMatrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(E.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix},i.transposedMatrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(E.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix},e.prototype.unproject=function(t,e,i,r,s){var o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-n)/n,i[2]=e,i[3]=1,E.mulMat4v4(this.inverseMatrix,i,r),E.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1,E.mulMat4v4(this.camera.inverseViewMatrix,r,s),s},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)},Object.defineProperties(e.prototype,i),e}(U),he=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this.camera=e,this._state=new oe({matrix:E.mat4(),inverseMatrix:E.mat4(),transposedMatrix:E.mat4(),near:.1,far:1e4}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.left=i.left,this.right=i.right,this.bottom=i.bottom,this.top=i.top,this.near=i.near,this.far=i.far}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},left:{configurable:!0},right:{configurable:!0},top:{configurable:!0},bottom:{configurable:!0},near:{configurable:!0},far:{configurable:!0},matrix:{configurable:!0},inverseMatrix:{configurable:!0},transposedMatrix:{configurable:!0}};return i.type.get=function(){return"Frustum"},e.prototype._update=function(){E.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)},i.left.set=function(t){this._left=null!=t?t:-1,this._needUpdate(0),this.fire("left",this._left)},i.left.get=function(){return this._left},i.right.set=function(t){this._right=null!=t?t:1,this._needUpdate(0),this.fire("right",this._right)},i.right.get=function(){return this._right},i.top.set=function(t){this._top=null!=t?t:1,this._needUpdate(0),this.fire("top",this._top)},i.top.get=function(){return this._top},i.bottom.set=function(t){this._bottom=null!=t?t:-1,this._needUpdate(0),this.fire("bottom",this._bottom)},i.bottom.get=function(){return this._bottom},i.near.set=function(t){this._state.near=null!=t?t:.1,this._needUpdate(0),this.fire("near",this._state.near)},i.near.get=function(){return this._state.near},i.far.set=function(t){this._state.far=null!=t?t:1e4,this._needUpdate(0),this.fire("far",this._state.far)},i.far.get=function(){return this._state.far},i.matrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix},i.inverseMatrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(E.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix},i.transposedMatrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(E.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix},e.prototype.unproject=function(t,e,i,r,s){var o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-n)/n,i[2]=e,i[3]=1,E.mulMat4v4(this.inverseMatrix,i,r),E.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1,E.mulMat4v4(this.camera.inverseViewMatrix,r,s),s},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy(),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(U),ue=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this.camera=e,this._state=new oe({matrix:E.mat4(),inverseMatrix:E.mat4(),transposedMatrix:E.mat4()}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!1,this.matrix=i.matrix}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},matrix:{configurable:!0},inverseMatrix:{configurable:!0},transposedMatrix:{configurable:!0}};return i.type.get=function(){return"CustomProjection"},i.matrix.set=function(t){this._state.matrix.set(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("far",this._state.matrix)},i.matrix.get=function(){return this._state.matrix},i.inverseMatrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(E.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix},i.transposedMatrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(E.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix},e.prototype.unproject=function(t,e,i,r,s){var o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-n)/n,i[2]=e,i[3]=1,E.mulMat4v4(this.inverseMatrix,i,r),E.mulVec3Scalar(r,1/r[3]),r[3]=1,r[1]*=-1,E.mulMat4v4(this.camera.inverseViewMatrix,r,s),s},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy()},Object.defineProperties(e.prototype,i),e}(U),ce=E.vec3(),pe=E.vec3(),de=E.vec3(),fe=E.vec3(),_e=E.vec3(),ge=E.vec3(),me=E.mat4(),ve=E.mat4(),be=E.vec3(),ye=E.vec3(),Pe=E.vec3(),Me=E.vec3(),xe=function(t){function e(e,i){var r=this;void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({deviceMatrix:E.mat4(),hasDeviceMatrix:!1,matrix:E.mat4(),normalMatrix:E.mat4(),inverseMatrix:E.mat4()}),this._perspective=new ne(this),this._ortho=new le(this),this._frustum=new he(this),this._customProjection=new ue(this),this._project=this._perspective,this._eye=E.vec3([0,0,10]),this._look=E.vec3([0,0,0]),this._up=E.vec3([0,1,0]),this._worldUp=E.vec3([0,1,0]),this._worldRight=E.vec3([1,0,0]),this._worldForward=E.vec3([0,0,-1]),this.deviceMatrix=i.deviceMatrix,this.eye=i.eye,this.look=i.look,this.up=i.up,this.worldAxis=i.worldAxis,this.gimbalLock=i.gimbalLock,this.constrainPitch=i.constrainPitch,this.projection=i.projection,this._perspective.on("matrix",(function(){"perspective"===r._projectionType&&r.fire("projMatrix",r._perspective.matrix)})),this._ortho.on("matrix",(function(){"ortho"===r._projectionType&&r.fire("projMatrix",r._ortho.matrix)})),this._frustum.on("matrix",(function(){"frustum"===r._projectionType&&r.fire("projMatrix",r._frustum.matrix)})),this._customProjection.on("matrix",(function(){"customProjection"===r._projectionType&&r.fire("projMatrix",r._customProjection.matrix)}))}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},eye:{configurable:!0},look:{configurable:!0},up:{configurable:!0},deviceMatrix:{configurable:!0},worldAxis:{configurable:!0},worldUp:{configurable:!0},xUp:{configurable:!0},yUp:{configurable:!0},zUp:{configurable:!0},worldRight:{configurable:!0},worldForward:{configurable:!0},gimbalLock:{configurable:!0},constrainPitch:{configurable:!0},eyeLookDist:{configurable:!0},matrix:{configurable:!0},viewMatrix:{configurable:!0},normalMatrix:{configurable:!0},viewNormalMatrix:{configurable:!0},inverseViewMatrix:{configurable:!0},projMatrix:{configurable:!0},perspective:{configurable:!0},ortho:{configurable:!0},frustum:{configurable:!0},customProjection:{configurable:!0},projection:{configurable:!0},project:{configurable:!0}};return i.type.get=function(){return"Camera"},e.prototype._update=function(){var t,e=this._state;"ortho"===this.projection?(E.subVec3(this._eye,this._look,be),E.normalizeVec3(be,ye),E.mulVec3Scalar(ye,1e3,Pe),E.addVec3(this._look,Pe,Me),t=Me):t=this._eye,e.hasDeviceMatrix?(E.lookAtMat4v(t,this._look,this._up,ve),E.mulMat4(e.deviceMatrix,ve,e.matrix)):E.lookAtMat4v(t,this._look,this._up,e.matrix),E.inverseMat4(this._state.matrix,this._state.inverseMatrix),E.transposeMat4(this._state.inverseMatrix,this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)},e.prototype.orbitYaw=function(t){var e=E.subVec3(this._eye,this._look,ce);E.rotationMat4v(.0174532925*t,this._gimbalLock?this._worldUp:this._up,me),e=E.transformPoint3(me,e,pe),this.eye=E.addVec3(this._look,e,de),this.up=E.transformPoint3(me,this._up,fe)},e.prototype.orbitPitch=function(t){if(!(this._constrainPitch&&(t=E.dotVec3(this._up,this._worldUp)/E.DEGTORAD)<1)){var e=E.subVec3(this._eye,this._look,ce),i=E.cross3Vec3(E.normalizeVec3(e,pe),E.normalizeVec3(this._up,de));E.rotationMat4v(.0174532925*t,i,me),e=E.transformPoint3(me,e,fe),this.up=E.transformPoint3(me,this._up,_e),this.eye=E.addVec3(e,this._look,ge)}},e.prototype.yaw=function(t){var e=E.subVec3(this._look,this._eye,ce);E.rotationMat4v(.0174532925*t,this._gimbalLock?this._worldUp:this._up,me),e=E.transformPoint3(me,e,pe),this.look=E.addVec3(e,this._eye,de),this._gimbalLock&&(this.up=E.transformPoint3(me,this._up,fe))},e.prototype.pitch=function(t){if(!(this._constrainPitch&&(t=E.dotVec3(this._up,this._worldUp)/E.DEGTORAD)<1)){var e=E.subVec3(this._look,this._eye,ce),i=E.cross3Vec3(E.normalizeVec3(e,pe),E.normalizeVec3(this._up,de));E.rotationMat4v(.0174532925*t,i,me),this.up=E.transformPoint3(me,this._up,ge),e=E.transformPoint3(me,e,fe),this.look=E.addVec3(e,this._eye,_e)}},e.prototype.pan=function(t){var e,i=E.subVec3(this._eye,this._look,ce),r=[0,0,0];if(0!==t[0]){var s=E.cross3Vec3(E.normalizeVec3(i,[]),E.normalizeVec3(this._up,pe));e=E.mulVec3Scalar(s,t[0]),r[0]+=e[0],r[1]+=e[1],r[2]+=e[2]}0!==t[1]&&(e=E.mulVec3Scalar(E.normalizeVec3(this._up,de),t[1]),r[0]+=e[0],r[1]+=e[1],r[2]+=e[2]),0!==t[2]&&(e=E.mulVec3Scalar(E.normalizeVec3(i,fe),t[2]),r[0]+=e[0],r[1]+=e[1],r[2]+=e[2]),this.eye=E.addVec3(this._eye,r,_e),this.look=E.addVec3(this._look,r,ge)},e.prototype.zoom=function(t){var e=E.subVec3(this._eye,this._look,ce),i=Math.abs(E.lenVec3(e,pe)),r=Math.abs(i+t);if(!(r<.5)){var s=E.normalizeVec3(e,de);this.eye=E.addVec3(this._look,E.mulVec3Scalar(s,r),fe)}},i.eye.set=function(t){this._eye.set(t||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)},i.eye.get=function(){return this._eye},i.look.set=function(t){this._look.set(t||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)},i.look.get=function(){return this._look},i.up.set=function(t){this._up.set(t||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)},i.up.get=function(){return this._up},i.deviceMatrix.set=function(t){this._state.deviceMatrix.set(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!t,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)},i.deviceMatrix.get=function(){return this._state.deviceMatrix},i.worldAxis.set=function(t){t=t||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(t):this._worldAxis=E.vec3(t),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)},i.worldAxis.get=function(){return this._worldAxis},i.worldUp.get=function(){return this._worldUp},i.xUp.get=function(){return this._worldUp[0]>this._worldUp[1]&&this._worldUp[0]>this._worldUp[2]},i.yUp.get=function(){return this._worldUp[1]>this._worldUp[0]&&this._worldUp[1]>this._worldUp[2]},i.zUp.get=function(){return this._worldUp[2]>this._worldUp[0]&&this._worldUp[2]>this._worldUp[1]},i.worldRight.get=function(){return this._worldRight},i.worldForward.get=function(){return this._worldForward},i.gimbalLock.set=function(t){this._gimbalLock=!1!==t,this.fire("gimbalLock",this._gimbalLock)},i.gimbalLock.get=function(){return this._gimbalLock},i.constrainPitch.set=function(t){this._constrainPitch=!!t,this.fire("constrainPitch",this._constrainPitch)},i.eyeLookDist.get=function(){return E.lenVec3(E.subVec3(this._look,this._eye,ce))},i.matrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix},i.viewMatrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix},i.normalMatrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix},i.viewNormalMatrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix},i.inverseViewMatrix.get=function(){return this._updateScheduled&&this._doUpdate(),this._state.inverseMatrix},i.projMatrix.get=function(){return this[this.projection].matrix},i.perspective.get=function(){return this._perspective},i.ortho.get=function(){return this._ortho},i.frustum.get=function(){return this._frustum},i.customProjection.get=function(){return this._customProjection},i.projection.set=function(t){t=t||"perspective",this._projectionType!==t&&("perspective"===t?this._project=this._perspective:"ortho"===t?this._project=this._ortho:"frustum"===t?this._project=this._frustum:"customProjection"===t?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+t+" defaulting to 'perspective'"),this._project=this._perspective,t="perspective"),this._project._update(),this._projectionType=t,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType),this.fire("projMatrix",this._project.matrix))},i.projection.get=function(){return this._projectionType},i.project.get=function(){return this._project},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy()},Object.defineProperties(e.prototype,i),e}(U),we=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},isLight:{configurable:!0}};return i.type.get=function(){return"Light"},i.isLight.get=function(){return!0},Object.defineProperties(e.prototype,i),e}(U),Ee=function(t){function e(e,i){var r=this;void 0===i&&(i={}),t.call(this,e,i),this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;var s=this.scene.camera,o=this.scene.canvas;this._onCameraViewMatrix=s.on("viewMatrix",(function(){r._shadowViewMatrixDirty=!0})),this._onCameraProjMatrix=s.on("projMatrix",(function(){r._shadowProjMatrixDirty=!0})),this._onCanvasBoundary=o.on("boundary",(function(){r._shadowProjMatrixDirty=!0})),this._state=new oe({type:"dir",dir:E.vec3([1,1,1]),color:E.vec3([.7,.7,.8]),intensity:1,space:i.space||"view",castsShadow:!1,getShadowViewMatrix:function(){if(r._shadowViewMatrixDirty){r._shadowViewMatrix||(r._shadowViewMatrix=E.identityMat4());var t=r.scene.camera,e=r._state.dir,i=t.look,s=[i[0]-e[0],i[1]-e[1],i[2]-e[2]];E.lookAtMat4v(s,i,[0,1,0],r._shadowViewMatrix),r._shadowViewMatrixDirty=!1}return r._shadowViewMatrix},getShadowProjMatrix:function(){return r._shadowProjMatrixDirty&&(r._shadowProjMatrix||(r._shadowProjMatrix=E.identityMat4()),E.orthoMat4c(-40,40,-40,40,-40,80,r._shadowProjMatrix),r._shadowProjMatrixDirty=!1),r._shadowProjMatrix},getShadowRenderBuf:function(){return r._shadowRenderBuf||(r._shadowRenderBuf=new Bt(r.scene.canvas.canvas,r.scene.canvas.gl,{size:[1024,1024]})),r._shadowRenderBuf}}),this.dir=i.dir,this.color=i.color,this.intensity=i.intensity,this.castsShadow=i.castsShadow,this.scene._lightCreated(this)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},dir:{configurable:!0},color:{configurable:!0},intensity:{configurable:!0},castsShadow:{configurable:!0}};return i.type.get=function(){return"DirLight"},i.dir.set=function(t){this._state.dir.set(t||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()},i.dir.get=function(){return this._state.dir},i.color.set=function(t){this._state.color.set(t||[.7,.7,.8]),this.glRedraw()},i.color.get=function(){return this._state.color},i.intensity.set=function(t){t=void 0!==t?t:1,this._state.intensity=t,this.glRedraw()},i.intensity.get=function(){return this._state.intensity},i.castsShadow.set=function(t){t=!!t,this._state.castsShadow!==t&&(this._state.castsShadow=t,this._shadowViewMatrixDirty=!0,this.glRedraw())},i.castsShadow.get=function(){return this._state.castsShadow},e.prototype.destroy=function(){var e=this.scene.camera,i=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),i.off(this._onCanvasBoundary),t.prototype.destroy.call(this),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()},Object.defineProperties(e.prototype,i),e}(we),Ce=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state={type:"ambient",color:E.vec3([.7,.7,.7]),intensity:1},this.color=i.color,this.intensity=i.intensity,this.scene._lightCreated(this)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},color:{configurable:!0},intensity:{configurable:!0}};return i.type.get=function(){return"AmbientLight"},i.color.set=function(t){this._state.color.set(t||[.7,.7,.8]),this.glRedraw()},i.color.get=function(){return this._state.color},i.intensity.set=function(t){this._state.intensity=void 0!==t?t:1,this.glRedraw()},i.intensity.get=function(){return this._state.intensity},e.prototype.destroy=function(){t.prototype.destroy.call(this),this.scene._lightDestroyed(this)},Object.defineProperties(e.prototype,i),e}(we),Ae=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),S.memory.meshes++}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},isGeometry:{configurable:!0}};return i.type.get=function(){return"Geometry"},i.isGeometry.get=function(){return!0},e.prototype.destroy=function(){t.prototype.destroy.call(this),S.memory.meshes--},Object.defineProperties(e.prototype,i),e}(U),Se=function(){var t=[],e=[],i=[],r=[],s=[],o=0,a=new Uint16Array(3),n=new Uint16Array(3),l=new Uint16Array(3),h=E.vec3(),u=E.vec3(),c=E.vec3(),p=E.vec3(),d=E.vec3(),f=E.vec3(),_=E.vec3();return function(g,m,v,b){!function(s,o){var a,n,l,h,u,c,p={},d=Math.pow(10,4),f=0;for(u=0,c=s.length;u<c;u+=3)a=s[u],n=s[u+1],l=s[u+2],void 0===p[h=Math.round(a*d)+"_"+Math.round(n*d)+"_"+Math.round(l*d)]&&(p[h]=f/3,t[f++]=a,t[f++]=n,t[f++]=l),e[u/3]=p[h];for(u=0,c=o.length;u<c;u++)r[u]=e[o[u]],i[r[u]]=o[u]}(g,m),function(e,i){o=0;for(var g=0,m=e;g<m;g+=3){var v=3*r[g],b=3*r[g+1],y=3*r[g+2];i?(a[0]=t[v],a[1]=t[v+1],a[2]=t[v+2],n[0]=t[b],n[1]=t[b+1],n[2]=t[b+2],l[0]=t[y],l[1]=t[y+1],l[2]=t[y+2],E.decompressPosition(a,i,h),E.decompressPosition(n,i,u),E.decompressPosition(l,i,c)):(h[0]=t[v],h[1]=t[v+1],h[2]=t[v+2],u[0]=t[b],u[1]=t[b+1],u[2]=t[b+2],c[0]=t[y],c[1]=t[y+1],c[2]=t[y+2]),E.subVec3(c,u,p),E.subVec3(h,u,d),E.cross3Vec3(p,d,f),E.normalizeVec3(f,_);var P=s[o]||(s[o]={normal:E.vec3()});P.normal[0]=_[0],P.normal[1]=_[1],P.normal[2]=_[2],o++}}(m.length,v);for(var y,P,M,x,w,C,A,S,D,L,B=[],R=Math.cos(E.DEGTORAD*b),T={},F=!1,N=0,I=m.length;N<I;N+=3)for(var k=N/3,O=0;O<3;O++)y=r[N+O],P=r[N+(O+1)%3],void 0===T[w=(M=Math.min(y,P))+","+(x=Math.max(y,P))]?T[w]={index1:M,index2:x,face1:k,face2:void 0}:T[w].face2=k;for(w in T)void 0!==(C=T[w]).face2&&(A=s[C.face1].normal,S=s[C.face2].normal,E.dotVec3(A,S)>R)||(D=i[C.index1],L=i[C.index2],(!F&&D>65535||L>65535)&&(F=!0),B.push(D),B.push(L));return F?new Uint32Array(B):new Uint16Array(B)}}();function De(t,e,i,r){var s=t[e]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2])),o=t[e+1]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2]));if(t[e+2]<0){var a=(1-Math.abs(o))*(s>=0?1:-1),n=(1-Math.abs(s))*(o>=0?1:-1);s=a,o=n}return new Int8Array([Math[i](127.5*s+(s<0?-1:0)),Math[r](127.5*o+(o<0?-1:0))])}function Le(t){var e=t[0],i=t[1];e/=e<0?127:128,i/=i<0?127:128;var r=1-Math.abs(e)-Math.abs(i);r<0&&(e=(1-Math.abs(i))*(e>=0?1:-1),i=(1-Math.abs(e))*(i>=0?1:-1));var s=Math.sqrt(e*e+i*i+r*r);return[e/s,i/s,r/s]}function Be(t,e,i){return t[e]*i[0]+t[e+1]*i[1]+t[e+2]*i[2]}var Re={getPositionsBounds:function(t){var e,i,r=new Float32Array(3),s=new Float32Array(3);for(e=0;e<3;e++)r[e]=Number.MAX_VALUE,s[e]=-Number.MAX_VALUE;for(e=0;e<t.length;e+=3)for(i=0;i<3;i++)r[i]=Math.min(r[i],t[e+i]),s[i]=Math.max(s[i],t[e+i]);return{min:r,max:s}},createPositionsDecodeMatrix:function(){var t=E.mat4(),e=E.mat4();return function(i,r){r=r||E.mat4();var s=i[0],o=i[1],a=i[2],n=i[3]-s,l=i[4]-o,h=i[5]-a,u=65535;return E.identityMat4(t),E.translationMat4v(i,t),E.identityMat4(e),E.scalingMat4v([n/u,l/u,h/u],e),E.mulMat4(t,e,r),r}}(),compressPositions:function(){var t=E.mat4(),e=E.mat4();return function(i,r,s){var o,a=new Uint16Array(i.length),n=new Float32Array([s[0]!==r[0]?65535/(s[0]-r[0]):0,s[1]!==r[1]?65535/(s[1]-r[1]):0,s[2]!==r[2]?65535/(s[2]-r[2]):0]);for(o=0;o<i.length;o+=3)a[o+0]=Math.floor((i[o+0]-r[0])*n[0]),a[o+1]=Math.floor((i[o+1]-r[1])*n[1]),a[o+2]=Math.floor((i[o+2]-r[2])*n[2]);return E.identityMat4(t),E.translationMat4v(r,t),E.identityMat4(e),E.scalingMat4v([(s[0]-r[0])/65535,(s[1]-r[1])/65535,(s[2]-r[2])/65535],e),{quantized:a,decodeMatrix:E.mulMat4(t,e,E.identityMat4())}}}(),decompressPositions:function(t,e,i){void 0===i&&(i=new Float32Array(t.length));for(var r=0,s=t.length;r<s;r+=3)i[r+0]=t[r+0]*e[0]+e[12],i[r+1]=t[r+1]*e[5]+e[13],i[r+2]=t[r+2]*e[10]+e[14];return i},decompressPosition:function(t,e,i){return i[0]=t[0]*e[0]+e[12],i[1]=t[1]*e[5]+e[13],i[2]=t[2]*e[10]+e[14],i},decompressAABB:function(t,e,i){return void 0===i&&(i=t),i[0]=t[0]*e[0]+e[12],i[1]=t[1]*e[5]+e[13],i[2]=t[2]*e[10]+e[14],i[3]=t[3]*e[0]+e[12],i[4]=t[4]*e[5]+e[13],i[5]=t[5]*e[10]+e[14],i},getUVBounds:function(t){var e,i,r=new Float32Array(2),s=new Float32Array(2);for(e=0;e<2;e++)r[e]=Number.MAX_VALUE,s[e]=-Number.MAX_VALUE;for(e=0;e<t.length;e+=2)for(i=0;i<2;i++)r[i]=Math.min(r[i],t[e+i]),s[i]=Math.max(s[i],t[e+i]);return{min:r,max:s}},compressUVs:function(){var t=E.mat3(),e=E.mat3();return function(i,r,s){var o,a=new Uint16Array(i.length),n=new Float32Array([65535/(s[0]-r[0]),65535/(s[1]-r[1])]);for(o=0;o<i.length;o+=2)a[o+0]=Math.floor((i[o+0]-r[0])*n[0]),a[o+1]=Math.floor((i[o+1]-r[1])*n[1]);return E.identityMat3(t),E.translationMat3v(r,t),E.identityMat3(e),E.scalingMat3v([(s[0]-r[0])/65535,(s[1]-r[1])/65535],e),{quantized:a,decodeMatrix:E.mulMat3(t,e,E.identityMat3())}}}(),decompressUVs:function(t,e,i){void 0===i&&(i=new Float32Array(t.length));for(var r=0,s=t.length;r<s;r+=3)i[r+0]=t[r+0]*e[0]+e[6],i[r+1]=t[r+1]*e[4]+e[7];return i},decompressUV:function(t,e,i){i[0]=t[0]*e[0]+e[6],i[1]=t[1]*e[4]+e[7]},compressNormals:function(t){for(var e,i,r,s,o=new Int8Array(t.length),a=0;a<t.length;a+=3)i=e=De(t,a,"floor","floor"),r=s=Be(t,a,Le(e)),(r=Be(t,a,Le(e=De(t,a,"ceil","floor"))))>s&&(i=e,s=r),(r=Be(t,a,Le(e=De(t,a,"floor","ceil"))))>s&&(i=e,s=r),(r=Be(t,a,Le(e=De(t,a,"ceil","ceil"))))>s&&(i=e,s=r),o[a]=i[0],o[a+1]=i[1];return o},decompressNormals:function(t,e){for(var i=0,r=0,s=t.length;i<s;i+=2){var o=t[i+0],a=t[i+1];o=(2*o+1)/255,a=(2*a+1)/255;var n=1-Math.abs(o)-Math.abs(a);n<0&&(o=(1-Math.abs(a))*(o>=0?1:-1),a=(1-Math.abs(o))*(a>=0?1:-1));var l=Math.sqrt(o*o+a*a+n*n);e[r+0]=o/l,e[r+1]=a/l,e[r+2]=n/l,r+=3}return e},decompressNormal:function(t,e){var i=t[0],r=t[1];i=(2*i+1)/255,r=(2*r+1)/255;var s=1-Math.abs(i)-Math.abs(r);s<0&&(i=(1-Math.abs(r))*(i>=0?1:-1),r=(1-Math.abs(i))*(r>=0?1:-1));var o=Math.sqrt(i*i+r*r+s*s);return e[0]=i/o,e[1]=r/o,e[2]=s/o,e}},Te=S.memory,Fe=wt.SUPPORTED_EXTENSIONS.OES_element_index_uint,Ne=Fe?Uint32Array:Uint16Array,Ie=E.AABB3(),ke=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({compressGeometry:!!i.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=i.edgeThreshold||10,this._edgeIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._aabbDirty=!0,this._boundingSphere=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;var r=this._state,s=this.scene.canvas.gl;switch(i.primitive=i.primitive||"triangles",i.primitive){case"points":r.primitive=s.POINTS,r.primitiveName=i.primitive;break;case"lines":r.primitive=s.LINES,r.primitiveName=i.primitive;break;case"line-loop":r.primitive=s.LINE_LOOP,r.primitiveName=i.primitive;break;case"line-strip":r.primitive=s.LINE_STRIP,r.primitiveName=i.primitive;break;case"triangles":r.primitive=s.TRIANGLES,r.primitiveName=i.primitive;break;case"triangle-strip":r.primitive=s.TRIANGLE_STRIP,r.primitiveName=i.primitive;break;case"triangle-fan":r.primitive=s.TRIANGLE_FAN,r.primitiveName=i.primitive;break;default:this.error("Unsupported value for 'primitive': '"+i.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),r.primitive=s.TRIANGLES,r.primitiveName=i.primitive}if(i.positions)if(this._state.compressGeometry){var o=Re.getPositionsBounds(i.positions),a=Re.compressPositions(i.positions,o.min,o.max);r.positions=a.quantized,r.positionsDecodeMatrix=a.decodeMatrix}else r.positions=i.positions.constructor===Float32Array?i.positions:new Float32Array(i.positions);if(i.colors&&(r.colors=i.colors.constructor===Float32Array?i.colors:new Float32Array(i.colors)),i.uv)if(this._state.compressGeometry){var n=Re.getUVBounds(i.uv),l=Re.compressUVs(i.uv,n.min,n.max);r.uv=l.quantized,r.uvDecodeMatrix=l.decodeMatrix}else r.uv=i.uv.constructor===Float32Array?i.uv:new Float32Array(i.uv);if(i.normals&&(this._state.compressGeometry?r.normals=Re.compressNormals(i.normals):r.normals=i.normals.constructor===Float32Array?i.normals:new Float32Array(i.normals)),i.indices){if(!Fe&&i.indices.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");r.indices=i.indices.constructor===Uint32Array||i.indices.constructor===Uint16Array?i.indices:new Ne(i.indices),"triangles"===this._state.primitiveName&&(this._numTriangles=i.indices.length/3)}this._buildHash(),Te.meshes++,this._buildVBOs()}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},isReadableGeometry:{configurable:!0},primitive:{configurable:!0},compressGeometry:{configurable:!0},positions:{configurable:!0},normals:{configurable:!0},uv:{configurable:!0},colors:{configurable:!0},indices:{configurable:!0},aabb:{configurable:!0},obb:{configurable:!0},numTriangles:{configurable:!0}};return i.type.get=function(){return"ReadableGeometry"},i.isReadableGeometry.get=function(){return!0},e.prototype._buildVBOs=function(){var t=this._state,e=this.scene.canvas.gl;if(t.indices&&(t.indicesBuf=new Ut(e,e.ELEMENT_ARRAY_BUFFER,t.indices,t.indices.length,1,e.STATIC_DRAW),Te.indices+=t.indicesBuf.numItems),t.positions&&(t.positionsBuf=new Ut(e,e.ARRAY_BUFFER,t.positions,t.positions.length,3,e.STATIC_DRAW),Te.positions+=t.positionsBuf.numItems),t.normals){var i=t.compressGeometry;t.normalsBuf=new Ut(e,e.ARRAY_BUFFER,t.normals,t.normals.length,3,e.STATIC_DRAW,i),Te.normals+=t.normalsBuf.numItems}t.colors&&(t.colorsBuf=new Ut(e,e.ARRAY_BUFFER,t.colors,t.colors.length,4,e.STATIC_DRAW),Te.colors+=t.colorsBuf.numItems),t.uv&&(t.uvBuf=new Ut(e,e.ARRAY_BUFFER,t.uv,t.uv.length,2,e.STATIC_DRAW),Te.uvs+=t.uvBuf.numItems)},e.prototype._buildHash=function(){var t=this._state,e=["/g"];e.push("/"+t.primitive+";"),t.positions&&e.push("p"),t.colors&&e.push("c"),(t.normals||t.autoVertexNormals)&&e.push("n"),t.uv&&e.push("u"),t.compressGeometry&&e.push("cp"),e.push(";"),t.hash=e.join("")},e.prototype._getEdgeIndices=function(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf},e.prototype._getPickTrianglePositions=function(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf},e.prototype._getPickTriangleColors=function(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf},e.prototype._buildEdgeIndices=function(){var t=this._state;if(t.positions&&t.indices){var e=this.scene.canvas.gl,i=Se(t.positions,t.indices,t.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new Ut(e,e.ELEMENT_ARRAY_BUFFER,i,i.length,1,e.STATIC_DRAW),Te.indices+=this._edgeIndicesBuf.numItems}},e.prototype._buildPickTriangleVBOs=function(){var t=this._state;if(t.positions&&t.indices){var e=this.scene.canvas.gl,i=E.buildPickTriangles(t.positions,t.indices,t.compressGeometry),r=i.positions,s=i.colors;this._pickTrianglePositionsBuf=new Ut(e,e.ARRAY_BUFFER,r,r.length,3,e.STATIC_DRAW),this._pickTriangleColorsBuf=new Ut(e,e.ARRAY_BUFFER,s,s.length,4,e.STATIC_DRAW,!0),Te.positions+=this._pickTrianglePositionsBuf.numItems,Te.colors+=this._pickTriangleColorsBuf.numItems}},e.prototype._buildPickVertexVBOs=function(){},e.prototype._webglContextLost=function(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()},e.prototype._webglContextRestored=function(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null},i.primitive.get=function(){return this._state.primitiveName},i.compressGeometry.get=function(){return this._state.compressGeometry},i.positions.get=function(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),Re.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null},i.positions.set=function(t){var e=this._state,i=e.positions;if(i)if(i.length===t.length){if(this._state.compressGeometry){var r=Re.getPositionsBounds(t),s=Re.compressPositions(t,r.min,r.max);t=s.quantized,e.positionsDecodeMatrix=s.decodeMatrix}i.set(t),e.positionsBuf&&e.positionsBuf.setData(i),this._setAABBDirty(),this.glRedraw()}else this.error("can't update geometry positions - new positions are wrong length");else this.error("can't update geometry positions - geometry has no positions")},i.normals.get=function(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){var t=this._state.normals.length,e=t+t/2;this._decompressedNormals=new Float32Array(e),Re.decompressNormals(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}},i.normals.set=function(t){if(this._state.compressGeometry)this.error("can't update geometry normals - quantized geometry is immutable");else{var e=this._state,i=e.normals;i?i.length===t.length?(i.set(t),e.normalsBuf&&e.normalsBuf.setData(i),this.glRedraw()):this.error("can't update geometry normals - new normals are wrong length"):this.error("can't update geometry normals - geometry has no normals")}},i.uv.get=function(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),Re.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null},i.uv.set=function(t){if(this._state.compressGeometry)this.error("can't update geometry UVs - quantized geometry is immutable");else{var e=this._state,i=e.uv;i?i.length===t.length?(i.set(t),e.uvBuf&&e.uvBuf.setData(i),this.glRedraw()):this.error("can't update geometry UVs - new UVs are wrong length"):this.error("can't update geometry UVs - geometry has no UVs")}},i.colors.get=function(){return this._state.colors},i.colors.set=function(t){if(this._state.compressGeometry)this.error("can't update geometry colors - quantized geometry is immutable");else{var e=this._state,i=e.colors;i?i.length===t.length?(i.set(t),e.colorsBuf&&e.colorsBuf.setData(i),this.glRedraw()):this.error("can't update geometry colors - new colors are wrong length"):this.error("can't update geometry colors - geometry has no colors")}},i.indices.get=function(){return this._state.indices},i.aabb.get=function(){return this._aabbDirty&&(this._aabb||(this._aabb=E.AABB3()),E.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb},i.obb.get=function(){return this._obbDirty&&(this._obb||(this._obb=E.OBB3()),E.positions3ToAABB3(this._state.positions,Ie,this._state.positionsDecodeMatrix),E.AABB3ToOBB3(Ie,this._obb),this._obbDirty=!1),this._obb},i.numTriangles.get=function(){return this._numTriangles},e.prototype._setAABBDirty=function(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0)},e.prototype._getState=function(){return this._state},e.prototype.destroy=function(){t.prototype.destroy.call(this);var e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),e.destroy(),Te.meshes--},Object.defineProperties(e.prototype,i),e}(Ae);function Oe(t){void 0===t&&(t={});var e=t.xSize||1;e<0&&(console.error("negative xSize not allowed - will invert"),e*=-1);var i=t.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);var r=t.zSize||1;r<0&&(console.error("negative zSize not allowed - will invert"),r*=-1);var s=t.center,o=s?s[0]:0,a=s?s[1]:0,n=s?s[2]:0,l=-e+o,h=-i+a,u=-r+n,c=e+o,p=i+a,d=r+n;return B.apply(t,{positions:[c,p,d,l,p,d,l,h,d,c,h,d,c,p,d,c,h,d,c,h,u,c,p,u,c,p,d,c,p,u,l,p,u,l,p,d,l,p,d,l,p,u,l,h,u,l,h,d,l,h,u,c,h,u,c,h,d,l,h,d,c,h,u,l,h,u,l,p,u,c,p,u],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}var Ve=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),S.memory.materials++}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0}};return i.type.get=function(){return"Material"},e.prototype.destroy=function(){t.prototype.destroy.call(this),S.memory.materials--},Object.defineProperties(e.prototype,i),e}(U),ze={opaque:0,mask:1,blend:2},Ue=["opaque","mask","blend"],je=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({type:"PhongMaterial",ambient:E.vec3([1,1,1]),diffuse:E.vec3([1,1,1]),specular:E.vec3([1,1,1]),emissive:E.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=i.ambient,this.diffuse=i.diffuse,this.specular=i.specular,this.emissive=i.emissive,this.alpha=i.alpha,this.shininess=i.shininess,this.reflectivity=i.reflectivity,this.lineWidth=i.lineWidth,this.pointSize=i.pointSize,i.ambientMap&&(this._ambientMap=this._checkComponent("Texture",i.ambientMap)),i.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",i.diffuseMap)),i.specularMap&&(this._specularMap=this._checkComponent("Texture",i.specularMap)),i.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",i.emissiveMap)),i.alphaMap&&(this._alphaMap=this._checkComponent("Texture",i.alphaMap)),i.reflectivityMap&&(this._reflectivityMap=this._checkComponent("Texture",i.reflectivityMap)),i.normalMap&&(this._normalMap=this._checkComponent("Texture",i.normalMap)),i.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",i.occlusionMap)),i.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("Fresnel",i.diffuseFresnel)),i.specularFresnel&&(this._specularFresnel=this._checkComponent("Fresnel",i.specularFresnel)),i.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("Fresnel",i.emissiveFresnel)),i.alphaFresnel&&(this._alphaFresnel=this._checkComponent("Fresnel",i.alphaFresnel)),i.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("Fresnel",i.reflectivityFresnel)),this.alphaMode=i.alphaMode,this.alphaCutoff=i.alphaCutoff,this.backfaces=i.backfaces,this.frontface=i.frontface,this._makeHash()}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},ambient:{configurable:!0},diffuse:{configurable:!0},specular:{configurable:!0},emissive:{configurable:!0},alpha:{configurable:!0},shininess:{configurable:!0},lineWidth:{configurable:!0},pointSize:{configurable:!0},reflectivity:{configurable:!0},normalMap:{configurable:!0},ambientMap:{configurable:!0},diffuseMap:{configurable:!0},specularMap:{configurable:!0},emissiveMap:{configurable:!0},alphaMap:{configurable:!0},reflectivityMap:{configurable:!0},occlusionMap:{configurable:!0},diffuseFresnel:{configurable:!0},specularFresnel:{configurable:!0},emissiveFresnel:{configurable:!0},alphaFresnel:{configurable:!0},reflectivityFresnel:{configurable:!0},alphaMode:{configurable:!0},alphaCutoff:{configurable:!0},backfaces:{configurable:!0},frontface:{configurable:!0}};return i.type.get=function(){return"PhongMaterial"},e.prototype._makeHash=function(){var t=this._state,e=["/p"];this._normalMap&&(e.push("/nm"),this._normalMap.hasMatrix&&e.push("/mat")),this._ambientMap&&(e.push("/am"),this._ambientMap.hasMatrix&&e.push("/mat"),e.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(e.push("/dm"),this._diffuseMap.hasMatrix&&e.push("/mat"),e.push("/"+this._diffuseMap.encoding)),this._specularMap&&(e.push("/sm"),this._specularMap.hasMatrix&&e.push("/mat")),this._emissiveMap&&(e.push("/em"),this._emissiveMap.hasMatrix&&e.push("/mat"),e.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(e.push("/opm"),this._alphaMap.hasMatrix&&e.push("/mat")),this._reflectivityMap&&(e.push("/rm"),this._reflectivityMap.hasMatrix&&e.push("/mat")),this._occlusionMap&&(e.push("/ocm"),this._occlusionMap.hasMatrix&&e.push("/mat")),this._diffuseFresnel&&e.push("/df"),this._specularFresnel&&e.push("/sf"),this._emissiveFresnel&&e.push("/ef"),this._alphaFresnel&&e.push("/of"),this._reflectivityFresnel&&e.push("/rf"),e.push(";"),t.hash=e.join("")},i.ambient.set=function(t){var e=this._state.ambient;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.ambient=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()},i.ambient.get=function(){return this._state.ambient},i.diffuse.set=function(t){var e=this._state.diffuse;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.diffuse=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()},i.diffuse.get=function(){return this._state.diffuse},i.specular.set=function(t){var e=this._state.specular;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.specular=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()},i.specular.get=function(){return this._state.specular},i.emissive.set=function(t){var e=this._state.emissive;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.emissive=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=0,e[1]=0,e[2]=0),this.glRedraw()},i.emissive.get=function(){return this._state.emissive},i.alpha.set=function(t){t=null!=t?t:1,this._state.alpha!==t&&(this._state.alpha=t,this.glRedraw())},i.alpha.get=function(){return this._state.alpha},i.shininess.set=function(t){this._state.shininess=void 0!==t?t:80,this.glRedraw()},i.shininess.get=function(){return this._state.shininess},i.lineWidth.set=function(t){this._state.lineWidth=t||1,this.glRedraw()},i.lineWidth.get=function(){return this._state.lineWidth},i.pointSize.set=function(t){this._state.pointSize=t||1,this.glRedraw()},i.pointSize.get=function(){return this._state.pointSize},i.reflectivity.set=function(t){this._state.reflectivity=void 0!==t?t:1,this.glRedraw()},i.reflectivity.get=function(){return this._state.reflectivity},i.normalMap.get=function(){return this._normalMap},i.ambientMap.get=function(){return this._ambientMap},i.diffuseMap.get=function(){return this._diffuseMap},i.specularMap.get=function(){return this._specularMap},i.emissiveMap.get=function(){return this._emissiveMap},i.alphaMap.get=function(){return this._alphaMap},i.reflectivityMap.get=function(){return this._reflectivityMap},i.occlusionMap.get=function(){return this._occlusionMap},i.diffuseFresnel.get=function(){return this._diffuseFresnel},i.specularFresnel.get=function(){return this._specularFresnel},i.emissiveFresnel.get=function(){return this._emissiveFresnel},i.alphaFresnel.get=function(){return this._alphaFresnel},i.reflectivityFresnel.get=function(){return this._reflectivityFresnel},i.alphaMode.set=function(t){var e=ze[t=t||"opaque"];void 0===e&&(this.error("Unsupported value for 'alphaMode': "+t+" - defaulting to 'opaque'"),e="opaque"),this._state.alphaMode!==e&&(this._state.alphaMode=e,this.glRedraw())},i.alphaMode.get=function(){return Ue[this._state.alphaMode]},i.alphaCutoff.set=function(t){null==t&&(t=.5),this._state.alphaCutoff!==t&&(this._state.alphaCutoff=t)},i.alphaCutoff.get=function(){return this._state.alphaCutoff},i.backfaces.set=function(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())},i.backfaces.get=function(){return this._state.backfaces},i.frontface.set=function(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this.glRedraw())},i.frontface.get=function(){return this._state.frontface?"ccw":"cw"},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy()},Object.defineProperties(e.prototype,i),e}(Ve),Ge={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}},Xe=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0}),this._preset="default",i.preset?(this.preset=i.preset,void 0!==i.fill&&(this.fill=i.fill),i.fillColor&&(this.fillColor=i.fillColor),void 0!==i.fillAlpha&&(this.fillAlpha=i.fillAlpha),void 0!==i.edges&&(this.edges=i.edges),i.edgeColor&&(this.edgeColor=i.edgeColor),void 0!==i.edgeAlpha&&(this.edgeAlpha=i.edgeAlpha),void 0!==i.edgeWidth&&(this.edgeWidth=i.edgeWidth),void 0!==i.backfaces&&(this.backfaces=i.backfaces)):(this.fill=i.fill,this.fillColor=i.fillColor,this.fillAlpha=i.fillAlpha,this.edges=i.edges,this.edgeColor=i.edgeColor,this.edgeAlpha=i.edgeAlpha,this.edgeWidth=i.edgeWidth,this.backfaces=i.backfaces)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},presets:{configurable:!0},fill:{configurable:!0},fillColor:{configurable:!0},fillAlpha:{configurable:!0},edges:{configurable:!0},edgeColor:{configurable:!0},edgeAlpha:{configurable:!0},edgeWidth:{configurable:!0},backfaces:{configurable:!0},preset:{configurable:!0}};return i.type.get=function(){return"EmphasisMaterial"},i.presets.get=function(){return Ge},i.fill.set=function(t){t=!1!==t,this._state.fill!==t&&(this._state.fill=t,this.glRedraw())},i.fill.get=function(){return this._state.fill},i.fillColor.set=function(t){var e=this._state.fillColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.fillColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.4,e[1]=.4,e[2]=.4),this.glRedraw()},i.fillColor.get=function(){return this._state.fillColor},i.fillAlpha.set=function(t){t=null!=t?t:.2,this._state.fillAlpha!==t&&(this._state.fillAlpha=t,this.glRedraw())},i.fillAlpha.get=function(){return this._state.fillAlpha},i.edges.set=function(t){t=!1!==t,this._state.edges!==t&&(this._state.edges=t,this.glRedraw())},i.edges.get=function(){return this._state.edges},i.edgeColor.set=function(t){var e=this._state.edgeColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.edgeColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()},i.edgeColor.get=function(){return this._state.edgeColor},i.edgeAlpha.set=function(t){t=null!=t?t:.5,this._state.edgeAlpha!==t&&(this._state.edgeAlpha=t,this.glRedraw())},i.edgeAlpha.get=function(){return this._state.edgeAlpha},i.edgeWidth.set=function(t){this._state.edgeWidth=t||1,this.glRedraw()},i.edgeWidth.get=function(){return this._state.edgeWidth},i.backfaces.set=function(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())},i.backfaces.get=function(){return this._state.backfaces},i.preset.set=function(t){if(t=t||"default",this._preset!==t){var e=Ge[t];e?(this.fill=e.fill,this.fillColor=e.fillColor,this.fillAlpha=e.fillAlpha,this.edges=e.edges,this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(Ge).join(", "))}},i.preset.get=function(){return this._preset},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy()},Object.defineProperties(e.prototype,i),e}(Ve),We={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}},He=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({type:"EdgeMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",i.preset?(this.preset=i.preset,i.edgeColor&&(this.edgeColor=i.edgeColor),void 0!==i.edgeAlpha&&(this.edgeAlpha=i.edgeAlpha),void 0!==i.edgeWidth&&(this.edgeWidth=i.edgeWidth)):(this.edgeColor=i.edgeColor,this.edgeAlpha=i.edgeAlpha,this.edgeWidth=i.edgeWidth),this.edges=!1!==i.edges}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},presets:{configurable:!0},edges:{configurable:!0},edgeColor:{configurable:!0},edgeAlpha:{configurable:!0},edgeWidth:{configurable:!0},preset:{configurable:!0}};return i.type.get=function(){return"EdgeMaterial"},i.presets.get=function(){return We},i.edges.set=function(t){t=!1!==t,this._state.edges!==t&&(this._state.edges=t,this.glRedraw())},i.edges.get=function(){return this._state.edges},i.edgeColor.set=function(t){var e=this._state.edgeColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.edgeColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()},i.edgeColor.get=function(){return this._state.edgeColor},i.edgeAlpha.set=function(t){t=null!=t?t:1,this._state.edgeAlpha!==t&&(this._state.edgeAlpha=t,this.glRedraw())},i.edgeAlpha.get=function(){return this._state.edgeAlpha},i.edgeWidth.set=function(t){this._state.edgeWidth=t||1,this.glRedraw()},i.edgeWidth.get=function(){return this._state.edgeWidth},i.preset.set=function(t){if(t=t||"default",this._preset!==t){var e=We[t];e?(this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(We).join(", "))}},i.preset.get=function(){return this._preset},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy()},Object.defineProperties(e.prototype,i),e}(Ve),Ye={meters:{abbrev:"m"},metres:{abbrev:"m"},centimeters:{abbrev:"cm"},centimetres:{abbrev:"cm"},millimeters:{abbrev:"mm"},millimetres:{abbrev:"mm"},yards:{abbrev:"yd"},feet:{abbrev:"ft"},inches:{abbrev:"in"}},Ke=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._units="meters",this._scale=1,this._origin=E.vec3([0,0,0]),this.units=i.units,this.scale=i.scale,this.origin=i.origin}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={unitsInfo:{configurable:!0},units:{configurable:!0},scale:{configurable:!0},origin:{configurable:!0}};return i.unitsInfo.get=function(){return Ye},i.units.set=function(t){t||(t="meters"),Ye[t]||(this.error("Unsupported value for 'units': "+t+" defaulting to 'meters'"),t="meters"),this._units=t,this.fire("units",this._units)},i.units.get=function(){return this._units},i.scale.set=function(t){(t=t||1)<=0?this.error("scale value should be larger than zero"):(this._scale=t,this.fire("scale",this._scale))},i.scale.get=function(){return this._scale},i.origin.set=function(t){if(!t)return this._origin[0]=0,this._origin[1]=0,void(this._origin[2]=0);this._origin[0]=t[0],this._origin[1]=t[1],this._origin[2]=t[2],this.fire("origin",this._origin)},i.origin.get=function(){return this._origin},e.prototype.worldToRealPos=function(t,e){void 0===e&&(e=E.vec3(3)),e[0]=this._origin[0]+this._scale*t[0],e[1]=this._origin[1]+this._scale*t[1],e[2]=this._origin[2]+this._scale*t[2]},e.prototype.realToWorldPos=function(t,e){return void 0===e&&(e=E.vec3(3)),e[0]=(t[0]-this._origin[0])/this._scale,e[1]=(t[1]-this._origin[1])/this._scale,e[2]=(t[2]-this._origin[2])/this._scale,e},Object.defineProperties(e.prototype,i),e}(U),qe=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i);var r=navigator.userAgent.match(/(opera|chrome|safari|firefox|msie|mobile)\/?\s*(\.?\d+(\.\d+)*)/i),s=r&&"safari"===r[1].toLowerCase();this._supported=!s&&wt.SUPPORTED_EXTENSIONS.OES_standard_derivatives,this.enabled=i.enabled,this.kernelRadius=i.kernelRadius,this.intensity=i.intensity,this.bias=i.bias,this.scale=i.scale,this.minResolution=i.minResolution,this.numSamples=i.numSamples,this.blur=i.blur,this.blendCutoff=i.blendCutoff,this.blendFactor=i.blendFactor}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={supported:{configurable:!0},enabled:{configurable:!0},possible:{configurable:!0},active:{configurable:!0},kernelRadius:{configurable:!0},intensity:{configurable:!0},bias:{configurable:!0},scale:{configurable:!0},minResolution:{configurable:!0},numSamples:{configurable:!0},blur:{configurable:!0},blendCutoff:{configurable:!0},blendFactor:{configurable:!0}};return i.supported.get=function(){return this._supported},i.enabled.set=function(t){t=!!t,this._enabled!==t&&(this._enabled=t,this.glRedraw())},i.enabled.get=function(){return this._enabled},i.possible.get=function(){if(!this._supported)return!1;if(!this._enabled)return!1;var t=this.scene.camera.projection;return"customProjection"!==t&&"frustum"!==t},i.active.get=function(){return this._active},i.kernelRadius.set=function(t){null==t&&(t=100),this._kernelRadius!==t&&(this._kernelRadius=t,this.glRedraw())},i.kernelRadius.get=function(){return this._kernelRadius},i.intensity.set=function(t){null==t&&(t=.15),this._intensity!==t&&(this._intensity=t,this.glRedraw())},i.intensity.get=function(){return this._intensity},i.bias.set=function(t){null==t&&(t=.5),this._bias!==t&&(this._bias=t,this.glRedraw())},i.bias.get=function(){return this._bias},i.scale.set=function(t){null==t&&(t=1),this._scale!==t&&(this._scale=t,this.glRedraw())},i.scale.get=function(){return this._scale},i.minResolution.set=function(t){null==t&&(t=0),this._minResolution!==t&&(this._minResolution=t,this.glRedraw())},i.minResolution.get=function(){return this._minResolution},i.numSamples.set=function(t){null==t&&(t=10),this._numSamples!==t&&(this._numSamples=t,this.glRedraw())},i.numSamples.get=function(){return this._numSamples},i.blur.set=function(t){t=!1!==t,this._blur!==t&&(this._blur=t,this.glRedraw())},i.blur.get=function(){return this._blur},i.blendCutoff.set=function(t){null==t&&(t=.3),this._blendCutoff!==t&&(this._blendCutoff=t,this.glRedraw())},i.blendCutoff.get=function(){return this._blendCutoff},i.blendFactor.set=function(t){null==t&&(t=1),this._blendFactor!==t&&(this._blendFactor=t,this.glRedraw())},i.blendFactor.get=function(){return this._blendFactor},e.prototype.destroy=function(){t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(U),Ze={default:{pointSize:4,roundPoints:!0,perspectivePoints:!0},square:{pointSize:4,roundPoints:!1,perspectivePoints:!0},round:{pointSize:4,roundPoints:!0,perspectivePoints:!0}},Qe=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({type:"PointsMaterial",pointSize:null,roundPoints:null,perspectivePoints:null,minPerspectivePointSize:null,maxPerspectivePointSize:null,filterIntensity:null,minIntensity:null,maxIntensity:null}),i.preset?(this.preset=i.preset,void 0!==i.pointSize&&(this.pointSize=i.pointSize),void 0!==i.roundPoints&&(this.roundPoints=i.roundPoints),void 0!==i.perspectivePoints&&(this.perspectivePoints=i.perspectivePoints),void 0!==i.minPerspectivePointSize&&(this.minPerspectivePointSize=i.minPerspectivePointSize),void 0!==i.maxPerspectivePointSize&&(this.maxPerspectivePointSize=i.minPerspectivePointSize)):(this._preset="default",this.pointSize=i.pointSize,this.roundPoints=i.roundPoints,this.perspectivePoints=i.perspectivePoints,this.minPerspectivePointSize=i.minPerspectivePointSize,this.maxPerspectivePointSize=i.maxPerspectivePointSize),this.filterIntensity=i.filterIntensity,this.minIntensity=i.minIntensity,this.maxIntensity=i.maxIntensity}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},presets:{configurable:!0},pointSize:{configurable:!0},roundPoints:{configurable:!0},perspectivePoints:{configurable:!0},minPerspectivePointSize:{configurable:!0},maxPerspectivePointSize:{configurable:!0},filterIntensity:{configurable:!0},minIntensity:{configurable:!0},maxIntensity:{configurable:!0},preset:{configurable:!0},hash:{configurable:!0}};return i.type.get=function(){return"PointsMaterial"},i.presets.get=function(){return Ze},i.pointSize.set=function(t){this._state.pointSize=t||2,this.glRedraw()},i.pointSize.get=function(){return this._state.pointSize},i.roundPoints.set=function(t){t=!1!==t,this._state.roundPoints!==t&&(this._state.roundPoints=t,this.scene._needRecompile=!0,this.glRedraw())},i.roundPoints.get=function(){return this._state.roundPoints},i.perspectivePoints.set=function(t){t=!1!==t,this._state.perspectivePoints!==t&&(this._state.perspectivePoints=t,this.scene._needRecompile=!0,this.glRedraw())},i.perspectivePoints.get=function(){return this._state.perspectivePoints},i.minPerspectivePointSize.set=function(t){this._state.minPerspectivePointSize=t||1,this.scene._needRecompile=!0,this.glRedraw()},i.minPerspectivePointSize.get=function(){return this._state.minPerspectivePointSize},i.maxPerspectivePointSize.set=function(t){this._state.maxPerspectivePointSize=t||6,this.scene._needRecompile=!0,this.glRedraw()},i.maxPerspectivePointSize.get=function(){return this._state.maxPerspectivePointSize},i.filterIntensity.set=function(t){t=!1!==t,this._state.filterIntensity!==t&&(this._state.filterIntensity=t,this.scene._needRecompile=!0,this.glRedraw())},i.filterIntensity.get=function(){return this._state.filterIntensity},i.minIntensity.set=function(t){this._state.minIntensity=null!=t?t:0,this.glRedraw()},i.minIntensity.get=function(){return this._state.minIntensity},i.maxIntensity.set=function(t){this._state.maxIntensity=null!=t?t:1,this.glRedraw()},i.maxIntensity.get=function(){return this._state.maxIntensity},i.preset.set=function(t){if(t=t||"default",this._preset!==t){var e=Ze[t];e?(this.pointSize=e.pointSize,this.roundPoints=e.roundPoints,this.perspectivePoints=e.perspectivePoints,this.minPerspectivePointSize=e.minPerspectivePointSize,this.maxPerspectivePointSize=e.maxPerspectivePointSize,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(Ze).join(", "))}},i.preset.get=function(){return this._preset},i.hash.get=function(){return[this.pointSize,this.roundPoints,this.perspectivePoints,this.minPerspectivePointSize,this.maxPerspectivePointSize,this.filterIntensity].join(";")},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy()},Object.defineProperties(e.prototype,i),e}(Ve),Je={default:{lineWidth:1},thick:{lineWidth:2},thicker:{lineWidth:4}},$e=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({type:"LinesMaterial",lineWidth:null}),i.preset?(this.preset=i.preset,void 0!==i.lineWidth&&(this.lineWidth=i.lineWidth)):(this._preset="default",this.lineWidth=i.lineWidth)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},presets:{configurable:!0},lineWidth:{configurable:!0},preset:{configurable:!0},hash:{configurable:!0}};return i.type.get=function(){return"LinesMaterial"},i.presets.get=function(){return Je},i.lineWidth.set=function(t){this._state.lineWidth=t||1,this.glRedraw()},i.lineWidth.get=function(){return this._state.lineWidth},i.preset.set=function(t){if(t=t||"default",this._preset!==t){var e=Je[t];e?(this.lineWidth=e.lineWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(Je).join(", "))}},i.preset.get=function(){return this._preset},i.hash.get=function(){return[""+this.lineWidth].join(";")},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy()},Object.defineProperties(e.prototype,i),e}(Ve);function ti(t,e){for(var i,r,s={},o=0,a=e.length;o<a;o++)i=e[o],(r=t.component[i])?r.isEntity?s[i]=!0:t.warn("pick(): Component is not an Entity: "+i):t.warn("pick(): Component not found: "+i);return s}var ei=function(t){function e(e,i){var r=this;void 0===i&&(i={}),t.call(this,null,i);var s=i.canvasElement||document.getElementById(i.canvasId);if(!(s instanceof HTMLCanvasElement))throw"Mandatory config expected: valid canvasId or canvasElement";var o=!!i.transparent,a=!!i.alphaDepthMask;this._aabbDirty=!0,this.viewer=e,this.occlusionTestCountdown=0,this.loading=0,this.startTime=(new Date).getTime(),this.models={},this.objects={},this._numObjects=0,this.visibleObjects={},this._numVisibleObjects=0,this.xrayedObjects={},this._numXRayedObjects=0,this.highlightedObjects={},this._numHighlightedObjects=0,this.selectedObjects={},this._numSelectedObjects=0,this.colorizedObjects={},this._numColorizedObjects=0,this.opacityObjects={},this._numOpacityObjects=0,this.offsetObjects={},this._numOffsetObjects=0,this._modelIds=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this._opacityObjectIds=null,this._offsetObjectIds=null,this._collidables={},this._compilables={},this._needRecompile=!1,this.types={},this.components={},this.sectionPlanes={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.realWorldOffset=i.realWorldOffset||new Float64Array([0,0,0]),this.canvas=new St(this,{dontClear:!0,canvas:s,spinnerElementId:i.spinnerElementId,transparent:o,webgl2:!1!==i.webgl2,contextAttr:i.contextAttr||{},backgroundColor:i.backgroundColor,backgroundColorFromAmbientLight:i.backgroundColorFromAmbientLight,premultipliedAlpha:i.premultipliedAlpha}),this.canvas.on("boundary",(function(){r.glRedraw()})),this.canvas.on("webglContextFailed",(function(){alert("xeokit failed to find WebGL!")})),this._renderer=new ie(this,{transparent:o,alphaDepthMask:a}),this._sectionPlanesState=new function(){this.sectionPlanes=[],this.clippingCaps=!1;var t=null;this.getHash=function(){if(t)return t;var e=this.sectionPlanes;if(0===e.length)return this.hash=";";for(var i=[],r=0,s=e.length;r<s;r++)e[r],i.push("cp");return i.push(";"),t=i.join("")},this.addSectionPlane=function(e){this.sectionPlanes.push(e),t=null},this.removeSectionPlane=function(e){for(var i=0,r=this.sectionPlanes.length;i<r;i++)if(this.sectionPlanes[i].id===e.id)return this.sectionPlanes.splice(i,1),void(t=null)}},this._lightsState=new function(){var t=E.vec4([0,0,0,0]),e=E.vec4();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];var i=null,r=null;this.getHash=function(){if(i)return i;for(var t,e=[],r=this.lights,s=0,o=r.length;s<o;s++)t=r[s],e.push("/"),e.push(t.type),e.push("world"===t.space?"w":"v"),t.castsShadow&&e.push("sh");return this.lightMaps.length>0&&e.push("/lm"),this.reflectionMaps.length>0&&e.push("/rm"),e.push(";"),i=e.join("")},this.addLight=function(t){this.lights.push(t),r=null,i=null},this.removeLight=function(t){for(var e=0,s=this.lights.length;e<s;e++){if(this.lights[e].id===t.id)return this.lights.splice(e,1),r&&r.id===t.id&&(r=null),void(i=null)}},this.addReflectionMap=function(t){this.reflectionMaps.push(t),i=null},this.removeReflectionMap=function(t){for(var e=0,r=this.reflectionMaps.length;e<r;e++)if(this.reflectionMaps[e].id===t.id)return this.reflectionMaps.splice(e,1),void(i=null)},this.addLightMap=function(t){this.lightMaps.push(t),i=null},this.removeLightMap=function(t){for(var e=0,r=this.lightMaps.length;e<r;e++)if(this.lightMaps[e].id===t.id)return this.lightMaps.splice(e,1),void(i=null)},this.getAmbientColorAndIntensity=function(){if(!r)for(var i=0,s=this.lights.length;i<s;i++){var o=this.lights[i];if("ambient"===o.type){r=o;break}}if(r){var a=r.color,n=r.intensity;return e[0]=a[0],e[1]=a[1],e[2]=a[2],e[3]=n,e}return t}},this.input=new re(this,{dontClear:!0,element:this.canvas.canvas}),this.metrics=new Ke(this,{units:i.units,scale:i.scale,origin:i.origin}),this.sao=new qe(this,{enabled:i.saoEnabled}),this.ticksPerRender=i.ticksPerRender,this.ticksPerOcclusionTest=i.ticksPerOcclusionTest,this.passes=i.passes,this.clearEachPass=i.clearEachPass,this.gammaInput=i.gammaInput,this.gammaOutput=i.gammaOutput,this.gammaFactor=i.gammaFactor,this._entityOffsetsEnabled=!!i.entityOffsetsEnabled,this._pickSurfacePrecisionEnabled=!!i.pickSurfacePrecisionEnabled,this._logarithmicDepthBufferEnabled=!!i.logarithmicDepthBufferEnabled,this._pbrEnabled=!!i.pbrEnabled,V._addScene(this),this._initDefaults(),this._viewport=new ae(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new xe(this,{id:"default.camera",dontClear:!0}),new Ce(this,{color:[1,1,1],intensity:.7}),new Ee(this,{dir:[.8,-.5,-.5],color:[.67,.67,1],intensity:.7,space:"world"}),new Ee(this,{dir:[-.8,-1,.5],color:[1,1,.9],intensity:.9,space:"world"}),this._camera.on("dirty",(function(){r._renderer.imageDirty()}))}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},entityOffsetsEnabled:{configurable:!0},pickSurfacePrecisionEnabled:{configurable:!0},logarithmicDepthBufferEnabled:{configurable:!0},pbrEnabled:{configurable:!0},modelIds:{configurable:!0},numObjects:{configurable:!0},objectIds:{configurable:!0},numVisibleObjects:{configurable:!0},visibleObjectIds:{configurable:!0},numXRayedObjects:{configurable:!0},xrayedObjectIds:{configurable:!0},numHighlightedObjects:{configurable:!0},highlightedObjectIds:{configurable:!0},numSelectedObjects:{configurable:!0},selectedObjectIds:{configurable:!0},numColorizedObjects:{configurable:!0},colorizedObjectIds:{configurable:!0},opacityObjectIds:{configurable:!0},offsetObjectIds:{configurable:!0},ticksPerRender:{configurable:!0},ticksPerOcclusionTest:{configurable:!0},passes:{configurable:!0},clearEachPass:{configurable:!0},gammaInput:{configurable:!0},gammaOutput:{configurable:!0},gammaFactor:{configurable:!0},geometry:{configurable:!0},material:{configurable:!0},xrayMaterial:{configurable:!0},highlightMaterial:{configurable:!0},selectedMaterial:{configurable:!0},edgeMaterial:{configurable:!0},pointsMaterial:{configurable:!0},linesMaterial:{configurable:!0},viewport:{configurable:!0},camera:{configurable:!0},center:{configurable:!0},aabb:{configurable:!0}};return i.type.get=function(){return"Scene"},e.prototype._initDefaults=function(){this.geometry,this.material,this.xrayMaterial,this.edgeMaterial,this.selectedMaterial,this.highlightMaterial},e.prototype._addComponent=function(t){if(t.id&&this.components[t.id]&&(this.error("Component "+B.inQuotes(t.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),t.id=null),!t.id)for(void 0===window.nextID&&(window.nextID=0),t.id="__"+window.nextID++;this.components[t.id];)t.id=E.createUUID();this.components[t.id]=t;var e=t.type,i=this.types[t.type];i||(i=this.types[e]={}),i[t.id]=t,t.compile&&(this._compilables[t.id]=t),t.isDrawable&&(this._renderer.addDrawable(t.id,t),this._collidables[t.id]=t)},e.prototype._removeComponent=function(t){var e=t.id,i=t.type;delete this.components[e];var r=this.types[i];r&&(delete r[e],B.isEmptyObject(r)&&delete this.types[i]),t.compile&&delete this._compilables[t.id],t.isDrawable&&(this._renderer.removeDrawable(t.id),delete this._collidables[t.id])},e.prototype._sectionPlaneCreated=function(t){this.sectionPlanes[t.id]=t,this.scene._sectionPlanesState.addSectionPlane(t._state),this.scene.fire("sectionPlaneCreated",t,!0),this._needRecompile=!0},e.prototype._lightCreated=function(t){this.lights[t.id]=t,this.scene._lightsState.addLight(t._state),this._needRecompile=!0},e.prototype._lightMapCreated=function(t){this.lightMaps[t.id]=t,this.scene._lightsState.addLightMap(t._state),this._needRecompile=!0},e.prototype._reflectionMapCreated=function(t){this.reflectionMaps[t.id]=t,this.scene._lightsState.addReflectionMap(t._state),this._needRecompile=!0},e.prototype._sectionPlaneDestroyed=function(t){delete this.sectionPlanes[t.id],this.scene._sectionPlanesState.removeSectionPlane(t._state),this.scene.fire("sectionPlaneDestroyed",t,!0),this._needRecompile=!0},e.prototype._lightDestroyed=function(t){delete this.lights[t.id],this.scene._lightsState.removeLight(t._state),this._needRecompile=!0},e.prototype._lightMapDestroyed=function(t){delete this.lightMaps[t.id],this.scene._lightsState.removeLightMap(t._state),this._needRecompile=!0},e.prototype._reflectionMapDestroyed=function(t){delete this.reflectionMaps[t.id],this.scene._lightsState.removeReflectionMap(t._state),this._needRecompile=!0},e.prototype._registerModel=function(t){this.models[t.id]=t,this._modelIds=null},e.prototype._deregisterModel=function(t){delete this.models[t.id],this._modelIds=null},e.prototype._registerObject=function(t){this.objects[t.id]=t,this._numObjects++,this._objectIds=null},e.prototype._deregisterObject=function(t){delete this.objects[t.id],this._numObjects--,this._objectIds=null},e.prototype._objectVisibilityUpdated=function(t,e){void 0===e&&(e=!0),t.visible?(this.visibleObjects[t.id]=t,this._numVisibleObjects++):(delete this.visibleObjects[t.id],this._numVisibleObjects--),this._visibleObjectIds=null,e&&this.fire("objectVisibility",t,!0)},e.prototype._objectXRayedUpdated=function(t){t.xrayed?(this.xrayedObjects[t.id]=t,this._numXRayedObjects++):(delete this.xrayedObjects[t.id],this._numXRayedObjects--),this._xrayedObjectIds=null},e.prototype._objectHighlightedUpdated=function(t){t.highlighted?(this.highlightedObjects[t.id]=t,this._numHighlightedObjects++):(delete this.highlightedObjects[t.id],this._numHighlightedObjects--),this._highlightedObjectIds=null},e.prototype._objectSelectedUpdated=function(t){t.selected?(this.selectedObjects[t.id]=t,this._numSelectedObjects++):(delete this.selectedObjects[t.id],this._numSelectedObjects--),this._selectedObjectIds=null},e.prototype._objectColorizeUpdated=function(t,e){e?(this.colorizedObjects[t.id]=t,this._numColorizedObjects++):(delete this.colorizedObjects[t.id],this._numColorizedObjects--),this._colorizedObjectIds=null},e.prototype._objectOpacityUpdated=function(t,e){e?(this.opacityObjects[t.id]=t,this._numOpacityObjects++):(delete this.opacityObjects[t.id],this._numOpacityObjects--),this._opacityObjectIds=null},e.prototype._objectOffsetUpdated=function(t,e){!e||0===e[0]&&0===e[1]&&0===e[2]?(this.offsetObjects[t.id]=t,this._numOffsetObjects++):(delete this.offsetObjects[t.id],this._numOffsetObjects--),this._offsetObjectIds=null},e.prototype._webglContextLost=function(){for(var t in this.canvas.spinner.processes++,this.components)if(this.components.hasOwnProperty(t)){var e=this.components[t];e._webglContextLost&&e._webglContextLost()}this._renderer.webglContextLost()},e.prototype._webglContextRestored=function(){var t=this.canvas.gl;for(var e in this.components)if(this.components.hasOwnProperty(e)){var i=this.components[e];i._webglContextRestored&&i._webglContextRestored(t)}this._renderer.webglContextRestored(t),this.canvas.spinner.processes--},i.entityOffsetsEnabled.get=function(){return this._entityOffsetsEnabled},i.pickSurfacePrecisionEnabled.get=function(){return this._pickSurfacePrecisionEnabled},i.logarithmicDepthBufferEnabled.get=function(){return this._logarithmicDepthBufferEnabled},i.pbrEnabled.set=function(t){this._pbrEnabled=!!t,this.glRedraw()},i.pbrEnabled.get=function(){return this._pbrEnabled},e.prototype.doOcclusionTest=function(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()},e.prototype.render=function(t){t&&V.runTasks();var e={sceneId:null,pass:0};this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),e.sceneId=this.id;var i,r,s=this._passes,o=this._clearEachPass;for(i=0;i<s;i++)e.pass=i,this.fire("rendering",e,!0),r=o||0===i,this._renderer.render({pass:i,clear:r,force:t}),this.fire("rendered",e,!0);this._saveAmbientColor()},e.prototype._recompile=function(){for(var t in this._compilables)this._compilables.hasOwnProperty(t)&&this._compilables[t].compile();this._renderer.shadowsDirty(),this.fire("compile",this,!0)},e.prototype._saveAmbientColor=function(){var t=this.canvas;if(t.transparent||t.backgroundImage||t.backgroundColor)this._lastAmbientColor=null;else{var e=this._lightsState.getAmbientColorAndIntensity();this._lastAmbientColor&&this._lastAmbientColor[0]===e[0]&&this._lastAmbientColor[1]===e[1]&&this._lastAmbientColor[2]===e[2]&&this._lastAmbientColor[3]===e[3]||(t.backgroundColor=e,this._lastAmbientColor||(this._lastAmbientColor=E.vec4([0,0,0,1])),this._lastAmbientColor.set(e))}},i.modelIds.get=function(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds},i.numObjects.get=function(){return this._numObjects},i.objectIds.get=function(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds},i.numVisibleObjects.get=function(){return this._numVisibleObjects},i.visibleObjectIds.get=function(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds},i.numXRayedObjects.get=function(){return this._numXRayedObjects},i.xrayedObjectIds.get=function(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds},i.numHighlightedObjects.get=function(){return this._numHighlightedObjects},i.highlightedObjectIds.get=function(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds},i.numSelectedObjects.get=function(){return this._numSelectedObjects},i.selectedObjectIds.get=function(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds},i.numColorizedObjects.get=function(){return this._numColorizedObjects},i.colorizedObjectIds.get=function(){return this._colorizedObjectIds||(this._colorizedObjectIds=Object.keys(this.colorizedObjects)),this._colorizedObjectIds},i.opacityObjectIds.get=function(){return this._opacityObjectIds||(this._opacityObjectIds=Object.keys(this.opacityObjects)),this._opacityObjectIds},i.offsetObjectIds.get=function(){return this._offsetObjectIds||(this._offsetObjectIds=Object.keys(this.offsetObjects)),this._offsetObjectIds},i.ticksPerRender.set=function(t){null==t?t=1:(!B.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+t+"' - should be an integer greater than zero."),t=1),t!==this._ticksPerRender&&(this._ticksPerRender=t)},i.ticksPerRender.get=function(){return this._ticksPerRender},i.ticksPerOcclusionTest.set=function(t){null==t?t=20:(!B.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+t+"' - should be an integer greater than zero."),t=20),t!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=t)},i.ticksPerOcclusionTest.get=function(){return this._ticksPerOcclusionTest},i.passes.set=function(t){null==t?t=1:(!B.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'passes': '"+t+"' - should be an integer greater than zero."),t=1),t!==this._passes&&(this._passes=t,this.glRedraw())},i.passes.get=function(){return this._passes},i.clearEachPass.set=function(t){(t=!!t)!==this._clearEachPass&&(this._clearEachPass=t,this.glRedraw())},i.clearEachPass.get=function(){return this._clearEachPass},i.gammaInput.set=function(t){(t=!1!==t)!==this._renderer.gammaInput&&(this._renderer.gammaInput=t,this._needRecompile=!0,this.glRedraw())},i.gammaInput.get=function(){return this._renderer.gammaInput},i.gammaOutput.set=function(t){(t=!!t)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=t,this._needRecompile=!0,this.glRedraw())},i.gammaOutput.get=function(){return this._renderer.gammaOutput},i.gammaFactor.set=function(t){(t=null==t?2.2:t)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=t,this.glRedraw())},i.gammaFactor.get=function(){return this._renderer.gammaFactor},i.geometry.get=function(){return this.components["default.geometry"]||Oe(ke)},i.material.get=function(){return this.components["default.material"]||new je(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})},i.xrayMaterial.get=function(){return this.components["default.xrayMaterial"]||new Xe(this,{id:"default.xrayMaterial",preset:"sepia",dontClear:!0})},i.highlightMaterial.get=function(){return this.components["default.highlightMaterial"]||new Xe(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})},i.selectedMaterial.get=function(){return this.components["default.selectedMaterial"]||new Xe(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})},i.edgeMaterial.get=function(){return this.components["default.edgeMaterial"]||new He(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})},i.pointsMaterial.get=function(){return this.components["default.pointsMaterial"]||new Qe(this,{id:"default.pointsMaterial",preset:"default",dontClear:!0})},i.linesMaterial.get=function(){return this.components["default.linesMaterial"]||new $e(this,{id:"default.linesMaterial",preset:"default",dontClear:!0})},i.viewport.get=function(){return this._viewport},i.camera.get=function(){return this._camera},i.center.get=function(){if(this._aabbDirty||!this._center){this._center&&this._center||(this._center=E.vec3());var t=this.aabb;this._center[0]=(t[0]+t[3])/2,this._center[1]=(t[1]+t[4])/2,this._center[2]=(t[2]+t[5])/2}return this._center},i.aabb.get=function(){if(this._aabbDirty){this._aabb||(this._aabb=E.AABB3());var t,e,i=E.MAX_DOUBLE,r=E.MAX_DOUBLE,s=E.MAX_DOUBLE,o=E.MIN_DOUBLE,a=E.MIN_DOUBLE,n=E.MIN_DOUBLE,l=this._collidables,h=!1;for(var u in l)if(l.hasOwnProperty(u)){if(!1===(e=l[u]).collidable)continue;(t=e.aabb)[0]<i&&(i=t[0]),t[1]<r&&(r=t[1]),t[2]<s&&(s=t[2]),t[3]>o&&(o=t[3]),t[4]>a&&(a=t[4]),t[5]>n&&(n=t[5]),h=!0}h||(i=-100,r=-100,s=-100,o=100,a=100,n=100),this._aabb[0]=i,this._aabb[1]=r,this._aabb[2]=s,this._aabb[3]=o,this._aabb[4]=a,this._aabb[5]=n,this._aabbDirty=!1}return this._aabb},e.prototype._setAABBDirty=function(){this._aabbDirty=!0,this.fire("boundary")},e.prototype.pick=function(t,e){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(t=t||{}).pickSurface=t.pickSurface||t.rayPick,t.canvasPos||t.matrix||t.origin&&t.direction||this.warn("picking without canvasPos, matrix, or ray origin and direction");var i=t.includeEntities||t.include;i&&(t.includeEntityIds=ti(this,i));var r=t.excludeEntities||t.exclude;return r&&(t.excludeEntityIds=ti(this,r)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),(e=this._renderer.pick(t,e))?(e.entity&&e.entity.fire&&e.entity.fire("picked",e),e):void 0},e.prototype.clear=function(){var t;for(var e in this.components)this.components.hasOwnProperty(e)&&((t=this.components[e])._dontClear||t.destroy())},e.prototype.clearLights=function(){for(var t=Object.keys(this.lights),e=0,i=t.length;e<i;e++)this.lights[t[e]].destroy()},e.prototype.clearSectionPlanes=function(){for(var t=Object.keys(this.sectionPlanes),e=0,i=t.length;e<i;e++)this.sectionPlanes[t[e]].destroy()},e.prototype.getAABB=function(t){if(void 0===t)return this.aabb;if(B.isString(t)){var e=this.objects[t];if(e&&e.aabb)return e.aabb;t=[t]}if(0===t.length)return this.aabb;var i,r=E.MAX_DOUBLE,s=E.MAX_DOUBLE,o=E.MAX_DOUBLE,a=E.MIN_DOUBLE,n=E.MIN_DOUBLE,l=E.MIN_DOUBLE;if(this.withObjects(t,(function(t){if(t.collidable){var e=t.aabb;e[0]<r&&(r=e[0]),e[1]<s&&(s=e[1]),e[2]<o&&(o=e[2]),e[3]>a&&(a=e[3]),e[4]>n&&(n=e[4]),e[5]>l&&(l=e[5]),i=!0}})),i){var h=E.AABB3();return h[0]=r,h[1]=s,h[2]=o,h[3]=a,h[4]=n,h[5]=l,h}return this.aabb},e.prototype.setObjectsVisible=function(t,e){return this.withObjects(t,(function(t){var i=t.visible!==e;return t.visible=e,i}))},e.prototype.setObjectsCollidable=function(t,e){return this.withObjects(t,(function(t){var i=t.collidable!==e;return t.collidable=e,i}))},e.prototype.setObjectsCulled=function(t,e){return this.withObjects(t,this.objects,(function(t){var i=t.culled!==e;return t.culled=e,i}))},e.prototype.setObjectsSelected=function(t,e){return this.withObjects(t,(function(t){var i=t.selected!==e;return t.selected=e,i}))},e.prototype.setObjectsHighlighted=function(t,e){return this.withObjects(t,(function(t){var i=t.highlighted!==e;return t.highlighted=e,i}))},e.prototype.setObjectsXRayed=function(t,e){return this.withObjects(t,(function(t){var i=t.xrayed!==e;return t.xrayed=e,i}))},e.prototype.setObjectsEdges=function(t,e){return this.withObjects(t,(function(t){var i=t.edges!==e;return t.edges=e,i}))},e.prototype.setObjectsColorized=function(t,e){return this.withObjects(t,(function(t){t.colorize=e}))},e.prototype.setObjectsOpacity=function(t,e){return this.withObjects(t,(function(t){var i=t.opacity!==e;return t.opacity=e,i}))},e.prototype.setObjectsPickable=function(t,e){return this.withObjects(t,(function(t){var i=t.pickable!==e;return t.pickable=e,i}))},e.prototype.setObjectsOffset=function(t,e){this.withObjects(t,(function(t){t.offset=e}))},e.prototype.withObjects=function(t,e){B.isString(t)&&(t=[t]);for(var i=!1,r=0,s=t.length;r<s;r++){var o=t[r],a=this.objects[o];if(a)i=e(a)||i;else for(var n=this.modelIds,l=0,h=n.length;l<h;l++){var u=n[l],c=E.globalizeObjectId(u,o);(a=this.objects[c])&&(i=e(a)||i)}}return i},e.prototype.destroy=function(){for(var e in t.prototype.destroy.call(this),this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.colorizedObjects=null,this.opacityObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null},Object.defineProperties(e.prototype,i),e}(U),ii=function(t){"LambertMaterial"===t._material._state.type?(this.vertex=function(t){var e=t.scene,i=t.scene._sectionPlanesState,r=t.scene._lightsState,s=t._geometry._state,o=t._state.billboard,a=t._state.stationary,n=i.sectionPlanes.length>0,l=!!s.compressGeometry,h=[];h.push("// Lambertian drawing vertex shader"),e.logarithmicDepthBufferEnabled&&h.push("#extension GL_EXT_frag_depth : enable");h.push("attribute vec3 position;"),h.push("uniform mat4 modelMatrix;"),h.push("uniform mat4 viewMatrix;"),h.push("uniform mat4 projMatrix;"),h.push("uniform vec4 colorize;"),h.push("uniform vec3 offset;"),l&&h.push("uniform mat4 positionsDecodeMatrix;");e.logarithmicDepthBufferEnabled&&(h.push("uniform float logDepthBufFC;"),h.push("varying float vFragDepth;"));n&&h.push("varying vec4 vWorldPosition;");if(h.push("uniform vec4 lightAmbient;"),h.push("uniform vec4 materialColor;"),h.push("uniform vec3 materialEmissive;"),s.normalsBuf){h.push("attribute vec3 normal;"),h.push("uniform mat4 modelNormalMatrix;"),h.push("uniform mat4 viewNormalMatrix;");for(var u=0,c=r.lights.length;u<c;u++){var p=r.lights[u];"ambient"!==p.type&&(h.push("uniform vec4 lightColor"+u+";"),"dir"===p.type&&h.push("uniform vec3 lightDir"+u+";"),"point"===p.type&&h.push("uniform vec3 lightPos"+u+";"),"spot"===p.type&&(h.push("uniform vec3 lightPos"+u+";"),h.push("uniform vec3 lightDir"+u+";")))}l&&(h.push("vec3 octDecode(vec2 oct) {"),h.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),h.push("    if (v.z < 0.0) {"),h.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),h.push("    }"),h.push("    return normalize(v);"),h.push("}"))}h.push("varying vec4 vColor;"),"points"===s.primitiveName&&h.push("uniform float pointSize;");"spherical"!==o&&"cylindrical"!==o||(h.push("void billboard(inout mat4 mat) {"),h.push("   mat[0][0] = 1.0;"),h.push("   mat[0][1] = 0.0;"),h.push("   mat[0][2] = 0.0;"),"spherical"===o&&(h.push("   mat[1][0] = 0.0;"),h.push("   mat[1][1] = 1.0;"),h.push("   mat[1][2] = 0.0;")),h.push("   mat[2][0] = 0.0;"),h.push("   mat[2][1] = 0.0;"),h.push("   mat[2][2] =1.0;"),h.push("}"));h.push("void main(void) {"),h.push("vec4 localPosition = vec4(position, 1.0); "),h.push("vec4 worldPosition;"),l&&h.push("localPosition = positionsDecodeMatrix * localPosition;");s.normalsBuf&&(l?h.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):h.push("vec4 localNormal = vec4(normal, 0.0); "),h.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),h.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));h.push("mat4 viewMatrix2 = viewMatrix;"),h.push("mat4 modelMatrix2 = modelMatrix;"),a&&h.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===o||"cylindrical"===o?(h.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),h.push("billboard(modelMatrix2);"),h.push("billboard(viewMatrix2);"),h.push("billboard(modelViewMatrix);"),s.normalsBuf&&(h.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),h.push("billboard(modelNormalMatrix2);"),h.push("billboard(viewNormalMatrix2);"),h.push("billboard(modelViewNormalMatrix);")),h.push("worldPosition = modelMatrix2 * localPosition;"),h.push("worldPosition.xyz = worldPosition.xyz + offset;"),h.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(h.push("worldPosition = modelMatrix2 * localPosition;"),h.push("worldPosition.xyz = worldPosition.xyz + offset;"),h.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));s.normalsBuf&&h.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(h.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),h.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),h.push("float lambertian = 1.0;"),s.normalsBuf)for(var d=0,f=r.lights.length;d<f;d++){var _=r.lights[d];if("ambient"!==_.type){if("dir"===_.type)"view"===_.space?h.push("viewLightDir = normalize(lightDir"+d+");"):h.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+d+", 0.0)).xyz);");else if("point"===_.type)"view"===_.space?h.push("viewLightDir = -normalize(lightPos"+d+" - viewPosition.xyz);"):h.push("viewLightDir = -normalize((viewMatrix2 * vec4(lightPos"+d+", 0.0)).xyz);");else{if("spot"!==_.type)continue;"view"===_.space?h.push("viewLightDir = normalize(lightDir"+d+");"):h.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+d+", 0.0)).xyz);")}h.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),h.push("reflectedColor += lambertian * (lightColor"+d+".rgb * lightColor"+d+".a);")}}h.push("vColor = vec4((lightAmbient.rgb * lightAmbient.a * materialColor.rgb) + materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),n&&h.push("vWorldPosition = worldPosition;");"points"===s.primitiveName&&h.push("gl_PointSize = pointSize;");h.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&h.push("vFragDepth = 1.0 + clipPos.w;");return h.push("gl_Position = clipPos;"),h.push("}"),h}(t),this.fragment=function(t){var e=t.scene,i=e._sectionPlanesState;t._material._state;var r=t._geometry._state,s=i.sectionPlanes.length>0,o=e.gammaOutput,a=[];a.push("// Lambertian drawing fragment shader"),e.logarithmicDepthBufferEnabled&&a.push("#extension GL_EXT_frag_depth : enable");a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;"));if(s){a.push("varying vec4 vWorldPosition;"),a.push("uniform bool clippable;");for(var n=0,l=i.sectionPlanes.length;n<l;n++)a.push("uniform bool sectionPlaneActive"+n+";"),a.push("uniform vec3 sectionPlanePos"+n+";"),a.push("uniform vec3 sectionPlaneDir"+n+";")}a.push("varying vec4 vColor;"),o&&(a.push("uniform float gammaFactor;"),a.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}"));if(a.push("void main(void) {"),s){a.push("if (clippable) {"),a.push("  float dist = 0.0;");for(var h=0,u=i.sectionPlanes.length;h<u;h++)a.push("if (sectionPlaneActive"+h+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+h+".xyz, vWorldPosition.xyz - sectionPlanePos"+h+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}"points"===r.primitiveName&&(a.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),a.push("float r = dot(cxy, cxy);"),a.push("if (r > 1.0) {"),a.push("   discard;"),a.push("}"));e.logarithmicDepthBufferEnabled&&a.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");o?a.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):a.push("gl_FragColor = vColor;");return a.push("}"),a}(t)):(this.vertex=function(t){var e,i=t.scene,r=t._material,s=t._state,o=i._sectionPlanesState,a=t._geometry._state,n=i._lightsState,l=s.billboard,h=s.stationary,u=function(t){if(!t._geometry._state.uvBuf)return!1;var e=t._material;return!!(e._ambientMap||e._occlusionMap||e._baseColorMap||e._diffuseMap||e._alphaMap||e._specularMap||e._glossinessMap||e._specularGlossinessMap||e._emissiveMap||e._metallicMap||e._roughnessMap||e._metallicRoughnessMap||e._reflectivityMap||e._normalMap)}(t),c=oi(t),p=o.sectionPlanes.length>0,d=si(t),f=!!a.compressGeometry,_=[];_.push("// Drawing vertex shader"),c&&r._normalMap&&_.push("#extension GL_OES_standard_derivatives : enable");i.logarithmicDepthBufferEnabled&&_.push("#extension GL_EXT_frag_depth : enable");_.push("attribute  vec3 position;"),f&&_.push("uniform mat4 positionsDecodeMatrix;");_.push("uniform  mat4 modelMatrix;"),_.push("uniform  mat4 viewMatrix;"),_.push("uniform  mat4 projMatrix;"),_.push("varying  vec3 vViewPosition;"),_.push("uniform  vec3 offset;"),p&&_.push("varying vec4 vWorldPosition;");i.logarithmicDepthBufferEnabled&&(_.push("uniform float logDepthBufFC;"),_.push("varying float vFragDepth;"));n.lightMaps.length>0&&_.push("varying    vec3 vWorldNormal;");if(c){_.push("attribute  vec3 normal;"),_.push("uniform    mat4 modelNormalMatrix;"),_.push("uniform    mat4 viewNormalMatrix;"),_.push("varying    vec3 vViewNormal;");for(var g=0,m=n.lights.length;g<m;g++)"ambient"!==(e=n.lights[g]).type&&("dir"===e.type&&_.push("uniform vec3 lightDir"+g+";"),"point"===e.type&&_.push("uniform vec3 lightPos"+g+";"),"spot"===e.type&&(_.push("uniform vec3 lightPos"+g+";"),_.push("uniform vec3 lightDir"+g+";")),"dir"===e.type&&"view"===e.space||_.push("varying vec4 vViewLightReverseDirAndDist"+g+";"));f&&(_.push("vec3 octDecode(vec2 oct) {"),_.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),_.push("    if (v.z < 0.0) {"),_.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),_.push("    }"),_.push("    return normalize(v);"),_.push("}"))}u&&(_.push("attribute vec2 uv;"),_.push("varying vec2 vUV;"),f&&_.push("uniform mat3 uvDecodeMatrix;"));a.colors&&(_.push("attribute vec4 color;"),_.push("varying vec4 vColor;"));"points"===a.primitiveName&&_.push("uniform float pointSize;");"spherical"!==l&&"cylindrical"!==l||(_.push("void billboard(inout mat4 mat) {"),_.push("   mat[0][0] = 1.0;"),_.push("   mat[0][1] = 0.0;"),_.push("   mat[0][2] = 0.0;"),"spherical"===l&&(_.push("   mat[1][0] = 0.0;"),_.push("   mat[1][1] = 1.0;"),_.push("   mat[1][2] = 0.0;")),_.push("   mat[2][0] = 0.0;"),_.push("   mat[2][1] = 0.0;"),_.push("   mat[2][2] =1.0;"),_.push("}"));if(d){_.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");for(var v=0,b=n.lights.length;v<b;v++)n.lights[v].castsShadow&&(_.push("uniform mat4 shadowViewMatrix"+v+";"),_.push("uniform mat4 shadowProjMatrix"+v+";"),_.push("varying vec4 vShadowPosFromLight"+v+";"))}_.push("void main(void) {"),_.push("vec4 localPosition = vec4(position, 1.0); "),_.push("vec4 worldPosition;"),f&&_.push("localPosition = positionsDecodeMatrix * localPosition;");c&&(f?_.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):_.push("vec4 localNormal = vec4(normal, 0.0); "),_.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),_.push("mat4 viewNormalMatrix2     = viewNormalMatrix;"));_.push("mat4 viewMatrix2           = viewMatrix;"),_.push("mat4 modelMatrix2          = modelMatrix;"),h&&_.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===l||"cylindrical"===l?(_.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),_.push("billboard(modelMatrix2);"),_.push("billboard(viewMatrix2);"),_.push("billboard(modelViewMatrix);"),c&&(_.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),_.push("billboard(modelNormalMatrix2);"),_.push("billboard(viewNormalMatrix2);"),_.push("billboard(modelViewNormalMatrix);")),_.push("worldPosition = modelMatrix2 * localPosition;"),_.push("worldPosition.xyz = worldPosition.xyz + offset;"),_.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(_.push("worldPosition = modelMatrix2 * localPosition;"),_.push("worldPosition.xyz = worldPosition.xyz + offset;"),_.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));if(c){_.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),n.lightMaps.length>0&&_.push("vWorldNormal = worldNormal;"),_.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),_.push("vec3 tmpVec3;"),_.push("float lightDist;");for(var y=0,P=n.lights.length;y<P;y++)"ambient"!==(e=n.lights[y]).type&&("dir"===e.type&&"world"===e.space&&(_.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+y+", 0.0) ).xyz;"),_.push("vViewLightReverseDirAndDist"+y+" = vec4(-tmpVec3, 0.0);")),"point"===e.type&&("world"===e.space?(_.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+y+", 1.0)).xyz - viewPosition.xyz;"),_.push("lightDist = abs(length(tmpVec3));")):(_.push("tmpVec3 = lightPos"+y+".xyz - viewPosition.xyz;"),_.push("lightDist = abs(length(tmpVec3));")),_.push("vViewLightReverseDirAndDist"+y+" = vec4(tmpVec3, lightDist);")))}u&&(f?_.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):_.push("vUV = uv;"));a.colors&&_.push("vColor = color;");"points"===a.primitiveName&&_.push("gl_PointSize = pointSize;");p&&_.push("vWorldPosition = worldPosition;");_.push("   vViewPosition = viewPosition.xyz;"),_.push("vec4 clipPos = projMatrix * viewPosition;"),i.logarithmicDepthBufferEnabled&&_.push("vFragDepth = 1.0 + clipPos.w;");if(_.push("gl_Position = clipPos;"),d){_.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),_.push("vec4 tempx; ");for(var M=0,x=n.lights.length;M<x;M++)n.lights[M].castsShadow&&_.push("vShadowPosFromLight"+M+" = texUnitConverter * shadowProjMatrix"+M+" * (shadowViewMatrix"+M+" * worldPosition); ")}return _.push("}"),_}(t),this.fragment=function(t){var e=t.scene;e.canvas.gl;var i=t._material,r=t._geometry._state,s=t.scene._sectionPlanesState,o=t.scene._lightsState,a=t._material._state,n=s.sectionPlanes.length>0,l=oi(t),h=r.uvBuf,u="PhongMaterial"===a.type,c="MetallicMaterial"===a.type,p="SpecularMaterial"===a.type,d=si(t);e.gammaInput;var f=e.gammaOutput,_=[];_.push("// Drawing fragment shader"),e.logarithmicDepthBufferEnabled&&_.push("#extension GL_EXT_frag_depth : enable");l&&i._normalMap&&_.push("#extension GL_OES_standard_derivatives : enable");_.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),_.push("precision highp float;"),_.push("precision highp int;"),_.push("#else"),_.push("precision mediump float;"),_.push("precision mediump int;"),_.push("#endif"),e.logarithmicDepthBufferEnabled&&(_.push("uniform float logDepthBufFC;"),_.push("varying float vFragDepth;"));d&&(_.push("float unpackDepth (vec4 color) {"),_.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),_.push("  return dot(color, bitShift);"),_.push("}"));_.push("uniform float gammaFactor;"),_.push("vec4 linearToLinear( in vec4 value ) {"),_.push("  return value;"),_.push("}"),_.push("vec4 sRGBToLinear( in vec4 value ) {"),_.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),_.push("}"),_.push("vec4 gammaToLinear( in vec4 value) {"),_.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),_.push("}"),f&&(_.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),_.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),_.push("}"));if(n){_.push("varying vec4 vWorldPosition;"),_.push("uniform bool clippable;");for(var g=0;g<s.sectionPlanes.length;g++)_.push("uniform bool sectionPlaneActive"+g+";"),_.push("uniform vec3 sectionPlanePos"+g+";"),_.push("uniform vec3 sectionPlaneDir"+g+";")}l&&(o.lightMaps.length>0&&(_.push("uniform samplerCube lightMap;"),_.push("uniform mat4 viewNormalMatrix;")),o.reflectionMaps.length>0&&_.push("uniform samplerCube reflectionMap;"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&_.push("uniform mat4 viewMatrix;"),_.push("#define PI 3.14159265359"),_.push("#define RECIPROCAL_PI 0.31830988618"),_.push("#define RECIPROCAL_PI2 0.15915494"),_.push("#define EPSILON 1e-6"),_.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),_.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),_.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),_.push("}"),_.push("struct IncidentLight {"),_.push("   vec3 color;"),_.push("   vec3 direction;"),_.push("};"),_.push("struct ReflectedLight {"),_.push("   vec3 diffuse;"),_.push("   vec3 specular;"),_.push("};"),_.push("struct Geometry {"),_.push("   vec3 position;"),_.push("   vec3 viewNormal;"),_.push("   vec3 worldNormal;"),_.push("   vec3 viewEyeDir;"),_.push("};"),_.push("struct Material {"),_.push("   vec3    diffuseColor;"),_.push("   float   specularRoughness;"),_.push("   vec3    specularColor;"),_.push("   float   shine;"),_.push("};"),u&&((o.lightMaps.length>0||o.reflectionMaps.length>0)&&(_.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(_.push("   vec3 irradiance = "+ri[o.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),_.push("   irradiance *= PI;"),_.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),_.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(_.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),_.push("   vec3 radiance               = textureCube(reflectionMap, reflectVec).rgb * 0.2;"),_.push("   radiance *= PI;"),_.push("   reflectedLight.specular     += radiance;")),_.push("}")),_.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),_.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),_.push("   vec3 irradiance = dotNL * directLight.color * PI;"),_.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),_.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),_.push("}")),(c||p)&&(_.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),_.push("   float r = ggxRoughness + 0.0001;"),_.push("   return (2.0 / (r * r) - 2.0);"),_.push("}"),_.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),_.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),_.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),_.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),_.push("}"),o.reflectionMaps.length>0&&(_.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),_.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),_.push("   vec3 envMapColor = "+ri[o.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),_.push("  return envMapColor;"),_.push("}")),_.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),_.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),_.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),_.push("}"),_.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),_.push("   float a2 = ( alpha * alpha );"),_.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),_.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),_.push("   return 1.0 / ( gl * gv );"),_.push("}"),_.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),_.push("   float a2 = ( alpha * alpha );"),_.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),_.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),_.push("   return 0.5 / max( gv + gl, EPSILON );"),_.push("}"),_.push("float D_GGX(const in float alpha, const in float dotNH) {"),_.push("   float a2 = ( alpha * alpha );"),_.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),_.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),_.push("}"),_.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),_.push("   float alpha = ( roughness * roughness );"),_.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),_.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),_.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),_.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),_.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),_.push("   vec3  F = F_Schlick( specularColor, dotLH );"),_.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),_.push("   float D = D_GGX( alpha, dotNH );"),_.push("   return F * (G * D);"),_.push("}"),_.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),_.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),_.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),_.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),_.push("   vec4 r = roughness * c0 + c1;"),_.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),_.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),_.push("   return specularColor * AB.x + AB.y;"),_.push("}"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&(_.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(_.push("   vec3 irradiance = sRGBToLinear(textureCube(lightMap, geometry.worldNormal)).rgb;"),_.push("   irradiance *= PI;"),_.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),_.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(_.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),_.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),_.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),_.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),_.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),_.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),_.push("}")),_.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),_.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),_.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),_.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),_.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),_.push("}")));_.push("varying vec3 vViewPosition;"),r.colors&&_.push("varying vec4 vColor;");h&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._occlusionMap||i._alphaMap)&&_.push("varying vec2 vUV;");l&&(o.lightMaps.length>0&&_.push("varying vec3 vWorldNormal;"),_.push("varying vec3 vViewNormal;"));a.ambient&&_.push("uniform vec3 materialAmbient;");a.baseColor&&_.push("uniform vec3 materialBaseColor;");void 0!==a.alpha&&null!==a.alpha&&_.push("uniform vec4 materialAlphaModeCutoff;");a.emissive&&_.push("uniform vec3 materialEmissive;");a.diffuse&&_.push("uniform vec3 materialDiffuse;");void 0!==a.glossiness&&null!==a.glossiness&&_.push("uniform float materialGlossiness;");void 0!==a.shininess&&null!==a.shininess&&_.push("uniform float materialShininess;");a.specular&&_.push("uniform vec3 materialSpecular;");void 0!==a.metallic&&null!==a.metallic&&_.push("uniform float materialMetallic;");void 0!==a.roughness&&null!==a.roughness&&_.push("uniform float materialRoughness;");void 0!==a.specularF0&&null!==a.specularF0&&_.push("uniform float materialSpecularF0;");h&&i._ambientMap&&(_.push("uniform sampler2D ambientMap;"),i._ambientMap._state.matrix&&_.push("uniform mat4 ambientMapMatrix;"));h&&i._baseColorMap&&(_.push("uniform sampler2D baseColorMap;"),i._baseColorMap._state.matrix&&_.push("uniform mat4 baseColorMapMatrix;"));h&&i._diffuseMap&&(_.push("uniform sampler2D diffuseMap;"),i._diffuseMap._state.matrix&&_.push("uniform mat4 diffuseMapMatrix;"));h&&i._emissiveMap&&(_.push("uniform sampler2D emissiveMap;"),i._emissiveMap._state.matrix&&_.push("uniform mat4 emissiveMapMatrix;"));l&&h&&i._metallicMap&&(_.push("uniform sampler2D metallicMap;"),i._metallicMap._state.matrix&&_.push("uniform mat4 metallicMapMatrix;"));l&&h&&i._roughnessMap&&(_.push("uniform sampler2D roughnessMap;"),i._roughnessMap._state.matrix&&_.push("uniform mat4 roughnessMapMatrix;"));l&&h&&i._metallicRoughnessMap&&(_.push("uniform sampler2D metallicRoughnessMap;"),i._metallicRoughnessMap._state.matrix&&_.push("uniform mat4 metallicRoughnessMapMatrix;"));l&&i._normalMap&&(_.push("uniform sampler2D normalMap;"),i._normalMap._state.matrix&&_.push("uniform mat4 normalMapMatrix;"),_.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),_.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),_.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),_.push("      vec2 st0 = dFdx( uv.st );"),_.push("      vec2 st1 = dFdy( uv.st );"),_.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),_.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),_.push("      vec3 N = normalize( surf_norm );"),_.push("      vec3 mapN = texture2D( normalMap, uv ).xyz * 2.0 - 1.0;"),_.push("      mat3 tsn = mat3( S, T, N );"),_.push("      return normalize( tsn * mapN );"),_.push("}"));h&&i._occlusionMap&&(_.push("uniform sampler2D occlusionMap;"),i._occlusionMap._state.matrix&&_.push("uniform mat4 occlusionMapMatrix;"));h&&i._alphaMap&&(_.push("uniform sampler2D alphaMap;"),i._alphaMap._state.matrix&&_.push("uniform mat4 alphaMapMatrix;"));l&&h&&i._specularMap&&(_.push("uniform sampler2D specularMap;"),i._specularMap._state.matrix&&_.push("uniform mat4 specularMapMatrix;"));l&&h&&i._glossinessMap&&(_.push("uniform sampler2D glossinessMap;"),i._glossinessMap._state.matrix&&_.push("uniform mat4 glossinessMapMatrix;"));l&&h&&i._specularGlossinessMap&&(_.push("uniform sampler2D materialSpecularGlossinessMap;"),i._specularGlossinessMap._state.matrix&&_.push("uniform mat4 materialSpecularGlossinessMapMatrix;"));l&&(i._diffuseFresnel||i._specularFresnel||i._alphaFresnel||i._emissiveFresnel||i._reflectivityFresnel)&&(_.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),_.push("    float fr = abs(dot(eyeDir, normal));"),_.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),_.push("    return pow(finalFr, power);"),_.push("}"),i._diffuseFresnel&&(_.push("uniform float  diffuseFresnelCenterBias;"),_.push("uniform float  diffuseFresnelEdgeBias;"),_.push("uniform float  diffuseFresnelPower;"),_.push("uniform vec3   diffuseFresnelCenterColor;"),_.push("uniform vec3   diffuseFresnelEdgeColor;")),i._specularFresnel&&(_.push("uniform float  specularFresnelCenterBias;"),_.push("uniform float  specularFresnelEdgeBias;"),_.push("uniform float  specularFresnelPower;"),_.push("uniform vec3   specularFresnelCenterColor;"),_.push("uniform vec3   specularFresnelEdgeColor;")),i._alphaFresnel&&(_.push("uniform float  alphaFresnelCenterBias;"),_.push("uniform float  alphaFresnelEdgeBias;"),_.push("uniform float  alphaFresnelPower;"),_.push("uniform vec3   alphaFresnelCenterColor;"),_.push("uniform vec3   alphaFresnelEdgeColor;")),i._reflectivityFresnel&&(_.push("uniform float  materialSpecularF0FresnelCenterBias;"),_.push("uniform float  materialSpecularF0FresnelEdgeBias;"),_.push("uniform float  materialSpecularF0FresnelPower;"),_.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),_.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),i._emissiveFresnel&&(_.push("uniform float  emissiveFresnelCenterBias;"),_.push("uniform float  emissiveFresnelEdgeBias;"),_.push("uniform float  emissiveFresnelPower;"),_.push("uniform vec3   emissiveFresnelCenterColor;"),_.push("uniform vec3   emissiveFresnelEdgeColor;")));if(_.push("uniform vec4   lightAmbient;"),l)for(var m=0,v=o.lights.length;m<v;m++){var b=o.lights[m];"ambient"!==b.type&&(_.push("uniform vec4 lightColor"+m+";"),"point"===b.type&&_.push("uniform vec3 lightAttenuation"+m+";"),"dir"===b.type&&"view"===b.space&&_.push("uniform vec3 lightDir"+m+";"),"point"===b.type&&"view"===b.space?_.push("uniform vec3 lightPos"+m+";"):_.push("varying vec4 vViewLightReverseDirAndDist"+m+";"))}if(d)for(var y=0,P=o.lights.length;y<P;y++)o.lights[y].castsShadow&&(_.push("varying vec4 vShadowPosFromLight"+y+";"),_.push("uniform sampler2D shadowMap"+y+";"));if(_.push("uniform vec4 colorize;"),_.push("void main(void) {"),n){_.push("if (clippable) {"),_.push("  float dist = 0.0;");for(g=0;g<s.sectionPlanes.length;g++)_.push("if (sectionPlaneActive"+g+") {"),_.push("   dist += clamp(dot(-sectionPlaneDir"+g+".xyz, vWorldPosition.xyz - sectionPlanePos"+g+".xyz), 0.0, 1000.0);"),_.push("}");_.push("  if (dist > 0.0) { discard; }"),_.push("}")}"points"===r.primitiveName&&(_.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),_.push("float r = dot(cxy, cxy);"),_.push("if (r > 1.0) {"),_.push("   discard;"),_.push("}"));_.push("float occlusion = 1.0;"),a.ambient?_.push("vec3 ambientColor = materialAmbient;"):_.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);");a.diffuse?_.push("vec3 diffuseColor = materialDiffuse;"):a.baseColor?_.push("vec3 diffuseColor = materialBaseColor;"):_.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);");r.colors&&_.push("diffuseColor *= vColor.rgb;");a.emissive?_.push("vec3 emissiveColor = materialEmissive;"):_.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);");a.specular?_.push("vec3 specular = materialSpecular;"):_.push("vec3 specular = vec3(1.0, 1.0, 1.0);");void 0!==a.alpha?_.push("float alpha = materialAlphaModeCutoff[0];"):_.push("float alpha = 1.0;");r.colors&&_.push("alpha *= vColor.a;");void 0!==a.glossiness?_.push("float glossiness = materialGlossiness;"):_.push("float glossiness = 1.0;");void 0!==a.metallic?_.push("float metallic = materialMetallic;"):_.push("float metallic = 1.0;");void 0!==a.roughness?_.push("float roughness = materialRoughness;"):_.push("float roughness = 1.0;");void 0!==a.specularF0?_.push("float specularF0 = materialSpecularF0;"):_.push("float specularF0 = 1.0;");h&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._occlusionMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._alphaMap)&&(_.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),_.push("vec2 textureCoord;"));h&&i._ambientMap&&(i._ambientMap._state.matrix?_.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("vec4 ambientTexel = texture2D(ambientMap, textureCoord).rgb;"),_.push("ambientTexel = "+ri[i._ambientMap._state.encoding]+"(ambientTexel);"),_.push("ambientColor *= ambientTexel.rgb;"));h&&i._diffuseMap&&(i._diffuseMap._state.matrix?_.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("vec4 diffuseTexel = texture2D(diffuseMap, textureCoord);"),_.push("diffuseTexel = "+ri[i._diffuseMap._state.encoding]+"(diffuseTexel);"),_.push("diffuseColor *= diffuseTexel.rgb;"),_.push("alpha *= diffuseTexel.a;"));h&&i._baseColorMap&&(i._baseColorMap._state.matrix?_.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("vec4 baseColorTexel = texture2D(baseColorMap, textureCoord);"),_.push("baseColorTexel = "+ri[i._baseColorMap._state.encoding]+"(baseColorTexel);"),_.push("diffuseColor *= baseColorTexel.rgb;"),_.push("alpha *= baseColorTexel.a;"));h&&i._emissiveMap&&(i._emissiveMap._state.matrix?_.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("vec4 emissiveTexel = texture2D(emissiveMap, textureCoord);"),_.push("emissiveTexel = "+ri[i._emissiveMap._state.encoding]+"(emissiveTexel);"),_.push("emissiveColor = emissiveTexel.rgb;"));h&&i._alphaMap&&(i._alphaMap._state.matrix?_.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("alpha *= texture2D(alphaMap, textureCoord).r;"));h&&i._occlusionMap&&(i._occlusionMap._state.matrix?_.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("occlusion *= texture2D(occlusionMap, textureCoord).r;"));if(l&&(o.lights.length>0||o.lightMaps.length>0||o.reflectionMaps.length>0)){h&&i._normalMap?(i._normalMap._state.matrix?_.push("textureCoord = (normalMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):_.push("vec3 viewNormal = normalize(vViewNormal);"),h&&i._specularMap&&(i._specularMap._state.matrix?_.push("textureCoord = (specularMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("specular *= texture2D(specularMap, textureCoord).rgb;")),h&&i._glossinessMap&&(i._glossinessMap._state.matrix?_.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("glossiness *= texture2D(glossinessMap, textureCoord).r;")),h&&i._specularGlossinessMap&&(i._specularGlossinessMap._state.matrix?_.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("vec4 specGlossRGB = texture2D(materialSpecularGlossinessMap, textureCoord).rgba;"),_.push("specular *= specGlossRGB.rgb;"),_.push("glossiness *= specGlossRGB.a;")),h&&i._metallicMap&&(i._metallicMap._state.matrix?_.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("metallic *= texture2D(metallicMap, textureCoord).r;")),h&&i._roughnessMap&&(i._roughnessMap._state.matrix?_.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("roughness *= texture2D(roughnessMap, textureCoord).r;")),h&&i._metallicRoughnessMap&&(i._metallicRoughnessMap._state.matrix?_.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):_.push("textureCoord = texturePos.xy;"),_.push("vec3 metalRoughRGB = texture2D(metallicRoughnessMap, textureCoord).rgb;"),_.push("metallic *= metalRoughRGB.b;"),_.push("roughness *= metalRoughRGB.g;")),_.push("vec3 viewEyeDir = normalize(-vViewPosition);"),i._diffuseFresnel&&(_.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),_.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),i._specularFresnel&&(_.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),_.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),i._alphaFresnel&&(_.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),_.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),i._emissiveFresnel&&(_.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),_.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),_.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),_.push("   discard;"),_.push("}"),_.push("IncidentLight  light;"),_.push("Material       material;"),_.push("Geometry       geometry;"),_.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),_.push("vec3           viewLightDir;"),u&&(_.push("material.diffuseColor      = diffuseColor;"),_.push("material.specularColor     = specular;"),_.push("material.shine             = materialShininess;")),p&&(_.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),_.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),_.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),_.push("material.specularColor     = specular;")),c&&(_.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),_.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),_.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),_.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),_.push("geometry.position      = vViewPosition;"),o.lightMaps.length>0&&_.push("geometry.worldNormal   = normalize(vWorldNormal);"),_.push("geometry.viewNormal    = viewNormal;"),_.push("geometry.viewEyeDir    = viewEyeDir;"),u&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&_.push("computePhongLightMapping(geometry, material, reflectedLight);"),(p||c)&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&_.push("computePBRLightMapping(geometry, material, reflectedLight);"),_.push("float shadow = 1.0;"),_.push("float shadowAcneRemover = 0.007;"),_.push("vec3 fragmentDepth;"),_.push("float texelSize = 1.0 / 1024.0;"),_.push("float amountInLight = 0.0;"),_.push("vec3 shadowCoord;"),_.push("vec4 rgbaDepth;"),_.push("float depth;");for(var M=0,x=o.lights.length;M<x;M++){var w=o.lights[M];"ambient"!==w.type&&("dir"===w.type&&"view"===w.space?_.push("viewLightDir = -normalize(lightDir"+M+");"):"point"===w.type&&"view"===w.space?_.push("viewLightDir = normalize(lightPos"+M+" - vViewPosition);"):_.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+M+".xyz);"),d&&w.castsShadow?(_.push("shadow = 0.0;"),_.push("fragmentDepth = vShadowPosFromLight"+M+".xyz;"),_.push("fragmentDepth.z -= shadowAcneRemover;"),_.push("for (int x = -3; x <= 3; x++) {"),_.push("  for (int y = -3; y <= 3; y++) {"),_.push("      float texelDepth = unpackDepth(texture2D(shadowMap"+M+", fragmentDepth.xy + vec2(x, y) * texelSize));"),_.push("      if (fragmentDepth.z < texelDepth) {"),_.push("          shadow += 1.0;"),_.push("      }"),_.push("  }"),_.push("}"),_.push("shadow = shadow / 9.0;"),_.push("light.color =  lightColor"+M+".rgb * (lightColor"+M+".a * shadow);")):_.push("light.color =  lightColor"+M+".rgb * (lightColor"+M+".a );"),_.push("light.direction = viewLightDir;"),u&&_.push("computePhongLighting(light, geometry, material, reflectedLight);"),(p||c)&&_.push("computePBRLighting(light, geometry, material, reflectedLight);"))}u?_.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * diffuseColor) + ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;"):_.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;")}else _.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),_.push("vec3 outgoingLight = emissiveColor + ambientColor;");_.push("gl_FragColor = vec4(outgoingLight, alpha) * colorize;"),f&&_.push("gl_FragColor = linearToGamma(gl_FragColor, gammaFactor);");e.logarithmicDepthBufferEnabled&&_.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");return _.push("}"),_}(t))},ri={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};function si(t){if(!t.receivesShadow)return!1;var e=t.scene._lightsState.lights;if(!e||0===e.length)return!1;for(var i=0,r=e.length;i<r;i++)if(e[i].castsShadow)return!0;return!1}function oi(t){var e=t._geometry._state.primitiveName;return!(!t._geometry._state.autoVertexNormals&&!t._geometry._state.normalsBuf||"triangles"!==e&&"triangle-strip"!==e&&"triangle-fan"!==e)}var ai=E.vec3(),ni=new t({}),li=function(t,e){this.id=ni.addItem({}),this._hash=t,this._scene=e.scene,this._useCount=0,this._shaderSource=new ii(e),this._allocate(e)},hi={};li.get=function(t){var e=t.scene,i=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash(),t._geometry._state.hash,t._material._state.hash,t._state.drawHash].join(";"),r=hi[i];if(!r){if((r=new li(i,t)).errors)return console.log(r.errors.join("\n")),null;hi[i]=r,S.memory.programs++}return r._useCount++,r},li.prototype.put=function(){0==--this._useCount&&(ni.removeItem(this.id),this._program&&this._program.destroy(),delete hi[this._hash],S.memory.programs--)},li.prototype.webglContextRestored=function(){this._program=null},li.prototype.drawMesh=function(t,e){this._program||this._allocate(e);var i=wt.MAX_TEXTURE_UNITS,r=e.scene,s=e._material,o=r.canvas.gl,a=this._program,n=e._state,l=e._material._state,h=e._geometry._state,u=r.camera,c=e.rtcCenter;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),o.uniformMatrix4fv(this._uViewMatrix,!1,c?t.getRTCViewMatrix(n.rtcCenterHash,c):u.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,u.viewNormalMatrix),n.clippable){var p=r._sectionPlanesState.sectionPlanes.length;if(p>0)for(var d=r._sectionPlanesState.sectionPlanes,f=e.renderFlags,_=0;_<p;_++){var g=this._uSectionPlanes[_];if(g){var m=f.sectionPlanesActivePerLayer[_];if(o.uniform1i(g.active,m?1:0),m){var v=d[_];o.uniform3fv(g.pos,c?at(v.dist,v.dir,c,ai):v.pos),o.uniform3fv(g.dir,v.dir)}}}}if(l.id!==this._lastMaterialId){t.textureUnit=this._baseTextureUnit;var b=l.backfaces;t.backfaces!==b&&(b?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),t.backfaces=b);var y=l.frontface;switch(t.frontface!==y&&(y?o.frontFace(o.CCW):o.frontFace(o.CW),t.frontface=y),t.lineWidth!==l.lineWidth&&(o.lineWidth(l.lineWidth),t.lineWidth=l.lineWidth),this._uPointSize&&o.uniform1f(this._uPointSize,l.pointSize),l.type){case"LambertMaterial":this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialColor&&o.uniform4f(this._uMaterialColor,l.color[0],l.color[1],l.color[2],l.alpha),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive);break;case"PhongMaterial":this._uMaterialShininess&&o.uniform1f(this._uMaterialShininess,l.shininess),this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0),s._ambientMap&&s._ambientMap._state.texture&&this._uMaterialAmbientMap&&(a.bindTexture(this._uMaterialAmbientMap,s._ambientMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uMaterialAmbientMapMatrix&&o.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,s._ambientMap._state.matrix)),s._diffuseMap&&s._diffuseMap._state.texture&&this._uDiffuseMap&&(a.bindTexture(this._uDiffuseMap,s._diffuseMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,s._diffuseMap._state.matrix)),s._specularMap&&s._specularMap._state.texture&&this._uSpecularMap&&(a.bindTexture(this._uSpecularMap,s._specularMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,s._specularMap._state.matrix)),s._emissiveMap&&s._emissiveMap._state.texture&&this._uEmissiveMap&&(a.bindTexture(this._uEmissiveMap,s._emissiveMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,s._emissiveMap._state.matrix)),s._alphaMap&&s._alphaMap._state.texture&&this._uAlphaMap&&(a.bindTexture(this._uAlphaMap,s._alphaMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,s._alphaMap._state.matrix)),s._reflectivityMap&&s._reflectivityMap._state.texture&&this._uReflectivityMap&&(a.bindTexture(this._uReflectivityMap,s._reflectivityMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,this._uReflectivityMapMatrix&&o.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,s._reflectivityMap._state.matrix)),s._normalMap&&s._normalMap._state.texture&&this._uNormalMap&&(a.bindTexture(this._uNormalMap,s._normalMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,s._normalMap._state.matrix)),s._occlusionMap&&s._occlusionMap._state.texture&&this._uOcclusionMap&&(a.bindTexture(this._uOcclusionMap,s._occlusionMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,s._occlusionMap._state.matrix)),s._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&o.uniform1f(this._uDiffuseFresnelEdgeBias,s._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&o.uniform1f(this._uDiffuseFresnelCenterBias,s._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&o.uniform3fv(this._uDiffuseFresnelEdgeColor,s._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&o.uniform3fv(this._uDiffuseFresnelCenterColor,s._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&o.uniform1f(this._uDiffuseFresnelPower,s._diffuseFresnel.power)),s._specularFresnel&&(this._uSpecularFresnelEdgeBias&&o.uniform1f(this._uSpecularFresnelEdgeBias,s._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&o.uniform1f(this._uSpecularFresnelCenterBias,s._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&o.uniform3fv(this._uSpecularFresnelEdgeColor,s._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&o.uniform3fv(this._uSpecularFresnelCenterColor,s._specularFresnel.centerColor),this._uSpecularFresnelPower&&o.uniform1f(this._uSpecularFresnelPower,s._specularFresnel.power)),s._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&o.uniform1f(this._uAlphaFresnelEdgeBias,s._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&o.uniform1f(this._uAlphaFresnelCenterBias,s._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&o.uniform3fv(this._uAlphaFresnelEdgeColor,s._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&o.uniform3fv(this._uAlphaFresnelCenterColor,s._alphaFresnel.centerColor),this._uAlphaFresnelPower&&o.uniform1f(this._uAlphaFresnelPower,s._alphaFresnel.power)),s._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&o.uniform1f(this._uReflectivityFresnelEdgeBias,s._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&o.uniform1f(this._uReflectivityFresnelCenterBias,s._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&o.uniform3fv(this._uReflectivityFresnelEdgeColor,s._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&o.uniform3fv(this._uReflectivityFresnelCenterColor,s._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&o.uniform1f(this._uReflectivityFresnelPower,s._reflectivityFresnel.power)),s._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&o.uniform1f(this._uEmissiveFresnelEdgeBias,s._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&o.uniform1f(this._uEmissiveFresnelCenterBias,s._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&o.uniform3fv(this._uEmissiveFresnelEdgeColor,s._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&o.uniform3fv(this._uEmissiveFresnelCenterColor,s._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&o.uniform1f(this._uEmissiveFresnelPower,s._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&o.uniform3fv(this._uBaseColor,l.baseColor),this._uMaterialMetallic&&o.uniform1f(this._uMaterialMetallic,l.metallic),this._uMaterialRoughness&&o.uniform1f(this._uMaterialRoughness,l.roughness),this._uMaterialSpecularF0&&o.uniform1f(this._uMaterialSpecularF0,l.specularF0),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);var P=s._baseColorMap;P&&P._state.texture&&this._uBaseColorMap&&(a.bindTexture(this._uBaseColorMap,P._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uBaseColorMapMatrix&&o.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,P._state.matrix));var M=s._metallicMap;M&&M._state.texture&&this._uMetallicMap&&(a.bindTexture(this._uMetallicMap,M._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uMetallicMapMatrix&&o.uniformMatrix4fv(this._uMetallicMapMatrix,!1,M._state.matrix));var x=s._roughnessMap;x&&x._state.texture&&this._uRoughnessMap&&(a.bindTexture(this._uRoughnessMap,x._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uRoughnessMapMatrix&&o.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,x._state.matrix));var w=s._metallicRoughnessMap;w&&w._state.texture&&this._uMetallicRoughnessMap&&(a.bindTexture(this._uMetallicRoughnessMap,w._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uMetallicRoughnessMapMatrix&&o.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,w._state.matrix)),(S=s._emissiveMap)&&S._state.texture&&this._uEmissiveMap&&(a.bindTexture(this._uEmissiveMap,S._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,S._state.matrix)),(D=s._occlusionMap)&&s._occlusionMap._state.texture&&this._uOcclusionMap&&(a.bindTexture(this._uOcclusionMap,D._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,D._state.matrix)),(L=s._alphaMap)&&L._state.texture&&this._uAlphaMap&&(a.bindTexture(this._uAlphaMap,L._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,L._state.matrix)),(B=s._normalMap)&&B._state.texture&&this._uNormalMap&&(a.bindTexture(this._uNormalMap,B._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,B._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialGlossiness&&o.uniform1f(this._uMaterialGlossiness,l.glossiness),this._uMaterialReflectivity&&o.uniform1f(this._uMaterialReflectivity,l.reflectivity),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);var E=s._diffuseMap;E&&E._state.texture&&this._uDiffuseMap&&(a.bindTexture(this._uDiffuseMap,E._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,E._state.matrix));var C=s._specularMap;C&&C._state.texture&&this._uSpecularMap&&(a.bindTexture(this._uSpecularMap,C._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,C._state.matrix));var A=s._glossinessMap;A&&A._state.texture&&this._uGlossinessMap&&(a.bindTexture(this._uGlossinessMap,A._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uGlossinessMapMatrix&&o.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,A._state.matrix));var S,D,L,B,R=s._specularGlossinessMap;R&&R._state.texture&&this._uSpecularGlossinessMap&&(a.bindTexture(this._uSpecularGlossinessMap,R._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uSpecularGlossinessMapMatrix&&o.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,R._state.matrix)),(S=s._emissiveMap)&&S._state.texture&&this._uEmissiveMap&&(a.bindTexture(this._uEmissiveMap,S._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,S._state.matrix)),(D=s._occlusionMap)&&D._state.texture&&this._uOcclusionMap&&(a.bindTexture(this._uOcclusionMap,D._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,D._state.matrix)),(L=s._alphaMap)&&L._state.texture&&this._uAlphaMap&&(a.bindTexture(this._uAlphaMap,L._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,L._state.matrix)),(B=s._normalMap)&&B._state.texture&&this._uNormalMap&&(a.bindTexture(this._uNormalMap,B._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,B._state.matrix))}this._lastMaterialId=l.id}if(o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,e.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,n.clippable),this._uColorize){var T=n.colorize,F=this._lastColorize;F[0]===T[0]&&F[1]===T[1]&&F[2]===T[2]&&F[3]===T[3]||(o.uniform4fv(this._uColorize,T),F[0]=T[0],F[1]=T[1],F[2]=T[2],F[3]=T[3])}o.uniform3fv(this._uOffset,n.offset),h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf),t.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(h.normalsBuf),t.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(h.uvBuf),t.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(h.colorsBuf),t.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(h.flagsBuf),t.bindArray++),h.indicesBuf&&(h.indicesBuf.bind(),t.bindArray++),this._lastGeometryId=h.id),h.indicesBuf?(o.drawElements(h.primitive,h.indicesBuf.numItems,h.indicesBuf.itemType,0),t.drawElements++):h.positions&&(o.drawArrays(o.TRIANGLES,0,h.positions.numItems),t.drawArrays++)},li.prototype._allocate=function(t){var e=t.scene,i=e.canvas.gl,r=t._material,s=e._lightsState,o=e._sectionPlanesState,a=t._material._state;if(this._program=new zt(i,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var n=this._program;this._uPositionsDecodeMatrix=n.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=n.getLocation("uvDecodeMatrix"),this._uModelMatrix=n.getLocation("modelMatrix"),this._uModelNormalMatrix=n.getLocation("modelNormalMatrix"),this._uViewMatrix=n.getLocation("viewMatrix"),this._uViewNormalMatrix=n.getLocation("viewNormalMatrix"),this._uProjMatrix=n.getLocation("projMatrix"),this._uGammaFactor=n.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[],e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=n.getLocation("logDepthBufFC"));for(var l,h=s.lights,u=0,c=h.length;u<c;u++){switch((l=h[u]).type){case"ambient":this._uLightAmbient[u]=n.getLocation("lightAmbient");break;case"dir":this._uLightColor[u]=n.getLocation("lightColor"+u),this._uLightPos[u]=null,this._uLightDir[u]=n.getLocation("lightDir"+u);break;case"point":this._uLightColor[u]=n.getLocation("lightColor"+u),this._uLightPos[u]=n.getLocation("lightPos"+u),this._uLightDir[u]=null,this._uLightAttenuation[u]=n.getLocation("lightAttenuation"+u);break;case"spot":this._uLightColor[u]=n.getLocation("lightColor"+u),this._uLightPos[u]=n.getLocation("lightPos"+u),this._uLightDir[u]=n.getLocation("lightDir"+u),this._uLightAttenuation[u]=n.getLocation("lightAttenuation"+u)}l.castsShadow&&(this._uShadowViewMatrix[u]=n.getLocation("shadowViewMatrix"+u),this._uShadowProjMatrix[u]=n.getLocation("shadowProjMatrix"+u))}s.lightMaps.length>0&&(this._uLightMap="lightMap"),s.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];for(u=0,c=o.sectionPlanes.length;u<c;u++)this._uSectionPlanes.push({active:n.getLocation("sectionPlaneActive"+u),pos:n.getLocation("sectionPlanePos"+u),dir:n.getLocation("sectionPlaneDir"+u)});switch(this._uPointSize=n.getLocation("pointSize"),a.type){case"LambertMaterial":this._uMaterialColor=n.getLocation("materialColor"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=n.getLocation("materialAmbient"),this._uMaterialDiffuse=n.getLocation("materialDiffuse"),this._uMaterialSpecular=n.getLocation("materialSpecular"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=n.getLocation("materialShininess"),r._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=n.getLocation("ambientMapMatrix")),r._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=n.getLocation("diffuseMapMatrix")),r._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=n.getLocation("specularMapMatrix")),r._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),r._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),r._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=n.getLocation("reflectivityMapMatrix")),r._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix")),r._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),r._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=n.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=n.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=n.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=n.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=n.getLocation("diffuseFresnelPower")),r._specularFresnel&&(this._uSpecularFresnelEdgeBias=n.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=n.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=n.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=n.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=n.getLocation("specularFresnelPower")),r._alphaFresnel&&(this._uAlphaFresnelEdgeBias=n.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=n.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=n.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=n.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=n.getLocation("alphaFresnelPower")),r._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=n.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=n.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=n.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=n.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=n.getLocation("reflectivityFresnelPower")),r._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=n.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=n.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=n.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=n.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=n.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=n.getLocation("materialBaseColor"),this._uMaterialMetallic=n.getLocation("materialMetallic"),this._uMaterialRoughness=n.getLocation("materialRoughness"),this._uMaterialSpecularF0=n.getLocation("materialSpecularF0"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),r._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=n.getLocation("baseColorMapMatrix")),r._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=n.getLocation("metallicMapMatrix")),r._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=n.getLocation("roughnessMapMatrix")),r._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=n.getLocation("metallicRoughnessMapMatrix")),r._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),r._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),r._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),r._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=n.getLocation("materialDiffuse"),this._uMaterialSpecular=n.getLocation("materialSpecular"),this._uMaterialGlossiness=n.getLocation("materialGlossiness"),this._uMaterialReflectivity=n.getLocation("reflectivityFresnel"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),r._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=n.getLocation("diffuseMapMatrix")),r._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=n.getLocation("specularMapMatrix")),r._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=n.getLocation("glossinessMapMatrix")),r._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=n.getLocation("materialSpecularGlossinessMapMatrix")),r._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),r._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),r._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),r._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix"))}this._aPosition=n.getAttribute("position"),this._aNormal=n.getAttribute("normal"),this._aUV=n.getAttribute("uv"),this._aColor=n.getAttribute("color"),this._aFlags=n.getAttribute("flags"),this._uClippable=n.getLocation("clippable"),this._uColorize=n.getLocation("colorize"),this._uOffset=n.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0}},li.prototype._bindProgram=function(t){var e,i=wt.MAX_TEXTURE_UNITS,r=this._scene,s=r.canvas.gl,o=r._lightsState,a=r.camera.project,n=this._program;if(n.bind(),t.useProgram++,t.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,s.uniformMatrix4fv(this._uProjMatrix,!1,a.matrix),r.logarithmicDepthBufferEnabled){var l=2/(Math.log(a.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,l)}for(var h=0,u=o.lights.length;h<u;h++)if(e=o.lights[h],this._uLightAmbient[h])s.uniform4f(this._uLightAmbient[h],e.color[0],e.color[1],e.color[2],e.intensity);else if(this._uLightColor[h]&&s.uniform4f(this._uLightColor[h],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[h]&&(s.uniform3fv(this._uLightPos[h],e.pos),this._uLightAttenuation[h]&&s.uniform1f(this._uLightAttenuation[h],e.attenuation)),this._uLightDir[h]&&s.uniform3fv(this._uLightDir[h],e.dir),e.castsShadow){this._uShadowViewMatrix[h]&&s.uniformMatrix4fv(this._uShadowViewMatrix[h],!1,e.getShadowViewMatrix()),this._uShadowProjMatrix[h]&&s.uniformMatrix4fv(this._uShadowProjMatrix[h],!1,e.getShadowProjMatrix());var c=e.getShadowRenderBuf();c&&(n.bindTexture("shadowMap"+h,c.getTexture(),t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++)}o.lightMaps.length>0&&o.lightMaps[0].texture&&this._uLightMap&&(n.bindTexture(this._uLightMap,o.lightMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++),o.reflectionMaps.length>0&&o.reflectionMaps[0].texture&&this._uReflectionMap&&(n.bindTexture(this._uReflectionMap,o.reflectionMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++),this._uGammaFactor&&s.uniform1f(this._uGammaFactor,r.gammaFactor),this._baseTextureUnit=t.textureUnit};var ui=function(t){this.vertex=function(t){var e=t.scene,i=e._lightsState,r=function(t){var e=t._geometry._state.primitiveName;if((t._geometry._state.autoVertexNormals||t._geometry._state.normalsBuf)&&("triangles"===e||"triangle-strip"===e||"triangle-fan"===e))return!0;return!1}(t),s=e._sectionPlanesState.sectionPlanes.length>0,o=!!t._geometry._state.compressGeometry,a=t._state.billboard,n=t._state.stationary,l=[];l.push("// EmphasisFillShaderSource vertex shader"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&l.push("#extension GL_EXT_frag_depth : enable");l.push("attribute vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec3 offset;"),o&&l.push("uniform mat4 positionsDecodeMatrix;");e.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&l.push("varying float vFragDepth;"));s&&l.push("varying vec4 vWorldPosition;");if(l.push("uniform vec4   lightAmbient;"),l.push("uniform vec4   fillColor;"),r){l.push("attribute vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;");for(var h=0,u=i.lights.length;h<u;h++){var c=i.lights[h];"ambient"!==c.type&&(l.push("uniform vec4 lightColor"+h+";"),"dir"===c.type&&l.push("uniform vec3 lightDir"+h+";"),"point"===c.type&&l.push("uniform vec3 lightPos"+h+";"),"spot"===c.type&&l.push("uniform vec3 lightPos"+h+";"))}o&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}l.push("varying vec4 vColor;"),("spherical"===a||"cylindrical"===a)&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),"spherical"===a&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}"));l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),o&&l.push("localPosition = positionsDecodeMatrix * localPosition;");r&&(o?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),n&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===a||"cylindrical"===a?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),r&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));r&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),r)for(var p=0,d=i.lights.length;p<d;p++){var f=i.lights[p];if("ambient"!==f.type){if("dir"===f.type)"view"===f.space?l.push("viewLightDir = normalize(lightDir"+p+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+p+", 0.0)).xyz);");else{if("point"!==f.type)continue;"view"===f.space?l.push("viewLightDir = normalize(lightPos"+p+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+p+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+p+".rgb * lightColor"+p+".a);")}}l.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),s&&l.push("vWorldPosition = worldPosition;");"points"===t._geometry._state.primitiveName&&l.push("gl_PointSize = pointSize;");l.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?l.push("vFragDepth = 1.0 + clipPos.w;"):(l.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),l.push("clipPos.z *= clipPos.w;")));return l.push("gl_Position = clipPos;"),l.push("}"),l}(t),this.fragment=function(t){var e=t.scene,i=t.scene._sectionPlanesState,r=t.scene.gammaOutput,s=i.sectionPlanes.length>0,o=[];o.push("// Lambertian drawing fragment shader"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable");o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;"));r&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(s){o.push("varying vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(var a=0,n=i.sectionPlanes.length;a<n;a++)o.push("uniform bool sectionPlaneActive"+a+";"),o.push("uniform vec3 sectionPlanePos"+a+";"),o.push("uniform vec3 sectionPlaneDir"+a+";")}if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),s){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(var l=0,h=i.sectionPlanes.length;l<h;l++)o.push("if (sectionPlaneActive"+l+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}"points"===t._geometry._state.primitiveName&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}"));e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");r?o.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):o.push("gl_FragColor = vColor;");return o.push("}"),o}(t)};var ci=new t({}),pi=E.vec3(),di=function(t,e){this.id=ci.addItem({}),this._hash=t,this._scene=e.scene,this._useCount=0,this._shaderSource=new ui(e),this._allocate(e)},fi={};di.get=function(t){var e=[t.scene.id,t.scene.gammaOutput?"go":"",t.scene._sectionPlanesState.getHash(),t._geometry._state.normalsBuf?"n":"",t._geometry._state.compressGeometry?"cp":"",t._state.hash].join(";"),i=fi[e];return i||(i=new di(e,t),fi[e]=i,S.memory.programs++),i._useCount++,i},di.prototype.put=function(){0==--this._useCount&&(ci.removeItem(this.id),this._program&&this._program.destroy(),delete fi[this._hash],S.memory.programs--)},di.prototype.webglContextRestored=function(){this._program=null},di.prototype.drawMesh=function(t,e,i){this._program||this._allocate(e);var r=this._scene,s=r.camera,o=r.canvas.gl,a=0===i?e._xrayMaterial._state:1===i?e._highlightMaterial._state:e._selectedMaterial._state,n=e._state,l=e._geometry._state,h=e.rtcCenter;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),o.uniformMatrix4fv(this._uViewMatrix,!1,h?t.getRTCViewMatrix(n.rtcCenterHash,h):s.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),n.clippable){var u=r._sectionPlanesState.sectionPlanes.length;if(u>0)for(var c=r._sectionPlanesState.sectionPlanes,p=e.renderFlags,d=0;d<u;d++){var f=this._uSectionPlanes[d];if(f){var _=p.sectionPlanesActivePerLayer[d];if(o.uniform1i(f.active,_?1:0),_){var g=c[d];o.uniform3fv(f.pos,h?at(g.dist,g.dir,h,pi):g.pos),o.uniform3fv(f.dir,g.dir)}}}}if(a.id!==this._lastMaterialId){var m=a.fillColor,v=a.backfaces;t.backfaces!==v&&(v?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),t.backfaces=v),o.uniform4f(this._uFillColor,m[0],m[1],m[2],a.fillAlpha),this._lastMaterialId=a.id}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,e.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,n.clippable),o.uniform3fv(this._uOffset,n.offset),l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf),t.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(l.normalsBuf),t.bindArray++),l.indicesBuf?(l.indicesBuf.bind(),t.bindArray++):l.positionsBuf,this._lastGeometryId=l.id),l.indicesBuf?(o.drawElements(l.primitive,l.indicesBuf.numItems,l.indicesBuf.itemType,0),t.drawElements++):l.positionsBuf&&(o.drawArrays(o.TRIANGLES,0,l.positionsBuf.numItems),t.drawArrays++)},di.prototype._allocate=function(t){var e=t.scene,i=e._lightsState,r=e._sectionPlanesState,s=e.canvas.gl;if(this._program=new zt(s,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var o=this._program;this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uModelMatrix=o.getLocation("modelMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var a=0,n=i.lights.length;a<n;a++){switch(i.lights[a].type){case"ambient":this._uLightAmbient[a]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[a]=o.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=o.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=o.getLocation("lightColor"+a),this._uLightPos[a]=o.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=o.getLocation("lightAttenuation"+a)}}this._uSectionPlanes=[];for(var l=0,h=r.sectionPlanes.length;l<h;l++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+l),pos:o.getLocation("sectionPlanePos"+l),dir:o.getLocation("sectionPlaneDir"+l)});this._uFillColor=o.getLocation("fillColor"),this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._uClippable=o.getLocation("clippable"),this._uGammaFactor=o.getLocation("gammaFactor"),this._uOffset=o.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=o.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},di.prototype._bindProgram=function(t){var e=this._scene,i=e.canvas.gl,r=e._lightsState,s=e.camera,o=s.project;if(this._program.bind(),t.useProgram++,t.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,i.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.normalMatrix),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),e.logarithmicDepthBufferEnabled){var a=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,a)}for(var n=0,l=r.lights.length;n<l;n++){var h=r.lights[n];this._uLightAmbient[n]?i.uniform4f(this._uLightAmbient[n],h.color[0],h.color[1],h.color[2],h.intensity):(this._uLightColor[n]&&i.uniform4f(this._uLightColor[n],h.color[0],h.color[1],h.color[2],h.intensity),this._uLightPos[n]&&(i.uniform3fv(this._uLightPos[n],h.pos),this._uLightAttenuation[n]&&i.uniform1f(this._uLightAttenuation[n],h.attenuation)),this._uLightDir[n]&&i.uniform3fv(this._uLightDir[n],h.dir))}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,e.gammaFactor)};var _i=function(t){this.vertex=function(t){var e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,r=!!t._geometry._state.compressGeometry,s=t._state.billboard,o=t._state.stationary,a=[];a.push("// Edges drawing vertex shader"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec4 edgeColor;"),a.push("uniform vec3 offset;"),r&&a.push("uniform mat4 positionsDecodeMatrix;");e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"));i&&a.push("varying vec4 vWorldPosition;");a.push("varying vec4 vColor;"),("spherical"===s||"cylindrical"===s)&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===s&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),r&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),o&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===s||"cylindrical"===s?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));a.push("vColor = edgeColor;"),i&&a.push("vWorldPosition = worldPosition;");a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;")));return a.push("gl_Position = clipPos;"),a.push("}"),a}(t),this.fragment=function(t){var e=t.scene,i=t.scene._sectionPlanesState,r=t.scene.gammaOutput,s=i.sectionPlanes.length>0,o=[];o.push("// Edges drawing fragment shader"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable");o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;"));r&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(s){o.push("varying vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(var a=0,n=i.sectionPlanes.length;a<n;a++)o.push("uniform bool sectionPlaneActive"+a+";"),o.push("uniform vec3 sectionPlanePos"+a+";"),o.push("uniform vec3 sectionPlaneDir"+a+";")}if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),s){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(var l=0,h=i.sectionPlanes.length;l<h;l++)o.push("if (sectionPlaneActive"+l+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");r?o.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):o.push("gl_FragColor = vColor;");return o.push("}"),o}(t)};var gi=new t({}),mi=E.vec3(),vi=function(t,e){this.id=gi.addItem({}),this._hash=t,this._scene=e.scene,this._useCount=0,this._shaderSource=new _i(e),this._allocate(e)},bi={};vi.get=function(t){var e=[t.scene.id,t.scene.gammaOutput?"go":"",t.scene._sectionPlanesState.getHash(),t._geometry._state.compressGeometry?"cp":"",t._state.hash].join(";"),i=bi[e];return i||(i=new vi(e,t),bi[e]=i,S.memory.programs++),i._useCount++,i},vi.prototype.put=function(){0==--this._useCount&&(gi.removeItem(this.id),this._program&&this._program.destroy(),delete bi[this._hash],S.memory.programs--)},vi.prototype.webglContextRestored=function(){this._program=null},vi.prototype.drawMesh=function(t,e,i){this._program||this._allocate(e);var r,s,o=this._scene,a=o.camera,n=o.canvas.gl,l=e._state,h=e._geometry,u=h._state,c=e.rtcCenter;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),n.uniformMatrix4fv(this._uViewMatrix,!1,c?t.getRTCViewMatrix(l.rtcCenterHash,c):a.viewMatrix),l.clippable){var p=o._sectionPlanesState.sectionPlanes.length;if(p>0)for(var d=o._sectionPlanesState.sectionPlanes,f=e.renderFlags,_=0;_<p;_++){var g=this._uSectionPlanes[_];if(g){var m=f.sectionPlanesActivePerLayer[_];if(n.uniform1i(g.active,m?1:0),m){var v=d[_];n.uniform3fv(g.pos,c?at(v.dist,v.dir,c,mi):v.pos),n.uniform3fv(g.dir,v.dir)}}}}switch(i){case 0:r=e._xrayMaterial._state;break;case 1:r=e._highlightMaterial._state;break;case 2:r=e._selectedMaterial._state;break;case 3:default:r=e._edgeMaterial._state}if(r.id!==this._lastMaterialId){var b=r.backfaces;if(t.backfaces!==b&&(b?n.disable(n.CULL_FACE):n.enable(n.CULL_FACE),t.backfaces=b),t.lineWidth!==r.edgeWidth&&(n.lineWidth(r.edgeWidth),t.lineWidth=r.edgeWidth),this._uEdgeColor){var y=r.edgeColor,P=r.edgeAlpha;n.uniform4f(this._uEdgeColor,y[0],y[1],y[2],P)}this._lastMaterialId=r.id}n.uniformMatrix4fv(this._uModelMatrix,n.FALSE,e.worldMatrix),this._uClippable&&n.uniform1i(this._uClippable,l.clippable),n.uniform3fv(this._uOffset,l.offset),u.primitive===n.TRIANGLES?s=h._getEdgeIndices():u.primitive===n.LINES&&(s=u.indicesBuf),s&&(u.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,u.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(u.positionsBuf,u.compressGeometry?n.UNSIGNED_SHORT:n.FLOAT),t.bindArray++),s.bind(),t.bindArray++,this._lastGeometryId=u.id),n.drawElements(n.LINES,s.numItems,s.itemType,0),t.drawElements++)},vi.prototype._allocate=function(t){var e=t.scene,i=e.canvas.gl,r=e._sectionPlanesState;if(this._program=new zt(i,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(var o=0,a=r.sectionPlanes.length;o<a;o++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+o),pos:s.getLocation("sectionPlanePos"+o),dir:s.getLocation("sectionPlaneDir"+o)});this._uEdgeColor=s.getLocation("edgeColor"),this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uOffset=s.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},vi.prototype._bindProgram=function(t){var e=this._program,i=this._scene,r=i.canvas.gl,s=i.camera.project;if(e.bind(),t.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,r.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),i.logarithmicDepthBufferEnabled){var o=2/(Math.log(s.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,o)}this._uGammaFactor&&r.uniform1f(this._uGammaFactor,i.gammaFactor)};var yi=function(t){this.vertex=function(t){var e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,r=!!t._geometry._state.compressGeometry,s=t._state.billboard,o=t._state.stationary,a=[];a.push("// Mesh picking vertex shader"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("varying vec4 vViewPosition;"),a.push("uniform vec3 offset;"),r&&a.push("uniform mat4 positionsDecodeMatrix;");i&&a.push("varying vec4 vWorldPosition;");e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"));"spherical"!==s&&"cylindrical"!==s||(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===s&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),r&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),o&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==s&&"cylindrical"!==s||(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"));a.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),a.push("   worldPosition.xyz = worldPosition.xyz + offset;"),a.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&a.push("   vWorldPosition = worldPosition;");a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;")));return a.push("gl_Position = clipPos;"),a.push("}"),a}(t),this.fragment=function(t){var e=t.scene,i=e._sectionPlanesState,r=i.sectionPlanes.length>0,s=[];s.push("// Mesh picking fragment shader"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable");s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;"));if(s.push("uniform vec4 pickColor;"),r){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("void main(void) {"),r){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(o=0;o<i.sectionPlanes.length;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");return s.push("   gl_FragColor = pickColor; "),s.push("}"),s}(t)};var Pi=E.vec3(),Mi=function(t,e){this._hash=t,this._shaderSource=new yi(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},xi={};Mi.get=function(t){var e=[t.scene.canvas.canvas.id,t.scene._sectionPlanesState.getHash(),t._geometry._state.hash,t._state.hash].join(";"),i=xi[e];if(!i){if((i=new Mi(e,t)).errors)return console.log(i.errors.join("\n")),null;xi[e]=i,S.memory.programs++}return i._useCount++,i},Mi.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete xi[this._hash],S.memory.programs--)},Mi.prototype.webglContextRestored=function(){this._program=null},Mi.prototype.drawMesh=function(t,e){this._program||this._allocate(e);var i=this._scene,r=i.canvas.gl,s=e._state,o=e._material._state,a=e._geometry._state,n=e.rtcCenter;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),r.uniformMatrix4fv(this._uViewMatrix,!1,n?t.getRTCPickViewMatrix(s.rtcCenterHash,n):t.pickViewMatrix),s.clippable){var l=i._sectionPlanesState.sectionPlanes.length;if(l>0)for(var h=i._sectionPlanesState.sectionPlanes,u=e.renderFlags,c=0;c<l;c++){var p=this._uSectionPlanes[c];if(p){var d=u.sectionPlanesActivePerLayer[c];if(r.uniform1i(p.active,d?1:0),d){var f=h[c];r.uniform3fv(p.pos,n?at(f.dist,f.dir,n,Pi):f.pos),r.uniform3fv(p.dir,f.dir)}}}}if(o.id!==this._lastMaterialId){var _=o.backfaces;t.backfaces!==_&&(_?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),t.backfaces=_);var g=o.frontface;t.frontface!==g&&(g?r.frontFace(r.CCW):r.frontFace(r.CW),t.frontface=g),this._lastMaterialId=o.id}r.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),r.uniformMatrix4fv(this._uModelMatrix,!1,e.worldMatrix),this._uClippable&&r.uniform1i(this._uClippable,e._state.clippable),r.uniform3fv(this._uOffset,e._state.offset),a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.compressGeometry?r.UNSIGNED_SHORT:r.FLOAT),t.bindArray++),a.indicesBuf&&(a.indicesBuf.bind(),t.bindArray++),this._lastGeometryId=a.id);var m=e._state.pickID,v=m>>24&255,b=m>>16&255,y=m>>8&255,P=255&m;r.uniform4f(this._uPickColor,P/255,y/255,b/255,v/255),a.indicesBuf?(r.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),t.drawElements++):a.positions&&r.drawArrays(r.TRIANGLES,0,a.positions.numItems)},Mi.prototype._allocate=function(t){var e=t.scene,i=e.canvas.gl;if(this._program=new zt(i,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=e._sectionPlanesState.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uPickColor=r.getLocation("pickColor"),this._uOffset=r.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastGeometryId=null}},Mi.prototype._bindProgram=function(t){var e=this._scene,i=e.canvas.gl,r=e.camera.project;if(this._program.bind(),t.useProgram++,e.logarithmicDepthBufferEnabled){var s=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,s)}this._lastMaterialId=null,this._lastGeometryId=null};var wi=function(t){this.vertex=function(t){var e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,r=!!t._geometry._state.compressGeometry;t._state.billboard,t._state.stationary;var s=[];s.push("// Surface picking vertex shader"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable");s.push("attribute vec3 position;"),s.push("attribute vec4 color;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform vec3 offset;"),i&&(s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;"));e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;"));s.push("varying vec4 vColor;"),r&&s.push("uniform mat4 positionsDecodeMatrix;");s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),r&&s.push("localPosition = positionsDecodeMatrix * localPosition;");s.push("   vec4 worldPosition = modelMatrix * localPosition; "),s.push("   worldPosition.xyz = worldPosition.xyz + offset;"),s.push("   vec4 viewPosition = viewMatrix * worldPosition;"),i&&s.push("   vWorldPosition = worldPosition;");s.push("   vColor = color;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;")));return s.push("gl_Position = clipPos;"),s.push("}"),s}(t),this.fragment=function(t){var e=t.scene,i=e._sectionPlanesState,r=i.sectionPlanes.length>0,s=[];s.push("// Surface picking fragment shader"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable");s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("varying vec4 vColor;"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;"));if(r){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("void main(void) {"),r){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(var a=0;a<i.sectionPlanes.length;a++)s.push("if (sectionPlaneActive"+a+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");return s.push("   gl_FragColor = vColor;"),s.push("}"),s}(t)};var Ei=E.vec3(),Ci=function(t,e){this._hash=t,this._scene=e.scene,this._useCount=0,this._shaderSource=new wi(e),this._allocate(e)},Ai={};Ci.get=function(t){var e=[t.scene.canvas.canvas.id,t.scene._sectionPlanesState.getHash(),t._geometry._state.compressGeometry?"cp":"",t._state.hash].join(";"),i=Ai[e];if(!i){if((i=new Ci(e,t)).errors)return console.log(i.errors.join("\n")),null;Ai[e]=i,S.memory.programs++}return i._useCount++,i},Ci.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Ai[this._hash],S.memory.programs--)},Ci.prototype.webglContextRestored=function(){this._program=null},Ci.prototype.drawMesh=function(t,e){this._program||this._allocate(e);var i=this._scene,r=i.canvas.gl,s=e._state,o=e._material._state,a=e._geometry,n=e._geometry._state,l=e.rtcCenter,h=o.backfaces,u=o.frontface,c=i.camera.project,p=a._getPickTrianglePositions(),d=a._getPickTriangleColors();if(this._program.bind(),t.useProgram++,i.logarithmicDepthBufferEnabled){var f=2/(Math.log(c.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,f)}if(r.uniformMatrix4fv(this._uViewMatrix,!1,l?t.getRTCPickViewMatrix(s.rtcCenterHash,l):t.pickViewMatrix),s.clippable){var _=i._sectionPlanesState.sectionPlanes.length;if(_>0)for(var g=i._sectionPlanesState.sectionPlanes,m=e.renderFlags,v=0;v<_;v++){var b=this._uSectionPlanes[v];if(b){var y=m.sectionPlanesActivePerLayer[v];if(r.uniform1i(b.active,y?1:0),y){var P=g[v];r.uniform3fv(b.pos,l?at(P.dist,P.dir,l,Ei):P.pos),r.uniform3fv(b.dir,P.dir)}}}}r.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),i.logarithmicDepthBufferEnabled&&r.uniform1f(this._uZFar,i.camera.project.far),t.backfaces!==h&&(h?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),t.backfaces=h),t.frontface!==u&&(u?r.frontFace(r.CCW):r.frontFace(r.CW),t.frontface=u),r.uniformMatrix4fv(this._uModelMatrix,!1,e.worldMatrix),this._uClippable&&r.uniform1i(this._uClippable,e._state.clippable),r.uniform3fv(this._uOffset,e._state.offset),this._uPositionsDecodeMatrix?(r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(p,n.compressGeometry?r.UNSIGNED_SHORT:r.FLOAT)):this._aPosition.bindArrayBuffer(p),d.bind(),r.enableVertexAttribArray(this._aColor.location),r.vertexAttribPointer(this._aColor.location,d.itemSize,d.itemType,!0,0,0),r.drawArrays(n.primitive,0,p.numItems/3)},Ci.prototype._allocate=function(t){var e=t.scene,i=e.canvas.gl;if(this._program=new zt(i,this._shaderSource),this._useCount=0,this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=e._sectionPlanesState.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._uClippable=r.getLocation("clippable"),this._uOffset=r.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}};var Si=function(t){this.vertex=function(t){var e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,r=!!t._geometry._state.compressGeometry,s=t._state.billboard,o=t._state.stationary,a=[];a.push("// Mesh occlusion vertex shader"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec3 offset;"),r&&a.push("uniform mat4 positionsDecodeMatrix;");i&&a.push("varying vec4 vWorldPosition;");e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"));"spherical"!==s&&"cylindrical"!==s||(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===s&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),r&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),o&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==s&&"cylindrical"!==s||(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"));a.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),a.push("   worldPosition.xyz = worldPosition.xyz + offset;"),a.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&a.push("   vWorldPosition = worldPosition;");a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;")));return a.push("gl_Position = clipPos;"),a.push("}"),a}(t),this.fragment=function(t){var e=t.scene,i=e._sectionPlanesState,r=i.sectionPlanes.length>0,s=[];s.push("// Mesh occlusion fragment shader"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable");s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;"));if(r){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("void main(void) {"),r){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(o=0;o<i.sectionPlanes.length;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;");return s.push("}"),s}(t)};var Di=E.vec3(),Li=function(t,e){this._hash=t,this._shaderSource=new Si(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},Bi={};Li.get=function(t){var e=[t.scene.canvas.canvas.id,t.scene._sectionPlanesState.getHash(),t._geometry._state.hash,t._state.hash].join(";"),i=Bi[e];if(!i){if((i=new Li(e,t)).errors)return console.log(i.errors.join("\n")),null;Bi[e]=i,S.memory.programs++}return i._useCount++,i},Li.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Bi[this._hash],S.memory.programs--)},Li.prototype.webglContextRestored=function(){this._program=null},Li.prototype.drawMesh=function(t,e){this._program||this._allocate(e);var i=this._scene,r=i.canvas.gl,s=e._material._state,o=e._state,a=e._geometry._state,n=e.rtcCenter;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),s.id!==this._lastMaterialId){var l=s.backfaces;t.backfaces!==l&&(l?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),t.backfaces=l);var h=s.frontface;t.frontface!==h&&(h?r.frontFace(r.CCW):r.frontFace(r.CW),t.frontface=h),this._lastMaterialId=s.id}var u=i.camera;if(r.uniformMatrix4fv(this._uViewMatrix,!1,n?t.getRTCViewMatrix(o.rtcCenterHash,n):u.viewMatrix),o.clippable){var c=i._sectionPlanesState.sectionPlanes.length;if(c>0)for(var p=i._sectionPlanesState.sectionPlanes,d=e.renderFlags,f=0;f<c;f++){var _=this._uSectionPlanes[f];if(_){var g=d.sectionPlanesActivePerLayer[f];if(r.uniform1i(_.active,g?1:0),g){var m=p[f];r.uniform3fv(_.pos,n?at(m.dist,m.dir,n,Di):m.pos),r.uniform3fv(_.dir,m.dir)}}}}r.uniformMatrix4fv(this._uProjMatrix,!1,u._project._state.matrix),r.uniformMatrix4fv(this._uModelMatrix,r.FALSE,e.worldMatrix),this._uClippable&&r.uniform1i(this._uClippable,e._state.clippable),r.uniform3fv(this._uOffset,e._state.offset),a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.compressGeometry?r.UNSIGNED_SHORT:r.FLOAT),t.bindArray++),a.indicesBuf&&(a.indicesBuf.bind(),t.bindArray++),this._lastGeometryId=a.id),a.indicesBuf?(r.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),t.drawElements++):a.positions&&r.drawArrays(r.TRIANGLES,0,a.positions.numItems)},Li.prototype._allocate=function(t){var e=t.scene,i=e.canvas.gl;if(this._program=new zt(i,this._shaderSource),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=e._sectionPlanesState.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uOffset=r.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},Li.prototype._bindProgram=function(t){var e=this._scene,i=e.camera.project,r=e.canvas.gl;if(this._program.bind(),t.useProgram++,r.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){var s=2/(Math.log(i.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,s)}this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};var Ri=function(t){this.vertex=function(t){var e=t.scene._sectionPlanesState.sectionPlanes.length>0,i=!!t._geometry._state.compressGeometry,r=[];r.push("// Mesh shadow vertex shader"),r.push("attribute vec3 position;"),r.push("uniform mat4 modelMatrix;"),r.push("uniform mat4 shadowViewMatrix;"),r.push("uniform mat4 shadowProjMatrix;"),r.push("uniform vec3 offset;"),i&&r.push("uniform mat4 positionsDecodeMatrix;");e&&r.push("varying vec4 vWorldPosition;");r.push("void main(void) {"),r.push("vec4 localPosition = vec4(position, 1.0); "),r.push("vec4 worldPosition;"),i&&r.push("localPosition = positionsDecodeMatrix * localPosition;");r.push("worldPosition = modelMatrix * localPosition;"),r.push("worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = shadowViewMatrix * worldPosition; "),e&&r.push("vWorldPosition = worldPosition;");return r.push("   gl_Position = shadowProjMatrix * viewPosition;"),r.push("}"),r}(t),this.fragment=function(t){var e=t.scene;e.canvas.gl;var i=e._sectionPlanesState,r=i.sectionPlanes.length>0,s=[];if(s.push("// Mesh shadow fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),r){s.push("uniform bool clippable;"),s.push("varying vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("vec4 encodeFloat( const in float depth ) {"),s.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),s.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),s.push("  vec4 comp = fract(depth * bitShift);"),s.push("  comp -= comp.xxyz * bitMask;"),s.push("  return comp;"),s.push("}"),s.push("void main(void) {"),r){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(o=0;o<i.sectionPlanes.length;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("gl_FragColor = encodeFloat(gl_FragCoord.z);"),s.push("}"),s}(t)};var Ti=function(t,e){this._hash=t,this._shaderSource=new Ri(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},Fi={};Ti.get=function(t){var e=t.scene,i=[e.canvas.canvas.id,e._sectionPlanesState.getHash(),t._geometry._state.hash,t._state.hash].join(";"),r=Fi[i];if(!r){if((r=new Ti(i,t)).errors)return console.log(r.errors.join("\n")),null;Fi[i]=r,S.memory.programs++}return r._useCount++,r},Ti.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Fi[this._hash],S.memory.programs--)},Ti.prototype.webglContextRestored=function(){this._program=null},Ti.prototype.drawMesh=function(t,e){this._program||this._allocate(e);var i=this._scene.canvas.gl,r=e._material._state,s=e._geometry._state;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),r.id!==this._lastMaterialId){var o=r.backfaces;t.backfaces!==o&&(o?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),t.backfaces=o);var a=r.frontface;t.frontface!==a&&(a?i.frontFace(i.CCW):i.frontFace(i.CW),t.frontface=a),t.lineWidth!==r.lineWidth&&(i.lineWidth(r.lineWidth),t.lineWidth=r.lineWidth),this._uPointSize&&i.uniform1i(this._uPointSize,r.pointSize),this._lastMaterialId=r.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,e.worldMatrix),s.combineGeometry){var n=e.vertexBufs;n.id!==this._lastVertexBufsId&&(n.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),t.bindArray++),this._lastVertexBufsId=n.id)}this._uClippable&&i.uniform1i(this._uClippable,e._state.clippable),i.uniform3fv(this._uOffset,e._state.offset),s.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,s.positionsDecodeMatrix),s.combineGeometry?s.indicesBufCombined&&(s.indicesBufCombined.bind(),t.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(s.positionsBuf,s.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),t.bindArray++),s.indicesBuf&&(s.indicesBuf.bind(),t.bindArray++)),this._lastGeometryId=s.id),s.combineGeometry?s.indicesBufCombined&&(i.drawElements(s.primitive,s.indicesBufCombined.numItems,s.indicesBufCombined.itemType,0),t.drawElements++):s.indicesBuf?(i.drawElements(s.primitive,s.indicesBuf.numItems,s.indicesBuf.itemType,0),t.drawElements++):s.positions&&(i.drawArrays(i.TRIANGLES,0,s.positions.numItems),t.drawArrays++)},Ti.prototype._allocate=function(t){var e=t.scene,i=e.canvas.gl;if(this._program=new zt(i,this._shaderSource),this._scene=e,this._useCount=0,this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uShadowViewMatrix=r.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=r.getLocation("shadowProjMatrix"),this._uSectionPlanes={};for(var s=0,o=e._sectionPlanesState.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uOffset=r.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null}},Ti.prototype._bindProgram=function(t){this._program||this._allocate(mesh);var e=this._scene,i=e.canvas.gl,r=e._sectionPlanesState;if(this._program.bind(),t.useProgram++,i.uniformMatrix4fv(this._uShadowViewMatrix,!1,t.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,t.shadowProjMatrix),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,r.sectionPlanes.length>0)for(var s,o,a,n=0,l=this._uSectionPlanes.length;n<l;n++)o=(s=this._uSectionPlanes[n]).active,a=r.sectionPlanes[n],o&&i.uniform1i(o,a.active),s.pos&&i.uniform3fv(s.pos,a.pos),s.dir&&i.uniform3fv(s.dir,a.dir)};var Ni=function(){this.visibleLayers=[],this.sectionPlanesActivePerLayer=[],this.reset()};Ni.prototype.reset=function(){this.culled=!1,this.sectioned=!1,this.numLayers=0,this.numVisibleLayers=0,this.colorOpaque=!1,this.colorTransparent=!1,this.edgesOpaque=!1,this.edgesTransparent=!1,this.xrayedSilhouetteOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedSilhouetteTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedSilhouetteOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedSilhouetteTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedSilhouetteOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedSilhouetteTransparent=!1,this.selectedEdgesTransparent=!1};var Ii=E.OBB3(),ki=E.vec4(),Oi=E.vec4(),Vi=E.vec4(),zi=E.vec3([1,0,0]),Ui=E.vec3([0,1,0]),ji=E.vec3([0,0,1]),Gi=E.vec3(3),Xi=E.vec3(3),Wi=E.identityMat4(),Hi=function(t){function e(e,i){if(void 0===i&&(i={}),t.call(this,e,i),this.originalSystemId=i.originalSystemId||this.id,this.renderFlags=new Ni,this._state=new oe({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!i.stationary,billboard:this._checkBillboard(i.billboard),layer:null,colorize:null,pickID:this.scene._renderer.getPickID(this),drawHash:"",pickHash:"",offset:E.vec3(),rtcCenter:null,rtcCenterHash:null}),this._drawRenderer=null,this._shadowRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._occlusionRenderer=null,this._geometry=i.geometry?this._checkComponent2(["ReadableGeometry","VBOGeometry"],i.geometry):this.scene.geometry,this._material=i.material?this._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],i.material):this.scene.material,this._xrayMaterial=i.xrayMaterial?this._checkComponent("EmphasisMaterial",i.xrayMaterial):this.scene.xrayMaterial,this._highlightMaterial=i.highlightMaterial?this._checkComponent("EmphasisMaterial",i.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=i.selectedMaterial?this._checkComponent("EmphasisMaterial",i.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=i.edgeMaterial?this._checkComponent("EdgeMaterial",i.edgeMaterial):this.scene.edgeMaterial,this._parentNode=null,this._aabb=null,this._aabbDirty=!0,this._numTriangles=this._geometry?this._geometry.numTriangles:0,this.scene._aabbDirty=!0,this._scale=E.vec3(),this._quaternion=E.identityQuaternion(),this._rotation=E.vec3(),this._position=E.vec3(),this._worldMatrix=E.identityMat4(),this._worldNormalMatrix=E.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0,i.rtcCenter&&(this._state.rtcCenter=E.vec3(i.rtcCenter),this._state.rtcCenterHash=i.rtcCenter.join()),i.matrix?this.matrix=i.matrix:(this.scale=i.scale,this.position=i.position,i.quaternion||(this.rotation=i.rotation)),this._isObject=i.isObject,this._isObject&&this.scene._registerObject(this),this._isModel=i.isModel,this._isModel&&this.scene._registerModel(this),this.visible=i.visible,this.culled=i.culled,this.pickable=i.pickable,this.clippable=i.clippable,this.collidable=i.collidable,this.castsShadow=i.castsShadow,this.receivesShadow=i.receivesShadow,this.xrayed=i.xrayed,this.highlighted=i.highlighted,this.selected=i.selected,this.edges=i.edges,this.layer=i.layer,this.colorize=i.colorize,this.opacity=i.opacity,this.offset=i.offset,i.parentId){var r=this.scene.components[i.parentId];r?r.isNode?r.addChild(this):this.error("Parent is not a Node: '"+i.parentId+"'"):this.error("Parent not found: '"+i.parentId+"'"),this._parentNode=r}else i.parent&&(i.parent.isNode||this.error("Parent is not a Node"),i.parent.addChild(this),this._parentNode=i.parent);this.compile()}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},isMesh:{configurable:!0},parent:{configurable:!0},geometry:{configurable:!0},material:{configurable:!0},position:{configurable:!0},rotation:{configurable:!0},quaternion:{configurable:!0},scale:{configurable:!0},matrix:{configurable:!0},worldMatrix:{configurable:!0},worldNormalMatrix:{configurable:!0},isEntity:{configurable:!0},isModel:{configurable:!0},isObject:{configurable:!0},aabb:{configurable:!0},rtcCenter:{configurable:!0},numTriangles:{configurable:!0},visible:{configurable:!0},xrayed:{configurable:!0},highlighted:{configurable:!0},selected:{configurable:!0},edges:{configurable:!0},culled:{configurable:!0},clippable:{configurable:!0},collidable:{configurable:!0},pickable:{configurable:!0},castsShadow:{configurable:!0},receivesShadow:{configurable:!0},saoEnabled:{configurable:!0},colorize:{configurable:!0},opacity:{configurable:!0},transparent:{configurable:!0},layer:{configurable:!0},stationary:{configurable:!0},billboard:{configurable:!0},offset:{configurable:!0},isDrawable:{configurable:!0},isStateSortable:{configurable:!0},xrayMaterial:{configurable:!0},highlightMaterial:{configurable:!0},selectedMaterial:{configurable:!0},edgeMaterial:{configurable:!0}};return i.type.get=function(){return"Mesh"},i.isMesh.get=function(){return!0},i.parent.get=function(){return this._parentNode},e.prototype._checkBillboard=function(t){return"spherical"!==(t=t||"none")&&"cylindrical"!==t&&"none"!==t&&(this.error("Unsupported value for 'billboard': "+t+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),t="none"),t},e.prototype.compile=function(){var t=this._makeDrawHash();this._state.drawHash!==t&&(this._state.drawHash=t,this._putDrawRenderers(),this._drawRenderer=li.get(this),this._emphasisFillRenderer=di.get(this),this._emphasisEdgesRenderer=vi.get(this));var e=this._makePickHash();this._state.pickHash!==e&&(this._state.pickHash=e,this._putPickRenderers(),this._pickMeshRenderer=Mi.get(this));var i=this._makeOcclusionHash();this._state.occlusionHash!==i&&(this._state.occlusionHash=i,this._putOcclusionRenderer(),this._occlusionRenderer=Li.get(this))},e.prototype._setLocalMatrixDirty=function(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()},e.prototype._setWorldMatrixDirty=function(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0},e.prototype._buildWorldMatrix=function(){var t=this.matrix;if(this._parentNode)E.mulMat4(this._parentNode.worldMatrix,t,this._worldMatrix);else for(var e=0,i=t.length;e<i;e++)this._worldMatrix[e]=t[e];this._worldMatrixDirty=!1},e.prototype._buildWorldNormalMatrix=function(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=E.mat4()),E.transposeMat4(this._worldMatrix,this._worldNormalMatrix),E.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1},e.prototype._setAABBDirty=function(){if(this.collidable)for(var t=this;t;t=t._parentNode)t._aabbDirty=!0},e.prototype._updateAABB=function(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=E.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1},e.prototype._webglContextRestored=function(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored()},e.prototype._makeDrawHash=function(){var t=this.scene,e=[t.canvas.canvas.id,(t.gammaInput?"gi;":";")+(t.gammaOutput?"go":""),t._lightsState.getHash(),t._sectionPlanesState.getHash()],i=this._state;return i.stationary&&e.push("/s"),"none"===i.billboard?e.push("/n"):"spherical"===i.billboard?e.push("/s"):"cylindrical"===i.billboard&&e.push("/c"),i.receivesShadow&&e.push("/rs"),e.push(";"),e.join("")},e.prototype._makePickHash=function(){var t=this.scene,e=[t.canvas.canvas.id,t._sectionPlanesState.getHash()],i=this._state;return i.stationary&&e.push("/s"),"none"===i.billboard?e.push("/n"):"spherical"===i.billboard?e.push("/s"):"cylindrical"===i.billboard&&e.push("/c"),e.push(";"),e.join("")},e.prototype._makeOcclusionHash=function(){var t=this.scene,e=[t.canvas.canvas.id,t._sectionPlanesState.getHash()],i=this._state;return i.stationary&&e.push("/s"),"none"===i.billboard?e.push("/n"):"spherical"===i.billboard?e.push("/s"):"cylindrical"===i.billboard&&e.push("/c"),e.push(";"),e.join("")},e.prototype._buildAABB=function(t,e){E.transformOBB3(t,this._geometry.obb,Ii),E.OBB3ToAABB3(Ii,e);var i=this._state.offset;if(e[0]+=i[0],e[1]+=i[1],e[2]+=i[2],e[3]+=i[0],e[4]+=i[1],e[5]+=i[2],this._state.rtcCenter){var r=this._state.rtcCenter;e[0]+=r[0],e[1]+=r[1],e[2]+=r[2],e[3]+=r[0],e[4]+=r[1],e[5]+=r[2]}},i.geometry.get=function(){return this._geometry},i.material.get=function(){return this._material},i.position.set=function(t){this._position.set(t||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()},i.position.get=function(){return this._position},i.rotation.set=function(t){this._rotation.set(t||[0,0,0]),E.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()},i.rotation.get=function(){return this._rotation},i.quaternion.set=function(t){this._quaternion.set(t||[0,0,0,1]),E.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()},i.quaternion.get=function(){return this._quaternion},i.scale.set=function(t){this._scale.set(t||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()},i.scale.get=function(){return this._scale},i.matrix.set=function(t){this.__localMatrix||(this.__localMatrix=E.identityMat4()),this.__localMatrix.set(t||Wi),E.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()},i.matrix.get=function(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=E.identityMat4()),E.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix},i.worldMatrix.get=function(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix},i.worldNormalMatrix.get=function(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix},e.prototype.rotate=function(t,e){return ki[0]=t[0],ki[1]=t[1],ki[2]=t[2],ki[3]=e*E.DEGTORAD,E.angleAxisToQuaternion(ki,Oi),E.mulQuaternions(this.quaternion,Oi,Vi),this.quaternion=Vi,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this},e.prototype.rotateOnWorldAxis=function(t,e){return ki[0]=t[0],ki[1]=t[1],ki[2]=t[2],ki[3]=e*E.DEGTORAD,E.angleAxisToQuaternion(ki,Oi),E.mulQuaternions(Oi,this.quaternion,Oi),this},e.prototype.rotateX=function(t){return this.rotate(zi,t)},e.prototype.rotateY=function(t){return this.rotate(Ui,t)},e.prototype.rotateZ=function(t){return this.rotate(ji,t)},e.prototype.translate=function(t,e){return E.vec3ApplyQuaternion(this.quaternion,t,Gi),E.mulVec3Scalar(Gi,e,Xi),E.addVec3(this.position,Xi,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this},e.prototype.translateX=function(t){return this.translate(zi,t)},e.prototype.translateY=function(t){return this.translate(Ui,t)},e.prototype.translateZ=function(t){return this.translate(ji,t)},e.prototype._putDrawRenderers=function(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null)},e.prototype._putPickRenderers=function(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null)},e.prototype._putOcclusionRenderer=function(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null)},i.isEntity.get=function(){return!0},i.isModel.get=function(){return this._isModel},i.isObject.get=function(){return this._isObject},i.aabb.get=function(){return this._aabbDirty&&this._updateAABB(),this._aabb},i.rtcCenter.set=function(t){t?(this._state.rtcCenter||(this._state.rtcCenter=E.vec3()),this._state.rtcCenter.set(t),this._state.rtcCenterHash=t.join(),this._setAABBDirty(),this.scene._aabbDirty=!0):this._state.rtcCenter&&(this._state.rtcCenter=null,this._state.rtcCenterHash=null,this._setAABBDirty(),this.scene._aabbDirty=!0)},i.rtcCenter.get=function(){return this._state.rtcCenter},i.numTriangles.get=function(){return this._numTriangles},i.visible.set=function(t){t=!1!==t,this._state.visible=t,this._isObject&&this.scene._objectVisibilityUpdated(this),this.glRedraw()},i.visible.get=function(){return this._state.visible},i.xrayed.set=function(t){t=!!t,this._state.xrayed!==t&&(this._state.xrayed=t,this._isObject&&this.scene._objectXRayedUpdated(this),this.glRedraw())},i.xrayed.get=function(){return this._state.xrayed},i.highlighted.set=function(t){(t=!!t)!==this._state.highlighted&&(this._state.highlighted=t,this._isObject&&this.scene._objectHighlightedUpdated(this),this.glRedraw())},i.highlighted.get=function(){return this._state.highlighted},i.selected.set=function(t){(t=!!t)!==this._state.selected&&(this._state.selected=t,this._isObject&&this.scene._objectSelectedUpdated(this),this.glRedraw())},i.selected.get=function(){return this._state.selected},i.edges.set=function(t){(t=!!t)!==this._state.edges&&(this._state.edges=t,this.glRedraw())},i.edges.get=function(){return this._state.edges},i.culled.set=function(t){this._state.culled=!!t,this.glRedraw()},i.culled.get=function(){return this._state.culled},i.clippable.set=function(t){t=!1!==t,this._state.clippable!==t&&(this._state.clippable=t,this.glRedraw())},i.clippable.get=function(){return this._state.clippable},i.collidable.set=function(t){(t=!1!==t)!==this._state.collidable&&(this._state.collidable=t,this._setAABBDirty(),this.scene._aabbDirty=!0)},i.collidable.get=function(){return this._state.collidable},i.pickable.set=function(t){t=!1!==t,this._state.pickable!==t&&(this._state.pickable=t)},i.pickable.get=function(){return this._state.pickable},i.castsShadow.set=function(t){(t=!1!==t)!==this._state.castsShadow&&(this._state.castsShadow=t,this.glRedraw())},i.castsShadow.get=function(){return this._state.castsShadow},i.receivesShadow.set=function(t){(t=!1!==t)!==this._state.receivesShadow&&(this._state.receivesShadow=t,this._state.hash=t?"/mod/rs;":"/mod;",this.fire("dirty",this))},i.receivesShadow.get=function(){return this._state.receivesShadow},i.saoEnabled.get=function(){return!1},i.colorize.set=function(t){var e=this._state.colorize;e||((e=this._state.colorize=new Float32Array(4))[3]=1),t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1);var i=!!t;this.scene._objectColorizeUpdated(this,i),this.glRedraw()},i.colorize.get=function(){return this._state.colorize},i.opacity.set=function(t){var e=this._state.colorize;e||((e=this._state.colorize=new Float32Array(4))[0]=1,e[1]=1,e[2]=1);var i=null!=t;e[3]=i?t:1,this.scene._objectOpacityUpdated(this,i),this.glRedraw()},i.opacity.get=function(){return this._state.colorize[3]},i.transparent.get=function(){return 2===this._material.alphaMode||this._state.colorize[3]<1},i.layer.set=function(t){t=t||0,(t=Math.round(t))!==this._state.layer&&(this._state.layer=t,this._renderer.needStateSort())},i.layer.get=function(){return this._state.layer},i.stationary.get=function(){return this._state.stationary},i.billboard.get=function(){return this._state.billboard},i.offset.set=function(t){this._state.offset.set(t||[0,0,0]),this._setAABBDirty(),this.glRedraw()},i.offset.get=function(){return this._state.offset},i.isDrawable.get=function(){return!0},i.isStateSortable.get=function(){return!0},e.prototype.stateSortCompare=function(t,e){return t._state.layer-e._state.layer||t._drawRenderer.id-e._drawRenderer.id||t._material._state.id-e._material._state.id||t._geometry._state.id-e._geometry._state.id},e.prototype.rebuildRenderFlags=function(){this.renderFlags.reset(),this._getActiveSectionPlanes()?(this.renderFlags.numLayers=1,this.renderFlags.numVisibleLayers=1,this.renderFlags.visibleLayers[0]=0,this._updateRenderFlags()):this.renderFlags.culled=!0},e.prototype._updateRenderFlags=function(){var t=this.renderFlags,e=this._state;if(e.xrayed){var i=this._xrayMaterial._state;i.fill&&(i.fillAlpha<1?t.xrayedSilhouetteTransparent=!0:t.xrayedSilhouetteOpaque=!0),i.edges&&(i.edgeAlpha<1?t.xrayedEdgesTransparent=!0:t.xrayedEdgesOpaque=!0)}else{if(this._material._state.alpha<1||e.colorize[3]<1?t.colorTransparent=!0:t.colorOpaque=!0,e.edges)this._edgeMaterial._state.alpha<1?t.edgesTransparent=!0:t.edgesOpaque=!0;if(e.selected){var r=this._selectedMaterial._state;r.fill&&(r.fillAlpha<1?t.selectedSilhouetteTransparent=!0:t.selectedSilhouetteOpaque=!0),r.edges&&(r.edgeAlpha<1?t.selectedEdgesTransparent=!0:t.selectedEdgesOpaque=!0)}else if(e.highlighted){var s=this._highlightMaterial._state;s.fill&&(s.fillAlpha<1?t.highlightedSilhouetteTransparent=!0:t.highlightedSilhouetteOpaque=!0),s.edges&&(s.edgeAlpha<1?t.highlightedEdgesTransparent=!0:t.highlightedEdgesOpaque=!0)}}},e.prototype._getActiveSectionPlanes=function(){if(this._state.clippable){var t=this.scene._sectionPlanesState.sectionPlanes,e=t.length;if(e>0)for(var i=0;i<e;i++){var r=t[i],s=this.renderFlags;if(r.active)if(this._state.rtcCenter){var o=E.planeAABB3Intersect(r.dir,r.dist,this.aabb);if(-1===o)return!1;var a=0===o;s.sectionPlanesActivePerLayer[i]=a}else s.sectionPlanesActivePerLayer[i]=!0;else s.sectionPlanesActivePerLayer[i]=!1}}return!0},i.xrayMaterial.get=function(){return this._xrayMaterial},i.highlightMaterial.get=function(){return this._highlightMaterial},i.selectedMaterial.get=function(){return this._selectedMaterial},i.edgeMaterial.get=function(){return this._edgeMaterial},e.prototype.drawColorOpaque=function(t){(this._drawRenderer||(this._drawRenderer=li.get(this)))&&this._drawRenderer.drawMesh(t,this)},e.prototype.drawColorTransparent=function(t){(this._drawRenderer||(this._drawRenderer=li.get(this)))&&this._drawRenderer.drawMesh(t,this)},e.prototype.drawSilhouetteXRayed=function(t){(this._emphasisFillRenderer||(this._emphasisFillRenderer=di.get(this)))&&this._emphasisFillRenderer.drawMesh(t,this,0)},e.prototype.drawSilhouetteHighlighted=function(t){(this._emphasisFillRenderer||(this._emphasisFillRenderer=di.get(this)))&&this._emphasisFillRenderer.drawMesh(t,this,1)},e.prototype.drawSilhouetteSelected=function(t){(this._emphasisFillRenderer||(this._emphasisFillRenderer=di.get(this)))&&this._emphasisFillRenderer.drawMesh(t,this,2)},e.prototype.drawEdgesColorOpaque=function(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,3)},e.prototype.drawEdgesColorTransparent=function(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,3)},e.prototype.drawEdgesXRayed=function(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,0)},e.prototype.drawEdgesHighlighted=function(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,1)},e.prototype.drawEdgesSelected=function(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,2)},e.prototype.drawOcclusion=function(t){(this._occlusionRenderer||(this._occlusionRenderer=Li.get(this)))&&this._occlusionRenderer.drawMesh(t,this)},e.prototype.drawShadow=function(t){(this._shadowRenderer||(this._shadowRenderer=Ti.get(this)))&&this._shadowRenderer.drawMesh(t,this)},e.prototype.drawPickMesh=function(t){(this._pickMeshRenderer||(this._pickMeshRenderer=Mi.get(this)))&&this._pickMeshRenderer.drawMesh(t,this)},e.prototype.canPickTriangle=function(){return this._geometry.isReadableGeometry},e.prototype.drawPickTriangles=function(t){(this._pickTriangleRenderer||(this._pickTriangleRenderer=Ci.get(this)))&&this._pickTriangleRenderer.drawMesh(t,this)},e.prototype.pickTriangleSurface=function(t,e,i){Yi(this,t,e,i)},e.prototype.drawPickVertices=function(t){},e.prototype.delegatePickedEntity=function(){return this},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw()},Object.defineProperties(e.prototype,i),e}(U),Yi=function(){var t=E.vec3(),e=E.vec3(),i=E.vec3(),r=E.vec3(),s=E.vec3(),o=E.vec3(),a=E.vec4(),n=E.vec3(),l=E.vec3(),h=E.vec3(),u=E.vec3(),c=E.vec3(),p=E.vec3(),d=E.vec3(),f=E.vec3(),_=E.vec3(),g=E.vec4(),m=E.vec4(),v=E.vec4(),b=E.vec3(),y=E.vec3(),P=E.vec3(),M=E.vec3(),x=E.vec3(),w=E.vec3(),C=E.vec3(),A=E.vec3(),S=E.vec3(),D=E.vec3(),L=E.vec3();return function(B,R,T,F){var N=F.primIndex;if(null!=N&&N>-1){var I=B.geometry._state,k=B.scene,O=k.camera,V=k.canvas;if("triangles"===I.primitiveName){F.primitive="triangle";var z,U,j,G,X=N,W=I.indices,H=I.positions;if(W){var Y=W[X+0],K=W[X+1],q=W[X+2];o[0]=Y,o[1]=K,o[2]=q,F.indices=o,z=3*Y,U=3*K,j=3*q}else j=(U=(z=3*X)+3)+3;if(i[0]=H[z+0],i[1]=H[z+1],i[2]=H[z+2],r[0]=H[U+0],r[1]=H[U+1],r[2]=H[U+2],s[0]=H[j+0],s[1]=H[j+1],s[2]=H[j+2],I.compressGeometry){var Z=I.positionsDecodeMatrix;Z&&(Re.decompressPosition(i,Z,i),Re.decompressPosition(r,Z,r),Re.decompressPosition(s,Z,s))}F.canvasPos?(G=F.canvasPos,E.canvasPosToLocalRay(V.canvas,R,T,B.worldMatrix,G,t,e)):F.origin&&F.direction&&E.worldRayToLocalRay(B.worldMatrix,F.origin,F.direction,t,e),E.normalizeVec3(e),E.rayPlaneIntersect(t,e,i,r,s,a),F.localPos=a,F.position=a,g[0]=a[0],g[1]=a[1],g[2]=a[2],g[3]=1,E.transformVec4(B.worldMatrix,g,m),n[0]=m[0],n[1]=m[1],n[2]=m[2],F.worldPos=n,E.transformVec4(O.matrix,m,v),l[0]=v[0],l[1]=v[1],l[2]=v[2],F.viewPos=l,E.cartesianToBarycentric(a,i,r,s,h),F.bary=h;var Q=I.normals;if(Q){if(I.compressGeometry){var J=3*Y,$=3*K,tt=3*q;Re.decompressNormal(Q.subarray(J,J+2),u),Re.decompressNormal(Q.subarray($,$+2),c),Re.decompressNormal(Q.subarray(tt,tt+2),p)}else u[0]=Q[z],u[1]=Q[z+1],u[2]=Q[z+2],c[0]=Q[U],c[1]=Q[U+1],c[2]=Q[U+2],p[0]=Q[j],p[1]=Q[j+1],p[2]=Q[j+2];var et=E.addVec3(E.addVec3(E.mulVec3Scalar(u,h[0],b),E.mulVec3Scalar(c,h[1],y),P),E.mulVec3Scalar(p,h[2],M),x);F.worldNormal=E.normalizeVec3(E.transformVec3(B.worldNormalMatrix,et,w))}var it=I.uv;if(it){if(d[0]=it[2*Y],d[1]=it[2*Y+1],f[0]=it[2*K],f[1]=it[2*K+1],_[0]=it[2*q],_[1]=it[2*q+1],I.compressGeometry){var rt=I.uvDecodeMatrix;rt&&(Re.decompressUV(d,rt,d),Re.decompressUV(f,rt,f),Re.decompressUV(_,rt,_))}F.uv=E.addVec3(E.addVec3(E.mulVec2Scalar(d,h[0],C),E.mulVec2Scalar(f,h[1],A),S),E.mulVec2Scalar(_,h[2],D),L)}}}}}();function Ki(t){void 0===t&&(t={});var e=t.radiusTop||1;e<0&&(console.error("negative radiusTop not allowed - will invert"),e*=-1);var i=t.radiusBottom||1;i<0&&(console.error("negative radiusBottom not allowed - will invert"),i*=-1);var r=t.height||1;r<0&&(console.error("negative height not allowed - will invert"),r*=-1);var s=t.radialSegments||32;s<0&&(console.error("negative radialSegments not allowed - will invert"),s*=-1),s<3&&(s=3);var o=t.heightSegments||1;o<0&&(console.error("negative heightSegments not allowed - will invert"),o*=-1),o<1&&(o=1);var a,n,l,h,u,c,p,d,f,_,g,m=!!t.openEnded,v=t.center,b=v?v[0]:0,y=v?v[1]:0,P=v?v[2]:0,M=r/2,x=r/o,w=2*Math.PI/s,E=1/s,C=(e-i)/o,A=[],S=[],D=[],L=[],R=(90-180*Math.atan(r/(i-e))/Math.PI)/90;for(a=0;a<=o;a++)for(u=e-a*C,c=M-a*x,n=0;n<=s;n++)l=Math.sin(n*w),h=Math.cos(n*w),S.push(u*l),S.push(R),S.push(u*h),D.push(n*E),D.push(1*a/o),A.push(u*l+b),A.push(c+y),A.push(u*h+P);for(a=0;a<o;a++)for(n=0;n<=s;n++)d=(p=a*(s+1)+n)+s,L.push(p),L.push(d),L.push(d+1),L.push(p),L.push(d+1),L.push(p+1);if(!m&&e>0){for(f=A.length/3,S.push(0),S.push(1),S.push(0),D.push(.5),D.push(.5),A.push(0+b),A.push(M+y),A.push(0+P),n=0;n<=s;n++)l=Math.sin(n*w),h=Math.cos(n*w),_=.5*Math.sin(n*w)+.5,g=.5*Math.cos(n*w)+.5,S.push(e*l),S.push(1),S.push(e*h),D.push(_),D.push(g),A.push(e*l+b),A.push(M+y),A.push(e*h+P);for(n=0;n<s;n++)v=f,p=f+1+n,L.push(p),L.push(p+1),L.push(v)}if(!m&&i>0){for(f=A.length/3,S.push(0),S.push(-1),S.push(0),D.push(.5),D.push(.5),A.push(0+b),A.push(0-M+y),A.push(0+P),n=0;n<=s;n++)l=Math.sin(n*w),h=Math.cos(n*w),_=.5*Math.sin(n*w)+.5,g=.5*Math.cos(n*w)+.5,S.push(i*l),S.push(-1),S.push(i*h),D.push(_),D.push(g),A.push(i*l+b),A.push(0-M+y),A.push(i*h+P);for(n=0;n<s;n++)v=f,p=f+1+n,L.push(v),L.push(p+1),L.push(p)}return B.apply(t,{positions:A,normals:S,uv:D,indices:L})}function qi(t){void 0===t&&(t={});var e=t.lod||1,i=t.center?t.center[0]:0,r=t.center?t.center[1]:0,s=t.center?t.center[2]:0,o=t.radius||1;o<0&&(console.error("negative radius not allowed - will invert"),o*=-1);var a=t.heightSegments||18;a<0&&(console.error("negative heightSegments not allowed - will invert"),a*=-1),(a=Math.floor(e*a))<18&&(a=18);var n=t.widthSegments||18;n<0&&(console.error("negative widthSegments not allowed - will invert"),n*=-1),(n=Math.floor(e*n))<18&&(n=18);var l,h,u,c,p,d,f,_,g,m,v,b,y,P,M=[],x=[],w=[],E=[];for(l=0;l<=a;l++)for(u=l*Math.PI/a,c=Math.sin(u),p=Math.cos(u),h=0;h<=n;h++)d=2*h*Math.PI/n,f=Math.sin(d),_=Math.cos(d)*c,g=p,m=f*c,v=1-h/n,b=l/a,x.push(_),x.push(g),x.push(m),w.push(v),w.push(b),M.push(i+o*_),M.push(r+o*g),M.push(s+o*m);for(l=0;l<a;l++)for(h=0;h<n;h++)P=(y=l*(n+1)+h)+n+1,E.push(y+1),E.push(P+1),E.push(P),E.push(y+1),E.push(P),E.push(y);return B.apply(t,{positions:M,normals:x,uv:w,indices:E})}var Zi={" ":{width:16,points:[]},"!":{width:10,points:[[5,21],[5,7],[-1,-1],[5,2],[4,1],[5,0],[6,1],[5,2]]},'"':{width:16,points:[[4,21],[4,14],[-1,-1],[12,21],[12,14]]},"#":{width:21,points:[[11,25],[4,-7],[-1,-1],[17,25],[10,-7],[-1,-1],[4,12],[18,12],[-1,-1],[3,6],[17,6]]},$:{width:20,points:[[8,25],[8,-4],[-1,-1],[12,25],[12,-4],[-1,-1],[17,18],[15,20],[12,21],[8,21],[5,20],[3,18],[3,16],[4,14],[5,13],[7,12],[13,10],[15,9],[16,8],[17,6],[17,3],[15,1],[12,0],[8,0],[5,1],[3,3]]},"%":{width:24,points:[[21,21],[3,0],[-1,-1],[8,21],[10,19],[10,17],[9,15],[7,14],[5,14],[3,16],[3,18],[4,20],[6,21],[8,21],[10,20],[13,19],[16,19],[19,20],[21,21],[-1,-1],[17,7],[15,6],[14,4],[14,2],[16,0],[18,0],[20,1],[21,3],[21,5],[19,7],[17,7]]},"&":{width:26,points:[[23,12],[23,13],[22,14],[21,14],[20,13],[19,11],[17,6],[15,3],[13,1],[11,0],[7,0],[5,1],[4,2],[3,4],[3,6],[4,8],[5,9],[12,13],[13,14],[14,16],[14,18],[13,20],[11,21],[9,20],[8,18],[8,16],[9,13],[11,10],[16,3],[18,1],[20,0],[22,0],[23,1],[23,2]]},"'":{width:10,points:[[5,19],[4,20],[5,21],[6,20],[6,18],[5,16],[4,15]]},"(":{width:14,points:[[11,25],[9,23],[7,20],[5,16],[4,11],[4,7],[5,2],[7,-2],[9,-5],[11,-7]]},")":{width:14,points:[[3,25],[5,23],[7,20],[9,16],[10,11],[10,7],[9,2],[7,-2],[5,-5],[3,-7]]},"*":{width:16,points:[[8,21],[8,9],[-1,-1],[3,18],[13,12],[-1,-1],[13,18],[3,12]]},"+":{width:26,points:[[13,18],[13,0],[-1,-1],[4,9],[22,9]]},",":{width:10,points:[[6,1],[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},"-":{width:26,points:[[4,9],[22,9]]},".":{width:10,points:[[5,2],[4,1],[5,0],[6,1],[5,2]]},"/":{width:22,points:[[20,25],[2,-7]]},0:{width:20,points:[[9,21],[6,20],[4,17],[3,12],[3,9],[4,4],[6,1],[9,0],[11,0],[14,1],[16,4],[17,9],[17,12],[16,17],[14,20],[11,21],[9,21]]},1:{width:20,points:[[6,17],[8,18],[11,21],[11,0]]},2:{width:20,points:[[4,16],[4,17],[5,19],[6,20],[8,21],[12,21],[14,20],[15,19],[16,17],[16,15],[15,13],[13,10],[3,0],[17,0]]},3:{width:20,points:[[5,21],[16,21],[10,13],[13,13],[15,12],[16,11],[17,8],[17,6],[16,3],[14,1],[11,0],[8,0],[5,1],[4,2],[3,4]]},4:{width:20,points:[[13,21],[3,7],[18,7],[-1,-1],[13,21],[13,0]]},5:{width:20,points:[[15,21],[5,21],[4,12],[5,13],[8,14],[11,14],[14,13],[16,11],[17,8],[17,6],[16,3],[14,1],[11,0],[8,0],[5,1],[4,2],[3,4]]},6:{width:20,points:[[16,18],[15,20],[12,21],[10,21],[7,20],[5,17],[4,12],[4,7],[5,3],[7,1],[10,0],[11,0],[14,1],[16,3],[17,6],[17,7],[16,10],[14,12],[11,13],[10,13],[7,12],[5,10],[4,7]]},7:{width:20,points:[[17,21],[7,0],[-1,-1],[3,21],[17,21]]},8:{width:20,points:[[8,21],[5,20],[4,18],[4,16],[5,14],[7,13],[11,12],[14,11],[16,9],[17,7],[17,4],[16,2],[15,1],[12,0],[8,0],[5,1],[4,2],[3,4],[3,7],[4,9],[6,11],[9,12],[13,13],[15,14],[16,16],[16,18],[15,20],[12,21],[8,21]]},9:{width:20,points:[[16,14],[15,11],[13,9],[10,8],[9,8],[6,9],[4,11],[3,14],[3,15],[4,18],[6,20],[9,21],[10,21],[13,20],[15,18],[16,14],[16,9],[15,4],[13,1],[10,0],[8,0],[5,1],[4,3]]},":":{width:10,points:[[5,14],[4,13],[5,12],[6,13],[5,14],[-1,-1],[5,2],[4,1],[5,0],[6,1],[5,2]]},";":{width:10,points:[[5,14],[4,13],[5,12],[6,13],[5,14],[-1,-1],[6,1],[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},"<":{width:24,points:[[20,18],[4,9],[20,0]]},"=":{width:26,points:[[4,12],[22,12],[-1,-1],[4,6],[22,6]]},">":{width:24,points:[[4,18],[20,9],[4,0]]},"?":{width:18,points:[[3,16],[3,17],[4,19],[5,20],[7,21],[11,21],[13,20],[14,19],[15,17],[15,15],[14,13],[13,12],[9,10],[9,7],[-1,-1],[9,2],[8,1],[9,0],[10,1],[9,2]]},"@":{width:27,points:[[18,13],[17,15],[15,16],[12,16],[10,15],[9,14],[8,11],[8,8],[9,6],[11,5],[14,5],[16,6],[17,8],[-1,-1],[12,16],[10,14],[9,11],[9,8],[10,6],[11,5],[-1,-1],[18,16],[17,8],[17,6],[19,5],[21,5],[23,7],[24,10],[24,12],[23,15],[22,17],[20,19],[18,20],[15,21],[12,21],[9,20],[7,19],[5,17],[4,15],[3,12],[3,9],[4,6],[5,4],[7,2],[9,1],[12,0],[15,0],[18,1],[20,2],[21,3],[-1,-1],[19,16],[18,8],[18,6],[19,5]]},A:{width:18,points:[[9,21],[1,0],[-1,-1],[9,21],[17,0],[-1,-1],[4,7],[14,7]]},B:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,15],[17,13],[16,12],[13,11],[-1,-1],[4,11],[13,11],[16,10],[17,9],[18,7],[18,4],[17,2],[16,1],[13,0],[4,0]]},C:{width:21,points:[[18,16],[17,18],[15,20],[13,21],[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5]]},D:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[11,21],[14,20],[16,18],[17,16],[18,13],[18,8],[17,5],[16,3],[14,1],[11,0],[4,0]]},E:{width:19,points:[[4,21],[4,0],[-1,-1],[4,21],[17,21],[-1,-1],[4,11],[12,11],[-1,-1],[4,0],[17,0]]},F:{width:18,points:[[4,21],[4,0],[-1,-1],[4,21],[17,21],[-1,-1],[4,11],[12,11]]},G:{width:21,points:[[18,16],[17,18],[15,20],[13,21],[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[18,8],[-1,-1],[13,8],[18,8]]},H:{width:22,points:[[4,21],[4,0],[-1,-1],[18,21],[18,0],[-1,-1],[4,11],[18,11]]},I:{width:8,points:[[4,21],[4,0]]},J:{width:16,points:[[12,21],[12,5],[11,2],[10,1],[8,0],[6,0],[4,1],[3,2],[2,5],[2,7]]},K:{width:21,points:[[4,21],[4,0],[-1,-1],[18,21],[4,7],[-1,-1],[9,12],[18,0]]},L:{width:17,points:[[4,21],[4,0],[-1,-1],[4,0],[16,0]]},M:{width:24,points:[[4,21],[4,0],[-1,-1],[4,21],[12,0],[-1,-1],[20,21],[12,0],[-1,-1],[20,21],[20,0]]},N:{width:22,points:[[4,21],[4,0],[-1,-1],[4,21],[18,0],[-1,-1],[18,21],[18,0]]},O:{width:22,points:[[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[19,8],[19,13],[18,16],[17,18],[15,20],[13,21],[9,21]]},P:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,14],[17,12],[16,11],[13,10],[4,10]]},Q:{width:22,points:[[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[19,8],[19,13],[18,16],[17,18],[15,20],[13,21],[9,21],[-1,-1],[12,4],[18,-2]]},R:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,15],[17,13],[16,12],[13,11],[4,11],[-1,-1],[11,11],[18,0]]},S:{width:20,points:[[17,18],[15,20],[12,21],[8,21],[5,20],[3,18],[3,16],[4,14],[5,13],[7,12],[13,10],[15,9],[16,8],[17,6],[17,3],[15,1],[12,0],[8,0],[5,1],[3,3]]},T:{width:16,points:[[8,21],[8,0],[-1,-1],[1,21],[15,21]]},U:{width:22,points:[[4,21],[4,6],[5,3],[7,1],[10,0],[12,0],[15,1],[17,3],[18,6],[18,21]]},V:{width:18,points:[[1,21],[9,0],[-1,-1],[17,21],[9,0]]},W:{width:24,points:[[2,21],[7,0],[-1,-1],[12,21],[7,0],[-1,-1],[12,21],[17,0],[-1,-1],[22,21],[17,0]]},X:{width:20,points:[[3,21],[17,0],[-1,-1],[17,21],[3,0]]},Y:{width:18,points:[[1,21],[9,11],[9,0],[-1,-1],[17,21],[9,11]]},Z:{width:20,points:[[17,21],[3,0],[-1,-1],[3,21],[17,21],[-1,-1],[3,0],[17,0]]},"[":{width:14,points:[[4,25],[4,-7],[-1,-1],[5,25],[5,-7],[-1,-1],[4,25],[11,25],[-1,-1],[4,-7],[11,-7]]},"\\":{width:14,points:[[0,21],[14,-3]]},"]":{width:14,points:[[9,25],[9,-7],[-1,-1],[10,25],[10,-7],[-1,-1],[3,25],[10,25],[-1,-1],[3,-7],[10,-7]]},"^":{width:16,points:[[6,15],[8,18],[10,15],[-1,-1],[3,12],[8,17],[13,12],[-1,-1],[8,17],[8,0]]},_:{width:16,points:[[0,-2],[16,-2]]},"`":{width:10,points:[[6,21],[5,20],[4,18],[4,16],[5,15],[6,16],[5,17]]},a:{width:19,points:[[15,14],[15,0],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},b:{width:19,points:[[4,21],[4,0],[-1,-1],[4,11],[6,13],[8,14],[11,14],[13,13],[15,11],[16,8],[16,6],[15,3],[13,1],[11,0],[8,0],[6,1],[4,3]]},c:{width:18,points:[[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},d:{width:19,points:[[15,21],[15,0],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},e:{width:18,points:[[3,8],[15,8],[15,10],[14,12],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},f:{width:12,points:[[10,21],[8,21],[6,20],[5,17],[5,0],[-1,-1],[2,14],[9,14]]},g:{width:19,points:[[15,14],[15,-2],[14,-5],[13,-6],[11,-7],[8,-7],[6,-6],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},h:{width:19,points:[[4,21],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0]]},i:{width:8,points:[[3,21],[4,20],[5,21],[4,22],[3,21],[-1,-1],[4,14],[4,0]]},j:{width:10,points:[[5,21],[6,20],[7,21],[6,22],[5,21],[-1,-1],[6,14],[6,-3],[5,-6],[3,-7],[1,-7]]},k:{width:17,points:[[4,21],[4,0],[-1,-1],[14,14],[4,4],[-1,-1],[8,8],[15,0]]},l:{width:8,points:[[4,21],[4,0]]},m:{width:30,points:[[4,14],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0],[-1,-1],[15,10],[18,13],[20,14],[23,14],[25,13],[26,10],[26,0]]},n:{width:19,points:[[4,14],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0]]},o:{width:19,points:[[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3],[16,6],[16,8],[15,11],[13,13],[11,14],[8,14]]},p:{width:19,points:[[4,14],[4,-7],[-1,-1],[4,11],[6,13],[8,14],[11,14],[13,13],[15,11],[16,8],[16,6],[15,3],[13,1],[11,0],[8,0],[6,1],[4,3]]},q:{width:19,points:[[15,14],[15,-7],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},r:{width:13,points:[[4,14],[4,0],[-1,-1],[4,8],[5,11],[7,13],[9,14],[12,14]]},s:{width:17,points:[[14,11],[13,13],[10,14],[7,14],[4,13],[3,11],[4,9],[6,8],[11,7],[13,6],[14,4],[14,3],[13,1],[10,0],[7,0],[4,1],[3,3]]},t:{width:12,points:[[5,21],[5,4],[6,1],[8,0],[10,0],[-1,-1],[2,14],[9,14]]},u:{width:19,points:[[4,14],[4,4],[5,1],[7,0],[10,0],[12,1],[15,4],[-1,-1],[15,14],[15,0]]},v:{width:16,points:[[2,14],[8,0],[-1,-1],[14,14],[8,0]]},w:{width:22,points:[[3,14],[7,0],[-1,-1],[11,14],[7,0],[-1,-1],[11,14],[15,0],[-1,-1],[19,14],[15,0]]},x:{width:17,points:[[3,14],[14,0],[-1,-1],[14,14],[3,0]]},y:{width:16,points:[[2,14],[8,0],[-1,-1],[14,14],[8,0],[6,-4],[4,-6],[2,-7],[1,-7]]},z:{width:17,points:[[14,14],[3,0],[-1,-1],[3,14],[14,14],[-1,-1],[3,0],[14,0]]},"{":{width:14,points:[[9,25],[7,24],[6,23],[5,21],[5,19],[6,17],[7,16],[8,14],[8,12],[6,10],[-1,-1],[7,24],[6,22],[6,20],[7,18],[8,17],[9,15],[9,13],[8,11],[4,9],[8,7],[9,5],[9,3],[8,1],[7,0],[6,-2],[6,-4],[7,-6],[-1,-1],[6,8],[8,6],[8,4],[7,2],[6,1],[5,-1],[5,-3],[6,-5],[7,-6],[9,-7]]},"|":{width:8,points:[[4,25],[4,-7]]},"}":{width:14,points:[[5,25],[7,24],[8,23],[9,21],[9,19],[8,17],[7,16],[6,14],[6,12],[8,10],[-1,-1],[7,24],[8,22],[8,20],[7,18],[6,17],[5,15],[5,13],[6,11],[10,9],[6,7],[5,5],[5,3],[6,1],[7,0],[8,-2],[8,-4],[7,-6],[-1,-1],[8,8],[6,6],[6,4],[7,2],[8,1],[9,-1],[9,-3],[8,-5],[7,-6],[5,-7]]},"~":{width:24,points:[[3,6],[3,8],[4,11],[6,12],[8,12],[10,11],[14,8],[16,7],[18,7],[20,8],[21,10],[-1,-1],[3,8],[4,10],[6,11],[8,11],[10,10],[14,7],[16,6],[18,6],[20,7],[21,10],[21,12]]}};function Qi(t){void 0===t&&(t={});var e=t.origin||[0,0,0],i=e[0],r=e[1],s=e[2],o=t.size||1,a=[],n=[],l=t.text;B.isNumeric(l)&&(l=""+l);for(var h,u,c,p,d,f,_,g,m,v=(l||"").split("\n"),b=0,y=0,P=.04,M=0;M<v.length;M++){h=0,c=(u=v[M]).length;for(var x=0;x<c;x++)if(p=Zi[u.charAt(x)]){d=1,f=-1,_=-1,g=p.points.length;for(var w=0;w<g;w++)-1!==(m=p.points[w])[0]||-1!==m[1]?(a.push(h+m[0]*o*P+i),a.push(y+m[1]*o*P+r),a.push(0+s),-1===f?f=b:(-1===_||(f=_),_=b),b++,d?d=!1:(n.push(f),n.push(_))):d=1;h+=p.width*P*o}y-=35*P*o}return B.apply(t,{primitive:"lines",positions:a,indices:n})}var Ji=function(t){function e(e,i){i=i||{},t.call(this,"AxisGizmo",e,i);var r=e.scene.camera;i.canvasId||i.canvasElement||this.error("Config expected: either 'canvasId' or 'canvasElement'");try{this._axisGizmoScene=new ei(e,{canvasId:i.canvasId,canvasElement:i.canvasElement,transparent:!0})}catch(t){return void this.error(t)}var s=this._axisGizmoScene;s.clearLights(),new Ce(s,{color:[.45,.45,.5],intensity:.9}),new Ee(s,{dir:[-.5,.5,-.6],color:[.8,.8,.7],intensity:1,space:"view"}),new Ee(s,{dir:[.5,-.5,-.6],color:[.8,.8,.8],intensity:1,space:"view"});var o=s.camera;r.on("matrix",(function(){var t=r.eye,e=r.look,i=r.up,s=E.mulVec3Scalar(E.normalizeVec3(E.subVec3(t,e,[])),22);o.look=[0,0,0],o.eye=s,o.up=i}));var a=new ke(s,Ki({radiusTop:.01,radiusBottom:.6,height:1.7,radialSegments:20,heightSegments:1,openEnded:!1})),n=new ke(s,Ki({radiusTop:.2,radiusBottom:.2,height:4.5,radialSegments:20,heightSegments:1,openEnded:!1})),l=new je(s,{diffuse:[1,.3,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),h=new je(s,{emissive:[1,.3,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),u=new je(s,{diffuse:[.3,1,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),c=new je(s,{emissive:[.3,1,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),p=new je(s,{diffuse:[.3,.3,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),d=new je(s,{emissive:[.3,.3,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),f=new je(s,{diffuse:[.5,.5,.5],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2});this._meshes=[new Hi(s,{geometry:new ke(s,qi({radius:9,heightSegments:60,widthSegments:60})),material:new je(s,{diffuse:[0,0,0],emissive:[.1,.1,.1],ambient:[.1,.1,.2],specular:[0,0,0],alpha:.4,alphaMode:"blend",frontface:"cw"}),pickable:!1,collidable:!1,visible:!1!==i.visible}),new Hi(s,{geometry:new ke(s,qi({radius:1})),material:f,pickable:!1,collidable:!1,visible:!1!==i.visible}),new Hi(s,{geometry:a,material:l,pickable:!1,collidable:!1,visible:!1!==i.visible,position:[5,0,0],rotation:[0,0,-90]}),new Hi(s,{geometry:n,material:l,pickable:!1,collidable:!1,visible:!1!==i.visible,position:[2,0,0],rotation:[0,0,90]}),new Hi(s,{geometry:new ke(s,Qi({text:"X",size:1.5})),material:h,pickable:!1,collidable:!1,visible:!1!==i.visible,position:[7,0,0],billboard:"spherical"}),new Hi(s,{geometry:a,material:u,pickable:!1,collidable:!1,visible:!1!==i.visible,position:[0,5,0]}),new Hi(s,{geometry:n,material:u,pickable:!1,collidable:!1,visible:!1!==i.visible,position:[0,2,0]}),new Hi(s,{geometry:new ke(s,Qi({text:"Y",size:1.5})),material:c,pickable:!1,collidable:!1,visible:!1!==i.visible,position:[0,7,0],billboard:"spherical"}),new Hi(s,{geometry:a,material:p,pickable:!1,collidable:!1,visible:!1!==i.visible,position:[0,0,5],rotation:[90,0,0]}),new Hi(s,{geometry:n,material:p,pickable:!1,collidable:!1,visible:!1!==i.visible,position:[0,0,2],rotation:[90,0,0]}),new Hi(s,{geometry:new ke(s,Qi({text:"Z",size:1.5})),material:d,pickable:!1,collidable:!1,visible:!1!==i.visible,position:[0,0,7],billboard:"spherical"})]}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setVisible=function(t){for(var e=0;e<this._meshes.length;e++)this._meshes[e].visible=t},e.prototype.destroy=function(){this._axisGizmoCanvas=null,this._axisGizmoScene.destroy(),this._axisGizmoScene=null,t.prototype.destroy.call(this)},e}(n),$i=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({active:!0,pos:E.vec3(),dir:E.vec3(),dist:0}),this.active=i.active,this.pos=i.pos,this.dir=i.dir,this.scene._sectionPlaneCreated(this)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},active:{configurable:!0},pos:{configurable:!0},dir:{configurable:!0},dist:{configurable:!0}};return i.type.get=function(){return"SectionPlane"},i.active.set=function(t){this._state.active=!1!==t,this.glRedraw(),this.fire("active",this._state.active)},i.active.get=function(){return this._state.active},i.pos.set=function(t){this._state.pos.set(t||[0,0,0]),this._state.dist=-E.dotVec3(this._state.pos,this._state.dir),this.fire("pos",this._state.pos)},i.pos.get=function(){return this._state.pos},i.dir.set=function(t){this._state.dir.set(t||[0,0,-1]),this._state.dist=-E.dotVec3(this._state.pos,this._state.dir),this.glRedraw(),this.fire("dir",this._state.dir)},i.dir.get=function(){return this._state.dir},i.dist.get=function(){return this._state.dist},e.prototype.flipDir=function(){var t=this._state.dir;t[0]*=-1,t[1]*=-1,t[2]*=-1,this._state.dist=-E.dotVec3(this._state.pos,this._state.dir),this.fire("dir",this._state.dir),this.glRedraw()},e.prototype.destroy=function(){this._state.destroy(),this.scene._sectionPlaneDestroyed(this),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(U),tr=E.vec3(),er=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,"BCFViewpoints",e,i),this.originatingSystem=i.originatingSystem||"xeokit.io",this.authoringTool=i.authoringTool||"xeokit.io"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getViewpoint=function(t){var e=this;void 0===t&&(t={});var i=this.viewer.scene,r=i.camera,s=i.realWorldOffset,o=!0===t.reverseClippingPlanes,a={},n=E.normalizeVec3(E.subVec3(r.look,r.eye,E.vec3())),l=r.eye,h=r.up;r.yUp&&(n=sr(n),l=sr(l),h=sr(h));var u=ir(E.addVec3(l,s));"ortho"===r.projection?a.orthogonal_camera={camera_view_point:u,camera_direction:ir(n),camera_up_vector:ir(h),view_to_world_scale:r.ortho.scale}:a.perspective_camera={camera_view_point:u,camera_direction:ir(n),camera_up_vector:ir(h),field_of_view:r.perspective.fov};var c=i.sectionPlanes;for(var p in c)if(c.hasOwnProperty(p)){var d=c[p],f=d.pos,_=void 0;_=o?E.negateVec3(d.dir,E.vec3()):d.dir,r.yUp&&(f=sr(f),_=sr(_)),E.addVec3(f,s),f=ir(f),_=ir(_),a.clipping_planes||(a.clipping_planes=[]),a.clipping_planes.push({location:f,direction:_})}a.components={visibility:{view_setup_hints:{spaces_visible:!!t.spacesVisible,space_boundaries_visible:!!t.spaceBoundariesVisible,openings_visible:!!t.openingsVisible}}};var g=new Set(i.opacityObjectIds),m=new Set(i.xrayedObjectIds),v=new Set(i.colorizedObjectIds),b=Object.values(i.objects).filter((function(t){return g.has(t.id)||v.has(t.id)||m.has(t.id)})).reduce((function(t,r){var s,o=function(t){var e="";return e+=Math.round(255*t[0]).toString(16).padStart(2,"0"),e+=Math.round(255*t[1]).toString(16).padStart(2,"0"),e+=Math.round(255*t[2]).toString(16).padStart(2,"0")}(r.colorize);r.xrayed?(s=0===i.xrayMaterial.fillAlpha&&0!==i.xrayMaterial.edgeAlpha?.1:i.xrayMaterial.fillAlpha,o=(s=Math.round(255*s).toString(16).padStart(2,"0"))+o):g.has(r.id)&&(o=(s=Math.round(255*r.opacity).toString(16).padStart(2,"0"))+o),t[o]||(t[o]=[]);var a=r.id,n=r.originalSystemId,l={ifc_guid:n,originating_system:e.originatingSystem};return n!==a&&(l.authoring_tool_id=a),t[o].push(l),t}),{}),y=Object.entries(b).map((function(t){return{color:t[0],components:t[1]}}));a.components.coloring=y;var P=i.objectIds,M=i.visibleObjects,x=i.visibleObjectIds,w=P.filter((function(t){return!M[t]})),C=i.selectedObjectIds;return t.defaultInvisible||x.length<w.length?(a.components.visibility.exceptions=this._createBCFComponents(x),a.components.visibility.default_visibility=!1):(a.components.visibility.exceptions=this._createBCFComponents(w),a.components.visibility.default_visibility=!0),a.components.selection=this._createBCFComponents(C),!1!==t.snapshot&&(a.snapshot={snapshot_type:"png",snapshot_data:this.viewer.getSnapshot({format:"png"})}),a},e.prototype._createBCFComponents=function(t){for(var e=this.viewer.scene,i=[],r=0,s=t.length;r<s;r++){var o=t[r],a=e.objects[o];if(a){var n={ifc_guid:a.originalSystemId,originating_system:this.originatingSystem};a.originalSystemId!==o&&(n.authoring_tool_id=o),i.push(n)}}return i},e.prototype.setViewpoint=function(t,e){var i=this;if(void 0===e&&(e={}),t){var r=this.viewer,s=r.scene,o=s.camera,a=!1!==e.rayCast,n=!1!==e.immediate,l=!1!==e.reset,h=s.realWorldOffset,u=!0===e.reverseClippingPlanes;if(s.clearSectionPlanes(),t.clipping_planes&&t.clipping_planes.forEach((function(t){var e=rr(t.location,tr),i=rr(t.direction,tr);u&&E.negateVec3(i),E.subVec3(e,h),o.yUp&&(e=or(e),i=or(i)),new $i(s,{pos:e,dir:i})})),l&&(s.setObjectsXRayed(s.xrayedObjectIds,!1),s.setObjectsHighlighted(s.highlightedObjectIds,!1),s.setObjectsSelected(s.selectedObjectIds,!1)),t.components){if(t.components.visibility){t.components.visibility.default_visibility?(s.setObjectsVisible(s.objectIds,!0),t.components.visibility.exceptions&&t.components.visibility.exceptions.forEach((function(t){return i._withBCFComponent(e,t,(function(t){return t.visible=!1}))}))):(s.setObjectsVisible(s.objectIds,!1),t.components.visibility.exceptions&&t.components.visibility.exceptions.forEach((function(t){return i._withBCFComponent(e,t,(function(t){return t.visible=!0}))})));var c=t.components.visibility.view_setup_hints;c&&(!1===c.spaces_visible&&s.setObjectsVisible(r.metaScene.getObjectIDsByType("IfcSpace"),!1),!1===c.openings_visible&&s.setObjectsVisible(r.metaScene.getObjectIDsByType("IfcOpening"),!1),c.space_boundaries_visible)}t.components.selection&&(s.setObjectsSelected(s.selectedObjectIds,!1),t.components.selection.forEach((function(t){return i._withBCFComponent(e,t,(function(t){return t.selected=!0}))}))),t.components.coloring&&t.components.coloring.forEach((function(t){var r=t.color,s=0,o=!1;8===r.length&&((s=parseInt(r.substring(0,2),16)/256)<=1&&s>=.95&&(s=1),r=r.substring(2),o=!0);var a=[parseInt(r.substring(0,2),16)/256,parseInt(r.substring(2,4),16)/256,parseInt(r.substring(4,6),16)/256];t.components.map((function(t){return i._withBCFComponent(e,t,(function(t){t.colorize=a,o&&(t.opacity=s)}))}))}))}if(t.perspective_camera||t.orthogonal_camera){var p,d,f,_;if(t.perspective_camera?(p=rr(t.perspective_camera.camera_view_point,tr),d=rr(t.perspective_camera.camera_direction,tr),f=rr(t.perspective_camera.camera_up_vector,tr),o.perspective.fov=t.perspective_camera.field_of_view,_="perspective"):(p=rr(t.orthogonal_camera.camera_view_point,tr),d=rr(t.orthogonal_camera.camera_direction,tr),f=rr(t.orthogonal_camera.camera_up_vector,tr),o.ortho.scale=t.orthogonal_camera.view_to_world_scale,_="ortho"),E.subVec3(p,h),o.yUp&&(p=or(p),d=or(d),f=or(f)),a){var g=s.pick({pickSurface:!0,origin:p,direction:d});d=g?g.worldPos:E.addVec3(p,d,tr)}else d=E.addVec3(p,d,tr);n?(o.eye=p,o.look=d,o.up=f,o.projection=_):r.cameraFlight.flyTo({eye:p,look:d,up:f,duration:e.duration,projection:_})}}},e.prototype._withBCFComponent=function(t,e,i){var r=this.viewer,s=r.scene;if(e.authoring_tool_id&&e.originating_system===this.originatingSystem){var o=e.authoring_tool_id,a=s.objects[o];if(a)return void i(a);if(t.updateCompositeObjects)if(r.metaScene.metaObjects[o])return void s.withObjects(r.metaScene.getObjectIDsInSubtree(o),i)}if(e.ifc_guid){var n=e.ifc_guid,l=s.objects[n];if(l)return void i(l);if(t.updateCompositeObjects)if(r.metaScene.metaObjects[n])return void s.withObjects(r.metaScene.getObjectIDsInSubtree(n),i);Object.keys(s.models).forEach((function(e){var o=E.globalizeObjectId(e,n),a=s.objects[o];if(a)i(a);else if(t.updateCompositeObjects&&r.metaScene.metaObjects[o])return void s.withObjects(r.metaScene.getObjectIDsInSubtree(o),i)}))}},e.prototype.destroy=function(){t.prototype.destroy.call(this)},e}(n);function ir(t){return{x:t[0],y:t[1],z:t[2]}}function rr(t,e){return(e=new Float64Array(3))[0]=t.x,e[1]=t.y,e[2]=t.z,e}function sr(t){return new Float64Array([t[0],-t[2],t[1]])}function or(t){return new Float64Array([t[0],t[2],-t[1]])}var ar=E.vec3(),nr=function(t,e,i,r){var s=t-i,o=e-r;return Math.sqrt(s*s+o*o)},lr=function(t){function e(e,i){var r=this;if(void 0===i&&(i={}),t.call(this,e.viewer.scene,i),this.plugin=e,this._container=i.container,!this._container)throw"config missing: container";this._eventSubs={};var s=this.plugin.viewer.scene;this._originMarker=new ht(s,i.origin),this._targetMarker=new ht(s,i.target),this._originWorld=E.vec3(),this._targetWorld=E.vec3(),this._wp=new Float64Array(24),this._vp=new Float64Array(24),this._pp=new Float64Array(24),this._cp=new Int16Array(8),this._xAxisLabelCulled=!1,this._yAxisLabelCulled=!1,this._zAxisLabelCulled=!1,this._originDot=new ct(this._container,{}),this._targetDot=new ct(this._container,{}),this._lengthWire=new ut(this._container,{color:"#00BBFF",thickness:2}),this._xAxisWire=new ut(this._container,{color:"red",thickness:1}),this._yAxisWire=new ut(this._container,{color:"green",thickness:1}),this._zAxisWire=new ut(this._container,{color:"blue",thickness:1}),this._lengthLabel=new pt(this._container,{fillColor:"#00BBFF",prefix:"",text:""}),this._xAxisLabel=new pt(this._container,{fillColor:"red",prefix:"X",text:""}),this._yAxisLabel=new pt(this._container,{fillColor:"green",prefix:"Y",text:""}),this._zAxisLabel=new pt(this._container,{fillColor:"blue",prefix:"Z",text:""}),this._wpDirty=!1,this._vpDirty=!1,this._cpDirty=!1,this._visible=!1,this._originVisible=!1,this._targetVisible=!1,this._wireVisible=!1,this._axisVisible=!1,this._originMarker.on("worldPos",(function(t){r._originWorld.set(t||[0,0,0]),r._wpDirty=!0,r._needUpdate(0)})),this._targetMarker.on("worldPos",(function(t){r._targetWorld.set(t||[0,0,0]),r._wpDirty=!0,r._needUpdate(0)})),this._onViewMatrix=s.camera.on("viewMatrix",(function(){r._vpDirty=!0,r._needUpdate(0)})),this._onProjMatrix=s.camera.on("projMatrix",(function(){r._cpDirty=!0,r._needUpdate()})),this._onCanvasBoundary=s.canvas.on("boundary",(function(){r._cpDirty=!0,r._needUpdate(0)})),this._onMetricsUnits=s.metrics.on("units",(function(){r._cpDirty=!0,r._needUpdate()})),this._onMetricsScale=s.metrics.on("scale",(function(){r._cpDirty=!0,r._needUpdate()})),this._onMetricsOrigin=s.metrics.on("origin",(function(){r._cpDirty=!0,r._needUpdate()})),this.approximate=i.approximate,this.visible=i.visible,this.originVisible=i.originVisible,this.targetVisible=i.targetVisible,this.wireVisible=i.wireVisible,this.axisVisible=i.axisVisible}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={approximate:{configurable:!0},origin:{configurable:!0},target:{configurable:!0},length:{configurable:!0},visible:{configurable:!0},originVisible:{configurable:!0},targetVisible:{configurable:!0},axisVisible:{configurable:!0},wireVisible:{configurable:!0}};return e.prototype._update=function(){if(this._visible){var t=this.plugin.viewer.scene;this._wpDirty&&(this._wp[0]=this._originWorld[0],this._wp[1]=this._originWorld[1],this._wp[2]=this._originWorld[2],this._wp[3]=1,this._wp[4]=this._targetWorld[0],this._wp[5]=this._originWorld[1],this._wp[6]=this._originWorld[2],this._wp[7]=1,this._wp[8]=this._targetWorld[0],this._wp[9]=this._targetWorld[1],this._wp[10]=this._originWorld[2],this._wp[11]=1,this._wp[12]=this._targetWorld[0],this._wp[13]=this._targetWorld[1],this._wp[14]=this._targetWorld[2],this._wp[15]=1,this._wpDirty=!1,this._vpDirty=!0),this._vpDirty&&(E.transformPositions4(t.camera.viewMatrix,this._wp,this._vp),this._vp[3]=1,this._vp[7]=1,this._vp[11]=1,this._vp[15]=1,this._vpDirty=!1,this._cpDirty=!0);var e=this._originMarker.viewPos[2],i=this._targetMarker.viewPos[2];if(e>-.3||i>-.3)return this._xAxisLabel.setVisible(!1),this._yAxisLabel.setVisible(!1),this._zAxisLabel.setVisible(!1),this._lengthLabel.setVisible(!1),this._xAxisWire.setVisible(!1),this._yAxisWire.setVisible(!1),this._zAxisWire.setVisible(!1),this._lengthWire.setVisible(!1),this._originDot.setVisible(!1),void this._targetDot.setVisible(!1);if(this._cpDirty){E.transformPositions4(t.camera.project.matrix,this._vp,this._pp);for(var r=this._pp,s=this._cp,o=t.canvas.canvas.getBoundingClientRect(),a=o.top,n=o.left,l=t.canvas.boundary,h=l[2],u=l[3],c=0,p=this.plugin.viewer.scene.metrics,d=p.scale,f=p.units,_=p.unitsInfo[f].abbrev,g=0,m=r.length;g<m;g+=4)s[c]=n+Math.floor((1+r[g+0]/r[g+3])*h/2),s[c+1]=a+Math.floor((1-r[g+1]/r[g+3])*u/2),c+=2;this._originDot.setPos(s[0],s[1]),this._targetDot.setPos(s[6],s[7]),this._lengthWire.setStartAndEnd(s[0],s[1],s[6],s[7]),this._xAxisWire.setStartAndEnd(s[0],s[1],s[2],s[3]),this._yAxisWire.setStartAndEnd(s[2],s[3],s[4],s[5]),this._zAxisWire.setStartAndEnd(s[4],s[5],s[6],s[7]),this._lengthLabel.setPosOnWire(s[0],s[1],s[6],s[7]),this._xAxisLabel.setPosOnWire(s[0],s[1],s[2],s[3]),this._yAxisLabel.setPosOnWire(s[2],s[3],s[4],s[5]),this._zAxisLabel.setPosOnWire(s[4],s[5],s[6],s[7]);var v=this._approximate?" ~ ":" = ";this._length=Math.abs(E.lenVec3(E.subVec3(this._targetWorld,this._originWorld,ar))),this._lengthLabel.setText(v+(this._length*d).toFixed(2)+_);var b=Math.abs(nr(s[0],s[1],s[2],s[3])),y=Math.abs(nr(s[2],s[3],s[4],s[5])),P=Math.abs(nr(s[4],s[5],s[6],s[7])),M=this.plugin.labelMinAxisLength;this._xAxisLabelCulled=b<M,this._yAxisLabelCulled=y<M,this._zAxisLabelCulled=P<M,this._xAxisLabelCulled?this._xAxisLabel.setVisible(!1):(this._xAxisLabel.setText(v+Math.abs((this._targetWorld[0]-this._originWorld[0])*d).toFixed(2)+_),this._xAxisLabel.setVisible(!0)),this._yAxisLabelCulled?this._yAxisLabel.setVisible(!1):(this._yAxisLabel.setText(v+Math.abs((this._targetWorld[1]-this._originWorld[1])*d).toFixed(2)+_),this._yAxisLabel.setVisible(!0)),this._zAxisLabelCulled?this._zAxisLabel.setVisible(!1):(this._zAxisLabel.setText(v+Math.abs((this._targetWorld[2]-this._originWorld[2])*d).toFixed(2)+_),this._zAxisLabel.setVisible(!0)),this._originDot.setVisible(this._visible&&this._originVisible),this._targetDot.setVisible(this._visible&&this._targetVisible),this._xAxisWire.setVisible(!0),this._yAxisWire.setVisible(!0),this._zAxisWire.setVisible(!0),this._lengthWire.setVisible(!0),this._lengthLabel.setVisible(!0),this._cpDirty=!1}}},i.approximate.set=function(t){t=!1!==t,this._approximate!==t&&(this._approximate=t,this._cpDirty=!0,this._needUpdate(0))},i.approximate.get=function(){return this._approximate},i.origin.get=function(){return this._originMarker},i.target.get=function(){return this._targetMarker},i.length.get=function(){this._update();var t=this.plugin.viewer.scene.metrics.scale;return this._length*t},i.visible.set=function(t){t=!1!==t,this._visible=t,this._originDot.setVisible(this._visible&&this._originVisible),this._targetDot.setVisible(this._visible&&this._targetVisible),this._lengthWire.setVisible(this._visible&&this._wireVisible);var e=this._visible&&this._axisVisible;this._xAxisWire.setVisible(e),this._yAxisWire.setVisible(e),this._zAxisWire.setVisible(e),this._lengthLabel.setVisible(e),this._xAxisLabel.setVisible(e&&!this._xAxisLabelCulled),this._yAxisLabel.setVisible(e&&!this._yAxisLabelCulled),this._zAxisLabel.setVisible(e&&!this._zAxisLabelCulled)},i.visible.get=function(){return this._visible},i.originVisible.set=function(t){t=!1!==t,this._originVisible=t,this._originDot.setVisible(this._visible&&this._originVisible)},i.originVisible.get=function(){return this._originVisible},i.targetVisible.set=function(t){t=!1!==t,this._targetVisible=t,this._targetDot.setVisible(this._visible&&this._targetVisible)},i.targetVisible.get=function(){return this._targetVisible},i.axisVisible.set=function(t){t=!1!==t,this._axisVisible=t;var e=this._visible&&this._axisVisible;this._xAxisWire.setVisible(e),this._yAxisWire.setVisible(e),this._zAxisWire.setVisible(e),this._xAxisLabel.setVisible(e&&!this._xAxisLabelCulled),this._yAxisLabel.setVisible(e&&!this._yAxisLabelCulled),this._zAxisLabel.setVisible(e&&!this._zAxisLabelCulled)},i.axisVisible.get=function(){return this._axisVisible},i.wireVisible.set=function(t){t=!1!==t,this._wireVisible=t;var e=this._visible&&this._wireVisible;this._lengthLabel.setVisible(e),this._lengthWire.setVisible(e)},i.wireVisible.get=function(){return this._wireVisible},e.prototype.destroy=function(){var e=this.plugin.viewer.scene,i=e.metrics;this._onViewMatrix&&e.camera.off(this._onViewMatrix),this._onProjMatrix&&e.camera.off(this._onProjMatrix),this._onCanvasBoundary&&e.canvas.off(this._onCanvasBoundary),this._onMetricsUnits&&i.off(this._onMetricsUnits),this._onMetricsScale&&i.off(this._onMetricsScale),this._onMetricsOrigin&&i.off(this._onMetricsOrigin),this._originDot.destroy(),this._targetDot.destroy(),this._xAxisWire.destroy(),this._yAxisWire.destroy(),this._zAxisWire.destroy(),this._lengthLabel.destroy(),this._xAxisLabel.destroy(),this._yAxisLabel.destroy(),this._zAxisLabel.destroy(),this._lengthWire.destroy(),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(U),hr=function(t){function e(e){t.call(this,e.viewer.scene),this.plugin=e,this._active=!1,this._state=0,this._currentDistMeasurement=null,this._prevDistMeasurement=null,this._onHoverSurface=null,this._onHoverOff=null}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={active:{configurable:!0}};return i.active.get=function(){return this._active},e.prototype.activate=function(){var t=this;if(!this._active){var e,i,r=this.plugin.viewer.cameraControl,s=!1,o=null,a=E.vec3(),n=E.vec2(),l=this.plugin.viewer.scene.pickSurfacePrecisionEnabled;this._onHoverSurface=r.on("hoverSurface",(function(e){if(s=!0,o=e.entity,a.set(e.worldPos),n.set(e.canvasPos),0!==t._state){if(t._currentDistMeasurement)switch(t._state){case 2:t._currentDistMeasurement.wireVisible=!0,t._currentDistMeasurement.axisVisible=!0,t._currentDistMeasurement.target.entity=e.entity,t._currentDistMeasurement.target.worldPos=e.worldPos,document.body.style.cursor="pointer"}}else document.body.style.cursor="pointer"}));this._onInputMouseDown=this.plugin.viewer.scene.input.on("mousedown",(function(t){e=t[0],i=t[1]})),this._onInputMouseUp=this.plugin.viewer.scene.input.on("mouseup",(function(r){if(!(r[0]>e+5||r[0]<e-5||r[1]>i+5||r[1]<i-5))switch(t._state){case 0:if(t._prevDistMeasurement&&(t._prevDistMeasurement.originVisible=!0,t._prevDistMeasurement.targetVisible=!0,t._prevDistMeasurement.axisVisible=!0),s){if(l){var h=t.plugin.viewer.scene.pick({canvasPos:n,pickSurface:!0,pickSurfacePrecision:!0});h&&h.worldPos&&a.set(h.worldPos)}t._currentDistMeasurement=t.plugin.createMeasurement({id:E.createUUID(),origin:{entity:o,worldPos:a},target:{entity:o,worldPos:a},approximate:!0}),t._currentDistMeasurement.axisVisible=!1,t._currentDistMeasurement.targetVisible=!0,t._prevDistMeasurement=t._currentDistMeasurement,t._state=2}break;case 2:if(s){if(l){var u=t.plugin.viewer.scene.pick({canvasPos:n,pickSurface:!0,pickSurfacePrecision:!0});u&&u.worldPos&&(t._currentDistMeasurement.target.worldPos=u.worldPos),t._currentDistMeasurement.approximate=!1}t._currentDistMeasurement.axisVisible=!0,t._currentDistMeasurement.targetVisible=!0,t._currentDistMeasurement=null,t._prevDistMeasurement=null,t._state=0}else t._currentDistMeasurement&&(t._currentDistMeasurement.destroy(),t._currentDistMeasurement=null,t._prevDistMeasurement=null,t._state=0)}})),this._onHoverOff=r.on("hoverOff",(function(e){if(s=!1,t._currentDistMeasurement)switch(t._state){case 0:break;case 1:t._currentDistMeasurement.wireVisible=!1,t._currentDistMeasurement.originVisible=!1,t._currentDistMeasurement.axisVisible=!1;break;case 2:t._currentDistMeasurement.wireVisible=!1,t._currentDistMeasurement.targetVisible=!1,t._currentDistMeasurement.axisVisible=!1}document.body.style.cursor="default"})),this._active=!0}},e.prototype.deactivate=function(){if(this._active){this.reset();var t=this.plugin.viewer.cameraControl;this.plugin.viewer.scene.input.off(this._onInputMouseDown),t.off(this._onHoverSurface),t.off(this._onHoverOff),this._currentDistMeasurement=null,this._active=!1}},e.prototype.reset=function(){this._active&&(this._currentDistMeasurement&&(this._currentDistMeasurement.destroy(),this._currentDistMeasurement=null),this._prevDistMeasurement=null,this._state=0)},e.prototype.destroy=function(){this.deactivate(),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(U),ur=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,"DistanceMeasurements",e),this._container=i.container||document.body,this._control=new hr(this),this._measurements={},this.labelMinAxisLength=i.labelMinAxisLength}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={control:{configurable:!0},measurements:{configurable:!0},labelMinAxisLength:{configurable:!0}};return e.prototype.send=function(t,e){},i.control.get=function(){return this._control},i.measurements.get=function(){return this._measurements},i.labelMinAxisLength.set=function(t){t<1&&(this.error("labelMinAxisLength must be >= 1; defaulting to 25"),t=25),this._labelMinAxisLength=t||25},i.labelMinAxisLength.get=function(){return this._labelMinAxisLength},e.prototype.createMeasurement=function(t){var e=this;void 0===t&&(t={}),this.viewer.scene.components[t.id]&&(this.error("Viewer scene component with this ID already exists: "+t.id),delete t.id);var i=t.origin,r=t.target,s=new lr(this,{id:t.id,plugin:this,container:this._container,origin:{entity:i.entity,worldPos:i.worldPos},target:{entity:r.entity,worldPos:r.worldPos},visible:t.visible,wireVisible:t.wireVisible,originVisible:t.originVisible,targetVisible:t.targetVisible});return this._measurements[s.id]=s,s.on("destroyed",(function(){delete e._measurements[s.id]})),s},e.prototype.destroyMeasurement=function(t){var e=this._measurements[t];e?e.destroy():this.log("DistanceMeasurement not found: "+t)},e.prototype.clear=function(){for(var t=Object.keys(this._measurements),e=0,i=t.length;e<i;e++)this.destroyMeasurement(t[e])},e.prototype.destroy=function(){this.clear(),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(n),cr=function(t){function e(e,i){var r=this;void 0===i&&(i={}),t.call(this,"FastNav",e),this._pbrEnabled=void 0!==i.pbrEnabled&&null!==i.pbrEnabled?i.pbrEnabled:e.scene.pbrEnabled,this._saoEnabled=void 0!==i.saoEnabled&&null!==i.saoEnabled?i.saoEnabled:e.scene.sao.enabled,this._edgesEnabled=void 0!==i.edgesEnabled&&null!==i.edgesEnabled?i.edgesEnabled:e.scene.edgeMaterial.edges,this._pInterval=null,this._fadeMillisecs=500;var s=600,o=s,a=!1;this._onCanvasBoundary=e.scene.canvas.on("boundary",(function(){o=s,a||(r._cancelFade(),e.scene.pbrEnabled=!1,e.scene.sao.enabled=!1,e.scene.edgeMaterial.edges=!1,a=!0)})),this._onCameraMatrix=e.scene.camera.on("matrix",(function(){o=s,a||(r._cancelFade(),e.scene.pbrEnabled=!1,e.scene.sao.enabled=!1,e.scene.edgeMaterial.edges=!1,a=!0)})),this._onSceneTick=e.scene.on("tick",(function(t){a&&(o-=t.deltaTime)<=0&&a&&(r._startFade(),r._pInterval2=setTimeout((function(){e.scene.pbrEnabled=r._pbrEnabled,e.scene.sao.enabled=r._saoEnabled,e.scene.edgeMaterial.edges=r._edgesEnabled}),100),a=!1)}));var n=!1;this._onSceneMouseDown=e.scene.input.on("mousedown",(function(){n=!0})),this._onSceneMouseUp=e.scene.input.on("mouseup",(function(){n=!1})),this._onSceneMouseMove=e.scene.input.on("mousemove",(function(){n&&(o=s,a||(r._cancelFade(),e.scene.pbrEnabled=!1,e.scene.sao.enabled=!1,e.scene.edgeMaterial.edges=!1,a=!0))}))}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={pbrEnabled:{configurable:!0},saoEnabled:{configurable:!0},edgesEnabled:{configurable:!0}};return e.prototype._startFade=function(){var t=this;this._img||this._initFade();var e=1/(this._fadeMillisecs/50);this._pInterval&&(clearInterval(this._pInterval),this._pInterval=null);var i=this.viewer,r=i.scene.canvas.canvas,s=pr(r),o=(parseInt(r.style["z-index"])||0)+1;this._img.style.position="fixed",this._img.style.margin="0px",this._img.style["z-index"]=o,this._img.style.background=r.style.background,this._img.style.left=s.left+"px",this._img.style.top=s.top+"px",this._img.style.width=r.width+"px",this._img.style.height=r.height+"px",this._img.width=r.width,this._img.height=r.height,this._img.src="",this._img.src=i.getSnapshot({format:"png",includeGizmos:!0}),this._img.style.visibility="visible",this._img.style.opacity=1;var a=1;this._pInterval=setInterval((function(){if((a-=e)>0){t._img.style.opacity=a;var i=pr(r);t._img.style.left=i.left+"px",t._img.style.top=i.top+"px",t._img.style.width=r.width+"px",t._img.style.height=r.height+"px",t._img.style.opacity=a,t._img.width=r.width,t._img.height=r.height}else t._img.style.opacity=0,t._img.style.visibility="hidden",clearInterval(t._pInterval),t._pInterval=null}),50)},e.prototype._initFade=function(){this._img=document.createElement("img");var t=this.viewer.scene.canvas.canvas,e=pr(t);parseInt(t.style["z-index"]),this._img.style.position="absolute",this._img.style.visibility="hidden",this._img.style["pointer-events"]="none",this._img.style["z-index"]=5,this._img.style.left=e.left+"px",this._img.style.top=e.top+"px",this._img.style.width=t.width+"px",this._img.style.height=t.height+"px",this._img.style.opacity=1,this._img.width=t.width,this._img.height=t.height,this._img.left=e.left,this._img.top=e.top,t.parentNode.insertBefore(this._img,t.nextSibling)},e.prototype._cancelFade=function(){this._img&&(this._pInterval&&(clearInterval(this._pInterval),this._pInterval=null),this._pInterval2&&(clearInterval(this._pInterval2),this._pInterval2=null),this._img.style.opacity=0,this._img.style.visibility="hidden")},i.pbrEnabled.set=function(t){this._pbrEnabled=t},i.pbrEnabled.get=function(){return this._pbrEnabled},i.saoEnabled.set=function(t){this._saoEnabled=t},i.saoEnabled.get=function(){return this._saoEnabled},i.edgesEnabled.set=function(t){this._edgesEnabled=t},i.edgesEnabled.get=function(){return this._edgesEnabled},e.prototype.send=function(t,e){switch(t){case"clear":this._cancelFade()}},e.prototype.destroy=function(){this._cancelFade(),this.viewer.scene.camera.off(this._onCameraMatrix),this.viewer.scene.canvas.off(this._onCanvasBoundary),this.viewer.scene.input.off(this._onSceneMouseDown),this.viewer.scene.input.off(this._onSceneMouseUp),this.viewer.scene.input.off(this._onSceneMouseMove),this.viewer.scene.off(this._onSceneTick),t.prototype.destroy.call(this),this._img&&(this._img.parentNode.removeChild(this._img),this._img=null)},Object.defineProperties(e.prototype,i),e}(n);function pr(t){var e=0,i=0;do{e+=t.offsetTop||0,i+=t.offsetLeft||0,t=t.offsetParent}while(t);return{top:e,left:i}}var dr=function(){};dr.prototype.getMetaModel=function(t,e,i){B.loadJSON(t,(function(t){e(t)}),(function(t){i(t)}))},dr.prototype.getGLTF=function(t,e,i){B.loadJSON(t,(function(t){e(t)}),(function(t){i(t)}))},dr.prototype.getArrayBuffer=function(t,e,i,r){!function(t,e,i,r){var s=function(){};i=i||s,r=r||s;var o=/^data:(.*?)(;base64)?,(.*)$/,a=e.match(o);if(a){var n=!!a[2],l=a[3];l=window.decodeURIComponent(l),n&&(l=window.atob(l));try{for(var h=new ArrayBuffer(l.length),u=new Uint8Array(h),c=0;c<l.length;c++)u[c]=l.charCodeAt(c);window.setTimeout((function(){i(h)}),0)}catch(t){window.setTimeout((function(){r(t)}),0)}}else{var p=function(t){var e=t.lastIndexOf("/");return 0!==e?t.substring(0,e+1):""}(t)+e,d=new XMLHttpRequest;d.open("GET",p,!0),d.responseType="arraybuffer",d.onreadystatechange=function(){4===d.readyState&&(200===d.status?i(d.response):r("loadArrayBuffer error : "+d.response))},d.send(null)}}(t,e,(function(t){i(t)}),(function(t){r(t)}))};var fr=function(t,e,i,r,s,o){void 0===s&&(s=null),void 0===o&&(o=0),this.model=t,this.object=null,this.parent=null,this.id=e,this.pickId=this.model.scene._renderer.getPickID(this),this.aabb=E.AABB3(),this._layer=s,this._portionId=o,this._color=[i[0],i[1],i[2],r],this._colorize=[i[0],i[1],i[2],r],this._colorizing=!1,this._transparent=r<255,this.numTriangles=0,this.rtcCenter=null};fr.prototype._finalize=function(t){this._layer.initFlags(this._portionId,t,this._transparent)},fr.prototype._setVisible=function(t){this._layer.setVisible(this._portionId,t,this._transparent)},fr.prototype._setColor=function(t){this._color[0]=t[0],this._color[1]=t[1],this._color[2]=t[2],this._colorizing||this._layer.setColor(this._portionId,this._color,!1)},fr.prototype._setColorize=function(t){t?(this._colorize[0]=t[0],this._colorize[1]=t[1],this._colorize[2]=t[2],this._layer.setColor(this._portionId,this._colorize,false),this._colorizing=!0):(this._layer.setColor(this._portionId,this._color,false),this._colorizing=!1)},fr.prototype._setOpacity=function(t,e){var i=t<255,r=this._transparent!==i;this._color[3]=t,this._colorize[3]=t,this._transparent=i,this._colorizing?this._layer.setColor(this._portionId,this._colorize):this._layer.setColor(this._portionId,this._color),r&&this._layer.setTransparent(this._portionId,e,i)},fr.prototype._setOffset=function(t){this._layer.setOffset(this._portionId,t)},fr.prototype._setHighlighted=function(t){this._layer.setHighlighted(this._portionId,t,this._transparent)},fr.prototype._setXRayed=function(t){this._layer.setXRayed(this._portionId,t,this._transparent)},fr.prototype._setSelected=function(t){this._layer.setSelected(this._portionId,t,this._transparent)},fr.prototype._setEdges=function(t){this._layer.setEdges(this._portionId,t,this._transparent)},fr.prototype._setClippable=function(t){this._layer.setClippable(this._portionId,t,this._transparent)},fr.prototype._setCollidable=function(t){this._layer.setCollidable(this._portionId,t)},fr.prototype._setPickable=function(t){this._layer.setPickable(this._portionId,t,this._transparent)},fr.prototype._setCulled=function(t){this._layer.setCulled(this._portionId,t,this._transparent)},fr.prototype.canPickTriangle=function(){return!1},fr.prototype.drawPickTriangles=function(t,e){},fr.prototype.pickTriangleSurface=function(t){},fr.prototype.precisionRayPickSurface=function(t,e,i){return!!this._layer.precisionRayPickSurface&&this._layer.precisionRayPickSurface(this._portionId,t,e,i)},fr.prototype.canPickWorldPos=function(){return!0},fr.prototype.drawPickDepths=function(t){this.model.drawPickDepths(t)},fr.prototype.drawPickNormals=function(t){this.model.drawPickNormals(t)},fr.prototype.delegatePickedEntity=function(){return this.parent},fr.prototype._destroy=function(){this.model.scene._renderer.putPickID(this.pickId)};var _r=function(){this._uint8Arrays={},this._float32Arrays={}};_r.prototype._clear=function(){this._uint8Arrays={},this._float32Arrays={}},_r.prototype.getUInt8Array=function(t){var e=this._uint8Arrays[t];return e||(e=new Uint8Array(t),this._uint8Arrays[t]=e),e},_r.prototype.getFloat32Array=function(t){var e=this._float32Arrays[t];return e||(e=new Float32Array(t),this._float32Arrays[t]=e),e};var gr=new _r,mr=0;var vr=0,br=1,yr=2,Pr=3,Mr=4,xr=5,wr=6,Er=7,Cr=8,Ar=9,Sr=10,Dr=11,Lr=E.vec4(),Br=E.vec3(),Rr=function(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()};Rr.prototype.getValid=function(){return this._hash===this._getHash()},Rr.prototype._getHash=function(){var t=this._scene;return[t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")},Rr.prototype.drawLayer=function(t,e,i){var r=this._scene,s=r.camera,o=e.model,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?rt(s.viewMatrix,l):s.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,o.worldNormalMatrix);var h=r._sectionPlanesState.sectionPlanes.length;if(h>0)for(var u=r._sectionPlanesState.sectionPlanes,c=e.layerIndex*h,p=o.renderFlags,d=0;d<h;d++){var f=this._uSectionPlanes[d];if(f){var _=p.sectionPlanesActivePerLayer[c+d];if(a.uniform1i(f.active,_?1:0),_){var g=u[d];if(l){var m=at(g.dist,g.dir,l,Br);a.uniform3fv(f.pos,m)}else a.uniform3fv(f.pos,g.pos);a.uniform3fv(f.dir,g.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}},Rr.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uWorldNormalMatrix=r.getLocation("worldNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var s=i.lights,o=0,a=s.length;o<a;o++)switch(s[o].type){case"dir":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=null,this._uLightDir[o]=r.getLocation("lightDir"+o);break;case"point":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=null,this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o);break;case"spot":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=r.getLocation("lightDir"+o),this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o)}this._uSectionPlanes=[];for(var n=0,l=t._sectionPlanesState.sectionPlanes.length;n<l;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aNormal=r.getAttribute("normal"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Rr.prototype._bindProgram=function(t){var e=this._scene,i=e.canvas.gl,r=this._program,s=e._lightsState.lights,o=e.camera.project;r.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,e._lightsState.getAmbientColorAndIntensity());for(var a=0,n=s.length;a<n;a++){var l=s[a];this._uLightColor[a]&&i.uniform4f(this._uLightColor[a],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[a]&&(i.uniform3fv(this._uLightPos[a],l.pos),this._uLightAttenuation[a]&&i.uniform1f(this._uLightAttenuation[a],l.attenuation)),this._uLightDir[a]&&i.uniform3fv(this._uLightDir[a],l.dir)}if(this._withSAO){var h=e.sao;if(h.possible){var u=i.drawingBufferWidth,c=i.drawingBufferHeight;Lr[0]=u,Lr[1]=c,Lr[2]=h.blendCutoff,Lr[3]=h.blendFactor,i.uniform4fv(this._uSAOParams,Lr),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,0)}}if(e.logarithmicDepthBufferEnabled){var p=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,p)}},Rr.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Rr.prototype._buildVertexShader=function(){var t,e=this._scene,i=e._sectionPlanesState,r=e._lightsState,s=i.sectionPlanes.length>0,o=[];o.push("// Triangles batching draw vertex shader"),e.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("uniform int renderPass;"),o.push("attribute vec3 position;"),o.push("attribute vec3 normal;"),o.push("attribute vec4 color;"),o.push("attribute vec4 flags;"),o.push("attribute vec4 flags2;"),e.entityOffsetsEnabled&&o.push("attribute vec3 offset;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;")),o.push("uniform vec4 lightAmbient;");for(var a=0,n=r.lights.length;a<n;a++)"ambient"!==(t=r.lights[a]).type&&(o.push("uniform vec4 lightColor"+a+";"),"dir"===t.type&&o.push("uniform vec3 lightDir"+a+";"),"point"===t.type&&o.push("uniform vec3 lightPos"+a+";"),"spot"===t.type&&(o.push("uniform vec3 lightPos"+a+";"),o.push("uniform vec3 lightDir"+a+";")));o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),s&&(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;")),o.push("varying vec4 vColor;"),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;");for(var l=0,h=r.lights.length;l<h;l++)if("ambient"!==(t=r.lights[l]).type){if("dir"===t.type)"view"===t.space?o.push("viewLightDir = normalize(lightDir"+l+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?o.push("viewLightDir = -normalize(lightPos"+l+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+l+", 0.0)).xyz);");else{if("spot"!==t.type)continue;"view"===t.space?o.push("viewLightDir = normalize(lightDir"+l+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);")}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+l+".rgb * lightColor"+l+".a);")}return o.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),o.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;"))),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;")),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o},Rr.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching draw fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),this._withSAO&&(r.push("uniform sampler2D uOcclusionTexture;"),r.push("uniform vec4      uSAOParams;"),r.push("const float       packUpscale = 256. / 255.;"),r.push("const float       unpackDownScale = 255. / 256.;"),r.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),r.push("float unpackRGBToFloat( const in vec4 v ) {"),r.push("    return dot( v, unPackFactors );"),r.push("}")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { "),r.push("      discard;"),r.push("  }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(r.push("   float viewportWidth     = uSAOParams[0];"),r.push("   float viewportHeight    = uSAOParams[1];"),r.push("   float blendCutoff       = uSAOParams[2];"),r.push("   float blendFactor       = uSAOParams[3];"),r.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),r.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),r.push("   gl_FragColor            = vec4(vColor.rgb * ambient, 1.0);")):r.push("   gl_FragColor            = vColor;"),r.push("}"),r},Rr.prototype.webglContextRestored=function(){this._program=null},Rr.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Tr=E.vec4(),Fr=E.vec3(),Nr=function(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()};Nr.prototype.getValid=function(){return this._hash===this._getHash()},Nr.prototype._getHash=function(){var t=this._scene;return[t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")},Nr.prototype.drawLayer=function(t,e,i){var r=this._scene,s=r.camera,o=e.model,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?rt(s.viewMatrix,l):s.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix);var h=r._sectionPlanesState.sectionPlanes.length;if(h>0)for(var u=r._sectionPlanesState.sectionPlanes,c=e.layerIndex*h,p=o.renderFlags,d=0;d<h;d++){var f=this._uSectionPlanes[d],_=p.sectionPlanesActivePerLayer[c+d];if(a.uniform1i(f.active,_?1:0),_){var g=u[d];if(l){var m=at(g.dist,g.dir,l,Fr);a.uniform3fv(f.pos,m)}else a.uniform3fv(f.pos,g.pos);a.uniform3fv(f.dir,g.dir)}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}},Nr.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var s=i.lights,o=0,a=s.length;o<a;o++)switch(s[o].type){case"dir":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=null,this._uLightDir[o]=r.getLocation("lightDir"+o);break;case"point":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=null,this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o);break;case"spot":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=r.getLocation("lightDir"+o),this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o)}this._uSectionPlanes=[];for(var n=0,l=t._sectionPlanesState.sectionPlanes.length;n<l;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Nr.prototype._bindProgram=function(t){var e=this._scene,i=e.canvas.gl,r=this._program,s=e._lightsState.lights,o=e.camera.project;r.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,e._lightsState.getAmbientColorAndIntensity());for(var a=0,n=s.length;a<n;a++){var l=s[a];this._uLightColor[a]&&i.uniform4f(this._uLightColor[a],l.color[0],l.color[1],l.color[2],l.intensity),this._uLightPos[a]&&(i.uniform3fv(this._uLightPos[a],l.pos),this._uLightAttenuation[a]&&i.uniform1f(this._uLightAttenuation[a],l.attenuation)),this._uLightDir[a]&&i.uniform3fv(this._uLightDir[a],l.dir)}if(this._withSAO){var h=e.sao;if(h.possible){var u=i.drawingBufferWidth,c=i.drawingBufferHeight;Tr[0]=u,Tr[1]=c,Tr[2]=h.blendCutoff,Tr[3]=h.blendFactor,i.uniform4fv(this._uSAOParams,Tr),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,0)}}if(e.logarithmicDepthBufferEnabled){var p=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,p)}},Nr.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Nr.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState;t._lightsState;var i=e.sectionPlanes.length>0,r=[];return r.push("// Triangles batching flat-shading draw vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),r.push("attribute vec4 color;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),i&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vViewPosition;"),r.push("varying vec4 vColor;"),r.push("void main(void) {"),r.push("if (int(flags.x) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&r.push("worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("vViewPosition = viewPosition;"),r.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),i&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;")),r.push("gl_Position = clipPos;"),r.push("}"),r.push("}"),r},Nr.prototype._buildFragmentShader=function(){var t=this._scene,e=t._lightsState,i=t._sectionPlanesState,r=i.sectionPlanes.length>0,s=[];if(s.push("// Triangles batching flat-shading draw fragment shader"),s.push("#extension GL_OES_standard_derivatives : enable"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),r){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var o=0,a=i.sectionPlanes.length;o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}s.push("uniform mat4 viewMatrix;"),s.push("uniform vec4 lightAmbient;");for(var n=0,l=e.lights.length;n<l;n++){var h=e.lights[n];"ambient"!==h.type&&(s.push("uniform vec4 lightColor"+n+";"),"dir"===h.type&&s.push("uniform vec3 lightDir"+n+";"),"point"===h.type&&s.push("uniform vec3 lightPos"+n+";"),"spot"===h.type&&(s.push("uniform vec3 lightPos"+n+";"),s.push("uniform vec3 lightDir"+n+";")))}if(s.push("varying vec4 vViewPosition;"),s.push("varying vec4 vColor;"),s.push("void main(void) {"),r){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var u=0,c=i.sectionPlanes.length;u<c;u++)s.push("if (sectionPlaneActive"+u+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+u+".xyz, vWorldPosition.xyz - sectionPlanePos"+u+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}s.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),s.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),s.push("float lambertian = 1.0;"),s.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),s.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),s.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(var p=0,d=e.lights.length;p<d;p++){var f=e.lights[p];if("ambient"!==f.type){if("dir"===f.type)"view"===f.space?s.push("viewLightDir = normalize(lightDir"+p+");"):s.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+p+", 0.0)).xyz);");else if("point"===f.type)"view"===f.space?s.push("viewLightDir = -normalize(lightPos"+p+" - viewPosition.xyz);"):s.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+p+", 0.0)).xyz);");else{if("spot"!==f.type)continue;"view"===f.space?s.push("viewLightDir = normalize(lightDir"+p+");"):s.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+p+", 0.0)).xyz);")}s.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),s.push("reflectedColor += lambertian * (lightColor"+p+".rgb * lightColor"+p+".a);")}}return s.push("vec4 fragColor =  vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),s.push("   gl_FragColor            = vec4(fragColor.rgb * ambient, 1.0);")):s.push("   gl_FragColor            = fragColor;"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s},Nr.prototype.webglContextRestored=function(){this._program=null},Nr.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Ir=new Float32Array([1,1,1]),kr=E.vec3(),Or=function(t,e){this._scene=t,this._hash=this._getHash(),this._allocate()};Or.prototype.getValid=function(){return this._hash===this._getHash()},Or.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Or.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===xr){var h=s.xrayMaterial._state,u=h.fillColor,c=h.fillAlpha;a.uniform4f(this._uColor,u[0],u[1],u[2],c)}else if(i===Pr){var p=s.highlightMaterial._state,d=p.fillColor,f=p.fillAlpha;a.uniform4f(this._uColor,d[0],d[1],d[2],f)}else if(i===Mr){var _=s.selectedMaterial._state,g=_.fillColor,m=_.fillAlpha;a.uniform4f(this._uColor,g[0],g[1],g[2],m)}else a.uniform4fv(this._uColor,Ir);var v=l?rt(o.viewMatrix,l):o.viewMatrix;a.uniformMatrix4fv(this._uViewMatrix,!1,v),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var b=s._sectionPlanesState.sectionPlanes.length;if(b>0)for(var y=s._sectionPlanesState.sectionPlanes,P=e.layerIndex*b,M=r.renderFlags,x=0;x<b;x++){var w=this._uSectionPlanes[x];if(w){var E=M.sectionPlanesActivePerLayer[P+x];if(a.uniform1i(w.active,E?1:0),E){var C=y[x];if(l){var A=at(C.dist,C.dir,l,kr);a.uniform3fv(w.pos,A)}else a.uniform3fv(w.pos,C.pos);a.uniform3fv(w.dir,C.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}},Or.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},Or.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},Or.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Or.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 color;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},Or.prototype._buildFragmentShader=function(){var t,e,i=this._scene,r=i._sectionPlanesState,s=r.sectionPlanes.length>0,o=[];if(o.push("// Triangles batching silhouette fragment shader"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),s)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),t=0,e=r.sectionPlanes.length;t<e;t++)o.push("uniform bool sectionPlaneActive"+t+";"),o.push("uniform vec3 sectionPlanePos"+t+";"),o.push("uniform vec3 sectionPlaneDir"+t+";");if(o.push("uniform vec4 color;"),o.push("void main(void) {"),s){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),t=0,e=r.sectionPlanes.length;t<e;t++)o.push("if (sectionPlaneActive"+t+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("gl_FragColor = color;"),o.push("}"),o},Or.prototype.webglContextRestored=function(){this._program=null},Or.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Vr=E.vec3(),zr=new Float32Array([0,0,0,1]),Ur=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Ur.prototype.getValid=function(){return this._hash===this._getHash()},Ur.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Ur.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;if(this._program||(this._allocate(e),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===Sr){var h=s.xrayMaterial._state,u=h.edgeColor,c=h.edgeAlpha;a.uniform4f(this._uColor,u[0],u[1],u[2],c)}else if(i===Cr){var p=s.highlightMaterial._state,d=p.edgeColor,f=p.edgeAlpha;a.uniform4f(this._uColor,d[0],d[1],d[2],f)}else if(i===Ar){var _=s.selectedMaterial._state,g=_.edgeColor,m=_.edgeAlpha;a.uniform4f(this._uColor,g[0],g[1],g[2],m)}else a.uniform4fv(this._uColor,zr);a.uniformMatrix4fv(this._uViewMatrix,!1,l?rt(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var v=s._sectionPlanesState.sectionPlanes.length;if(v>0)for(var b=s._sectionPlanesState.sectionPlanes,y=e.layerIndex*v,P=r.renderFlags,M=0;M<v;M++){var x=this._uSectionPlanes[M];if(x){var w=P.sectionPlanesActivePerLayer[y+M];if(a.uniform1i(x.active,w?1:0),w){var E=b[M];if(l){var C=at(E.dist,E.dir,l,Vr);a.uniform3fv(x.pos,C)}else a.uniform3fv(x.pos,E.pos);a.uniform3fv(x.dir,E.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.edgeIndicesBuf.bind(),a.drawElements(a.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0)}},Ur.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},Ur.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=this._program,r=t.camera.project;if(i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),t.logarithmicDepthBufferEnabled){var s=2/(Math.log(r.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,s)}},Ur.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Ur.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry edges drawing vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i},Ur.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = vColor;"),r.push("}"),r},Ur.prototype.webglContextRestored=function(){this._program=null},Ur.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var jr=E.vec3(),Gr=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Gr.prototype.getValid=function(){return this._hash===this._getHash()},Gr.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Gr.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;if(this._program||(this._allocate(e),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?rt(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var h=s._sectionPlanesState.sectionPlanes.length;if(h>0)for(var u=s._sectionPlanesState.sectionPlanes,c=e.layerIndex*h,p=r.renderFlags,d=0;d<h;d++){var f=this._uSectionPlanes[d];if(f){var _=p.sectionPlanesActivePerLayer[c+d];if(a.uniform1i(f.active,_?1:0),_){var g=u[d];if(l){var m=at(g.dist,g.dir,l,jr);a.uniform3fv(f.pos,m)}else a.uniform3fv(f.pos,g.pos);a.uniform3fv(f.dir,g.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.edgeIndicesBuf.bind(),a.drawElements(a.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0)}},Gr.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},Gr.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=this._program,r=t.camera.project;if(i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),t.logarithmicDepthBufferEnabled){var s=2/(Math.log(r.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,s)}},Gr.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Gr.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry edges drawing vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i},Gr.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = vColor;"),r.push("}"),r},Gr.prototype.webglContextRestored=function(){this._program=null},Gr.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Xr=E.vec3(),Wr=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Wr.prototype.getValid=function(){return this._hash===this._getHash()},Wr.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Wr.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var h=t.pickViewMatrix||o.viewMatrix,u=l?rt(h,l):h;if(a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,u),s.logarithmicDepthBufferEnabled){var c=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,c)}var p=s._sectionPlanesState.sectionPlanes.length;if(p>0)for(var d=s._sectionPlanesState.sectionPlanes,f=e.layerIndex*p,_=r.renderFlags,g=0;g<p;g++){var m=this._uSectionPlanes[g];if(m){var v=_.sectionPlanesActivePerLayer[f+g];if(a.uniform1i(m.active,v?1:0),v){var b=d[g];if(l){var y=at(b.dist,b.dir,l,Xr);a.uniform3fv(m.pos,y)}else a.uniform3fv(m.pos,b.pos);a.uniform3fv(m.dir,b.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aPickColor&&this._aPickColor.bindArrayBuffer(n.pickColorsBuf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)},Wr.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aPickColor=i.getAttribute("pickColor"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},Wr.prototype._bindProgram=function(t){var e=this._scene.canvas.gl;this._program.bind(),e.uniform1i(this._uPickInvisible,t.pickInvisible)},Wr.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Wr.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry picking vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 pickColor;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vPickColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i},Wr.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry picking fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vPickColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(s=0;s<e.sectionPlanes.length;s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   gl_FragColor = vPickColor; "),r.push("}"),r},Wr.prototype.webglContextRestored=function(){this._program=null},Wr.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Hr=E.vec3(),Yr=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Yr.prototype.getValid=function(){return this._hash===this._getHash()},Yr.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Yr.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;this._program||this._allocate(),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible);var h=t.pickViewMatrix||o.viewMatrix,u=l?rt(h,l):h;if(a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniform1f(this._uPickZNear,t.pickZNear),a.uniform1f(this._uPickZFar,t.pickZFar),s.logarithmicDepthBufferEnabled){var c=2/(Math.log(t.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,c)}var p=s._sectionPlanesState.sectionPlanes.length;if(p>0)for(var d=s._sectionPlanesState.sectionPlanes,f=e.layerIndex*p,_=r.renderFlags,g=0;g<p;g++){var m=this._uSectionPlanes[g];if(m){var v=_.sectionPlanesActivePerLayer[f+g];if(a.uniform1i(m.active,v?1:0),v){var b=d[g];if(l){var y=at(b.dist,b.dir,l,Hr);a.uniform3fv(m.pos,y)}else a.uniform3fv(m.pos,b.pos);a.uniform3fv(m.dir,b.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)},Yr.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},Yr.prototype._bindProgram=function(){this._program.bind()},Yr.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Yr.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching pick depth vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i},Yr.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching pick depth fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),r.push("uniform float pickZNear;"),r.push("uniform float pickZFar;"),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vViewPosition;"),r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(s=0;s<e.sectionPlanes.length;s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),r.push("    gl_FragColor = packDepth(zNormalizedDepth); "),r.push("}"),r},Yr.prototype.webglContextRestored=function(){this._program=null},Yr.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Kr=E.vec3(),qr=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};qr.prototype.getValid=function(){return this._hash===this._getHash()},qr.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},qr.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var h=t.pickViewMatrix||o.viewMatrix,u=l?rt(h,l):h;if(a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),s.logarithmicDepthBufferEnabled){var c=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,c)}var p=s._sectionPlanesState.sectionPlanes.length;if(p>0)for(var d=s._sectionPlanesState.sectionPlanes,f=e.layerIndex*p,_=r.renderFlags,g=0;g<p;g++){var m=this._uSectionPlanes[g];if(m){var v=_.sectionPlanesActivePerLayer[f+g];if(a.uniform1i(m.active,v?1:0),v){var b=d[g];if(l){var y=at(b.dist,b.dir,l,Kr);a.uniform3fv(m.pos,y)}else a.uniform3fv(m.pos,b.pos);a.uniform3fv(m.dir,b.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(n.normalsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)},qr.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},qr.prototype._bindProgram=function(){this._program.bind()},qr.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},qr.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching pick normals vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vec3 worldNormal =  octDecode(normal.xy); "),i.push("      vWorldNormal = worldNormal;"),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i},qr.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching pick normals fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec3 vWorldNormal;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(s=0;s<e.sectionPlanes.length;s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    gl_FragColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),r.push("}"),r},qr.prototype.webglContextRestored=function(){this._program=null},qr.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Zr=E.vec3(),Qr=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Qr.prototype.getValid=function(){return this._hash===this._getHash()},Qr.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Qr.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.canvas.gl,a=e._state,n=s.camera,l=e._state.rtcCenter;if(this._program||(this._allocate(e),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uViewMatrix,!1,l?rt(n.viewMatrix,l):n.viewMatrix),o.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var h=s._sectionPlanesState.sectionPlanes.length;if(h>0)for(var u=s._sectionPlanesState.sectionPlanes,c=e.layerIndex*h,p=r.renderFlags,d=0;d<h;d++){var f=this._uSectionPlanes[d];if(f){var _=p.sectionPlanesActivePerLayer[c+d];if(o.uniform1i(f.active,_?1:0),_){var g=u[d];if(l){var m=at(g.dist,g.dir,l,Zr);o.uniform3fv(f.pos,m)}else o.uniform3fv(f.pos,g.pos);o.uniform3fv(f.dir,g.dir)}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),o.drawElements(o.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}},Qr.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},Qr.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},Qr.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Qr.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i},Qr.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching occlusion fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("      if (sectionPlaneActive"+o+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),r.push("}"),r},Qr.prototype.webglContextRestored=function(){this._program=null},Qr.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Jr=E.vec3(),$r=function(t){this._scene=t,this._allocate(),this._hash=this._getHash()};$r.prototype.getValid=function(){return this._hash===this._getHash()},$r.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},$r.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,l?rt(o.viewMatrix,l):o.viewMatrix);var h=s._sectionPlanesState.sectionPlanes.length;if(h>0)for(var u=s._sectionPlanesState.sectionPlanes,c=e.layerIndex*h,p=r.renderFlags,d=0;d<h;d++){var f=this._uSectionPlanes[d];if(f){var _=p.sectionPlanesActivePerLayer[c+d];if(a.uniform1i(f.active,_?1:0),_){var g=u[d];if(l){var m=at(g.dist,g.dir,l,Jr);a.uniform3fv(f.pos,m)}else a.uniform3fv(f.pos,g.pos);a.uniform3fv(f.dir,g.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}},$r.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},$r.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},$r.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},$r.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching depth vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("  }"),i.push("}"),i},$r.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching depth fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("precision highp float;"),r.push("precision highp int;"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("const float   packUpScale = 256. / 255.;"),r.push("const float   unpackDownscale = 255. / 256.;"),r.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),r.push("const float   shiftRight8 = 1.0 / 256.;"),r.push("vec4 packDepthToRGBA( const in float v ) {"),r.push("    vec4 r = vec4( fract( v * packFactors ), v );"),r.push("    r.yzw -= r.xyz * shiftRight8;"),r.push("    return r * packUpScale;"),r.push("}"),r.push("varying vec2 vHighPrecisionZW;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("      if (sectionPlaneActive"+o+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?r.push("    gl_FragColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "):r.push("    gl_FragColor = packDepthToRGBA(fragCoordZ); "),r.push("}"),r},$r.prototype.webglContextRestored=function(){this._program=null},$r.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null,S.memory.programs--};var ts=E.vec3(),es=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};es.prototype.getValid=function(){return this._hash===this._getHash()},es.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},es.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;if(this._program||(this._allocate(e),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(e)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?rt(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix);var h=s._sectionPlanesState.sectionPlanes.length;if(h>0)for(var u=s._sectionPlanesState.sectionPlanes,c=e.layerIndex*h,p=r.renderFlags,d=0;d<h;d++){var f=this._uSectionPlanes[d];if(f){var _=p.sectionPlanesActivePerLayer[c+d];if(a.uniform1i(f.active,_?1:0),_){var g=u[d];if(l){var m=at(g.dist,g.dir,l,ts);a.uniform3fv(f.pos,m)}else a.uniform3fv(f.pos,g.pos);a.uniform3fv(f.dir,g.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}},es.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2&&(this._aFlags2=i.getAttribute("flags2")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},es.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},es.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},es.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry normals vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),e&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags2         = flags2;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i},es.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry normals fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec3 vViewNormal;"),r.push("vec3 packNormalToRGB( const in vec3 normal ) {"),r.push("    return normalize( normal ) * 0.5 + 0.5;"),r.push("}"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("      if (sectionPlaneActive"+o+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),r.push("}"),r},es.prototype.webglContextRestored=function(){this._program=null},es.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var is=E.vec3(),rs=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};rs.prototype.getValid=function(){return this._hash===this._getHash()},rs.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},rs.prototype.drawLayer=function(t,e){var i=this._scene,r=i.canvas.gl,s=e._state;this._program||this._allocate(),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),i.logarithmicDepthBufferEnabled&&r.uniform1f(this._uZFar,i.camera.project.far),this._aPosition.bindArrayBuffer(s.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(s.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(s.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(s.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(s.offsetsBuf),s.indicesBuf.bind();var o=i._sectionPlanesState.sectionPlanes.length;if(o>0)for(var a=i._sectionPlanesState.sectionPlanes,n=e.layerIndex*o,l=model.renderFlags,h=e._state.rtcCenter,u=0;u<o;u++){var c=this._uSectionPlanes[u];if(c){var p=l.sectionPlanesActivePerLayer[n+u];if(r.uniform1i(c.active,p?1:0),p){var d=a[u];if(h){var f=at(d.dist,d.dir,h,is);r.uniform3fv(c.pos,f)}else r.uniform3fv(c.pos,d.pos);r.uniform3fv(c.dir,d.dir)}}}r.drawElements(r.TRIANGLES,s.indicesBuf.numItems,s.indicesBuf.itemType,0)},rs.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=r.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=r.getLocation("shadowProjMatrix"),t.logarithmicDepthBufferEnabled&&(this._uZFar=r.getLocation("zFar")),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2")}},rs.prototype._bindProgram=function(t){var e=this._scene.canvas.gl;this._program.bind(),e.uniformMatrix4fv(this._uShadowViewMatrix,!1,t.shadowViewMatrix),e.uniformMatrix4fv(this._uShadowProjMatrix,!1,t.shadowProjMatrix),this._lastLightId=null},rs.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},rs.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry shadow vertex shader"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("  bool visible        = (float(flags.x) > 0.0);"),i.push("  bool transparent    = ((float(color.a) / 255.0) < 1.0);"),i.push("  if (!visible || transparent) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = shadowViewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("      vViewPosition = viewPosition;"),i.push("      gl_Position = shadowProjMatrix * viewPosition;"),i.push("  }"),i.push("}"),i},rs.prototype._buildFragmentShader=function(){var t=this._scene._sectionPlanesState,e=t.sectionPlanes.length>0,i=[];if(i.push("// Batched geometry shadow fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e){i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)i.push("uniform bool sectionPlaneActive"+r+";"),i.push("uniform vec3 sectionPlanePos"+r+";"),i.push("uniform vec3 sectionPlaneDir"+r+";")}if(i.push("varying vec4 vViewPosition;"),i.push("vec4 encodeFloat( const in float v ) {"),i.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),i.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),i.push("  vec4 comp = fract(v * bitShift);"),i.push("  comp -= comp.xxyz * bitMask;"),i.push("  return comp;"),i.push("}"),i.push("void main(void) {"),e){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<t.sectionPlanes.length;s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragColor = encodeFloat( gl_FragCoord.z); "),i.push("}"),i},rs.prototype.webglContextRestored=function(){this._program=null},rs.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var ss=E.vec4(),os=E.vec3(),as={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"},ns=function(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()};ns.prototype.getValid=function(){return this._hash===this._getHash()},ns.prototype._getHash=function(){var t=this._scene;return[t.gammaOutput,t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")},ns.prototype.drawLayer=function(t,e,i){var r=this._scene,s=r.camera,o=e.model,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?rt(s.viewMatrix,l):s.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,o.worldNormalMatrix);var h=r._sectionPlanesState.sectionPlanes.length;if(h>0)for(var u=r._sectionPlanesState.sectionPlanes,c=e.layerIndex*h,p=o.renderFlags,d=0;d<h;d++){var f=this._uSectionPlanes[d];if(f){var _=p.sectionPlanesActivePerLayer[c+d];if(a.uniform1i(f.active,_?1:0),_){var g=u[d];if(l){var m=at(g.dist,g.dir,l,os);a.uniform3fv(f.pos,m)}else a.uniform3fv(f.pos,g.pos);a.uniform3fv(f.dir,g.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aMetallicRoughness&&this._aMetallicRoughness.bindArrayBuffer(n.metallicRoughnessBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}},ns.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uWorldNormalMatrix=r.getLocation("worldNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uGammaFactor=r.getLocation("gammaFactor"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var s=i.lights,o=0,a=s.length;o<a;o++)switch(s[o].type){case"dir":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=null,this._uLightDir[o]=r.getLocation("lightDir"+o);break;case"point":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=null,this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o);break;case"spot":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=r.getLocation("lightDir"+o),this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(var n=0,l=t._sectionPlanesState.sectionPlanes.length;n<l;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aNormal=r.getAttribute("normal"),this._aColor=r.getAttribute("color"),this._aMetallicRoughness=r.getAttribute("metallicRoughness"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},ns.prototype._bindProgram=function(t){var e=wt.MAX_TEXTURE_UNITS,i=this._scene,r=i.canvas.gl,s=this._program,o=i._lightsState,a=o.lights,n=i.camera.project;s.bind(),r.uniformMatrix4fv(this._uProjMatrix,!1,n.matrix),this._uLightAmbient&&r.uniform4fv(this._uLightAmbient,i._lightsState.getAmbientColorAndIntensity());for(var l=0,h=a.length;l<h;l++){var u=a[l];this._uLightColor[l]&&r.uniform4f(this._uLightColor[l],u.color[0],u.color[1],u.color[2],u.intensity),this._uLightPos[l]&&(r.uniform3fv(this._uLightPos[l],u.pos),this._uLightAttenuation[l]&&r.uniform1f(this._uLightAttenuation[l],u.attenuation)),this._uLightDir[l]&&r.uniform3fv(this._uLightDir[l],u.dir)}if(o.reflectionMaps.length>0&&o.reflectionMaps[0].texture&&this._uReflectionMap&&(s.bindTexture(this._uReflectionMap,o.reflectionMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),o.lightMaps.length>0&&o.lightMaps[0].texture&&this._uLightMap&&(s.bindTexture(this._uLightMap,o.lightMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),this._withSAO){var c=i.sao;if(c.possible){var p=r.drawingBufferWidth,d=r.drawingBufferHeight;ss[0]=p,ss[1]=d,ss[2]=c.blendCutoff,ss[3]=c.blendFactor,r.uniform4fv(this._uSAOParams,ss),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++}}if(i.logarithmicDepthBufferEnabled){var f=2/(Math.log(n.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,f)}this._uGammaFactor&&r.uniform1f(this._uGammaFactor,i.gammaFactor)},ns.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},ns.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState,i=t._lightsState,r=e.sectionPlanes.length>0,s=e.clippingCaps,o=[];return o.push("// Triangles batching quality draw vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("uniform int renderPass;"),o.push("attribute vec3 position;"),o.push("attribute vec3 normal;"),o.push("attribute vec4 color;"),o.push("attribute vec2 metallicRoughness;"),o.push("attribute vec4 flags;"),o.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&o.push("attribute vec3 offset;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("varying vec4 vViewPosition;"),o.push("varying vec3 vViewNormal;"),o.push("varying vec4 vColor;"),o.push("varying vec2 vMetallicRoughness;"),i.lightMaps.length>0&&o.push("varying vec3 vWorldNormal;"),r&&(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),s&&o.push("varying vec4 vClipPosition;")),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;"))),r&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;"),s&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o},ns.prototype._buildFragmentShader=function(){var t=this._scene,e=t.gammaOutput,i=t._sectionPlanesState,r=t._lightsState,s=i.sectionPlanes.length>0,o=i.clippingCaps,a=[];a.push("// Triangles batching quality draw fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;")),a.push("varying vec4 vViewPosition;"),a.push("varying vec3 vViewNormal;"),a.push("varying vec4 vColor;"),a.push("varying vec2 vMetallicRoughness;"),r.lightMaps.length>0&&a.push("varying vec3 vWorldNormal;"),a.push("uniform mat4 viewMatrix;"),r.reflectionMaps.length>0&&a.push("uniform samplerCube reflectionMap;"),r.lightMaps.length>0&&a.push("uniform samplerCube lightMap;"),a.push("uniform vec4 lightAmbient;");for(var n=0,l=r.lights.length;n<l;n++){var h=r.lights[n];"ambient"!==h.type&&(a.push("uniform vec4 lightColor"+n+";"),"dir"===h.type&&a.push("uniform vec3 lightDir"+n+";"),"point"===h.type&&a.push("uniform vec3 lightPos"+n+";"),"spot"===h.type&&(a.push("uniform vec3 lightPos"+n+";"),a.push("uniform vec3 lightDir"+n+";")))}if(this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBAToDepth( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),a.push("uniform float gammaFactor;"),a.push("vec4 linearToLinear( in vec4 value ) {"),a.push("  return value;"),a.push("}"),a.push("vec4 sRGBToLinear( in vec4 value ) {"),a.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),a.push("}"),a.push("vec4 gammaToLinear( in vec4 value) {"),a.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),a.push("}"),e&&(a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}")),s){a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),o&&a.push("varying vec4 vClipPosition;");for(var u=0,c=i.sectionPlanes.length;u<c;u++)a.push("uniform bool sectionPlaneActive"+u+";"),a.push("uniform vec3 sectionPlanePos"+u+";"),a.push("uniform vec3 sectionPlaneDir"+u+";")}if(a.push("#define PI 3.14159265359"),a.push("#define RECIPROCAL_PI 0.31830988618"),a.push("#define RECIPROCAL_PI2 0.15915494"),a.push("#define EPSILON 1e-6"),a.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),a.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),a.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),a.push("}"),a.push("struct IncidentLight {"),a.push("   vec3 color;"),a.push("   vec3 direction;"),a.push("};"),a.push("struct ReflectedLight {"),a.push("   vec3 diffuse;"),a.push("   vec3 specular;"),a.push("};"),a.push("struct Geometry {"),a.push("   vec3 position;"),a.push("   vec3 viewNormal;"),a.push("   vec3 worldNormal;"),a.push("   vec3 viewEyeDir;"),a.push("};"),a.push("struct Material {"),a.push("   vec3    diffuseColor;"),a.push("   float   specularRoughness;"),a.push("   vec3    specularColor;"),a.push("   float   shine;"),a.push("};"),a.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),a.push("   float r = ggxRoughness + 0.0001;"),a.push("   return (2.0 / (r * r) - 2.0);"),a.push("}"),a.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),a.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),a.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),a.push("}"),r.reflectionMaps.length>0&&(a.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),a.push("   vec3 envMapColor = "+as[r.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),a.push("  return envMapColor;"),a.push("}")),a.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),a.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),a.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),a.push("}"),a.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   return 1.0 / ( gl * gv );"),a.push("}"),a.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   return 0.5 / max( gv + gl, EPSILON );"),a.push("}"),a.push("float D_GGX(const in float alpha, const in float dotNH) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),a.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float alpha = ( roughness * roughness );"),a.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),a.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),a.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),a.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),a.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),a.push("   vec3  F = F_Schlick( specularColor, dotLH );"),a.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),a.push("   float D = D_GGX( alpha, dotNH );"),a.push("   return F * (G * D);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),a.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),a.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),a.push("   vec4 r = roughness * c0 + c1;"),a.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),a.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),a.push("   return specularColor * AB.x + AB.y;"),a.push("}"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&(a.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),r.lightMaps.length>0&&(a.push("   vec3 irradiance = "+as[r.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),a.push("   irradiance *= PI;"),a.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.diffuse +=  irradiance * diffuseBRDFContrib;")),r.reflectionMaps.length>0&&(a.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),a.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),a.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),a.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),a.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),a.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),a.push("}")),a.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),a.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),a.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),a.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),a.push("}"),a.push("void main(void) {"),s){a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(var p=0,d=i.sectionPlanes.length;p<d;p++)a.push("if (sectionPlaneActive"+p+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+p+".xyz, vWorldPosition.xyz - sectionPlanePos"+p+".xyz), 0.0, 1000.0);"),a.push("}");o?(a.push("  if (dist > (0.002 * vClipPosition.w)) {"),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      gl_FragColor=vec4(1.0, 0.0, 0.0, 1.0);"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("  gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("  return;"),a.push("}")):(a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }")),a.push("}")}a.push("IncidentLight  light;"),a.push("Material       material;"),a.push("Geometry       geometry;"),a.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),a.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),a.push("float alpha = float(vColor.a) / 255.0;"),a.push("vec3  diffuseColor = rgb;"),a.push("float specularF0 = 1.0;"),a.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),a.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),a.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),a.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),a.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),a.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);"),a.push("geometry.position      = vViewPosition.xyz;"),a.push("geometry.viewNormal    = -normalize(vViewNormal);"),a.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),r.lightMaps.length>0&&a.push("geometry.worldNormal   = normalize(vWorldNormal);"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&a.push("computePBRLightMapping(geometry, material, reflectedLight);");for(var f=0,_=r.lights.length;f<_;f++){var g=r.lights[f];if("ambient"!==g.type){if("dir"===g.type)"view"===g.space?a.push("light.direction =  normalize(lightDir"+f+");"):a.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+f+", 0.0)).xyz);");else if("point"===g.type)"view"===g.space?a.push("light.direction =  normalize(lightPos"+f+" - vViewPosition.xyz);"):a.push("light.direction =  normalize((viewMatrix * vec4(lightPos"+f+", 0.0)).xyz);");else{if("spot"!==g.type)continue;"view"===g.space?a.push("light.direction =  normalize(lightDir"+f+");"):a.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+f+", 0.0)).xyz);")}a.push("light.color =  lightColor"+f+".rgb * lightColor"+f+".a;"),a.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return a.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular);"),a.push("vec4 fragColor;"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),a.push("   fragColor               = vec4(outgoingLight.rgb * ambient, alpha);")):a.push("   fragColor            = vec4(outgoingLight.rgb, alpha);"),e&&a.push("fragColor = linearToGamma(fragColor, gammaFactor);"),a.push("gl_FragColor = fragColor;"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a},ns.prototype.webglContextRestored=function(){this._program=null},ns.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var ls=E.vec3(),hs=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};hs.prototype.getValid=function(){return this._hash===this._getHash()},hs.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},hs.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var h=t.pickViewMatrix||o.viewMatrix,u=l?rt(h,l):h;if(a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),s.logarithmicDepthBufferEnabled){var c=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,c)}var p=s._sectionPlanesState.sectionPlanes.length;if(p>0)for(var d=s._sectionPlanesState.sectionPlanes,f=e.layerIndex*p,_=r.renderFlags,g=0;g<p;g++){var m=this._uSectionPlanes[g],v=_.sectionPlanesActivePerLayer[f+g];if(a.uniform1i(m.active,v?1:0),v){var b=d[g];if(l){var y=at(b.dist,b.dir,l,ls);a.uniform3fv(m.pos,y)}else a.uniform3fv(m.pos,b.pos);a.uniform3fv(m.dir,b.dir)}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)},hs.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},hs.prototype._bindProgram=function(){this._program.bind()},hs.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},hs.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching pick flat normals vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("varying vec4 vWorldPosition;"),e&&i.push("varying vec4 vFlags2;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),e&&i.push("      vFlags2 = flags2;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i},hs.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching pick flat normals fragment shader"),r.push("#extension GL_OES_standard_derivatives : enable"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),r.push("varying vec4 vWorldPosition;"),i){r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(s=0;s<e.sectionPlanes.length;s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),r.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),r.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),r.push("  gl_FragColor = vec4((worldNormal * 0.5) + 0.5, 1.0);"),r.push("}"),r},hs.prototype.webglContextRestored=function(){this._program=null},hs.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var us=function(t){this._scene=t},cs={colorRenderer:{configurable:!0},colorRendererWithSAO:{configurable:!0},flatColorRenderer:{configurable:!0},flatColorRendererWithSAO:{configurable:!0},colorQualityRenderer:{configurable:!0},colorQualityRendererWithSAO:{configurable:!0},silhouetteRenderer:{configurable:!0},depthRenderer:{configurable:!0},normalsRenderer:{configurable:!0},edgesRenderer:{configurable:!0},edgesColorRenderer:{configurable:!0},pickMeshRenderer:{configurable:!0},pickNormalsRenderer:{configurable:!0},pickNormalsFlatRenderer:{configurable:!0},pickDepthRenderer:{configurable:!0},occlusionRenderer:{configurable:!0},shadowRenderer:{configurable:!0}};us.prototype._compile=function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorQualityRenderer&&!this._colorQualityRenderer.getValid()&&(this._colorQualityRenderer.destroy(),this._colorQualityRenderer=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!1===this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)},cs.colorRenderer.get=function(){return this._colorRenderer||(this._colorRenderer=new Rr(this._scene,!1)),this._colorRenderer},cs.colorRendererWithSAO.get=function(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Rr(this._scene,!0)),this._colorRendererWithSAO},cs.flatColorRenderer.get=function(){return this._flatColorRenderer||(this._flatColorRenderer=new Nr(this._scene,!1)),this._flatColorRenderer},cs.flatColorRendererWithSAO.get=function(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new Nr(this._scene,!0)),this._flatColorRendererWithSAO},cs.colorQualityRenderer.get=function(){return this._colorQualityRenderer||(this._colorQualityRenderer=new ns(this._scene,!1)),this._colorQualityRenderer},cs.colorQualityRendererWithSAO.get=function(){return this._colorQualityRendererWithSAO||(this._colorQualityRendererWithSAO=new ns(this._scene,!0)),this._colorQualityRendererWithSAO},cs.silhouetteRenderer.get=function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Or(this._scene)),this._silhouetteRenderer},cs.depthRenderer.get=function(){return this._depthRenderer||(this._depthRenderer=new $r(this._scene)),this._depthRenderer},cs.normalsRenderer.get=function(){return this._normalsRenderer||(this._normalsRenderer=new es(this._scene)),this._normalsRenderer},cs.edgesRenderer.get=function(){return this._edgesRenderer||(this._edgesRenderer=new Ur(this._scene)),this._edgesRenderer},cs.edgesColorRenderer.get=function(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Gr(this._scene)),this._edgesColorRenderer},cs.pickMeshRenderer.get=function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Wr(this._scene)),this._pickMeshRenderer},cs.pickNormalsRenderer.get=function(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new qr(this._scene)),this._pickNormalsRenderer},cs.pickNormalsFlatRenderer.get=function(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new hs(this._scene)),this._pickNormalsFlatRenderer},cs.pickDepthRenderer.get=function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Yr(this._scene)),this._pickDepthRenderer},cs.occlusionRenderer.get=function(){return this._occlusionRenderer||(this._occlusionRenderer=new Qr(this._scene)),this._occlusionRenderer},cs.shadowRenderer.get=function(){return this._shadowRenderer||(this._shadowRenderer=new rs(this._scene)),this._shadowRenderer},us.prototype._destroy=function(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorQualityRenderer&&this._colorQualityRenderer.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()},Object.defineProperties(us.prototype,cs);var ps={};var ds=wt.SUPPORTED_EXTENSIONS.OES_element_index_uint,fs=function(t){void 0===t&&(t=5e6),ds?t>5e6&&(t=5e6):t>65530&&(t=65530),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.metallicRoughness=[],this.normals=[],this.pickColors=[],this.flags=[],this.flags2=[],this.offsets=[],this.indices=[],this.edgeIndices=[]},_s=E.mat4(),gs=E.mat4();function ms(t,e,i){for(var r=t.length,s=new Uint16Array(r),o=e[0],a=e[1],n=e[2],l=e[3]-o,h=e[4]-a,u=e[5]-n,c=65525,p=c/l,d=c/h,f=c/u,_=function(t){return t>=0?t:0},g=0;g<r;g+=3)s[g+0]=Math.floor(_(t[g+0]-o)*p),s[g+1]=Math.floor(_(t[g+1]-a)*d),s[g+2]=Math.floor(_(t[g+2]-n)*f);return E.identityMat4(_s),E.translationMat4v(e,_s),E.identityMat4(gs),E.scalingMat4v([l/c,h/c,u/c],gs),E.mulMat4(_s,gs,i),s}function vs(t,e,i){var r=t[0]/(Math.abs(t[0])+Math.abs(t[1])+Math.abs(t[2])),s=t[1]/(Math.abs(t[0])+Math.abs(t[1])+Math.abs(t[2]));if(t[2]<0){var o,a;o=(1-Math.abs(s))*(r>=0?1:-1),a=(1-Math.abs(r))*(s>=0?1:-1),r=o,s=a}return new Int8Array([Math[e](127.5*r+(r<0?-1:0)),Math[i](127.5*s+(s<0?-1:0))])}function bs(t,e,i,r){var s=t[e]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2])),o=t[e+1]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2]));if(t[e+2]<0){var a=(1-Math.abs(o))*(s>=0?1:-1),n=(1-Math.abs(s))*(o>=0?1:-1);s=a,o=n}return new Int8Array([Math[i](127.5*s+(s<0?-1:0)),Math[r](127.5*o+(o<0?-1:0))])}function ys(t){var e=t[0],i=t[1];e/=e<0?127:128,i/=i<0?127:128;var r=1-Math.abs(e)-Math.abs(i);r<0&&(e=(1-Math.abs(i))*(e>=0?1:-1),i=(1-Math.abs(e))*(i>=0?1:-1));var s=Math.sqrt(e*e+i*i+r*r);return[e/s,i/s,r/s]}function Ps(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}var Ms=E.mat4(),xs=E.mat4(),ws=E.vec4([0,0,0,1]),Es=E.vec4([0,0,0,1]),Cs=E.vec4([0,0,0,1]),As=E.OBB3(),Ss=E.vec3(),Ds=E.vec3(),Ls=E.vec3(),Bs=E.vec3(),Rs=E.vec3(),Ts=E.vec3(),Fs=E.vec3(),Ns=function(t,e){var i,r,s;this.sortId="TrianglesBatchingLayer"+(e.solid?"-solid":"-surface")+(e.autoNormals?"-autonormals":"-normals"),this.layerIndex=e.layerIndex,this._batchingRenderers=(i=t.scene,r=i.id,(s=ps[r])||(s=new us(i),ps[r]=s,s._compile(),i.on("compile",(function(){s._compile()})),i.on("destroyed",(function(){delete ps[r],s._destroy()}))),s),this.model=t,this._buffer=new fs(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new oe({positionsBuf:null,offsetsBuf:null,normalsBuf:null,colorsBuf:null,metallicRoughnessBuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:E.mat4()}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=E.collapseAABB3(),this._portions=[],this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressed=!0):this._preCompressed=!1,e.rtcCenter&&(this._state.rtcCenter=E.vec3(e.rtcCenter)),this.aabb=E.collapseAABB3(),this.solid=!!e.solid};Ns.prototype.canCreatePortion=function(t,e){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+t<3*this._buffer.maxVerts&&this._buffer.indices.length+e<this._buffer.maxIndices},Ns.prototype.createPortion=function(t){if(this._finalized)throw"Already finalized";var e=t.positions,i=t.normals,r=t.indices,s=t.edgeIndices,o=t.color,a=t.metallic,n=t.roughness,l=t.colors,h=t.opacity,u=t.meshMatrix,c=t.worldMatrix,p=t.worldAABB,d=t.pickColor,f=this.model.scene,_=this._buffer,g=_.positions.length/3,m=e.length/3,v=e.length;if(this._preCompressed){for(var b=0,y=e.length;b<y;b++)_.positions.push(e[b]);var P=Re.getPositionsBounds(e),M=Re.decompressPosition(P.min,this._state.positionsDecodeMatrix,[]),x=Re.decompressPosition(P.max,this._state.positionsDecodeMatrix,[]);p[0]=M[0],p[1]=M[1],p[2]=M[2],p[3]=x[0],p[4]=x[1],p[5]=x[2],c&&(E.AABB3ToOBB3(p,As),E.transformOBB3(c,As),E.OBB3ToAABB3(As,p))}else{for(var w=_.positions.length,C=0,A=e.length;C<A;C++)_.positions.push(e[C]);if(u)for(var S=w,D=w+v;S<D;S+=3)ws[0]=_.positions[S+0],ws[1]=_.positions[S+1],ws[2]=_.positions[S+2],E.transformPoint4(u,ws,Es),_.positions[S+0]=Es[0],_.positions[S+1]=Es[1],_.positions[S+2]=Es[2],E.expandAABB3Point3(this._modelAABB,Es),c?(E.transformPoint4(c,Es,Cs),E.expandAABB3Point3(p,Cs)):E.expandAABB3Point3(p,Es);else for(var L=w,B=w+v;L<B;L+=3)ws[0]=_.positions[L+0],ws[1]=_.positions[L+1],ws[2]=_.positions[L+2],E.expandAABB3Point3(this._modelAABB,ws),c?(E.transformPoint4(c,ws,Es),E.expandAABB3Point3(p,Es)):E.expandAABB3Point3(p,ws)}if(this._state.rtcCenter){var R=this._state.rtcCenter;p[0]+=R[0],p[1]+=R[1],p[2]+=R[2],p[3]+=R[0],p[4]+=R[1],p[5]+=R[2]}if(E.expandAABB3(this.aabb,p),i&&i.length>0)if(this._preCompressed)for(var T=0,F=i.length;T<F;T++)_.normals.push(i[T]);else{var N=Ms;u?E.inverseMat4(E.transposeMat4(u,xs),N):E.identityMat4(N,N),function(t,e,i,r,s){var o,a,n,l,h,u=new Float32Array([0,0,0,0]),c=new Float32Array([0,0,0,0]);for(h=0;h<i;h+=3)u[0]=e[h],u[1]=e[h+1],u[2]=e[h+2],E.transformVec3(t,u,c),E.normalizeVec3(c,c),a=o=vs(c,"floor","floor"),n=l=Ps(c,ys(o)),(n=Ps(c,ys(o=vs(c,"ceil","floor"))))>l&&(a=o,l=n),(n=Ps(c,ys(o=vs(c,"floor","ceil"))))>l&&(a=o,l=n),(n=Ps(c,ys(o=vs(c,"ceil","ceil"))))>l&&(a=o,l=n),r[s+h+0]=a[0],r[s+h+1]=a[1],r[s+h+2]=0}(N,i,i.length,_.normals,_.normals.length)}if(l)for(var I=0,k=l.length;I<k;I+=3)_.colors.push(255*l[I]),_.colors.push(255*l[I+1]),_.colors.push(255*l[I+2]),_.colors.push(255);else if(o)for(var O=o[0],V=o[1],z=o[2],U=h,j=null!=a?a:0,G=null!=n?n:255,X=0;X<m;X++)_.colors.push(O),_.colors.push(V),_.colors.push(z),_.colors.push(U),_.metallicRoughness.push(j),_.metallicRoughness.push(G);if(r)for(var W=0,H=r.length;W<H;W++)_.indices.push(r[W]+g);if(s)for(var Y=0,K=s.length;Y<K;Y++)_.edgeIndices.push(s[Y]+g);for(var q=_.pickColors.length,Z=q,Q=q+4*m;Z<Q;Z+=4)_.pickColors.push(d[0]),_.pickColors.push(d[1]),_.pickColors.push(d[2]),_.pickColors.push(d[3]);if(f.entityOffsetsEnabled)for(var J=0;J<m;J++)_.offsets.push(0),_.offsets.push(0),_.offsets.push(0);var $=this._portions.length,tt={vertsBase:g,numVerts:m};return f.pickSurfacePrecisionEnabled&&(r&&(tt.indices=r),f.entityOffsetsEnabled&&(tt.offset=new Float32Array(3))),this._portions.push(tt),this._numPortions++,this.model.numPortions++,$},Ns.prototype.finalize=function(){if(this._finalized)this.model.error("Already finalized");else{var t=this._state,e=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0){var r=this._preCompressed?new Uint16Array(i.positions):ms(i.positions,this._modelAABB,t.positionsDecodeMatrix);if(t.positionsBuf=new Ut(e,e.ARRAY_BUFFER,r,r.length,3,e.STATIC_DRAW),this.model.scene.pickSurfacePrecisionEnabled)for(var s=0,o=this._portions.length;s<o;s++){var a=this._portions[s],n=3*a.vertsBase,l=n+3*a.numVerts;a.quantizedPositions=r.slice(n,l)}}if(i.normals.length>0){var h=new Int8Array(i.normals);t.normalsBuf=new Ut(e,e.ARRAY_BUFFER,h,i.normals.length,3,e.STATIC_DRAW,!0)}if(i.colors.length>0){var u=new Uint8Array(i.colors);t.colorsBuf=new Ut(e,e.ARRAY_BUFFER,u,i.colors.length,4,e.DYNAMIC_DRAW,!1)}if(i.metallicRoughness.length>0){var c=new Uint8Array(i.metallicRoughness);t.metallicRoughnessBuf=new Ut(e,e.ARRAY_BUFFER,c,i.metallicRoughness.length,2,e.STATIC_DRAW,!1)}if(i.positions.length>0){var p=i.positions.length/3*4,d=new Uint8Array(p),f=new Uint8Array(p);t.flagsBuf=new Ut(e,e.ARRAY_BUFFER,d,d.length,4,e.DYNAMIC_DRAW,!1),t.flags2Buf=new Ut(e,e.ARRAY_BUFFER,f,f.length,4,e.DYNAMIC_DRAW,!0)}if(i.pickColors.length>0){var _=new Uint8Array(i.pickColors);t.pickColorsBuf=new Ut(e,e.ARRAY_BUFFER,_,i.pickColors.length,4,e.STATIC_DRAW,!1)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){var g=new Float32Array(i.offsets);t.offsetsBuf=new Ut(e,e.ARRAY_BUFFER,g,i.offsets.length,3,e.DYNAMIC_DRAW)}var m=wt.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(i.indices.length>0){var v=m?new Uint32Array(i.indices):new Uint16Array(i.indices);t.indicesBuf=new Ut(e,e.ELEMENT_ARRAY_BUFFER,v,i.indices.length,1,e.STATIC_DRAW)}if(i.edgeIndices.length>0){var b=m?new Uint32Array(i.edgeIndices):new Uint16Array(i.edgeIndices);t.edgeIndicesBuf=new Ut(e,e.ELEMENT_ARRAY_BUFFER,b,i.edgeIndices.length,1,e.STATIC_DRAW)}this._buffer=null,this._finalized=!0}},Ns.prototype.isEmpty=function(){return!this._state.indicesBuf},Ns.prototype.initFlags=function(t,e,i){e&G&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&q&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&K&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&Z&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&H&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&Q&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&W&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&X&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)},Ns.prototype.setVisible=function(t,e,i){if(!this._finalized)throw"Not finalized";e&G?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)},Ns.prototype.setHighlighted=function(t,e,i){if(!this._finalized)throw"Not finalized";e&q?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)},Ns.prototype.setXRayed=function(t,e,i){if(!this._finalized)throw"Not finalized";e&K?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)},Ns.prototype.setSelected=function(t,e,i){if(!this._finalized)throw"Not finalized";e&Z?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)},Ns.prototype.setEdges=function(t,e,i){if(!this._finalized)throw"Not finalized";e&Q?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)},Ns.prototype.setClippable=function(t,e){if(!this._finalized)throw"Not finalized";e&H?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)},Ns.prototype.setCulled=function(t,e,i){if(!this._finalized)throw"Not finalized";e&X?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)},Ns.prototype.setCollidable=function(t,e){if(!this._finalized)throw"Not finalized"},Ns.prototype.setPickable=function(t,e,i){if(!this._finalized)throw"Not finalized";e&W?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(t,e,i)},Ns.prototype.setColor=function(t,e){if(!this._finalized)throw"Not finalized";for(var i=t,r=this._portions[i],s=4*r.vertsBase,o=4*r.numVerts,a=this._scratchMemory.getUInt8Array(o),n=e[0],l=e[1],h=e[2],u=e[3],c=0;c<o;c+=4)a[c+0]=n,a[c+1]=l,a[c+2]=h,a[c+3]=u;this._state.colorsBuf&&this._state.colorsBuf.setData(a,s,o)},Ns.prototype.setTransparent=function(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)},Ns.prototype._setFlags=function(t,e,i){if(!this._finalized)throw"Not finalized";var r,s,o=t,a=this._portions[o],n=4*a.vertsBase,l=4*a.numVerts,h=this._scratchMemory.getUInt8Array(l),u=!!(e&G),c=!!(e&K),p=!!(e&q),d=!!(e&Z),f=!!(e&X);r=!u||f||c?vr:i?yr:br,s=!u||f?vr:d?Mr:p?Pr:c?xr:vr;var _=0;_=!u||f?vr:d?Ar:p?Cr:c?Sr:!!(e&Q)?i?Er:wr:vr;for(var g=u&&!f&&!!(e&W)?Dr:vr,m=0;m<l;m+=4)h[m+0]=r,h[m+1]=s,h[m+2]=_,h[m+3]=g;this._state.flagsBuf&&this._state.flagsBuf.setData(h,n,l)},Ns.prototype._setFlags2=function(t,e){if(!this._finalized)throw"Not finalized";for(var i=t,r=this._portions[i],s=4*r.vertsBase,o=4*r.numVerts,a=this._scratchMemory.getUInt8Array(o),n=e&H?255:0,l=0;l<o;l+=4)a[l+0]=n;this._state.flags2Buf&&this._state.flags2Buf.setData(a,s,o)},Ns.prototype.setOffset=function(t,e){if(!this._finalized)throw"Not finalized";if(this.model.scene.entityOffsetsEnabled){for(var i=t,r=this._portions[i],s=3*r.vertsBase,o=3*r.numVerts,a=this._scratchMemory.getFloat32Array(o),n=e[0],l=e[1],h=e[2],u=0;u<o;u+=3)a[u+0]=n,a[u+1]=l,a[u+2]=h;this._state.offsetsBuf&&this._state.offsetsBuf.setData(a,s,o),this.model.scene.pickSurfacePrecisionEnabled&&(r.offset[0]=e[0],r.offset[1]=e[1],r.offset[2]=e[2])}else this.model.error("Entity#offset not enabled for this Viewer")},Ns.prototype.drawColorOpaque=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),e.withSAO&&this.model.saoEnabled?e.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._batchingRenderers.colorQualityRendererWithSAO&&this._batchingRenderers.colorQualityRendererWithSAO.drawLayer(e,this,br):this._state.normalsBuf?this._batchingRenderers.colorRendererWithSAO&&this._batchingRenderers.colorRendererWithSAO.drawLayer(e,this,br):this._batchingRenderers.flatColorRendererWithSAO&&this._batchingRenderers.flatColorRendererWithSAO.drawLayer(e,this,br):e.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._batchingRenderers.colorQualityRenderer&&this._batchingRenderers.colorQualityRenderer.drawLayer(e,this,br):this._state.normalsBuf?this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(e,this,br):this._batchingRenderers.flatColorRenderer&&this._batchingRenderers.flatColorRenderer.drawLayer(e,this,br))},Ns.prototype._updateBackfaceCull=function(t,e){var i=this.model.backfaces||!this.solid||t.sectioned;if(e.backfaces!==i){var r=e.gl;i?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),e.backfaces=i}},Ns.prototype.drawColorTransparent=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),e.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._batchingRenderers.colorQualityRenderer&&this._batchingRenderers.colorQualityRenderer.drawLayer(e,this,yr):this._state.normalsBuf?this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(e,this,yr):this._batchingRenderers.flatColorRenderer&&this._batchingRenderers.flatColorRenderer.drawLayer(e,this,yr))},Ns.prototype.drawDepth=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.depthRenderer&&this._batchingRenderers.depthRenderer.drawLayer(e,this,br))},Ns.prototype.drawNormals=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.normalsRenderer&&this._batchingRenderers.normalsRenderer.drawLayer(e,this,br))},Ns.prototype.drawSilhouetteXRayed=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,xr))},Ns.prototype.drawSilhouetteHighlighted=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,Pr))},Ns.prototype.drawSilhouetteSelected=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,Mr))},Ns.prototype.drawEdgesColorOpaque=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._batchingRenderers.edgesColorRenderer&&this._batchingRenderers.edgesColorRenderer.drawLayer(e,this,wr)},Ns.prototype.drawEdgesColorTransparent=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._batchingRenderers.edgesColorRenderer&&this._batchingRenderers.edgesColorRenderer.drawLayer(e,this,Er)},Ns.prototype.drawEdgesHighlighted=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(e,this,Cr)},Ns.prototype.drawEdgesSelected=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(e,this,Ar)},Ns.prototype.drawEdgesXRayed=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(e,this,Sr)},Ns.prototype.drawOcclusion=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.occlusionRenderer&&this._batchingRenderers.occlusionRenderer.drawLayer(e,this,br))},Ns.prototype.drawShadow=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.shadowRenderer&&this._batchingRenderers.shadowRenderer.drawLayer(e,this,br))},Ns.prototype.drawPickMesh=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.pickMeshRenderer&&this._batchingRenderers.pickMeshRenderer.drawLayer(e,this,Dr))},Ns.prototype.drawPickDepths=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.pickDepthRenderer&&this._batchingRenderers.pickDepthRenderer.drawLayer(e,this,Dr))},Ns.prototype.drawPickNormals=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._state.normalsBuf?this._batchingRenderers.pickNormalsRenderer&&this._batchingRenderers.pickNormalsRenderer.drawLayer(e,this,Dr):this._batchingRenderers.pickNormalsFlatRenderer&&this._batchingRenderers.pickNormalsFlatRenderer.drawLayer(e,this,Dr))},Ns.prototype.precisionRayPickSurface=function(t,e,i,r){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;var s=this._state,o=this._portions[t];if(!o)return this.model.error("portion not found: "+t),!1;var a=o.quantizedPositions,n=o.indices,l=s.rtcCenter,h=o.offset,u=Ss,c=Ds;u.set(l?E.subVec3(e,l,Ls):e),c.set(i),h&&E.subVec3(u,h),E.transformRay(this.model.worldNormalMatrix,u,c,u,c);for(var p=Bs,d=Rs,f=Ts,_=!1,g=0,m=Fs,v=0,b=n.length;v<b;v+=3){var y=3*n[v],P=3*n[v+1],M=3*n[v+2];if(p[0]=a[y],p[1]=a[y+1],p[2]=a[y+2],d[0]=a[P],d[1]=a[P+1],d[2]=a[P+2],f[0]=a[M],f[1]=a[M+1],f[2]=a[M+2],E.decompressPosition(p,s.positionsDecodeMatrix),E.decompressPosition(d,s.positionsDecodeMatrix),E.decompressPosition(f,s.positionsDecodeMatrix),E.rayTriangleIntersect(u,c,p,d,f,m)){E.transformPoint3(this.model.worldMatrix,m,m),h&&E.addVec3(m,h),l&&E.addVec3(m,l);var x=Math.abs(E.lenVec3(E.subVec3(m,e,[])));(!_||x>g)&&(g=x,r.set(m),_=!0)}}return _},Ns.prototype.destroy=function(){var t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.normalsBuf&&(t.normalsBuf.destroy(),t.normalsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.metallicRoughnessBuf&&(t.metallicRoughnessBuf.destroy(),t.metallicRoughnessBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.edgeIndicesBuf&&(t.edgeIndicesBuf.destroy(),t.edgeIndicessBuf=null),t.destroy()};var Is=E.vec4(),ks=E.vec3(),Os=function(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()};Os.prototype.getValid=function(){return this._hash===this._getHash()},Os.prototype._getHash=function(){var t=this._scene;return[t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")},Os.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix);var u=s._sectionPlanesState.sectionPlanes.length;if(u>0)for(var c=s._sectionPlanesState.sectionPlanes,p=e.layerIndex*u,d=r.renderFlags,f=0;f<u;f++){var _=this._uSectionPlanes[f];if(_){var g=d.sectionPlanesActivePerLayer[p+f];if(a.uniform1i(_.active,g?1:0),g){var m=c[f];if(h){var v=at(m.dist,m.dir,h,ks);a.uniform3fv(_.pos,v)}else a.uniform3fv(_.pos,m.pos);a.uniform3fv(_.dir,m.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(n.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(n.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(n.modelNormalMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},Os.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uWorldNormalMatrix=r.getLocation("worldNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var s=i.lights,o=0,a=s.length;o<a;o++)switch(s[o].type){case"dir":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=null,this._uLightDir[o]=r.getLocation("lightDir"+o);break;case"point":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=null,this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o);break;case"spot":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=r.getLocation("lightDir"+o),this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o)}this._uSectionPlanes=[];for(var n=0,l=t._sectionPlanesState.sectionPlanes.length;n<l;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aNormal=r.getAttribute("normal"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aOffset=r.getAttribute("offset"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=r.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=r.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=r.getAttribute("modelNormalMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Os.prototype._bindProgram=function(t){var e=this._scene,i=e.canvas.gl,r=e._lightsState.lights,s=e.camera.project;this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,e._lightsState.getAmbientColorAndIntensity());for(var o=0,a=r.length;o<a;o++){var n=r[o];this._uLightColor[o]&&i.uniform4f(this._uLightColor[o],n.color[0],n.color[1],n.color[2],n.intensity),this._uLightPos[o]&&(i.uniform3fv(this._uLightPos[o],n.pos),this._uLightAttenuation[o]&&i.uniform1f(this._uLightAttenuation[o],n.attenuation)),this._uLightDir[o]&&i.uniform3fv(this._uLightDir[o],n.dir)}if(this._withSAO){var l=e.sao;if(l.possible){var h=i.drawingBufferWidth,u=i.drawingBufferHeight;Is[0]=h,Is[1]=u,Is[2]=l.blendCutoff,Is[3]=l.blendFactor,i.uniform4fv(this._uSAOParams,Is),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,0)}}if(e.logarithmicDepthBufferEnabled){var c=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,c)}},Os.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Os.prototype._buildVertexShader=function(){var t,e,i,r=this._scene,s=r._sectionPlanesState,o=r._lightsState,a=s.sectionPlanes.length>0,n=[];for(n.push("// Instancing geometry drawing vertex shader"),r.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("#extension GL_EXT_frag_depth : enable"),n.push("uniform int renderPass;"),n.push("attribute vec3 position;"),n.push("attribute vec2 normal;"),n.push("attribute vec4 color;"),n.push("attribute vec4 flags;"),n.push("attribute vec4 flags2;"),r.entityOffsetsEnabled&&n.push("attribute vec3 offset;"),n.push("attribute vec4 modelMatrixCol0;"),n.push("attribute vec4 modelMatrixCol1;"),n.push("attribute vec4 modelMatrixCol2;"),n.push("attribute vec4 modelNormalMatrixCol0;"),n.push("attribute vec4 modelNormalMatrixCol1;"),n.push("attribute vec4 modelNormalMatrixCol2;"),n.push("uniform mat4 worldMatrix;"),n.push("uniform mat4 worldNormalMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 viewNormalMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform mat4 positionsDecodeMatrix;"),r.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("varying float vFragDepth;")),n.push("uniform vec4 lightAmbient;"),t=0,e=o.lights.length;t<e;t++)"ambient"!==(i=o.lights[t]).type&&(n.push("uniform vec4 lightColor"+t+";"),"dir"===i.type&&n.push("uniform vec3 lightDir"+t+";"),"point"===i.type&&n.push("uniform vec3 lightPos"+t+";"),"spot"===i.type&&(n.push("uniform vec3 lightPos"+t+";"),n.push("uniform vec3 lightDir"+t+";")));for(n.push("vec3 octDecode(vec2 oct) {"),n.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),n.push("    if (v.z < 0.0) {"),n.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),n.push("    }"),n.push("    return normalize(v);"),n.push("}"),a&&(n.push("varying vec4 vWorldPosition;"),n.push("varying vec4 vFlags2;")),n.push("varying vec4 vColor;"),n.push("void main(void) {"),n.push("if (int(flags.x) != renderPass) {"),n.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),n.push("} else {"),n.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),n.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),r.entityOffsetsEnabled&&n.push("      worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix * worldPosition; "),n.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),n.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),n.push("vec3 viewNormal = normalize(vec4(viewNormalMatrix * worldNormal).xyz);"),n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),t=0,e=o.lights.length;t<e;t++)if("ambient"!==(i=o.lights[t]).type){if("dir"===i.type)"view"===i.space?n.push("viewLightDir = normalize(lightDir"+t+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===i.type)"view"===i.space?n.push("viewLightDir = -normalize(lightPos"+t+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==i.type)continue;"view"===i.space?n.push("viewLightDir = normalize(lightDir"+t+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);")}n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}return n.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),n.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),n.push("vec4 clipPos = projMatrix * viewPosition;"),r.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?n.push("vFragDepth = 1.0 + clipPos.w;"):(n.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),n.push("clipPos.z *= clipPos.w;"))),a&&(n.push("vWorldPosition = worldPosition;"),n.push("vFlags2 = flags2;")),n.push("gl_Position = clipPos;"),n.push("}"),n.push("}"),n},Os.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Instancing geometry drawing fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),this._withSAO&&(r.push("uniform sampler2D uOcclusionTexture;"),r.push("uniform vec4      uSAOParams;"),r.push("const float       packUpscale = 256. / 255.;"),r.push("const float       unpackDownScale = 255. / 256.;"),r.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),r.push("float unpackRGBToFloat( const in vec4 v ) {"),r.push("    return dot( v, unPackFactors );"),r.push("}")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { "),r.push("      discard;"),r.push("  }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(r.push("   float viewportWidth     = uSAOParams[0];"),r.push("   float viewportHeight    = uSAOParams[1];"),r.push("   float blendCutoff       = uSAOParams[2];"),r.push("   float blendFactor       = uSAOParams[3];"),r.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),r.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),r.push("   gl_FragColor            = vec4(vColor.rgb * ambient, 1.0);")):r.push("    gl_FragColor           = vColor;"),r.push("}"),r},Os.prototype.webglContextRestored=function(){this._program=null},Os.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Vs=E.vec4(),zs=E.vec3(),Us=function(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()};Us.prototype.getValid=function(){return this._hash===this._getHash()},Us.prototype._getHash=function(){var t=this._scene;return[t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")},Us.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var u=s._sectionPlanesState.sectionPlanes.length;if(u>0)for(var c=s._sectionPlanesState.sectionPlanes,p=e.layerIndex*u,d=r.renderFlags,f=0;f<u;f++){var _=this._uSectionPlanes[f],g=d.sectionPlanesActivePerLayer[p+f];if(a.uniform1i(_.active,g?1:0),g){var m=c[f];if(h){var v=at(m.dist,m.dir,h,zs);a.uniform3fv(_.pos,v)}else a.uniform3fv(_.pos,m.pos);a.uniform3fv(_.dir,m.dir)}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},Us.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var s=i.lights,o=0,a=s.length;o<a;o++)switch(s[o].type){case"dir":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=null,this._uLightDir[o]=r.getLocation("lightDir"+o);break;case"point":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=null,this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o);break;case"spot":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=r.getLocation("lightDir"+o),this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o)}this._uSectionPlanes=[];for(var n=0,l=t._sectionPlanesState.sectionPlanes.length;n<l;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aOffset=r.getAttribute("offset"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Us.prototype._bindProgram=function(t){var e=this._scene,i=e.canvas.gl,r=e._lightsState.lights,s=e.camera.project;this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,e._lightsState.getAmbientColorAndIntensity());for(var o=0,a=r.length;o<a;o++){var n=r[o];this._uLightColor[o]&&i.uniform4f(this._uLightColor[o],n.color[0],n.color[1],n.color[2],n.intensity),this._uLightPos[o]&&(i.uniform3fv(this._uLightPos[o],n.pos),this._uLightAttenuation[o]&&i.uniform1f(this._uLightAttenuation[o],n.attenuation)),this._uLightDir[o]&&i.uniform3fv(this._uLightDir[o],n.dir)}if(this._withSAO){var l=e.sao;if(l.possible){var h=i.drawingBufferWidth,u=i.drawingBufferHeight;Vs[0]=h,Vs[1]=u,Vs[2]=l.blendCutoff,Vs[3]=l.blendFactor,i.uniform4fv(this._uSAOParams,Vs),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,0)}}if(e.logarithmicDepthBufferEnabled){var c=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,c)}},Us.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Us.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry flat-shading drawing vertex shader"),i.push("#extension GL_OES_standard_derivatives : enable"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},Us.prototype._buildFragmentShader=function(){var t,e,i=this._scene,r=i._sectionPlanesState,s=i._lightsState,o=r.sectionPlanes.length>0,a=[];if(a.push("// Instancing geometry flat-shading drawing fragment shader"),a.push("#extension GL_OES_standard_derivatives : enable"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;")),this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBToFloat( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),o){a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;");for(var n=0,l=r.sectionPlanes.length;n<l;n++)a.push("uniform bool sectionPlaneActive"+n+";"),a.push("uniform vec3 sectionPlanePos"+n+";"),a.push("uniform vec3 sectionPlaneDir"+n+";")}for(a.push("uniform mat4 viewMatrix;"),a.push("uniform vec4 lightAmbient;"),t=0,e=s.lights.length;t<e;t++){var h=s.lights[t];"ambient"!==h.type&&(a.push("uniform vec4 lightColor"+t+";"),"dir"===h.type&&a.push("uniform vec3 lightDir"+t+";"),"point"===h.type&&a.push("uniform vec3 lightPos"+t+";"),"spot"===h.type&&(a.push("uniform vec3 lightPos"+t+";"),a.push("uniform vec3 lightDir"+t+";")))}if(a.push("varying vec4 vViewPosition;"),a.push("varying vec4 vColor;"),a.push("void main(void) {"),o){a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(var u=0,c=r.sectionPlanes.length;u<c;u++)a.push("if (sectionPlaneActive"+u+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+u+".xyz, vWorldPosition.xyz - sectionPlanePos"+u+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }"),a.push("}")}for(a.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),a.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),a.push("float lambertian = 1.0;"),a.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),a.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),a.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),t=0,e=s.lights.length;t<e;t++){var p=s.lights[t];if("ambient"!==p.type){if("dir"===p.type)"view"===p.space?a.push("viewLightDir = normalize(lightDir"+t+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===p.type)"view"===p.space?a.push("viewLightDir = -normalize(lightPos"+t+" - viewPosition.xyz);"):a.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==p.type)continue;"view"===p.space?a.push("viewLightDir = normalize(lightDir"+t+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);")}a.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),a.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}}return a.push("vec4 fragColor = vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),a.push("   gl_FragColor            = vec4(fragColor.rgb * ambient, 1.0);")):a.push("    gl_FragColor           = fragColor;"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a},Us.prototype.webglContextRestored=function(){this._program=null},Us.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var js=E.vec3(),Gs=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Gs.prototype.getValid=function(){return this._hash===this._getHash()},Gs.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Gs.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(e.model.scene),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===xr){var u=s.xrayMaterial._state,c=u.fillColor,p=u.fillAlpha;a.uniform4f(this._uColor,c[0],c[1],c[2],p)}else if(i===Pr){var d=s.highlightMaterial._state,f=d.fillColor,_=d.fillAlpha;a.uniform4f(this._uColor,f[0],f[1],f[2],_)}else if(i===Mr){var g=s.selectedMaterial._state,m=g.fillColor,v=g.fillAlpha;a.uniform4f(this._uColor,m[0],m[1],m[2],v)}else a.uniform4fv(this._uColor,E.vec3([1,1,1]));a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var b=s._sectionPlanesState.sectionPlanes.length;if(b>0)for(var y=s._sectionPlanesState.sectionPlanes,P=e.layerIndex*b,M=r.renderFlags,x=0;x<b;x++){var w=this._uSectionPlanes[x];if(w){var C=M.sectionPlanesActivePerLayer[P+x];if(a.uniform1i(w.active,C?1:0),C){var A=y[x];if(h){var S=at(A.dist,A.dir,h,js);a.uniform3fv(w.pos,S)}else a.uniform3fv(w.pos,A.pos);a.uniform3fv(w.dir,A.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},Gs.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uColor=r.getLocation("color"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Gs.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},Gs.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Gs.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing fill vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("uniform vec4 color;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},Gs.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Instancing fill fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("uniform vec4 color;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = color;"),r.push("}"),r},Gs.prototype.webglContextRestored=function(){this._program=null},Gs.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Xs=E.vec3(),Ws=new Float32Array([0,0,0,1]),Hs=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Hs.prototype.getValid=function(){return this._hash===this._getHash()},Hs.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Hs.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(e),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===Sr){var u=s.xrayMaterial._state,c=u.edgeColor,p=u.edgeAlpha;a.uniform4f(this._uColor,c[0],c[1],c[2],p)}else if(i===Cr){var d=s.highlightMaterial._state,f=d.edgeColor,_=d.edgeAlpha;a.uniform4f(this._uColor,f[0],f[1],f[2],_)}else if(i===Ar){var g=s.selectedMaterial._state,m=g.edgeColor,v=g.edgeAlpha;a.uniform4f(this._uColor,m[0],m[1],m[2],v)}else a.uniform4fv(this._uColor,Ws);a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var b=s._sectionPlanesState.sectionPlanes.length;if(b>0)for(var y=s._sectionPlanesState.sectionPlanes,P=e.layerIndex*b,M=r.renderFlags,x=0;x<b;x++){var w=this._uSectionPlanes[x];if(w){var E=M.sectionPlanesActivePerLayer[P+x];if(a.uniform1i(w.active,E?1:0),E){var C=y[x];if(h){var A=at(C.dist,C.dir,h,Xs);a.uniform3fv(w.pos,A)}else a.uniform3fv(w.pos,C.pos);a.uniform3fv(w.dir,C.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags&&(this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1)),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.edgeIndicesBuf.bind(),l.drawElementsInstancedANGLE(a.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0),this._aFlags&&l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0)}},Hs.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uColor=r.getLocation("color"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Hs.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},Hs.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Hs.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles instancing edges vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i},Hs.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = vColor;"),r.push("}"),r},Hs.prototype.webglContextRestored=function(){this._program=null},Hs.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Ys=E.vec3(),Ks=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Ks.prototype.getValid=function(){return this._hash===this._getHash()},Ks.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Ks.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(e),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var u=s._sectionPlanesState.sectionPlanes.length;if(u>0)for(var c=s._sectionPlanesState.sectionPlanes,p=e.layerIndex*u,d=r.renderFlags,f=0;f<u;f++){var _=this._uSectionPlanes[f];if(_){var g=d.sectionPlanesActivePerLayer[p+f];if(a.uniform1i(_.active,g?1:0),g){var m=c[f];if(h){var v=at(m.dist,m.dir,h,Ys);a.uniform3fv(_.pos,v)}else a.uniform3fv(_.pos,m.pos);a.uniform3fv(_.dir,m.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1)),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.edgeIndicesBuf.bind(),l.drawElementsInstancedANGLE(a.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0),this._aFlags&&l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0)}},Ks.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._aOffset=r.getAttribute("offset"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Ks.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},Ks.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Ks.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles instancing edges vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i},Ks.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = vColor;"),r.push("}"),r},Ks.prototype.webglContextRestored=function(){this._program=null},Ks.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var qs=E.vec3(),Zs=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Zs.prototype.getValid=function(){return this._hash===this._getHash()},Zs.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Zs.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i);var u=t.pickViewMatrix||o.viewMatrix,c=h?rt(u,h):u;if(a.uniformMatrix4fv(this._uViewMatrix,!1,c),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),s.logarithmicDepthBufferEnabled){var p=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,p)}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPickColor.bindArrayBuffer(n.pickColorsBuf),l.vertexAttribDivisorANGLE(this._aPickColor.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind();var d=s._sectionPlanesState.sectionPlanes.length;if(d>0)for(var f=s._sectionPlanesState.sectionPlanes,_=e.layerIndex*d,g=r.renderFlags,m=0;m<d;m++){var v=this._uSectionPlanes[m];if(v){var b=g.sectionPlanesActivePerLayer[_+m];if(a.uniform1i(v.active,b?1:0),b){var y=f[m];if(h){var P=at(y.dist,y.dir,h,qs);a.uniform3fv(v.pos,P)}else a.uniform3fv(v.pos,y.pos);a.uniform3fv(v.dir,y.dir)}}}l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aPickColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},Zs.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uPickInvisible=r.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._uRenderPass=r.getLocation("renderPass"),this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aPickColor=r.getAttribute("pickColor"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Zs.prototype._bindProgram=function(t){var e=this._scene.canvas.gl;this._program.bind(),e.uniform1i(this._uPickInvisible,t.pickInvisible)},Zs.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Zs.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry picking vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 pickColor;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vPickColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},Zs.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry picking fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vPickColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = vPickColor; "),r.push("}"),r},Zs.prototype.webglContextRestored=function(){this._program=null},Zs.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Qs=E.vec3(),Js=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Js.prototype.getValid=function(){return this._hash===this._getHash()},Js.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Js.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.canvas.gl,a=e._state,n=this._instanceExt,l=e._state.rtcCenter;if(this._program||(this._allocate(e),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram());var h=s.camera;o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,t.pickInvisible);var u=t.pickViewMatrix||h.viewMatrix,c=l?rt(u,l):u;if(o.uniformMatrix4fv(this._uViewMatrix,!1,c),o.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),o.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),o.uniform1f(this._uPickZNear,t.pickZNear),o.uniform1f(this._uPickZFar,t.pickZFar),s.logarithmicDepthBufferEnabled){var p=2/(Math.log(t.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,p)}var d=s._sectionPlanesState.sectionPlanes.length;if(d>0)for(var f=s._sectionPlanesState.sectionPlanes,_=e.layerIndex*d,g=r.renderFlags,m=0;m<d;m++){var v=this._uSectionPlanes[m];if(v){var b=g.sectionPlanesActivePerLayer[_+m];if(o.uniform1i(v.active,b?1:0),b){var y=f[m];if(l){var P=at(y.dist,y.dir,l,Qs);o.uniform3fv(v.pos,P)}else o.uniform3fv(v.pos,y.pos);o.uniform3fv(v.dir,y.dir)}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.indicesBuf.bind(),n.drawElementsInstancedANGLE(o.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),n.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisorANGLE(this._aOffset.location,0)}},Js.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},Js.prototype._bindProgram=function(){this._program.bind()},Js.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Js.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry depth vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("  vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},Js.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry depth fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),r.push("uniform float pickZNear;"),r.push("uniform float pickZFar;"),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vViewPosition;"),r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),r.push("    gl_FragColor = packDepth(zNormalizedDepth); "),r.push("}"),r},Js.prototype.webglContextRestored=function(){this._program=null},Js.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var $s=E.vec3(),to=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};to.prototype.getValid=function(){return this._hash===this._getHash()},to.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},to.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(e),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible);var u=t.pickViewMatrix||o.viewMatrix,c=h?rt(u,h):u;if(a.uniformMatrix4fv(this._uViewMatrix,!1,c),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix),s.logarithmicDepthBufferEnabled){var p=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,p)}var d=s._sectionPlanesState.sectionPlanes.length;if(d>0)for(var f=s._sectionPlanesState.sectionPlanes,_=e.layerIndex*d,g=r.renderFlags,m=0;m<d;m++){var v=this._uSectionPlanes[m];if(v){var b=g.sectionPlanesActivePerLayer[_+m];if(a.uniform1i(v.active,b?1:0),b){var y=f[m];if(h){var P=at(y.dist,y.dir,h,$s);a.uniform3fv(v.pos,P)}else a.uniform3fv(v.pos,y.pos);a.uniform3fv(v.dir,y.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(n.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(n.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(n.modelNormalMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},to.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPickInvisible=r.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uWorldNormalMatrix=r.getLocation("worldNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aNormal=r.getAttribute("normal"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=r.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=r.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=r.getAttribute("modelNormalMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},to.prototype._bindProgram=function(){this._program.bind()},to.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},to.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry normals vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec2 normal;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("attribute vec4 modelNormalMatrixCol0;"),i.push("attribute vec4 modelNormalMatrixCol1;"),i.push("attribute vec4 modelNormalMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),i.push("  vWorldNormal = worldNormal;"),e&&i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},to.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry normals fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec3 vWorldNormal;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    gl_FragColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),r.push("}"),r},to.prototype.webglContextRestored=function(){this._program=null},to.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var eo=E.vec3(),io=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};io.prototype.getValid=function(){return this._hash===this._getHash()},io.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},io.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var u=s._sectionPlanesState.sectionPlanes.length;if(u>0)for(var c=s._sectionPlanesState.sectionPlanes,p=e.layerIndex*u,d=r.renderFlags,f=0;f<u;f++){var _=this._uSectionPlanes[f];if(_){var g=d.sectionPlanesActivePerLayer[p+f];if(a.uniform1i(_.active,g?1:0),g){var m=c[f];if(h){var v=at(m.dist,m.dir,h,eo);a.uniform3fv(_.pos,v)}else a.uniform3fv(_.pos,m.pos);a.uniform3fv(_.dir,m.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aColor&&(this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1)),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aColor&&l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},io.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},io.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},io.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},io.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},io.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Instancing occlusion fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r},io.prototype.webglContextRestored=function(){this._program=null},io.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var ro=E.vec3(),so=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};so.prototype.getValid=function(){return this._hash===this._getHash()},so.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},so.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix);var u=s._sectionPlanesState.sectionPlanes.length;if(u>0)for(var c=s._sectionPlanesState.sectionPlanes,p=e.layerIndex*u,d=r.renderFlags,f=0;f<u;f++){var _=this._uSectionPlanes[f];if(_){var g=d.sectionPlanesActivePerLayer[p+f];if(a.uniform1i(_.active,g?1:0),g){var m=c[f];if(h){var v=at(m.dist,m.dir,h,ro);a.uniform3fv(_.pos,v)}else a.uniform3fv(_.pos,m.pos);a.uniform3fv(_.dir,m.dir)}}}this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},so.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},so.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},so.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},so.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry depth drawing vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("}"),i.push("}"),i},so.prototype._buildFragmentShader=function(){var t,e,i=this._scene,r=i._sectionPlanesState,s=r.sectionPlanes.length>0,o=[];if(o.push("// Instancing geometry depth drawing fragment shader"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("precision highp float;"),o.push("precision highp int;"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),s)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),t=0,e=r.sectionPlanes.length;t<e;t++)o.push("uniform bool sectionPlaneActive"+t+";"),o.push("uniform vec3 sectionPlanePos"+t+";"),o.push("uniform vec3 sectionPlaneDir"+t+";");if(wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture||(o.push("const float   packUpScale = 256. / 255.;"),o.push("const float   unpackDownscale = 255. / 256.;"),o.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),o.push("const float   shiftRight8 = 1.0 / 256.;"),o.push("vec4 packDepthToRGBA( const in float v ) {"),o.push("    vec4 r = vec4( fract( v * packFactors ), v );"),o.push("    r.yzw -= r.xyz * shiftRight8;"),o.push("    return r * packUpScale;"),o.push("}")),o.push("varying vec2 vHighPrecisionZW;"),o.push("void main(void) {"),s){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),t=0,e=r.sectionPlanes.length;t<e;t++)o.push("if (sectionPlaneActive"+t+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),wt.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?o.push("    gl_FragColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "):o.push("    gl_FragColor = packDepthToRGBA(fragCoordZ); "),o.push("}"),o},so.prototype.webglContextRestored=function(){this._program=null},so.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var oo=E.vec3(),ao=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};ao.prototype.getValid=function(){return this._hash===this._getHash()},ao.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},ao.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(e),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix);var u=s._sectionPlanesState.sectionPlanes.length;if(u>0)for(var c=s._sectionPlanesState.sectionPlanes,p=e.layerIndex*u,d=r.renderFlags,f=0;f<u;f++){var _=this._uSectionPlanes[f];if(_){var g=d.sectionPlanesActivePerLayer[p+f];if(a.uniform1i(_.active,g?1:0),g){var m=c[f];if(h){var v=at(m.dist,m.dir,h,oo);a.uniform3fv(_.pos,v)}else a.uniform3fv(_.pos,m.pos);a.uniform3fv(_.dir,m.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},ao.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uWorldNormalMatrix=r.getLocation("worldNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aNormal=r.getAttribute("normal"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2&&(this._aFlags2=r.getAttribute("flags2")),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},ao.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},ao.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},ao.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry normals drawing vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},ao.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Instancing geometry depth drawing fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec3 vViewNormal;"),r.push("vec3 packNormalToRGB( const in vec3 normal ) {"),r.push("    return normalize( normal ) * 0.5 + 0.5;"),r.push("}"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),r.push("}"),r},ao.prototype.webglContextRestored=function(){this._program=null},ao.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var no=E.vec3(),lo=function(t){this._scene=t,this._hash=this._getHash(),this._lastLightId=null,this._allocate()};lo.prototype.getValid=function(){return this._hash===this._getHash()},lo.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},lo.prototype.drawLayer=function(t,e){var i=e.model,r=i.scene,s=r.canvas.gl,o=e._state,a=this._instanceExt;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),a.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aColor.bindArrayBuffer(o.colorsBuf),a.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),a.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),a.vertexAttribDivisorANGLE(this._aFlags2.location,1));var n=r._sectionPlanesState.sectionPlanes.length;if(n>0)for(var l=r._sectionPlanesState.sectionPlanes,h=e.layerIndex*n,u=i.renderFlags,c=e._state.rtcCenter,p=0;p<n;p++){var d=this._uSectionPlanes[p];if(d){var f=u.sectionPlanesActivePerLayer[h+p];if(s.uniform1i(d.active,f?1:0),f){var _=l[p];if(c){var g=at(_.dist,_.dir,c,no);s.uniform3fv(d.pos,g)}else s.uniform3fv(d.pos,_.pos);s.uniform3fv(d.dir,_.dir)}}}o.indicesBuf.bind(),a.drawElementsInstancedANGLE(s.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),a.vertexAttribDivisorANGLE(this._aColor.location,0),a.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&a.vertexAttribDivisorANGLE(this._aOffset.location,0)}},lo.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=r.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=r.getLocation("shadowProjMatrix"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2")}},lo.prototype._bindProgram=function(t,e){var i=this._scene.canvas.gl;this._program.bind(),i.uniformMatrix4fv(this._uShadowViewMatrix,!1,t.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,t.shadowProjMatrix),this._lastLightId=null},lo.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},lo.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry shadow drawing vertex shader"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("}"),i},lo.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Instancing geometry depth drawing fragment shader"),t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec3 vViewNormal;"),r.push("vec3 packNormalToRGB( const in vec3 normal ) {"),r.push("    return normalize( normal ) * 0.5 + 0.5;"),r.push("}"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),r.push("}"),r},lo.prototype.webglContextRestored=function(){this._program=null},lo.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var ho=E.vec4(),uo=E.vec3(),co={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"},po=function(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()};po.prototype.getValid=function(){return this._hash===this._getHash()},po.prototype._getHash=function(){var t=this._scene;return[t.gammaOutput,t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")},po.prototype.drawLayer=function(t,e,i){var r=e.model,s=this._scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix);var u=s._sectionPlanesState.sectionPlanes.length;if(u>0)for(var c=s._sectionPlanesState.sectionPlanes,p=e.layerIndex*u,d=r.renderFlags,f=0;f<u;f++){var _=this._uSectionPlanes[f];if(_){var g=d.sectionPlanesActivePerLayer[p+f];if(a.uniform1i(_.active,g?1:0),g){var m=c[f];if(h){var v=at(m.dist,m.dir,h,uo);a.uniform3fv(_.pos,v)}else a.uniform3fv(_.pos,m.pos);a.uniform3fv(_.dir,m.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(n.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(n.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(n.modelNormalMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aMetallicRoughness.bindArrayBuffer(n.metallicRoughnessBuf),l.vertexAttribDivisorANGLE(this._aMetallicRoughness.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aMetallicRoughness.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},po.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uWorldNormalMatrix=r.getLocation("worldNormalMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uViewNormalMatrix=r.getLocation("viewNormalMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uGammaFactor=r.getLocation("gammaFactor"),this._uLightAmbient=r.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var s=i.lights,o=0,a=s.length;o<a;o++)switch(s[o].type){case"dir":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=null,this._uLightDir[o]=r.getLocation("lightDir"+o);break;case"point":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=null,this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o);break;case"spot":this._uLightColor[o]=r.getLocation("lightColor"+o),this._uLightPos[o]=r.getLocation("lightPos"+o),this._uLightDir[o]=r.getLocation("lightDir"+o),this._uLightAttenuation[o]=r.getLocation("lightAttenuation"+o)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(var n=0,l=t._sectionPlanesState.sectionPlanes.length;n<l;n++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+n),pos:r.getLocation("sectionPlanePos"+n),dir:r.getLocation("sectionPlaneDir"+n)});this._aPosition=r.getAttribute("position"),this._aNormal=r.getAttribute("normal"),this._aColor=r.getAttribute("color"),this._aMetallicRoughness=r.getAttribute("metallicRoughness"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aOffset=r.getAttribute("offset"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=r.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=r.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=r.getAttribute("modelNormalMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=r.getLocation("uSAOParams"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},po.prototype._bindProgram=function(t){var e=wt.MAX_TEXTURE_UNITS,i=this._scene,r=i.canvas.gl,s=i._lightsState,o=s.lights,a=i.camera.project;this._program.bind(),r.uniformMatrix4fv(this._uProjMatrix,!1,a.matrix),this._uLightAmbient&&r.uniform4fv(this._uLightAmbient,i._lightsState.getAmbientColorAndIntensity());for(var n=0,l=o.length;n<l;n++){var h=o[n];this._uLightColor[n]&&r.uniform4f(this._uLightColor[n],h.color[0],h.color[1],h.color[2],h.intensity),this._uLightPos[n]&&(r.uniform3fv(this._uLightPos[n],h.pos),this._uLightAttenuation[n]&&r.uniform1f(this._uLightAttenuation[n],h.attenuation)),this._uLightDir[n]&&r.uniform3fv(this._uLightDir[n],h.dir)}if(s.reflectionMaps.length>0&&s.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,s.reflectionMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),s.lightMaps.length>0&&s.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,s.lightMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),this._withSAO){var u=i.sao;if(u.possible){var c=r.drawingBufferWidth,p=r.drawingBufferHeight;ho[0]=c,ho[1]=p,ho[2]=u.blendCutoff,ho[3]=u.blendFactor,r.uniform4fv(this._uSAOParams,ho),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++}}if(i.logarithmicDepthBufferEnabled){var d=2/(Math.log(a.far+1)/Math.LN2);r.uniform1f(this._uLogDepthBufFC,d)}this._uGammaFactor&&r.uniform1f(this._uGammaFactor,i.gammaFactor)},po.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},po.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState,i=t._lightsState,r=e.sectionPlanes.length>0,s=e.clippingCaps,o=[];return o.push("// Instancing geometry quality drawing vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("uniform int renderPass;"),o.push("attribute vec3 position;"),o.push("attribute vec2 normal;"),o.push("attribute vec4 color;"),o.push("attribute vec2 metallicRoughness;"),o.push("attribute vec4 flags;"),o.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&o.push("attribute vec3 offset;"),o.push("attribute vec4 modelMatrixCol0;"),o.push("attribute vec4 modelMatrixCol1;"),o.push("attribute vec4 modelMatrixCol2;"),o.push("attribute vec4 modelNormalMatrixCol0;"),o.push("attribute vec4 modelNormalMatrixCol1;"),o.push("attribute vec4 modelNormalMatrixCol2;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("varying vec4 vViewPosition;"),o.push("varying vec3 vViewNormal;"),o.push("varying vec4 vColor;"),o.push("varying vec2 vMetallicRoughness;"),i.lightMaps.length>0&&o.push("varying vec3 vWorldNormal;"),r&&(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),s&&o.push("varying vec4 vClipPosition;")),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),o.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),o.push("vec3 viewNormal = vec4(viewNormalMatrix * worldNormal).xyz;"),o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;"))),r&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;"),s&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o},po.prototype._buildFragmentShader=function(){var t=this._scene,e=t.gammaOutput,i=t._sectionPlanesState,r=t._lightsState,s=i.sectionPlanes.length>0,o=i.clippingCaps,a=[];a.push("// Instancing geometry quality drawing fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;")),this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBAToDepth( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),r.reflectionMaps.length>0&&a.push("uniform samplerCube reflectionMap;"),r.lightMaps.length>0&&a.push("uniform samplerCube lightMap;"),a.push("uniform vec4 lightAmbient;");for(var n=0,l=r.lights.length;n<l;n++){var h=r.lights[n];"ambient"!==h.type&&(a.push("uniform vec4 lightColor"+n+";"),"dir"===h.type&&a.push("uniform vec3 lightDir"+n+";"),"point"===h.type&&a.push("uniform vec3 lightPos"+n+";"),"spot"===h.type&&(a.push("uniform vec3 lightPos"+n+";"),a.push("uniform vec3 lightDir"+n+";")))}if(a.push("uniform float gammaFactor;"),a.push("vec4 linearToLinear( in vec4 value ) {"),a.push("  return value;"),a.push("}"),a.push("vec4 sRGBToLinear( in vec4 value ) {"),a.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),a.push("}"),a.push("vec4 gammaToLinear( in vec4 value) {"),a.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),a.push("}"),e&&(a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}")),s){a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),o&&a.push("varying vec4 vClipPosition;");for(var u=0,c=i.sectionPlanes.length;u<c;u++)a.push("uniform bool sectionPlaneActive"+u+";"),a.push("uniform vec3 sectionPlanePos"+u+";"),a.push("uniform vec3 sectionPlaneDir"+u+";")}if(a.push("varying vec4 vViewPosition;"),a.push("varying vec3 vViewNormal;"),a.push("varying vec4 vColor;"),a.push("varying vec2 vMetallicRoughness;"),r.lightMaps.length>0&&a.push("varying vec3 vWorldNormal;"),a.push("uniform mat4 viewMatrix;"),a.push("#define PI 3.14159265359"),a.push("#define RECIPROCAL_PI 0.31830988618"),a.push("#define RECIPROCAL_PI2 0.15915494"),a.push("#define EPSILON 1e-6"),a.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),a.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),a.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),a.push("}"),a.push("struct IncidentLight {"),a.push("   vec3 color;"),a.push("   vec3 direction;"),a.push("};"),a.push("struct ReflectedLight {"),a.push("   vec3 diffuse;"),a.push("   vec3 specular;"),a.push("};"),a.push("struct Geometry {"),a.push("   vec3 position;"),a.push("   vec3 viewNormal;"),a.push("   vec3 worldNormal;"),a.push("   vec3 viewEyeDir;"),a.push("};"),a.push("struct Material {"),a.push("   vec3    diffuseColor;"),a.push("   float   specularRoughness;"),a.push("   vec3    specularColor;"),a.push("   float   shine;"),a.push("};"),a.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),a.push("   float r = ggxRoughness + 0.0001;"),a.push("   return (2.0 / (r * r) - 2.0);"),a.push("}"),a.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),a.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),a.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),a.push("}"),r.reflectionMaps.length>0&&(a.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),a.push("   vec3 envMapColor = "+co[r.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),a.push("  return envMapColor;"),a.push("}")),a.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),a.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),a.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),a.push("}"),a.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   return 1.0 / ( gl * gv );"),a.push("}"),a.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   return 0.5 / max( gv + gl, EPSILON );"),a.push("}"),a.push("float D_GGX(const in float alpha, const in float dotNH) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),a.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float alpha = ( roughness * roughness );"),a.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),a.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),a.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),a.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),a.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),a.push("   vec3  F = F_Schlick( specularColor, dotLH );"),a.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),a.push("   float D = D_GGX( alpha, dotNH );"),a.push("   return F * (G * D);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),a.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),a.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),a.push("   vec4 r = roughness * c0 + c1;"),a.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),a.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),a.push("   return specularColor * AB.x + AB.y;"),a.push("}"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&(a.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),r.lightMaps.length>0&&(a.push("   vec3 irradiance = "+co[r.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),a.push("   irradiance *= PI;"),a.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),r.reflectionMaps.length>0&&(a.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),a.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),a.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),a.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),a.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),a.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),a.push("}")),a.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),a.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),a.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),a.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),a.push("}"),a.push("void main(void) {"),s){a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(var p=0,d=i.sectionPlanes.length;p<d;p++)a.push("if (sectionPlaneActive"+p+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+p+".xyz, vWorldPosition.xyz - sectionPlanePos"+p+".xyz), 0.0, 1000.0);"),a.push("}");o?(a.push("  if (dist > (0.002 * vClipPosition.w)) {"),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      gl_FragColor=vec4(1.0, 0.0, 0.0, 1.0);"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("  gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("  return;"),a.push("}")):(a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }")),a.push("}")}a.push("IncidentLight  light;"),a.push("Material       material;"),a.push("Geometry       geometry;"),a.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),a.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),a.push("float alpha = float(vColor.a) / 255.0;"),a.push("vec3  diffuseColor = rgb;"),a.push("float specularF0 = 1.0;"),a.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),a.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),a.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),a.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),a.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),a.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);"),a.push("geometry.position      = vViewPosition.xyz;"),a.push("geometry.viewNormal    = -normalize(vViewNormal);"),a.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),r.lightMaps.length>0&&a.push("geometry.worldNormal   = normalize(vWorldNormal);"),(r.lightMaps.length>0||r.reflectionMaps.length>0)&&a.push("computePBRLightMapping(geometry, material, reflectedLight);");for(var f=0,_=r.lights.length;f<_;f++){var g=r.lights[f];if("ambient"!==g.type){if("dir"===g.type)"view"===g.space?a.push("light.direction = normalize(lightDir"+f+");"):a.push("light.direction = normalize((viewMatrix * vec4(lightDir"+f+", 0.0)).xyz);");else if("point"===g.type)"view"===g.space?a.push("light.direction = normalize(lightPos"+f+" - vViewPosition.xyz);"):a.push("light.direction = normalize((viewMatrix * vec4(lightPos"+f+", 0.0)).xyz);");else{if("spot"!==g.type)continue;"view"===g.space?a.push("light.direction = normalize(lightDir"+f+");"):a.push("light.direction = normalize((viewMatrix * vec4(lightDir"+f+", 0.0)).xyz);")}a.push("light.color =  lightColor"+f+".rgb * lightColor"+f+".a;"),a.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return a.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular);"),a.push("vec4 fragColor;"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),a.push("   fragColor            = vec4(outgoingLight.rgb * ambient, alpha);")):a.push("   fragColor            = vec4(outgoingLight.rgb, alpha);"),e&&a.push("fragColor = linearToGamma(fragColor, gammaFactor);"),a.push("gl_FragColor = fragColor;"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a},po.prototype.webglContextRestored=function(){this._program=null},po.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var fo=E.vec3(),_o=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};_o.prototype.getValid=function(){return this._hash===this._getHash()},_o.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},_o.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(e),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible);var u=t.pickViewMatrix||o.viewMatrix,c=h?rt(u,h):u;if(a.uniformMatrix4fv(this._uViewMatrix,!1,c),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),s.logarithmicDepthBufferEnabled){var p=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,p)}var d=s._sectionPlanesState.sectionPlanes.length;if(d>0)for(var f=s._sectionPlanesState.sectionPlanes,_=e.layerIndex*d,g=r.renderFlags,m=0;m<d;m++){var v=this._uSectionPlanes[m],b=g.sectionPlanesActivePerLayer[_+m];if(a.uniform1i(v.active,b?1:0),b){var y=f[m];if(h){var P=at(y.dist,y.dir,h,fo);a.uniform3fv(v.pos,P)}else a.uniform3fv(v.pos,y.pos);a.uniform3fv(v.dir,y.dir)}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},_o.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPickInvisible=r.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},_o.prototype._bindProgram=function(){this._program.bind()},_o.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},_o.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry normals vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&i.push("varying vec4 vFlags2;"),i.push("varying vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},_o.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Batched geometry normals fragment shader"),r.push("#extension GL_OES_standard_derivatives : enable"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),r.push("varying vec4 vWorldPosition;"),i){r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec3 vWorldNormal;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),r.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),r.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),r.push("  gl_FragColor = vec4((worldNormal * 0.5) + 0.5, 1.0);"),r.push("}"),r},_o.prototype.webglContextRestored=function(){this._program=null},_o.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var go=function(t){this._scene=t},mo={colorRenderer:{configurable:!0},colorRendererWithSAO:{configurable:!0},flatColorRenderer:{configurable:!0},flatColorRendererWithSAO:{configurable:!0},colorQualityRenderer:{configurable:!0},colorQualityRendererWithSAO:{configurable:!0},silhouetteRenderer:{configurable:!0},depthRenderer:{configurable:!0},normalsRenderer:{configurable:!0},edgesRenderer:{configurable:!0},edgesColorRenderer:{configurable:!0},pickMeshRenderer:{configurable:!0},pickNormalsRenderer:{configurable:!0},pickNormalsFlatRenderer:{configurable:!0},pickDepthRenderer:{configurable:!0},occlusionRenderer:{configurable:!0},shadowRenderer:{configurable:!0}};go.prototype._compile=function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorQualityRenderer&&!this._colorQualityRenderer.getValid()&&(this._colorQualityRenderer.destroy(),this._colorQualityRenderer=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)},mo.colorRenderer.get=function(){return this._colorRenderer||(this._colorRenderer=new Os(this._scene,!1)),this._colorRenderer},mo.colorRendererWithSAO.get=function(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Os(this._scene,!0)),this._colorRendererWithSAO},mo.flatColorRenderer.get=function(){return this._flatColorRenderer||(this._flatColorRenderer=new Us(this._scene,!1)),this._flatColorRenderer},mo.flatColorRendererWithSAO.get=function(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new Us(this._scene,!0)),this._flatColorRendererWithSAO},mo.colorQualityRenderer.get=function(){return this._colorQualityRenderer||(this._colorQualityRenderer=new po(this._scene,!1)),this._colorQualityRenderer},mo.colorQualityRendererWithSAO.get=function(){return this._colorQualityRendererWithSAO||(this._colorQualityRendererWithSAO=new po(this._scene,!0)),this._colorQualityRendererWithSAO},mo.silhouetteRenderer.get=function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Gs(this._scene)),this._silhouetteRenderer},mo.depthRenderer.get=function(){return this._depthRenderer||(this._depthRenderer=new so(this._scene)),this._depthRenderer},mo.normalsRenderer.get=function(){return this._normalsRenderer||(this._normalsRenderer=new ao(this._scene)),this._normalsRenderer},mo.edgesRenderer.get=function(){return this._edgesRenderer||(this._edgesRenderer=new Hs(this._scene)),this._edgesRenderer},mo.edgesColorRenderer.get=function(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Ks(this._scene)),this._edgesColorRenderer},mo.pickMeshRenderer.get=function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Zs(this._scene)),this._pickMeshRenderer},mo.pickNormalsRenderer.get=function(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new to(this._scene)),this._pickNormalsRenderer},mo.pickNormalsFlatRenderer.get=function(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new _o(this._scene)),this._pickNormalsFlatRenderer},mo.pickDepthRenderer.get=function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Js(this._scene)),this._pickDepthRenderer},mo.occlusionRenderer.get=function(){return this._occlusionRenderer||(this._occlusionRenderer=new io(this._scene)),this._occlusionRenderer},mo.shadowRenderer.get=function(){return this._shadowRenderer||(this._shadowRenderer=new lo(this._scene)),this._shadowRenderer},go.prototype._destroy=function(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorQualityRenderer&&this._colorQualityRenderer.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()},Object.defineProperties(go.prototype,mo);var vo={};var bo=wt.SUPPORTED_EXTENSIONS.OES_element_index_uint,yo=new Uint8Array(4),Po=E.vec4([0,0,0,1]),Mo=E.vec4([0,0,0,1]),xo=E.vec4([0,0,0,1]),wo=new Float32Array(3),Eo=E.vec3(),Co=E.vec3(),Ao=E.vec3(),So=E.vec3(),Do=E.vec3(),Lo=E.vec3(),Bo=E.vec3(),Ro=function(t,e){var i,r,s;this.sortId="TrianglesInstancingLayer"+(e.solid?"-solid":"-surface")+(e.normals?"-normals":"-autoNormals"),this.layerIndex=e.layerIndex,this._instancingRenderers=(i=t.scene,r=i.id,(s=vo[r])||(s=new go(i),vo[r]=s,s._compile(),i.on("compile",(function(){s._compile()})),i.on("destroyed",(function(){delete vo[r],s._destroy()}))),s),this.model=t,this._aabb=E.collapseAABB3();var o={positionsDecodeMatrix:E.mat4(),numInstances:0,obb:E.OBB3(),rtcCenter:null},a=!!e.positionsDecodeMatrix,n=this.model.scene.pickSurfacePrecisionEnabled,l=this.model.scene.canvas.gl;if(e.positions)if(a){o.positionsBuf=new Ut(l,l.ARRAY_BUFFER,e.positions,e.positions.length,3,l.STATIC_DRAW,!1),o.positionsDecodeMatrix.set(e.positionsDecodeMatrix);var h=E.collapseAABB3();E.expandAABB3Points3(h,e.positions),Re.decompressAABB(h,o.positionsDecodeMatrix),E.AABB3ToOBB3(h,o.obb),n&&(o.quantizedPositions=e.positions)}else{var u=e.positions.length,c=E.collapseAABB3();E.expandAABB3Points3(c,e.positions),E.AABB3ToOBB3(c,o.obb);var p=ms(e.positions,c,o.positionsDecodeMatrix);o.positionsBuf=new Ut(l,l.ARRAY_BUFFER,p,u,3,l.STATIC_DRAW,!1),n&&(o.quantizedPositions=p)}if(e.normals&&e.normals.length>0)if(a){o.normalsBuf=new Ut(l,l.ARRAY_BUFFER,e.normals,e.normals.length,3,l.STATIC_DRAW,!0)}else{var d=function(t){for(var e,i,r,s,o=t.length,a=new Int8Array(o),n=0;n<o;n+=3)i=e=bs(t,n,"floor","floor"),ys(e),r=s=Ps(t,n),ys(e=bs(t,n,"ceil","floor")),(r=Ps(t,n))>s&&(i=e,s=r),ys(e=bs(t,n,"floor","ceil")),(r=Ps(t,n))>s&&(i=e,s=r),ys(e=bs(t,n,"ceil","ceil")),(r=Ps(t,n))>s&&(i=e,s=r),a[n+0]=i[0],a[n+1]=i[1],a[n+2]=0;return new Int8Array(a)}(e.normals);o.normalsBuf=new Ut(l,l.ARRAY_BUFFER,d,d.length,3,l.STATIC_DRAW,!0)}e.indices&&(o.indicesBuf=new Ut(l,l.ELEMENT_ARRAY_BUFFER,bo?new Uint32Array(e.indices):new Uint16Array(e.indices),e.indices.length,1,l.STATIC_DRAW),n&&(o.indices=e.indices));var f=e.edgeIndices;f||(f=Se(e.positions,e.indices,null,e.edgeThreshold||10)),o.edgeIndicesBuf=new Ut(l,l.ELEMENT_ARRAY_BUFFER,bo?new Uint32Array(f):new Uint16Array(f),f.length,1,l.STATIC_DRAW),this._state=new oe(o),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.indices?e.indices.length/3:0,this._colors=[],this._metallicRoughness=[],this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],e.rtcCenter&&(this._state.rtcCenter=E.vec3(e.rtcCenter)),this._finalized=!1,this.aabb=E.collapseAABB3(),this.solid=!!e.solid};Ro.prototype.createPortion=function(t){var e=t.color,i=t.metallic,r=t.roughness,s=t.opacity,o=t.meshMatrix,a=t.worldMatrix,n=t.aabb,l=t.pickColor;if(this._finalized)throw"Already finalized";var h=e[0],u=e[1],c=e[2];if(e[3],this._colors.push(h),this._colors.push(u),this._colors.push(c),this._colors.push(s),this._metallicRoughness.push(null!=i?i:0),this._metallicRoughness.push(null!=r?r:255),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(o[0]),this._modelMatrixCol0.push(o[4]),this._modelMatrixCol0.push(o[8]),this._modelMatrixCol0.push(o[12]),this._modelMatrixCol1.push(o[1]),this._modelMatrixCol1.push(o[5]),this._modelMatrixCol1.push(o[9]),this._modelMatrixCol1.push(o[13]),this._modelMatrixCol2.push(o[2]),this._modelMatrixCol2.push(o[6]),this._modelMatrixCol2.push(o[10]),this._modelMatrixCol2.push(o[14]),this._state.normalsBuf){var p=E.transposeMat4(o,E.mat4()),d=E.inverseMat4(p);this._modelNormalMatrixCol0.push(d[0]),this._modelNormalMatrixCol0.push(d[4]),this._modelNormalMatrixCol0.push(d[8]),this._modelNormalMatrixCol0.push(d[12]),this._modelNormalMatrixCol1.push(d[1]),this._modelNormalMatrixCol1.push(d[5]),this._modelNormalMatrixCol1.push(d[9]),this._modelNormalMatrixCol1.push(d[13]),this._modelNormalMatrixCol2.push(d[2]),this._modelNormalMatrixCol2.push(d[6]),this._modelNormalMatrixCol2.push(d[10]),this._modelNormalMatrixCol2.push(d[14])}this._pickColors.push(l[0]),this._pickColors.push(l[1]),this._pickColors.push(l[2]),this._pickColors.push(l[3]),E.collapseAABB3(n);for(var f=this._state.obb,_=f.length,g=0;g<_;g+=4)Po[0]=f[g+0],Po[1]=f[g+1],Po[2]=f[g+2],E.transformPoint4(o,Po,Mo),a?(E.transformPoint4(a,Mo,xo),E.expandAABB3Point3(n,xo)):E.expandAABB3Point3(n,Mo);if(this._state.rtcCenter){var m=this._state.rtcCenter;n[0]+=m[0],n[1]+=m[1],n[2]+=m[2],n[3]+=m[0],n[4]+=m[1],n[5]+=m[2]}E.expandAABB3(this.aabb,n),this._state.numInstances++;var v=this._portions.length,b={};return this.model.scene.pickSurfacePrecisionEnabled&&(b.matrix=o.slice(),b.inverseMatrix=null),this._portions.push(b),this._numPortions++,this.model.numPortions++,v},Ro.prototype.finalize=function(){if(this._finalized)throw"Already finalized";var t=this.model.scene.canvas.gl,e=this._colors.length,i=e;if(e>0){this._state.colorsBuf=new Ut(t,t.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,t.DYNAMIC_DRAW,!1),this._colors=[]}if(this._metallicRoughness.length>0){var r=new Uint8Array(this._metallicRoughness);this._state.metallicRoughnessBuf=new Ut(t,t.ARRAY_BUFFER,r,this._metallicRoughness.length,2,t.STATIC_DRAW,!1)}if(i>0){this._state.flagsBuf=new Ut(t,t.ARRAY_BUFFER,new Uint8Array(i),i,4,t.DYNAMIC_DRAW,!1),this._state.flags2Buf=new Ut(t,t.ARRAY_BUFFER,new Uint8Array(i),i,4,t.DYNAMIC_DRAW,!0)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){this._state.offsetsBuf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,t.DYNAMIC_DRAW,!1),this._offsets=[]}if(this._modelMatrixCol0.length>0){var s=!1;this._state.modelMatrixCol0Buf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,t.STATIC_DRAW,s),this._state.modelMatrixCol1Buf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,t.STATIC_DRAW,s),this._state.modelMatrixCol2Buf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,t.STATIC_DRAW,s),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._state.normalsBuf&&(this._state.modelNormalMatrixCol0Buf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,t.STATIC_DRAW,s),this._state.modelNormalMatrixCol1Buf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,t.STATIC_DRAW,s),this._state.modelNormalMatrixCol2Buf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,t.STATIC_DRAW,s),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[])}if(this._pickColors.length>0){this._state.pickColorsBuf=new Ut(t,t.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,t.STATIC_DRAW,!1),this._pickColors=[]}this._finalized=!0},Ro.prototype.initFlags=function(t,e,i){e&G&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&q&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&K&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&Z&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&H&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&Q&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&W&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&X&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)},Ro.prototype.setVisible=function(t,e,i){if(!this._finalized)throw"Not finalized";e&G?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)},Ro.prototype.setHighlighted=function(t,e,i){if(!this._finalized)throw"Not finalized";e&q?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)},Ro.prototype.setXRayed=function(t,e,i){if(!this._finalized)throw"Not finalized";e&K?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)},Ro.prototype.setSelected=function(t,e,i){if(!this._finalized)throw"Not finalized";e&Z?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)},Ro.prototype.setEdges=function(t,e,i){if(!this._finalized)throw"Not finalized";e&Q?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)},Ro.prototype.setClippable=function(t,e){if(!this._finalized)throw"Not finalized";e&H?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)},Ro.prototype.setCollidable=function(t,e){if(!this._finalized)throw"Not finalized"},Ro.prototype.setPickable=function(t,e,i){if(!this._finalized)throw"Not finalized";e&W?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(t,e,i)},Ro.prototype.setCulled=function(t,e,i){if(!this._finalized)throw"Not finalized";e&X?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)},Ro.prototype.setColor=function(t,e){if(!this._finalized)throw"Not finalized";yo[0]=e[0],yo[1]=e[1],yo[2]=e[2],yo[3]=e[3],this._state.colorsBuf&&this._state.colorsBuf.setData(yo,4*t,4)},Ro.prototype.setTransparent=function(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)},Ro.prototype._setFlags=function(t,e,i){if(!this._finalized)throw"Not finalized";var r,s,o=!!(e&G),a=!!(e&K),n=!!(e&q),l=!!(e&Z),h=!!(e&X);r=!o||h||a?vr:i?yr:br,s=!o||h?vr:l?Mr:n?Pr:a?xr:vr;var u=0;u=!o||h?vr:l?Ar:n?Cr:a?Sr:!!(e&Q)?i?Er:wr:vr;var c=o&&!h&&!!(e&W)?Dr:vr;yo[0]=r,yo[1]=s,yo[2]=u,yo[3]=c,this._state.flagsBuf&&this._state.flagsBuf.setData(yo,4*t,4)},Ro.prototype._setFlags2=function(t,e){if(!this._finalized)throw"Not finalized";var i=e&H?255:0;yo[0]=i,this._state.flags2Buf&&this._state.flags2Buf.setData(yo,4*t,4)},Ro.prototype.setOffset=function(t,e){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(wo[0]=e[0],wo[1]=e[1],wo[2]=e[2],this._state.offsetsBuf&&this._state.offsetsBuf.setData(wo,3*t,3)):this.model.error("Entity#offset not enabled for this Viewer")},Ro.prototype.drawColorOpaque=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),e.withSAO&&this.model.saoEnabled?e.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._instancingRenderers.colorQualityRendererWithSAO&&this._instancingRenderers.colorQualityRendererWithSAO.drawLayer(e,this,br):this._state.normalsBuf?this._instancingRenderers.colorRendererWithSAO&&this._instancingRenderers.colorRendererWithSAO.drawLayer(e,this,br):this._instancingRenderers.flatColorRendererWithSAO&&this._instancingRenderers.flatColorRendererWithSAO.drawLayer(e,this,br):e.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._instancingRenderers.colorQualityRenderer&&this._instancingRenderers.colorQualityRenderer.drawLayer(e,this,br):this._state.normalsBuf?this._instancingRenderers.colorRenderer&&this._instancingRenderers.colorRenderer.drawLayer(e,this,br):this._instancingRenderers.flatColorRenderer&&this._instancingRenderers.flatColorRenderer.drawLayer(e,this,br))},Ro.prototype._updateBackfaceCull=function(t,e){var i=this.model.backfaces||!this.solid||t.sectioned;if(e.backfaces!==i){var r=e.gl;i?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),e.backfaces=i}},Ro.prototype.drawColorTransparent=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),e.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._instancingRenderers.colorQualityRenderer&&this._instancingRenderers.colorQualityRenderer.drawLayer(e,this,yr):this._state.normalsBuf?this._instancingRenderers.colorRenderer&&this._instancingRenderers.colorRenderer.drawLayer(e,this,yr):this._instancingRenderers.flatColorRenderer&&this._instancingRenderers.flatColorRenderer.drawLayer(e,this,yr))},Ro.prototype.drawDepth=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.depthRenderer&&this._instancingRenderers.depthRenderer.drawLayer(e,this,br))},Ro.prototype.drawNormals=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.normalsRenderer&&this._instancingRenderers.normalsRenderer.drawLayer(e,this,br))},Ro.prototype.drawSilhouetteXRayed=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(e,this,xr))},Ro.prototype.drawSilhouetteHighlighted=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(e,this,Pr))},Ro.prototype.drawSilhouetteSelected=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(e,this,Mr))},Ro.prototype.drawEdgesColorOpaque=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._instancingRenderers.edgesColorRenderer&&this._instancingRenderers.edgesColorRenderer.drawLayer(e,this,wr)},Ro.prototype.drawEdgesColorTransparent=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._instancingRenderers.edgesColorRenderer&&this._instancingRenderers.edgesColorRenderer.drawLayer(e,this,Er)},Ro.prototype.drawEdgesXRayed=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(e,this,Sr)},Ro.prototype.drawEdgesHighlighted=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(e,this,Cr)},Ro.prototype.drawEdgesSelected=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(e,this,Ar)},Ro.prototype.drawOcclusion=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.occlusionRenderer&&this._instancingRenderers.occlusionRenderer.drawLayer(e,this,br))},Ro.prototype.drawShadow=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.shadowRenderer&&this._instancingRenderers.shadowRenderer.drawLayer(e,this,br))},Ro.prototype.drawPickMesh=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.pickMeshRenderer&&this._instancingRenderers.pickMeshRenderer.drawLayer(e,this,Dr))},Ro.prototype.drawPickDepths=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.pickDepthRenderer&&this._instancingRenderers.pickDepthRenderer.drawLayer(e,this,Dr))},Ro.prototype.drawPickNormals=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.pickNormalsRenderer&&this._instancingRenderers.pickNormalsRenderer.drawLayer(e,this,Dr))},Ro.prototype.precisionRayPickSurface=function(t,e,i,r){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;var s=this._state,o=this._portions[t];if(!o)return this.model.error("portion not found: "+t),!1;o.inverseMatrix||(o.inverseMatrix=E.inverseMat4(o.matrix,E.mat4()));var a=s.quantizedPositions,n=s.indices,l=s.rtcCenter,h=o.offset,u=Eo,c=Co;u.set(l?E.subVec3(e,l,Ao):e),c.set(i),h&&E.subVec3(u,h),E.transformRay(this.model.worldNormalMatrix,u,c,u,c),E.transformRay(o.inverseMatrix,u,c,u,c);for(var p=So,d=Do,f=Lo,_=!1,g=0,m=Bo,v=0,b=n.length;v<b;v+=3){var y=3*n[v+0],P=3*n[v+1],M=3*n[v+2];if(p[0]=a[y],p[1]=a[y+1],p[2]=a[y+2],d[0]=a[P],d[1]=a[P+1],d[2]=a[P+2],f[0]=a[M],f[1]=a[M+1],f[2]=a[M+2],E.decompressPosition(p,s.positionsDecodeMatrix),E.decompressPosition(d,s.positionsDecodeMatrix),E.decompressPosition(f,s.positionsDecodeMatrix),E.rayTriangleIntersect(u,c,p,d,f,m)){E.transformPoint3(o.matrix,m,m),E.transformPoint3(this.model.worldMatrix,m,m),h&&E.addVec3(m,h),l&&E.addVec3(m,l);var x=Math.abs(E.lenVec3(E.subVec3(m,e,[])));(!_||x>g)&&(g=x,r.set(m),_=!0)}}return _},Ro.prototype.destroy=function(){var t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.normalsBuf&&(t.normalsBuf.destroy(),t.normalsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.metallicRoughnessBuf&&(t.metallicRoughnessBuf.destroy(),t.metallicRoughnessBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.modelMatrixCol0Buf&&(t.modelMatrixCol0Buf.destroy(),t.modelMatrixCol0Buf=null),t.modelMatrixCol1Buf&&(t.modelMatrixCol1Buf.destroy(),t.modelMatrixCol1Buf=null),t.modelMatrixCol2Buf&&(t.modelMatrixCol2Buf.destroy(),t.modelMatrixCol2Buf=null),t.modelNormalMatrixCol0Buf&&(t.modelNormalMatrixCol0Buf.destroy(),t.modelNormalMatrixCol0Buf=null),t.modelNormalMatrixCol1Buf&&(t.modelNormalMatrixCol1Buf.destroy(),t.modelNormalMatrixCol1Buf=null),t.modelNormalMatrixCol2Buf&&(t.modelNormalMatrixCol2Buf.destroy(),t.modelNormalMatrixCol2Buf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.edgeIndicesBuf&&(t.edgeIndicesBuf.destroy(),t.edgeIndicessBuf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.destroy()};var To=E.vec3(),Fo=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Fo.prototype.getValid=function(){return this._hash===this._getHash()},Fo.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Fo.prototype.drawLayer=function(t,e,i){var r=this._scene,s=r.camera,o=e.model,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?rt(s.viewMatrix,l):s.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),a.lineWidth(r.linesMaterial.lineWidth);var h=r._sectionPlanesState.sectionPlanes.length;if(h>0)for(var u=r._sectionPlanesState.sectionPlanes,c=e.layerIndex*h,p=o.renderFlags,d=0;d<h;d++){var f=this._uSectionPlanes[d];if(f){var _=p.sectionPlanesActivePerLayer[c+d];if(a.uniform1i(f.active,_?1:0),_){var g=u[d];if(l){var m=at(g.dist,g.dir,l,To);a.uniform3fv(f.pos,m)}else a.uniform3fv(f.pos,g.pos);a.uniform3fv(f.dir,g.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),n.indicesBuf.bind(),a.drawElements(a.LINES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}},Fo.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},Fo.prototype._bindProgram=function(t){var e=this._scene,i=e.canvas.gl,r=this._program,s=e.camera.project;if(r.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){var o=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,o)}},Fo.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Fo.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines batching color vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},Fo.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Lines batching color fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   gl_FragColor            = vColor;"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r},Fo.prototype.webglContextRestored=function(){this._program=null},Fo.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var No=new Float32Array([1,1,1]),Io=E.vec3(),ko=function(t,e){this._scene=t,this._hash=this._getHash(),this._allocate()};ko.prototype.getValid=function(){return this._hash===this._getHash()},ko.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},ko.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===xr){var h=s.xrayMaterial._state,u=h.fillColor,c=h.fillAlpha;a.uniform4f(this._uColor,u[0],u[1],u[2],c)}else if(i===Pr){var p=s.highlightMaterial._state,d=p.fillColor,f=p.fillAlpha;a.uniform4f(this._uColor,d[0],d[1],d[2],f)}else if(i===Mr){var _=s.selectedMaterial._state,g=_.fillColor,m=_.fillAlpha;a.uniform4f(this._uColor,g[0],g[1],g[2],m)}else a.uniform4fv(this._uColor,No);var v=l?rt(o.viewMatrix,l):o.viewMatrix;a.uniformMatrix4fv(this._uViewMatrix,!1,v),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.lineWidth(s.linesMaterial.lineWidth);var b=s._sectionPlanesState.sectionPlanes.length;if(b>0)for(var y=s._sectionPlanesState.sectionPlanes,P=e.layerIndex*b,M=r.renderFlags,x=0;x<b;x++){var w=this._uSectionPlanes[x];if(w){var E=M.sectionPlanesActivePerLayer[P+x];if(a.uniform1i(w.active,E?1:0),E){var C=y[x];if(l){var A=at(C.dist,C.dir,l,Io);a.uniform3fv(w.pos,A)}else a.uniform3fv(w.pos,C.pos);a.uniform3fv(w.dir,C.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.LINES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}},ko.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},ko.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},ko.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},ko.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines batching silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 color;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},ko.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Lines batching silhouette fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("uniform vec4 color;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = color;"),r.push("}"),r},ko.prototype.webglContextRestored=function(){this._program=null},ko.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Oo=function(t){this._scene=t},Vo={colorRenderer:{configurable:!0},silhouetteRenderer:{configurable:!0}};Oo.prototype._compile=function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null)},Vo.colorRenderer.get=function(){return this._colorRenderer||(this._colorRenderer=new Fo(this._scene,!1)),this._colorRenderer},Vo.silhouetteRenderer.get=function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new ko(this._scene)),this._silhouetteRenderer},Oo.prototype._destroy=function(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy()},Object.defineProperties(Oo.prototype,Vo);var zo={};var Uo=wt.SUPPORTED_EXTENSIONS.OES_element_index_uint,jo=function(t){void 0===t&&(t=5e6),Uo?t>5e6&&(t=5e6):t>65530&&(t=65530),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.flags=[],this.flags2=[],this.offsets=[],this.indices=[]},Go=E.vec4([0,0,0,1]),Xo=E.vec4([0,0,0,1]),Wo=E.vec4([0,0,0,1]),Ho=E.OBB3(),Yo=function(t,e){var i,r,s;this.layerIndex=e.layerIndex,this._batchingRenderers=(i=t.scene,r=i.id,(s=zo[r])||(s=new Oo(i),zo[r]=s,s._compile(),i.on("compile",(function(){s._compile()})),i.on("destroyed",(function(){delete zo[r],s._destroy()}))),s),this.model=t,this._buffer=new jo(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new oe({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,positionsDecodeMatrix:E.mat4(),rtcCenter:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=E.collapseAABB3(),this._portions=[],this._finalized=!1,this._positionsDecodeMatrix=e.positionsDecodeMatrix,this._preCompressed=!!this._positionsDecodeMatrix,e.rtcCenter&&(this._state.rtcCenter=E.vec3(e.rtcCenter)),this.aabb=E.collapseAABB3()};Yo.prototype.canCreatePortion=function(t,e){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+t<3*this._buffer.maxVerts&&this._buffer.indices.length+e<this._buffer.maxIndices},Yo.prototype.createPortion=function(t){if(this._finalized)throw"Already finalized";var e=t.positions,i=t.indices,r=t.color,s=t.opacity,o=t.meshMatrix,a=t.worldMatrix,n=t.worldAABB;t.pickColor;var l=this._buffer,h=l.positions.length/3,u=e.length/3,c=e.length;if(this._preCompressed){for(var p=0,d=e.length;p<d;p++)l.positions.push(e[p]);var f=Re.getPositionsBounds(e),_=Re.decompressPosition(f.min,this._positionsDecodeMatrix,[]),g=Re.decompressPosition(f.max,this._positionsDecodeMatrix,[]);n[0]=_[0],n[1]=_[1],n[2]=_[2],n[3]=g[0],n[4]=g[1],n[5]=g[2],a&&(E.AABB3ToOBB3(n,Ho),E.transformOBB3(a,Ho),E.OBB3ToAABB3(Ho,n))}else{for(var m=l.positions.length,v=0,b=e.length;v<b;v++)l.positions.push(e[v]);if(o)for(var y=m,P=m+c;y<P;y+=3)Go[0]=l.positions[y+0],Go[1]=l.positions[y+1],Go[2]=l.positions[y+2],E.transformPoint4(o,Go,Xo),l.positions[y+0]=Xo[0],l.positions[y+1]=Xo[1],l.positions[y+2]=Xo[2],E.expandAABB3Point3(this._modelAABB,Xo),a?(E.transformPoint4(a,Xo,Wo),E.expandAABB3Point3(n,Wo)):E.expandAABB3Point3(n,Xo);else for(var M=m,x=m+c;M<x;M+=3)Go[0]=l.positions[M+0],Go[1]=l.positions[M+1],Go[2]=l.positions[M+2],E.expandAABB3Point3(this._modelAABB,Go),a?(E.transformPoint4(a,Go,Xo),E.expandAABB3Point3(n,Xo)):E.expandAABB3Point3(n,Go)}if(this._state.rtcCenter){var w=this._state.rtcCenter;n[0]+=w[0],n[1]+=w[1],n[2]+=w[2],n[3]+=w[0],n[4]+=w[1],n[5]+=w[2]}if(E.expandAABB3(this.aabb,n),r)for(var C=r[0],A=r[1],S=r[2],D=s,L=0;L<u;L++)l.colors.push(C),l.colors.push(A),l.colors.push(S),l.colors.push(D);if(i)for(var B=0,R=i.length;B<R;B++)l.indices.push(i[B]+h);if(this.model.scene.entityOffsetsEnabled)for(var T=0;T<u;T++)l.offsets.push(0),l.offsets.push(0),l.offsets.push(0);var F=this._portions.length/2;return this._portions.push(h),this._portions.push(u),this._numPortions++,this.model.numPortions++,F},Yo.prototype.finalize=function(){if(this._finalized)this.model.error("Already finalized");else{var t=this._state,e=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressed){t.positionsDecodeMatrix=this._positionsDecodeMatrix;var r=new Uint16Array(i.positions);t.positionsBuf=new Ut(e,e.ARRAY_BUFFER,r,i.positions.length,3,e.STATIC_DRAW)}else{var s=ms(new Float32Array(i.positions),this._modelAABB,t.positionsDecodeMatrix);t.positionsBuf=new Ut(e,e.ARRAY_BUFFER,s,i.positions.length,3,e.STATIC_DRAW)}if(i.colors.length>0){var o=new Uint8Array(i.colors);t.colorsBuf=new Ut(e,e.ARRAY_BUFFER,o,i.colors.length,4,e.DYNAMIC_DRAW,!1)}if(i.colors.length>0){var a=i.colors.length,n=new Uint8Array(a),l=new Uint8Array(a);t.flagsBuf=new Ut(e,e.ARRAY_BUFFER,n,n.length,4,e.DYNAMIC_DRAW,!1),t.flags2Buf=new Ut(e,e.ARRAY_BUFFER,l,l.length,4,e.DYNAMIC_DRAW,!0)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){var h=new Float32Array(i.offsets);t.offsetsBuf=new Ut(e,e.ARRAY_BUFFER,h,i.offsets.length,3,e.DYNAMIC_DRAW)}var u=wt.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(i.indices.length>0){var c=u?new Uint32Array(i.indices):new Uint16Array(i.indices);t.indicesBuf=new Ut(e,e.ELEMENT_ARRAY_BUFFER,c,i.indices.length,1,e.STATIC_DRAW)}this._buffer=null,this._finalized=!0}},Yo.prototype.initFlags=function(t,e,i){e&G&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&q&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&K&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&Z&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&H&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&Q&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&W&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&X&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)},Yo.prototype.setVisible=function(t,e,i){if(!this._finalized)throw"Not finalized";e&G?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)},Yo.prototype.setHighlighted=function(t,e,i){if(!this._finalized)throw"Not finalized";e&q?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)},Yo.prototype.setXRayed=function(t,e,i){if(!this._finalized)throw"Not finalized";e&K?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)},Yo.prototype.setSelected=function(t,e,i){if(!this._finalized)throw"Not finalized";e&Z?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)},Yo.prototype.setEdges=function(t,e,i){if(!this._finalized)throw"Not finalized";e&Q?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)},Yo.prototype.setClippable=function(t,e){if(!this._finalized)throw"Not finalized";e&H?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)},Yo.prototype.setCulled=function(t,e,i){if(!this._finalized)throw"Not finalized";e&X?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)},Yo.prototype.setCollidable=function(t,e){if(!this._finalized)throw"Not finalized"},Yo.prototype.setPickable=function(t,e,i){if(!this._finalized)throw"Not finalized";e&W?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(t,e,i)},Yo.prototype.setColor=function(t,e){if(!this._finalized)throw"Not finalized";for(var i=2*t,r=4*this._portions[i],s=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(s),a=e[0],n=e[1],l=e[2],h=e[3],u=0;u<s;u+=4)o[u+0]=a,o[u+1]=n,o[u+2]=l,o[u+3]=h;this._state.colorsBuf.setData(o,r,s)},Yo.prototype.setTransparent=function(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)},Yo.prototype._setFlags=function(t,e,i){if(!this._finalized)throw"Not finalized";var r,s,o=2*t,a=4*this._portions[o],n=4*this._portions[o+1],l=this._scratchMemory.getUInt8Array(n),h=!!(e&G),u=!!(e&K),c=!!(e&X);r=!h||c||u?vr:i?yr:br,s=!h||c?vr:!!(e&Z)?Mr:!!(e&q)?Pr:u?xr:vr;for(var p=h&&!c&&!!(e&W)?Dr:vr,d=0;d<n;d+=4)l[d+0]=r,l[d+1]=s,l[d+2]=0,l[d+3]=p;this._state.flagsBuf.setData(l,a,n)},Yo.prototype._setFlags2=function(t,e){if(!this._finalized)throw"Not finalized";for(var i=2*t,r=4*this._portions[i],s=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(s),a=e&H?255:0,n=0;n<s;n+=4)o[n+0]=a;this._state.flags2Buf.setData(o,r,s)},Yo.prototype.setOffset=function(t,e){if(!this._finalized)throw"Not finalized";if(this.model.scene.entityOffsetsEnabled){for(var i=2*t,r=3*this._portions[i],s=3*this._portions[i+1],o=this._scratchMemory.getFloat32Array(s),a=e[0],n=e[1],l=e[2],h=0;h<s;h+=3)o[h+0]=a,o[h+1]=n,o[h+2]=l;this._state.offsetsBuf.setData(o,r,s)}else this.model.error("Entity#offset not enabled for this Viewer")},Yo.prototype.drawColorOpaque=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(e,this,br)},Yo.prototype.drawColorTransparent=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(e,this,yr)},Yo.prototype.drawDepth=function(t,e){},Yo.prototype.drawNormals=function(t,e){},Yo.prototype.drawSilhouetteXRayed=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,xr)},Yo.prototype.drawSilhouetteHighlighted=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,Pr)},Yo.prototype.drawSilhouetteSelected=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,Mr)},Yo.prototype.drawEdgesColorOpaque=function(t,e){},Yo.prototype.drawEdgesColorTransparent=function(t,e){},Yo.prototype.drawEdgesHighlighted=function(t,e){},Yo.prototype.drawEdgesSelected=function(t,e){},Yo.prototype.drawEdgesXRayed=function(t,e){},Yo.prototype.drawPickMesh=function(t){},Yo.prototype.drawPickDepths=function(t){},Yo.prototype.drawPickNormals=function(t){},Yo.prototype.drawOcclusion=function(t){},Yo.prototype.drawShadow=function(t){},Yo.prototype.destroy=function(){var t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.destroy()};var Ko=E.vec3(),qo=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};qo.prototype.getValid=function(){return this._hash===this._getHash()},qo.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},qo.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.lineWidth(s.linesMaterial.lineWidth);var u=s._sectionPlanesState.sectionPlanes.length;if(u>0)for(var c=s._sectionPlanesState.sectionPlanes,p=e.layerIndex*u,d=r.renderFlags,f=0;f<u;f++){var _=this._uSectionPlanes[f];if(_){var g=d.sectionPlanesActivePerLayer[p+f];if(a.uniform1i(_.active,g?1:0),g){var m=c[f];if(h){var v=at(m.dist,m.dir,h,Ko);a.uniform3fv(_.pos,v)}else a.uniform3fv(_.pos,m.pos);a.uniform3fv(_.dir,m.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.LINES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},qo.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aOffset=i.getAttribute("offset"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},qo.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},qo.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},qo.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines instancing color vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("uniform vec4 lightAmbient;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0,  float(color.a) / 255.0);"),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},qo.prototype._buildFragmentShader=function(){var t,e,i=this._scene,r=i._sectionPlanesState,s=r.sectionPlanes.length>0,o=[];if(o.push("// Lines instancing color fragment shader"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),s)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),t=0,e=r.sectionPlanes.length;t<e;t++)o.push("uniform bool sectionPlaneActive"+t+";"),o.push("uniform vec3 sectionPlanePos"+t+";"),o.push("uniform vec3 sectionPlaneDir"+t+";");if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),s){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),t=0,e=r.sectionPlanes.length;t<e;t++)o.push("if (sectionPlaneActive"+t+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),o.push("   gl_FragColor            = vec4(vColor.rgb * ambient, vColor.a);")):o.push("    gl_FragColor           = vColor;"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o},qo.prototype.webglContextRestored=function(){this._program=null},qo.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Zo=E.vec3(),Qo=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Qo.prototype.getValid=function(){return this._hash===this._getHash()},Qo.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Qo.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter;if(this._program||(this._allocate(e.model.scene),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===xr){var u=s.xrayMaterial._state,c=u.fillColor,p=u.fillAlpha;a.uniform4f(this._uColor,c[0],c[1],c[2],p)}else if(i===Pr){var d=s.highlightMaterial._state,f=d.fillColor,_=d.fillAlpha;a.uniform4f(this._uColor,f[0],f[1],f[2],_)}else if(i===Mr){var g=s.selectedMaterial._state,m=g.fillColor,v=g.fillAlpha;a.uniform4f(this._uColor,m[0],m[1],m[2],v)}else a.uniform4fv(this._uColor,E.vec3([1,1,1]));a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.lineWidth(s.linesMaterial.lineWidth);var b=s._sectionPlanesState.sectionPlanes.length;if(b>0)for(var y=s._sectionPlanesState.sectionPlanes,P=e.layerIndex*b,M=r.renderFlags,x=0;x<b;x++){var w=this._uSectionPlanes[x];if(w){var C=M.sectionPlanesActivePerLayer[P+x];if(a.uniform1i(w.active,C?1:0),C){var A=y[x];if(h){var S=at(A.dist,A.dir,h,Zo);a.uniform3fv(w.pos,S)}else a.uniform3fv(w.pos,A.pos);a.uniform3fv(w.dir,A.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.LINES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},Qo.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uColor=r.getLocation("color"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Qo.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},Qo.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Qo.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines instancing silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("uniform vec4 color;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i},Qo.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Lines instancing silhouette fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("uniform vec4 color;"),r.push("void main(void) {"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = color;"),r.push("}"),r},Qo.prototype.webglContextRestored=function(){this._program=null},Qo.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Jo=function(t){this._scene=t},$o={colorRenderer:{configurable:!0},silhouetteRenderer:{configurable:!0}};Jo.prototype._compile=function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null)},$o.colorRenderer.get=function(){return this._colorRenderer||(this._colorRenderer=new qo(this._scene)),this._colorRenderer},$o.silhouetteRenderer.get=function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Qo(this._scene)),this._silhouetteRenderer},Jo.prototype._destroy=function(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy()},Object.defineProperties(Jo.prototype,$o);var ta={};var ea=wt.SUPPORTED_EXTENSIONS.OES_element_index_uint,ia=new Uint8Array(4),ra=E.vec4([0,0,0,1]),sa=E.vec4([0,0,0,1]),oa=E.vec4([0,0,0,1]),aa=new Float32Array(3),na=function(t,e){var i,r,s;this.sortId="LinesInstancingLayer",this.layerIndex=e.layerIndex,this._linesInstancingRenderers=(i=t.scene,r=i.id,(s=ta[r])||(s=new Jo(i),ta[r]=s,s._compile(),i.on("compile",(function(){s._compile()})),i.on("destroyed",(function(){delete ta[r],s._destroy()}))),s),this.model=t,this._aabb=E.collapseAABB3();var o=t.scene.canvas.gl,a={positionsDecodeMatrix:E.mat4(),numInstances:0,obb:E.OBB3(),rtcCenter:null},n=!!e.positionsDecodeMatrix;if(e.positions)if(n){a.positionsBuf=new Ut(o,o.ARRAY_BUFFER,e.positions,e.positions.length,3,o.STATIC_DRAW,!1),a.positionsDecodeMatrix.set(e.positionsDecodeMatrix);var l=E.collapseAABB3();E.expandAABB3Points3(l,e.positions),Re.decompressAABB(l,a.positionsDecodeMatrix),E.AABB3ToOBB3(l,a.obb)}else{var h=e.positions.length,u=E.collapseAABB3();E.expandAABB3Points3(u,e.positions),E.AABB3ToOBB3(u,a.obb);var c=ms(e.positions,u,a.positionsDecodeMatrix);a.positionsBuf=new Ut(o,o.ARRAY_BUFFER,c,h,3,o.STATIC_DRAW,!1)}e.indices&&(a.indicesBuf=new Ut(o,o.ELEMENT_ARRAY_BUFFER,ea?new Uint32Array(e.indices):new Uint16Array(e.indices),e.indices.length,1,o.STATIC_DRAW)),this._state=new oe(a),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.indices?e.indices.length/3:0,this._colors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],e.rtcCenter&&(this._state.rtcCenter=E.vec3(e.rtcCenter)),this._finalized=!1,this.aabb=E.collapseAABB3()};na.prototype.createPortion=function(t){var e=t.color,i=t.opacity,r=t.meshMatrix,s=t.worldMatrix,o=t.aabb;if(this._finalized)throw"Already finalized";var a=e[0],n=e[1],l=e[2];e[3],this._colors.push(a),this._colors.push(n),this._colors.push(l),this._colors.push(i),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(r[0]),this._modelMatrixCol0.push(r[4]),this._modelMatrixCol0.push(r[8]),this._modelMatrixCol0.push(r[12]),this._modelMatrixCol1.push(r[1]),this._modelMatrixCol1.push(r[5]),this._modelMatrixCol1.push(r[9]),this._modelMatrixCol1.push(r[13]),this._modelMatrixCol2.push(r[2]),this._modelMatrixCol2.push(r[6]),this._modelMatrixCol2.push(r[10]),this._modelMatrixCol2.push(r[14]),E.collapseAABB3(o);for(var h=this._state.obb,u=h.length,c=0;c<u;c+=4)ra[0]=h[c+0],ra[1]=h[c+1],ra[2]=h[c+2],E.transformPoint4(r,ra,sa),s?(E.transformPoint4(s,sa,oa),E.expandAABB3Point3(o,oa)):E.expandAABB3Point3(o,sa);if(this._state.rtcCenter){var p=this._state.rtcCenter;o[0]+=p[0],o[1]+=p[1],o[2]+=p[2],o[3]+=p[0],o[4]+=p[1],o[5]+=p[2]}E.expandAABB3(this.aabb,o),this._state.numInstances++;var d=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,d},na.prototype.finalize=function(){if(this._finalized)throw"Already finalized";var t=this.model.scene.canvas.gl,e=this._colors.length,i=e;if(e>0){this._state.colorsBuf=new Ut(t,t.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,t.DYNAMIC_DRAW,!1),this._colors=[]}if(i>0){this._state.flagsBuf=new Ut(t,t.ARRAY_BUFFER,new Uint8Array(i),i,4,t.DYNAMIC_DRAW,!1),this._state.flags2Buf=new Ut(t,t.ARRAY_BUFFER,new Uint8Array(i),i,4,t.DYNAMIC_DRAW,!0)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){this._state.offsetsBuf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,t.DYNAMIC_DRAW,!1),this._offsets=[]}if(this._modelMatrixCol0.length>0){var r=!1;this._state.modelMatrixCol0Buf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,t.STATIC_DRAW,r),this._state.modelMatrixCol1Buf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,t.STATIC_DRAW,r),this._state.modelMatrixCol2Buf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,t.STATIC_DRAW,r),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}this._finalized=!0},na.prototype.initFlags=function(t,e,i){e&G&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&q&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&K&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&Z&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&H&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&Q&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&W&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&X&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)},na.prototype.setVisible=function(t,e,i){if(!this._finalized)throw"Not finalized";e&G?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)},na.prototype.setHighlighted=function(t,e,i){if(!this._finalized)throw"Not finalized";e&q?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)},na.prototype.setXRayed=function(t,e,i){if(!this._finalized)throw"Not finalized";e&K?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)},na.prototype.setSelected=function(t,e,i){if(!this._finalized)throw"Not finalized";e&Z?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)},na.prototype.setEdges=function(t,e,i){if(!this._finalized)throw"Not finalized";e&Q?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)},na.prototype.setClippable=function(t,e){if(!this._finalized)throw"Not finalized";e&H?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)},na.prototype.setCollidable=function(t,e){if(!this._finalized)throw"Not finalized"},na.prototype.setPickable=function(t,e,i){if(!this._finalized)throw"Not finalized";e&W?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(t,e,i)},na.prototype.setCulled=function(t,e,i){if(!this._finalized)throw"Not finalized";e&X?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)},na.prototype.setColor=function(t,e){if(!this._finalized)throw"Not finalized";ia[0]=e[0],ia[1]=e[1],ia[2]=e[2],ia[3]=e[3],this._state.colorsBuf.setData(ia,4*t,4)},na.prototype.setTransparent=function(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)},na.prototype._setFlags=function(t,e,i){if(!this._finalized)throw"Not finalized";var r,s,o=!!(e&G),a=!!(e&K),n=!!(e&q),l=!!(e&Z),h=!!(e&X);r=!o||h||a?vr:i?yr:br,s=!o||h?vr:l?Mr:n?Pr:a?xr:vr;var u=0;u=!o||h?vr:l?Ar:n?Cr:a?Sr:!!(e&Q)?i?Er:wr:vr;var c=o&&!h&&!!(e&W)?Dr:vr;ia[0]=r,ia[1]=s,ia[2]=u,ia[3]=c,this._state.flagsBuf.setData(ia,4*t,4)},na.prototype._setFlags2=function(t,e){if(!this._finalized)throw"Not finalized";var i=e&H?255:0;ia[0]=i,this._state.flags2Buf.setData(ia,4*t,4)},na.prototype.setOffset=function(t,e){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(aa[0]=e[0],aa[1]=e[1],aa[2]=e[2],this._state.offsetsBuf.setData(aa,3*t,3)):this.model.error("Entity#offset not enabled for this Viewer")},na.prototype.drawColorOpaque=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._linesInstancingRenderers.colorRenderer&&this._linesInstancingRenderers.colorRenderer.drawLayer(e,this,br)},na.prototype.drawColorTransparent=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._linesInstancingRenderers.colorRenderer&&this._linesInstancingRenderers.colorRenderer.drawLayer(e,this,yr)},na.prototype.drawDepth=function(t,e){},na.prototype.drawNormals=function(t,e){},na.prototype.drawSilhouetteXRayed=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(e,this,xr)},na.prototype.drawSilhouetteHighlighted=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(e,this,Pr)},na.prototype.drawSilhouetteSelected=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(e,this,Mr)},na.prototype.drawEdgesColorOpaque=function(t,e){},na.prototype.drawEdgesColorTransparent=function(t,e){},na.prototype.drawEdgesXRayed=function(t,e){},na.prototype.drawEdgesHighlighted=function(t,e){},na.prototype.drawEdgesSelected=function(t,e){},na.prototype.drawOcclusion=function(t,e){},na.prototype.drawShadow=function(t,e){},na.prototype.drawPickMesh=function(t,e){},na.prototype.drawPickDepths=function(t,e){},na.prototype.drawPickNormals=function(t,e){},na.prototype.destroy=function(){var t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.modelMatrixCol0Buf&&(t.modelMatrixCol0Buf.destroy(),t.modelMatrixCol0Buf=null),t.modelMatrixCol1Buf&&(t.modelMatrixCol1Buf.destroy(),t.modelMatrixCol1Buf=null),t.modelMatrixCol2Buf&&(t.modelMatrixCol2Buf.destroy(),t.modelMatrixCol2Buf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.destroy()};var la=E.vec3(),ha=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};ha.prototype.getValid=function(){return this._hash===this._getHash()},ha.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash},ha.prototype.drawLayer=function(t,e,i){var r=this._scene,s=r.camera,o=e.model,a=r.canvas.gl,n=e._state,l=e._state.rtcCenter,h=r.pointsMaterial;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?rt(s.viewMatrix,l):s.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix);var u=r._sectionPlanesState.sectionPlanes.length;if(u>0)for(var c=r._sectionPlanesState.sectionPlanes,p=e.layerIndex*u,d=o.renderFlags,f=0;f<u;f++){var _=this._uSectionPlanes[f];if(_){var g=d.sectionPlanesActivePerLayer[p+f];if(a.uniform1i(_.active,g?1:0),g){var m=c[f];if(l){var v=at(m.dist,m.dir,l,la);a.uniform3fv(_.pos,v)}else a.uniform3fv(_.pos,m.pos);a.uniform3fv(_.dir,m.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),h.filterIntensity&&a.uniform2f(this._uIntensityRange,h.minIntensity,h.maxIntensity),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),a.uniform1f(this._uPointSize,h.pointSize);var b="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,b),a.drawArrays(a.POINTS,0,n.positionsBuf.numItems)}},ha.prototype._allocate=function(){var t=this._scene,e=t.pointsMaterial._state,i=t.canvas.gl;if(this._program=new zt(i,this._buildShader(t)),this._program.errors)this.errors=this._program.errors;else{var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=t._sectionPlanesState.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._uPointSize=r.getLocation("pointSize"),this._uNearPlaneHeight=r.getLocation("nearPlaneHeight"),e.filterIntensity&&(this._uIntensityRange=r.getLocation("intensityRange")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},ha.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=this._program,r=t.camera.project;if(i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),t.logarithmicDepthBufferEnabled){var s=2/(Math.log(r.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,s)}},ha.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},ha.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial,r=[];return r.push("// Points batching color vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),r.push("attribute vec4 color;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),i.filterIntensity&&r.push("uniform vec2 intensityRange;"),t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),e&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vColor;"),r.push("void main(void) {"),r.push("if (int(flags.x) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),i.filterIntensity&&(r.push("float intensity = float(color.a) / 255.0;"),r.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {")),r.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&r.push("worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),e&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),i.filterIntensity&&r.push("}"),r.push("}"),r},ha.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Points batching color fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),t.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   gl_FragColor = vColor;"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r},ha.prototype.webglContextRestored=function(){this._program=null},ha.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var ua=new Float32Array([1,1,1]),ca=E.vec3(),pa=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};pa.prototype.getValid=function(){return this._hash===this._getHash()},pa.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash},pa.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter,h=s.pointsMaterial._state;if(this._program||(this._allocate(),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===xr){var u=s.xrayMaterial._state,c=u.fillColor,p=u.fillAlpha;a.uniform4f(this._uColor,c[0],c[1],c[2],p)}else if(i===Pr){var d=s.highlightMaterial._state,f=d.fillColor,_=d.fillAlpha;a.uniform4f(this._uColor,f[0],f[1],f[2],_)}else if(i===Mr){var g=s.selectedMaterial._state,m=g.fillColor,v=g.fillAlpha;a.uniform4f(this._uColor,m[0],m[1],m[2],v)}else a.uniform4fv(this._uColor,ua);var b=l?rt(o.viewMatrix,l):o.viewMatrix;a.uniformMatrix4fv(this._uViewMatrix,!1,b),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var y=s._sectionPlanesState.sectionPlanes.length;if(y>0)for(var P=s._sectionPlanesState.sectionPlanes,M=e.layerIndex*y,x=r.renderFlags,w=0;w<y;w++){var E=this._uSectionPlanes[w];if(E){var C=x.sectionPlanesActivePerLayer[M+w];if(a.uniform1i(E.active,C?1:0),C){var A=P[w];if(l){var S=at(A.dist,A.dir,l,ca);a.uniform3fv(E.pos,S)}else a.uniform3fv(E.pos,A.pos);a.uniform3fv(E.dir,A.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),a.uniform1f(this._uPointSize,h.pointSize);var D="ortho"===s.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,D),a.drawArrays(a.POINTS,0,n.positionsBuf.numItems)}},pa.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},pa.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},pa.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},pa.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,r=[];return r.push("// Points batching silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),t.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform vec4 color;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),e&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("void main(void) {"),r.push("if (int(flags.y) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r},pa.prototype._buildFragmentShader=function(){var t,e,i=this._scene,r=i._sectionPlanesState,s=r.sectionPlanes.length>0,o=[];if(o.push("// Points batching silhouette vertex shader"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),s)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),t=0,e=r.sectionPlanes.length;t<e;t++)o.push("uniform bool sectionPlaneActive"+t+";"),o.push("uniform vec3 sectionPlanePos"+t+";"),o.push("uniform vec3 sectionPlaneDir"+t+";");if(o.push("uniform vec4 color;"),o.push("void main(void) {"),i.pointsMaterial.roundPoints&&(o.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("  float r = dot(cxy, cxy);"),o.push("  if (r > 1.0) {"),o.push("       discard;"),o.push("  }")),s){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),t=0,e=r.sectionPlanes.length;t<e;t++)o.push("if (sectionPlaneActive"+t+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("gl_FragColor = color;"),o.push("}"),o},pa.prototype.webglContextRestored=function(){this._program=null},pa.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var da=E.vec3(),fa=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};fa.prototype.getValid=function(){return this._hash===this._getHash()},fa.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash},fa.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter,h=s.pointsMaterial._state;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var u=t.pickViewMatrix||o.viewMatrix,c=l?rt(u,l):u;if(a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,c),s.logarithmicDepthBufferEnabled){var p=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,p)}var d=s._sectionPlanesState.sectionPlanes.length;if(d>0)for(var f=s._sectionPlanesState.sectionPlanes,_=e.layerIndex*d,g=r.renderFlags,m=0;m<d;m++){var v=this._uSectionPlanes[m];if(v){var b=g.sectionPlanesActivePerLayer[_+m];if(a.uniform1i(v.active,b?1:0),b){var y=f[m];if(l){var P=at(y.dist,y.dir,l,da);a.uniform3fv(v.pos,P)}else a.uniform3fv(v.pos,y.pos);a.uniform3fv(v.dir,y.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aPickColor&&this._aPickColor.bindArrayBuffer(n.pickColorsBuf),a.uniform1f(this._uPointSize,h.pointSize);var M="ortho"===s.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,M),a.drawArrays(a.POINTS,0,n.positionsBuf.numItems)},fa.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aPickColor=i.getAttribute("pickColor"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},fa.prototype._bindProgram=function(t){var e=this._scene.canvas.gl;this._program.bind(),e.uniform1i(this._uPickInvisible,t.pickInvisible)},fa.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},fa.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,r=[];return r.push("// Points batching pick mesh vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),t.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("attribute vec4 pickColor;"),r.push("uniform bool pickInvisible;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),e&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vPickColor;"),r.push("void main(void) {"),r.push("if (int(flags.w) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("  } else {"),r.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(r.push("      vWorldPosition = worldPosition;"),r.push("      vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("gl_PointSize += 10.0;"),r.push("  }"),r.push("}"),r},fa.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Points batching pick mesh vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vPickColor;"),r.push("void main(void) {"),t.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(s=0;s<e.sectionPlanes.length;s++)r.push("      if (sectionPlaneActive"+s+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   gl_FragColor = vPickColor; "),r.push("}"),r},fa.prototype.webglContextRestored=function(){this._program=null},fa.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var _a=E.vec3(),ga=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};ga.prototype.getValid=function(){return this._hash===this._getHash()},ga.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash},ga.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=e._state.rtcCenter,h=s.pointsMaterial._state;this._program||this._allocate(),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible);var u=t.pickViewMatrix||o.viewMatrix,c=l?rt(u,l):u;if(a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,c),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniform1f(this._uPickZNear,t.pickZNear),a.uniform1f(this._uPickZFar,t.pickZFar),s.logarithmicDepthBufferEnabled){var p=2/(Math.log(t.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,p)}var d=s._sectionPlanesState.sectionPlanes.length;if(d>0)for(var f=s._sectionPlanesState.sectionPlanes,_=e.layerIndex*d,g=r.renderFlags,m=0;m<d;m++){var v=this._uSectionPlanes[m];if(v){var b=g.sectionPlanesActivePerLayer[_+m];if(a.uniform1i(v.active,b?1:0),b){var y=f[m];if(l){var P=at(y.dist,y.dir,l,_a);a.uniform3fv(v.pos,P)}else a.uniform3fv(v.pos,y.pos);a.uniform3fv(v.dir,y.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),a.uniform1f(this._uPointSize,h.pointSize);var M="ortho"===s.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,M),a.drawArrays(a.POINTS,0,n.positionsBuf.numItems)},ga.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},ga.prototype._bindProgram=function(){this._program.bind()},ga.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},ga.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,r=[];return r.push("// Points batched pick depth vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),t.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("uniform bool pickInvisible;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),e&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vViewPosition;"),r.push("void main(void) {"),r.push("if (int(flags.w) != renderPass) {"),r.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("  } else {"),r.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(r.push("      vWorldPosition = worldPosition;"),r.push("      vFlags2 = flags2;")),r.push("vViewPosition = viewPosition;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("gl_PointSize += 10.0;"),r.push("  }"),r.push("}"),r},ga.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Points batched pick depth fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),r.push("uniform float pickZNear;"),r.push("uniform float pickZFar;"),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vViewPosition;"),r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("void main(void) {"),t.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("      if (sectionPlaneActive"+o+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),r.push("    gl_FragColor = packDepth(zNormalizedDepth); "),r.push("}"),r},ga.prototype.webglContextRestored=function(){this._program=null},ga.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var ma=E.vec3(),va=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};va.prototype.getValid=function(){return this._hash===this._getHash()},va.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash},va.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.canvas.gl,a=e._state,n=s.camera,l=e._state.rtcCenter,h=s.pointsMaterial._state;if(this._program||(this._allocate(e),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uViewMatrix,!1,l?rt(n.viewMatrix,l):n.viewMatrix),o.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var u=s._sectionPlanesState.sectionPlanes.length;if(u>0)for(var c=s._sectionPlanesState.sectionPlanes,p=e.layerIndex*u,d=r.renderFlags,f=0;f<u;f++){var _=this._uSectionPlanes[f];if(_){var g=d.sectionPlanesActivePerLayer[p+f];if(o.uniform1i(_.active,g?1:0),g){var m=c[f];if(l){var v=at(m.dist,m.dir,l,ma);o.uniform3fv(_.pos,v)}else o.uniform3fv(_.pos,m.pos);o.uniform3fv(_.dir,m.dir)}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),o.uniform1f(this._uPointSize,h.pointSize);var b="ortho"===s.camera.projection?1:o.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));o.uniform1f(this._uNearPlaneHeight,b),o.drawArrays(o.POINTS,0,a.positionsBuf.numItems)}},va.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},va.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},va.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},va.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,r=[];return r.push("// Points batching occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),t.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),e&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("void main(void) {"),r.push("if (int(flags.x) != renderPass) {"),r.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("  } else {"),r.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(r.push("      vWorldPosition = worldPosition;"),r.push("      vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("  gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("  }"),r.push("}"),r},va.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Points batching occlusion fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("void main(void) {"),t.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("      float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("      if (sectionPlaneActive"+o+") {"),r.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("      }");r.push("      if (dist > 0.0) { discard; }"),r.push("  }")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),r.push("}"),r},va.prototype.webglContextRestored=function(){this._program=null},va.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var ba=function(t){this._scene=t},ya={colorRenderer:{configurable:!0},silhouetteRenderer:{configurable:!0},pickMeshRenderer:{configurable:!0},pickDepthRenderer:{configurable:!0},occlusionRenderer:{configurable:!0}};ba.prototype._compile=function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null)},ya.colorRenderer.get=function(){return this._colorRenderer||(this._colorRenderer=new ha(this._scene)),this._colorRenderer},ya.silhouetteRenderer.get=function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new pa(this._scene)),this._silhouetteRenderer},ya.pickMeshRenderer.get=function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new fa(this._scene)),this._pickMeshRenderer},ya.pickDepthRenderer.get=function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new ga(this._scene)),this._pickDepthRenderer},ya.occlusionRenderer.get=function(){return this._occlusionRenderer||(this._occlusionRenderer=new va(this._scene)),this._occlusionRenderer},ba.prototype._destroy=function(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy()},Object.defineProperties(ba.prototype,ya);var Pa={};var Ma=wt.SUPPORTED_EXTENSIONS.OES_element_index_uint,xa=function(t){void 0===t&&(t=5e6),Ma?t>5e6&&(t=5e6):t>65530&&(t=65530),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.intensities=[],this.pickColors=[],this.flags=[],this.flags2=[],this.offsets=[]},wa=E.vec4(),Ea=E.vec4(),Ca=E.vec4([0,0,0,1]),Aa=E.vec4([0,0,0,1]),Sa=E.vec4([0,0,0,1]),Da=E.OBB3(),La=function(t,e){this.sortId="PointsBatchingLayer",this.layerIndex=e.layerIndex,this._pointsBatchingRenderers=function(t){var e=t.id,i=Pa[e];return i||(i=new ba(t),Pa[e]=i,i._compile(),t.on("compile",(function(){i._compile()})),t.on("destroyed",(function(){delete Pa[e],i._destroy()}))),i}(t.scene),this.model=t,this._buffer=new xa(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new oe({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,flags2Buf:null,positionsDecodeMatrix:E.mat4(),rtcCenter:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=E.collapseAABB3(),this._portions=[],this._finalized=!1,this._positionsDecodeMatrix=e.positionsDecodeMatrix,this._preCompressed=!!this._positionsDecodeMatrix,e.rtcCenter&&(this._state.rtcCenter=E.vec3(e.rtcCenter)),this.aabb=E.collapseAABB3()};La.prototype.canCreatePortion=function(t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+t<3*this._buffer.maxVerts},La.prototype.createPortion=function(t){if(this._finalized)throw"Already finalized";var e=t.positions,i=t.color,r=t.colorsCompressed,s=t.colors,o=t.meshMatrix,a=t.worldMatrix,n=t.worldAABB,l=t.pickColor,h=this._buffer,u=h.positions.length/3,c=e.length/3,p=e.length;if(this._preCompressed){for(var d=0,f=e.length;d<f;d++)h.positions.push(e[d]);var _=Re.getPositionsBounds(e),g=Re.decompressPosition(_.min,this._positionsDecodeMatrix,wa),m=Re.decompressPosition(_.max,this._positionsDecodeMatrix,Ea);n[0]=g[0],n[1]=g[1],n[2]=g[2],n[3]=m[0],n[4]=m[1],n[5]=m[2],a&&(E.AABB3ToOBB3(n,Da),E.transformOBB3(a,Da),E.OBB3ToAABB3(Da,n))}else{for(var v=h.positions.length,b=0,y=e.length;b<y;b++)h.positions.push(e[b]);if(o)for(var P=v,M=v+p;P<M;P+=3)Ca[0]=h.positions[P+0],Ca[1]=h.positions[P+1],Ca[2]=h.positions[P+2],E.transformPoint4(o,Ca,Aa),h.positions[P+0]=Aa[0],h.positions[P+1]=Aa[1],h.positions[P+2]=Aa[2],E.expandAABB3Point3(this._modelAABB,Aa),a?(E.transformPoint4(a,Aa,Sa),E.expandAABB3Point3(n,Sa)):E.expandAABB3Point3(n,Aa);else for(var x=v,w=v+p;x<w;x+=3)Ca[0]=h.positions[x+0],Ca[1]=h.positions[x+1],Ca[2]=h.positions[x+2],E.expandAABB3Point3(this._modelAABB,Ca),a?(E.transformPoint4(a,Ca,Aa),E.expandAABB3Point3(n,Aa)):E.expandAABB3Point3(n,Ca)}if(this._state.rtcCenter){var C=this._state.rtcCenter;n[0]+=C[0],n[1]+=C[1],n[2]+=C[2],n[3]+=C[0],n[4]+=C[1],n[5]+=C[2]}if(E.expandAABB3(this.aabb,n),r)for(var A=0,S=r.length;A<S;A++)h.colors.push(r[A]);else if(s)for(var D=0,L=s.length;D<L;D++)h.colors.push(255*s[D]);else if(i)for(var B=i[0],R=i[1],T=i[2],F=0;F<c;F++)h.colors.push(B),h.colors.push(R),h.colors.push(T),h.colors.push(1);for(var N=h.pickColors.length,I=N,k=N+4*c;I<k;I+=4)h.pickColors.push(l[0]),h.pickColors.push(l[1]),h.pickColors.push(l[2]),h.pickColors.push(l[3]);if(this.model.scene.entityOffsetsEnabled)for(var O=0;O<c;O++)h.offsets.push(0),h.offsets.push(0),h.offsets.push(0);var V=this._portions.length/2;return this._portions.push(u),this._portions.push(c),this._numPortions++,this.model.numPortions++,V},La.prototype.finalize=function(){if(this._finalized)this.model.error("Already finalized");else{var t=this._state,e=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressed){t.positionsDecodeMatrix=this._positionsDecodeMatrix;var r=new Uint16Array(i.positions);t.positionsBuf=new Ut(e,e.ARRAY_BUFFER,r,i.positions.length,3,e.STATIC_DRAW)}else{var s=ms(new Float32Array(i.positions),this._modelAABB,t.positionsDecodeMatrix);t.positionsBuf=new Ut(e,e.ARRAY_BUFFER,s,i.positions.length,3,e.STATIC_DRAW)}if(i.colors.length>0){var o=new Uint8Array(i.colors);t.colorsBuf=new Ut(e,e.ARRAY_BUFFER,o,i.colors.length,4,e.STATIC_DRAW,!1)}if(i.positions.length>0){var a=i.positions.length/3*4,n=new Uint8Array(a),l=new Uint8Array(a);t.flagsBuf=new Ut(e,e.ARRAY_BUFFER,n,n.length,4,e.DYNAMIC_DRAW,!1),t.flags2Buf=new Ut(e,e.ARRAY_BUFFER,l,l.length,4,e.DYNAMIC_DRAW,!0)}if(i.pickColors.length>0){var h=new Uint8Array(i.pickColors);t.pickColorsBuf=new Ut(e,e.ARRAY_BUFFER,h,i.pickColors.length,4,e.STATIC_DRAW,!1)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){var u=new Float32Array(i.offsets);t.offsetsBuf=new Ut(e,e.ARRAY_BUFFER,u,i.offsets.length,3,e.DYNAMIC_DRAW)}this._buffer=null,this._finalized=!0}},La.prototype.initFlags=function(t,e,i){e&G&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&q&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&K&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&Z&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&H&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&W&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&X&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)},La.prototype.setVisible=function(t,e,i){if(!this._finalized)throw"Not finalized";e&G?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)},La.prototype.setHighlighted=function(t,e,i){if(!this._finalized)throw"Not finalized";e&q?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)},La.prototype.setXRayed=function(t,e,i){if(!this._finalized)throw"Not finalized";e&K?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)},La.prototype.setSelected=function(t,e,i){if(!this._finalized)throw"Not finalized";e&Z?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)},La.prototype.setEdges=function(t,e,i){if(!this._finalized)throw"Not finalized"},La.prototype.setClippable=function(t,e){if(!this._finalized)throw"Not finalized";e&H?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)},La.prototype.setCulled=function(t,e,i){if(!this._finalized)throw"Not finalized";e&X?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)},La.prototype.setCollidable=function(t,e){if(!this._finalized)throw"Not finalized"},La.prototype.setPickable=function(t,e,i){if(!this._finalized)throw"Not finalized";e&W?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(t,e,i)},La.prototype.setColor=function(t,e){if(!this._finalized)throw"Not finalized";for(var i=2*t,r=4*this._portions[i],s=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(s),a=e[0],n=e[1],l=e[2],h=0;h<s;h+=4)o[h+0]=a,o[h+1]=n,o[h+2]=l;this._state.colorsBuf.setData(o,r,s)},La.prototype.setTransparent=function(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)},La.prototype._setFlags=function(t,e,i){if(!this._finalized)throw"Not finalized";var r,s,o=2*t,a=4*this._portions[o],n=4*this._portions[o+1],l=this._scratchMemory.getUInt8Array(n),h=!!(e&G),u=!!(e&K),c=!!(e&X);r=!h||c||u?vr:i?yr:br,s=!h||c?vr:!!(e&Z)?Mr:!!(e&q)?Pr:u?xr:vr;for(var p=h&&!c&&!!(e&W)?Dr:vr,d=0;d<n;d+=4)l[d+0]=r,l[d+1]=s,l[d+2]=0,l[d+3]=p;this._state.flagsBuf.setData(l,a,n)},La.prototype._setFlags2=function(t,e){if(!this._finalized)throw"Not finalized";for(var i=2*t,r=4*this._portions[i],s=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(s),a=e&H?255:0,n=0;n<s;n+=4)o[n+0]=a;this._state.flags2Buf.setData(o,r,s)},La.prototype.setOffset=function(t,e){if(!this._finalized)throw"Not finalized";if(this.model.scene.entityOffsetsEnabled){for(var i=2*t,r=3*this._portions[i],s=3*this._portions[i+1],o=this._scratchMemory.getFloat32Array(s),a=e[0],n=e[1],l=e[2],h=0;h<s;h+=3)o[h+0]=a,o[h+1]=n,o[h+2]=l;this._state.offsetsBuf.setData(o,r,s)}else this.model.error("Entity#offset not enabled for this Viewer")},La.prototype.drawColorOpaque=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsBatchingRenderers.colorRenderer&&this._pointsBatchingRenderers.colorRenderer.drawLayer(e,this,br)},La.prototype.drawColorTransparent=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsBatchingRenderers.colorRenderer&&this._pointsBatchingRenderers.colorRenderer.drawLayer(e,this,yr)},La.prototype.drawDepth=function(t,e){},La.prototype.drawNormals=function(t,e){},La.prototype.drawSilhouetteXRayed=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(e,this,xr)},La.prototype.drawSilhouetteHighlighted=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(e,this,Pr)},La.prototype.drawSilhouetteSelected=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(e,this,Mr)},La.prototype.drawEdgesColorOpaque=function(t,e){},La.prototype.drawEdgesColorTransparent=function(t,e){},La.prototype.drawEdgesHighlighted=function(t,e){},La.prototype.drawEdgesSelected=function(t,e){},La.prototype.drawEdgesXRayed=function(t,e){},La.prototype.drawPickMesh=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.pickMeshRenderer&&this._pointsBatchingRenderers.pickMeshRenderer.drawLayer(e,this,Dr)},La.prototype.drawPickDepths=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.pickDepthRenderer&&this._pointsBatchingRenderers.pickDepthRenderer.drawLayer(e,this,Dr)},La.prototype.drawPickNormals=function(t,e){},La.prototype.drawOcclusion=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.occlusionRenderer&&this._pointsBatchingRenderers.occlusionRenderer.drawLayer(e,this,br)},La.prototype.drawShadow=function(t,e){},La.prototype.destroy=function(){var t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.destroy()};var Ba=E.vec3(),Ra=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Ra.prototype.getValid=function(){return this._hash===this._getHash()},Ra.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash},Ra.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter,u=s.pointsMaterial._state;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),u.filterIntensity&&a.uniform2f(this._uIntensityRange,u.minIntensity,u.maxIntensity);var c=s._sectionPlanesState.sectionPlanes.length;if(c>0)for(var p=s._sectionPlanesState.sectionPlanes,d=e.layerIndex*c,f=r.renderFlags,_=0;_<c;_++){var g=this._uSectionPlanes[_];if(g){var m=f.sectionPlanesActivePerLayer[d+_];if(a.uniform1i(g.active,m?1:0),m){var v=p[_];if(h){var b=at(v.dist,v.dir,h,Ba);a.uniform3fv(g.pos,b)}else a.uniform3fv(g.pos,v.pos);a.uniform3fv(g.dir,v.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.uniform1f(this._uPointSize,u.pointSize);var y="ortho"===s.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,y),l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},Ra.prototype._allocate=function(){var t=this._scene,e=t.pointsMaterial._state,i=t.canvas.gl;if(this._program=new zt(i,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=i.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=t._sectionPlanesState.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aOffset=r.getAttribute("offset"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uPointSize=r.getLocation("pointSize"),this._uNearPlaneHeight=r.getLocation("nearPlaneHeight"),e.filterIntensity&&(this._uIntensityRange=r.getLocation("intensityRange")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Ra.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},Ra.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Ra.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,r=[];return r.push("// Points instancing color vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),r.push("attribute vec4 color;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 modelMatrixCol0;"),r.push("attribute vec4 modelMatrixCol1;"),r.push("attribute vec4 modelMatrixCol2;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),i.filterIntensity&&r.push("uniform vec2 intensityRange;"),t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),e&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vColor;"),r.push("void main(void) {"),r.push("if (int(flags.x) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),i.filterIntensity&&(r.push("float intensity = float(color.a) / 255.0;"),r.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {")),r.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),r.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),e&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),i.filterIntensity&&r.push("}"),r.push("}"),r},Ra.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Points instancing color fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vColor;"),r.push("void main(void) {"),t.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   gl_FragColor = vColor;"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r},Ra.prototype.webglContextRestored=function(){this._program=null},Ra.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Ta=E.vec3(),Fa=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Fa.prototype.getValid=function(){return this._hash===this._getHash()},Fa.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash},Fa.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter,u=s.pointsMaterial._state;if(this._program||(this._allocate(e.model.scene),!this.errors)){if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===xr){var c=s.xrayMaterial._state,p=c.fillColor,d=c.fillAlpha;a.uniform4f(this._uColor,p[0],p[1],p[2],d)}else if(i===Pr){var f=s.highlightMaterial._state,_=f.fillColor,g=f.fillAlpha;a.uniform4f(this._uColor,_[0],_[1],_[2],g)}else if(i===Mr){var m=s.selectedMaterial._state,v=m.fillColor,b=m.fillAlpha;a.uniform4f(this._uColor,v[0],v[1],v[2],b)}else a.uniform4fv(this._uColor,E.vec3([1,1,1]));a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var y=s._sectionPlanesState.sectionPlanes.length;if(y>0)for(var P=s._sectionPlanesState.sectionPlanes,M=e.layerIndex*y,x=r.renderFlags,w=0;w<y;w++){var C=this._uSectionPlanes[w];if(C){var A=x.sectionPlanesActivePerLayer[M+w];if(a.uniform1i(C.active,A?1:0),A){var S=P[w];if(h){var D=at(S.dist,S.dir,h,Ta);a.uniform3fv(C.pos,D)}else a.uniform3fv(C.pos,S.pos);a.uniform3fv(C.dir,S.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.uniform1f(this._uPointSize,u.pointSize);var L="ortho"===s.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,L),l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},Fa.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uColor=r.getLocation("color"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uPointSize=r.getLocation("pointSize"),this._uNearPlaneHeight=r.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Fa.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},Fa.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Fa.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,r=[];return r.push("// Points instancing silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),t.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("attribute vec4 modelMatrixCol0;"),r.push("attribute vec4 modelMatrixCol1;"),r.push("attribute vec4 modelMatrixCol2;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),r.push("uniform vec4 color;"),e&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("void main(void) {"),r.push("if (int(flags.y) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r},Fa.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Points instancing silhouette fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("uniform vec4 color;"),r.push("void main(void) {"),t.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = color;"),r.push("}"),r},Fa.prototype.webglContextRestored=function(){this._program=null},Fa.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Na=E.vec3(),Ia=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Ia.prototype.getValid=function(){return this._hash===this._getHash()},Ia.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash},Ia.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter,u=s.pointsMaterial._state;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i);var c=t.pickViewMatrix||o.viewMatrix,p=h?rt(c,h):c;if(a.uniformMatrix4fv(this._uViewMatrix,!1,p),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),s.logarithmicDepthBufferEnabled){var d=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,d)}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPickColor.bindArrayBuffer(n.pickColorsBuf),l.vertexAttribDivisorANGLE(this._aPickColor.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.uniform1f(this._uPointSize,u.pointSize);var f="ortho"===s.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,f);var _=s._sectionPlanesState.sectionPlanes.length;if(_>0)for(var g=s._sectionPlanesState.sectionPlanes,m=e.layerIndex*_,v=r.renderFlags,b=0;b<_;b++){var y=this._uSectionPlanes[b];if(y){var P=v.sectionPlanesActivePerLayer[m+b];if(a.uniform1i(y.active,P?1:0),P){var M=g[b];if(h){var x=at(M.dist,M.dir,h,Na);a.uniform3fv(y.pos,x)}else a.uniform3fv(y.pos,M.pos);a.uniform3fv(y.dir,M.dir)}}}l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aPickColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},Ia.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uPickInvisible=r.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._uRenderPass=r.getLocation("renderPass"),this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aPickColor=r.getAttribute("pickColor"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uPointSize=r.getLocation("pointSize"),this._uNearPlaneHeight=r.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},Ia.prototype._bindProgram=function(t){var e=this._scene.canvas.gl;this._program.bind(),e.uniform1i(this._uPickInvisible,t.pickInvisible)},Ia.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Ia.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,r=[];return r.push("// Points instancing pick mesh vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),t.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("attribute vec4 pickColor;"),r.push("attribute vec4 modelMatrixCol0;"),r.push("attribute vec4 modelMatrixCol1;"),r.push("attribute vec4 modelMatrixCol2;"),r.push("uniform bool pickInvisible;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),e&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vPickColor;"),r.push("void main(void) {"),r.push("if (int(flags.w) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),r.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(r.push("  vWorldPosition = worldPosition;"),r.push("  vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r},Ia.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Points instancing pick mesh fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vPickColor;"),r.push("void main(void) {"),t.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("gl_FragColor = vPickColor; "),r.push("}"),r},Ia.prototype.webglContextRestored=function(){this._program=null},Ia.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var ka=E.vec3(),Oa=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};Oa.prototype.getValid=function(){return this._hash===this._getHash()},Oa.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash},Oa.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.canvas.gl,a=e._state,n=this._instanceExt,l=e._state.rtcCenter,h=s.pointsMaterial._state;if(this._program||(this._allocate(e),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram());var u=s.camera;o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,t.pickInvisible);var c=t.pickViewMatrix||u.viewMatrix,p=l?rt(c,l):c;if(o.uniformMatrix4fv(this._uViewMatrix,!1,p),o.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),o.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),o.uniform1f(this._uPickZNear,t.pickZNear),o.uniform1f(this._uPickZFar,t.pickZFar),s.logarithmicDepthBufferEnabled){var d=2/(Math.log(t.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,d)}var f=s._sectionPlanesState.sectionPlanes.length;if(f>0)for(var _=s._sectionPlanesState.sectionPlanes,g=e.layerIndex*f,m=r.renderFlags,v=0;v<f;v++){var b=this._uSectionPlanes[v];if(b){var y=m.sectionPlanesActivePerLayer[g+v];if(o.uniform1i(b.active,y?1:0),y){var P=_[v];if(l){var M=at(P.dist,P.dir,l,ka);o.uniform3fv(b.pos,M)}else o.uniform3fv(b.pos,P.pos);o.uniform3fv(b.dir,P.dir)}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.uniform1f(this._uPointSize,h.pointSize);var x="ortho"===s.camera.projection?1:o.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));o.uniform1f(this._uNearPlaneHeight,x),n.drawArraysInstancedANGLE(o.POINTS,0,a.positionsBuf.numItems,a.numInstances),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),n.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisorANGLE(this._aOffset.location,0)}},Oa.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},Oa.prototype._bindProgram=function(){this._program.bind()},Oa.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Oa.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,r=[];return r.push("// Points instancing pick depth vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),t.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("attribute vec4 modelMatrixCol0;"),r.push("attribute vec4 modelMatrixCol1;"),r.push("attribute vec4 modelMatrixCol2;"),r.push("uniform bool pickInvisible;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),e&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("varying vec4 vViewPosition;"),r.push("void main(void) {"),r.push("if (int(flags.w) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(r.push("  vWorldPosition = worldPosition;"),r.push("  vFlags2 = flags2;")),r.push("  vViewPosition = viewPosition;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r},Oa.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Points instancing pick depth fragment shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),r.push("uniform float pickZNear;"),r.push("uniform float pickZFar;"),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec4 vViewPosition;"),r.push("vec4 packDepth(const in float depth) {"),r.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),r.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),r.push("  vec4 res = fract(depth * bitShift);"),r.push("  res -= res.xxyz * bitMask;"),r.push("  return res;"),r.push("}"),r.push("void main(void) {"),t.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),r.push("    gl_FragColor = packDepth(zNormalizedDepth); "),r.push("}"),r},Oa.prototype.webglContextRestored=function(){this._program=null},Oa.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Va=E.vec3(),za=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};za.prototype.getValid=function(){return this._hash===this._getHash()},za.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash},za.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter,u=s.pointsMaterial._state;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);var c=s._sectionPlanesState.sectionPlanes.length;if(c>0)for(var p=s._sectionPlanesState.sectionPlanes,d=e.layerIndex*c,f=r.renderFlags,_=0;_<c;_++){var g=this._uSectionPlanes[_];if(g){var m=f.sectionPlanesActivePerLayer[d+_];if(a.uniform1i(g.active,m?1:0),m){var v=p[_];if(h){var b=at(v.dist,v.dir,h,Va);a.uniform3fv(g.pos,b)}else a.uniform3fv(g.pos,v.pos);a.uniform3fv(g.dir,v.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aColor&&(this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1)),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),a.uniform1f(this._uPointSize,u.pointSize);var y="ortho"===s.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,y),l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aColor&&l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},za.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uRenderPass=r.getLocation("renderPass"),this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=r.getLocation("worldMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uPointSize=r.getLocation("pointSize"),this._uNearPlaneHeight=r.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC"))}},za.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},za.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},za.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,r=[];return r.push("// Points instancing occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),t.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 color;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("attribute vec4 modelMatrixCol0;"),r.push("attribute vec4 modelMatrixCol1;"),r.push("attribute vec4 modelMatrixCol2;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),e&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("void main(void) {"),r.push("if (int(flags.x) != renderPass) {"),r.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&r.push("  vWorldPosition = worldPosition;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r},za.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Points instancing occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0;s<e.sectionPlanes.length;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("void main(void) {"),t.pointsMaterial.roundPoints&&(r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }")),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var o=0;o<e.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return r.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r},za.prototype.webglContextRestored=function(){this._program=null},za.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Ua=E.vec3(),ja=function(t){this._scene=t,this._hash=this._getHash(),this._allocate()};ja.prototype.getValid=function(){return this._hash===this._getHash()},ja.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash},ja.prototype.drawLayer=function(t,e,i){var r=e.model,s=r.scene,o=s.camera,a=s.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.rtcCenter,u=s.pointsMaterial._state;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,h?rt(o.viewMatrix,h):o.viewMatrix);var c=s._sectionPlanesState.sectionPlanes.length;if(c>0)for(var p=s._sectionPlanesState.sectionPlanes,d=e.layerIndex*c,f=r.renderFlags,_=0;_<c;_++){var g=this._uSectionPlanes[_];if(g){var m=f.sectionPlanesActivePerLayer[d+_];if(a.uniform1i(g.active,m?1:0),m){var v=p[_];if(h){var b=at(v.dist,v.dir,h,Ua);a.uniform3fv(g.pos,b)}else a.uniform3fv(g.pos,v.pos);a.uniform3fv(g.dir,v.dir)}}}this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),a.uniform1f(this._uPointSize,u.pointSize);var y="ortho"===s.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,y),l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}},ja.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(var r=0,s=t._sectionPlanesState.sectionPlanes.length;r<s;r++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+r),pos:i.getLocation("sectionPlanePos"+r),dir:i.getLocation("sectionPlaneDir"+r)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}},ja.prototype._bindProgram=function(){var t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){var r=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,r)}},ja.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},ja.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,r=[];return r.push("// Points instancing depth vertex shader"),t.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("uniform int renderPass;"),r.push("attribute vec3 position;"),t.entityOffsetsEnabled&&r.push("attribute vec3 offset;"),r.push("attribute vec4 flags;"),r.push("attribute vec4 flags2;"),r.push("attribute vec4 modelMatrixCol0;"),r.push("attribute vec4 modelMatrixCol1;"),r.push("attribute vec4 modelMatrixCol2;"),r.push("uniform mat4 worldMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform mat4 positionsDecodeMatrix;"),r.push("uniform float pointSize;"),i.perspectivePoints&&r.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;")),e&&(r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;")),r.push("void main(void) {"),r.push("if (int(flags.x) != renderPass) {"),r.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),r.push("} else {"),r.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),r.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&r.push("      worldPosition.xyz = worldPosition.xyz + offset;"),r.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(r.push("vWorldPosition = worldPosition;"),r.push("vFlags2 = flags2;")),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(wt.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;"))),r.push("gl_Position = clipPos;"),i.perspectivePoints?(r.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),r.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),r.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):r.push("gl_PointSize = pointSize;"),r.push("}"),r.push("}"),r},ja.prototype._buildFragmentShader=function(){var t,e,i=this._scene,r=i._sectionPlanesState,s=r.sectionPlanes.length>0,o=[];if(o.push("// Points instancing depth vertex shader"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),s)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),t=0,e=r.sectionPlanes.length;t<e;t++)o.push("uniform bool sectionPlaneActive"+t+";"),o.push("uniform vec3 sectionPlanePos"+t+";"),o.push("uniform vec3 sectionPlaneDir"+t+";");if(o.push("const float   packUpScale = 256. / 255.;"),o.push("const float   unpackDownscale = 255. / 256.;"),o.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),o.push("const float   shiftRight8 = 1.0 / 256.;"),o.push("vec4 packDepthToRGBA( const in float v ) {"),o.push("    vec4 r = vec4( fract( v * packFactors ), v );"),o.push("    r.yzw -= r.xyz * shiftRight8;"),o.push("    return r * packUpScale;"),o.push("}"),o.push("void main(void) {"),i.pointsMaterial.roundPoints&&(o.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("  float r = dot(cxy, cxy);"),o.push("  if (r > 1.0) {"),o.push("       discard;"),o.push("  }")),s){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),t=0,e=r.sectionPlanes.length;t<e;t++)o.push("if (sectionPlaneActive"+t+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return o.push("    gl_FragColor = packDepthToRGBA( gl_FragCoord.z); "),i.logarithmicDepthBufferEnabled&&wt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o},ja.prototype.webglContextRestored=function(){this._program=null},ja.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Ga=E.vec3(),Xa=function(t){this._scene=t,this._hash=this._getHash(),this._lastLightId=null,this._allocate()};Xa.prototype.getValid=function(){return this._hash===this._getHash()},Xa.prototype._getHash=function(){return this._scene._sectionPlanesState.getHash()},Xa.prototype.drawLayer=function(t,e){var i=e.model,r=i.scene,s=r.canvas.gl,o=e._state,a=this._instanceExt;if(this._program||(this._allocate(),!this.errors)){t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),a.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aColor.bindArrayBuffer(o.colorsBuf),a.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),a.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),a.vertexAttribDivisorANGLE(this._aFlags2.location,1));var n=r._sectionPlanesState.sectionPlanes.length;if(n>0)for(var l=r._sectionPlanesState.sectionPlanes,h=e.layerIndex*n,u=i.renderFlags,c=e._state.rtcCenter,p=0;p<n;p++){var d=this._uSectionPlanes[p];if(d){var f=u.sectionPlanesActivePerLayer[h+p];if(s.uniform1i(d.active,f?1:0),f){var _=l[p];if(c){var g=at(_.dist,_.dir,c,Ga);s.uniform3fv(d.pos,g)}else s.uniform3fv(d.pos,_.pos);s.uniform3fv(d.dir,_.dir)}}}s.uniform1f(this._uPointSize,10),a.drawArraysInstancedANGLE(s.POINTS,0,o.positionsBuf.numItems,o.numInstances),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),a.vertexAttribDivisorANGLE(this._aColor.location,0),a.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&a.vertexAttribDivisorANGLE(this._aOffset.location,0)}},Xa.prototype._allocate=function(){var t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new zt(e,this._buildShader()),this._program.errors)this.errors=this._program.errors;else{this._instanceExt=e.getExtension("ANGLE_instanced_arrays");var r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=r.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=r.getLocation("shadowProjMatrix"),this._uSectionPlanes=[];for(var s=0,o=i.sectionPlanes.length;s<o;s++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+s),pos:r.getLocation("sectionPlanePos"+s),dir:r.getLocation("sectionPlaneDir"+s)});this._aPosition=r.getAttribute("position"),this._aOffset=r.getAttribute("offset"),this._aColor=r.getAttribute("color"),this._aFlags=r.getAttribute("flags"),this._aFlags2=r.getAttribute("flags2"),this._aModelMatrixCol0=r.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=r.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=r.getAttribute("modelMatrixCol2"),this._uPointSize=r.getLocation("pointSize")}},Xa.prototype._bindProgram=function(t,e){var i=this._scene.canvas.gl;this._program.bind(),i.uniformMatrix4fv(this._uShadowViewMatrix,!1,t.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,t.shadowProjMatrix),this._lastLightId=null},Xa.prototype._buildShader=function(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}},Xa.prototype._buildVertexShader=function(){var t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry shadow drawing vertex shader"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("gl_PointSize = pointSize;"),i.push("}"),i},Xa.prototype._buildFragmentShader=function(){var t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,r=[];if(r.push("// Instancing geometry depth drawing fragment shader"),t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),i){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(var s=0,o=e.sectionPlanes.length;s<o;s++)r.push("uniform bool sectionPlaneActive"+s+";"),r.push("uniform vec3 sectionPlanePos"+s+";"),r.push("uniform vec3 sectionPlaneDir"+s+";")}if(r.push("varying vec3 vViewNormal;"),r.push("vec3 packNormalToRGB( const in vec3 normal ) {"),r.push("    return normalize( normal ) * 0.5 + 0.5;"),r.push("}"),r.push("void main(void) {"),r.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),r.push("  float r = dot(cxy, cxy);"),r.push("  if (r > 1.0) {"),r.push("       discard;"),r.push("  }"),i){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(var a=0,n=e.sectionPlanes.length;a<n;a++)r.push("if (sectionPlaneActive"+a+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),r.push("}");r.push("if (dist > 0.0) { discard; }"),r.push("}")}return t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),r.push("}"),r},Xa.prototype.webglContextRestored=function(){this._program=null},Xa.prototype.destroy=function(){this._program&&this._program.destroy(),this._program=null};var Wa=function(t){this._scene=t},Ha={colorRenderer:{configurable:!0},silhouetteRenderer:{configurable:!0},depthRenderer:{configurable:!0},pickMeshRenderer:{configurable:!0},pickDepthRenderer:{configurable:!0},occlusionRenderer:{configurable:!0},shadowRenderer:{configurable:!0}};Wa.prototype._compile=function(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)},Ha.colorRenderer.get=function(){return this._colorRenderer||(this._colorRenderer=new Ra(this._scene,!1)),this._colorRenderer},Ha.silhouetteRenderer.get=function(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Fa(this._scene)),this._silhouetteRenderer},Ha.depthRenderer.get=function(){return this._depthRenderer||(this._depthRenderer=new ja(this._scene)),this._depthRenderer},Ha.pickMeshRenderer.get=function(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Ia(this._scene)),this._pickMeshRenderer},Ha.pickDepthRenderer.get=function(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Oa(this._scene)),this._pickDepthRenderer},Ha.occlusionRenderer.get=function(){return this._occlusionRenderer||(this._occlusionRenderer=new za(this._scene)),this._occlusionRenderer},Ha.shadowRenderer.get=function(){return this._shadowRenderer||(this._shadowRenderer=new Xa(this._scene)),this._shadowRenderer},Wa.prototype._destroy=function(){this._colorRenderer&&this._colorRenderer.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()},Object.defineProperties(Wa.prototype,Ha);var Ya={};var Ka=new Uint8Array(4),qa=E.vec4([0,0,0,1]),Za=E.vec4([0,0,0,1]),Qa=E.vec4([0,0,0,1]),Ja=new Float32Array(3),$a=function(t,e){var i,r,s;this.sortId="PointsInstancingLayer",this.layerIndex=e.layerIndex,this._pointsInstancingRenderers=(i=t.scene,r=i.id,(s=Ya[r])||(s=new Wa(i),Ya[r]=s,s._compile(),i.on("compile",(function(){s._compile()})),i.on("destroyed",(function(){delete Ya[r],s._destroy()}))),s),this.model=t,this._aabb=E.collapseAABB3();var o=t.scene.canvas.gl,a={positionsDecodeMatrix:E.mat4(),numInstances:0,obb:E.OBB3(),rtcCenter:null},n=!!e.positionsDecodeMatrix;if(!e.positions)throw"positions expected";var l=e.positions.length/3;if(n){a.positionsBuf=new Ut(o,o.ARRAY_BUFFER,e.positions,e.positions.length,3,o.STATIC_DRAW,!1),a.positionsDecodeMatrix.set(e.positionsDecodeMatrix);var h=E.collapseAABB3();E.expandAABB3Points3(h,e.positions),Re.decompressAABB(h,a.positionsDecodeMatrix),E.AABB3ToOBB3(h,a.obb)}else{var u=e.positions.length,c=E.collapseAABB3();E.expandAABB3Points3(c,e.positions),E.AABB3ToOBB3(c,a.obb);var p=ms(e.positions,c,a.positionsDecodeMatrix);a.positionsBuf=new Ut(o,o.ARRAY_BUFFER,p,u,3,o.STATIC_DRAW,!1)}if(e.colorsCompressed){var d=new Uint8Array(e.colorsCompressed);a.colorsBuf=new Ut(o,o.ARRAY_BUFFER,d,d.length,4,o.STATIC_DRAW,!1)}else if(e.colors){for(var f=e.colors,_=new Uint8Array(f.length),g=0,m=f.length;g<m;g++)_[g]=255*f[g];a.colorsBuf=new Ut(o,o.ARRAY_BUFFER,_,_.length,4,o.STATIC_DRAW,!1)}else{for(var v=new Uint8Array(4*l),b=0,y=4*l;b<y;b++)v[b]=255;a.colorsBuf=new Ut(o,o.ARRAY_BUFFER,v,v.length,4,o.STATIC_DRAW,!1)}this._state=new oe(a),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],e.rtcCenter&&(this._state.rtcCenter=E.vec3(e.rtcCenter)),this._finalized=!1,this.aabb=E.collapseAABB3()};$a.prototype.createPortion=function(t){var e=t.meshMatrix,i=t.worldMatrix,r=t.aabb,s=t.pickColor;if(this._finalized)throw"Already finalized";this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(e[0]),this._modelMatrixCol0.push(e[4]),this._modelMatrixCol0.push(e[8]),this._modelMatrixCol0.push(e[12]),this._modelMatrixCol1.push(e[1]),this._modelMatrixCol1.push(e[5]),this._modelMatrixCol1.push(e[9]),this._modelMatrixCol1.push(e[13]),this._modelMatrixCol2.push(e[2]),this._modelMatrixCol2.push(e[6]),this._modelMatrixCol2.push(e[10]),this._modelMatrixCol2.push(e[14]),this._pickColors.push(s[0]),this._pickColors.push(s[1]),this._pickColors.push(s[2]),this._pickColors.push(s[3]),E.collapseAABB3(r);for(var o=this._state.obb,a=o.length,n=0;n<a;n+=4)qa[0]=o[n+0],qa[1]=o[n+1],qa[2]=o[n+2],E.transformPoint4(e,qa,Za),i?(E.transformPoint4(i,Za,Qa),E.expandAABB3Point3(r,Qa)):E.expandAABB3Point3(r,Za);if(this._state.rtcCenter){var l=this._state.rtcCenter;r[0]+=l[0],r[1]+=l[1],r[2]+=l[2],r[3]+=l[0],r[4]+=l[1],r[5]+=l[2]}E.expandAABB3(this.aabb,r),this._state.numInstances++;var h=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,h},$a.prototype.finalize=function(){if(this._finalized)throw"Already finalized";var t=this.model.scene.canvas.gl,e=this._pickColors.length;if(e>0){this._state.flagsBuf=new Ut(t,t.ARRAY_BUFFER,new Uint8Array(e),e,4,t.DYNAMIC_DRAW,!1),this._state.flags2Buf=new Ut(t,t.ARRAY_BUFFER,new Uint8Array(e),e,4,t.DYNAMIC_DRAW,!0)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){this._state.offsetsBuf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,t.DYNAMIC_DRAW,!1),this._offsets=[]}if(this._modelMatrixCol0.length>0){var i=!1;this._state.modelMatrixCol0Buf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,t.STATIC_DRAW,i),this._state.modelMatrixCol1Buf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,t.STATIC_DRAW,i),this._state.modelMatrixCol2Buf=new Ut(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,t.STATIC_DRAW,i),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}if(this._pickColors.length>0){this._state.pickColorsBuf=new Ut(t,t.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,t.STATIC_DRAW,!1),this._pickColors=[]}this._finalized=!0},$a.prototype.initFlags=function(t,e,i){e&G&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&q&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&K&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&Z&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&H&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&Q&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&W&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&X&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)},$a.prototype.setVisible=function(t,e,i){if(!this._finalized)throw"Not finalized";e&G?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)},$a.prototype.setHighlighted=function(t,e,i){if(!this._finalized)throw"Not finalized";e&q?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)},$a.prototype.setXRayed=function(t,e,i){if(!this._finalized)throw"Not finalized";e&K?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)},$a.prototype.setSelected=function(t,e,i){if(!this._finalized)throw"Not finalized";e&Z?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)},$a.prototype.setEdges=function(t,e,i){if(!this._finalized)throw"Not finalized";e&Q?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)},$a.prototype.setClippable=function(t,e){if(!this._finalized)throw"Not finalized";e&H?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)},$a.prototype.setCollidable=function(t,e){if(!this._finalized)throw"Not finalized"},$a.prototype.setPickable=function(t,e,i){if(!this._finalized)throw"Not finalized";e&W?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(t,e,i)},$a.prototype.setCulled=function(t,e,i){if(!this._finalized)throw"Not finalized";e&X?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)},$a.prototype.setColor=function(t,e){if(!this._finalized)throw"Not finalized";Ka[0]=e[0],Ka[1]=e[1],Ka[2]=e[2],this._state.colorsBuf.setData(Ka,3*t,3)},$a.prototype.setTransparent=function(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)},$a.prototype._setFlags=function(t,e,i){if(!this._finalized)throw"Not finalized";var r,s,o=!!(e&G),a=!!(e&K),n=!!(e&q),l=!!(e&Z),h=!!(e&X);r=!o||h||a?vr:i?yr:br,s=!o||h?vr:l?Mr:n?Pr:a?xr:vr;var u=0;u=!o||h?vr:l?Ar:n?Cr:a?Sr:!!(e&Q)?i?Er:wr:vr;var c=o&&!h&&!!(e&W)?Dr:vr;Ka[0]=r,Ka[1]=s,Ka[2]=u,Ka[3]=c,this._state.flagsBuf.setData(Ka,4*t,4)},$a.prototype._setFlags2=function(t,e){if(!this._finalized)throw"Not finalized";var i=e&H?255:0;Ka[0]=i,this._state.flags2Buf.setData(Ka,4*t,4)},$a.prototype.setOffset=function(t,e){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(Ja[0]=e[0],Ja[1]=e[1],Ja[2]=e[2],this._state.offsetsBuf.setData(Ja,3*t,3)):this.model.error("Entity#offset not enabled for this Viewer")},$a.prototype.drawColorOpaque=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsInstancingRenderers.colorRenderer&&this._pointsInstancingRenderers.colorRenderer.drawLayer(e,this,br)},$a.prototype.drawColorTransparent=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsInstancingRenderers.colorRenderer&&this._pointsInstancingRenderers.colorRenderer.drawLayer(e,this,yr)},$a.prototype.drawDepth=function(t,e){},$a.prototype.drawNormals=function(t,e){},$a.prototype.drawSilhouetteXRayed=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(e,this,xr)},$a.prototype.drawSilhouetteHighlighted=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(e,this,Pr)},$a.prototype.drawSilhouetteSelected=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(e,this,Mr)},$a.prototype.drawEdgesColorOpaque=function(t,e){},$a.prototype.drawEdgesColorTransparent=function(t,e){},$a.prototype.drawEdgesHighlighted=function(t,e){},$a.prototype.drawEdgesSelected=function(t,e){},$a.prototype.drawEdgesXRayed=function(t,e){},$a.prototype.drawOcclusion=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.occlusionRenderer&&this._pointsInstancingRenderers.occlusionRenderer.drawLayer(e,this,br)},$a.prototype.drawShadow=function(t,e){},$a.prototype.drawPickMesh=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.pickMeshRenderer&&this._pointsInstancingRenderers.pickMeshRenderer.drawLayer(e,this,Dr)},$a.prototype.drawPickDepths=function(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.pickDepthRenderer&&this._pointsInstancingRenderers.pickDepthRenderer.drawLayer(e,this,Dr)},$a.prototype.drawPickNormals=function(t,e){},$a.prototype.destroy=function(){var t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.modelMatrixCol0Buf&&(t.modelMatrixCol0Buf.destroy(),t.modelMatrixCol0Buf=null),t.modelMatrixCol1Buf&&(t.modelMatrixCol1Buf.destroy(),t.modelMatrixCol1Buf=null),t.modelMatrixCol2Buf&&(t.modelMatrixCol2Buf.destroy(),t.modelMatrixCol2Buf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.destroy()};var tn=wt.SUPPORTED_EXTENSIONS.ANGLE_instanced_arrays,en=E.mat4(),rn=E.vec3([1,1,1]),sn=E.vec3([0,0,0]),on=E.vec3([0,0,0]),an=E.identityQuaternion(),nn=function(t){function e(e,i){var r=this;void 0===i&&(i={}),t.call(this,e,i),this._maxGeometryBatchSize=i.maxGeometryBatchSize,this._aabb=E.collapseAABB3(),this._aabbDirty=!1,this._layerList=[],this._nodeList=[],this._lastRTCCenter=null,this._lastDecodeMatrix=null,this._lastNormals=null,this._instancingLayers={},this._currentBatchingLayers={},this._scratchMemory=(mr++,gr),this._meshes={},this._nodes={},this.renderFlags=new Ni,this.numGeometries=0,this.numPortions=0,this.numVisibleLayerPortions=0,this.numTransparentLayerPortions=0,this.numXRayedLayerPortions=0,this.numHighlightedLayerPortions=0,this.numSelectedLayerPortions=0,this.numEdgesLayerPortions=0,this.numPickableLayerPortions=0,this.numClippableLayerPortions=0,this.numCulledLayerPortions=0,this.numEntities=0,this._numTriangles=0,this._numLines=0,this._numPoints=0,this._edgeThreshold=i.edgeThreshold||10,this.visible=i.visible,this.culled=i.culled,this.pickable=i.pickable,this.clippable=i.clippable,this.collidable=i.collidable,this.castsShadow=i.castsShadow,this.receivesShadow=i.receivesShadow,this.xrayed=i.xrayed,this.highlighted=i.highlighted,this.selected=i.selected,this.edges=i.edges,this.colorize=i.colorize,this.opacity=i.opacity,this.backfaces=i.backfaces,this._position=new Float32Array(i.position||[0,0,0]),this._rotation=new Float32Array(i.rotation||[0,0,0]),this._quaternion=new Float32Array(i.quaternion||[0,0,0,1]),i.rotation&&E.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._scale=new Float32Array(i.scale||[1,1,1]),this._worldMatrix=E.mat4(),E.composeMat4(this._position,this._quaternion,this._scale,this._worldMatrix),this._worldNormalMatrix=E.mat4(),E.inverseMat4(this._worldMatrix,this._worldNormalMatrix),E.transposeMat4(this._worldNormalMatrix),(i.matrix||i.position||i.rotation||i.scale||i.quaternion)&&(this._viewMatrix=E.mat4(),this._viewNormalMatrix=E.mat4(),this._viewMatrixDirty=!0,this._worldMatrixNonIdentity=!0),this._opacity=1,this._colorize=[1,1,1],this._saoEnabled=!1!==i.saoEnabled,this._pbrEnabled=!!i.pbrEnabled,this._isModel=i.isModel,this._isModel&&this.scene._registerModel(this),this._onCameraViewMatrix=this.scene.camera.on("matrix",(function(){r._viewMatrixDirty=!0}))}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={isPerformanceModel:{configurable:!0},position:{configurable:!0},rotation:{configurable:!0},quaternion:{configurable:!0},scale:{configurable:!0},matrix:{configurable:!0},worldMatrix:{configurable:!0},worldNormalMatrix:{configurable:!0},viewMatrix:{configurable:!0},viewNormalMatrix:{configurable:!0},backfaces:{configurable:!0},entityList:{configurable:!0},isEntity:{configurable:!0},isModel:{configurable:!0},isObject:{configurable:!0},aabb:{configurable:!0},numTriangles:{configurable:!0},numLines:{configurable:!0},numPoints:{configurable:!0},visible:{configurable:!0},xrayed:{configurable:!0},highlighted:{configurable:!0},selected:{configurable:!0},edges:{configurable:!0},culled:{configurable:!0},clippable:{configurable:!0},collidable:{configurable:!0},pickable:{configurable:!0},colorize:{configurable:!0},opacity:{configurable:!0},castsShadow:{configurable:!0},receivesShadow:{configurable:!0},saoEnabled:{configurable:!0},pbrEnabled:{configurable:!0},isDrawable:{configurable:!0},isStateSortable:{configurable:!0},xrayMaterial:{configurable:!0},highlightMaterial:{configurable:!0},selectedMaterial:{configurable:!0},edgeMaterial:{configurable:!0}};return i.isPerformanceModel.get=function(){return!0},i.position.get=function(){return this._position},i.rotation.get=function(){return this._rotation},i.quaternion.get=function(){return this._quaternion},i.scale.get=function(){return this._scale},i.matrix.get=function(){return this._worldMatrix},i.worldMatrix.get=function(){return this._worldMatrix},i.worldNormalMatrix.get=function(){return this._worldNormalMatrix},i.viewMatrix.get=function(){return this._viewMatrix?(this._viewMatrixDirty&&(E.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),E.inverseMat4(this._viewMatrix,this._viewNormalMatrix),E.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewMatrix):this.scene.camera.viewMatrix},e.prototype.getPickViewMatrix=function(t){return this._viewMatrix?this._viewMatrix:t},i.viewNormalMatrix.get=function(){return this._viewNormalMatrix?(this._viewMatrixDirty&&(E.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),E.inverseMat4(this._viewMatrix,this._viewNormalMatrix),E.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix},e.prototype.createGeometry=function(t){if(tn){var e=t.id;if(null!=e)if(this._instancingLayers[e])this.error("Geometry already created: "+e);else{var i,r=t.primitive;if(null!=r){switch(r){case"triangles":case"solid":i=new Ro(this,B.apply({layerIndex:0,solid:!0},t)),this._numTriangles+=t.indices?Math.round(t.indices.length/3):0;break;case"surface":i=new Ro(this,B.apply({layerIndex:0,solid:!1},t)),this._numTriangles+=t.indices?Math.round(t.indices.length/3):0;break;case"lines":i=new na(this,B.apply({layerIndex:0},t)),this._numLines+=t.indices?Math.round(t.indices.length/2):0;break;case"points":i=new $a(this,B.apply({layerIndex:0},t)),this._numPoints+=t.positions?Math.round(t.positions.length/3):0}this._instancingLayers[e]=i,this._layerList.push(i),this.numGeometries++}else this.error("Config missing: primitive")}else this.error("Config missing: id")}else this.error("WebGL instanced arrays not supported")},e.prototype.createMesh=function(t){var e=this,i=t.id;if(null!=i)if(this._meshes[i])this.error("PerformanceModel already has a Mesh with this ID: "+i);else{var r,s,o=t.geometryId,a=void 0!==o;if(a){if(!tn)return void this.error("WebGL instanced arrays not supported");if(!this._instancingLayers[o])return void this.error("Geometry not found: "+o+" - ensure that you create it first with createGeometry()")}var n=t.color?new Uint8Array([Math.floor(255*t.color[0]),Math.floor(255*t.color[1]),Math.floor(255*t.color[2])]):[255,255,255],l=void 0!==t.opacity&&null!==t.opacity?Math.floor(255*t.opacity):255,h=void 0!==t.metallic&&null!==t.metallic?Math.floor(255*t.metallic):0,u=void 0!==t.roughness&&null!==t.roughness?Math.floor(255*t.roughness):255,c=new fr(this,i,n,l),p=c.pickId,d=new Uint8Array([255&p,p>>8&255,p>>16&255,p>>24&255]),f=E.collapseAABB3();if(a){var _,g=this._worldMatrixNonIdentity?this._worldMatrix:null;if(t.matrix)_=t.matrix;else{var m=t.scale||rn,v=t.position||sn,b=t.rotation||on;E.eulerToQuaternion(b,"XYZ",an),_=E.composeMat4(v,an,m,en)}var y=this._instancingLayers[o];r=y,s=y.createPortion({color:n,metallic:h,roughness:u,opacity:l,meshMatrix:_,worldMatrix:g,aabb:f,pickColor:d}),E.expandAABB3(this._aabb,f);var P=Math.round(y.numIndices/3);this._numTriangles+=P,c.numTriangles=P,c.rtcCenter=y.rtcCenter}else{var M=t.primitive||"triangles";"points"!==M&&"lines"!==M&&"triangles"!==M&&"solid"!==M&&"surface"!==M&&(this.error("Unsupported value for 'primitive': '"+M+"' - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'. Defaulting to 'triangles'."),M="triangles");var x=t.positions;if(!x)return this.error("Config missing: positions (no meshIds provided, so expecting geometry arrays instead)"),null;var w=t.indices,C=t.edgeIndices;if(!t.indices&&"triangles"===M)return this.error("Config missing for triangles primitive: indices (no meshIds provided, so expecting geometry arrays instead)"),null;var A=!1;if(t.rtcCenter&&(this._lastRTCCenter?E.compareVec3(this._lastRTCCenter,t.rtcCenter)||(A=!0,this._lastRTCCenter.set(t.rtcCenter)):(A=!0,this._lastRTCCenter=E.vec3(t.rtcCenter))),t.positionsDecodeMatrix&&(this._lastDecodeMatrix?E.compareMat4(this._lastDecodeMatrix,t.positionsDecodeMatrix)||(A=!0,this._lastDecodeMatrix.set(t.positionsDecodeMatrix)):(A=!0,this._lastDecodeMatrix=E.mat4(t.positionsDecodeMatrix))),A){for(var S in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(S)&&this._currentBatchingLayers[S].finalize();this._currentBatchingLayers={}}var D=!!t.normals&&t.normals.length>0;"triangles"!==M&&"solid"!==M&&"surface"!==M||(null!==this._lastNormals&&D!==this._lastNormals&&["triangles","solid","surface"].map((function(t){e._currentBatchingLayers[t]&&(e._currentBatchingLayers[t].finalize(),delete e._currentBatchingLayers[t])})),this._lastNormals=D);var L,B=this._worldMatrixNonIdentity?this._worldMatrix:null;if(!t.positionsDecodeMatrix)if(t.matrix)L=t.matrix;else{var R=t.scale||rn,T=t.position||sn,F=t.rotation||on;E.eulerToQuaternion(F,"XYZ",an),L=E.composeMat4(T,an,R,en)}switch(r=this._currentBatchingLayers[M],M){case"triangles":case"solid":case"surface":r&&(r.canCreatePortion(x.length,w.length)||(r.finalize(),delete this._currentBatchingLayers[M],r=null)),r||(r=new Ns(this,{layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:t.positionsDecodeMatrix,rtcCenter:t.rtcCenter,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:"solid"===M,autoNormals:!D}),this._layerList.push(r),this._currentBatchingLayers[M]=r),C||(C=Se(x,w,null,this._edgeThreshold)),s=r.createPortion({positions:x,normals:t.normals,indices:w,edgeIndices:C,color:n,metallic:h,roughness:u,colors:t.colors,colorsCompressed:t.colorsCompressed,opacity:l,meshMatrix:L,worldMatrix:B,worldAABB:f,pickColor:d});var N=Math.round(w.length/3);this._numTriangles+=N,c.numTriangles=N;break;case"lines":r&&(r.canCreatePortion(x.length,w.length)||(r.finalize(),delete this._currentBatchingLayers[M],r=null)),r||(r=new Yo(this,{layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:t.positionsDecodeMatrix,rtcCenter:t.rtcCenter,maxGeometryBatchSize:this._maxGeometryBatchSize}),this._layerList.push(r),this._currentBatchingLayers[M]=r),s=r.createPortion({positions:x,indices:w,color:n,colors:t.colors,colorsCompressed:t.colorsCompressed,opacity:l,meshMatrix:L,worldMatrix:B,worldAABB:f,pickColor:d}),this._numLines+=Math.round(w.length/2);break;case"points":r&&(r.canCreatePortion(x.length)||(r.finalize(),delete this._currentBatchingLayers[M],r=null)),r||(r=new La(this,{layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:t.positionsDecodeMatrix,rtcCenter:t.rtcCenter,maxGeometryBatchSize:this._maxGeometryBatchSize}),this._layerList.push(r),this._currentBatchingLayers[M]=r),s=r.createPortion({positions:x,color:n,colors:t.colors,colorsCompressed:t.colorsCompressed,opacity:l,meshMatrix:L,worldMatrix:B,worldAABB:f,pickColor:d}),this._numPoints+=Math.round(x.length/3)}E.expandAABB3(this._aabb,f),this.numGeometries++,c.rtcCenter=t.rtcCenter}c.parent=null,c._layer=r,c._portionId=s,c.aabb=f,this._meshes[i]=c}else this.error("Config missing: id")},e.prototype.createEntity=function(t){var e=t.id;void 0===e?e=E.createUUID():this.scene.components[e]&&(this.error("Scene already has a Component with this ID: "+e+" - will assign random ID"),e=E.createUUID());var i=t.meshIds;if(void 0!==i){for(var r=[],s=0,o=i.length;s<o;s++){var a=i[s],n=this._meshes[a];n?n.parent?this.error("Mesh with ID "+a+" already belongs to object with ID "+n.parent.id+" - ignoring this mesh"):r.push(n):this.error("Mesh with this ID not found: "+a+" - ignoring this mesh")}var l,h=0;if(this._visible&&!1!==t.visible&&(h|=G),this._pickable&&!1!==t.pickable&&(h|=W),this._culled&&!1!==t.culled&&(h|=X),this._clippable&&!1!==t.clippable&&(h|=H),this._collidable&&!1!==t.collidable&&(h|=Y),this._edges&&!1!==t.edges&&(h|=Q),this._xrayed&&!1!==t.xrayed&&(h|=K),this._highlighted&&!1!==t.highlighted&&(h|=q),this._selected&&!1!==t.selected&&(h|=Z),1===r.length)l=r[0].aabb;else{l=E.collapseAABB3();for(var u=0,c=r.length;u<c;u++)E.expandAABB3(l,r[u].aabb)}var p=new tt(this,t.isObject,e,r,h,l);return this._nodeList.push(p),this._nodes[e]=p,this.numEntities++,p}this.error("Config missing: meshIds")},e.prototype.finalize=function(){if(!this.destroyed){for(var t in this._instancingLayers)this._instancingLayers.hasOwnProperty(t)&&this._instancingLayers[t].finalize();for(var e in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(e)&&this._currentBatchingLayers[e].finalize();this._currentBatchingLayers={};for(var i=0,r=this._nodeList.length;i<r;i++){this._nodeList[i]._finalize()}this._layerList.sort((function(t,e){return t.sortId<e.sortId?-1:t.sortId>e.sortId?1:0}));for(var s=0,o=this._layerList.length;s<o;s++){this._layerList[s].layerIndex=s}this.glRedraw(),this.scene._aabbDirty=!0}},i.backfaces.set=function(t){t=!!t,this._backfaces=t,this.glRedraw()},i.backfaces.get=function(){return this._backfaces},i.entityList.get=function(){return this._nodeList},i.isEntity.get=function(){return!0},i.isModel.get=function(){return this._isModel},i.isObject.get=function(){return!1},i.aabb.get=function(){return this._aabbDirty&&this._rebuildAABB(),this._aabb},e.prototype._rebuildAABB=function(){E.collapseAABB3(this._aabb);for(var t=0,e=this._nodeList.length;t<e;t++){var i=this._nodeList[t];E.expandAABB3(this._aabb,i.aabb)}this._aabbDirty=!1},i.numTriangles.get=function(){return this._numTriangles},i.numLines.get=function(){return this._numLines},i.numPoints.get=function(){return this._numPoints},i.visible.set=function(t){t=!1!==t,this._visible=t;for(var e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].visible=t;this.glRedraw()},i.visible.get=function(){return this.numVisibleLayerPortions>0},i.xrayed.set=function(t){t=!!t,this._xrayed=t;for(var e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].xrayed=t;this.glRedraw()},i.xrayed.get=function(){return this.numXRayedLayerPortions>0},i.highlighted.set=function(t){t=!!t,this._highlighted=t;for(var e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].highlighted=t;this.glRedraw()},i.highlighted.get=function(){return this.numHighlightedLayerPortions>0},i.selected.set=function(t){t=!!t,this._selected=t;for(var e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].selected=t;this.glRedraw()},i.selected.get=function(){return this.numSelectedLayerPortions>0},i.edges.set=function(t){t=!!t,this._edges=t;for(var e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].edges=t;this.glRedraw()},i.edges.get=function(){return this.numEdgesLayerPortions>0},i.culled.set=function(t){t=!!t,this._culled=t;for(var e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].culled=t;this.glRedraw()},i.culled.get=function(){return this._culled},i.clippable.set=function(t){t=!1!==t,this._clippable=t;for(var e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].clippable=t;this.glRedraw()},i.clippable.get=function(){return this._clippable},i.collidable.set=function(t){t=!1!==t,this._collidable=t;for(var e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].collidable=t},i.collidable.get=function(){return this._collidable},i.pickable.set=function(t){t=!1!==t,this._pickable=t;for(var e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].pickable=t},i.pickable.get=function(){return this.numPickableLayerPortions>0},i.colorize.set=function(t){this._colorize=t;for(var e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].colorize=t},i.colorize.get=function(){return this._colorize},i.opacity.set=function(t){this._opacity=t;for(var e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].opacity=t},i.opacity.get=function(){return this._opacity},i.castsShadow.set=function(t){(t=!1!==t)!==this._castsShadow&&(this._castsShadow=t,this.glRedraw())},i.castsShadow.get=function(){return this._castsShadow},i.receivesShadow.set=function(t){(t=!1!==t)!==this._receivesShadow&&(this._receivesShadow=t,this.glRedraw())},i.receivesShadow.get=function(){return this._receivesShadow},i.saoEnabled.get=function(){return this._saoEnabled},i.pbrEnabled.get=function(){return this._pbrEnabled},i.isDrawable.get=function(){return!0},i.isStateSortable.get=function(){return!1},e.prototype.stateSortCompare=function(t,e){},e.prototype.rebuildRenderFlags=function(){this.renderFlags.reset(),this._updateRenderFlagsVisibleLayers(),this.renderFlags.numLayers>0&&0===this.renderFlags.numVisibleLayers?this.renderFlags.culled=!0:this._updateRenderFlags()},e.prototype._updateRenderFlagsVisibleLayers=function(){var t=this.renderFlags;t.numLayers=this._layerList.length,t.numVisibleLayers=0;for(var e=0,i=this._layerList.length;e<i;e++){var r=this._layerList[e];this._getActiveSectionPlanesForLayer(r)&&(t.visibleLayers[t.numVisibleLayers++]=e)}},e.prototype._getActiveSectionPlanesForLayer=function(t){var e=this.renderFlags,i=this.scene._sectionPlanesState.sectionPlanes,r=i.length,s=t.layerIndex*r;if(r>0)for(var o=0;o<r;o++){i[o].active?(e.sectionPlanesActivePerLayer[s+o]=!0,e.sectioned=!0):e.sectionPlanesActivePerLayer[s+o]=!1}return!0},e.prototype._updateRenderFlags=function(){if(0!==this.numVisibleLayerPortions&&this.numCulledLayerPortions!==this.numPortions){var t=this.renderFlags;if(t.colorOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(t.colorTransparent=!0),this.numXRayedLayerPortions>0){var e=this.scene.xrayMaterial._state;e.fill&&(e.fillAlpha<1?t.xrayedSilhouetteTransparent=!0:t.xrayedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.xrayedEdgesTransparent=!0:t.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0)this.scene.edgeMaterial._state.edges&&(t.edgesOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(t.edgesTransparent=!0));if(this.numSelectedLayerPortions>0){var i=this.scene.selectedMaterial._state;i.fill&&(i.fillAlpha<1?t.selectedSilhouetteTransparent=!0:t.selectedSilhouetteOpaque=!0),i.edges&&(i.edgeAlpha<1?t.selectedEdgesTransparent=!0:t.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){var r=this.scene.highlightMaterial._state;r.fill&&(r.fillAlpha<1?t.highlightedSilhouetteTransparent=!0:t.highlightedSilhouetteOpaque=!0),r.edges&&(r.edgeAlpha<1?t.highlightedEdgesTransparent=!0:t.highlightedEdgesOpaque=!0)}}},i.xrayMaterial.get=function(){return this.scene.xrayMaterial},i.highlightMaterial.get=function(){return this.scene.highlightMaterial},i.selectedMaterial.get=function(){return this.scene.selectedMaterial},i.edgeMaterial.get=function(){return this.scene.edgeMaterial},e.prototype.drawColorOpaque=function(t){for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawColorOpaque(e,t)}},e.prototype.drawColorTransparent=function(t){for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawColorTransparent(e,t)}},e.prototype.drawDepth=function(t){for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawDepth(e,t)}},e.prototype.drawNormals=function(t){for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawNormals(e,t)}},e.prototype.drawSilhouetteXRayed=function(t){for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawSilhouetteXRayed(e,t)}},e.prototype.drawSilhouetteHighlighted=function(t){for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawSilhouetteHighlighted(e,t)}},e.prototype.drawSilhouetteSelected=function(t){for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawSilhouetteSelected(e,t)}},e.prototype.drawEdgesColorOpaque=function(t){for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawEdgesColorOpaque(e,t)}},e.prototype.drawEdgesColorTransparent=function(t){for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawEdgesColorTransparent(e,t)}},e.prototype.drawEdgesXRayed=function(t){for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawEdgesXRayed(e,t)}},e.prototype.drawEdgesHighlighted=function(t){for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawEdgesHighlighted(e,t)}},e.prototype.drawEdgesSelected=function(t){for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawEdgesSelected(e,t)}},e.prototype.drawOcclusion=function(t){if(0!==this.numVisibleLayerPortions)for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawOcclusion(e,t)}},e.prototype.drawShadow=function(t){if(0!==this.numVisibleLayerPortions)for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawShadow(e,t)}},e.prototype.drawPickMesh=function(t){if(0!==this.numVisibleLayerPortions)for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawPickMesh(e,t)}},e.prototype.drawPickDepths=function(t){if(0!==this.numVisibleLayerPortions)for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawPickDepths(e,t)}},e.prototype.drawPickNormals=function(t){if(0!==this.numVisibleLayerPortions)for(var e=this.renderFlags,i=0,r=e.visibleLayers.length;i<r;i++){var s=e.visibleLayers[i];this._layerList[s].drawPickNormals(e,t)}},e.prototype.destroy=function(){for(var e in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(e)&&this._currentBatchingLayers[e].destroy();this._currentBatchingLayers={},this.scene.camera.off(this._onCameraViewMatrix);for(var i=0,r=this._layerList.length;i<r;i++)this._layerList[i].destroy();for(var s=0,o=this._nodeList.length;s<o;s++)this._nodeList[s]._destroy();this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this),0!==mr&&0==--mr&&gr._clear(),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(U),ln=E.vec4(4),hn=E.vec4(),un=E.vec4(),cn=E.vec3([1,0,0]),pn=E.vec3([0,1,0]),dn=E.vec3([0,0,1]),fn=E.vec3(3),_n=E.vec3(3),gn=E.identityMat4(),mn=function(t){function e(e,i){if(void 0===i&&(i={}),t.call(this,e,i),this._parentNode=null,this._children=[],this._aabb=null,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._numTriangles=0,this._scale=E.vec3(),this._quaternion=E.identityQuaternion(),this._rotation=E.vec3(),this._position=E.vec3(),this._offset=E.vec3(),this._localMatrix=E.identityMat4(),this._worldMatrix=E.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,i.matrix?this.matrix=i.matrix:(this.scale=i.scale,this.position=i.position,i.quaternion||(this.rotation=i.rotation)),this._isModel=i.isModel,this._isModel&&this.scene._registerModel(this),this._isObject=i.isObject,this._isObject&&this.scene._registerObject(this),this.rtcCenter=i.rtcCenter,this.visible=i.visible,this.culled=i.culled,this.pickable=i.pickable,this.clippable=i.clippable,this.collidable=i.collidable,this.castsShadow=i.castsShadow,this.receivesShadow=i.receivesShadow,this.xrayed=i.xrayed,this.highlighted=i.highlighted,this.selected=i.selected,this.edges=i.edges,this.colorize=i.colorize,this.opacity=i.opacity,this.offset=i.offset,i.children)for(var r=i.children,s=0,o=r.length;s<o;s++)this.addChild(r[s],i.inheritStates);if(i.parentId){var a=this.scene.components[i.parentId];a?a.isNode?a.addChild(this):this.error("Parent is not a Node: '"+i.parentId+"'"):this.error("Parent not found: '"+i.parentId+"'")}else i.parent&&(i.parent.isNode||this.error("Parent is not a Node"),i.parent.addChild(this))}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={isEntity:{configurable:!0},isModel:{configurable:!0},isObject:{configurable:!0},aabb:{configurable:!0},rtcCenter:{configurable:!0},numTriangles:{configurable:!0},visible:{configurable:!0},xrayed:{configurable:!0},highlighted:{configurable:!0},selected:{configurable:!0},edges:{configurable:!0},culled:{configurable:!0},clippable:{configurable:!0},collidable:{configurable:!0},pickable:{configurable:!0},colorize:{configurable:!0},opacity:{configurable:!0},castsShadow:{configurable:!0},receivesShadow:{configurable:!0},saoEnabled:{configurable:!0},offset:{configurable:!0},isNode:{configurable:!0},numChildren:{configurable:!0},children:{configurable:!0},parent:{configurable:!0},position:{configurable:!0},rotation:{configurable:!0},quaternion:{configurable:!0},scale:{configurable:!0},matrix:{configurable:!0},worldMatrix:{configurable:!0},type:{configurable:!0}};return i.isEntity.get=function(){return!0},i.isModel.get=function(){return this._isModel},i.isObject.get=function(){return this._isObject},i.aabb.get=function(){return this._aabbDirty&&this._updateAABB(),this._aabb},i.rtcCenter.set=function(t){t?(this._rtcCenter||(this._rtcCenter=E.vec3()),this._rtcCenter.set(t)):this._rtcCenter&&(this._rtcCenter=null);for(var e=0,i=this._children.length;e<i;e++)this._children[e].rtcCenter=t},i.rtcCenter.get=function(){return this._rtcCenter},i.numTriangles.get=function(){return this._numTriangles},i.visible.set=function(t){t=!1!==t,this._visible=t;for(var e=0,i=this._children.length;e<i;e++)this._children[e].visible=t;this._isObject&&this.scene._objectVisibilityUpdated(this,t)},i.visible.get=function(){return this._visible},i.xrayed.set=function(t){t=!!t,this._xrayed=t;for(var e=0,i=this._children.length;e<i;e++)this._children[e].xrayed=t;this._isObject&&this.scene._objectXRayedUpdated(this,t)},i.xrayed.get=function(){return this._xrayed},i.highlighted.set=function(t){t=!!t,this._highlighted=t;for(var e=0,i=this._children.length;e<i;e++)this._children[e].highlighted=t;this._isObject&&this.scene._objectHighlightedUpdated(this,t)},i.highlighted.get=function(){return this._highlighted},i.selected.set=function(t){t=!!t,this._selected=t;for(var e=0,i=this._children.length;e<i;e++)this._children[e].selected=t;this._isObject&&this.scene._objectSelectedUpdated(this,t)},i.selected.get=function(){return this._selected},i.edges.set=function(t){t=!!t,this._edges=t;for(var e=0,i=this._children.length;e<i;e++)this._children[e].edges=t},i.edges.get=function(){return this._edges},i.culled.set=function(t){t=!!t,this._culled=t;for(var e=0,i=this._children.length;e<i;e++)this._children[e].culled=t},i.culled.get=function(){return this._culled},i.clippable.set=function(t){t=!1!==t,this._clippable=t;for(var e=0,i=this._children.length;e<i;e++)this._children[e].clippable=t},i.clippable.get=function(){return this._clippable},i.collidable.set=function(t){t=!1!==t,this._collidable=t;for(var e=0,i=this._children.length;e<i;e++)this._children[e].collidable=t},i.collidable.get=function(){return this._collidable},i.pickable.set=function(t){t=!1!==t,this._pickable=t;for(var e=0,i=this._children.length;e<i;e++)this._children[e].pickable=t},i.pickable.get=function(){return this._pickable},i.colorize.set=function(t){var e=this._colorize;e||((e=this._colorize=new Float32Array(4))[3]=1),t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1);for(var i=0,r=this._children.length;i<r;i++)this._children[i].colorize=e;if(this._isObject){var s=!!t;this.scene._objectColorizeUpdated(this,s)}},i.colorize.get=function(){return this._colorize.slice(0,3)},i.opacity.set=function(t){var e=this._colorize;e||((e=this._colorize=new Float32Array(4))[0]=1,e[1]=1,e[2]=1),e[3]=null!=t?t:1;for(var i=0,r=this._children.length;i<r;i++)this._children[i].opacity=t;if(this._isObject){var s=null!=t;this.scene._objectOpacityUpdated(this,s)}},i.opacity.get=function(){return this._colorize[3]},i.castsShadow.set=function(t){t=!!t,this._castsShadow=t;for(var e=0,i=this._children.length;e<i;e++)this._children[e].castsShadow=t},i.castsShadow.get=function(){return this._castsShadow},i.receivesShadow.set=function(t){t=!!t,this._receivesShadow=t;for(var e=0,i=this._children.length;e<i;e++)this._children[e].receivesShadow=t},i.receivesShadow.get=function(){return this._receivesShadow},i.saoEnabled.get=function(){return!1},i.offset.set=function(t){t?(this._offset[0]=t[0],this._offset[1]=t[1],this._offset[2]=t[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(var e=0,i=this._children.length;e<i;e++)this._children[e].offset=this._offset;this._isObject&&this.scene._objectOffsetUpdated(this,t)},i.offset.get=function(){return this._offset},i.isNode.get=function(){return!0},e.prototype._setLocalMatrixDirty=function(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()},e.prototype._setWorldMatrixDirty=function(){this._worldMatrixDirty=!0;for(var t=0,e=this._children.length;t<e;t++)this._children[t]._setWorldMatrixDirty()},e.prototype._buildWorldMatrix=function(){var t=this.matrix;if(this._parentNode)E.mulMat4(this._parentNode.worldMatrix,t,this._worldMatrix);else for(var e=0,i=t.length;e<i;e++)this._worldMatrix[e]=t[e];this._worldMatrixDirty=!1},e.prototype._setSubtreeAABBsDirty=function(t){if(t._aabbDirty=!0,t._children)for(var e=0,i=t._children.length;e<i;e++)this._setSubtreeAABBsDirty(t._children[e])},e.prototype._setAABBDirty=function(){if(this._setSubtreeAABBsDirty(this),this.collidable)for(var t=this;t;t=t._parentNode)t._aabbDirty=!0},e.prototype._updateAABB=function(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=E.AABB3()),this._buildAABB)this._buildAABB(this.worldMatrix,this._aabb);else{var t;E.collapseAABB3(this._aabb);for(var e=0,i=this._children.length;e<i;e++)(t=this._children[e]).collidable&&E.expandAABB3(this._aabb,t.aabb)}this._aabbDirty=!1},e.prototype.addChild=function(t,e){if(B.isNumeric(t)||B.isString(t)){var i=t;if(!(t=this.scene.component[i]))return void this.warn("Component not found: "+B.inQuotes(i));if(!t.isNode&&!t.isMesh)return void this.error("Not a Node or Mesh: "+i)}else{if(!t.isNode&&!t.isMesh)return void this.error("Not a Node or Mesh: "+t.id);if(t._parentNode){if(t._parentNode.id===this.id)return void this.warn("Already a child: "+t.id);t._parentNode.removeChild(t)}}if(t.id,t.scene.id===this.scene.id)return this._children.push(t),t._parentNode=this,e&&(t.visible=this.visible,t.culled=this.culled,t.xrayed=this.xrayed,t.highlited=this.highlighted,t.selected=this.selected,t.edges=this.edges,t.clippable=this.clippable,t.pickable=this.pickable,t.collidable=this.collidable,t.castsShadow=this.castsShadow,t.receivesShadow=this.receivesShadow,t.colorize=this.colorize,t.opacity=this.opacity,t.offset=this.offset),t._setWorldMatrixDirty(),t._setAABBDirty(),this._numTriangles+=t.numTriangles,t;this.error("Child not in same Scene: "+t.id)},e.prototype.removeChild=function(t){for(var e=0,i=this._children.length;e<i;e++)if(this._children[e].id===t.id)return t._parentNode=null,this._children=this._children.splice(e,1),t._setWorldMatrixDirty(),t._setAABBDirty(),this._setAABBDirty(),void(this._numTriangles-=t.numTriangles)},e.prototype.removeChildren=function(){for(var t,e=0,i=this._children.length;e<i;e++)(t=this._children[e])._parentNode=null,t._setWorldMatrixDirty(),t._setAABBDirty(),this._numTriangles-=t.numTriangles;this._children=[],this._setAABBDirty()},i.numChildren.get=function(){return this._children.length},i.children.get=function(){return this._children},i.parent.set=function(t){if(B.isNumeric(t)||B.isString(t)){var e=t;if(!(t=this.scene.components[e]))return void this.warn("Node not found: "+B.inQuotes(e));if(!t.isNode)return void this.error("Not a Node: "+t.id)}t.scene.id===this.scene.id?this._parentNode&&this._parentNode.id===t.id?this.warn("Already a child of Node: "+t.id):t.addChild(this):this.error("Node not in same Scene: "+t.id)},i.parent.get=function(){return this._parentNode},i.position.set=function(t){this._position.set(t||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()},i.position.get=function(){return this._position},i.rotation.set=function(t){this._rotation.set(t||[0,0,0]),E.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()},i.rotation.get=function(){return this._rotation},i.quaternion.set=function(t){this._quaternion.set(t||[0,0,0,1]),E.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()},i.quaternion.get=function(){return this._quaternion},i.scale.set=function(t){this._scale.set(t||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()},i.scale.get=function(){return this._scale},i.matrix.set=function(t){this._localMatrix||(this._localMatrix=E.identityMat4()),this._localMatrix.set(t||gn),E.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()},i.matrix.get=function(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=E.identityMat4()),E.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix},i.worldMatrix.get=function(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix},e.prototype.rotate=function(t,e){return ln[0]=t[0],ln[1]=t[1],ln[2]=t[2],ln[3]=e*E.DEGTORAD,E.angleAxisToQuaternion(ln,hn),E.mulQuaternions(this.quaternion,hn,un),this.quaternion=un,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this},e.prototype.rotateOnWorldAxis=function(t,e){return ln[0]=t[0],ln[1]=t[1],ln[2]=t[2],ln[3]=e*E.DEGTORAD,E.angleAxisToQuaternion(ln,hn),E.mulQuaternions(hn,this.quaternion,hn),this},e.prototype.rotateX=function(t){return this.rotate(cn,t)},e.prototype.rotateY=function(t){return this.rotate(pn,t)},e.prototype.rotateZ=function(t){return this.rotate(dn,t)},e.prototype.translate=function(t,e){return E.vec3ApplyQuaternion(this.quaternion,t,fn),E.mulVec3Scalar(fn,e,_n),E.addVec3(this.position,_n,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this},e.prototype.translateX=function(t){return this.translate(cn,t)},e.prototype.translateY=function(t){return this.translate(pn,t)},e.prototype.translateZ=function(t){return this.translate(dn,t)},i.type.get=function(){return"Node"},e.prototype.destroy=function(){if(t.prototype.destroy.call(this),this._parentNode&&this._parentNode.removeChild(this),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this._children.length)for(var e=this._children.splice(),i=0,r=e.length;i<r;i++)e[i].destroy();this._children=[],this._setAABBDirty(),this.scene._aabbDirty=!0},Object.defineProperties(e.prototype,i),e}(U),vn=S.memory,bn=wt.SUPPORTED_EXTENSIONS.OES_element_index_uint,yn=bn?Uint32Array:Uint16Array,Pn=E.AABB3(),Mn=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({compressGeometry:!0,primitive:null,primitiveName:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=i.edgeThreshold||10,this._aabb=null,this._obb=E.OBB3();var r=this._state,s=this.scene.canvas.gl;switch(i.primitive=i.primitive||"triangles",i.primitive){case"points":r.primitive=s.POINTS,r.primitiveName=i.primitive;break;case"lines":r.primitive=s.LINES,r.primitiveName=i.primitive;break;case"line-loop":r.primitive=s.LINE_LOOP,r.primitiveName=i.primitive;break;case"line-strip":r.primitive=s.LINE_STRIP,r.primitiveName=i.primitive;break;case"triangles":r.primitive=s.TRIANGLES,r.primitiveName=i.primitive;break;case"triangle-strip":r.primitive=s.TRIANGLE_STRIP,r.primitiveName=i.primitive;break;case"triangle-fan":r.primitive=s.TRIANGLE_FAN,r.primitiveName=i.primitive;break;default:this.error("Unsupported value for 'primitive': '"+i.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),r.primitive=s.TRIANGLES,r.primitiveName=i.primitive}if(i.positions)if(i.indices){var o;if(i.positionsDecodeMatrix);else{var a=Re.getPositionsBounds(i.positions),n=Re.compressPositions(i.positions,a.min,a.max);o=n.quantized,r.positionsDecodeMatrix=n.decodeMatrix,r.positionsBuf=new Ut(s,s.ARRAY_BUFFER,o,o.length,3,s.STATIC_DRAW),vn.positions+=r.positionsBuf.numItems,E.positions3ToAABB3(i.positions,this._aabb),E.positions3ToAABB3(o,Pn,r.positionsDecodeMatrix),E.AABB3ToOBB3(Pn,this._obb)}if(i.colors){var l=i.colors.constructor===Float32Array?i.colors:new Float32Array(i.colors);r.colorsBuf=new Ut(s,s.ARRAY_BUFFER,l,l.length,4,s.STATIC_DRAW),vn.colors+=r.colorsBuf.numItems}if(i.uv){var h=Re.getUVBounds(i.uv),u=Re.compressUVs(i.uv,h.min,h.max),c=u.quantized;r.uvDecodeMatrix=u.decodeMatrix,r.uvBuf=new Ut(s,s.ARRAY_BUFFER,c,c.length,2,s.STATIC_DRAW),vn.uvs+=r.uvBuf.numItems}if(i.normals){var p=Re.compressNormals(i.normals),d=r.compressGeometry;r.normalsBuf=new Ut(s,s.ARRAY_BUFFER,p,p.length,3,s.STATIC_DRAW,d),vn.normals+=r.normalsBuf.numItems}if(bn||i.indices.constructor!==Uint32Array){var f=i.indices.constructor===Uint32Array||i.indices.constructor===Uint16Array?i.indices:new yn(i.indices);r.indicesBuf=new Ut(s,s.ELEMENT_ARRAY_BUFFER,f,f.length,1,s.STATIC_DRAW),vn.indices+=r.indicesBuf.numItems;var _=Se(o,f,r.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new Ut(s,s.ELEMENT_ARRAY_BUFFER,_,_.length,1,s.STATIC_DRAW),"triangles"===this._state.primitiveName&&(this._numTriangles=i.indices.length/3),this._buildHash(),vn.meshes++}else this.error("This WebGL implementation does not support Uint32Array")}else this.error("Config expected: indices");else this.error("Config expected: positions")}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},isVBOGeometry:{configurable:!0},primitive:{configurable:!0},aabb:{configurable:!0},obb:{configurable:!0},numTriangles:{configurable:!0}};return i.type.get=function(){return"VBOGeometry"},i.isVBOGeometry.get=function(){return!0},e.prototype._buildHash=function(){var t=this._state,e=["/g"];e.push("/"+t.primitive+";"),t.positionsBuf&&e.push("p"),t.colorsBuf&&e.push("c"),(t.normalsBuf||t.autoVertexNormals)&&e.push("n"),t.uvBuf&&e.push("u"),e.push("cp"),e.push(";"),t.hash=e.join("")},e.prototype._getEdgeIndices=function(){return this._edgeIndicesBuf},i.primitive.get=function(){return this._state.primitiveName},i.aabb.get=function(){return this._aabb},i.obb.get=function(){return this._obb},i.numTriangles.get=function(){return this._numTriangles},e.prototype._getState=function(){return this._state},e.prototype.destroy=function(){t.prototype.destroy.call(this);var e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),e.destroy(),vn.meshes--},Object.defineProperties(e.prototype,i),e}(Ae),xn={opaque:0,mask:1,blend:2},wn=["opaque","mask","blend"],En=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({type:"MetallicMaterial",baseColor:E.vec4([1,1,1]),emissive:E.vec4([0,0,0]),metallic:null,roughness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.baseColor=i.baseColor,this.metallic=i.metallic,this.roughness=i.roughness,this.specularF0=i.specularF0,this.emissive=i.emissive,this.alpha=i.alpha,i.baseColorMap&&(this._baseColorMap=this._checkComponent("Texture",i.baseColorMap)),i.metallicMap&&(this._metallicMap=this._checkComponent("Texture",i.metallicMap)),i.roughnessMap&&(this._roughnessMap=this._checkComponent("Texture",i.roughnessMap)),i.metallicRoughnessMap&&(this._metallicRoughnessMap=this._checkComponent("Texture",i.metallicRoughnessMap)),i.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",i.emissiveMap)),i.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",i.occlusionMap)),i.alphaMap&&(this._alphaMap=this._checkComponent("Texture",i.alphaMap)),i.normalMap&&(this._normalMap=this._checkComponent("Texture",i.normalMap)),this.alphaMode=i.alphaMode,this.alphaCutoff=i.alphaCutoff,this.backfaces=i.backfaces,this.frontface=i.frontface,this.lineWidth=i.lineWidth,this.pointSize=i.pointSize,this._makeHash()}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},baseColor:{configurable:!0},baseColorMap:{configurable:!0},metallic:{configurable:!0},metallicMap:{configurable:!0},roughness:{configurable:!0},roughnessMap:{configurable:!0},metallicRoughnessMap:{configurable:!0},specularF0:{configurable:!0},emissive:{configurable:!0},emissiveMap:{configurable:!0},occlusionMap:{configurable:!0},alpha:{configurable:!0},alphaMap:{configurable:!0},normalMap:{configurable:!0},alphaMode:{configurable:!0},alphaCutoff:{configurable:!0},backfaces:{configurable:!0},frontface:{configurable:!0},lineWidth:{configurable:!0},pointSize:{configurable:!0}};return i.type.get=function(){return"MetallicMaterial"},e.prototype._makeHash=function(){var t=this._state,e=["/met"];this._baseColorMap&&(e.push("/bm"),this._baseColorMap._state.hasMatrix&&e.push("/mat"),e.push("/"+this._baseColorMap._state.encoding)),this._metallicMap&&(e.push("/mm"),this._metallicMap._state.hasMatrix&&e.push("/mat")),this._roughnessMap&&(e.push("/rm"),this._roughnessMap._state.hasMatrix&&e.push("/mat")),this._metallicRoughnessMap&&(e.push("/mrm"),this._metallicRoughnessMap._state.hasMatrix&&e.push("/mat")),this._emissiveMap&&(e.push("/em"),this._emissiveMap._state.hasMatrix&&e.push("/mat")),this._occlusionMap&&(e.push("/ocm"),this._occlusionMap._state.hasMatrix&&e.push("/mat")),this._alphaMap&&(e.push("/am"),this._alphaMap._state.hasMatrix&&e.push("/mat")),this._normalMap&&(e.push("/nm"),this._normalMap._state.hasMatrix&&e.push("/mat")),e.push(";"),t.hash=e.join("")},i.baseColor.set=function(t){var e=this._state.baseColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.baseColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()},i.baseColor.get=function(){return this._state.baseColor},i.baseColorMap.get=function(){return this._baseColorMap},i.metallic.set=function(t){t=null!=t?t:1,this._state.metallic!==t&&(this._state.metallic=t,this.glRedraw())},i.metallic.get=function(){return this._state.metallic},i.metallicMap.get=function(){return this._attached.metallicMap},i.roughness.set=function(t){t=null!=t?t:1,this._state.roughness!==t&&(this._state.roughness=t,this.glRedraw())},i.roughness.get=function(){return this._state.roughness},i.roughnessMap.get=function(){return this._attached.roughnessMap},i.metallicRoughnessMap.get=function(){return this._attached.metallicRoughnessMap},i.specularF0.set=function(t){t=null!=t?t:0,this._state.specularF0!==t&&(this._state.specularF0=t,this.glRedraw())},i.specularF0.get=function(){return this._state.specularF0},i.emissive.set=function(t){var e=this._state.emissive;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.emissive=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=0,e[1]=0,e[2]=0),this.glRedraw()},i.emissive.get=function(){return this._state.emissive},i.emissiveMap.get=function(){return this._attached.emissiveMap},i.occlusionMap.get=function(){return this._attached.occlusionMap},i.alpha.set=function(t){t=null!=t?t:1,this._state.alpha!==t&&(this._state.alpha=t,this.glRedraw())},i.alpha.get=function(){return this._state.alpha},i.alphaMap.get=function(){return this._attached.alphaMap},i.normalMap.get=function(){return this._attached.normalMap},i.alphaMode.set=function(t){var e=xn[t=t||"opaque"];void 0===e&&(this.error("Unsupported value for 'alphaMode': "+t+" defaulting to 'opaque'"),e="opaque"),this._state.alphaMode!==e&&(this._state.alphaMode=e,this.glRedraw())},i.alphaMode.get=function(){return wn[this._state.alphaMode]},i.alphaCutoff.set=function(t){null==t&&(t=.5),this._state.alphaCutoff!==t&&(this._state.alphaCutoff=t)},i.alphaCutoff.get=function(){return this._state.alphaCutoff},i.backfaces.set=function(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())},i.backfaces.get=function(){return this._state.backfaces},i.frontface.set=function(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this.glRedraw())},i.frontface.get=function(){return this._state.frontface?"ccw":"cw"},i.lineWidth.set=function(t){this._state.lineWidth=t||1,this.glRedraw()},i.lineWidth.get=function(){return this._state.lineWidth},i.pointSize.set=function(t){this._state.pointSize=t||1,this.glRedraw()},i.pointSize.get=function(){return this._state.pointSize},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy()},Object.defineProperties(e.prototype,i),e}(Ve),Cn={opaque:0,mask:1,blend:2},An=["opaque","mask","blend"],Sn=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({type:"SpecularMaterial",diffuse:E.vec3([1,1,1]),emissive:E.vec3([0,0,0]),specular:E.vec3([1,1,1]),glossiness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.diffuse=i.diffuse,this.specular=i.specular,this.glossiness=i.glossiness,this.specularF0=i.specularF0,this.emissive=i.emissive,this.alpha=i.alpha,i.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",i.diffuseMap)),i.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",i.emissiveMap)),i.specularMap&&(this._specularMap=this._checkComponent("Texture",i.specularMap)),i.glossinessMap&&(this._glossinessMap=this._checkComponent("Texture",i.glossinessMap)),i.specularGlossinessMap&&(this._specularGlossinessMap=this._checkComponent("Texture",i.specularGlossinessMap)),i.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",i.occlusionMap)),i.alphaMap&&(this._alphaMap=this._checkComponent("Texture",i.alphaMap)),i.normalMap&&(this._normalMap=this._checkComponent("Texture",i.normalMap)),this.alphaMode=i.alphaMode,this.alphaCutoff=i.alphaCutoff,this.backfaces=i.backfaces,this.frontface=i.frontface,this.lineWidth=i.lineWidth,this.pointSize=i.pointSize,this._makeHash()}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},diffuse:{configurable:!0},diffuseMap:{configurable:!0},specular:{configurable:!0},specularMap:{configurable:!0},specularGlossinessMap:{configurable:!0},glossiness:{configurable:!0},glossinessMap:{configurable:!0},specularF0:{configurable:!0},emissive:{configurable:!0},emissiveMap:{configurable:!0},alpha:{configurable:!0},alphaMap:{configurable:!0},normalMap:{configurable:!0},occlusionMap:{configurable:!0},alphaMode:{configurable:!0},alphaCutoff:{configurable:!0},backfaces:{configurable:!0},frontface:{configurable:!0},lineWidth:{configurable:!0},pointSize:{configurable:!0}};return i.type.get=function(){return"SpecularMaterial"},e.prototype._makeHash=function(){var t=this._state,e=["/spe"];this._diffuseMap&&(e.push("/dm"),this._diffuseMap.hasMatrix&&e.push("/mat"),e.push("/"+this._diffuseMap.encoding)),this._emissiveMap&&(e.push("/em"),this._emissiveMap.hasMatrix&&e.push("/mat")),this._glossinessMap&&(e.push("/gm"),this._glossinessMap.hasMatrix&&e.push("/mat")),this._specularMap&&(e.push("/sm"),this._specularMap.hasMatrix&&e.push("/mat")),this._specularGlossinessMap&&(e.push("/sgm"),this._specularGlossinessMap.hasMatrix&&e.push("/mat")),this._occlusionMap&&(e.push("/ocm"),this._occlusionMap.hasMatrix&&e.push("/mat")),this._normalMap&&(e.push("/nm"),this._normalMap.hasMatrix&&e.push("/mat")),this._alphaMap&&(e.push("/opm"),this._alphaMap.hasMatrix&&e.push("/mat")),e.push(";"),t.hash=e.join("")},i.diffuse.set=function(t){var e=this._state.diffuse;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.diffuse=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()},i.diffuse.get=function(){return this._state.diffuse},i.diffuseMap.get=function(){return this._diffuseMap},i.specular.set=function(t){var e=this._state.specular;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.specular=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()},i.specular.get=function(){return this._state.specular},i.specularMap.get=function(){return this._specularMap},i.specularGlossinessMap.get=function(){return this._specularGlossinessMap},i.glossiness.set=function(t){t=null!=t?t:1,this._state.glossiness!==t&&(this._state.glossiness=t,this.glRedraw())},i.glossiness.get=function(){return this._state.glossiness},i.glossinessMap.get=function(){return this._glossinessMap},i.specularF0.set=function(t){t=null!=t?t:0,this._state.specularF0!==t&&(this._state.specularF0=t,this.glRedraw())},i.specularF0.get=function(){return this._state.specularF0},i.emissive.set=function(t){var e=this._state.emissive;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.emissive=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=0,e[1]=0,e[2]=0),this.glRedraw()},i.emissive.get=function(){return this._state.emissive},i.emissiveMap.get=function(){return this._emissiveMap},i.alpha.set=function(t){t=null!=t?t:1,this._state.alpha!==t&&(this._state.alpha=t,this.glRedraw())},i.alpha.get=function(){return this._state.alpha},i.alphaMap.get=function(){return this._alphaMap},i.normalMap.get=function(){return this._normalMap},i.occlusionMap.get=function(){return this._occlusionMap},i.alphaMode.set=function(t){var e=Cn[t=t||"opaque"];void 0===e&&(this.error("Unsupported value for 'alphaMode': "+t+" defaulting to 'opaque'"),e="opaque"),this._state.alphaMode!==e&&(this._state.alphaMode=e,this.glRedraw())},i.alphaMode.get=function(){return An[this._state.alphaMode]},i.alphaCutoff.set=function(t){null==t&&(t=.5),this._state.alphaCutoff!==t&&(this._state.alphaCutoff=t)},i.alphaCutoff.get=function(){return this._state.alphaCutoff},i.backfaces.set=function(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())},i.backfaces.get=function(){return this._state.backfaces},i.frontface.set=function(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this.glRedraw())},i.frontface.get=function(){return this._state.frontface?"ccw":"cw"},i.lineWidth.set=function(t){this._state.lineWidth=t||1,this.glRedraw()},i.lineWidth.get=function(){return this._state.lineWidth},i.pointSize.set=function(t){this._state.pointSize=t||1,this.glRedraw()},i.pointSize.get=function(){return this._state.pointSize},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy()},Object.defineProperties(e.prototype,i),e}(Ve),Dn={funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"};function Ln(t,e,i){if(void 0===e)return i;var r=Dn[e];return void 0===r?i:t[r]}var Bn=new Uint8Array([0,0,0,1]),Rn=function(t,e){this.gl=t,this.target=e||t.TEXTURE_2D,this.texture=t.createTexture(),this.setPreloadColor([0,0,0,0]),this.allocated=!0};function Tn(t){if(!Fn(t.width)||!Fn(t.height)){var e=document.createElement("canvas");e.width=Nn(t.width),e.height=Nn(t.height),e.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e.width,e.height),t=e}return t}function Fn(t){return 0==(t&t-1)}function Nn(t){--t;for(var e=1;e<32;e<<=1)t|=t>>e;return t+1}Rn.prototype.setPreloadColor=function(t){t?(Bn[0]=Math.floor(255*t[0]),Bn[1]=Math.floor(255*t[1]),Bn[2]=Math.floor(255*t[2]),Bn[3]=Math.floor(255*(void 0!==t[3]?t[3]:1))):(Bn[0]=0,Bn[1]=0,Bn[2]=0,Bn[3]=255);var e=this.gl;if(e.bindTexture(this.target,this.texture),e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,e.NEAREST),this.target===e.TEXTURE_CUBE_MAP)for(var i=[e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z],r=0,s=i.length;r<s;r++)e.texImage2D(i[r],0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,Bn);else e.texImage2D(this.target,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,Bn);e.bindTexture(this.target,null)},Rn.prototype.setTarget=function(t){this.target=t||this.gl.TEXTURE_2D},Rn.prototype.setImage=function(t,e){var i=this.gl;if(i.bindTexture(this.target,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,e.flipY),this.target===i.TEXTURE_CUBE_MAP){if(B.isArray(t))for(var r=t,s=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z],o=0,a=s.length;o<a;o++)i.texImage2D(s[o],0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,r[o])}else i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t);i.bindTexture(this.target,null)},Rn.prototype.setProps=function(t){var e=this.gl;if(e.bindTexture(this.target,this.texture),t.minFilter){var i=Ln(e,t.minFilter);i&&(e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,i),i!==e.NEAREST_MIPMAP_NEAREST&&i!==e.LINEAR_MIPMAP_NEAREST&&i!==e.NEAREST_MIPMAP_LINEAR&&i!==e.LINEAR_MIPMAP_LINEAR||e.generateMipmap(this.target))}if(t.magFilter){var r=Ln(e,t.magFilter);r&&e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,r)}if(t.wrapS){var s=Ln(e,t.wrapS);s&&e.texParameteri(this.target,e.TEXTURE_WRAP_S,s)}if(t.wrapT){var o=Ln(e,t.wrapT);o&&e.texParameteri(this.target,e.TEXTURE_WRAP_T,o)}e.bindTexture(this.target,null)},Rn.prototype.bind=function(t){if(this.allocated){if(this.texture){var e=this.gl;return e.activeTexture(e["TEXTURE"+t]),e.bindTexture(this.target,this.texture),!0}return!1}},Rn.prototype.unbind=function(t){if(this.allocated&&this.texture){var e=this.gl;e.activeTexture(e["TEXTURE"+t]),e.bindTexture(this.target,null)}},Rn.prototype.destroy=function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)};var In=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({texture:new Rn(this.scene.canvas.gl),matrix:E.identityMat4(),hasMatrix:i.translate&&(0!==i.translate[0]||0!==i.translate[1])||!!i.rotate||i.scale&&(0!==i.scale[0]||0!==i.scale[1]),minFilter:this._checkMinFilter(i.minFilter),magFilter:this._checkMagFilter(i.magFilter),wrapS:this._checkWrapS(i.wrapS),wrapT:this._checkWrapT(i.wrapT),flipY:this._checkFlipY(i.flipY),encoding:this._checkEncoding(i.encoding)}),this._src=null,this._image=null,this._translate=E.vec2([0,0]),this._scale=E.vec2([1,1]),this._rotate=E.vec2([0,0]),this._matrixDirty=!1,this.translate=i.translate,this.scale=i.scale,this.rotate=i.rotate,i.src?this.src=i.src:i.image&&(this.image=i.image),S.memory.textures++}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},image:{configurable:!0},src:{configurable:!0},translate:{configurable:!0},scale:{configurable:!0},rotate:{configurable:!0},minFilter:{configurable:!0},magFilter:{configurable:!0},wrapS:{configurable:!0},wrapT:{configurable:!0},flipY:{configurable:!0},encoding:{configurable:!0}};return i.type.get=function(){return"Texture"},e.prototype._checkMinFilter=function(t){return"linear"!==(t=t||"linearMipmapLinear")&&"linearMipmapNearest"!==t&&"linearMipmapLinear"!==t&&"nearestMipmapLinear"!==t&&"nearestMipmapNearest"!==t&&(this.error("Unsupported value for 'minFilter': '"+t+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),t="linearMipmapLinear"),t},e.prototype._checkMagFilter=function(t){return"linear"!==(t=t||"linear")&&"nearest"!==t&&(this.error("Unsupported value for 'magFilter': '"+t+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),t="linear"),t},e.prototype._checkFilter=function(t){return"linear"!==(t=t||"linear")&&"nearest"!==t&&(this.error("Unsupported value for 'magFilter': '"+t+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),t="linear"),t},e.prototype._checkWrapS=function(t){return"clampToEdge"!==(t=t||"repeat")&&"mirroredRepeat"!==t&&"repeat"!==t&&(this.error("Unsupported value for 'wrapS': '"+t+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),t="repeat"),t},e.prototype._checkWrapT=function(t){return"clampToEdge"!==(t=t||"repeat")&&"mirroredRepeat"!==t&&"repeat"!==t&&(this.error("Unsupported value for 'wrapT': '"+t+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),t="repeat"),t},e.prototype._checkFlipY=function(t){return!!t},e.prototype._checkEncoding=function(t){return"linear"!==(t=t||"linear")&&"sRGB"!==t&&"gamma"!==t&&(this.error("Unsupported value for 'encoding': '"+t+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),t="linear"),t},e.prototype._webglContextRestored=function(){this._state.texture=new Rn(this.scene.canvas.gl),this._image?this.image=this._image:this._src&&(this.src=this._src)},e.prototype._update=function(){var t,e,i=this._state;this._matrixDirty&&(0===this._translate[0]&&0===this._translate[1]||(t=E.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(e=E.scalingMat4v([this._scale[0],this._scale[1],1]),t=t?E.mulMat4(t,e):e),0!==this._rotate&&(e=E.rotationMat4v(.0174532925*this._rotate,[0,0,1]),t=t?E.mulMat4(t,e):e),t&&(i.matrix=t),this._matrixDirty=!1);this.glRedraw()},i.image.set=function(t){this._image=Tn(t),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._state.texture.setProps(this._state),this._src=null,this.glRedraw()},i.image.get=function(){return this._image},i.src.set=function(t){this.scene.loading++,this.scene.canvas.spinner.processes++;var e=this,i=new Image;i.onload=function(){i=Tn(i),e._state.texture.setImage(i,e._state),e._state.texture.setProps(e._state),e.scene.loading--,e.glRedraw(),e.scene.canvas.spinner.processes--},i.src=t,this._src=t,this._image=null},i.src.get=function(){return this._src},i.translate.set=function(t){this._translate.set(t||[0,0]),this._matrixDirty=!0,this._needUpdate()},i.translate.get=function(){return this._translate},i.scale.set=function(t){this._scale.set(t||[1,1]),this._matrixDirty=!0,this._needUpdate()},i.scale.get=function(){return this._scale},i.rotate.set=function(t){t=t||0,this._rotate!==t&&(this._rotate=t,this._matrixDirty=!0,this._needUpdate())},i.rotate.get=function(){return this._rotate},i.minFilter.get=function(){return this._state.minFilter},i.magFilter.get=function(){return this._state.magFilter},i.wrapS.get=function(){return this._state.wrapS},i.wrapT.get=function(){return this._state.wrapT},i.flipY.get=function(){return this._state.flipY},i.encoding.get=function(){return this._state.encoding},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.texture&&this._state.texture.destroy(),this._state.destroy(),S.memory.textures--},Object.defineProperties(e.prototype,i),e}(U),kn=function(t){};kn.prototype.load=function(t,e,i,r,s,o){r=r||{};var a=e.scene.canvas.spinner;a.processes++,On(t,e,i,r,(function(){a.processes--,V.scheduleTask((function(){e.scene.fire("modelLoaded",e.id),e.fire("loaded",!0,!1)})),s&&s()}),(function(t){a.processes--,e.error(t),o&&o(t),e.fire("error",t)}))},kn.prototype.parse=function(t,e,i,r,s,o){r=r||{};var a=e.scene.canvas.spinner;a.processes++,Vn(t,i,"",r,e,(function(){a.processes--,e.scene.fire("modelLoaded",e.id),e.fire("loaded",!0,!1),s&&s()}),(function(t){a.processes--,e.error(t),e.fire("error",t),o&&o(t)}))};var On=function(t,e,i,r,s,o){t.dataSource.getGLTF(i,(function(a){r.basePath=function(t){var e=t.lastIndexOf("/");return 0!==e?t.substring(0,e+1):""}(i),Vn(t,a,i,r,e,s,o)}),o)},Vn=function(){var t={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},e={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};return function(t,e,u,c,p,d){p.clear();var f={src:u,loadBuffer:c.loadBuffer,basePath:c.basePath,prioritizeGLTFNode:c.prioritizeGLTFNode,handleGLTFNode:c.handleGLTFNode,ignoreMaterials:!!c.ignoreMaterials,edgeThreshold:c.edgeThreshold,readableGeometry:!!c.readableGeometry,json:e,scene:p.scene,plugin:t,modelNode:p,modelNodeProps:{visible:p.visible,culled:p.culled,xrayed:p.xrayed,highlighted:p.highlighted,selected:p.selected,outlined:p.outlined,clippable:p.clippable,pickable:p.pickable,collidable:p.collidable,castsShadow:p.castsShadow,receivesShadow:p.receivesShadow,colorize:p.colorize,opacity:p.opacity,edges:p.edges}};p.scene.loading++,function(t,e){var r=t.json.buffers;if(r)for(var s=r.length,o=0,a=r.length;o<a;o++)i(t,r[o],(function(){0==--s&&e()}),(function(i){t.plugin.error(i),0==--s&&e()}));else e()}(f,(function(){!function(t){var e=t.json.bufferViews;if(e)for(var i=0,s=e.length;i<s;i++)r(t,e[i])}(f),function(t){var e=t.json.accessors;if(e)for(var i=0,r=e.length;i<r;i++)s(t,e[i])}(f),function(t){var e=t.json.textures;if(e)for(var i=0,r=e.length;i<r;i++)o(t,e[i])}(f),function(t){var e,i,r=t.json.materials;if(r)for(var s=0,o=r.length;s<o;s++)i=a(t,e=r[s]),e._material=i}(f),function(t){var e=t.json.meshes;if(e)for(var i=0,r=e.length;i<r;i++)n(t,e[i])}(f),function(t){var e=t.json,i=e.scene||0,r=e.scenes[i];if(!r)return void h(t,"glTF has no default scene");!function(t,e){var i=e.nodes;if(!i)return;for(var r,s=t.json,o=0,a=i.length;o<a;o++)(r=s.nodes[i[o]])?l(t,r,null,null):h(t,"Node not found: "+o)}(t,r)}(f),p.scene.loading--,d()}))};function i(t,e,i,r){var s=e.uri;s?t.plugin.dataSource.getArrayBuffer(t.src,s,(function(t){e._buffer=t,i()}),r):r("gltf/handleBuffer missing uri in "+JSON.stringify(e))}function r(t,e){var i=t.json.buffers[e.buffer];e._typedArray=null;var r=e.byteLength||0,s=e.byteOffset||0;e._buffer=i._buffer.slice(s,s+r)}function s(i,r){var s=i.json.bufferViews[r.bufferView],o=e[r.type],a=t[r.componentType],n=a.BYTES_PER_ELEMENT*o;r.byteStride&&r.byteStride!==n||(r._typedArray=new a(s._buffer,r.byteOffset||0,r.count*o),r._itemSize=o)}function o(t,e){e._texture=new In(t.modelNode,{src:t.json.images[e.source].uri?t.basePath+t.json.images[e.source].uri:void 0,flipY:!!e.flipY,encoding:"sRGB"})}function a(t,e){var i,r=t.json,s={},o=e.normalTexture;o&&(i=r.textures[o.index])&&(s.normalMap=i._texture);var a=e.occlusionTexture;a&&(i=r.textures[a.index])&&(s.occlusionMap=i._texture);var n=e.emissiveTexture;n&&(i=r.textures[n.index])&&(s.emissiveMap=i._texture);var l=e.emissiveFactor;switch(l&&(s.emissive=l),s.backfaces=!!e.doubleSided,e.alphaMode){case"NORMAL_OPAQUE":s.alphaMode="opaque";break;case"MASK":s.alphaMode="mask";break;case"BLEND":s.alphaMode="blend"}var h=e.alphaCutoff;void 0!==h&&(s.alphaCutoff=h);var u=e.extensions;if(u){var c=u.KHR_materials_pbrSpecularGlossiness;if(c){var p=c.diffuseFactor;null!=p&&(s.diffuse=p.slice(0,3),s.alpha=p[3]);var d=c.diffuseTexture;d&&(i=r.textures[d.index])&&(s.diffuseMap=i._texture);var f=c.specularFactor;null!=f&&(s.specular=f.slice(0,3));var _=c.glossinessFactor;null!=_&&(s.glossiness=_);var g=c.specularGlossinessTexture;return g&&(i=r.textures[g.index])&&(s.specularGlossinessMap=i._texture),new Sn(t.modelNode,s)}var m=u.KHR_materials_common;if(m){var v,b=m.technique,y=m.values||{},P="BLINN"===b,M="PHONG"===b,x="LAMBERT"===b,w=y.shininess;s.shininess=(P||M)&&null!=w?w:0;var E=y.diffuse;E&&(P||M||x)?B.isString(E)?(v=t.textures[E])&&(s.diffuseMap=v):s.diffuse=E.slice(0,3):s.diffuse=[0,0,0];var C=y.specular;C&&(P||M)?B.isString(C)?(v=t.textures[C])&&(s.specularMap=v):s.specular=C.slice(0,3):s.specular=[0,0,0];var A=y.emission;A?B.isString(A)?(v=t.textures[A])&&(s.emissiveMap=v):s.emissive=A.slice(0,3):s.emissive=[0,0,0];var S=y.transparency;return s.alpha=null!=S?S:1,y.transparent,new je(t.scene,s)}}var D=e.pbrMetallicRoughness;if(D){var L=D.baseColorFactor;L&&(s.baseColor=L.slice(0,3),s.alpha=L[3]);var R=D.baseColorTexture;R&&(i=r.textures[R.index])&&(s.baseColorMap=i._texture);var T=D.metallicFactor;null!=T&&(s.metallic=T);var F=D.roughnessFactor;null!=F&&(s.roughness=F);var N=D.metallicRoughnessTexture;return N&&(i=r.textures[N.index])&&(s.metallicRoughnessMap=i._texture),new En(t.scene,s)}return new je(t.scene,s)}function n(t,e){var i,r,s,o,a=t.json,n=[],l=e.primitives;if(l)for(var h,u,c,p,d,f,_,g,m=0,v=l.length;m<v;m++)f={primitive:"triangles",compressGeometry:!0,edgeThreshold:t.edgeThreshold},null!=(u=(h=l[m]).indices)&&(s=a.accessors[u],f.indices=s._typedArray),(o=h.attributes)&&(null!=(c=o.POSITION)&&(s=a.accessors[c],f.positions=s._typedArray),null!=(p=o.NORMAL)&&(s=a.accessors[p],f.normals=s._typedArray),null!=(d=o.TEXCOORD_0)&&(s=a.accessors[d],f.uv=s._typedArray),_={},g=t.readableGeometry?new ke(t.modelNode,f):new Mn(t.modelNode,f),_.geometry=g,null!=(i=h.material)&&(r=a.materials[i])&&(_.material=r._material),n.push(_));e._mesh=n}function l(t,e,i,r){var s;if(r=r||t.modelNode,t.prioritizeGLTFNode){var o=t.prioritizeGLTFNode(t.modelNode.id,e);if(null==o)return}if(t.handleGLTFNode){var a={};if(!t.handleGLTFNode(t.modelNode.id,e,a))return;a.createEntity&&(s=a.createEntity)}var n,u=t.json,c=t.modelNode,p=e.children&&e.children.length>0;if(e.matrix&&(n=e.matrix,i=i?E.mulMat4(i,n,E.mat4()):n),e.translation&&(n=E.translationMat4v(e.translation),i=i?E.mulMat4(i,n,n):n),e.rotation&&(n=E.quaternionToMat4(e.rotation),i=i?E.mulMat4(i,n,n):n),e.scale&&(n=E.scalingMat4v(e.scale),i=i?E.mulMat4(i,n,n):n),void 0!==e.mesh){var d=u.meshes[e.mesh];if(d){var f,_,g=d._mesh,m=g.length;if(!s&&m>0&&!p){for(var v=0,b=m;v<b;v++){var y={geometry:(f=g[v]).geometry,matrix:i};B.apply(t.modelNodeProps,y),y.material=f.material,_=new Hi(c,y),r.addChild(_,!1)}return}if(s&&1===m&&!p){var P={geometry:(f=g[0]).geometry,matrix:i};return B.apply(t.modelNodeProps,P),P.material=f.material,B.apply(s,P),_=new Hi(c,P),void r.addChild(_,!1)}if(s&&m>0&&!p){var M={matrix:i};B.apply(t.modelNodeProps,M),B.apply(s,M);var x=new mn(c,M);r.addChild(x,!1);for(var w=0,C=m;w<C;w++){var A={geometry:(f=g[w]).geometry};B.apply(t.modelNodeProps,A),A.material=f.material,B.apply(s,A),A.id=null,_=new Hi(c,A),x.addChild(_,!1)}return}if(!s&&m>0&&p){var S={matrix:i};B.apply(t.modelNodeProps,S);var D=new mn(c,S);r.addChild(D,!1);for(var L=0,R=m;L<R;L++){var T={geometry:(f=g[L]).geometry};B.apply(S,T),T.id=null,T.matrix=null,T.material=f.material,_=new Hi(c,T),D.addChild(_,!1)}i=null,r=D}if(s&&0===m&&p){var F={matrix:i};B.apply(t.modelNodeProps,F),B.apply(s,F),s.matrix=i;var N=new mn(c,F);r.addChild(N,!1),i=null,r=N}if(s&&m>0||p){var I={matrix:i};B.apply(t.modelNodeProps,I),s&&B.apply(s,I);var k=new mn(c,I);r.addChild(k,!1);for(var O=0,V=m;O<V;O++){var z={geometry:(f=g[O]).geometry};B.apply(t.modelProps,z),z.material=f.material,s&&B.apply(s,z),z.id=null,_=new Hi(c,z),k.addChild(_,!1)}i=null,r=k}}}if(e.children)for(var U,j,G=e.children,X=0,W=G.length;X<W;X++)j=G[X],(U=u.nodes[j])?l(t,U,i,r):h(t,"Node not found: "+X)}function h(t,e){t.plugin.error(e)}}(),zn=function(t){};zn.prototype.load=function(t,e,i,r,s,o){Un(t,e,i,r=r||{},(function(){V.scheduleTask((function(){e.scene.fire("modelLoaded",e.id),e.fire("loaded",!0,!1)})),s&&s()}),(function(i){t.error(i),o&&o(i),e.fire("error",i)}))},zn.prototype.parse=function(t,e,i,r,s,o){jn(t,i,"",r=r||{},e,(function(){e.scene.fire("modelLoaded",e.id),e.fire("loaded",!0,!1),s&&s()}),(function(t){e.error(t),e.fire("error",t),o&&o(t)}))};var Un=function(t,e,i,r,s,o){var a=t.viewer.scene.canvas.spinner;a.processes++,t.dataSource.getGLTF(i,(function(n){a.processes--,jn(t,n,i,r,e,s,o)}),o)},jn=function(){var t={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},e={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};return function(t,e,n,l,u,c){var p={src:n,loadBuffer:l.loadBuffer,handleGLTFNode:l.handleGLTFNode,json:e,scene:u.scene,plugin:t,performanceModel:u,geometryCreated:{},numObjects:0,nodes:[]},d=t.viewer.scene.canvas.spinner;d.processes++,function(t,e){var r=t.json.buffers;if(r)for(var s=r.length,o=0,a=r.length;o<a;o++)i(t,r[o],(function(){0==--s&&e()}),(function(i){t.plugin.error(i),0==--s&&e()}));else e()}(p,(function(){!function(t){var e=t.json.bufferViews;if(e)for(var i=0,s=e.length;i<s;i++)r(t,e[i])}(p),function(t){var e=t.json.buffers;if(e)for(var i=0,r=e.length;i<r;i++)e[i]._buffer=null}(p),function(t){var e=t.json.materials;if(e)for(var i=0,r=e.length;i<r;i++){var o=e[i],a=s(t,o);o._rgbaColor=a}}(p),d.processes--,function(t){var e=t.json,i=e.scene||0,r=e.scenes[i];if(!r)return void h(t,"glTF has no default scene");(function(t,e){var i=e.nodes;if(!i)return;for(var r=t.json,s=0,a=i.length;s<a;s++){r.nodes[i[s]]?o(t,s):h(t,"Node not found: "+s)}})(t,r),function(t,e){var i=e.nodes;if(!i)return;for(var r=t.json,s=0,n=i.length;s<n;s++){var l=r.nodes[i[s]];l?o(t,l):h(t,"Node not found: "+s)}t.plugin.viewer.scene.canvas.spinner.processes++;for(var u=0,c=i.length;u<c;u++){a(t,r.nodes[i[u]],null)}t.plugin.viewer.scene.canvas.spinner.processes--}(t,r)}(p),u.finalize(),c()}))};function i(t,e,i,r){var s=e.uri;s?t.plugin.dataSource.getArrayBuffer(t.src,s,(function(t){e._buffer=t,i()}),r):r("gltf/handleBuffer missing uri in "+JSON.stringify(e))}function r(t,e){var i=t.json.buffers[e.buffer];e._typedArray=null;var r=e.byteLength||0,s=e.byteOffset||0;e._buffer=i._buffer.slice(s,s+r)}function s(t,e){var i=new Float32Array([1,1,1,1]),r=e.extensions;if(r){var s=r.KHR_materials_pbrSpecularGlossiness;if(s){var o=s.diffuseFactor;null!=o&&i.set(o)}var a=r.KHR_materials_common;if(a){var n=a.technique,l=a.values||{},h="BLINN"===n,u="PHONG"===n,c="LAMBERT"===n,p=l.diffuse;p&&(h||u||c)&&(B.isString(p)||i.set(p));var d=l.transparency;null!=d&&(i[3]=d);var f=l.transparent;null!=f&&(i[3]=f)}}var _=e.pbrMetallicRoughness;if(_){var g=_.baseColorFactor;g&&i.set(g)}return i}function o(t,e){var i=t.json;if(void 0!==e.mesh){var r=i.meshes[e.mesh];r&&(r.instances=r.instances?r.instances+1:1)}if(e.children)for(var s=e.children,a=0,n=s.length;a<n;a++){var l=s[a],u=i.nodes[l];u?o(t,u):h(t,"Node not found: "+a)}}function a(t,e,i){var r,s=t.json;if(e.matrix&&(r=e.matrix,i=i?E.mulMat4(i,r,E.mat4()):r),e.translation&&(r=E.translationMat4v(e.translation),i=i?E.mulMat4(i,r,E.mat4()):r),e.rotation&&(r=E.quaternionToMat4(e.rotation),i=i?E.mulMat4(i,r,E.mat4()):r),e.scale&&(r=E.scalingMat4v(e.scale),i=i?E.mulMat4(i,r,E.mat4()):r),void 0!==e.mesh){var o=s.meshes[e.mesh];if(o){var l;if(t.handleGLTFNode){var u={};if(!t.handleGLTFNode(t.performanceModel.id,e,u))return;u.createEntity&&(l=u.createEntity)}var c=t.performanceModel,p=i?i.slice():E.identityMat4(),d=o.primitives.length;if(d>0){for(var f=[],_=0;_<d;_++){var g={id:c.id+"."+t.numObjects++,matrix:p},m=o.primitives[_],v=m.material,b=void 0;if(null!=v&&(b=s.materials[v]),b?(g.color=b._rgbaColor,g.opacity=b._rgbaColor[3]):(g.color=new Float32Array([1,1,1]),g.opacity=1),l&&(l.colorize&&(g.color=l.colorize),void 0!==l.opacity&&null!==l.opacity&&(g.opacity=l.opacity)),o.instances>1){var y=c.id+"."+e.mesh+"."+_;if(!t.geometryCreated[y]){var P={id:y};n(t,m,P),c.createGeometry(P),t.geometryCreated[y]=!0}g.geometryId=y,c.createMesh(g),f.push(g.id)}else n(t,m,g),c.createMesh(g),f.push(g.id)}l?c.createEntity(B.apply(l,{meshIds:f})):c.createEntity({meshIds:f})}}}if(e.children)for(var M=e.children,x=0,w=M.length;x<w;x++){var C=M[x],A=s.nodes[C];A?a(t,A,i):h(t,"Node not found: "+x)}}function n(t,e,i){var r=e.attributes;if(r){i.primitive="triangles";var s=e.indices;if(null!=s){var o=t.json.accessors[s];i.indices=l(t,o)}var a=r.POSITION;if(null!=a){var n=t.json.accessors[a];i.positions=l(t,n)}var h=r.NORMAL;if(null!=h){var u=t.json.accessors[h];i.normals=l(t,u)}i.indices&&(i.edgeIndices=Se(i.positions,i.indices,null,10))}}function l(i,r){var s=i.json.bufferViews[r.bufferView],o=e[r.type],a=t[r.componentType],n=a.BYTES_PER_ELEMENT*o;if(!r.byteStride||r.byteStride===n)return new a(s._buffer,r.byteOffset||0,r.count*o);h("interleaved buffer!")}function h(t,e){t.plugin.error(e)}}(),Gn={IfcOpeningElement:{pickable:!1,visible:!1},IfcSpace:{colorize:[.137255,.403922,.870588],pickable:!1,visible:!1,opacity:.4},IfcWindow:{colorize:[.137255,.403922,.870588],opacity:.3},IfcPlate:{colorize:[.8470588235,.427450980392,0,.5],opacity:.3},DEFAULT:{}},Xn=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,"GLTFLoader",e,i),this._sceneGraphLoader=new kn(this,i),this._performanceModelLoader=new zn(this,i),this.dataSource=i.dataSource,this.objectDefaults=i.objectDefaults}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={dataSource:{configurable:!0},objectDefaults:{configurable:!0}};return i.dataSource.set=function(t){this._dataSource=t||new dr},i.dataSource.get=function(){return this._dataSource},i.objectDefaults.set=function(t){this._objectDefaults=t||Gn},i.objectDefaults.get=function(){return this._objectDefaults},e.prototype.load=function(t){var e=this;void 0===t&&(t={}),t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);var i=!1!==t.performance,r=i?new nn(this.viewer.scene,B.apply(t,{isModel:!0})):new mn(this.viewer.scene,B.apply(t,{isModel:!0})),s=r.id;if(!t.src&&!t.gltf)return this.error("load() param expected: src or gltf"),r;var o=i?this._performanceModelLoader:this._sceneGraphLoader;if(t.metaModelSrc||t.metaModelData){var a=t.objectDefaults||this._objectDefaults||Gn,n=function(i){var n;if(e.viewer.metaScene.createMetaModel(s,i,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes}),e.viewer.scene.canvas.spinner.processes--,t.includeTypes){n={};for(var l=0,h=t.includeTypes.length;l<h;l++)n[t.includeTypes[l]]=!0}if(t.excludeTypes){n||(n={});for(var u=0,c=t.excludeTypes.length;u<c;u++)n[t.excludeTypes[u]]=!0}t.readableGeometry=!1,t.handleGLTFNode=function(t,i,r){var s=i.name;if(!s)return!0;var o=s,n=e.viewer.metaScene.metaObjects[o],l=(n?n.type:"DEFAULT")||"DEFAULT";r.createEntity={id:o,isObject:!0};var h=a[l];return h&&(!1===h.visible&&(r.createEntity.visible=!1),h.colorize&&(r.createEntity.colorize=h.colorize),!1===h.pickable&&(r.createEntity.pickable=!1),void 0!==h.opacity&&null!==h.opacity&&(r.createEntity.opacity=h.opacity)),!0},t.src?o.load(e,r,t.src,t):o.parse(e,r,t.gltf,t)};if(t.metaModelSrc){var l=t.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(l,(function(t){e.viewer.scene.canvas.spinner.processes--,n(t)}),(function(t){e.error("load(): Failed to load model metadata for model '"+s+" from  '"+l+"' - "+t),e.viewer.scene.canvas.spinner.processes--}))}else t.metaModelData&&n(t.metaModelData)}else t.handleGLTFNode=function(t,e,i){var r=e.name;if(!r)return!0;var s=r;return i.createEntity={id:s,isObject:!0},!0},t.src?o.load(this,r,t.src,t):o.parse(this,r,t.gltf,t);return r.once("destroyed",(function(){e.viewer.metaScene.destroyMetaModel(s)})),r},e.prototype.destroy=function(){t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(n);function Wn(t,e){void 0===e&&(e={});var i="lightgrey",r=e.hoverColor||"rgba(0,0,0,0.4)",s=500,o=s+s/3,a=o/24,n=[{boundary:[6,6,6,6],color:e.frontColor||e.color||"#55FF55"},{boundary:[18,6,6,6],color:e.backColor||e.color||"#55FF55"},{boundary:[12,6,6,6],color:e.leftColor||e.color||"#FF5555"},{boundary:[0,6,6,6],color:e.rightColor||e.color||"#FF5555"},{boundary:[6,0,6,6],color:e.topColor||e.color||"#7777FF"},{boundary:[6,12,6,6],color:e.bottomColor||e.color||"#7777FF"}],l=[{label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,1,0],up:[0,0,1]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,-1,0],up:[0,0,1]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,0,1]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,0,1]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,0,1],up:[0,-1,0]},{boundaries:[[7,5,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,0,-1],up:[1,0,1]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-1,-1],up:[0,-1,1]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,0,-1],up:[-1,0,1]},{boundaries:[[7,11,4,2]],dir:[0,1,1],up:[0,-1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,0,1],up:[-1,0,1]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,-1,1],up:[0,1,1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,0,1],up:[1,0,1]},{boundaries:[[5,7,2,4]],dir:[1,1,0],up:[0,0,1]},{boundaries:[[11,7,2,4]],dir:[-1,1,0],up:[0,0,1]},{boundaries:[[17,7,2,4]],dir:[-1,-1,0],up:[0,0,1]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,-1,0],up:[0,0,1]},{boundaries:[[5,11,2,2]],dir:[1,1,1],up:[-1,-1,1]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[1,-1,1],up:[-1,1,1]},{boundaries:[[5,5,2,2]],dir:[1,1,-1],up:[1,1,1]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-1,-1,1],up:[1,1,1]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-1,-1,-1],up:[-1,-1,1]},{boundaries:[[11,11,2,2]],dir:[-1,1,1],up:[1,-1,1]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[1,-1,-1],up:[1,-1,1]},{boundaries:[[11,5,2,2]],dir:[-1,1,-1],up:[-1,1,1]}];e.frontColor||e.color,e.backColor||e.color,e.leftColor||e.color,e.rightColor||e.color,e.topColor||e.color,e.bottomColor||e.color;for(var h=[{yUp:"",label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,0,1],up:[0,1,0]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,1,0]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,1,0]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,-1,0],up:[0,0,-1]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,1,0],up:[0,0,1]},{boundaries:[[7,5,4,2]],dir:[0,-.7071,-.7071],up:[0,.7071,-.7071]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,-1,0],up:[1,1,0]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-.7071,.7071],up:[0,.7071,.7071]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,-1,0],up:[-1,1,0]},{boundaries:[[7,11,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,1,0],up:[-1,1,0]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,1,1],up:[0,1,-1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,1,0],up:[1,1,0]},{boundaries:[[5,7,2,4]],dir:[1,0,-1],up:[0,1,0]},{boundaries:[[11,7,2,4]],dir:[-1,0,-1],up:[0,1,0]},{boundaries:[[17,7,2,4]],dir:[-1,0,1],up:[0,1,0]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,0,1],up:[0,1,0]},{boundaries:[[5,11,2,2]],dir:[.5,.7071,-.5],up:[-.5,.7071,.5]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[.5,.7071,.5],up:[-.5,.7071,-.5]},{boundaries:[[5,5,2,2]],dir:[.5,-.7071,-.5],up:[.5,.7071,-.5]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-.5,.7071,.5],up:[.5,.7071,-.5]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-.5,-.7071,.5],up:[-.5,.7071,.5]},{boundaries:[[11,11,2,2]],dir:[-.5,.7071,-.5],up:[.5,.7071,.5]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[.5,-.7071,.5],up:[.5,.7071,.5]},{boundaries:[[11,5,2,2]],dir:[-.5,-.7071,-.5],up:[-.5,.7071,-.5]}],u=0,c=l.length;u<c;u++)E.normalizeVec3(l[u].dir,l[u].dir),E.normalizeVec3(l[u].up,l[u].up);for(var p=0,d=h.length;p<d;p++)E.normalizeVec3(h[p].dir,h[p].dir),E.normalizeVec3(h[p].up,h[p].up);var f=h;this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=o,this._textureCanvas.height=s,this._textureCanvas.style.width=o+"px",this._textureCanvas.style.height="500px",this._textureCanvas.style.padding="0",this._textureCanvas.style.margin="0",this._textureCanvas.style.top="0",this._textureCanvas.style.background=i,this._textureCanvas.style.position="absolute",this._textureCanvas.style.opacity="1.0",this._textureCanvas.style.visibility="hidden",this._textureCanvas.style["z-index"]=2e6,document.getElementsByTagName("body")[0].appendChild(this._textureCanvas);var _=this._textureCanvas.getContext("2d"),g=!1;function m(){for(var e=0,s=n.length;e<s;e++){var o=n[e],l=o.boundary,h=Math.round(l[0]*a),u=Math.round(l[1]*a),c=Math.round(l[2]*a),p=Math.round(l[3]*a);_.fillStyle=o.color,_.fillRect(h,u,c,p)}for(var d=0,g=f.length;d<g;d++){for(var m=void 0,v=void 0,b=void 0,y=void 0,M=f[d],x=M.boundaries,w=0,E=x.length;w<E;w++){var C=x[w];m=Math.round(C[0]*a),v=Math.round(C[1]*a),b=Math.round(C[2]*a),y=Math.round(C[3]*a),M.highlighted&&(_.fillStyle=M.highlighted?r:M.color||i,_.fillRect(m,v,b,y))}if(M.label){_.fillStyle="black",_.font="60px sans-serif",_.textAlign="center";var A=m+.5*b,S=v+.7*y;_.fillText(P(M.label),A,S,80)}}t.scene.glRedraw()}var v,b,y,P=(v={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},b={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},y={"NavCube.front":"FRONT","NavCube.back":"BACK","NavCube.right":"RIGHT","NavCube.left":"LEFT","NavCube.top":"TOP","NavCube.bottom":"BOTTOM"},function(e){var i=g?b:v,r=i?i[e]:null;return r?t.localeService.translate(r)||y[r]||r:e});this.setZUp=function(){g=!0,f=l,this.clear()},this.setYUp=function(){g=!1,f=h,this.clear()},this.clear=function(){_.fillStyle=i,_.fillRect(0,0,o,s);for(var t=0,e=f.length;t<e;t++){f[t].highlighted=!1}m()},this.getArea=function(t){for(var e=t[0]*o,i=s-t[1]*s,r=0,n=f.length;r<n;r++)for(var l=f[r].boundaries,h=0,u=l.length;h<u;h++){var c=l[h];if(e>=c[0]*a&&e<=(c[0]+c[2])*a&&i>=c[1]*a&&i<=(c[1]+c[3])*a)return r}return-1},this.setAreaHighlighted=function(t,e){var i=f[t];if(!i)throw"Area not found: "+t;i.highlighted=!!e,m()},this.getAreaDir=function(t){var e=f[t];if(!e)throw"Unknown area: "+t;return e.dir},this.getAreaUp=function(t){var e=f[t];if(!e)throw"Unknown area: "+t;return e.up},this.getImage=function(){return this._textureCanvas},this.destroy=function(){this._textureCanvas&&(this._textureCanvas.parentNode.removeChild(this._textureCanvas),this._textureCanvas=null)}}var Hn=function(t){function e(e,i){var r=this;void 0===i&&(i={}),t.call(this,"NavCube",e,i),e.navCube=this;try{this._navCubeScene=new ei(e,{canvasId:i.canvasId,canvasElement:i.canvasElement,transparent:!0}),this._navCubeCanvas=this._navCubeScene.canvas.canvas,this._navCubeScene.input.keyboardEnabled=!1}catch(t){return void this.error(t)}var s=this._navCubeScene;s.clearLights(),new Ee(s,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new Ee(s,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new Ee(s,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._navCubeCamera=s.camera,this._navCubeCamera.ortho.scale=7,this._navCubeCamera.ortho.near=.1,this._navCubeCamera.ortho.far=2e3,s.edgeMaterial.edgeColor=[.2,.2,.2],s.edgeMaterial.edgeAlpha=.6,this._zUp=Boolean(e.camera.zUp);var o=this;this._synchCamera=function(){var t=E.rotationMat4c(-90*E.DEGTORAD,1,0,0),i=E.vec3(),r=E.vec3(),s=E.vec3();return function(){var a=e.camera.eye,n=e.camera.look,l=e.camera.up;i=E.mulVec3Scalar(E.normalizeVec3(E.subVec3(a,n,i)),5),o._zUp?(E.transformVec3(t,i,r),E.transformVec3(t,l,s),o._navCubeCamera.look=[0,0,0],o._navCubeCamera.eye=E.transformVec3(t,i,r),o._navCubeCamera.up=E.transformPoint3(t,l,s)):(o._navCubeCamera.look=[0,0,0],o._navCubeCamera.eye=i,o._navCubeCamera.up=l)}}(),this._cubeTextureCanvas=new Wn(e,i),this._cubeSampler=new In(s,{image:this._cubeTextureCanvas.getImage(),flipY:!0,wrapS:"clampToEdge",wrapT:"clampToEdge"}),this._cubeMesh=new Hi(s,{geometry:new ke(s,{primitive:"triangles",normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),material:new je(s,{diffuse:[.4,.4,.4],specular:[.4,.4,.4],emissive:[.6,.6,.6],diffuseMap:this._cubeSampler,emissiveMap:this._cubeSampler}),visible:!0,edges:!0}),this._shadow=new Hi(s,{geometry:new ke(s,Ki({center:[0,0,0],radiusTop:.001,radiusBottom:1.4,height:.01,radialSegments:20,heightSegments:1,openEnded:!0})),material:new je(s,{diffuse:[0,0,0],specular:[0,0,0],emissive:[0,0,0],alpha:.5}),position:[0,-1.5,0],visible:!0,pickable:!1,backfaces:!1}),this._onCameraMatrix=e.camera.on("matrix",this._synchCamera),this._onCameraWorldAxis=e.camera.on("worldAxis",(function(){e.camera.zUp?(r._zUp=!0,r._cubeTextureCanvas.setZUp(),r._repaint(),r._synchCamera()):e.camera.yUp&&(r._zUp=!1,r._cubeTextureCanvas.setYUp(),r._repaint(),r._synchCamera())})),this._onCameraFOV=e.camera.perspective.on("fov",(function(t){r._synchProjection&&(r._navCubeCamera.perspective.fov=t)})),this._onCameraProjection=e.camera.on("projection",(function(t){r._synchProjection&&(r._navCubeCamera.projection=t)}));var a=-1;function n(t){var e=[0,0];if(t){for(var i=t.target,r=0,s=0;i.offsetParent;)r+=i.offsetLeft,s+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-r,e[1]=t.pageY-s}else t=window.event,e[0]=t.x,e[1]=t.y;return e}var l,h,u=null,c=null,p=!1,d=!1,f=.5;o._navCubeCanvas.addEventListener("mouseenter",o._onMouseEnter=function(t){d=!0}),o._navCubeCanvas.addEventListener("mouseleave",o._onMouseLeave=function(t){d=!1}),o._navCubeCanvas.addEventListener("mousedown",o._onMouseDown=function(t){if(1===t.which){u=t.x,c=t.y,l=t.clientX,h=t.clientY;var e=n(t),i=s.pick({canvasPos:e});p=!!i}}),document.addEventListener("mouseup",o._onMouseUp=function(t){if(1===t.which&&(p=!1,null!==u)){var e=n(t),i=s.pick({canvasPos:e,pickSurface:!0});if(i&&i.uv){var r=o._cubeTextureCanvas.getArea(i.uv);if(r>=0&&(document.body.style.cursor="pointer",a>=0&&(o._cubeTextureCanvas.setAreaHighlighted(a,!1),o._repaint(),a=-1),r>=0)){if(o._cubeTextureCanvas.setAreaHighlighted(r,!0),a=r,o._repaint(),t.x<u-3||t.x>u+3||t.y<c-3||t.y>c+3)return;var l=o._cubeTextureCanvas.getAreaDir(r);if(l){var h=o._cubeTextureCanvas.getAreaUp(r);_(l,h,(function(){a>=0&&(o._cubeTextureCanvas.setAreaHighlighted(a,!1),o._repaint(),a=-1),document.body.style.cursor="pointer",a>=0&&(o._cubeTextureCanvas.setAreaHighlighted(a,!1),o._repaint(),a=-1),r>=0&&(o._cubeTextureCanvas.setAreaHighlighted(r,!1),a=-1,o._repaint())}))}}}}}),document.addEventListener("mousemove",o._onMouseMove=function(t){if(a>=0&&(o._cubeTextureCanvas.setAreaHighlighted(a,!1),o._repaint(),a=-1),1!==t.buttons||p){if(p){var i=t.clientX,r=t.clientY;return document.body.style.cursor="move",void function(t,i){var r=(t-l)*-f,s=(i-h)*-f;e.camera.orbitYaw(r),e.camera.orbitPitch(-s),l=t,h=i}(i,r)}if(d){var u=n(t),c=s.pick({canvasPos:u,pickSurface:!0});if(c){if(c.uv){document.body.style.cursor="pointer";var _=o._cubeTextureCanvas.getArea(c.uv);if(_===a)return;a>=0&&o._cubeTextureCanvas.setAreaHighlighted(a,!1),_>=0&&(o._cubeTextureCanvas.setAreaHighlighted(_,!0),o._repaint(),a=_)}}else document.body.style.cursor="default",a>=0&&(o._cubeTextureCanvas.setAreaHighlighted(a,!1),o._repaint(),a=-1)}}});var _=function(){var t=E.vec3();return function(i,r,s){var a=o._fitVisible?e.scene.getAABB(e.scene.visibleObjectIds):e.scene.aabb,n=E.getAABB3Diag(a);E.getAABB3Center(a,t);var l=Math.abs(n/Math.tan(o._cameraFitFOV*E.DEGTORAD));e.cameraControl.pivotPos=t,o._cameraFly?e.cameraFlight.flyTo({look:t,eye:[t[0]-l*i[0],t[1]-l*i[1],t[2]-l*i[2]],up:r||[0,1,0],orthoScale:1.1*n,fitFOV:o._cameraFitFOV,duration:o._cameraFlyDuration},s):e.cameraFlight.jumpTo({look:t,eye:[t[0]-l*i[0],t[1]-l*i[1],t[2]-l*i[2]],up:r||[0,1,0],orthoScale:1.1*n,fitFOV:o._cameraFitFOV},s)}}();this._onUpdated=e.localeService.on("updated",(function(){r._cubeTextureCanvas.clear(),r._repaint()})),this.setVisible(i.visible),this.setCameraFitFOV(i.cameraFitFOV),this.setCameraFly(i.cameraFly),this.setCameraFlyDuration(i.cameraFlyDuration),this.setFitVisible(i.fitVisible),this.setSynchProjection(i.synchProjection)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.send=function(t,e){switch(t){case"language":this._cubeTextureCanvas.clear(),this._repaint()}},e.prototype._repaint=function(){var t=this._cubeTextureCanvas.getImage();this._cubeMesh.material.diffuseMap.image=t,this._cubeMesh.material.emissiveMap.image=t},e.prototype.setVisible=function(t){void 0===t&&(t=!0),this._navCubeCanvas&&(this._cubeMesh.visible=t,this._shadow.visible=t,this._navCubeCanvas.style.visibility=t?"visible":"hidden")},e.prototype.getVisible=function(){return!!this._navCubeCanvas&&this._cubeMesh.visible},e.prototype.setFitVisible=function(t){void 0===t&&(t=!1),this._fitVisible=t},e.prototype.getFitVisible=function(){return this._fitVisible},e.prototype.setCameraFly=function(t){void 0===t&&(t=!0),this._cameraFly=t},e.prototype.getCameraFly=function(){return this._cameraFly},e.prototype.setCameraFitFOV=function(t){void 0===t&&(t=45),this._cameraFitFOV=t},e.prototype.getCameraFitFOV=function(){return this._cameraFitFOV},e.prototype.setCameraFlyDuration=function(t){void 0===t&&(t=.5),this._cameraFlyDuration=t},e.prototype.getCameraFlyDuration=function(){return this._cameraFlyDuration},e.prototype.setSynchProjection=function(t){void 0===t&&(t=!1),this._synchProjection=t},e.prototype.getSynchProjection=function(){return this._synchProjection},e.prototype.destroy=function(){this._navCubeCanvas&&(this.viewer.localeService.off(this._onUpdated),this.viewer.camera.off(this._onCameraMatrix),this.viewer.camera.off(this._onCameraWorldAxis),this.viewer.camera.perspective.off(this._onCameraFOV),this.viewer.camera.off(this._onCameraProjection),this._navCubeCanvas.removeEventListener("mouseenter",this._onMouseEnter),this._navCubeCanvas.removeEventListener("mouseleave",this._onMouseLeave),this._navCubeCanvas.removeEventListener("mousedown",this._onMouseDown),document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),this._navCubeCanvas=null,this._cubeTextureCanvas.destroy(),this._cubeTextureCanvas=null,this._onMouseEnter=null,this._onMouseLeave=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null),this._navCubeScene.destroy(),this._navCubeScene=null,this._cubeMesh=null,this._shadow=null,t.prototype.destroy.call(this)},e}(n),Yn=E.vec3(),Kn=function(){};Kn.prototype.load=function(t,e,i){var r=t.scene.canvas.spinner;r.processes++,qn(t,e,(function(e){!function(t,e,i){for(var r=e.basePath,s=Object.keys(e.materialLibraries),o=s.length,a=0,n=o;a<n;a++)Qn(t,r,r+s[a],(function(){0==--o&&i()}))}(t,e,(function(){$n(t,e),r.processes--,V.scheduleTask((function(){t.fire("loaded",!0,!1)}))}))}))},Kn.prototype.parse=function(t,e,i,r){if(e){var s=Zn(t,e,null);i&&Jn(t,i,r),$n(t,s),t.src=null,t.fire("loaded",!0,!1)}else this.warn("load() param expected: objText")};var qn=function(t,e,i){tl(e,(function(r){var s=Zn(t,r,e);i(s)}),(function(e){t.error(e)}))},Zn=function(){var t={vertex_pattern:/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,normal_pattern:/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,uv_pattern:/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /};return function(i,r,s){var o,a,n={src:s=s||"",basePath:(o=s,a=o.lastIndexOf("/"),-1===a?o:o.substring(0,a+1)),objects:[],object:{},positions:[],normals:[],uv:[],materialLibraries:{}};e(n,"",!1),-1!==r.indexOf("\r\n")&&(r=r.replace("\r\n","\n"));for(var l=r.split("\n"),h="",p="",d="",f=[],_="function"==typeof"".trimLeft,g=0,m=l.length;g<m;g++)if(h=l[g],0!==(h=_?h.trimLeft():h.trim()).length&&"#"!==(p=h.charAt(0)))if("v"===p)if(" "===(d=h.charAt(1))&&null!==(f=t.vertex_pattern.exec(h)))n.positions.push(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3]));else if("n"===d&&null!==(f=t.normal_pattern.exec(h)))n.normals.push(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3]));else{if("t"!==d||null===(f=t.uv_pattern.exec(h)))return void i.error("Unexpected vertex/normal/uv line: '"+h+"'");n.uv.push(parseFloat(f[1]),parseFloat(f[2]))}else if("f"===p)if(null!==(f=t.face_vertex_uv_normal.exec(h)))u(n,f[1],f[4],f[7],f[10],f[2],f[5],f[8],f[11],f[3],f[6],f[9],f[12]);else if(null!==(f=t.face_vertex_uv.exec(h)))u(n,f[1],f[3],f[5],f[7],f[2],f[4],f[6],f[8]);else if(null!==(f=t.face_vertex_normal.exec(h)))u(n,f[1],f[3],f[5],f[7],void 0,void 0,void 0,void 0,f[2],f[4],f[6],f[8]);else{if(null===(f=t.face_vertex.exec(h)))return void i.error("Unexpected face line: '"+h+"'");u(n,f[1],f[2],f[3],f[4])}else if("l"===p){var v=h.substring(1).trim().split(" "),b=[],y=[];if(-1===h.indexOf("/"))b=v;else for(var P=0,M=v.length;P<M;P++){var x=v[P].split("/");""!==x[0]&&b.push(x[0]),""!==x[1]&&y.push(x[1])}c(n,b,y)}else if(null!==(f=t.object_pattern.exec(h))){e(n,w=f[0].substr(1).trim(),!0)}else if(t.material_use_pattern.test(h)){var w=h.substring(7).trim();n.object.material.id=w}else if(t.material_library_pattern.test(h))n.materialLibraries[h.substring(7).trim()]=!0;else{if(null===(f=t.smoothing_pattern.exec(h))){if("\0"===h)continue;return void i.error("Unexpected line: '"+h+"'")}var E=f[1].trim().toLowerCase();n.object.material.smooth="1"===E||"on"===E}return n};function e(t,e,i){if(t.object&&!1===t.object.fromDeclaration)return t.object.id=e,void(t.object.fromDeclaration=!1!==i);t.object={id:e||"",geometry:{positions:[],normals:[],uv:[]},material:{id:"",smooth:!0},fromDeclaration:!1!==i},t.objects.push(t.object)}function i(t,e){var i=parseInt(t,10);return 3*(i>=0?i-1:i+e/3)}function r(t,e){var i=parseInt(t,10);return 3*(i>=0?i-1:i+e/3)}function s(t,e){var i=parseInt(t,10);return 2*(i>=0?i-1:i+e/2)}function o(t,e,i,r){var s=t.positions,o=t.object.geometry.positions;o.push(s[e+0]),o.push(s[e+1]),o.push(s[e+2]),o.push(s[i+0]),o.push(s[i+1]),o.push(s[i+2]),o.push(s[r+0]),o.push(s[r+1]),o.push(s[r+2])}function a(t,e){var i=t.positions,r=t.object.geometry.positions;r.push(i[e+0]),r.push(i[e+1]),r.push(i[e+2])}function n(t,e,i,r){var s=t.normals,o=t.object.geometry.normals;o.push(s[e+0]),o.push(s[e+1]),o.push(s[e+2]),o.push(s[i+0]),o.push(s[i+1]),o.push(s[i+2]),o.push(s[r+0]),o.push(s[r+1]),o.push(s[r+2])}function l(t,e,i,r){var s=t.uv,o=t.object.geometry.uv;o.push(s[e+0]),o.push(s[e+1]),o.push(s[i+0]),o.push(s[i+1]),o.push(s[r+0]),o.push(s[r+1])}function h(t,e){var i=t.uv,r=t.object.geometry.uv;r.push(i[e+0]),r.push(i[e+1])}function u(t,e,a,h,u,c,p,d,f,_,g,m,v){var b,y=t.positions.length,P=i(e,y),M=i(a,y),x=i(h,y);if(void 0===u?o(t,P,M,x):(o(t,P,M,b=i(u,y)),o(t,M,x,b)),void 0!==c){var w=t.uv.length;P=s(c,w),M=s(p,w),x=s(d,w),void 0===u?l(t,P,M,x):(l(t,P,M,b=s(f,w)),l(t,M,x,b))}if(void 0!==_){var E=t.normals.length;P=r(_,E),M=_===g?P:r(g,E),x=_===m?P:r(m,E),void 0===u?n(t,P,M,x):(n(t,P,M,b=r(v,E)),n(t,M,x,b))}}function c(t,e,r){t.object.geometry.type="Line";for(var o=t.positions.length,n=t.uv.length,l=0,u=e.length;l<u;l++)a(t,i(e[l],o));for(var c=0,p=r.length;c<p;c++)h(t,s(r[c],n))}}();var Qn=function(t,e,i,r){tl(i,(function(i){Jn(t,i,e),r()}),(function(e){t.error(e),r()}))},Jn=function(){var t=/\s+/;return function(t,s,o){var a,n,l,h,u,c=s.split("\n"),p={id:"Default"},d=!1;o=o||"";for(var f=0;f<c.length;f++)if(0!==(a=c[f].trim()).length&&"#"!==a.charAt(0))switch(l=(l=(n=a.indexOf(" "))>=0?a.substring(0,n):a).toLowerCase(),h=(h=n>=0?a.substring(n+1):"").trim(),l.toLowerCase()){case"newmtl":i(t,p),p={id:h},d=!0;break;case"ka":p.ambient=r(h);break;case"kd":p.diffuse=r(h);break;case"ks":p.specular=r(h);break;case"map_kd":p.diffuseMap||(p.diffuseMap=e(t,o,h,"sRGB"));break;case"map_ks":p.specularMap||(p.specularMap=e(t,o,h,"linear"));break;case"map_bump":case"bump":p.normalMap||(p.normalMap=e(t,o,h));break;case"ns":p.shininess=parseFloat(h);break;case"d":(u=parseFloat(h))<1&&(p.alpha=u,p.alphaMode="blend");break;case"tr":(u=parseFloat(h))>0&&(p.alpha=1-u,p.alphaMode="blend")}d&&i(t,p)};function e(t,e,i,r){var s={},o=i.split(/\s+/),a=o.indexOf("-bm");return a>=0&&o.splice(a,2),(a=o.indexOf("-s"))>=0&&(s.scale=[parseFloat(o[a+1]),parseFloat(o[a+2])],o.splice(a,4)),(a=o.indexOf("-o"))>=0&&(s.translate=[parseFloat(o[a+1]),parseFloat(o[a+2])],o.splice(a,4)),s.src=e+o.join(" ").trim(),s.flipY=!0,s.encoding=r||"linear",new In(t,s).id}function i(t,e){new je(t,e)}function r(e){var i=e.split(t,3);return[parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2])]}}();function $n(t,e){for(var i=0,r=e.objects.length;i<r;i++){var s=e.objects[i],o=s.geometry;if(o.type,0!==o.positions.length){var a={primitive:"triangles",compressGeometry:!1};a.positions=o.positions,o.normals.length>0&&(a.normals=o.normals),o.uv.length>0&&(a.uv=o.uv);for(var n=new Array(a.positions.length/3),l=0;l<n.length;l++)n[l]=l;a.indices=n;var h=Yn;ot(o.positions,o.positions,h);var u,c=new ke(t,a),p=s.material.id;p&&""!==p?(u=t.scene.components[p])||t.error("Material not found: "+p):u=new je(t,{diffuse:[.6,.6,.6],backfaces:!0});var d=new Hi(t,{id:t.id+"#"+s.id,rtcCenter:0!==h[0]||0!==h[1]||0!==h[2]?h:null,isObject:!0,geometry:c,material:u,pickable:!0});t.addChild(d)}}}function tl(t,e,i){var r=new XMLHttpRequest;r.open("GET",t,!0),r.addEventListener("load",(function(t){var r=t.target.response;200===this.status?e&&e(r):0===this.status?(console.warn("loadFile: HTTP Status 0 received."),e&&e(r)):i&&i(t)}),!1),r.addEventListener("error",(function(t){i&&i(t)}),!1),r.send(null)}var el=function(t){function e(e,i){t.call(this,"OBJLoader",e,i),this._sceneGraphLoader=new Kn}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.load=function(t){var e=this;void 0===t&&(t={}),t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);var i=new mn(this.viewer.scene,B.apply(t,{isModel:!0})),r=i.id,s=t.src;if(!s)return this.error("load() param expected: src"),i;if(t.metaModelSrc){var o=t.metaModelSrc;B.loadJSON(o,(function(o){e.viewer.metaScene.createMetaModel(r,o),e._sceneGraphLoader.load(i,s,t)}),(function(t){e.error("load(): Failed to load model modelMetadata for model '"+r+" from  '"+o+"' - "+t)}))}else this._sceneGraphLoader.load(i,s,t);return i.once("destroyed",(function(){e.viewer.metaScene.destroyMetaModel(r)})),i},e.prototype.destroy=function(){t.prototype.destroy.call(this)},e}(n);function il(t){void 0===t&&(t={});var e=t.radius||1;e<0&&(console.error("negative radius not allowed - will invert"),e*=-1),e*=.5;var i=t.tube||.3;i<0&&(console.error("negative tube not allowed - will invert"),i*=-1);var r=t.radialSegments||32;r<0&&(console.error("negative radialSegments not allowed - will invert"),r*=-1),r<4&&(r=4);var s=t.tubeSegments||24;s<0&&(console.error("negative tubeSegments not allowed - will invert"),s*=-1),s<4&&(s=4);var o=t.arc||2*Math.PI;o<0&&(console.warn("negative arc not allowed - will invert"),o*=-1),o>360&&(o=360);var a,n,l,h,u,c,p,d,f,_,g,m,v=t.center,b=v?v[0]:0,y=v?v[1]:0,P=v?v[2]:0,M=[],x=[],w=[],C=[];for(d=0;d<=s;d++)for(p=0;p<=r;p++)a=p/r*o,n=.785398+d/s*Math.PI*2,b=e*Math.cos(a),y=e*Math.sin(a),l=(e+i*Math.cos(n))*Math.cos(a),h=(e+i*Math.cos(n))*Math.sin(a),u=i*Math.sin(n),M.push(l+b),M.push(h+y),M.push(u+P),w.push(1-p/r),w.push(d/s),c=E.normalizeVec3(E.subVec3([l,h,u],[b,y,P],[]),[]),x.push(c[0]),x.push(c[1]),x.push(c[2]);for(d=1;d<=s;d++)for(p=1;p<=r;p++)f=(r+1)*d+p-1,_=(r+1)*(d-1)+p-1,g=(r+1)*(d-1)+p,m=(r+1)*d+p,C.push(f),C.push(_),C.push(g),C.push(g),C.push(m),C.push(f);return B.apply(t,{positions:M,normals:x,uv:w,indices:C})}var rl=new Float64Array([0,0,1]),sl=new Float64Array(4),ol=function(t){this.id=null,this._viewer=t.viewer,this._visible=!1,this._pos=E.vec3(),this._rtcCenter=E.vec3(),this._rtcPos=E.vec3(),this._baseDir=E.vec3(),this._rootNode=null,this._displayMeshes=null,this._affordanceMeshes=null,this._ignoreNextSectionPlaneDirUpdate=!1,this._createNodes(),this._bindEvents()},al={sectionPlane:{configurable:!0}};ol.prototype._setSectionPlane=function(t){var e=this;this._sectionPlane&&(this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._onSectionPlanePos=null,this._onSectionPlaneDir=null,this._sectionPlane=null),t&&(this.id=t.id,this._setPos(t.pos),this._setDir(t.dir),this._sectionPlane=t,this._onSectionPlanePos=t.on("pos",(function(){e._setPos(e._sectionPlane.pos)})),this._onSectionPlaneDir=t.on("dir",(function(){e._ignoreNextSectionPlaneDirUpdate?e._ignoreNextSectionPlaneDirUpdate=!1:e._setDir(e._sectionPlane.dir)})))},al.sectionPlane.get=function(){return this._sectionPlane},ol.prototype._setPos=function(t){this._pos.set(t),st(this._pos,this._rtcCenter,this._rtcPos),this._rootNode.rtcCenter=this._rtcCenter,this._rootNode.position=this._rtcPos},ol.prototype._setDir=function(t){this._baseDir.set(t),this._rootNode.quaternion=E.vec3PairToQuaternion(rl,t,sl)},ol.prototype._setSectionPlaneDir=function(t){this._sectionPlane&&(this._ignoreNextSectionPlaneDirUpdate=!0,this._sectionPlane.dir=t)},ol.prototype.setVisible=function(t){if(void 0===t&&(t=!0),this._visible!==t){var e;for(e in this._visible=t,this._displayMeshes)this._displayMeshes.hasOwnProperty(e)&&(this._displayMeshes[e].visible=t);if(!t)for(e in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(e)&&(this._affordanceMeshes[e].visible=t)}},ol.prototype.getVisible=function(){return this._visible},ol.prototype.setCulled=function(t){var e;for(e in this._displayMeshes)this._displayMeshes.hasOwnProperty(e)&&(this._displayMeshes[e].culled=t);if(!t)for(e in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(e)&&(this._affordanceMeshes[e].culled=t)},ol.prototype._createNodes=function(){var t=!1,e=this._viewer.scene,i=.01;this._rootNode=new mn(e,{position:[0,0,0],scale:[5,5,5]});var r,s,o=this._rootNode,a={arrowHead:new ke(o,Ki({radiusTop:.001,radiusBottom:.07,radialSegments:32,heightSegments:1,height:.2,openEnded:!1})),arrowHeadBig:new ke(o,Ki({radiusTop:.001,radiusBottom:.09,radialSegments:32,heightSegments:1,height:.25,openEnded:!1})),arrowHeadHandle:new ke(o,Ki({radiusTop:.09,radiusBottom:.09,radialSegments:8,heightSegments:1,height:.37,openEnded:!1})),curve:new ke(o,il({radius:.8,tube:i,radialSegments:64,tubeSegments:14,arc:2*Math.PI/4})),curveHandle:new ke(o,il({radius:.8,tube:.06,radialSegments:64,tubeSegments:14,arc:2*Math.PI/4})),hoop:new ke(o,il({radius:.8,tube:i,radialSegments:64,tubeSegments:8,arc:2*Math.PI})),axis:new ke(o,Ki({radiusTop:i,radiusBottom:i,radialSegments:20,heightSegments:1,height:1,openEnded:!1})),axisHandle:new ke(o,Ki({radiusTop:.08,radiusBottom:.08,radialSegments:20,heightSegments:1,height:1,openEnded:!1}))},n={pickable:new je(o,{diffuse:[1,1,0],alpha:0,alphaMode:"blend"}),red:new je(o,{diffuse:[1,0,0],emissive:[1,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightRed:new Xe(o,{edges:!1,fill:!0,fillColor:[1,0,0],fillAlpha:.6}),green:new je(o,{diffuse:[0,1,0],emissive:[0,1,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightGreen:new Xe(o,{edges:!1,fill:!0,fillColor:[0,1,0],fillAlpha:.6}),blue:new je(o,{diffuse:[0,0,1],emissive:[0,0,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightBlue:new Xe(o,{edges:!1,fill:!0,fillColor:[0,0,1],fillAlpha:.2}),center:new je(o,{diffuse:[0,0,0],emissive:[0,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80}),highlightBall:new Xe(o,{edges:!1,fill:!0,fillColor:[.5,.5,.5],fillAlpha:.5,vertices:!1}),highlightPlane:new Xe(o,{edges:!0,edgeWidth:3,fill:!1,fillColor:[.5,.5,.5],fillAlpha:.5,vertices:!1})};this._displayMeshes={plane:o.addChild(new Hi(o,{geometry:new ke(o,{primitive:"triangles",positions:[.5,.5,0,.5,-.5,0,-.5,-.5,0,-.5,.5,0,.5,.5,-0,.5,-.5,-0,-.5,-.5,-0,-.5,.5,-0],indices:[0,1,2,2,3,0]}),material:new je(o,{emissive:[0,0,0],diffuse:[0,0,0],backfaces:!0}),opacity:.6,ghosted:!0,ghostMaterial:new Xe(o,{edges:!1,filled:!0,fillColor:[1,1,0],edgeColor:[0,0,0],fillAlpha:.1,backfaces:!0}),pickable:!1,collidable:!0,clippable:!1,visible:!1,scale:[2.4,2.4,1]}),t),planeFrame:o.addChild(new Hi(o,{geometry:new ke(o,il({center:[0,0,0],radius:1.7,tube:.02,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new je(o,{emissive:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],shininess:0}),highlightMaterial:new Xe(o,{edges:!1,edgeColor:[0,0,0],filled:!0,fillColor:[.8,.8,.8],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,.1],rotation:[0,0,45]}),t),xCurve:o.addChild(new Hi(o,{geometry:a.curve,material:n.red,matrix:(r=E.rotationMat4v(90*E.DEGTORAD,[0,1,0],E.identityMat4()),s=E.rotationMat4v(270*E.DEGTORAD,[1,0,0],E.identityMat4()),E.mulMat4(s,r,E.identityMat4())),pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),t),xCurveHandle:o.addChild(new Hi(o,{geometry:a.curveHandle,material:n.pickable,matrix:function(){var t=E.rotationMat4v(90*E.DEGTORAD,[0,1,0],E.identityMat4()),e=E.rotationMat4v(270*E.DEGTORAD,[1,0,0],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),t),xCurveArrow1:o.addChild(new Hi(o,{geometry:a.arrowHead,material:n.red,matrix:function(){var t=E.translateMat4c(0,-.07,-.8,E.identityMat4()),e=E.scaleMat4v([.6,.6,.6],E.identityMat4()),i=E.rotationMat4v(0*E.DEGTORAD,[0,0,1],E.identityMat4());return E.mulMat4(E.mulMat4(t,e,E.identityMat4()),i,E.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),xCurveArrow2:o.addChild(new Hi(o,{geometry:a.arrowHead,material:n.red,matrix:function(){var t=E.translateMat4c(0,-.8,-.07,E.identityMat4()),e=E.scaleMat4v([.6,.6,.6],E.identityMat4()),i=E.rotationMat4v(90*E.DEGTORAD,[1,0,0],E.identityMat4());return E.mulMat4(E.mulMat4(t,e,E.identityMat4()),i,E.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),yCurve:o.addChild(new Hi(o,{geometry:a.curve,material:n.green,rotation:[-90,0,0],pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),t),yCurveHandle:o.addChild(new Hi(o,{geometry:a.curveHandle,material:n.pickable,rotation:[-90,0,0],pickable:!0,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),t),yCurveArrow1:o.addChild(new Hi(o,{geometry:a.arrowHead,material:n.green,matrix:function(){var t=E.translateMat4c(.07,0,-.8,E.identityMat4()),e=E.scaleMat4v([.6,.6,.6],E.identityMat4()),i=E.rotationMat4v(90*E.DEGTORAD,[0,0,1],E.identityMat4());return E.mulMat4(E.mulMat4(t,e,E.identityMat4()),i,E.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),yCurveArrow2:o.addChild(new Hi(o,{geometry:a.arrowHead,material:n.green,matrix:function(){var t=E.translateMat4c(.8,0,-.07,E.identityMat4()),e=E.scaleMat4v([.6,.6,.6],E.identityMat4()),i=E.rotationMat4v(90*E.DEGTORAD,[1,0,0],E.identityMat4());return E.mulMat4(E.mulMat4(t,e,E.identityMat4()),i,E.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),zCurve:o.addChild(new Hi(o,{geometry:a.curve,material:n.blue,matrix:E.rotationMat4v(180*E.DEGTORAD,[1,0,0],E.identityMat4()),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),zCurveHandle:o.addChild(new Hi(o,{geometry:a.curveHandle,material:n.pickable,matrix:E.rotationMat4v(180*E.DEGTORAD,[1,0,0],E.identityMat4()),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),zCurveCurveArrow1:o.addChild(new Hi(o,{geometry:a.arrowHead,material:n.blue,matrix:function(){var t=E.translateMat4c(.8,-.07,0,E.identityMat4()),e=E.scaleMat4v([.6,.6,.6],E.identityMat4());return E.mulMat4(t,e,E.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),zCurveArrow2:o.addChild(new Hi(o,{geometry:a.arrowHead,material:n.blue,matrix:function(){var t=E.translateMat4c(.05,-.8,0,E.identityMat4()),e=E.scaleMat4v([.6,.6,.6],E.identityMat4()),i=E.rotationMat4v(90*E.DEGTORAD,[0,0,1],E.identityMat4());return E.mulMat4(E.mulMat4(t,e,E.identityMat4()),i,E.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),center:o.addChild(new Hi(o,{geometry:new ke(o,qi({radius:.05})),material:n.center,pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),xAxisArrow:o.addChild(new Hi(o,{geometry:a.arrowHead,material:n.red,matrix:function(){var t=E.translateMat4c(0,1.1,0,E.identityMat4()),e=E.rotationMat4v(-90*E.DEGTORAD,[0,0,1],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),xAxisArrowHandle:o.addChild(new Hi(o,{geometry:a.arrowHeadHandle,material:n.pickable,matrix:function(){var t=E.translateMat4c(0,1.1,0,E.identityMat4()),e=E.rotationMat4v(-90*E.DEGTORAD,[0,0,1],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),xAxis:o.addChild(new Hi(o,{geometry:a.axis,material:n.red,matrix:function(){var t=E.translateMat4c(0,.5,0,E.identityMat4()),e=E.rotationMat4v(-90*E.DEGTORAD,[0,0,1],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),xAxisHandle:o.addChild(new Hi(o,{geometry:a.axisHandle,material:n.pickable,matrix:function(){var t=E.translateMat4c(0,.5,0,E.identityMat4()),e=E.rotationMat4v(-90*E.DEGTORAD,[0,0,1],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),yAxisArrow:o.addChild(new Hi(o,{geometry:a.arrowHead,material:n.green,matrix:function(){var t=E.translateMat4c(0,1.1,0,E.identityMat4()),e=E.rotationMat4v(180*E.DEGTORAD,[1,0,0],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),yAxisArrowHandle:o.addChild(new Hi(o,{geometry:a.arrowHeadHandle,material:n.pickable,matrix:function(){var t=E.translateMat4c(0,1.1,0,E.identityMat4()),e=E.rotationMat4v(180*E.DEGTORAD,[1,0,0],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,opacity:.2}),t),yShaft:o.addChild(new Hi(o,{geometry:a.axis,material:n.green,position:[0,-.5,0],pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),yShaftHandle:o.addChild(new Hi(o,{geometry:a.axisHandle,material:n.pickable,position:[0,-.5,0],pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),zAxisArrow:o.addChild(new Hi(o,{geometry:a.arrowHead,material:n.blue,matrix:function(){var t=E.translateMat4c(0,1.1,0,E.identityMat4()),e=E.rotationMat4v(-90*E.DEGTORAD,[.8,0,0],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),zAxisArrowHandle:o.addChild(new Hi(o,{geometry:a.arrowHeadHandle,material:n.pickable,matrix:function(){var t=E.translateMat4c(0,1.1,0,E.identityMat4()),e=E.rotationMat4v(-90*E.DEGTORAD,[.8,0,0],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),zShaft:o.addChild(new Hi(o,{geometry:a.axis,material:n.blue,matrix:function(){var t=E.translateMat4c(0,.5,0,E.identityMat4()),e=E.rotationMat4v(-90*E.DEGTORAD,[1,0,0],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),clippable:!1,pickable:!1,collidable:!0,visible:!1}),t),zAxisHandle:o.addChild(new Hi(o,{geometry:a.axisHandle,material:n.pickable,matrix:function(){var t=E.translateMat4c(0,.5,0,E.identityMat4()),e=E.rotationMat4v(-90*E.DEGTORAD,[1,0,0],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),clippable:!1,pickable:!0,collidable:!0,visible:!1}),t)},this._affordanceMeshes={planeFrame:o.addChild(new Hi(o,{geometry:new ke(o,il({center:[0,0,0],radius:2,tube:i,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new je(o,{ambient:[1,1,1],diffuse:[0,0,0],emissive:[1,1,0]}),highlighted:!0,highlightMaterial:new Xe(o,{edges:!1,filled:!0,fillColor:[1,1,0],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,1],rotation:[0,0,45]}),t),xHoop:o.addChild(new Hi(o,{geometry:a.hoop,material:n.red,highlighted:!0,highlightMaterial:n.highlightRed,matrix:function(){var t=E.rotationMat4v(90*E.DEGTORAD,[0,1,0],E.identityMat4()),e=E.rotationMat4v(270*E.DEGTORAD,[1,0,0],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),yHoop:o.addChild(new Hi(o,{geometry:a.hoop,material:n.green,highlighted:!0,highlightMaterial:n.highlightGreen,rotation:[-90,0,0],pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),zHoop:o.addChild(new Hi(o,{geometry:a.hoop,material:n.blue,highlighted:!0,highlightMaterial:n.highlightBlue,matrix:E.rotationMat4v(180*E.DEGTORAD,[1,0,0],E.identityMat4()),pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),t),xAxisArrow:o.addChild(new Hi(o,{geometry:a.arrowHeadBig,material:n.red,matrix:function(){var t=E.translateMat4c(0,1.1,0,E.identityMat4()),e=E.rotationMat4v(-90*E.DEGTORAD,[0,0,1],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),yAxisArrow:o.addChild(new Hi(o,{geometry:a.arrowHeadBig,material:n.green,matrix:function(){var t=E.translateMat4c(0,1.1,0,E.identityMat4()),e=E.rotationMat4v(180*E.DEGTORAD,[1,0,0],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),zAxisArrow:o.addChild(new Hi(o,{geometry:a.arrowHeadBig,material:n.blue,matrix:function(){var t=E.translateMat4c(0,1.1,0,E.identityMat4()),e=E.rotationMat4v(-90*E.DEGTORAD,[.8,0,0],E.identityMat4());return E.mulMat4(e,t,E.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t)}},ol.prototype._bindEvents=function(){var t=this,e=this,i=!1,r=-1,s=0,o=1,a=2,n=3,l=4,h=5,u=this._rootNode,c=null,p=null,d=E.vec2(),f=E.vec3([1,0,0]),_=E.vec3([0,1,0]),g=E.vec3([0,0,1]),m=this._viewer.scene.canvas.canvas,v=this._viewer.camera,b=this._viewer.scene,y=E.vec3([0,0,0]),P=-1;this._onCameraViewMatrix=b.camera.on("viewMatrix",(function(){})),this._onCameraProjMatrix=b.camera.on("projMatrix",(function(){})),this._onSceneTick=b.on("tick",(function(){var e=Math.abs(E.lenVec3(E.subVec3(b.camera.eye,t._pos,y)));if(e!==P&&"perspective"===v.projection){var i=.07*(Math.tan(v.perspective.fov*E.DEGTORAD)*e);u.scale=[i,i,i],P=e}if("ortho"===v.projection){var r=v.ortho.scale/10;u.scale=[r,r,r],P=e}}));var M,x,w,C,A,S,D,L=function(){var t=new Float64Array(2);return function(e){if(e){for(var i=e.target,r=0,s=0;i.offsetParent;)r+=i.offsetLeft,s+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-r,t[1]=e.pageY-s}else e=window.event,t[0]=e.x,t[1]=e.y;return t}}(),B=function(){var t=E.mat4();return function(i,r){return E.quaternionToMat4(e._rootNode.quaternion,t),E.transformVec3(t,i,r),E.normalizeVec3(r),r}}(),R=(M=E.vec3(),function(t){var e=Math.abs(t[0]);return e>Math.abs(t[1])&&e>Math.abs(t[2])?E.cross3Vec3(t,[0,1,0],M):E.cross3Vec3(t,[1,0,0],M),E.cross3Vec3(M,t,M),E.normalizeVec3(M),M}),T=(x=E.vec3(),w=E.vec3(),C=E.vec4(),function(t,i,r){B(t,C);var s=R(C,i,r);N(i,s,x),N(r,s,w),E.subVec3(w,x);var o=E.dotVec3(w,C);e._pos[0]+=C[0]*o,e._pos[1]+=C[1]*o,e._pos[2]+=C[2]*o,e._rootNode.position=e._pos,e._sectionPlane&&(e._sectionPlane.pos=e._pos)}),F=function(){var t=E.vec4(),i=E.vec4(),r=E.vec4(),s=E.vec4();return function(o,a,n){if(B(o,s),!(N(a,s,t)&&N(n,s,i))){var l=R(s,a,n);N(a,l,t,1),N(n,l,i,1);var h=E.dotVec3(t,s);t[0]-=h*s[0],t[1]-=h*s[1],t[2]-=h*s[2],h=E.dotVec3(i,s),i[0]-=h*s[0],i[1]-=h*s[1],i[2]-=h*s[2]}E.normalizeVec3(t),E.normalizeVec3(i),h=E.dotVec3(t,i),h=E.clamp(h,-1,1);var u=Math.acos(h)*E.RADTODEG;E.cross3Vec3(t,i,r),E.dotVec3(r,s)<0&&(u=-u),e._rootNode.rotate(o,u),I()}}(),N=(A=E.vec4([0,0,0,1]),S=E.mat4(),function(t,i,r,s){s=s||0,A[0]=t[0]/m.width*2-1,A[1]=-(t[1]/m.height*2-1),A[2]=0,A[3]=1,E.mulMat4(v.projMatrix,v.viewMatrix,S),E.inverseMat4(S),E.transformVec4(S,A,A),E.mulVec4Scalar(A,1/A[3]);var o=v.eye;E.subVec4(A,o,A);var a=e._sectionPlane.pos,n=-E.dotVec3(a,i)-s,l=E.dotVec3(i,A);if(Math.abs(l)>.005){var h=-(E.dotVec3(i,o)+n)/l;return E.mulVec3Scalar(A,h,r),E.addVec3(r,o),E.subVec3(r,a,r),!0}return!1}),I=function(){var t=E.vec3(),i=E.mat4();return function(){e.sectionPlane&&(E.quaternionToMat4(u.quaternion,i),E.transformVec3(i,[0,0,1],t),e._setSectionPlaneDir(t))}}(),k=!1;this._onCameraControlHover=this._viewer.cameraControl.on("hoverEnter",(function(e){if(t._visible&&!k){var u;switch(i=!1,D&&(D.visible=!1),e.entity.id){case t._displayMeshes.xAxisArrowHandle.id:case t._displayMeshes.xAxisHandle.id:u=t._affordanceMeshes.xAxisArrow,c=s;break;case t._displayMeshes.yAxisArrowHandle.id:case t._displayMeshes.yShaftHandle.id:u=t._affordanceMeshes.yAxisArrow,c=o;break;case t._displayMeshes.zAxisArrowHandle.id:case t._displayMeshes.zAxisHandle.id:u=t._affordanceMeshes.zAxisArrow,c=a;break;case t._displayMeshes.xCurveHandle.id:u=t._affordanceMeshes.xHoop,c=n;break;case t._displayMeshes.yCurveHandle.id:u=t._affordanceMeshes.yHoop,c=l;break;case t._displayMeshes.zCurveHandle.id:u=t._affordanceMeshes.zHoop,c=h;break;default:return void(c=r)}u&&(u.visible=!0),D=u,i=!0}})),this._onCameraControlHoverLeave=this._viewer.cameraControl.on("hoverOut",(function(e){t._visible&&(D&&(D.visible=!1),D=null,c=r)})),m.addEventListener("mousedown",this._canvasMouseDownListener=function(e){if(e.preventDefault(),t._visible&&i)switch(t._viewer.cameraControl.pointerEnabled=!1,e.which){case 1:k=!0;var r=L(e);p=c,d[0]=r[0],d[1]=r[1]}}),m.addEventListener("mousemove",this._canvasMouseMoveListener=function(e){if(t._visible&&k){var i=L(e),r=i[0],u=i[1];switch(p){case s:T(f,d,i);break;case o:T(_,d,i);break;case a:T(g,d,i);break;case n:F(f,d,i);break;case l:F(_,d,i);break;case h:F(g,d,i)}d[0]=r,d[1]=u}}),m.addEventListener("mouseup",this._canvasMouseUpListener=function(e){t._visible&&(t._viewer.cameraControl.pointerEnabled=!0,k&&(e.which,k=!1,i=!1))}),m.addEventListener("wheel",this._canvasWheelListener=function(e){if(t._visible)Math.max(-1,Math.min(1,40*-e.deltaY))})},ol.prototype._destroy=function(){this._unbindEvents(),this._destroyNodes()},ol.prototype._unbindEvents=function(){var t=this._viewer,e=t.scene,i=e.canvas.canvas,r=t.camera,s=t.cameraControl;e.off(this._onSceneTick),i.removeEventListener("mousedown",this._canvasMouseDownListener),i.removeEventListener("mousemove",this._canvasMouseMoveListener),i.removeEventListener("mouseup",this._canvasMouseUpListener),i.removeEventListener("wheel",this._canvasWheelListener),r.off(this._onCameraViewMatrix),r.off(this._onCameraProjMatrix),s.off(this._onCameraControlHover),s.off(this._onCameraControlHoverLeave)},ol.prototype._destroyNodes=function(){this._setSectionPlane(null),this._rootNode.destroy(),this._displayMeshes={},this._affordanceMeshes={}},Object.defineProperties(ol.prototype,al);var nl=function(t,e,i){var r=this;this.id=i.id,this._sectionPlane=i,this._mesh=new Hi(e,{id:i.id,geometry:new ke(e,Oe({xSize:.5,ySize:.5,zSize:.001})),material:new je(e,{emissive:[1,1,1],diffuse:[0,0,0],backfaces:!1}),edgeMaterial:new He(e,{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),highlightMaterial:new Xe(e,{fill:!0,fillColor:[.5,1,.5],fillAlpha:.7,edges:!0,edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),selectedMaterial:new Xe(e,{fill:!0,fillColor:[0,0,1],fillAlpha:.7,edges:!0,edgeColor:[1,0,0],edgeAlpha:1,edgeWidth:1}),highlighted:!0,scale:[3,3,3],position:[0,0,0],rotation:[0,0,0],opacity:.3,edges:!0});var s=E.vec3([0,0,0]),o=E.vec3(),a=E.vec3([0,0,1]),n=E.vec4(4),l=E.vec3(),h=function(){var t=r._sectionPlane.scene.center,e=[-r._sectionPlane.dir[0],-r._sectionPlane.dir[1],-r._sectionPlane.dir[2]];E.subVec3(t,r._sectionPlane.pos,s);var i=-E.dotVec3(e,s);E.normalizeVec3(e),E.mulVec3Scalar(e,i,o);var h=E.vec3PairToQuaternion(a,r._sectionPlane.dir,n);l[0]=.1*o[0],l[1]=.1*o[1],l[2]=.1*o[2],r._mesh.quaternion=h,r._mesh.position=l};this._onSectionPlanePos=this._sectionPlane.on("pos",h),this._onSectionPlaneDir=this._sectionPlane.on("dir",h),this._highlighted=!1,this._selected=!1};nl.prototype.setHighlighted=function(t){this._highlighted=!!t,this._mesh.highlighted=this._highlighted,this._mesh.highlightMaterial.fillColor=t?[0,.7,0]:[0,0,0]},nl.prototype.getHighlighted=function(){return this._highlighted},nl.prototype.setSelected=function(t){this._selected=!!t,this._mesh.edgeMaterial.edgeWidth=t?3:1,this._mesh.highlightMaterial.edgeWidth=t?3:1},nl.prototype.getSelected=function(){return this._selected},nl.prototype.destroy=function(){this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._mesh.destroy()};var ll=function(t,e){var i=this;if(!(e.onHoverEnterPlane&&e.onHoverLeavePlane&&e.onClickedNothing&&e.onClickedPlane))throw"Missing config(s): onHoverEnterPlane, onHoverLeavePlane, onClickedNothing || onClickedPlane";this.plugin=t,this._viewer=t.viewer,this._onHoverEnterPlane=e.onHoverEnterPlane,this._onHoverLeavePlane=e.onHoverLeavePlane,this._onClickedNothing=e.onClickedNothing,this._onClickedPlane=e.onClickedPlane,this._visible=!0,this._planes={},this._canvas=e.overviewCanvas,this._scene=new ei(this._viewer,{canvasId:this._canvas.id,transparent:!0}),this._scene.clearLights(),new Ee(this._scene,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new Ee(this._scene,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new Ee(this._scene,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._scene.camera,this._scene.camera.perspective.fov=70,this._zUp=!1;var r=this._scene.camera,s=E.rotationMat4c(-90*E.DEGTORAD,1,0,0),o=E.vec3(),a=E.vec3(),n=E.vec3();this._synchCamera=function(){var t=i._viewer.camera.eye,e=i._viewer.camera.look,l=i._viewer.camera.up;E.mulVec3Scalar(E.normalizeVec3(E.subVec3(t,e,o)),7),i._zUp?(E.transformVec3(s,o,a),E.transformVec3(s,l,n),r.look=[0,0,0],r.eye=E.transformVec3(s,o,a),r.up=E.transformPoint3(s,l,n)):(r.look=[0,0,0],r.eye=o,r.up=l)},this._onViewerCameraMatrix=this._viewer.camera.on("matrix",this._synchCamera),this._onViewerCameraWorldAxis=this._viewer.camera.on("worldAxis",this._synchCamera),this._onViewerCameraFOV=this._viewer.camera.perspective.on("fov",(function(t){i._scene.camera.perspective.fov=t}));var l=null;this._onInputMouseMove=this._scene.input.on("mousemove",(function(t){var e=i._scene.pick({canvasPos:t});if(e){if(!l||e.entity.id!==l.id){if(l)i._planes[l.id]&&i._onHoverLeavePlane(l.id);l=e.entity,i._planes[l.id]&&i._onHoverEnterPlane(l.id)}}else l&&(i._onHoverLeavePlane(l.id),l=null)})),this._scene.canvas.canvas.addEventListener("mouseup",this._onCanvasMouseUp=function(){l?i._planes[l.id]&&i._onClickedPlane(l.id):i._onClickedNothing()}),this._scene.canvas.canvas.addEventListener("mouseout",this._onCanvasMouseOut=function(){l&&(i._onHoverLeavePlane(l.id),l=null)}),this.setVisible(e.overviewVisible)};ll.prototype.addSectionPlane=function(t){this._planes[t.id]=new nl(this,this._scene,t)},ll.prototype.setPlaneHighlighted=function(t,e){var i=this._planes[t];i&&i.setHighlighted(e)},ll.prototype.setPlaneSelected=function(t,e){var i=this._planes[t];i&&i.setSelected(e)},ll.prototype.removeSectionPlane=function(t){var e=this._planes[t.id];e&&(e.destroy(),delete this._planes[t.id])},ll.prototype.setVisible=function(t){void 0===t&&(t=!0),this._visible=t,this._canvas.style.visibility=t?"visible":"hidden"},ll.prototype.getVisible=function(){return this._visible},ll.prototype.destroy=function(){this._viewer.camera.off(this._onViewerCameraMatrix),this._viewer.camera.off(this._onViewerCameraWorldAxis),this._viewer.camera.perspective.off(this._onViewerCameraFOV),this._scene.input.off(this._onInputMouseMove),this._scene.canvas.canvas.removeEventListener("mouseup",this._onCanvasMouseUp),this._scene.canvas.canvas.removeEventListener("mouseout",this._onCanvasMouseOut),this._scene.destroy()};var hl=E.AABB3(),ul=E.vec3(),cl=function(t){function e(e,i){var r=this;if(void 0===i&&(i={}),t.call(this,"SectionPlanes",e),this._freeControls=[],this._sectionPlanes=e.scene.sectionPlanes,this._controls={},this._shownControlId=null,null!==i.overviewCanvasId&&void 0!==i.overviewCanvasId){var s=document.getElementById(i.overviewCanvasId);s?this._overview=new ll(this,{overviewCanvas:s,visible:i.overviewVisible,onHoverEnterPlane:function(t){r._overview.setPlaneHighlighted(t,!0)},onHoverLeavePlane:function(t){r._overview.setPlaneHighlighted(t,!1)},onClickedPlane:function(t){if(r.getShownControl()!==t){r.showControl(t);var e=r.sectionPlanes[t].pos;hl.set(r.viewer.scene.aabb),E.getAABB3Center(hl,ul),hl[0]+=e[0]-ul[0],hl[1]+=e[1]-ul[1],hl[2]+=e[2]-ul[2],hl[3]+=e[0]-ul[0],hl[4]+=e[1]-ul[1],hl[5]+=e[2]-ul[2],r.viewer.cameraFlight.flyTo({aabb:hl,fitFOV:65})}else r.hideControl()},onClickedNothing:function(){r.hideControl()}}):this.warn("Can't find overview canvas: '"+i.overviewCanvasId+"' - will create plugin without overview")}this._onSceneSectionPlaneCreated=e.scene.on("sectionPlaneCreated",(function(t){r._sectionPlaneCreated(t)}))}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={sectionPlanes:{configurable:!0}};return e.prototype.setOverviewVisible=function(t){this._overview&&this._overview.setVisible(t)},e.prototype.getOverviewVisible=function(){if(this._overview)return this._overview.getVisible()},i.sectionPlanes.get=function(){return this._sectionPlanes},e.prototype.createSectionPlane=function(t){return void 0===t&&(t={}),void 0!==t.id&&null!==t.id&&this.viewer.scene.components[t.id]&&(this.error("Viewer component with this ID already exists: "+t.id),delete t.id),new $i(this.viewer.scene,{id:t.id,pos:t.pos,dir:t.dir,active:!0})},e.prototype._sectionPlaneCreated=function(t){var e=this,i=this._freeControls.length>0?this._freeControls.pop():new ol(this);i._setSectionPlane(t),i.setVisible(!1),this._controls[t.id]=i,this._overview&&this._overview.addSectionPlane(t),t.once("destroyed",(function(){e._sectionPlaneDestroyed(t)}))},e.prototype.flipSectionPlanes=function(){var t=this.viewer.scene.sectionPlanes;for(var e in t){t[e].flipDir()}},e.prototype.showControl=function(t){var e=this._controls[t];e?(this.hideControl(),e.setVisible(!0),this._overview&&this._overview.setPlaneSelected(t,!0),this._shownControlId=t):this.error("Control not found: "+t)},e.prototype.getShownControl=function(){return this._shownControlId},e.prototype.hideControl=function(){for(var t in this._controls)this._controls.hasOwnProperty(t)&&(this._controls[t].setVisible(!1),this._overview&&this._overview.setPlaneSelected(t,!1));this._shownControlId=null},e.prototype.destroySectionPlane=function(t){var e=this.viewer.scene.sectionPlanes[t];e?(this._sectionPlaneDestroyed(e),e.destroy(),t===this._shownControlId&&(this._shownControlId=null)):this.error("SectionPlane not found: "+t)},e.prototype._sectionPlaneDestroyed=function(t){this._overview&&this._overview.removeSectionPlane(t);var e=this._controls[t.id];e&&(e.setVisible(!1),e._setSectionPlane(null),delete this._controls[t.id],this._freeControls.push(e))},e.prototype.clear=function(){for(var t=Object.keys(this._sectionPlanes),e=0,i=t.length;e<i;e++)this.destroySectionPlane(t[e])},e.prototype.send=function(t,e){switch(t){case"snapshotStarting":for(var i in this._controls)this._controls.hasOwnProperty(i)&&this._controls[i].setCulled(!0);break;case"snapshotFinished":for(var r in this._controls)this._controls.hasOwnProperty(r)&&this._controls[r].setCulled(!1);break;case"clearSectionPlanes":this.clear()}},e.prototype.destroy=function(){this.clear(),this._overview&&this._overview.destroy(),this._destroyFreeControls(),t.prototype.destroy.call(this)},e.prototype._destroyFreeControls=function(){for(var t=this._freeControls.pop();t;)t._destroy(),t=this._freeControls.pop();this.viewer.scene.off(this._onSceneSectionPlaneCreated)},Object.defineProperties(e.prototype,i),e}(n),pl=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._skyboxMesh=new Hi(this,{geometry:new ke(this,{primitive:"triangles",positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),scale:[2e3,2e3,2e3],rotation:[0,-90,0],material:new je(this,{ambient:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],emissive:[1,1,1],emissiveMap:new In(this,{src:i.src,flipY:!0,encoding:i.encoding||"sRGB"}),backfaces:!0}),visible:!1,pickable:!1,collidable:!1}),this.size=i.size,this.active=i.active}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={size:{configurable:!0},active:{configurable:!0}};return i.size.set=function(t){this._size=t||1e3,this._skyboxMesh.scale=[this._size,this._size,this._size]},i.size.get=function(){return this._size},i.active.set=function(t){this._skyboxMesh.visible=t},i.active.get=function(){return this._skyboxMesh.visible},Object.defineProperties(e.prototype,i),e}(U),dl=function(t){function e(e){t.call(this,"skyboxes",e),this.skyboxes={}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.send=function(t,e){switch(t){case"clear":this.clear()}},e.prototype.createSkybox=function(t,e){if(this.viewer.scene.components[t])return this.error("Component with this ID already exists: "+t),this;var i=new pl(this.viewer.scene,{id:t,pos:e.pos,dir:e.dir,active:!0});return this.skyboxes[t]=i,i},e.prototype.destroySkybox=function(t){var e=this.skyboxes[t];e?e.destroy():this.error("Skybox not found: "+t)},e.prototype.clear=function(){for(var t=Object.keys(this.viewer.scene.skyboxes),e=0,i=t.length;e<i;e++)this.destroySkybox(t[e])},e.prototype.destroy=function(){this.clear(),t.prototype.clear.call(this)},e}(n),fl=function(){};fl.prototype.getSTL=function(t,e,i){var r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.open("GET",t,!0),r.responseType="arraybuffer",r.onreadystatechange=function(){4===r.readyState&&(200===r.status?e(r.response):i(r.statusText))},r.send(null)};var _l=E.vec3(),gl=function(){};function ml(t){var e=new DataView(t);if(84+50*e.getUint32(80,!0)===e.byteLength)return!0;for(var i=[115,111,108,105,100],r=0;r<5;r++)if(i[r]!==e.getUint8(r,!1))return!0;return!1}function vl(t,e,i,r){for(var s,o,a,n,l,h,u,c=new DataView(e),p=c.getUint32(80,!0),d=!1,f=null,_=null,g=null,m=!1,v=0;v<70;v++)1129270351===c.getUint32(v,!1)&&82===c.getUint8(v+4)&&61===c.getUint8(v+5)&&(d=!0,n=[],l=c.getUint8(v+6)/255,h=c.getUint8(v+7)/255,u=c.getUint8(v+8)/255,c.getUint8(v+9));for(var b=new En(i,{roughness:.5}),y=[],P=[],M=r.splitMeshes,x=0;x<p;x++){var w=84+50*x,E=c.getFloat32(w,!0),C=c.getFloat32(w+4,!0),A=c.getFloat32(w+8,!0);if(d){var S=c.getUint16(w+48,!0);0==(32768&S)?(s=(31&S)/31,o=(S>>5&31)/31,a=(S>>10&31)/31):(s=l,o=h,a=u),(M&&s!==f||o!==_||a!==g)&&(null!==f&&(m=!0),f=s,_=o,g=a)}for(var D=1;D<=3;D++){var L=w+12*D;y.push(c.getFloat32(L,!0)),y.push(c.getFloat32(L+4,!0)),y.push(c.getFloat32(L+8,!0)),P.push(E,C,A),d&&n.push(s,o,a,1)}M&&m&&(yl(i,y,P,n,b,r),y=[],P=[],n=n?[]:null,m=!1)}y.length>0&&yl(i,y,P,n,b,r)}function bl(t,e,i,r){for(var s,o,a,n,l,h,u,c=/facet([\s\S]*?)endfacet/g,p=0,d=/[\s]+([+-]?(?:\d+.\d+|\d+.|\d+|.\d+)(?:[eE][+-]?\d+)?)/.source,f=new RegExp("vertex"+d+d+d,"g"),_=new RegExp("normal"+d+d+d,"g"),g=[],m=[];null!==(n=c.exec(e));){for(l=0,h=0,u=n[0];null!==(n=_.exec(u));)s=parseFloat(n[1]),o=parseFloat(n[2]),a=parseFloat(n[3]),h++;for(;null!==(n=f.exec(u));)g.push(parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3])),m.push(s,o,a),l++;1!==h&&t.error("Error in normal of face "+p),3!==l&&t.error("Error in positions of face "+p),p++}yl(i,g,m,null,new En(i,{roughness:.5}),r)}function yl(t,e,i,r,s,o){for(var a=new Int32Array(e.length/3),n=0,l=a.length;n<l;n++)a[n]=n;i=i&&i.length>0?i:null,r=r&&r.length>0?r:null,o.smoothNormals&&E.faceToVertexNormals(e,i,o);var h=_l;ot(e,e,h);var u=new ke(t,{primitive:"triangles",positions:e,normals:i,colors:r,indices:a}),c=new Hi(t,{rtcCenter:0!==h[0]||0!==h[1]||0!==h[2]?h:null,geometry:u,material:s,edges:o.edges});t.addChild(c)}function Pl(t){return"string"!=typeof t?function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);for(var e="",i=0,r=t.length;i<r;i++)e+=String.fromCharCode(t[i]);return decodeURIComponent(escape(e))}(new Uint8Array(t)):t}function Ml(t){if("string"==typeof t){for(var e=new Uint8Array(t.length),i=0;i<t.length;i++)e[i]=255&t.charCodeAt(i);return e.buffer||e}return t}gl.prototype.load=function(t,e,i,r,s,o){r=r||{};var a=t.viewer.scene.canvas.spinner;a.processes++,t.dataSource.getSTL(i,(function(i){!function(t,e,i,r){try{var s=Ml(i);ml(s)?vl(t,s,e,r):bl(t,Pl(i),e,r)}catch(t){e.fire("error",t)}}(t,e,i,r);try{var n=Ml(i);ml(n)?vl(t,n,e,r):bl(t,Pl(i),e,r),a.processes--,V.scheduleTask((function(){e.fire("loaded",!0,!1)})),s&&s()}catch(i){a.processes--,t.error(i),o&&o(i),e.fire("error",i)}}),(function(i){a.processes--,t.error(i),o&&o(i),e.fire("error",i)}))},gl.prototype.parse=function(t,e,i,r){var s=t.viewer.scene.canvas.spinner;s.processes++;try{var o=Ml(i);ml(o)?vl(t,o,e,r):bl(t,Pl(i),e,r),s.processes--,V.scheduleTask((function(){e.fire("loaded",!0,!1)}))}catch(t){s.processes--,e.fire("error",t)}};var xl=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,"STLLoader",e,i),this._sceneGraphLoader=new gl,this.dataSource=i.dataSource}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={dataSource:{configurable:!0}};return i.dataSource.set=function(t){this._dataSource=t||new fl},i.dataSource.get=function(){return this._dataSource},e.prototype.load=function(t){t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);var e=new mn(this.viewer.scene,B.apply(t,{isModel:!0})),i=t.src,r=t.stl;return i||r?(i?this._sceneGraphLoader.load(this,e,i,t):this._sceneGraphLoader.parse(this,e,r,t),e):(this.error("load() param expected: either 'src' or 'stl'"),e)},Object.defineProperties(e.prototype,i),e}(n),wl=function(t,e,i,r,s){this.plugin=t,this.storeyId=r,this.modelId=i,this.aabb=e.slice(),this.numObjects=s},El={IfcSlab:{visible:!0,edges:!1,colorize:[1,1,1,1]},IfcWall:{visible:!0,edges:!1,colorize:[.1,.1,.1,1]},IfcWallStandardCase:{visible:!0,edges:!1,colorize:[.1,.1,.1,1]},IfcDoor:{visible:!0,edges:!1,colorize:[.5,.5,.5,1]},IfcWindow:{visible:!0,edges:!1,colorize:[.5,.5,.5,1]},IfcColumn:{visible:!0,edges:!1,colorize:[.5,.5,.5,1]},IfcCurtainWall:{visible:!0,edges:!1,colorize:[.5,.5,.5,1]},IfcStair:{visible:!0,edges:!1,colorize:[.7,.7,.7,1]},IfcStairFlight:{visible:!0,edges:!1,colorize:[.7,.7,.7,1]},IfcRamp:{visible:!0,edges:!1,colorize:[.7,.7,.7,1]},IfcFurniture:{visible:!0,edges:!1,colorize:[.7,.7,.7,1]},IfcFooting:{visible:!0,edges:!1,colorize:[.7,.7,.7,1]},IfcFloor:{visible:!0,edges:!1,colorize:[1,1,1,1]},DEFAULT:{visible:!1}},Cl=E.vec3(),Al=function(){this.objectsVisible=[],this.objectsEdges=[],this.objectsXrayed=[],this.objectsHighlighted=[],this.objectsSelected=[],this.objectsClippable=[],this.objectsPickable=[],this.objectsColorize=[],this.objectsHasColorize=[],this.objectsOpacity=[],this.numObjects=0};Al.prototype.saveObjects=function(t,e){this.numObjects=0,this._mask=e?B.apply(e,{}):null;var i=t.objects,r=!e||e.visible,s=!e||e.edges,o=!e||e.xrayed,a=!e||e.highlighted,n=!e||e.selected,l=!e||e.clippable,h=!e||e.pickable,u=!e||e.colorize,c=!e||e.opacity;for(var p in i)if(i.hasOwnProperty(p)){var d=i[p],f=this.numObjects;if(r&&(this.objectsVisible[f]=d.visible),s&&(this.objectsEdges[f]=d.edges),o&&(this.objectsXrayed[f]=d.xrayed),a&&(this.objectsHighlighted[f]=d.highlighted),n&&(this.objectsSelected[f]=d.selected),l&&(this.objectsClippable[f]=d.clippable),h&&(this.objectsPickable[f]=d.pickable),u){var _=d.colorize;_?(this.objectsColorize[3*f+0]=_[0],this.objectsColorize[3*f+1]=_[1],this.objectsColorize[3*f+2]=_[2],this.objectsHasColorize[f]=!0):this.objectsHasColorize[f]=!1}c&&(this.objectsOpacity[f]=d.opacity),this.numObjects++}},Al.prototype.restoreObjects=function(t){var e=this._mask,i=!e||e.visible,r=!e||e.edges,s=!e||e.xrayed,o=!e||e.highlighted,a=!e||e.selected,n=!e||e.clippable,l=!e||e.pickable,h=!e||e.colorize,u=!e||e.opacity,c=0,p=t.objects;for(var d in p)if(p.hasOwnProperty(d)){var f=p[d];i&&(f.visible=this.objectsVisible[c]),r&&(f.edges=this.objectsEdges[c]),s&&(f.xrayed=this.objectsXrayed[c]),o&&(f.highlighted=this.objectsHighlighted[c]),a&&(f.selected=this.objectsSelected[c]),n&&(f.clippable=this.objectsClippable[c]),l&&(f.pickable=this.objectsPickable[c]),h&&(this.objectsHasColorize[c]?(Cl[0]=this.objectsColorize[3*c+0],Cl[1]=this.objectsColorize[3*c+1],Cl[2]=this.objectsColorize[3*c+2],f.colorize=Cl):f.colorize=null),u&&(f.opacity=this.objectsOpacity[c]),c++}};var Sl=function(t){this._eye=E.vec3(),this._look=E.vec3(),this._up=E.vec3(),this._projection={},t&&this.saveCamera(t)};Sl.prototype.saveCamera=function(t){var e=t.camera,i=e.project;switch(this._eye.set(e.eye),this._look.set(e.look),this._up.set(e.up),e.projection){case"perspective":this._projection={projection:"perspective",fov:i.fov,fovAxis:i.fovAxis,near:i.near,far:i.far};break;case"ortho":this._projection={projection:"ortho",scale:i.scale,near:i.near,far:i.far};break;case"frustum":this._projection={projection:"frustum",left:i.left,right:i.right,top:i.top,bottom:i.bottom,near:i.near,far:i.far};break;case"custom":this._projection={projection:"custom",matrix:i.matrix.slice()}}},Sl.prototype.restoreCamera=function(t,e){var i=t.camera,r=this._projection;function s(){switch(r.type){case"perspective":i.perspective.fov=r.fov,i.perspective.fovAxis=r.fovAxis,i.perspective.near=r.near,i.perspective.far=r.far;break;case"ortho":i.ortho.scale=r.scale,i.ortho.near=r.near,i.ortho.far=r.far;break;case"frustum":i.frustum.left=r.left,i.frustum.right=r.right,i.frustum.top=r.top,i.frustum.bottom=r.bottom,i.frustum.near=r.near,i.frustum.far=r.far;break;case"custom":i.customProjection.matrix=r.matrix}}e?t.viewer.cameraFlight.flyTo({eye:this._eye,look:this._look,up:this._up,orthoScale:r.scale,projection:r.projection},(function(){s(),e()})):(i.eye=this._eye,i.look=this._look,i.up=this._up,s(),i.projection=r.projection)};var Dl=function(t,e,i,r,s,o){this.storeyId=t,this.imageData=e,this.format=i,this.width=r,this.height=s},Ll=E.vec3(),Bl=E.mat4(),Rl=function(t){function e(e,i){var r=this;void 0===i&&(i={}),t.call(this,"StoreyViews",e),this._objectsMemento=new Al,this._cameraMemento=new Sl,this.storeys={},this.modelStoreys={},this.objectStates=i.objectStates,this._onModelLoaded=this.viewer.scene.on("modelLoaded",(function(t){r._registerModelStoreys(t),r.fire("storeys",r.storeys)}))}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={objectStates:{configurable:!0}};return e.prototype._registerModelStoreys=function(t){var e=this,i=this.viewer,r=i.scene,s=i.metaScene,o=s.metaModels[t],a=r.models[t];if(o&&o.rootMetaObject)for(var n=o.rootMetaObject.getObjectIDsInSubtreeByType(["IfcBuildingStorey"]),l=0,h=n.length;l<h;l++){var u=n[l],c=s.metaObjects[u].getObjectIDsInSubtree(),p=r.getAABB(c),d=Math.random()>.5?c.length:0,f=new wl(this,p,t,u,d);f._onModelDestroyed=a.once("destroyed",(function(){e._deregisterModelStoreys(t),e.fire("storeys",e.storeys)})),this.storeys[u]=f,this.modelStoreys[t]||(this.modelStoreys[t]={}),this.modelStoreys[t][u]=f}},e.prototype._deregisterModelStoreys=function(t){var e=this.modelStoreys[t];if(e){var i=this.viewer.scene;for(var r in e)if(e.hasOwnProperty(r)){var s=e[r],o=i.models[s.modelId];o&&o.off(s._onModelDestroyed),delete this.storeys[r]}delete this.modelStoreys[t]}},i.objectStates.set=function(t){this._objectStates=t||El},i.objectStates.get=function(){return this._objectStates},e.prototype.gotoStoreyCamera=function(t,e){void 0===e&&(e={});var i=this.storeys[t];if(!i)return this.error("IfcBuildingStorey not found with this ID: "+t),void(e.done&&e.done());var r=this.viewer,s=r.scene.camera,o=i.aabb;if(o[3]<o[0]||o[4]<o[1]||o[5]<o[2])e.done&&e.done();else if(o[3]!==o[0]||o[4]!==o[1]||o[5]!==o[2]){var a=E.getAABB3Center(o),n=E.getAABB3Diag(o),l=Math.abs(n/Math.tan(45*E.DEGTORAD)),h=1.3*n,u=Ll;u[0]=a[0]+s.worldUp[0]*l,u[1]=a[1]+s.worldUp[1]*l,u[2]=a[2]+s.worldUp[2]*l;var c=s.worldForward;e.done?r.cameraFlight.flyTo(B.apply(e,{eye:u,look:a,up:c,orthoScale:h}),(function(){e.done()})):(r.cameraFlight.jumpTo(B.apply(e,{eye:u,look:a,up:c,orthoScale:h})),r.camera.ortho.scale=h)}else e.done&&e.done()},e.prototype.showStoreyObjects=function(t,e){var i=this;if(void 0===e&&(e={}),this.storeys[t]){var r=this.viewer,s=r.scene;r.metaScene.metaObjects[t]&&(e.hideOthers&&s.setObjectsVisible(r.scene.visibleObjectIds,!1),this.withStoreyObjects(t,(function(t,r){if(t)if(e.useObjectStates){var s=i._objectStates[r.type]||i._objectStates.DEFAULT;s&&(t.visible=s.visible,t.edges=s.edges,s.colorize&&(t.colorize=s.colorize),null!==s.opacity&&void 0!==s.opacity&&(t.opacity=s.opacity))}else t.visible=!0})))}else this.error("IfcBuildingStorey not found with this ID: "+t)},e.prototype.withStoreyObjects=function(t,e){var i=this.viewer,r=i.scene,s=i.metaScene,o=s.metaObjects[t];if(o)for(var a=o.getObjectIDsInSubtree(),n=0,l=a.length;n<l;n++){var h=a[n],u=s.metaObjects[h],c=r.objects[h];c&&e(c,u)}},e.prototype.createStoreyMap=function(t,e){void 0===e&&(e={});var i=this.storeys[t];if(!i)return this.error("IfcBuildingStorey not found with this ID: "+t),"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==";var r,s,o=this.viewer,a=o.scene,n=e.format||"png",l=i.aabb,h=(l[5]-l[2])/(l[3]-l[0]),u=e.padding||0;e.width&&e.height?(r=e.width,s=e.height):e.height?r=(s=e.height)/h:s=e.width?(r=e.width)*h:(r=300)*h,this._objectsMemento.saveObjects(a),this._cameraMemento.saveCamera(a),o.beginSnapshot(),this.showStoreyObjects(t,B.apply(e,{useObjectStates:!0,hideOthers:!0})),this._arrangeStoreyMapCamera(i);var c=o.getSnapshot({width:r,height:s,format:n});return this._objectsMemento.restoreObjects(a),this._cameraMemento.restoreCamera(a),o.endSnapshot(),new Dl(t,c,n,r,s,u)},e.prototype._arrangeStoreyMapCamera=function(t){var e=this.viewer,i=e.scene.camera,r=t.aabb,s=E.getAABB3Center(r),o=Ll;o[0]=s[0]+.5*i.worldUp[0],o[1]=s[1]+.5*i.worldUp[1],o[2]=s[2]+.5*i.worldUp[2];var a=i.worldForward;e.cameraFlight.jumpTo({eye:o,look:s,up:a});var n=(r[3]-r[0])/2,l=(r[4]-r[1])/2,h=(r[5]-r[2])/2,u=-n,c=+n,p=-l,d=+l,f=-h,_=+h;e.camera.customProjection.matrix=E.orthoMat4c(u,c,f,_,p,d,Bl),e.camera.projection="customProjection"},e.prototype.pickStoreyMap=function(t,e,i){void 0===i&&(i={});var r=t.storeyId,s=this.storeys[r];if(!s)return this.error("IfcBuildingStorey not found with this ID: "+r),null;var o=1-e[0]/t.width,a=1-e[1]/t.height,n=s.aabb,l=n[0],h=n[1],u=n[2],c=n[3]-l,p=n[4]-h,d=n[5]-u,f=E.vec3([l+c*o,h+.5*p,u+d*a]),_=E.vec3([0,-1,0]),g=E.addVec3(f,_,Ll),m=this.viewer.camera.worldForward,v=E.lookAtMat4v(f,g,m,Bl),b=this.viewer.scene.pick({pickSurface:i.pickSurface,pickInvisible:!0,matrix:v});if(b){var y=this.viewer.metaScene.metaObjects[b.entity.id],P=this.objectStates[y.type];if(!P||!P.visible)return null}return b},e.prototype.getStoreyContainingWorldPos=function(t){for(var e in this.storeys){var i=this.storeys[e];if(E.point3AABB3Intersect(i.aabb,t))return e}return null},e.prototype.worldPosToStoreyMap=function(t,e,i){var r=t.storeyId,s=this.storeys[r];if(!s)return this.error("IfcBuildingStorey not found with this ID: "+r),!1;var o=s.aabb,a=o[0],n=o[1],l=o[2],h=o[3]-a,u=o[4]-n,c=o[5]-l,p=this.viewer.camera.worldUp,d=p[0]>p[1]&&p[0]>p[2],f=!d&&p[1]>p[0]&&p[1]>p[2];!d&&!f&&p[2]>p[0]&&(p[2],p[1]);var _=t.width/h,g=f?t.height/c:t.height/u;return i[0]=Math.floor(t.width-(e[0]-a)*_),i[1]=Math.floor(t.height-(e[2]-l)*g),i[0]>=0&&i[0]<t.width&&i[1]>=0&&i[1]<=t.height},e.prototype.worldDirToStoreyMap=function(t,e,i){var r=this.viewer.camera,s=r.eye,o=r.look,a=E.subVec3(o,s,Ll),n=r.worldUp,l=n[0]>n[1]&&n[0]>n[2],h=!l&&n[1]>n[0]&&n[1]>n[2];!l&&!h&&n[2]>n[0]&&(n[2],n[1]),l?(i[0]=a[1],i[1]=a[2]):h?(i[0]=a[0],i[1]=a[2]):(i[0]=a[0],i[1]=a[1]),E.normalizeVec2(i)},e.prototype.destroy=function(){this.viewer.scene.off(this._onModelLoaded),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(n);function Tl(t,e){var i=t.rootMetaObject;return i?Fl(i,e):(e.push("Can't build storeys hierarchy: model is empty"),!1)}function Fl(t,e,i,r,s){void 0===i&&(i=0),r=r||{foundIFCBuildingStoreys:!1};var o=t.type,a=t.children;if("IfcBuilding"===o)s=!0;else if("IfcBuildingStorey"===o){if(!s)return e.push("Can't build storeys hierarchy: IfcBuildingStorey found without parent IfcBuilding"),!1;r.foundIFCBuildingStoreys=!0}if(a)for(var n=0,l=a.length;n<l;n++){if(!Fl(a[n],e,i+1,r,s))return!1}return 0===i&&r.foundIFCBuildingStoreys,!0}var Nl=new t,Il=function(t,e,i,r,s){var o=this;if(!s.containerElement)throw"Config expected: containerElement";var a=r.rootMetaObject;a&&(this.errors=[],this.valid=!0,this.metaModel=r,this._id=Nl.addItem(),this._baseId=""+this._id,this._viewer=t,this._treeViewPlugin=e,this._rootMetaObject=a,this._containerElement=s.containerElement,this._rootElement=null,this._muteSceneEvents=!1,this._muteTreeEvents=!1,this._rootNodes=[],this._objectNodes={},this._rootName=s.rootName,this._sortNodes=s.sortNodes,this._pruneEmptyNodes=s.pruneEmptyNodes,this._showListItemElementId=null,this._containerElement.oncontextmenu=function(t){t.preventDefault()},this._onObjectVisibility=this._viewer.scene.on("objectVisibility",(function(t){if(!o._muteSceneEvents){var e=t.id,i=o._objectNodes[e];if(i){var r=t.visible;if(r!==i.checked){o._muteTreeEvents=!0,i.checked=r,r?i.numVisibleEntities++:i.numVisibleEntities--;var s=document.getElementById(i.nodeId);s&&(s.checked=r);for(var a=i.parent;a;){a.checked=r,r?a.numVisibleEntities++:a.numVisibleEntities--;var n=document.getElementById(a.nodeId);if(n){var l=a.numVisibleEntities>0;l!==n.checked&&(n.checked=l)}a=a.parent}o._muteTreeEvents=!1}}}})),this.switchExpandHandler=function(t){t.preventDefault(),t.stopPropagation();var e=t.target;o._expandSwitchElement(e)},this.switchCollapseHandler=function(t){t.preventDefault(),t.stopPropagation();var e=t.target;o._collapseSwitchElement(e)},this._checkboxChangeHandler=function(t){if(!o._muteTreeEvents){o._muteSceneEvents=!0;var e=t.target,i=e.checked,r=e.id,s=o._nodeToObjectID(r),a=o._objectNodes[s],n=o._viewer.scene.objects,l=0;o._withNodeTree(a,(function(t){var e=t.objectId,r=t.nodeId,s=n[e],o=0===t.children.length;t.numVisibleEntities=i?t.numEntities:0,o&&i!==t.checked&&l++,t.checked=i;var a=document.getElementById(r);a&&(a.checked=i),s&&(s.visible=i)}));for(var h=a.parent;h;){h.checked=i;var u=document.getElementById(h.nodeId);i?h.numVisibleEntities+=l:h.numVisibleEntities-=l;var c=h.numVisibleEntities>0;c!==u.checked&&(u.checked=c),h=h.parent}o._muteSceneEvents=!1}},this._hierarchy=s.hierarchy||"containment",this._autoExpandDepth=s.autoExpandDepth||0,this._createNodes())};Il.prototype._nodeToObjectID=function(t){return t.substring(this._baseId.length)},Il.prototype._objectToNodeID=function(t){return this._baseId+t},Il.prototype.setAutoExpandDepth=function(t){void 0===t&&(t=0),this._autoExpandDepth=t},Il.prototype.setHierarchy=function(t){this._hierarchy!==t&&(this._hierarchy=t,this._createNodes())},Il.prototype._createNodes=function(){this._rootElement&&(this._rootElement.parentNode.removeChild(this._rootElement),this._rootElement=null),this._rootNodes=[],this._objectNodes={},this._validate(),this.valid||"storeys"!==this._hierarchy?this._createEnabledNodes():this._createDisabledNodes()},Il.prototype._validate=function(){switch(this.errors=[],this._hierarchy){case"storeys":this.valid=Tl(this.metaModel,this.errors);break;case"types":this.valid=(t=this.metaModel,e=this.errors,!!t.rootMetaObject||(e.push("Can't build types hierarchy: model is empty"),!1));break;case"containment":default:this.valid=function(t,e){return!!t.rootMetaObject||(e.push("Can't build containment hierarchy: model is empty"),!1)}(this.metaModel,this.errors)}var t,e;return this.valid},Il.prototype._createEnabledNodes=function(){switch(this._pruneEmptyNodes&&this._findEmptyNodes(),this._hierarchy){case"storeys":this._createStoreysNodes(),0===this._rootNodes.length&&this._treeViewPlugin.error("Failed to build storeys hierarchy for model '"+this.metaModel.id+"' - perhaps this model is not an IFC model?");break;case"types":this._createTypesNodes();break;case"containment":default:this._createContainmentNodes()}this._sortNodes&&this._doSortNodes(),this._synchNodesToEntities(),this._createTrees(),this.expandToDepth(this._autoExpandDepth)},Il.prototype._createDisabledNodes=function(){var t=this._rootMetaObject,e=t.type,i=t.name,r=i&&""!==i&&"Undefined"!==i&&"Default"!==i?i:e,s=document.createElement("ul"),o=document.createElement("li");s.appendChild(o),this._containerElement.appendChild(s),this._rootElement=s;var a=document.createElement("a");a.href="#",a.textContent="!",a.classList.add("warn"),a.classList.add("warning"),o.appendChild(a);var n=document.createElement("span");n.textContent=r,o.appendChild(n)},Il.prototype._findEmptyNodes=function(t,e){void 0===t&&(t=this._rootMetaObject);var i=this._treeViewPlugin.viewer.scene,r=t.children,s=t.id,o=i.objects[s];if(t._countEntities=0,o&&t._countEntities++,r)for(var a=0,n=r.length;a<n;a++){var l=r[a];l._countEntities=this._findEmptyNodes(l),t._countEntities+=l._countEntities}return t._countEntities},Il.prototype._createStoreysNodes=function(t,e,i,r){if(void 0===t&&(t=this._rootMetaObject),!this._pruneEmptyNodes||0!==t._countEntities){var s=t.type,o=t.name,a=t.children,n=t.id;if("IfcBuilding"===s)e={nodeId:this._objectToNodeID(n),objectId:n,title:this._rootName||(o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:s),type:s,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},this._rootNodes.push(e),this._objectNodes[e.objectId]=e;else if("IfcBuildingStorey"===s){if(!e)return void this._treeViewPlugin.error("Failed to build storeys hierarchy for model '"+this.metaModel.id+"' - model does not have an IfcBuilding object, or is not an IFC model");i={nodeId:this._objectToNodeID(n),objectId:n,title:o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:s,type:s,parent:e,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},e.children.push(i),this._objectNodes[i.objectId]=i,r={}}else{if(i)if(this._viewer.scene.objects[n]){var l=(r=r||{})[s];if(!l){var h=i.objectId+"."+s;l={nodeId:this._objectToNodeID(h),objectId:h,title:s,type:s,parent:i,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},i.children.push(l),this._objectNodes[h]=l,r[s]=l}var u={nodeId:this._objectToNodeID(n),objectId:n,title:o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:s,type:s,parent:l,numEntities:0,numVisibleEntities:0,checked:!1,children:[]};l.children.push(u),this._objectNodes[u.objectId]=u}}if(a)for(var c=0,p=a.length;c<p;c++){var d=a[c];this._createStoreysNodes(d,e,i,r)}}},Il.prototype._createTypesNodes=function(t,e,i){if(void 0===t&&(t=this._rootMetaObject),!this._pruneEmptyNodes||0!==t._countEntities){var r=t.type,s=t.name,o=t.children,a=t.id;if(t.id===this._rootMetaObject.id)e={nodeId:this._objectToNodeID(a),objectId:a,title:this._rootName||(s&&""!==s&&"Undefined"!==s&&"Default"!==s?s:r),type:r,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},this._rootNodes.push(e),this._objectNodes[e.objectId]=e,i={};else if(e)if(this._viewer.scene.objects[a]){var n=i[r];n||(n={nodeId:this._objectToNodeID(e.objectId+"."+r),objectId:e.objectId+"."+r,title:r,type:r,parent:e,numEntities:0,numVisibleEntities:0,checked:!1,children:[]},e.children.push(n),this._objectNodes[n.objectId]=n,i[r]=n);var l={nodeId:this._objectToNodeID(a),objectId:a,title:s&&""!==s&&"Default"!==s?s:r,type:r,parent:n,numEntities:0,numVisibleEntities:0,checked:!1,children:[]};n.children.push(l),this._objectNodes[l.objectId]=l}if(o)for(var h=0,u=o.length;h<u;h++){var c=o[h];this._createTypesNodes(c,e,i)}}},Il.prototype._createContainmentNodes=function(t,e){if(void 0===t&&(t=this._rootMetaObject),!this._pruneEmptyNodes||0!==t._countEntities){var i=t.type,r=t.name||i,s=t.children,o=t.id,a={nodeId:this._objectToNodeID(o),objectId:o,title:e?r&&""!==r&&"Undefined"!==r&&"Default"!==r?r:i:this._rootName||r,type:i,parent:e,numEntities:0,numVisibleEntities:0,checked:!1,children:[]};if(e?e.children.push(a):this._rootNodes.push(a),this._objectNodes[a.objectId]=a,s)for(var n=0,l=s.length;n<l;n++){var h=s[n];this._createContainmentNodes(h,a)}}},Il.prototype._doSortNodes=function(){for(var t=0,e=this._rootNodes.length;t<e;t++){var i=this._rootNodes[t];this._sortChildren(i)}},Il.prototype._sortChildren=function(t){var e=t.children;if(e&&0!==e.length){"storeys"===this._hierarchy&&"IfcBuilding"===t.type?e.sort(this._getSpatialSortFunc()):e.sort(this._alphaSortFunc);for(var i=0,r=e.length;i<r;i++){var s=e[i];this._sortChildren(s)}}},Il.prototype._getSpatialSortFunc=function(){var t=this._treeViewPlugin.viewer,e=t.scene,i=e.camera,r=t.metaScene;return this._spatialSortFunc||(this._spatialSortFunc=function(t,s){t.aabb&&s.aabb||(t.aabb||(t.aabb=e.getAABB(r.getObjectIDsInSubtree(t.objectId))),s.aabb||(s.aabb=e.getAABB(r.getObjectIDsInSubtree(s.objectId))));var o=0;return o=i.xUp?0:i.yUp?1:2,t.aabb[o]>s.aabb[o]?-1:t.aabb[o]<s.aabb[o]?1:0})},Il.prototype._alphaSortFunc=function(t,e){var i=t.title.toUpperCase(),r=e.title.toUpperCase();return i<r?-1:i>r?1:0},Il.prototype._synchNodesToEntities=function(){for(var t=this._rootMetaObject.getObjectIDsInSubtree(),e=this._viewer.metaScene.metaObjects,i=this._viewer.scene.objects,r=0,s=t.length;r<s;r++){var o=t[r];if(e[o]){var a=this._objectNodes[o];if(a){var n=i[o];if(n){var l=n.visible;a.numEntities=1,l?(a.numVisibleEntities=1,a.checked=!0):(a.numVisibleEntities=0,a.checked=!1);for(var h=a.parent;h;)h.numEntities++,l&&(h.numVisibleEntities++,h.checked=!0),h=h.parent}}}}},Il.prototype._withNodeTree=function(t,e){e(t);var i=t.children;if(i)for(var r=0,s=i.length;r<s;r++)this._withNodeTree(i[r],e)},Il.prototype._createTrees=function(){var t=this;if(0!==this._rootNodes.length){var e=this._rootNodes.map((function(e){return t._createNodeElement(e)})),i=document.createElement("ul");e.forEach((function(t){i.appendChild(t)})),this._containerElement.appendChild(i),this._rootElement=i}},Il.prototype._createNodeElement=function(t){var e=this,i=document.createElement("li"),r=t.nodeId;if(i.id="node-"+r,t.children.length>0){var s="switch-"+r,o=document.createElement("a");o.href="#",o.id=s,o.textContent="+",o.classList.add("plus"),o.addEventListener("click",this.switchExpandHandler),i.appendChild(o)}var a=document.createElement("input");a.id=r,a.type="checkbox",a.checked=t.checked,a.style["pointer-events"]="all",a.addEventListener("change",this._checkboxChangeHandler),i.appendChild(a);var n=document.createElement("span");return n.textContent=t.title,i.appendChild(n),n.oncontextmenu=function(i){e._treeViewPlugin.fire("contextmenu",{event:i,viewer:e._viewer,treeViewPlugin:e._treeViewPlugin,treeViewNode:t}),i.preventDefault()},n.onclick=function(i){e._treeViewPlugin.fire("nodeTitleClicked",{event:i,viewer:e._viewer,treeViewPlugin:e._treeViewPlugin,treeViewNode:t}),i.preventDefault()},i},Il.prototype.expandToDepth=function(t){for(var e=this,i=function(r,s){if(s!==t){var o="switch-"+r.nodeId,a=document.getElementById(o);if(a){e._expandSwitchElement(a);for(var n=r.children,l=0,h=n.length;l<h;l++){var u=n[l];i(u,s+1)}}}},r=0,s=this._rootNodes.length;r<s;r++){var o=this._rootNodes[r];i(o,0)}},Il.prototype.collapse=function(){for(var t=0,e=this._rootNodes.length;t<e;t++){var i=this._rootNodes[t].objectId;this._collapseNode(i)}},Il.prototype.showNode=function(t){this._showListItemElementId&&this.unShowNode();var e=this._objectNodes[t];if(e){var i=e.nodeId,r="switch-"+i,s=document.getElementById(r);if(s)return this._expandSwitchElement(s),void s.scrollIntoView();var o=[];o.unshift(e);for(var a=e.parent;a;)o.unshift(a),a=a.parent;for(var n=0,l=o.length;n<l;n++){var h="switch-"+o[n].nodeId,u=document.getElementById(h);u&&this._expandSwitchElement(u)}var c="node-"+i,p=document.getElementById(c);p.scrollIntoView({block:"center"}),p.classList.add("highlighted-node"),this._showListItemElementId=c}},Il.prototype.unShowNode=function(){if(this._showListItemElementId){var t=document.getElementById(this._showListItemElementId);t?(t.classList.remove("highlighted-node"),this._showListItemElementId=null):this._showListItemElementId=null}},Il.prototype._expandSwitchElement=function(t){var e=this,i=t.parentElement;if(!i.getElementsByTagName("li")[0]){var r=i.id.replace("node-",""),s=this._nodeToObjectID(r),o=this._objectNodes[s].children.map((function(t){return e._createNodeElement(t)})),a=document.createElement("ul");o.forEach((function(t){a.appendChild(t)})),i.appendChild(a),t.classList.remove("plus"),t.classList.add("minus"),t.textContent="-",t.removeEventListener("click",this.switchExpandHandler),t.addEventListener("click",this.switchCollapseHandler)}},Il.prototype._collapseNode=function(t){var e="switch-"+this._objectToNodeID(t),i=document.getElementById(e);this._collapseSwitchElement(i)},Il.prototype._collapseSwitchElement=function(t){if(t){var e=t.parentElement;if(e){var i=e.querySelector("ul");i&&(e.removeChild(i),t.classList.remove("minus"),t.classList.add("plus"),t.textContent="+",t.removeEventListener("click",this.switchCollapseHandler),t.addEventListener("click",this.switchExpandHandler))}}},Il.prototype.destroy=function(){this._rootElement&&!this._destroyed&&(this._rootElement.parentNode.removeChild(this._rootElement),this._viewer.scene.off(this._onObjectVisibility),this._destroyed=!0,Nl.removeItem(this._id))};var kl=function(t){function e(e,i){var r=this;if(void 0===i&&(i={}),t.call(this,"TreeViewPlugin",e),i.containerElement){if(this._containerElement=i.containerElement,this._modelTreeViews={},this._autoAddModels=!1!==i.autoAddModels,this._autoExpandDepth=i.autoExpandDepth||0,this._sortNodes=!1!==i.sortNodes,this._pruneEmptyNodes=!1!==i.pruneEmptyNodes,this._autoAddModels){for(var s=Object.keys(this.viewer.metaScene.metaModels),o=0,a=s.length;o<a;o++){var n=s[o];this.addModel(n)}this.viewer.scene.on("modelLoaded",(function(t){r.viewer.metaScene.metaModels[t]&&r.addModel(t)}))}this.hierarchy=i.hierarchy}else this.error("Config expected: containerElement")}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={modelTreeViews:{configurable:!0},hierarchy:{configurable:!0}};return i.modelTreeViews.get=function(){return this._modelTreeViews},i.hierarchy.set=function(t){for(var e in"containment"!==(t=t||"containment")&&"storeys"!==t&&"types"!==t&&(this.error("Unsupported value for `hierarchy' - defaulting to 'containment'"),t="containment"),this._hierarchy=t,this._modelTreeViews)this._modelTreeViews.hasOwnProperty(e)&&this._modelTreeViews[e].setHierarchy(this._hierarchy)},i.hierarchy.get=function(){return this._hierarchy},e.prototype.addModel=function(t,e){var i=this;if(void 0===e&&(e={}),this._containerElement){var r=this.viewer.scene.models[t];if(!r)throw"Model not found: "+t;var s=this.viewer.metaScene.metaModels[t];if(s){if(!this._modelTreeViews[t]){var o=new Il(this.viewer,this,r,s,{containerElement:this._containerElement,autoExpandDepth:this._autoExpandDepth,hierarchy:this._hierarchy,sortNodes:this._sortNodes,pruneEmptyNodes:this._pruneEmptyNodes,rootName:e.rootName});return this._modelTreeViews[t]=o,r.on("destroyed",(function(){i.removeModel(r.id)})),o}this.warn("Model already added: "+t)}else this.error("MetaModel not found: "+t)}},e.prototype.removeModel=function(t){if(this._containerElement){var e=this._modelTreeViews[t];e?(e.destroy(),delete this._modelTreeViews[t]):this.warn("Model not added: "+t)}},e.prototype.collapse=function(){for(var t in this._modelTreeViews){if(this._modelTreeViews.hasOwnProperty(t))this._modelTreeViews[t].collapse()}},e.prototype.showNode=function(t){this.unShowNode();var e=this.viewer.metaScene.metaObjects[t];if(e){var i=e.metaModel.id,r=this._modelTreeViews[i];r?r.showNode(t):this.error("Object not in this TreeView: "+t)}else this.error("MetaObject not found: "+t)},e.prototype.unShowNode=function(){for(var t in this._modelTreeViews){if(this._modelTreeViews.hasOwnProperty(t))this._modelTreeViews[t].unShowNode()}},e.prototype.expandToDepth=function(t){for(var e in this._modelTreeViews)if(this._modelTreeViews.hasOwnProperty(e)){var i=this._modelTreeViews[e];i.collapse(),i.expandToDepth(t)}},e.prototype.withNodeTree=function(t,e){e(t);var i=t.children;if(i)for(var r=0,s=i.length;r<s;r++)this.withNodeTree(i[r],e)},e.prototype.destroy=function(){if(this._containerElement){for(var e in this._modelTreeViews)this._modelTreeViews.hasOwnProperty(e)&&this._modelTreeViews[e].destroy();this._modelTreeViews={},t.prototype.destroy.call(this)}},Object.defineProperties(e.prototype,i),e}(n),Ol=E.vec3(),Vl=E.vec3(),zl=E.mat4(),Ul=function(){this.normal=E.vec3(),this.offset=0,this.testVertex=E.vec3()};Ul.prototype.set=function(t,e,i,r){var s=1/Math.sqrt(t*t+e*e+i*i);this.normal[0]=t*s,this.normal[1]=e*s,this.normal[2]=i*s,this.offset=r*s,this.testVertex[0]=this.normal[0]>=0?1:0,this.testVertex[1]=this.normal[1]>=0?1:0,this.testVertex[2]=this.normal[2]>=0?1:0};var jl=function(){this.planes=[new Ul,new Ul,new Ul,new Ul,new Ul,new Ul]};jl.INSIDE=0,jl.INTERSECT=1,jl.OUTSIDE=2;var Gl=function(t){var e=this;this._scene=t,this._objects=[],this._objectsViewCulled=[],this._objectsDetailCulled=[],this._objectsChanged=[],this._objectsChangedList=[],this._modelInfos={},this._numObjects=0,this._lenObjectsChangedList=0,this._dirty=!0,this._onModelLoaded=t.on("modelLoaded",(function(i){var r=t.models[i];r&&e._addModel(r)})),this._onTick=t.on("tick",(function(){e._dirty&&e._build(),e._applyChanges()}))},Xl={objects:{configurable:!0},numObjects:{configurable:!0}};Gl.prototype._addModel=function(t){var e=this,i={model:t,onDestroyed:t.on("destroyed",(function(){e._removeModel(t)}))};this._modelInfos[t.id]=i,this._dirty=!0},Gl.prototype._removeModel=function(t){var e=this._modelInfos[t.id];e&&(e.model.off(e.onDestroyed),delete this._modelInfos[t.id],this._dirty=!0)},Gl.prototype._build=function(){if(this._dirty){this._applyChanges();for(var t=this._scene.objects,e=0;e<this._numObjects;e++)this._objects[e]=null;for(var i in this._numObjects=0,t){var r=t[i];this._objects[this._numObjects++]=r}this._lenObjectsChangedList=0,this._dirty=!1}},Gl.prototype._applyChanges=function(){if(this._lenObjectsChangedList>0){for(var t=0;t<this._lenObjectsChangedList;t++){var e=this._objectsChangedList[t],i=this._objects[e],r=this._objectsViewCulled[e],s=this._objectsDetailCulled[e],o=r||s;i.culled=o,this._objectsChanged[e]=!1}this._lenObjectsChangedList=0}},Xl.objects.get=function(){return this._dirty&&this._build(),this._objects},Xl.numObjects.get=function(){return this._dirty&&this._build(),this._numObjects},Gl.prototype.setObjectViewCulled=function(t,e){this._dirty&&this._build(),this._objectsViewCulled[t]!==e&&(this._objectsViewCulled[t]=e,this._objectsChanged[t]||(this._objectsChanged[t]=!0,this._objectsChangedList[this._lenObjectsChangedList++]=t))},Gl.prototype.setObjectDetailCulled=function(t,e){this._dirty&&this._build(),this._objectsDetailCulled[t]!==e&&(this._objectsDetailCulled[t]=e,this._objectsChanged[t]||(this._objectsChanged[t]=!0,this._objectsChangedList[this._lenObjectsChangedList++]=t))},Gl.prototype._destroy=function(){this._clear(),this._scene.off(this._onModelLoaded),this._scene.off(this._onTick)},Gl.prototype._clear=function(){for(var t in this._modelInfos){var e=this._modelInfos[t];e.model.off(e.onDestroyed)}this._modelInfos={},this._dirty=!0},Object.defineProperties(Gl.prototype,Xl);var Wl={};var Hl=new Float32Array(3),Yl=function(t){function e(e,i){var r,s,o,a=this;void 0===i&&(i={}),t.call(this,"ViewCull",e),this._objectCullStates=(r=e.scene,s=r.id,(o=Wl[s])||(o=new Gl(r),Wl[s]=o,r.on("destroyed",(function(){delete Wl[s],o._destroy()}))),o),this._maxTreeDepth=i.maxTreeDepth||8,this._modelInfos={},this._frustum=new jl,this._kdRoot=null,this._frustumDirty=!1,this._kdTreeDirty=!1,this._onViewMatrix=e.scene.camera.on("viewMatrix",(function(){a._frustumDirty=!0})),this._onProjMatrix=e.scene.camera.on("projMatMatrix",(function(){a._frustumDirty=!0})),this._onModelLoaded=e.scene.on("modelLoaded",(function(t){var e=a.viewer.scene.models[t];e&&a._addModel(e)})),this._onSceneTick=e.scene.on("tick",(function(){a._doCull()}))}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={enabled:{configurable:!0}};return i.enabled.set=function(t){this._enabled=t},i.enabled.get=function(){return this._enabled},e.prototype._addModel=function(t){var e=this,i={model:t,onDestroyed:t.on("destroyed",(function(){e._removeModel(t)}))};this._modelInfos[t.id]=i,this._kdTreeDirty=!0},e.prototype._removeModel=function(t){var e=this._modelInfos[t.id];e&&(e.model.off(e.onDestroyed),delete this._modelInfos[t.id],this._kdTreeDirty=!0)},e.prototype._doCull=function(){var t=this._frustumDirty||this._kdTreeDirty;if(this._frustumDirty&&this._buildFrustum(),this._kdTreeDirty&&this._buildKDTree(),t){var e=this._kdRoot;e&&this._visitKDNode(e)}},e.prototype._buildFrustum=function(){var t,e,i,r,s,o,a,n,l,h,u,c,p,d,f,_,g,m,v,b,y=this.viewer.scene.camera;t=this._frustum,e=y.viewMatrix,i=y.projMatrix,r=E.mulMat4(i,e,zl),s=r[0],o=r[1],a=r[2],n=r[3],l=r[4],h=r[5],u=r[6],c=r[7],p=r[8],d=r[9],f=r[10],_=r[11],g=r[12],m=r[13],v=r[14],b=r[15],t.planes[0].set(n-s,c-l,_-p,b-g),t.planes[1].set(n+s,c+l,_+p,b+g),t.planes[2].set(n-o,c-h,_-d,b-m),t.planes[3].set(n+o,c+h,_+d,b+m),t.planes[4].set(n-a,c-u,_-f,b-v),t.planes[5].set(n+a,c+u,_+f,b+v),this._frustumDirty=!1},e.prototype._buildKDTree=function(){var t=this.viewer.scene;this._kdRoot,this._kdRoot={aabb:t.getAABB(),intersection:jl.INTERSECT};for(var e=0,i=this._objectCullStates.numObjects;e<i;e++){var r=this._objectCullStates.objects[e];this._insertEntityIntoKDTree(this._kdRoot,r,e,1)}this._kdTreeDirty=!1},e.prototype._insertEntityIntoKDTree=function(t,e,i,r){var s=e.aabb;if(r>=this._maxTreeDepth)return t.objects=t.objects||[],t.objects.push(i),void E.expandAABB3(t.aabb,s);if(t.left&&E.containsAABB3(t.left.aabb,s))this._insertEntityIntoKDTree(t.left,e,i,r+1);else if(t.right&&E.containsAABB3(t.right.aabb,s))this._insertEntityIntoKDTree(t.right,e,i,r+1);else{var o=t.aabb;Hl[0]=o[3]-o[0],Hl[1]=o[4]-o[1],Hl[2]=o[5]-o[2];var a=0;if(Hl[1]>Hl[a]&&(a=1),Hl[2]>Hl[a]&&(a=2),!t.left){var n=o.slice();if(n[a+3]=(o[a]+o[a+3])/2,t.left={aabb:n,intersection:jl.INTERSECT},E.containsAABB3(n,s))return void this._insertEntityIntoKDTree(t.left,e,i,r+1)}if(!t.right){var l=o.slice();if(l[a]=(o[a]+o[a+3])/2,t.right={aabb:l,intersection:jl.INTERSECT},E.containsAABB3(l,s))return void this._insertEntityIntoKDTree(t.right,e,i,r+1)}t.objects=t.objects||[],t.objects.push(i),E.expandAABB3(t.aabb,s)}},e.prototype._visitKDNode=function(t,e){if(void 0===e&&(e=jl.INTERSECT),e===jl.INTERSECT||t.intersects!==e){e===jl.INTERSECT&&(e=function(t,e){var i=jl.INSIDE,r=Ol,s=Vl;r[0]=e[0],r[1]=e[1],r[2]=e[2],s[0]=e[3],s[1]=e[4],s[2]=e[5];for(var o=[r,s],a=0;a<6;++a){var n=t.planes[a];if(n.normal[0]*o[n.testVertex[0]][0]+n.normal[1]*o[n.testVertex[1]][1]+n.normal[2]*o[n.testVertex[2]][2]+n.offset<0)return jl.OUTSIDE;n.normal[0]*o[1-n.testVertex[0]][0]+n.normal[1]*o[1-n.testVertex[1]][1]+n.normal[2]*o[1-n.testVertex[2]][2]+n.offset<0&&(i=jl.INTERSECT)}return i}(this._frustum,t.aabb),t.intersects=e);var i=e===jl.OUTSIDE,r=t.objects;if(r&&r.length>0)for(var s=0,o=r.length;s<o;s++){var a=r[s];this._objectCullStates.setObjectViewCulled(a,i)}t.left&&this._visitKDNode(t.left,e),t.right&&this._visitKDNode(t.right,e)}},e.prototype.send=function(t,e){},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._clear();var e=this.viewer.scene,i=e.camera;e.off(this._onModelLoaded),e.off(this._onSceneTick),i.off(this._onViewMatrix),i.off(this._onProjMatrix)},e.prototype._clear=function(){for(var t in this._modelInfos){var e=this._modelInfos[t];e.model.off(e.onDestroyed)}this._modelInfos={},this._kdRoot=null,this._kdTreeDirty=!0},Object.defineProperties(e.prototype,i),e}(n),Kl=function(){};Kl.prototype.getMetaModel=function(t,e,i){B.loadJSON(t,(function(t){e(t)}),(function(t){i(t)}))},Kl.prototype.getXKT=function(t,e,i){var r=function(){};e=e||r,i=i||r;var s=t.match(/^data:(.*?)(;base64)?,(.*)$/);if(s){var o=!!s[2],a=s[3];a=window.decodeURIComponent(a),o&&(a=window.atob(a));try{for(var n=new ArrayBuffer(a.length),l=new Uint8Array(n),h=0;h<a.length;h++)l[h]=a.charCodeAt(h);e(n)}catch(t){i(t)}}else{var u=new XMLHttpRequest;u.open("GET",t,!0),u.responseType="arraybuffer",u.onreadystatechange=function(){4===u.readyState&&(200===u.status?e(u.response):i("getXKT error : "+u.response))},u.send(null)}},function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).pako=t()}}((function(){return function t(e,i,r){function s(a,n){if(!i[a]){if(!e[a]){var l="function"==typeof require&&require;if(!n&&l)return l(a,!0);if(o)return o(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var u=i[a]={exports:{}};e[a][0].call(u.exports,(function(t){return s(e[a][1][t]||t)}),u,u.exports,t,e,i,r)}return i[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)s(r[a]);return s}({1:[function(t,e,i){var r=t("./zlib/deflate"),s=t("./utils/common"),o=t("./utils/strings"),a=t("./zlib/messages"),n=t("./zlib/zstream"),l=Object.prototype.toString;function h(t){if(!(this instanceof h))return new h(t);this.options=s.assign({level:-1,method:8,chunkSize:16384,windowBits:15,memLevel:8,strategy:0,to:""},t||{});var e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new n,this.strm.avail_out=0;var i=r.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(0!==i)throw new Error(a[i]);if(e.header&&r.deflateSetHeader(this.strm,e.header),e.dictionary){var u;if(u="string"==typeof e.dictionary?o.string2buf(e.dictionary):"[object ArrayBuffer]"===l.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,0!==(i=r.deflateSetDictionary(this.strm,u)))throw new Error(a[i]);this._dict_set=!0}}function u(t,e){var i=new h(e);if(i.push(t,!0),i.err)throw i.msg||a[i.err];return i.result}h.prototype.push=function(t,e){var i,a,n=this.strm,h=this.options.chunkSize;if(this.ended)return!1;a=e===~~e?e:!0===e?4:0,"string"==typeof t?n.input=o.string2buf(t):"[object ArrayBuffer]"===l.call(t)?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;do{if(0===n.avail_out&&(n.output=new s.Buf8(h),n.next_out=0,n.avail_out=h),1!==(i=r.deflate(n,a))&&0!==i)return this.onEnd(i),this.ended=!0,!1;0!==n.avail_out&&(0!==n.avail_in||4!==a&&2!==a)||("string"===this.options.to?this.onData(o.buf2binstring(s.shrinkBuf(n.output,n.next_out))):this.onData(s.shrinkBuf(n.output,n.next_out)))}while((n.avail_in>0||0===n.avail_out)&&1!==i);return 4===a?(i=r.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,0===i):2!==a||(this.onEnd(0),n.avail_out=0,!0)},h.prototype.onData=function(t){this.chunks.push(t)},h.prototype.onEnd=function(t){0===t&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},i.Deflate=h,i.deflate=u,i.deflateRaw=function(t,e){return(e=e||{}).raw=!0,u(t,e)},i.gzip=function(t,e){return(e=e||{}).gzip=!0,u(t,e)}},{"./utils/common":3,"./utils/strings":4,"./zlib/deflate":8,"./zlib/messages":13,"./zlib/zstream":15}],2:[function(t,e,i){var r=t("./zlib/inflate"),s=t("./utils/common"),o=t("./utils/strings"),a=t("./zlib/constants"),n=t("./zlib/messages"),l=t("./zlib/zstream"),h=t("./zlib/gzheader"),u=Object.prototype.toString;function c(t){if(!(this instanceof c))return new c(t);this.options=s.assign({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&0==(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var i=r.inflateInit2(this.strm,e.windowBits);if(i!==a.Z_OK)throw new Error(n[i]);if(this.header=new h,r.inflateGetHeader(this.strm,this.header),e.dictionary&&("string"==typeof e.dictionary?e.dictionary=o.string2buf(e.dictionary):"[object ArrayBuffer]"===u.call(e.dictionary)&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(i=r.inflateSetDictionary(this.strm,e.dictionary))!==a.Z_OK))throw new Error(n[i])}function p(t,e){var i=new c(e);if(i.push(t,!0),i.err)throw i.msg||n[i.err];return i.result}c.prototype.push=function(t,e){var i,n,l,h,c,p=this.strm,d=this.options.chunkSize,f=this.options.dictionary,_=!1;if(this.ended)return!1;n=e===~~e?e:!0===e?a.Z_FINISH:a.Z_NO_FLUSH,"string"==typeof t?p.input=o.binstring2buf(t):"[object ArrayBuffer]"===u.call(t)?p.input=new Uint8Array(t):p.input=t,p.next_in=0,p.avail_in=p.input.length;do{if(0===p.avail_out&&(p.output=new s.Buf8(d),p.next_out=0,p.avail_out=d),(i=r.inflate(p,a.Z_NO_FLUSH))===a.Z_NEED_DICT&&f&&(i=r.inflateSetDictionary(this.strm,f)),i===a.Z_BUF_ERROR&&!0===_&&(i=a.Z_OK,_=!1),i!==a.Z_STREAM_END&&i!==a.Z_OK)return this.onEnd(i),this.ended=!0,!1;p.next_out&&(0!==p.avail_out&&i!==a.Z_STREAM_END&&(0!==p.avail_in||n!==a.Z_FINISH&&n!==a.Z_SYNC_FLUSH)||("string"===this.options.to?(l=o.utf8border(p.output,p.next_out),h=p.next_out-l,c=o.buf2string(p.output,l),p.next_out=h,p.avail_out=d-h,h&&s.arraySet(p.output,p.output,l,h,0),this.onData(c)):this.onData(s.shrinkBuf(p.output,p.next_out)))),0===p.avail_in&&0===p.avail_out&&(_=!0)}while((p.avail_in>0||0===p.avail_out)&&i!==a.Z_STREAM_END);return i===a.Z_STREAM_END&&(n=a.Z_FINISH),n===a.Z_FINISH?(i=r.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===a.Z_OK):n!==a.Z_SYNC_FLUSH||(this.onEnd(a.Z_OK),p.avail_out=0,!0)},c.prototype.onData=function(t){this.chunks.push(t)},c.prototype.onEnd=function(t){t===a.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},i.Inflate=c,i.inflate=p,i.inflateRaw=function(t,e){return(e=e||{}).raw=!0,p(t,e)},i.ungzip=p},{"./utils/common":3,"./utils/strings":4,"./zlib/constants":6,"./zlib/gzheader":9,"./zlib/inflate":11,"./zlib/messages":13,"./zlib/zstream":15}],3:[function(t,e,i){var r="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function s(t,e){return Object.prototype.hasOwnProperty.call(t,e)}i.assign=function(t){for(var e=Array.prototype.slice.call(arguments,1);e.length;){var i=e.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var r in i)s(i,r)&&(t[r]=i[r])}}return t},i.shrinkBuf=function(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t)};var o={arraySet:function(t,e,i,r,s){if(e.subarray&&t.subarray)t.set(e.subarray(i,i+r),s);else for(var o=0;o<r;o++)t[s+o]=e[i+o]},flattenChunks:function(t){var e,i,r,s,o,a;for(r=0,e=0,i=t.length;e<i;e++)r+=t[e].length;for(a=new Uint8Array(r),s=0,e=0,i=t.length;e<i;e++)o=t[e],a.set(o,s),s+=o.length;return a}},a={arraySet:function(t,e,i,r,s){for(var o=0;o<r;o++)t[s+o]=e[i+o]},flattenChunks:function(t){return[].concat.apply([],t)}};i.setTyped=function(t){t?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,o)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,a))},i.setTyped(r)},{}],4:[function(t,e,i){var r=t("./common"),s=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch(t){s=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(t){o=!1}for(var a=new r.Buf8(256),n=0;n<256;n++)a[n]=n>=252?6:n>=248?5:n>=240?4:n>=224?3:n>=192?2:1;function l(t,e){if(e<65534&&(t.subarray&&o||!t.subarray&&s))return String.fromCharCode.apply(null,r.shrinkBuf(t,e));for(var i="",a=0;a<e;a++)i+=String.fromCharCode(t[a]);return i}a[254]=a[254]=1,i.string2buf=function(t){var e,i,s,o,a,n=t.length,l=0;for(o=0;o<n;o++)55296==(64512&(i=t.charCodeAt(o)))&&o+1<n&&56320==(64512&(s=t.charCodeAt(o+1)))&&(i=65536+(i-55296<<10)+(s-56320),o++),l+=i<128?1:i<2048?2:i<65536?3:4;for(e=new r.Buf8(l),a=0,o=0;a<l;o++)55296==(64512&(i=t.charCodeAt(o)))&&o+1<n&&56320==(64512&(s=t.charCodeAt(o+1)))&&(i=65536+(i-55296<<10)+(s-56320),o++),i<128?e[a++]=i:i<2048?(e[a++]=192|i>>>6,e[a++]=128|63&i):i<65536?(e[a++]=224|i>>>12,e[a++]=128|i>>>6&63,e[a++]=128|63&i):(e[a++]=240|i>>>18,e[a++]=128|i>>>12&63,e[a++]=128|i>>>6&63,e[a++]=128|63&i);return e},i.buf2binstring=function(t){return l(t,t.length)},i.binstring2buf=function(t){for(var e=new r.Buf8(t.length),i=0,s=e.length;i<s;i++)e[i]=t.charCodeAt(i);return e},i.buf2string=function(t,e){var i,r,s,o,n=e||t.length,h=new Array(2*n);for(r=0,i=0;i<n;)if((s=t[i++])<128)h[r++]=s;else if((o=a[s])>4)h[r++]=65533,i+=o-1;else{for(s&=2===o?31:3===o?15:7;o>1&&i<n;)s=s<<6|63&t[i++],o--;o>1?h[r++]=65533:s<65536?h[r++]=s:(s-=65536,h[r++]=55296|s>>10&1023,h[r++]=56320|1023&s)}return l(h,r)},i.utf8border=function(t,e){var i;for((e=e||t.length)>t.length&&(e=t.length),i=e-1;i>=0&&128==(192&t[i]);)i--;return i<0||0===i?e:i+a[t[i]]>e?i:e}},{"./common":3}],5:[function(t,e,i){e.exports=function(t,e,i,r){for(var s=65535&t|0,o=t>>>16&65535|0,a=0;0!==i;){i-=a=i>2e3?2e3:i;do{o=o+(s=s+e[r++]|0)|0}while(--a);s%=65521,o%=65521}return s|o<<16|0}},{}],6:[function(t,e,i){e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],7:[function(t,e,i){var r=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var r=0;r<8;r++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}();e.exports=function(t,e,i,s){var o=r,a=s+i;t^=-1;for(var n=s;n<a;n++)t=t>>>8^o[255&(t^e[n])];return-1^t}},{}],8:[function(t,e,i){var r,s=t("../utils/common"),o=t("./trees"),a=t("./adler32"),n=t("./crc32"),l=t("./messages"),h=-2,u=258,c=262,p=103,d=113,f=666;function _(t,e){return t.msg=l[e],e}function g(t){return(t<<1)-(t>4?9:0)}function m(t){for(var e=t.length;--e>=0;)t[e]=0}function v(t){var e=t.state,i=e.pending;i>t.avail_out&&(i=t.avail_out),0!==i&&(s.arraySet(t.output,e.pending_buf,e.pending_out,i,t.next_out),t.next_out+=i,e.pending_out+=i,t.total_out+=i,t.avail_out-=i,e.pending-=i,0===e.pending&&(e.pending_out=0))}function b(t,e){o._tr_flush_block(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,v(t.strm)}function y(t,e){t.pending_buf[t.pending++]=e}function P(t,e){t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e}function M(t,e){var i,r,s=t.max_chain_length,o=t.strstart,a=t.prev_length,n=t.nice_match,l=t.strstart>t.w_size-c?t.strstart-(t.w_size-c):0,h=t.window,p=t.w_mask,d=t.prev,f=t.strstart+u,_=h[o+a-1],g=h[o+a];t.prev_length>=t.good_match&&(s>>=2),n>t.lookahead&&(n=t.lookahead);do{if(h[(i=e)+a]===g&&h[i+a-1]===_&&h[i]===h[o]&&h[++i]===h[o+1]){o+=2,i++;do{}while(h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&o<f);if(r=u-(f-o),o=f-u,r>a){if(t.match_start=e,a=r,r>=n)break;_=h[o+a-1],g=h[o+a]}}}while((e=d[e&p])>l&&0!=--s);return a<=t.lookahead?a:t.lookahead}function x(t){var e,i,r,o,l,h,u,p,d,f,_=t.w_size;do{if(o=t.window_size-t.lookahead-t.strstart,t.strstart>=_+(_-c)){s.arraySet(t.window,t.window,_,_,0),t.match_start-=_,t.strstart-=_,t.block_start-=_,e=i=t.hash_size;do{r=t.head[--e],t.head[e]=r>=_?r-_:0}while(--i);e=i=_;do{r=t.prev[--e],t.prev[e]=r>=_?r-_:0}while(--i);o+=_}if(0===t.strm.avail_in)break;if(h=t.strm,u=t.window,p=t.strstart+t.lookahead,d=o,f=void 0,(f=h.avail_in)>d&&(f=d),i=0===f?0:(h.avail_in-=f,s.arraySet(u,h.input,h.next_in,f,p),1===h.state.wrap?h.adler=a(h.adler,u,f,p):2===h.state.wrap&&(h.adler=n(h.adler,u,f,p)),h.next_in+=f,h.total_in+=f,f),t.lookahead+=i,t.lookahead+t.insert>=3)for(l=t.strstart-t.insert,t.ins_h=t.window[l],t.ins_h=(t.ins_h<<t.hash_shift^t.window[l+1])&t.hash_mask;t.insert&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[l+3-1])&t.hash_mask,t.prev[l&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=l,l++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<c&&0!==t.strm.avail_in)}function w(t,e){for(var i,r;;){if(t.lookahead<c){if(x(t),t.lookahead<c&&0===e)return 1;if(0===t.lookahead)break}if(i=0,t.lookahead>=3&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==i&&t.strstart-i<=t.w_size-c&&(t.match_length=M(t,i)),t.match_length>=3)if(r=o._tr_tally(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do{t.strstart++,t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!=--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+1])&t.hash_mask;else r=o._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(r&&(b(t,!1),0===t.strm.avail_out))return 1}return t.insert=t.strstart<2?t.strstart:2,4===e?(b(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(b(t,!1),0===t.strm.avail_out)?1:2}function E(t,e){for(var i,r,s;;){if(t.lookahead<c){if(x(t),t.lookahead<c&&0===e)return 1;if(0===t.lookahead)break}if(i=0,t.lookahead>=3&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,0!==i&&t.prev_length<t.max_lazy_match&&t.strstart-i<=t.w_size-c&&(t.match_length=M(t,i),t.match_length<=5&&(1===t.strategy||3===t.match_length&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){s=t.strstart+t.lookahead-3,r=o._tr_tally(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=s&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!=--t.prev_length);if(t.match_available=0,t.match_length=2,t.strstart++,r&&(b(t,!1),0===t.strm.avail_out))return 1}else if(t.match_available){if((r=o._tr_tally(t,0,t.window[t.strstart-1]))&&b(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(r=o._tr_tally(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,4===e?(b(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(b(t,!1),0===t.strm.avail_out)?1:2}function C(t,e,i,r,s){this.good_length=t,this.max_lazy=e,this.nice_length=i,this.max_chain=r,this.func=s}function A(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new s.Buf16(1146),this.dyn_dtree=new s.Buf16(122),this.bl_tree=new s.Buf16(78),m(this.dyn_ltree),m(this.dyn_dtree),m(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new s.Buf16(16),this.heap=new s.Buf16(573),m(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new s.Buf16(573),m(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function S(t){var e;return t&&t.state?(t.total_in=t.total_out=0,t.data_type=2,(e=t.state).pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?42:d,t.adler=2===e.wrap?0:1,e.last_flush=0,o._tr_init(e),0):_(t,h)}function D(t){var e,i=S(t);return 0===i&&((e=t.state).window_size=2*e.w_size,m(e.head),e.max_lazy_match=r[e.level].max_lazy,e.good_match=r[e.level].good_length,e.nice_match=r[e.level].nice_length,e.max_chain_length=r[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=2,e.match_available=0,e.ins_h=0),i}function L(t,e,i,r,o,a){if(!t)return h;var n=1;if(-1===e&&(e=6),r<0?(n=0,r=-r):r>15&&(n=2,r-=16),o<1||o>9||8!==i||r<8||r>15||e<0||e>9||a<0||a>4)return _(t,h);8===r&&(r=9);var l=new A;return t.state=l,l.strm=t,l.wrap=n,l.gzhead=null,l.w_bits=r,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=o+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+3-1)/3),l.window=new s.Buf8(2*l.w_size),l.head=new s.Buf16(l.hash_size),l.prev=new s.Buf16(l.w_size),l.lit_bufsize=1<<o+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new s.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=e,l.strategy=a,l.method=i,D(t)}r=[new C(0,0,0,0,(function(t,e){var i=65535;for(i>t.pending_buf_size-5&&(i=t.pending_buf_size-5);;){if(t.lookahead<=1){if(x(t),0===t.lookahead&&0===e)return 1;if(0===t.lookahead)break}t.strstart+=t.lookahead,t.lookahead=0;var r=t.block_start+i;if((0===t.strstart||t.strstart>=r)&&(t.lookahead=t.strstart-r,t.strstart=r,b(t,!1),0===t.strm.avail_out))return 1;if(t.strstart-t.block_start>=t.w_size-c&&(b(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,4===e?(b(t,!0),0===t.strm.avail_out?3:4):(t.strstart>t.block_start&&(b(t,!1),t.strm.avail_out),1)})),new C(4,4,8,4,w),new C(4,5,16,8,w),new C(4,6,32,32,w),new C(4,4,16,16,E),new C(8,16,32,32,E),new C(8,16,128,128,E),new C(8,32,128,256,E),new C(32,128,258,1024,E),new C(32,258,258,4096,E)],i.deflateInit=function(t,e){return L(t,e,8,15,8,0)},i.deflateInit2=L,i.deflateReset=D,i.deflateResetKeep=S,i.deflateSetHeader=function(t,e){return t&&t.state?2!==t.state.wrap?h:(t.state.gzhead=e,0):h},i.deflate=function(t,e){var i,s,a,l;if(!t||!t.state||e>5||e<0)return t?_(t,h):h;if(s=t.state,!t.output||!t.input&&0!==t.avail_in||s.status===f&&4!==e)return _(t,0===t.avail_out?-5:h);if(s.strm=t,i=s.last_flush,s.last_flush=e,42===s.status)if(2===s.wrap)t.adler=0,y(s,31),y(s,139),y(s,8),s.gzhead?(y(s,(s.gzhead.text?1:0)+(s.gzhead.hcrc?2:0)+(s.gzhead.extra?4:0)+(s.gzhead.name?8:0)+(s.gzhead.comment?16:0)),y(s,255&s.gzhead.time),y(s,s.gzhead.time>>8&255),y(s,s.gzhead.time>>16&255),y(s,s.gzhead.time>>24&255),y(s,9===s.level?2:s.strategy>=2||s.level<2?4:0),y(s,255&s.gzhead.os),s.gzhead.extra&&s.gzhead.extra.length&&(y(s,255&s.gzhead.extra.length),y(s,s.gzhead.extra.length>>8&255)),s.gzhead.hcrc&&(t.adler=n(t.adler,s.pending_buf,s.pending,0)),s.gzindex=0,s.status=69):(y(s,0),y(s,0),y(s,0),y(s,0),y(s,0),y(s,9===s.level?2:s.strategy>=2||s.level<2?4:0),y(s,3),s.status=d);else{var c=8+(s.w_bits-8<<4)<<8;c|=(s.strategy>=2||s.level<2?0:s.level<6?1:6===s.level?2:3)<<6,0!==s.strstart&&(c|=32),c+=31-c%31,s.status=d,P(s,c),0!==s.strstart&&(P(s,t.adler>>>16),P(s,65535&t.adler)),t.adler=1}if(69===s.status)if(s.gzhead.extra){for(a=s.pending;s.gzindex<(65535&s.gzhead.extra.length)&&(s.pending!==s.pending_buf_size||(s.gzhead.hcrc&&s.pending>a&&(t.adler=n(t.adler,s.pending_buf,s.pending-a,a)),v(t),a=s.pending,s.pending!==s.pending_buf_size));)y(s,255&s.gzhead.extra[s.gzindex]),s.gzindex++;s.gzhead.hcrc&&s.pending>a&&(t.adler=n(t.adler,s.pending_buf,s.pending-a,a)),s.gzindex===s.gzhead.extra.length&&(s.gzindex=0,s.status=73)}else s.status=73;if(73===s.status)if(s.gzhead.name){a=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>a&&(t.adler=n(t.adler,s.pending_buf,s.pending-a,a)),v(t),a=s.pending,s.pending===s.pending_buf_size)){l=1;break}l=s.gzindex<s.gzhead.name.length?255&s.gzhead.name.charCodeAt(s.gzindex++):0,y(s,l)}while(0!==l);s.gzhead.hcrc&&s.pending>a&&(t.adler=n(t.adler,s.pending_buf,s.pending-a,a)),0===l&&(s.gzindex=0,s.status=91)}else s.status=91;if(91===s.status)if(s.gzhead.comment){a=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>a&&(t.adler=n(t.adler,s.pending_buf,s.pending-a,a)),v(t),a=s.pending,s.pending===s.pending_buf_size)){l=1;break}l=s.gzindex<s.gzhead.comment.length?255&s.gzhead.comment.charCodeAt(s.gzindex++):0,y(s,l)}while(0!==l);s.gzhead.hcrc&&s.pending>a&&(t.adler=n(t.adler,s.pending_buf,s.pending-a,a)),0===l&&(s.status=p)}else s.status=p;if(s.status===p&&(s.gzhead.hcrc?(s.pending+2>s.pending_buf_size&&v(t),s.pending+2<=s.pending_buf_size&&(y(s,255&t.adler),y(s,t.adler>>8&255),t.adler=0,s.status=d)):s.status=d),0!==s.pending){if(v(t),0===t.avail_out)return s.last_flush=-1,0}else if(0===t.avail_in&&g(e)<=g(i)&&4!==e)return _(t,-5);if(s.status===f&&0!==t.avail_in)return _(t,-5);if(0!==t.avail_in||0!==s.lookahead||0!==e&&s.status!==f){var M=2===s.strategy?function(t,e){for(var i;;){if(0===t.lookahead&&(x(t),0===t.lookahead)){if(0===e)return 1;break}if(t.match_length=0,i=o._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,i&&(b(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,4===e?(b(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(b(t,!1),0===t.strm.avail_out)?1:2}(s,e):3===s.strategy?function(t,e){for(var i,r,s,a,n=t.window;;){if(t.lookahead<=u){if(x(t),t.lookahead<=u&&0===e)return 1;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=3&&t.strstart>0&&(r=n[s=t.strstart-1])===n[++s]&&r===n[++s]&&r===n[++s]){a=t.strstart+u;do{}while(r===n[++s]&&r===n[++s]&&r===n[++s]&&r===n[++s]&&r===n[++s]&&r===n[++s]&&r===n[++s]&&r===n[++s]&&s<a);t.match_length=u-(a-s),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=3?(i=o._tr_tally(t,1,t.match_length-3),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(i=o._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),i&&(b(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,4===e?(b(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(b(t,!1),0===t.strm.avail_out)?1:2}(s,e):r[s.level].func(s,e);if(3!==M&&4!==M||(s.status=f),1===M||3===M)return 0===t.avail_out&&(s.last_flush=-1),0;if(2===M&&(1===e?o._tr_align(s):5!==e&&(o._tr_stored_block(s,0,0,!1),3===e&&(m(s.head),0===s.lookahead&&(s.strstart=0,s.block_start=0,s.insert=0))),v(t),0===t.avail_out))return s.last_flush=-1,0}return 4!==e?0:s.wrap<=0?1:(2===s.wrap?(y(s,255&t.adler),y(s,t.adler>>8&255),y(s,t.adler>>16&255),y(s,t.adler>>24&255),y(s,255&t.total_in),y(s,t.total_in>>8&255),y(s,t.total_in>>16&255),y(s,t.total_in>>24&255)):(P(s,t.adler>>>16),P(s,65535&t.adler)),v(t),s.wrap>0&&(s.wrap=-s.wrap),0!==s.pending?0:1)},i.deflateEnd=function(t){var e;return t&&t.state?42!==(e=t.state.status)&&69!==e&&73!==e&&91!==e&&e!==p&&e!==d&&e!==f?_(t,h):(t.state=null,e===d?_(t,-3):0):h},i.deflateSetDictionary=function(t,e){var i,r,o,n,l,u,c,p,d=e.length;if(!t||!t.state)return h;if(2===(n=(i=t.state).wrap)||1===n&&42!==i.status||i.lookahead)return h;for(1===n&&(t.adler=a(t.adler,e,d,0)),i.wrap=0,d>=i.w_size&&(0===n&&(m(i.head),i.strstart=0,i.block_start=0,i.insert=0),p=new s.Buf8(i.w_size),s.arraySet(p,e,d-i.w_size,i.w_size,0),e=p,d=i.w_size),l=t.avail_in,u=t.next_in,c=t.input,t.avail_in=d,t.next_in=0,t.input=e,x(i);i.lookahead>=3;){r=i.strstart,o=i.lookahead-2;do{i.ins_h=(i.ins_h<<i.hash_shift^i.window[r+3-1])&i.hash_mask,i.prev[r&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=r,r++}while(--o);i.strstart=r,i.lookahead=2,x(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,t.next_in=u,t.input=c,t.avail_in=l,i.wrap=n,0},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./messages":13,"./trees":14}],9:[function(t,e,i){e.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],10:[function(t,e,i){e.exports=function(t,e){var i,r,s,o,a,n,l,h,u,c,p,d,f,_,g,m,v,b,y,P,M,x,w,E,C;i=t.state,r=t.next_in,E=t.input,s=r+(t.avail_in-5),o=t.next_out,C=t.output,a=o-(e-t.avail_out),n=o+(t.avail_out-257),l=i.dmax,h=i.wsize,u=i.whave,c=i.wnext,p=i.window,d=i.hold,f=i.bits,_=i.lencode,g=i.distcode,m=(1<<i.lenbits)-1,v=(1<<i.distbits)-1;t:do{f<15&&(d+=E[r++]<<f,f+=8,d+=E[r++]<<f,f+=8),b=_[d&m];e:for(;;){if(d>>>=y=b>>>24,f-=y,0===(y=b>>>16&255))C[o++]=65535&b;else{if(!(16&y)){if(0==(64&y)){b=_[(65535&b)+(d&(1<<y)-1)];continue e}if(32&y){i.mode=12;break t}t.msg="invalid literal/length code",i.mode=30;break t}P=65535&b,(y&=15)&&(f<y&&(d+=E[r++]<<f,f+=8),P+=d&(1<<y)-1,d>>>=y,f-=y),f<15&&(d+=E[r++]<<f,f+=8,d+=E[r++]<<f,f+=8),b=g[d&v];i:for(;;){if(d>>>=y=b>>>24,f-=y,!(16&(y=b>>>16&255))){if(0==(64&y)){b=g[(65535&b)+(d&(1<<y)-1)];continue i}t.msg="invalid distance code",i.mode=30;break t}if(M=65535&b,f<(y&=15)&&(d+=E[r++]<<f,(f+=8)<y&&(d+=E[r++]<<f,f+=8)),(M+=d&(1<<y)-1)>l){t.msg="invalid distance too far back",i.mode=30;break t}if(d>>>=y,f-=y,M>(y=o-a)){if((y=M-y)>u&&i.sane){t.msg="invalid distance too far back",i.mode=30;break t}if(x=0,w=p,0===c){if(x+=h-y,y<P){P-=y;do{C[o++]=p[x++]}while(--y);x=o-M,w=C}}else if(c<y){if(x+=h+c-y,(y-=c)<P){P-=y;do{C[o++]=p[x++]}while(--y);if(x=0,c<P){P-=y=c;do{C[o++]=p[x++]}while(--y);x=o-M,w=C}}}else if(x+=c-y,y<P){P-=y;do{C[o++]=p[x++]}while(--y);x=o-M,w=C}for(;P>2;)C[o++]=w[x++],C[o++]=w[x++],C[o++]=w[x++],P-=3;P&&(C[o++]=w[x++],P>1&&(C[o++]=w[x++]))}else{x=o-M;do{C[o++]=C[x++],C[o++]=C[x++],C[o++]=C[x++],P-=3}while(P>2);P&&(C[o++]=C[x++],P>1&&(C[o++]=C[x++]))}break}}break}}while(r<s&&o<n);r-=P=f>>3,d&=(1<<(f-=P<<3))-1,t.next_in=r,t.next_out=o,t.avail_in=r<s?s-r+5:5-(r-s),t.avail_out=o<n?n-o+257:257-(o-n),i.hold=d,i.bits=f}},{}],11:[function(t,e,i){var r=t("../utils/common"),s=t("./adler32"),o=t("./crc32"),a=t("./inffast"),n=t("./inftrees"),l=-2,h=12,u=30;function c(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24)}function p(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new r.Buf16(320),this.work=new r.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function d(t){var e;return t&&t.state?(e=t.state,t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=1,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new r.Buf32(852),e.distcode=e.distdyn=new r.Buf32(592),e.sane=1,e.back=-1,0):l}function f(t){var e;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,d(t)):l}function _(t,e){var i,r;return t&&t.state?(r=t.state,e<0?(i=0,e=-e):(i=1+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?l:(null!==r.window&&r.wbits!==e&&(r.window=null),r.wrap=i,r.wbits=e,f(t))):l}function g(t,e){var i,r;return t?(r=new p,t.state=r,r.window=null,0!==(i=_(t,e))&&(t.state=null),i):l}var m,v,b=!0;function y(t){if(b){var e;for(m=new r.Buf32(512),v=new r.Buf32(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(n(1,t.lens,0,288,m,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;n(2,t.lens,0,32,v,0,t.work,{bits:5}),b=!1}t.lencode=m,t.lenbits=9,t.distcode=v,t.distbits=5}function P(t,e,i,s){var o,a=t.state;return null===a.window&&(a.wsize=1<<a.wbits,a.wnext=0,a.whave=0,a.window=new r.Buf8(a.wsize)),s>=a.wsize?(r.arraySet(a.window,e,i-a.wsize,a.wsize,0),a.wnext=0,a.whave=a.wsize):((o=a.wsize-a.wnext)>s&&(o=s),r.arraySet(a.window,e,i-s,o,a.wnext),(s-=o)?(r.arraySet(a.window,e,i-s,s,0),a.wnext=s,a.whave=a.wsize):(a.wnext+=o,a.wnext===a.wsize&&(a.wnext=0),a.whave<a.wsize&&(a.whave+=o))),0}i.inflateReset=f,i.inflateReset2=_,i.inflateResetKeep=d,i.inflateInit=function(t){return g(t,15)},i.inflateInit2=g,i.inflate=function(t,e){var i,p,d,f,_,g,m,v,b,M,x,w,E,C,A,S,D,L,B,R,T,F,N,I,k=0,O=new r.Buf8(4),V=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return l;(i=t.state).mode===h&&(i.mode=13),_=t.next_out,d=t.output,m=t.avail_out,f=t.next_in,p=t.input,g=t.avail_in,v=i.hold,b=i.bits,M=g,x=m,F=0;t:for(;;)switch(i.mode){case 1:if(0===i.wrap){i.mode=13;break}for(;b<16;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}if(2&i.wrap&&35615===v){i.check=0,O[0]=255&v,O[1]=v>>>8&255,i.check=o(i.check,O,2,0),v=0,b=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&v)<<8)+(v>>8))%31){t.msg="incorrect header check",i.mode=u;break}if(8!=(15&v)){t.msg="unknown compression method",i.mode=u;break}if(b-=4,T=8+(15&(v>>>=4)),0===i.wbits)i.wbits=T;else if(T>i.wbits){t.msg="invalid window size",i.mode=u;break}i.dmax=1<<T,t.adler=i.check=1,i.mode=512&v?10:h,v=0,b=0;break;case 2:for(;b<16;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}if(i.flags=v,8!=(255&i.flags)){t.msg="unknown compression method",i.mode=u;break}if(57344&i.flags){t.msg="unknown header flags set",i.mode=u;break}i.head&&(i.head.text=v>>8&1),512&i.flags&&(O[0]=255&v,O[1]=v>>>8&255,i.check=o(i.check,O,2,0)),v=0,b=0,i.mode=3;case 3:for(;b<32;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}i.head&&(i.head.time=v),512&i.flags&&(O[0]=255&v,O[1]=v>>>8&255,O[2]=v>>>16&255,O[3]=v>>>24&255,i.check=o(i.check,O,4,0)),v=0,b=0,i.mode=4;case 4:for(;b<16;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}i.head&&(i.head.xflags=255&v,i.head.os=v>>8),512&i.flags&&(O[0]=255&v,O[1]=v>>>8&255,i.check=o(i.check,O,2,0)),v=0,b=0,i.mode=5;case 5:if(1024&i.flags){for(;b<16;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}i.length=v,i.head&&(i.head.extra_len=v),512&i.flags&&(O[0]=255&v,O[1]=v>>>8&255,i.check=o(i.check,O,2,0)),v=0,b=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&i.flags&&((w=i.length)>g&&(w=g),w&&(i.head&&(T=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),r.arraySet(i.head.extra,p,f,w,T)),512&i.flags&&(i.check=o(i.check,p,w,f)),g-=w,f+=w,i.length-=w),i.length))break t;i.length=0,i.mode=7;case 7:if(2048&i.flags){if(0===g)break t;w=0;do{T=p[f+w++],i.head&&T&&i.length<65536&&(i.head.name+=String.fromCharCode(T))}while(T&&w<g);if(512&i.flags&&(i.check=o(i.check,p,w,f)),g-=w,f+=w,T)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&i.flags){if(0===g)break t;w=0;do{T=p[f+w++],i.head&&T&&i.length<65536&&(i.head.comment+=String.fromCharCode(T))}while(T&&w<g);if(512&i.flags&&(i.check=o(i.check,p,w,f)),g-=w,f+=w,T)break t}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&i.flags){for(;b<16;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}if(v!==(65535&i.check)){t.msg="header crc mismatch",i.mode=u;break}v=0,b=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),t.adler=i.check=0,i.mode=h;break;case 10:for(;b<32;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}t.adler=i.check=c(v),v=0,b=0,i.mode=11;case 11:if(0===i.havedict)return t.next_out=_,t.avail_out=m,t.next_in=f,t.avail_in=g,i.hold=v,i.bits=b,2;t.adler=i.check=1,i.mode=h;case h:if(5===e||6===e)break t;case 13:if(i.last){v>>>=7&b,b-=7&b,i.mode=27;break}for(;b<3;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}switch(i.last=1&v,b-=1,3&(v>>>=1)){case 0:i.mode=14;break;case 1:if(y(i),i.mode=20,6===e){v>>>=2,b-=2;break t}break;case 2:i.mode=17;break;case 3:t.msg="invalid block type",i.mode=u}v>>>=2,b-=2;break;case 14:for(v>>>=7&b,b-=7&b;b<32;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}if((65535&v)!=(v>>>16^65535)){t.msg="invalid stored block lengths",i.mode=u;break}if(i.length=65535&v,v=0,b=0,i.mode=15,6===e)break t;case 15:i.mode=16;case 16:if(w=i.length){if(w>g&&(w=g),w>m&&(w=m),0===w)break t;r.arraySet(d,p,f,w,_),g-=w,f+=w,m-=w,_+=w,i.length-=w;break}i.mode=h;break;case 17:for(;b<14;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}if(i.nlen=257+(31&v),v>>>=5,b-=5,i.ndist=1+(31&v),v>>>=5,b-=5,i.ncode=4+(15&v),v>>>=4,b-=4,i.nlen>286||i.ndist>30){t.msg="too many length or distance symbols",i.mode=u;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;b<3;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}i.lens[V[i.have++]]=7&v,v>>>=3,b-=3}for(;i.have<19;)i.lens[V[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,N={bits:i.lenbits},F=n(0,i.lens,0,19,i.lencode,0,i.work,N),i.lenbits=N.bits,F){t.msg="invalid code lengths set",i.mode=u;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;S=(k=i.lencode[v&(1<<i.lenbits)-1])>>>16&255,D=65535&k,!((A=k>>>24)<=b);){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}if(D<16)v>>>=A,b-=A,i.lens[i.have++]=D;else{if(16===D){for(I=A+2;b<I;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}if(v>>>=A,b-=A,0===i.have){t.msg="invalid bit length repeat",i.mode=u;break}T=i.lens[i.have-1],w=3+(3&v),v>>>=2,b-=2}else if(17===D){for(I=A+3;b<I;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}b-=A,T=0,w=3+(7&(v>>>=A)),v>>>=3,b-=3}else{for(I=A+7;b<I;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}b-=A,T=0,w=11+(127&(v>>>=A)),v>>>=7,b-=7}if(i.have+w>i.nlen+i.ndist){t.msg="invalid bit length repeat",i.mode=u;break}for(;w--;)i.lens[i.have++]=T}}if(i.mode===u)break;if(0===i.lens[256]){t.msg="invalid code -- missing end-of-block",i.mode=u;break}if(i.lenbits=9,N={bits:i.lenbits},F=n(1,i.lens,0,i.nlen,i.lencode,0,i.work,N),i.lenbits=N.bits,F){t.msg="invalid literal/lengths set",i.mode=u;break}if(i.distbits=6,i.distcode=i.distdyn,N={bits:i.distbits},F=n(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,N),i.distbits=N.bits,F){t.msg="invalid distances set",i.mode=u;break}if(i.mode=20,6===e)break t;case 20:i.mode=21;case 21:if(g>=6&&m>=258){t.next_out=_,t.avail_out=m,t.next_in=f,t.avail_in=g,i.hold=v,i.bits=b,a(t,x),_=t.next_out,d=t.output,m=t.avail_out,f=t.next_in,p=t.input,g=t.avail_in,v=i.hold,b=i.bits,i.mode===h&&(i.back=-1);break}for(i.back=0;S=(k=i.lencode[v&(1<<i.lenbits)-1])>>>16&255,D=65535&k,!((A=k>>>24)<=b);){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}if(S&&0==(240&S)){for(L=A,B=S,R=D;S=(k=i.lencode[R+((v&(1<<L+B)-1)>>L)])>>>16&255,D=65535&k,!(L+(A=k>>>24)<=b);){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}v>>>=L,b-=L,i.back+=L}if(v>>>=A,b-=A,i.back+=A,i.length=D,0===S){i.mode=26;break}if(32&S){i.back=-1,i.mode=h;break}if(64&S){t.msg="invalid literal/length code",i.mode=u;break}i.extra=15&S,i.mode=22;case 22:if(i.extra){for(I=i.extra;b<I;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}i.length+=v&(1<<i.extra)-1,v>>>=i.extra,b-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;S=(k=i.distcode[v&(1<<i.distbits)-1])>>>16&255,D=65535&k,!((A=k>>>24)<=b);){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}if(0==(240&S)){for(L=A,B=S,R=D;S=(k=i.distcode[R+((v&(1<<L+B)-1)>>L)])>>>16&255,D=65535&k,!(L+(A=k>>>24)<=b);){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}v>>>=L,b-=L,i.back+=L}if(v>>>=A,b-=A,i.back+=A,64&S){t.msg="invalid distance code",i.mode=u;break}i.offset=D,i.extra=15&S,i.mode=24;case 24:if(i.extra){for(I=i.extra;b<I;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}i.offset+=v&(1<<i.extra)-1,v>>>=i.extra,b-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){t.msg="invalid distance too far back",i.mode=u;break}i.mode=25;case 25:if(0===m)break t;if(w=x-m,i.offset>w){if((w=i.offset-w)>i.whave&&i.sane){t.msg="invalid distance too far back",i.mode=u;break}w>i.wnext?(w-=i.wnext,E=i.wsize-w):E=i.wnext-w,w>i.length&&(w=i.length),C=i.window}else C=d,E=_-i.offset,w=i.length;w>m&&(w=m),m-=w,i.length-=w;do{d[_++]=C[E++]}while(--w);0===i.length&&(i.mode=21);break;case 26:if(0===m)break t;d[_++]=i.length,m--,i.mode=21;break;case 27:if(i.wrap){for(;b<32;){if(0===g)break t;g--,v|=p[f++]<<b,b+=8}if(x-=m,t.total_out+=x,i.total+=x,x&&(t.adler=i.check=i.flags?o(i.check,d,x,_-x):s(i.check,d,x,_-x)),x=m,(i.flags?v:c(v))!==i.check){t.msg="incorrect data check",i.mode=u;break}v=0,b=0}i.mode=28;case 28:if(i.wrap&&i.flags){for(;b<32;){if(0===g)break t;g--,v+=p[f++]<<b,b+=8}if(v!==(4294967295&i.total)){t.msg="incorrect length check",i.mode=u;break}v=0,b=0}i.mode=29;case 29:F=1;break t;case u:F=-3;break t;case 31:return-4;case 32:default:return l}return t.next_out=_,t.avail_out=m,t.next_in=f,t.avail_in=g,i.hold=v,i.bits=b,(i.wsize||x!==t.avail_out&&i.mode<u&&(i.mode<27||4!==e))&&P(t,t.output,t.next_out,x-t.avail_out),M-=t.avail_in,x-=t.avail_out,t.total_in+=M,t.total_out+=x,i.total+=x,i.wrap&&x&&(t.adler=i.check=i.flags?o(i.check,d,x,t.next_out-x):s(i.check,d,x,t.next_out-x)),t.data_type=i.bits+(i.last?64:0)+(i.mode===h?128:0)+(20===i.mode||15===i.mode?256:0),(0===M&&0===x||4===e)&&0===F&&(F=-5),F},i.inflateEnd=function(t){if(!t||!t.state)return l;var e=t.state;return e.window&&(e.window=null),t.state=null,0},i.inflateGetHeader=function(t,e){var i;return t&&t.state?0==(2&(i=t.state).wrap)?l:(i.head=e,e.done=!1,0):l},i.inflateSetDictionary=function(t,e){var i,r=e.length;return t&&t.state?0!==(i=t.state).wrap&&11!==i.mode?l:11===i.mode&&s(1,e,r,0)!==i.check?-3:P(t,e,r,r)?(i.mode=31,-4):(i.havedict=1,0):l},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./inffast":10,"./inftrees":12}],12:[function(t,e,i){var r=t("../utils/common"),s=15,o=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],a=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],n=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(t,e,i,h,u,c,p,d){var f,_,g,m,v,b,y,P,M,x=d.bits,w=0,E=0,C=0,A=0,S=0,D=0,L=0,B=0,R=0,T=0,F=null,N=0,I=new r.Buf16(16),k=new r.Buf16(16),O=null,V=0;for(w=0;w<=s;w++)I[w]=0;for(E=0;E<h;E++)I[e[i+E]]++;for(S=x,A=s;A>=1&&0===I[A];A--);if(S>A&&(S=A),0===A)return u[c++]=20971520,u[c++]=20971520,d.bits=1,0;for(C=1;C<A&&0===I[C];C++);for(S<C&&(S=C),B=1,w=1;w<=s;w++)if(B<<=1,(B-=I[w])<0)return-1;if(B>0&&(0===t||1!==A))return-1;for(k[1]=0,w=1;w<s;w++)k[w+1]=k[w]+I[w];for(E=0;E<h;E++)0!==e[i+E]&&(p[k[e[i+E]]++]=E);if(0===t?(F=O=p,b=19):1===t?(F=o,N-=257,O=a,V-=257,b=256):(F=n,O=l,b=-1),T=0,E=0,w=C,v=c,D=S,L=0,g=-1,m=(R=1<<S)-1,1===t&&R>852||2===t&&R>592)return 1;for(;;){y=w-L,p[E]<b?(P=0,M=p[E]):p[E]>b?(P=O[V+p[E]],M=F[N+p[E]]):(P=96,M=0),f=1<<w-L,C=_=1<<D;do{u[v+(T>>L)+(_-=f)]=y<<24|P<<16|M|0}while(0!==_);for(f=1<<w-1;T&f;)f>>=1;if(0!==f?(T&=f-1,T+=f):T=0,E++,0==--I[w]){if(w===A)break;w=e[i+p[E]]}if(w>S&&(T&m)!==g){for(0===L&&(L=S),v+=C,B=1<<(D=w-L);D+L<A&&!((B-=I[D+L])<=0);)D++,B<<=1;if(R+=1<<D,1===t&&R>852||2===t&&R>592)return 1;u[g=T&m]=S<<24|D<<16|v-c|0}}return 0!==T&&(u[v+T]=w-L<<24|64<<16|0),d.bits=S,0}},{"../utils/common":3}],13:[function(t,e,i){e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],14:[function(t,e,i){var r=t("../utils/common");function s(t){for(var e=t.length;--e>=0;)t[e]=0}var o=256,a=286,n=30,l=15,h=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],u=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],c=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],p=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],d=new Array(576);s(d);var f=new Array(60);s(f);var _=new Array(512);s(_);var g=new Array(256);s(g);var m=new Array(29);s(m);var v,b,y,P=new Array(n);function M(t,e,i,r,s){this.static_tree=t,this.extra_bits=e,this.extra_base=i,this.elems=r,this.max_length=s,this.has_stree=t&&t.length}function x(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}function w(t){return t<256?_[t]:_[256+(t>>>7)]}function E(t,e){t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255}function C(t,e,i){t.bi_valid>16-i?(t.bi_buf|=e<<t.bi_valid&65535,E(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=i-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=i)}function A(t,e,i){C(t,i[2*e],i[2*e+1])}function S(t,e){var i=0;do{i|=1&t,t>>>=1,i<<=1}while(--e>0);return i>>>1}function D(t,e,i){var r,s,o=new Array(16),a=0;for(r=1;r<=l;r++)o[r]=a=a+i[r-1]<<1;for(s=0;s<=e;s++){var n=t[2*s+1];0!==n&&(t[2*s]=S(o[n]++,n))}}function L(t){var e;for(e=0;e<a;e++)t.dyn_ltree[2*e]=0;for(e=0;e<n;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0}function B(t){t.bi_valid>8?E(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0}function R(t,e,i,r){var s=2*e,o=2*i;return t[s]<t[o]||t[s]===t[o]&&r[e]<=r[i]}function T(t,e,i){for(var r=t.heap[i],s=i<<1;s<=t.heap_len&&(s<t.heap_len&&R(e,t.heap[s+1],t.heap[s],t.depth)&&s++,!R(e,r,t.heap[s],t.depth));)t.heap[i]=t.heap[s],i=s,s<<=1;t.heap[i]=r}function F(t,e,i){var r,s,a,n,l=0;if(0!==t.last_lit)do{r=t.pending_buf[t.d_buf+2*l]<<8|t.pending_buf[t.d_buf+2*l+1],s=t.pending_buf[t.l_buf+l],l++,0===r?A(t,s,e):(A(t,(a=g[s])+o+1,e),0!==(n=h[a])&&C(t,s-=m[a],n),A(t,a=w(--r),i),0!==(n=u[a])&&C(t,r-=P[a],n))}while(l<t.last_lit);A(t,256,e)}function N(t,e){var i,r,s,o=e.dyn_tree,a=e.stat_desc.static_tree,n=e.stat_desc.has_stree,h=e.stat_desc.elems,u=-1;for(t.heap_len=0,t.heap_max=573,i=0;i<h;i++)0!==o[2*i]?(t.heap[++t.heap_len]=u=i,t.depth[i]=0):o[2*i+1]=0;for(;t.heap_len<2;)o[2*(s=t.heap[++t.heap_len]=u<2?++u:0)]=1,t.depth[s]=0,t.opt_len--,n&&(t.static_len-=a[2*s+1]);for(e.max_code=u,i=t.heap_len>>1;i>=1;i--)T(t,o,i);s=h;do{i=t.heap[1],t.heap[1]=t.heap[t.heap_len--],T(t,o,1),r=t.heap[1],t.heap[--t.heap_max]=i,t.heap[--t.heap_max]=r,o[2*s]=o[2*i]+o[2*r],t.depth[s]=(t.depth[i]>=t.depth[r]?t.depth[i]:t.depth[r])+1,o[2*i+1]=o[2*r+1]=s,t.heap[1]=s++,T(t,o,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],function(t,e){var i,r,s,o,a,n,h=e.dyn_tree,u=e.max_code,c=e.stat_desc.static_tree,p=e.stat_desc.has_stree,d=e.stat_desc.extra_bits,f=e.stat_desc.extra_base,_=e.stat_desc.max_length,g=0;for(o=0;o<=l;o++)t.bl_count[o]=0;for(h[2*t.heap[t.heap_max]+1]=0,i=t.heap_max+1;i<573;i++)(o=h[2*h[2*(r=t.heap[i])+1]+1]+1)>_&&(o=_,g++),h[2*r+1]=o,r>u||(t.bl_count[o]++,a=0,r>=f&&(a=d[r-f]),n=h[2*r],t.opt_len+=n*(o+a),p&&(t.static_len+=n*(c[2*r+1]+a)));if(0!==g){do{for(o=_-1;0===t.bl_count[o];)o--;t.bl_count[o]--,t.bl_count[o+1]+=2,t.bl_count[_]--,g-=2}while(g>0);for(o=_;0!==o;o--)for(r=t.bl_count[o];0!==r;)(s=t.heap[--i])>u||(h[2*s+1]!==o&&(t.opt_len+=(o-h[2*s+1])*h[2*s],h[2*s+1]=o),r--)}}(t,e),D(o,u,t.bl_count)}function I(t,e,i){var r,s,o=-1,a=e[1],n=0,l=7,h=4;for(0===a&&(l=138,h=3),e[2*(i+1)+1]=65535,r=0;r<=i;r++)s=a,a=e[2*(r+1)+1],++n<l&&s===a||(n<h?t.bl_tree[2*s]+=n:0!==s?(s!==o&&t.bl_tree[2*s]++,t.bl_tree[32]++):n<=10?t.bl_tree[34]++:t.bl_tree[36]++,n=0,o=s,0===a?(l=138,h=3):s===a?(l=6,h=3):(l=7,h=4))}function k(t,e,i){var r,s,o=-1,a=e[1],n=0,l=7,h=4;for(0===a&&(l=138,h=3),r=0;r<=i;r++)if(s=a,a=e[2*(r+1)+1],!(++n<l&&s===a)){if(n<h)do{A(t,s,t.bl_tree)}while(0!=--n);else 0!==s?(s!==o&&(A(t,s,t.bl_tree),n--),A(t,16,t.bl_tree),C(t,n-3,2)):n<=10?(A(t,17,t.bl_tree),C(t,n-3,3)):(A(t,18,t.bl_tree),C(t,n-11,7));n=0,o=s,0===a?(l=138,h=3):s===a?(l=6,h=3):(l=7,h=4)}}s(P);var O=!1;function V(t,e,i,s){C(t,0+(s?1:0),3),function(t,e,i,s){B(t),s&&(E(t,i),E(t,~i)),r.arraySet(t.pending_buf,t.window,e,i,t.pending),t.pending+=i}(t,e,i,!0)}i._tr_init=function(t){O||(!function(){var t,e,i,r,s,o=new Array(16);for(i=0,r=0;r<28;r++)for(m[r]=i,t=0;t<1<<h[r];t++)g[i++]=r;for(g[i-1]=r,s=0,r=0;r<16;r++)for(P[r]=s,t=0;t<1<<u[r];t++)_[s++]=r;for(s>>=7;r<n;r++)for(P[r]=s<<7,t=0;t<1<<u[r]-7;t++)_[256+s++]=r;for(e=0;e<=l;e++)o[e]=0;for(t=0;t<=143;)d[2*t+1]=8,t++,o[8]++;for(;t<=255;)d[2*t+1]=9,t++,o[9]++;for(;t<=279;)d[2*t+1]=7,t++,o[7]++;for(;t<=287;)d[2*t+1]=8,t++,o[8]++;for(D(d,287,o),t=0;t<n;t++)f[2*t+1]=5,f[2*t]=S(t,5);v=new M(d,h,257,a,l),b=new M(f,u,0,n,l),y=new M(new Array(0),c,0,19,7)}(),O=!0),t.l_desc=new x(t.dyn_ltree,v),t.d_desc=new x(t.dyn_dtree,b),t.bl_desc=new x(t.bl_tree,y),t.bi_buf=0,t.bi_valid=0,L(t)},i._tr_stored_block=V,i._tr_flush_block=function(t,e,i,r){var s,a,n=0;t.level>0?(2===t.strm.data_type&&(t.strm.data_type=function(t){var e,i=4093624447;for(e=0;e<=31;e++,i>>>=1)if(1&i&&0!==t.dyn_ltree[2*e])return 0;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return 1;for(e=32;e<o;e++)if(0!==t.dyn_ltree[2*e])return 1;return 0}(t)),N(t,t.l_desc),N(t,t.d_desc),n=function(t){var e;for(I(t,t.dyn_ltree,t.l_desc.max_code),I(t,t.dyn_dtree,t.d_desc.max_code),N(t,t.bl_desc),e=18;e>=3&&0===t.bl_tree[2*p[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e}(t),s=t.opt_len+3+7>>>3,(a=t.static_len+3+7>>>3)<=s&&(s=a)):s=a=i+5,i+4<=s&&-1!==e?V(t,e,i,r):4===t.strategy||a===s?(C(t,2+(r?1:0),3),F(t,d,f)):(C(t,4+(r?1:0),3),function(t,e,i,r){var s;for(C(t,e-257,5),C(t,i-1,5),C(t,r-4,4),s=0;s<r;s++)C(t,t.bl_tree[2*p[s]+1],3);k(t,t.dyn_ltree,e-1),k(t,t.dyn_dtree,i-1)}(t,t.l_desc.max_code+1,t.d_desc.max_code+1,n+1),F(t,t.dyn_ltree,t.dyn_dtree)),L(t),r&&B(t)},i._tr_tally=function(t,e,i){return t.pending_buf[t.d_buf+2*t.last_lit]=e>>>8&255,t.pending_buf[t.d_buf+2*t.last_lit+1]=255&e,t.pending_buf[t.l_buf+t.last_lit]=255&i,t.last_lit++,0===e?t.dyn_ltree[2*i]++:(t.matches++,e--,t.dyn_ltree[2*(g[i]+o+1)]++,t.dyn_dtree[2*w(e)]++),t.last_lit===t.lit_bufsize-1},i._tr_align=function(t){C(t,2,3),A(t,256,d),function(t){16===t.bi_valid?(E(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)}(t)}},{"../utils/common":3}],15:[function(t,e,i){e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],"/":[function(t,e,i){var r={};(0,t("./lib/utils/common").assign)(r,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),e.exports=r},{"./lib/deflate":1,"./lib/inflate":2,"./lib/utils/common":3,"./lib/zlib/constants":6}]},{},[])("/")}));var ql=Object.freeze({__proto__:null}),Zl=window.pako||ql;Zl.inflate||(Zl=Zl.default);var Ql,Jl=(Ql=new Float32Array(3),function(t){return Ql[0]=t[0]/255,Ql[1]=t[1]/255,Ql[2]=t[2]/255,Ql});var $l={version:1,parse:function(t,e,i,r){!function(t,e,i,r){r.positionsCompression="precompressed",r.normalsCompression="precompressed";for(var s=i.positions,o=i.normals,a=i.indices,n=i.edgeIndices,l=i.meshPositions,h=i.meshIndices,u=i.meshEdgesIndices,c=i.meshColors,p=JSON.parse(i.entityIDs),d=i.entityMeshes,f=i.entityIsObjects,_=l.length,g=d.length,m=0;m<g;m++){var v=p[m],b=e.globalizeObjectIds?E.globalizeObjectId(r.id,v):v,y=t.metaScene.metaObjects[b],P={},M={};if(y){if(e.excludeTypesMap&&y.type&&e.excludeTypesMap[y.type])continue;if(e.includeTypesMap&&y.type&&!e.includeTypesMap[y.type])continue;var x=e.objectDefaults?e.objectDefaults[y.type]||e.objectDefaults.DEFAULT:null;x&&(!1===x.visible&&(P.visible=!1),!1===x.pickable&&(P.pickable=!1),x.colorize&&(M.color=x.colorize),void 0!==x.opacity&&null!==x.opacity&&(M.opacity=x.opacity))}else if(e.excludeUnclassifiedObjects)continue;for(var w=m===g-1,C=[],A=d[m],S=w?d.length:d[m+1];A<S;A++){var D=A===_-1,L=b+".mesh."+A,R=Jl(c.subarray(4*A,4*A+3)),T=c[4*A+3]/255;r.createMesh(B.apply(M,{id:L,primitive:"triangles",positions:s.subarray(l[A],D?s.length:l[A+1]),normals:o.subarray(l[A],D?s.length:l[A+1]),indices:a.subarray(h[A],D?a.length:h[A+1]),edgeIndices:n.subarray(u[A],D?n.length:u[A+1]),positionsDecodeMatrix:i.positionsDecodeMatrix,color:R,opacity:T})),C.push(L)}r.createEntity(B.apply(P,{id:b,isObject:1===f[m],meshIds:C}))}}(t,e,function(t){return{positions:new Uint16Array(Zl.inflate(t.positions).buffer),normals:new Int8Array(Zl.inflate(t.normals).buffer),indices:new Uint32Array(Zl.inflate(t.indices).buffer),edgeIndices:new Uint32Array(Zl.inflate(t.edgeIndices).buffer),meshPositions:new Uint32Array(Zl.inflate(t.meshPositions).buffer),meshIndices:new Uint32Array(Zl.inflate(t.meshIndices).buffer),meshEdgesIndices:new Uint32Array(Zl.inflate(t.meshEdgesIndices).buffer),meshColors:new Uint8Array(Zl.inflate(t.meshColors).buffer),entityIDs:Zl.inflate(t.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(Zl.inflate(t.entityMeshes).buffer),entityIsObjects:new Uint8Array(Zl.inflate(t.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(Zl.inflate(t.positionsDecodeMatrix).buffer)}}(function(t){return{positions:t[0],normals:t[1],indices:t[2],edgeIndices:t[3],meshPositions:t[4],meshIndices:t[5],meshEdgesIndices:t[6],meshColors:t[7],entityIDs:t[8],entityMeshes:t[9],entityIsObjects:t[10],positionsDecodeMatrix:t[11]}}(i)),r)}},th=window.pako||ql;th.inflate||(th=th.default);var eh=function(){var t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();var ih={version:2,parse:function(t,e,i,r){!function(t,e,i,r){r.positionsCompression="precompressed",r.normalsCompression="precompressed";for(var s=i.positions,o=i.normals,a=i.indices,n=i.edgeIndices,l=i.meshPositions,h=i.meshIndices,u=i.meshEdgesIndices,c=i.meshColors,p=JSON.parse(i.entityIDs),d=i.entityMeshes,f=i.entityIsObjects,_=i.entityMeshIds,g=i.entityMatrices,m=i.entityUsesInstancing,v=l.length,b=d.length,y={},P=0;P<b;P++){var M=p[P],x=e.globalizeObjectIds?E.globalizeObjectId(r.id,M):M,w=t.metaScene.metaObjects[x],C={},A={},S=g.subarray(16*P,16*P+16);if(w){if(e.excludeTypesMap&&w.type&&e.excludeTypesMap[w.type])continue;if(e.includeTypesMap&&w.type&&!e.includeTypesMap[w.type])continue;var D=e.objectDefaults?e.objectDefaults[w.type]||e.objectDefaults.DEFAULT:null;D&&(!1===D.visible&&(C.visible=!1),!1===D.pickable&&(C.pickable=!1),D.colorize&&(A.color=D.colorize),void 0!==D.opacity&&null!==D.opacity&&(A.opacity=D.opacity))}else if(e.excludeUnclassifiedObjects)continue;for(var L=P===b-1,R=[],T=d[P],F=L?_.length:d[P+1];T<F;T++){var N=_[T],I=N===v-1,k=x+".mesh."+N,O=eh(c.subarray(4*N,4*N+3)),V=c[4*N+3]/255,z=s.subarray(l[N],I?s.length:l[N+1]),U=o.subarray(l[N],I?s.length:l[N+1]),j=a.subarray(h[N],I?a.length:h[N+1]),G=n.subarray(u[N],I?n.length:u[N+1]);if(1===m[P]){var X="geometry."+N;X in y||(r.createGeometry({id:X,positions:z,normals:U,indices:j,edgeIndices:G,primitive:"triangles",positionsDecodeMatrix:i.positionsDecodeMatrix}),y[X]=!0),r.createMesh(B.apply(A,{id:k,color:O,opacity:V,matrix:S,geometryId:X})),R.push(k)}else r.createMesh(B.apply(A,{id:k,primitive:"triangles",positions:z,normals:U,indices:j,edgeIndices:G,positionsDecodeMatrix:i.positionsDecodeMatrix,color:O,opacity:V})),R.push(k)}R.length&&r.createEntity(B.apply(C,{id:x,isObject:1===f[P],meshIds:R}))}}(t,e,function(t){return{positions:new Uint16Array(th.inflate(t.positions).buffer),normals:new Int8Array(th.inflate(t.normals).buffer),indices:new Uint32Array(th.inflate(t.indices).buffer),edgeIndices:new Uint32Array(th.inflate(t.edgeIndices).buffer),meshPositions:new Uint32Array(th.inflate(t.meshPositions).buffer),meshIndices:new Uint32Array(th.inflate(t.meshIndices).buffer),meshEdgesIndices:new Uint32Array(th.inflate(t.meshEdgesIndices).buffer),meshColors:new Uint8Array(th.inflate(t.meshColors).buffer),entityIDs:th.inflate(t.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(th.inflate(t.entityMeshes).buffer),entityIsObjects:new Uint8Array(th.inflate(t.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(th.inflate(t.positionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(th.inflate(t.entityMeshIds).buffer),entityMatrices:new Float32Array(th.inflate(t.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(th.inflate(t.entityUsesInstancing).buffer)}}(function(t){return{positions:t[0],normals:t[1],indices:t[2],edgeIndices:t[3],meshPositions:t[4],meshIndices:t[5],meshEdgesIndices:t[6],meshColors:t[7],entityIDs:t[8],entityMeshes:t[9],entityIsObjects:t[10],positionsDecodeMatrix:t[11],entityMeshIds:t[12],entityMatrices:t[13],entityUsesInstancing:t[14]}}(i)),r)}},rh=window.pako||ql;rh.inflate||(rh=rh.default);var sh=function(){var t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();var oh={version:3,parse:function(t,e,i,r){!function(t,e,i,r){r.positionsCompression="precompressed",r.normalsCompression="precompressed";for(var s=i.positions,o=i.normals,a=i.indices,n=i.edgeIndices,l=i.meshPositions,h=i.meshIndices,u=i.meshEdgesIndices,c=i.meshColors,p=JSON.parse(i.entityIDs),d=i.entityMeshes,f=i.entityIsObjects,_=i.entityMeshIds,g=i.entityMatrices,m=i.entityUsesInstancing,v=l.length,b=d.length,y={},P=0;P<b;P++){var M=p[P],x=e.globalizeObjectIds?E.globalizeObjectId(r.id,M):M,w=t.metaScene.metaObjects[x],C={},A={},S=g.subarray(16*P,16*P+16);if(w){if(e.excludeTypesMap&&w.type&&e.excludeTypesMap[w.type])continue;if(e.includeTypesMap&&w.type&&!e.includeTypesMap[w.type])continue;var D=e.objectDefaults?e.objectDefaults[w.type]||e.objectDefaults.DEFAULT:null;D&&(!1===D.visible&&(C.visible=!1),!1===D.pickable&&(C.pickable=!1),D.colorize&&(A.color=D.colorize),void 0!==D.opacity&&null!==D.opacity&&(A.opacity=D.opacity))}else if(e.excludeUnclassifiedObjects)continue;for(var L=P===b-1,R=[],T=d[P],F=L?_.length:d[P+1];T<F;T++){var N=_[T],I=N===v-1,k=x+".mesh."+N,O=sh(c.subarray(4*N,4*N+3)),V=c[4*N+3]/255,z=s.subarray(l[N],I?s.length:l[N+1]),U=o.subarray(l[N],I?s.length:l[N+1]),j=a.subarray(h[N],I?a.length:h[N+1]),G=n.subarray(u[N],I?n.length:u[N+1]);if(1===m[P]){var X="geometry."+N;X in y||(r.createGeometry({id:X,positions:z,normals:U,indices:j,edgeIndices:G,primitive:"triangles",positionsDecodeMatrix:i.instancedPositionsDecodeMatrix}),y[X]=!0),r.createMesh(B.apply(A,{id:k,color:O,opacity:V,matrix:S,geometryId:X})),R.push(k)}else r.createMesh(B.apply(A,{id:k,primitive:"triangles",positions:z,normals:U,indices:j,edgeIndices:G,positionsDecodeMatrix:i.batchedPositionsDecodeMatrix,color:O,opacity:V})),R.push(k)}R.length&&r.createEntity(B.apply(C,{id:x,isObject:1===f[P],meshIds:R}))}}(t,e,function(t){return{positions:new Uint16Array(rh.inflate(t.positions).buffer),normals:new Int8Array(rh.inflate(t.normals).buffer),indices:new Uint32Array(rh.inflate(t.indices).buffer),edgeIndices:new Uint32Array(rh.inflate(t.edgeIndices).buffer),meshPositions:new Uint32Array(rh.inflate(t.meshPositions).buffer),meshIndices:new Uint32Array(rh.inflate(t.meshIndices).buffer),meshEdgesIndices:new Uint32Array(rh.inflate(t.meshEdgesIndices).buffer),meshColors:new Uint8Array(rh.inflate(t.meshColors).buffer),entityIDs:rh.inflate(t.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(rh.inflate(t.entityMeshes).buffer),entityIsObjects:new Uint8Array(rh.inflate(t.entityIsObjects).buffer),instancedPositionsDecodeMatrix:new Float32Array(rh.inflate(t.instancedPositionsDecodeMatrix).buffer),batchedPositionsDecodeMatrix:new Float32Array(rh.inflate(t.batchedPositionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(rh.inflate(t.entityMeshIds).buffer),entityMatrices:new Float32Array(rh.inflate(t.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(rh.inflate(t.entityUsesInstancing).buffer)}}(function(t){return{positions:t[0],normals:t[1],indices:t[2],edgeIndices:t[3],meshPositions:t[4],meshIndices:t[5],meshEdgesIndices:t[6],meshColors:t[7],entityIDs:t[8],entityMeshes:t[9],entityIsObjects:t[10],instancedPositionsDecodeMatrix:t[11],batchedPositionsDecodeMatrix:t[12],entityMeshIds:t[13],entityMatrices:t[14],entityUsesInstancing:t[15]}}(i)),r)}},ah=window.pako||ql;ah.inflate||(ah=ah.default);var nh=function(){var t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();var lh={version:4,parse:function(t,e,i,r){!function(t,e,i,r){r.positionsCompression="precompressed",r.normalsCompression="precompressed";for(var s=i.positions,o=i.normals,a=i.indices,n=i.edgeIndices,l=i.decodeMatrices,h=i.matrices,u=i.eachPrimitivePositionsAndNormalsPortion,c=i.eachPrimitiveIndicesPortion,p=i.eachPrimitiveEdgeIndicesPortion,d=i.eachPrimitiveDecodeMatricesPortion,f=i.eachPrimitiveColor,_=i.primitiveInstances,g=JSON.parse(i.eachEntityId),m=i.eachEntityPrimitiveInstancesPortion,v=i.eachEntityMatricesPortion,b=u.length,y=_.length,P=new Uint8Array(b),M=new Uint32Array(b),x=g.length,w=0;w<b;w++)M[w]=w;M.sort((function(t,e){return d[t]<d[e]?-1:d[t]>d[e]?1:0}));for(var E=0;E<y;E++)P[_[E]]++;for(var C={},A=0;A<x;A++)for(var S=x-1,D=A===S,L=m[A],R=D?m[S]:m[A+1],T=L;T<R;T++){var F=_[T];P[F]>1||(C[F]=A)}for(var N=0;N<b;N++){var I=M[N],k=I===b-1,O=P[I]>1,V=nh(f.subarray(4*I,4*I+3)),z=f[4*I+3]/255,U=s.subarray(u[I],k?s.length:u[I+1]),j=o.subarray(u[I],k?o.length:u[I+1]),G=a.subarray(c[I],k?a.length:c[I+1]),X=n.subarray(p[I],k?n.length:p[I+1]),W=l.subarray(d[I],d[I]+16);if(O){var H="geometry"+I;r.createGeometry({id:H,primitive:"triangles",positions:U,normals:j,indices:G,edgeIndices:X,positionsDecodeMatrix:W})}else{var Y=I;g[C[I]],r.createMesh(B.apply({},{id:Y,primitive:"triangles",positions:U,normals:j,indices:G,edgeIndices:X,positionsDecodeMatrix:W,color:V,opacity:z}))}}for(var K=0,q=0;q<x;q++){for(var Z=x-1,Q=q===Z,J=g[q],$=m[q],tt=Q?m[Z]:m[q+1],et=[],it=$;it<tt;it++){var rt=_[it];if(P[rt]>1){var st="instance."+K++,ot="geometry"+rt,at=16*v[q],nt=h.subarray(at,at+16);r.createMesh(B.apply({},{id:st,geometryId:ot,matrix:nt})),et.push(st)}else et.push(rt)}et.length>0&&r.createEntity(B.apply({},{id:J,isObject:!0,meshIds:et}))}}(0,0,function(t){return{positions:new Uint16Array(ah.inflate(t.positions).buffer),normals:new Int8Array(ah.inflate(t.normals).buffer),indices:new Uint32Array(ah.inflate(t.indices).buffer),edgeIndices:new Uint32Array(ah.inflate(t.edgeIndices).buffer),decodeMatrices:new Float32Array(ah.inflate(t.decodeMatrices).buffer),matrices:new Float32Array(ah.inflate(t.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(ah.inflate(t.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(ah.inflate(t.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(ah.inflate(t.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveDecodeMatricesPortion:new Uint32Array(ah.inflate(t.eachPrimitiveDecodeMatricesPortion).buffer),eachPrimitiveColor:new Uint8Array(ah.inflate(t.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(ah.inflate(t.primitiveInstances).buffer),eachEntityId:ah.inflate(t.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(ah.inflate(t.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(ah.inflate(t.eachEntityMatricesPortion).buffer)}}(function(t){return{positions:t[0],normals:t[1],indices:t[2],edgeIndices:t[3],decodeMatrices:t[4],matrices:t[5],eachPrimitivePositionsAndNormalsPortion:t[6],eachPrimitiveIndicesPortion:t[7],eachPrimitiveEdgeIndicesPortion:t[8],eachPrimitiveDecodeMatricesPortion:t[9],eachPrimitiveColor:t[10],primitiveInstances:t[11],eachEntityId:t[12],eachEntityPrimitiveInstancesPortion:t[13],eachEntityMatricesPortion:t[14],eachEntityMatrix:t[15]}}(i)),r)}},hh=window.pako||ql;hh.inflate||(hh=hh.default);var uh=function(){var t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();var ch={version:5,parse:function(t,e,i,r){!function(t,e,i,r){r.positionsCompression="disabled",r.normalsCompression="precompressed";for(var s=i.positions,o=i.normals,a=i.indices,n=i.edgeIndices,l=i.matrices,h=i.eachPrimitivePositionsAndNormalsPortion,u=i.eachPrimitiveIndicesPortion,c=i.eachPrimitiveEdgeIndicesPortion,p=i.eachPrimitiveColor,d=i.primitiveInstances,f=JSON.parse(i.eachEntityId),_=i.eachEntityPrimitiveInstancesPortion,g=i.eachEntityMatricesPortion,m=h.length,v=d.length,b=new Uint8Array(m),y=f.length,P=0;P<v;P++)b[d[P]]++;for(var M={},x=0;x<y;x++)for(var w=y-1,E=x===w,C=_[x],A=E?_[w]:_[x+1],S=C;S<A;S++){var D=d[S];b[D]>1||(M[D]=x)}for(var L=0;L<m;L++){var R=L===m-1,T=b[L]>1,F=uh(p.subarray(4*L,4*L+3)),N=p[4*L+3]/255,I=s.subarray(h[L],R?s.length:h[L+1]),k=o.subarray(h[L],R?o.length:h[L+1]),O=a.subarray(u[L],R?a.length:u[L+1]),V=n.subarray(c[L],R?n.length:c[L+1]);if(T){var z="geometry"+L;r.createGeometry({id:z,primitive:"triangles",positions:I,normals:k,indices:O,edgeIndices:V})}else{var U=L;f[M[L]],r.createMesh(B.apply({},{id:U,primitive:"triangles",positions:I,normals:k,indices:O,edgeIndices:V,color:F,opacity:N}))}}for(var j=0,G=0;G<y;G++){for(var X=y-1,W=G===X,H=f[G],Y=_[G],K=W?_[X]:_[G+1],q=[],Z=Y;Z<K;Z++){var Q=d[Z];if(b[Q]>1){var J="instance."+j++,$="geometry"+Q,tt=16*g[G],et=l.subarray(tt,tt+16);r.createMesh(B.apply({},{id:J,geometryId:$,matrix:et})),q.push(J)}else q.push(Q)}q.length>0&&r.createEntity(B.apply({},{id:H,isObject:!0,meshIds:q}))}}(0,0,function(t){return{positions:new Float32Array(hh.inflate(t.positions).buffer),normals:new Int8Array(hh.inflate(t.normals).buffer),indices:new Uint32Array(hh.inflate(t.indices).buffer),edgeIndices:new Uint32Array(hh.inflate(t.edgeIndices).buffer),matrices:new Float32Array(hh.inflate(t.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(hh.inflate(t.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(hh.inflate(t.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(hh.inflate(t.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveColor:new Uint8Array(hh.inflate(t.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(hh.inflate(t.primitiveInstances).buffer),eachEntityId:hh.inflate(t.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(hh.inflate(t.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(hh.inflate(t.eachEntityMatricesPortion).buffer)}}(function(t){return{positions:t[0],normals:t[1],indices:t[2],edgeIndices:t[3],matrices:t[4],eachPrimitivePositionsAndNormalsPortion:t[5],eachPrimitiveIndicesPortion:t[6],eachPrimitiveEdgeIndicesPortion:t[7],eachPrimitiveColor:t[8],primitiveInstances:t[9],eachEntityId:t[10],eachEntityPrimitiveInstancesPortion:t[11],eachEntityMatricesPortion:t[12]}}(i)),r)}},ph=window.pako||ql;ph.inflate||(ph=ph.default);var dh,fh=(dh=new Float32Array(3),function(t){return dh[0]=t[0]/255,dh[1]=t[1]/255,dh[2]=t[2]/255,dh});var _h={version:6,parse:function(t,e,i,r){!function(t,e,i,r){for(var s=i.positions,o=i.normals,a=i.indices,n=i.edgeIndices,l=i.matrices,h=i.reusedPrimitivesDecodeMatrix,u=i.eachPrimitivePositionsAndNormalsPortion,c=i.eachPrimitiveIndicesPortion,p=i.eachPrimitiveEdgeIndicesPortion,d=i.eachPrimitiveColorAndOpacity,f=i.primitiveInstances,_=JSON.parse(i.eachEntityId),g=i.eachEntityPrimitiveInstancesPortion,m=i.eachEntityMatricesPortion,v=i.eachTileAABB,b=i.eachTileEntitiesPortion,y=u.length,P=f.length,M=_.length,x=b.length,w=0,C=new Uint32Array(y),A=0;A<P;A++){var S=f[A];void 0!==C[S]?C[S]++:C[S]=1}for(var D=E.vec3(),L=E.AABB3(),R=0;R<x;R++){var T=R===x-1,F=b[R],N=T?M:b[R+1],I=6*R,k=v.subarray(I,I+6);E.getAABB3Center(k,D),L[0]=k[0]-D[0],L[1]=k[1]-D[1],L[2]=k[2]-D[2],L[3]=k[3]-D[0],L[4]=k[4]-D[1],L[5]=k[5]-D[2];for(var O=Re.createPositionsDecodeMatrix(L),V={},z=F;z<N;z++){var U=_[z],j=e.globalizeObjectIds?E.globalizeObjectId(r.id,U):U,G=m[z],X=l.slice(G,G+16),W=z===M-1,H=g[z],Y=W?f.length:g[z+1],K=[],q=t.metaScene.metaObjects[j],Z={},Q={};if(q){if(e.excludeTypesMap&&q.type&&e.excludeTypesMap[q.type])continue;if(e.includeTypesMap&&q.type&&!e.includeTypesMap[q.type])continue;var J=e.objectDefaults?e.objectDefaults[q.type]||e.objectDefaults.DEFAULT:null;J&&(!1===J.visible&&(Z.visible=!1),!1===J.pickable&&(Z.pickable=!1),J.colorize&&(Q.color=J.colorize),void 0!==J.opacity&&null!==J.opacity&&(Q.opacity=J.opacity))}else if(e.excludeUnclassifiedObjects)continue;for(var $=H;$<Y;$++){var tt=f[$],et=C[tt]>1,it=tt===y-1,rt=s.subarray(u[tt],it?s.length:u[tt+1]),st=o.subarray(u[tt],it?o.length:u[tt+1]),ot=a.subarray(c[tt],it?a.length:c[tt+1]),at=n.subarray(p[tt],it?n.length:p[tt+1]),nt=fh(d.subarray(4*tt,4*tt+3)),lt=d[4*tt+3]/255,ht=w++;if(et){var ut="geometry."+R+"."+tt;V[ut]||(r.createGeometry({id:ut,rtcCenter:D,primitive:"triangles",positions:rt,normals:st,indices:ot,edgeIndices:at,positionsDecodeMatrix:h}),V[ut]=!0),r.createMesh(B.apply(Q,{id:ht,geometryId:ut,matrix:X,color:nt,opacity:lt})),K.push(ht)}else r.createMesh(B.apply(Q,{id:ht,rtcCenter:D,primitive:"triangles",positions:rt,normals:st,indices:ot,edgeIndices:at,positionsDecodeMatrix:O,color:nt,opacity:lt})),K.push(ht)}K.length>0&&r.createEntity(B.apply(Z,{id:j,isObject:!0,meshIds:K}))}}}(t,e,function(t){function e(t,e){return 0===t.length?[]:ph.inflate(t,e).buffer}return{positions:new Uint16Array(e(t.positions)),normals:new Int8Array(e(t.normals)),indices:new Uint32Array(e(t.indices)),edgeIndices:new Uint32Array(e(t.edgeIndices)),matrices:new Float32Array(e(t.matrices)),reusedPrimitivesDecodeMatrix:new Float32Array(e(t.reusedPrimitivesDecodeMatrix)),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(e(t.eachPrimitivePositionsAndNormalsPortion)),eachPrimitiveIndicesPortion:new Uint32Array(e(t.eachPrimitiveIndicesPortion)),eachPrimitiveEdgeIndicesPortion:new Uint32Array(e(t.eachPrimitiveEdgeIndicesPortion)),eachPrimitiveColorAndOpacity:new Uint8Array(e(t.eachPrimitiveColorAndOpacity)),primitiveInstances:new Uint32Array(e(t.primitiveInstances)),eachEntityId:ph.inflate(t.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(e(t.eachEntityPrimitiveInstancesPortion)),eachEntityMatricesPortion:new Uint32Array(e(t.eachEntityMatricesPortion)),eachTileAABB:new Float64Array(e(t.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(t.eachTileEntitiesPortion))}}(function(t){return{positions:t[0],normals:t[1],indices:t[2],edgeIndices:t[3],matrices:t[4],reusedPrimitivesDecodeMatrix:t[5],eachPrimitivePositionsAndNormalsPortion:t[6],eachPrimitiveIndicesPortion:t[7],eachPrimitiveEdgeIndicesPortion:t[8],eachPrimitiveColorAndOpacity:t[9],primitiveInstances:t[10],eachEntityId:t[11],eachEntityPrimitiveInstancesPortion:t[12],eachEntityMatricesPortion:t[13],eachTileAABB:t[14],eachTileEntitiesPortion:t[15]}}(i)),r)}},gh=window.pako||ql;gh.inflate||(gh=gh.default);var mh=function(){var t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();function vh(t){for(var e=[],i=0,r=t.length;i<r;i+=3)e.push(t[i]),e.push(t[i+1]),e.push(t[i+2]),e.push(1);return e}var bh={version:7,parse:function(t,e,i,r){!function(t,e,i,r){for(var s=i.positions,o=i.normals,a=i.colors,n=i.indices,l=i.edgeIndices,h=i.matrices,u=i.reusedGeometriesDecodeMatrix,c=i.eachGeometryPrimitiveType,p=i.eachGeometryPositionsPortion,d=i.eachGeometryNormalsPortion,f=i.eachGeometryColorsPortion,_=i.eachGeometryIndicesPortion,g=i.eachGeometryEdgeIndicesPortion,m=i.eachMeshGeometriesPortion,v=i.eachMeshMatricesPortion,b=i.eachMeshMaterial,y=JSON.parse(i.eachEntityId),P=i.eachEntityMeshesPortion,M=i.eachTileAABB,x=i.eachTileEntitiesPortion,w=p.length,C=m.length,A=y.length,S=x.length,D=0,L=new Uint32Array(w),R=0;R<C;R++){var T=m[R];void 0!==L[T]?L[T]++:L[T]=1}for(var F=E.vec3(),N=E.AABB3(),I=0;I<S;I++){var k=I===S-1,O=x[I],V=k?A:x[I+1],z=6*I,U=M.subarray(z,z+6);E.getAABB3Center(U,F),N[0]=U[0]-F[0],N[1]=U[1]-F[1],N[2]=U[2]-F[2],N[3]=U[3]-F[0],N[4]=U[4]-F[1],N[5]=U[5]-F[2];for(var j=Re.createPositionsDecodeMatrix(N),G={},X=O;X<V;X++){var W=y[X],H=e.globalizeObjectIds?E.globalizeObjectId(r.id,W):W,Y=X===A-1,K=P[X],q=Y?m.length:P[X+1],Z=[],Q=t.metaScene.metaObjects[H],J={},$={};if(Q){if(e.excludeTypesMap&&Q.type&&e.excludeTypesMap[Q.type])continue;if(e.includeTypesMap&&Q.type&&!e.includeTypesMap[Q.type])continue;var tt=e.objectDefaults?e.objectDefaults[Q.type]||e.objectDefaults.DEFAULT:null;tt&&(!1===tt.visible&&(J.visible=!1),!1===tt.pickable&&(J.pickable=!1),tt.colorize&&($.color=tt.colorize),void 0!==tt.opacity&&null!==tt.opacity&&($.opacity=tt.opacity),void 0!==tt.metallic&&null!==tt.metallic&&($.metallic=tt.metallic),void 0!==tt.roughness&&null!==tt.roughness&&($.roughness=tt.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(var et=K;et<q;et++){var it=m[et],rt=L[it]>1,st=it===w-1,ot=mh(b.subarray(6*et,6*et+3)),at=b[6*et+3]/255,nt=b[6*et+4]/255,lt=b[6*et+5]/255,ht=D++;if(rt){var ut=v[et],ct=h.slice(ut,ut+16),pt="geometry."+I+"."+it;if(!G[pt]){var dt=void 0,ft=void 0,_t=void 0,gt=void 0,mt=void 0,vt=void 0;switch(c[it]){case 0:dt="solid",ft=s.subarray(p[it],st?s.length:p[it+1]),_t=o.subarray(d[it],st?o.length:d[it+1]),mt=n.subarray(_[it],st?n.length:_[it+1]),vt=l.subarray(g[it],st?l.length:g[it+1]);break;case 1:dt="surface",ft=s.subarray(p[it],st?s.length:p[it+1]),_t=o.subarray(d[it],st?o.length:d[it+1]),mt=n.subarray(_[it],st?n.length:_[it+1]),vt=l.subarray(g[it],st?l.length:g[it+1]);break;case 2:dt="points",ft=s.subarray(p[it],st?s.length:p[it+1]),gt=vh(a.subarray(f[it],st?a.length:f[it+1]));break;case 3:dt="lines",ft=s.subarray(p[it],st?s.length:p[it+1]),mt=n.subarray(_[it],st?n.length:_[it+1]);break;default:continue}r.createGeometry({id:pt,rtcCenter:F,primitive:dt,positions:ft,normals:_t,colors:gt,indices:mt,edgeIndices:vt,positionsDecodeMatrix:u}),G[pt]=!0}r.createMesh(B.apply($,{id:ht,geometryId:pt,matrix:ct,color:ot,metallic:nt,roughness:lt,opacity:at})),Z.push(ht)}else{var bt=void 0,yt=void 0,Pt=void 0,Mt=void 0,xt=void 0,wt=void 0;switch(c[it]){case 0:bt="solid",yt=s.subarray(p[it],st?s.length:p[it+1]),Pt=o.subarray(d[it],st?o.length:d[it+1]),xt=n.subarray(_[it],st?n.length:_[it+1]),wt=l.subarray(g[it],st?l.length:g[it+1]);break;case 1:bt="surface",yt=s.subarray(p[it],st?s.length:p[it+1]),Pt=o.subarray(d[it],st?o.length:d[it+1]),xt=n.subarray(_[it],st?n.length:_[it+1]),wt=l.subarray(g[it],st?l.length:g[it+1]);break;case 2:bt="points",yt=s.subarray(p[it],st?s.length:p[it+1]),Mt=vh(a.subarray(f[it],st?a.length:f[it+1]));break;case 3:bt="lines",yt=s.subarray(p[it],st?s.length:p[it+1]),xt=n.subarray(_[it],st?n.length:_[it+1]);break;default:continue}r.createMesh(B.apply($,{id:ht,rtcCenter:F,primitive:bt,positions:yt,normals:Pt,colors:Mt,indices:xt,edgeIndices:wt,positionsDecodeMatrix:j,color:ot,metallic:nt,roughness:lt,opacity:at})),Z.push(ht)}}Z.length>0&&r.createEntity(B.apply(J,{id:H,isObject:!0,meshIds:Z}))}}}(t,e,function(t){function e(t,e){return 0===t.length?[]:gh.inflate(t,e).buffer}return{positions:new Uint16Array(e(t.positions)),normals:new Int8Array(e(t.normals)),colors:new Uint8Array(e(t.colors)),indices:new Uint32Array(e(t.indices)),edgeIndices:new Uint32Array(e(t.edgeIndices)),matrices:new Float32Array(e(t.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(t.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(t.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(t.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(t.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(t.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(t.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(t.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(t.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(t.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(t.eachMeshMaterial)),eachEntityId:gh.inflate(t.eachEntityId,{to:"string"}),eachEntityMeshesPortion:new Uint32Array(e(t.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(t.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(t.eachTileEntitiesPortion))}}(function(t){return{positions:t[0],normals:t[1],colors:t[2],indices:t[3],edgeIndices:t[4],matrices:t[5],reusedGeometriesDecodeMatrix:t[6],eachGeometryPrimitiveType:t[7],eachGeometryPositionsPortion:t[8],eachGeometryNormalsPortion:t[9],eachGeometryColorsPortion:t[10],eachGeometryIndicesPortion:t[11],eachGeometryEdgeIndicesPortion:t[12],eachMeshGeometriesPortion:t[13],eachMeshMatricesPortion:t[14],eachMeshMaterial:t[15],eachEntityId:t[16],eachEntityMeshesPortion:t[17],eachTileAABB:t[18],eachTileEntitiesPortion:t[19]}}(i)),r)}},yh=window.pako||ql;yh.inflate||(yh=yh.default);var Ph=function(){var t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();function Mh(t){for(var e=[],i=0,r=t.length;i<r;i+=3)e.push(t[i]),e.push(t[i+1]),e.push(t[i+2]),e.push(1);return e}var xh={version:8,parse:function(t,e,i,r){!function(t,e,i,r){var s=JSON.parse(i.types),o=JSON.parse(i.eachMetaObjectId),a=i.eachMetaObjectType,n=JSON.parse(i.eachMetaObjectName),l=i.eachMetaObjectParent,h=i.positions,u=i.normals,c=i.colors,p=i.indices,d=i.edgeIndices,f=i.matrices,_=i.reusedGeometriesDecodeMatrix,g=i.eachGeometryPrimitiveType,m=i.eachGeometryPositionsPortion,v=i.eachGeometryNormalsPortion,b=i.eachGeometryColorsPortion,y=i.eachGeometryIndicesPortion,P=i.eachGeometryEdgeIndicesPortion,M=i.eachMeshGeometriesPortion,x=i.eachMeshMatricesPortion,w=i.eachMeshMaterial,C=i.eachEntityMetaObject,A=i.eachEntityMeshesPortion,S=i.eachTileAABB,D=i.eachTileEntitiesPortion,L=o.length,R=m.length,T=M.length,F=C.length,N=D.length,I=0,k=r.id;if(!t.metaScene.metaModels[k]){for(var O={metaObjects:[]},V=0;V<L;V++){var z=o[V],U=s[a[V]]||"default",j=n[V],G=l[V],X=G!==V?o[G]:null;O.metaObjects.push({id:z,type:U,name:j,parent:X})}t.metaScene.createMetaModel(k,O,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds}),r.once("destroyed",(function(){t.metaScene.destroyMetaModel(k)}))}for(var W=new Uint32Array(R),H=0;H<T;H++){var Y=M[H];void 0!==W[Y]?W[Y]++:W[Y]=1}for(var K=E.vec3(),q=E.AABB3(),Z=0;Z<N;Z++){var Q=Z===N-1,J=D[Z],$=Q?F:D[Z+1],tt=6*Z,et=S.subarray(tt,tt+6);E.getAABB3Center(et,K),q[0]=et[0]-K[0],q[1]=et[1]-K[1],q[2]=et[2]-K[2],q[3]=et[3]-K[0],q[4]=et[4]-K[1],q[5]=et[5]-K[2];for(var it=Re.createPositionsDecodeMatrix(q),rt={},st=J;st<$;st++){var ot=o[C[st]],at=e.globalizeObjectIds?E.globalizeObjectId(r.id,ot):ot,nt=st===F-1,lt=A[st],ht=nt?M.length:A[st+1],ut=[],ct=t.metaScene.metaObjects[at],pt={},dt={};if(ct){if(e.excludeTypesMap&&ct.type&&e.excludeTypesMap[ct.type])continue;if(e.includeTypesMap&&ct.type&&!e.includeTypesMap[ct.type])continue;var ft=e.objectDefaults?e.objectDefaults[ct.type]||e.objectDefaults.DEFAULT:null;ft&&(!1===ft.visible&&(pt.visible=!1),!1===ft.pickable&&(pt.pickable=!1),ft.colorize&&(dt.color=ft.colorize),void 0!==ft.opacity&&null!==ft.opacity&&(dt.opacity=ft.opacity),void 0!==ft.metallic&&null!==ft.metallic&&(dt.metallic=ft.metallic),void 0!==ft.roughness&&null!==ft.roughness&&(dt.roughness=ft.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(var _t=lt;_t<ht;_t++){var gt=M[_t],mt=W[gt]>1,vt=gt===R-1,bt=Ph(w.subarray(6*_t,6*_t+3)),yt=w[6*_t+3]/255,Pt=w[6*_t+4]/255,Mt=w[6*_t+5]/255,xt=I++;if(mt){var wt=x[_t],Et=f.slice(wt,wt+16),Ct="geometry."+Z+"."+gt;if(!rt[Ct]){var At=void 0,St=void 0,Dt=void 0,Lt=void 0,Bt=void 0,Rt=void 0,Tt=!1;switch(g[gt]){case 0:At="solid",St=h.subarray(m[gt],vt?h.length:m[gt+1]),Dt=u.subarray(v[gt],vt?u.length:v[gt+1]),Bt=p.subarray(y[gt],vt?p.length:y[gt+1]),Rt=d.subarray(P[gt],vt?d.length:P[gt+1]),Tt=St.length>0&&Bt.length>0;break;case 1:At="surface",St=h.subarray(m[gt],vt?h.length:m[gt+1]),Dt=u.subarray(v[gt],vt?u.length:v[gt+1]),Bt=p.subarray(y[gt],vt?p.length:y[gt+1]),Rt=d.subarray(P[gt],vt?d.length:P[gt+1]),Tt=St.length>0&&Bt.length>0;break;case 2:At="points",St=h.subarray(m[gt],vt?h.length:m[gt+1]),Lt=Mh(c.subarray(b[gt],vt?c.length:b[gt+1])),Tt=St.length>0;break;case 3:At="lines",St=h.subarray(m[gt],vt?h.length:m[gt+1]),Bt=p.subarray(y[gt],vt?p.length:y[gt+1]),Tt=St.length>0&&Bt.length>0;break;default:continue}Tt&&(r.createGeometry({id:Ct,rtcCenter:K,primitive:At,positions:St,normals:Dt,colorsCompressed:Lt,indices:Bt,edgeIndices:Rt,positionsDecodeMatrix:_}),rt[Ct]=!0)}rt[Ct]&&(r.createMesh(B.apply(dt,{id:xt,geometryId:Ct,matrix:Et,color:bt,metallic:Pt,roughness:Mt,opacity:yt})),ut.push(xt))}else{var Ft=void 0,Nt=void 0,It=void 0,kt=void 0,Ot=void 0,Vt=void 0,zt=!1;switch(g[gt]){case 0:Ft="solid",Nt=h.subarray(m[gt],vt?h.length:m[gt+1]),It=u.subarray(v[gt],vt?u.length:v[gt+1]),Ot=p.subarray(y[gt],vt?p.length:y[gt+1]),Vt=d.subarray(P[gt],vt?d.length:P[gt+1]),zt=Nt.length>0&&Ot.length>0;break;case 1:Ft="surface",Nt=h.subarray(m[gt],vt?h.length:m[gt+1]),It=u.subarray(v[gt],vt?u.length:v[gt+1]),Ot=p.subarray(y[gt],vt?p.length:y[gt+1]),Vt=d.subarray(P[gt],vt?d.length:P[gt+1]),zt=Nt.length>0&&Ot.length>0;break;case 2:Ft="points",Nt=h.subarray(m[gt],vt?h.length:m[gt+1]),kt=Mh(c.subarray(b[gt],vt?c.length:b[gt+1])),zt=Nt.length>0;break;case 3:Ft="lines",Nt=h.subarray(m[gt],vt?h.length:m[gt+1]),Ot=p.subarray(y[gt],vt?p.length:y[gt+1]),zt=Nt.length>0&&Ot.length>0;break;default:continue}zt&&(r.createMesh(B.apply(dt,{id:xt,rtcCenter:K,primitive:Ft,positions:Nt,normals:It,colorsCompressed:kt,indices:Ot,edgeIndices:Vt,positionsDecodeMatrix:it,color:bt,metallic:Pt,roughness:Mt,opacity:yt})),ut.push(xt))}}ut.length>0&&r.createEntity(B.apply(pt,{id:at,isObject:!0,meshIds:ut}))}}}(t,e,function(t){function e(t,e){return 0===t.length?[]:yh.inflate(t,e).buffer}return{types:yh.inflate(t.types,{to:"string"}),eachMetaObjectId:yh.inflate(t.eachMetaObjectId,{to:"string"}),eachMetaObjectType:new Uint32Array(e(t.eachMetaObjectType)),eachMetaObjectName:yh.inflate(t.eachMetaObjectName,{to:"string"}),eachMetaObjectParent:new Uint32Array(e(t.eachMetaObjectParent)),positions:new Uint16Array(e(t.positions)),normals:new Int8Array(e(t.normals)),colors:new Uint8Array(e(t.colors)),indices:new Uint32Array(e(t.indices)),edgeIndices:new Uint32Array(e(t.edgeIndices)),matrices:new Float32Array(e(t.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(t.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(t.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(t.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(t.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(t.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(t.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(t.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(t.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(t.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(t.eachMeshMaterial)),eachEntityMetaObject:new Uint32Array(e(t.eachEntityMetaObject)),eachEntityMeshesPortion:new Uint32Array(e(t.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(t.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(t.eachTileEntitiesPortion))}}(function(t){return{types:t[0],eachMetaObjectId:t[1],eachMetaObjectType:t[2],eachMetaObjectName:t[3],eachMetaObjectParent:t[4],positions:t[5],normals:t[6],colors:t[7],indices:t[8],edgeIndices:t[9],matrices:t[10],reusedGeometriesDecodeMatrix:t[11],eachGeometryPrimitiveType:t[12],eachGeometryPositionsPortion:t[13],eachGeometryNormalsPortion:t[14],eachGeometryColorsPortion:t[15],eachGeometryIndicesPortion:t[16],eachGeometryEdgeIndicesPortion:t[17],eachMeshGeometriesPortion:t[18],eachMeshMatricesPortion:t[19],eachMeshMaterial:t[20],eachEntityMetaObject:t[21],eachEntityMeshesPortion:t[22],eachTileAABB:t[23],eachTileEntitiesPortion:t[24]}}(i)),r)}},wh=window.pako||ql;wh.inflate||(wh=wh.default);var Eh=function(){var t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();var Ch={version:9,parse:function(t,e,i,r){!function(t,e,i,r){var s=i.metadata,o=i.positions,a=i.normals,n=i.colors,l=i.indices,h=i.edgeIndices,u=i.matrices,c=i.reusedGeometriesDecodeMatrix,p=i.eachGeometryPrimitiveType,d=i.eachGeometryPositionsPortion,f=i.eachGeometryNormalsPortion,_=i.eachGeometryColorsPortion,g=i.eachGeometryIndicesPortion,m=i.eachGeometryEdgeIndicesPortion,v=i.eachMeshGeometriesPortion,b=i.eachMeshMatricesPortion,y=i.eachMeshMaterial,P=i.eachEntityId,M=i.eachEntityMeshesPortion,x=i.eachTileAABB,w=i.eachTileEntitiesPortion,C=d.length,A=v.length,S=M.length,D=w.length,L=0,R=r.id;t.metaScene.metaModels[R]||(t.metaScene.createMetaModel(R,s,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds}),r.once("destroyed",(function(){t.metaScene.destroyMetaModel(R)})));for(var T=new Uint32Array(C),F=0;F<A;F++){var N=v[F];void 0!==T[N]?T[N]++:T[N]=1}for(var I=E.vec3(),k=E.AABB3(),O=0;O<D;O++){var V=O===D-1,z=w[O],U=V?S-1:w[O+1]-1,j=6*O,G=x.subarray(j,j+6);E.getAABB3Center(G,I),k[0]=G[0]-I[0],k[1]=G[1]-I[1],k[2]=G[2]-I[2],k[3]=G[3]-I[0],k[4]=G[4]-I[1],k[5]=G[5]-I[2];for(var X=Re.createPositionsDecodeMatrix(k),W={},H=z;H<=U;H++){var Y=P[H],K=e.globalizeObjectIds?E.globalizeObjectId(r.id,Y):Y,q=H===S-1,Z=M[H],Q=q?v.length-1:M[H+1]-1,J=[],$=t.metaScene.metaObjects[K],tt={},et={};if($){if(e.excludeTypesMap&&$.type&&e.excludeTypesMap[$.type])continue;if(e.includeTypesMap&&$.type&&!e.includeTypesMap[$.type])continue;var it=e.objectDefaults?e.objectDefaults[$.type]||e.objectDefaults.DEFAULT:null;it&&(!1===it.visible&&(tt.visible=!1),!1===it.pickable&&(tt.pickable=!1),it.colorize&&(et.color=it.colorize),void 0!==it.opacity&&null!==it.opacity&&(et.opacity=it.opacity),void 0!==it.metallic&&null!==it.metallic&&(et.metallic=it.metallic),void 0!==it.roughness&&null!==it.roughness&&(et.roughness=it.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(var rt=Z;rt<=Q;rt++){var st=v[rt],ot=T[st]>1,at=st===C-1,nt=Eh(y.subarray(6*rt,6*rt+3)),lt=y[6*rt+3]/255,ht=y[6*rt+4]/255,ut=y[6*rt+5]/255,ct=L++;if(ot){var pt=b[rt],dt=u.slice(pt,pt+16),ft="geometry."+O+"."+st;if(!W[ft]){var _t=void 0,gt=void 0,mt=void 0,vt=void 0,bt=void 0,yt=void 0,Pt=!1;switch(p[st]){case 0:_t="solid",gt=o.subarray(d[st],at?o.length:d[st+1]),mt=a.subarray(f[st],at?a.length:f[st+1]),bt=l.subarray(g[st],at?l.length:g[st+1]),yt=h.subarray(m[st],at?h.length:m[st+1]),Pt=gt.length>0&&bt.length>0;break;case 1:_t="surface",gt=o.subarray(d[st],at?o.length:d[st+1]),mt=a.subarray(f[st],at?a.length:f[st+1]),bt=l.subarray(g[st],at?l.length:g[st+1]),yt=h.subarray(m[st],at?h.length:m[st+1]),Pt=gt.length>0&&bt.length>0;break;case 2:_t="points",gt=o.subarray(d[st],at?o.length:d[st+1]),vt=n.subarray(_[st],at?n.length:_[st+1]),Pt=gt.length>0;break;case 3:_t="lines",gt=o.subarray(d[st],at?o.length:d[st+1]),bt=l.subarray(g[st],at?l.length:g[st+1]),Pt=gt.length>0&&bt.length>0;break;default:continue}Pt&&(r.createGeometry({id:ft,rtcCenter:I,primitive:_t,positions:gt,normals:mt,colorsCompressed:vt,indices:bt,edgeIndices:yt,positionsDecodeMatrix:c}),W[ft]=!0)}W[ft]&&(r.createMesh(B.apply(et,{id:ct,geometryId:ft,matrix:dt,color:nt,metallic:ht,roughness:ut,opacity:lt})),J.push(ct))}else{var Mt=void 0,xt=void 0,wt=void 0,Et=void 0,Ct=void 0,At=void 0,St=!1;switch(p[st]){case 0:Mt="solid",xt=o.subarray(d[st],at?o.length:d[st+1]),wt=a.subarray(f[st],at?a.length:f[st+1]),Ct=l.subarray(g[st],at?l.length:g[st+1]),At=h.subarray(m[st],at?h.length:m[st+1]),St=xt.length>0&&Ct.length>0;break;case 1:Mt="surface",xt=o.subarray(d[st],at?o.length:d[st+1]),wt=a.subarray(f[st],at?a.length:f[st+1]),Ct=l.subarray(g[st],at?l.length:g[st+1]),At=h.subarray(m[st],at?h.length:m[st+1]),St=xt.length>0&&Ct.length>0;break;case 2:Mt="points",xt=o.subarray(d[st],at?o.length:d[st+1]),Et=n.subarray(_[st],at?n.length:_[st+1]),St=xt.length>0;break;case 3:Mt="lines",xt=o.subarray(d[st],at?o.length:d[st+1]),Ct=l.subarray(g[st],at?l.length:g[st+1]),St=xt.length>0&&Ct.length>0;break;default:continue}St&&(r.createMesh(B.apply(et,{id:ct,rtcCenter:I,primitive:Mt,positions:xt,normals:wt,colorsCompressed:Et,indices:Ct,edgeIndices:At,positionsDecodeMatrix:X,color:nt,metallic:ht,roughness:ut,opacity:lt})),J.push(ct))}}J.length>0&&r.createEntity(B.apply(tt,{id:K,isObject:!0,meshIds:J}))}}}(t,e,function(t){function e(t,e){return 0===t.length?[]:wh.inflate(t,e).buffer}return{metadata:JSON.parse(wh.inflate(t.metadata,{to:"string"})),positions:new Uint16Array(e(t.positions)),normals:new Int8Array(e(t.normals)),colors:new Uint8Array(e(t.colors)),indices:new Uint32Array(e(t.indices)),edgeIndices:new Uint32Array(e(t.edgeIndices)),matrices:new Float32Array(e(t.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(t.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(t.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(t.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(t.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(t.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(t.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(t.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(t.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(t.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(t.eachMeshMaterial)),eachEntityId:JSON.parse(wh.inflate(t.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(e(t.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(t.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(t.eachTileEntitiesPortion))}}(function(t){return{metadata:t[0],positions:t[1],normals:t[2],colors:t[3],indices:t[4],edgeIndices:t[5],matrices:t[6],reusedGeometriesDecodeMatrix:t[7],eachGeometryPrimitiveType:t[8],eachGeometryPositionsPortion:t[9],eachGeometryNormalsPortion:t[10],eachGeometryColorsPortion:t[11],eachGeometryIndicesPortion:t[12],eachGeometryEdgeIndicesPortion:t[13],eachMeshGeometriesPortion:t[14],eachMeshMatricesPortion:t[15],eachMeshMaterial:t[16],eachEntityId:t[17],eachEntityMeshesPortion:t[18],eachTileAABB:t[19],eachTileEntitiesPortion:t[20]}}(i)),r)}},Ah={};Ah[$l.version]=$l,Ah[ih.version]=ih,Ah[oh.version]=oh,Ah[lh.version]=lh,Ah[ch.version]=ch,Ah[_h.version]=_h,Ah[bh.version]=bh,Ah[xh.version]=xh,Ah[Ch.version]=Ch;var Sh=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,"XKTLoader",e,i),this._maxGeometryBatchSize=i.maxGeometryBatchSize,this.dataSource=i.dataSource,this.objectDefaults=i.objectDefaults,this.includeTypes=i.includeTypes,this.excludeTypes=i.excludeTypes,this.excludeUnclassifiedObjects=i.excludeUnclassifiedObjects}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={supportedVersions:{configurable:!0},dataSource:{configurable:!0},objectDefaults:{configurable:!0},includeTypes:{configurable:!0},excludeTypes:{configurable:!0},excludeUnclassifiedObjects:{configurable:!0},globalizeObjectIds:{configurable:!0}};return i.supportedVersions.get=function(){return Object.keys(Ah)},i.dataSource.set=function(t){this._dataSource=t||new Kl},i.dataSource.get=function(){return this._dataSource},i.objectDefaults.set=function(t){this._objectDefaults=t||Gn},i.objectDefaults.get=function(){return this._objectDefaults},i.includeTypes.set=function(t){this._includeTypes=t},i.includeTypes.get=function(){return this._includeTypes},i.excludeTypes.set=function(t){this._excludeTypes=t},i.excludeTypes.get=function(){return this._excludeTypes},i.excludeUnclassifiedObjects.set=function(t){this._excludeUnclassifiedObjects=!!t},i.excludeUnclassifiedObjects.get=function(){return this._excludeUnclassifiedObjects},i.globalizeObjectIds.set=function(t){this._globalizeObjectIds=!!t},i.globalizeObjectIds.get=function(){return this._globalizeObjectIds},e.prototype.load=function(t){var e=this;void 0===t&&(t={}),t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);var i=new nn(this.viewer.scene,B.apply(t,{isModel:!0,maxGeometryBatchSize:this._maxGeometryBatchSize})),r=i.id;if(!t.src&&!t.xkt)return this.error("load() param expected: src or xkt"),i;var s={},o=t.includeTypes||this._includeTypes,a=t.excludeTypes||this._excludeTypes,n=t.objectDefaults||this._objectDefaults;if(o){s.includeTypesMap={};for(var l=0,h=o.length;l<h;l++)s.includeTypesMap[o[l]]=!0}if(a){s.excludeTypesMap={};for(var u=0,c=a.length;u<c;u++)s.excludeTypesMap[a[u]]=!0}if(n&&(s.objectDefaults=n),s.excludeUnclassifiedObjects=void 0!==t.excludeUnclassifiedObjects?!!t.excludeUnclassifiedObjects:this._excludeUnclassifiedObjects,s.globalizeObjectIds=void 0!==t.globalizeObjectIds?!!t.globalizeObjectIds:this._globalizeObjectIds,t.metaModelSrc||t.metaModelData){var p=function(n){return!!e.viewer.metaScene.createMetaModel(r,n,{includeTypes:o,excludeTypes:a,globalizeObjectIds:e.globalizeObjectIds})&&(t.src?e._loadModel(t.src,t,s,i):e._parseModel(t.xkt,t,s,i),i.once("destroyed",(function(){e.viewer.metaScene.destroyMetaModel(i.id)})),!0)};if(t.metaModelSrc){var d=t.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(d,(function(t){i.destroyed||(p(t)||(e.error("load(): Failed to load model metadata for model '"+r+" from '"+d+"' - metadata not valid"),i.fire("error","Metadata not valid")),e.viewer.scene.canvas.spinner.processes--)}),(function(t){e.error("load(): Failed to load model metadata for model '"+r+" from  '"+d+"' - "+t),i.fire("error","Failed to load model metadata from  '"+d+"' - "+t),e.viewer.scene.canvas.spinner.processes--}))}else t.metaModelData&&(p(t.metaModelData)||(this.error("load(): Failed to load model metadata for model '"+r+" from '"+t.metaModelSrc+"' - metadata not valid"),i.fire("error","Metadata not valid")))}else t.src?this._loadModel(t.src,t,s,i):this._parseModel(t.xkt,t,s,i);return i},e.prototype._loadModel=function(t,e,i,r){var s=this,o=this.viewer.scene.canvas.spinner;o.processes++,this._dataSource.getXKT(e.src,(function(t){s._parseModel(t,e,i,r),o.processes--}),(function(t){o.processes--,s.error(t),r.fire("error",t)}))},e.prototype._parseModel=function(t,e,i,r){if(!r.destroyed){var s=new DataView(t),o=new Uint8Array(t),a=s.getUint32(0,!0),n=Ah[a];if(n){this.log("Loading .xkt V"+a);for(var l=s.getUint32(4,!0),h=[],u=4*(l+2),c=0;c<l;c++){var p=s.getUint32(4*(c+2),!0);h.push(o.subarray(u,u+p)),u+=p}n.parse(this.viewer,i,h,r),r.finalize(),this._createDefaultMetaModelIfNeeded(r,e,i),r.scene.once("tick",(function(){r.destroyed||(r.scene.fire("modelLoaded",r.id),r.fire("loaded",!0,!1))}))}else this.error("Unsupported .XKT file version: "+a+" - this XKTLoaderPlugin supports versions "+Object.keys(Ah))}},e.prototype._createDefaultMetaModelIfNeeded=function(t,e,i){var r=this,s=t.id;if(!this.viewer.metaScene.metaModels[s]){var o={metaObjects:[]};o.metaObjects.push({id:s,type:"default",name:s,parent:null});for(var a=t.entityList,n=0,l=a.length;n<l;n++){var h=a[n];h.isObject&&o.metaObjects.push({id:h.id,type:"default",name:h.id,parent:s})}var u=e.src;this.viewer.metaScene.createMetaModel(s,o,{includeTypes:i.includeTypes,excludeTypes:i.excludeTypes,globalizeObjectIds:i.globalizeObjectIds,getProperties:async function(t){return await r._dataSource.getProperties(u,t)}}),t.once("destroyed",(function(){r.viewer.metaScene.destroyMetaModel(s)}))}},Object.defineProperties(e.prototype,i),e}(n),Dh=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({type:"LambertMaterial",ambient:E.vec3([1,1,1]),color:E.vec3([1,1,1]),emissive:E.vec3([0,0,0]),alpha:null,alphaMode:0,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:"/lam;"}),this.ambient=i.ambient,this.color=i.color,this.emissive=i.emissive,this.alpha=i.alpha,this.lineWidth=i.lineWidth,this.pointSize=i.pointSize,this.backfaces=i.backfaces,this.frontface=i.frontface}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},ambient:{configurable:!0},color:{configurable:!0},emissive:{configurable:!0},alpha:{configurable:!0},lineWidth:{configurable:!0},pointSize:{configurable:!0},backfaces:{configurable:!0},frontface:{configurable:!0}};return i.type.get=function(){return"LambertMaterial"},i.ambient.set=function(t){var e=this._state.ambient;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.ambient=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()},i.ambient.get=function(){return this._state.ambient},i.color.set=function(t){var e=this._state.color;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.color=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()},i.color.get=function(){return this._state.color},i.emissive.set=function(t){var e=this._state.emissive;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.emissive=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=0,e[1]=0,e[2]=0),this.glRedraw()},i.emissive.get=function(){return this._state.emissive},i.alpha.set=function(t){t=null!=t?t:1,this._state.alpha!==t&&(this._state.alpha=t,this._state.alphaMode=t<1?2:0,this.glRedraw())},i.alpha.get=function(){return this._state.alpha},i.lineWidth.set=function(t){this._state.lineWidth=t||1,this.glRedraw()},i.lineWidth.get=function(){return this._state.lineWidth},i.pointSize.set=function(t){this._state.pointSize=t||1,this.glRedraw()},i.pointSize.get=function(){return this._state.pointSize},i.backfaces.set=function(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())},i.backfaces.get=function(){return this._state.backfaces},i.frontface.set=function(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this.glRedraw())},i.frontface.get=function(){return this._state.frontface?"ccw":"cw"},e.prototype._getState=function(){return this._state},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy()},Object.defineProperties(e.prototype,i),e}(Ve),Lh={};!function(t){var e,i="File format is not recognized.",r="Error while reading zip file.",s="Error while reading file data.",o=524288,a="text/plain";try{e=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(t){}function n(){this.crc=-1}function l(){}function h(t,e){var i,r;return i=new ArrayBuffer(t),r=new Uint8Array(i),e&&r.set(e,0),{buffer:i,array:r,view:new DataView(i)}}function u(){}function c(t){var e,i=this;i.size=0,i.init=function(r,s){var o=new Blob([t],{type:a});(e=new d(o)).init((function(){i.size=e.size,r()}),s)},i.readUint8Array=function(t,i,r,s){e.readUint8Array(t,i,r,s)}}function p(e){var i,r=this;r.size=0,r.init=function(t){for(var s=e.length;"="==e.charAt(s-1);)s--;i=e.indexOf(",")+1,r.size=Math.floor(.75*(s-i)),t()},r.readUint8Array=function(r,s,o){var a,n=h(s),l=4*Math.floor(r/3),u=4*Math.ceil((r+s)/3),c=t.atob(e.substring(l+i,u+i)),p=r-3*Math.floor(l/4);for(a=p;a<p+s;a++)n.array[a-p]=c.charCodeAt(a);o(n.array)}}function d(t){var e=this;e.size=0,e.init=function(i){e.size=t.size,i()},e.readUint8Array=function(e,i,r,s){var o=new FileReader;o.onload=function(t){r(new Uint8Array(t.target.result))},o.onerror=s;try{o.readAsArrayBuffer(function(t,e,i){if(e<0||i<0||e+i>t.size)throw new RangeError("offset:"+e+", length:"+i+", size:"+t.size);return t.slice?t.slice(e,e+i):t.webkitSlice?t.webkitSlice(e,e+i):t.mozSlice?t.mozSlice(e,e+i):t.msSlice?t.msSlice(e,e+i):void 0}(t,e,i))}catch(t){s(t)}}}function f(){}function _(t){var i,r=this;r.init=function(t){i=new Blob([],{type:a}),t()},r.writeUint8Array=function(t,r){i=new Blob([i,e?t:t.buffer],{type:a}),r()},r.getData=function(e,r){var s=new FileReader;s.onload=function(t){e(t.target.result)},s.onerror=r,s.readAsText(i,t)}}function g(e){var i=this,r="",s="";i.init=function(t){r+="data:"+(e||"")+";base64,",t()},i.writeUint8Array=function(e,i){var o,a=s.length,n=s;for(s="",o=0;o<3*Math.floor((a+e.length)/3)-a;o++)n+=String.fromCharCode(e[o]);for(;o<e.length;o++)s+=String.fromCharCode(e[o]);n.length>2?r+=t.btoa(n):s=n,i()},i.getData=function(e){e(r+t.btoa(s))}}function m(t){var i,r=this;r.init=function(e){i=new Blob([],{type:t}),e()},r.writeUint8Array=function(r,s){i=new Blob([i,e?r:r.buffer],{type:t}),s()},r.getData=function(t){t(i)}}function v(t,e,i,r,s,a,n,l,h,u){var c,p,d,f=0,_=e.sn;function g(){t.removeEventListener("message",m,!1),l(p,d)}function m(e){var i=e.data,s=i.data,o=i.error;if(o)return o.toString=function(){return"Error: "+this.message},void h(o);if(i.sn===_)switch("number"==typeof i.codecTime&&(t.codecTime+=i.codecTime),"number"==typeof i.crcTime&&(t.crcTime+=i.crcTime),i.type){case"append":s?(p+=s.length,r.writeUint8Array(s,(function(){v()}),u)):v();break;case"flush":d=i.crc,s?(p+=s.length,r.writeUint8Array(s,(function(){g()}),u)):g();break;case"progress":n&&n(c+i.loaded,a);break;case"importScripts":case"newTask":case"echo":break;default:console.warn("zip.js:launchWorkerProcess: unknown message: ",i)}}function v(){(c=f*o)<=a?i.readUint8Array(s+c,Math.min(o,a-c),(function(i){n&&n(c,a);var r=0===c?e:{sn:_};r.type="append",r.data=i;try{t.postMessage(r,[i.buffer])}catch(e){t.postMessage(r)}f++}),h):t.postMessage({sn:_,type:"flush"})}p=0,t.addEventListener("message",m,!1),v()}function b(t,e,i,r,s,a,l,h,u,c){var p,d=0,f=0,_="input"===a,g="output"===a,m=new n;!function a(){var n;if((p=d*o)<s)e.readUint8Array(r+p,Math.min(o,s-p),(function(e){var r;try{r=t.append(e,(function(t){l&&l(p+t,s)}))}catch(t){return void u(t)}r?(f+=r.length,i.writeUint8Array(r,(function(){d++,setTimeout(a,1)}),c),g&&m.append(r)):(d++,setTimeout(a,1)),_&&m.append(e),l&&l(p,s)}),u);else{try{n=t.flush()}catch(t){return void u(t)}n?(g&&m.append(n),f+=n.length,i.writeUint8Array(n,(function(){h(f,m.get())}),c)):h(f,m.get())}}()}function y(e,i,r,s,o,a,n,h,u,c,p){var d="input";t.zip.useWebWorkers&&n?v(e,{sn:i,codecClass:"NOOP",crcType:d},r,s,o,a,u,h,c,p):b(new l,r,s,o,a,d,u,h,c,p)}function P(t){var e,i,r="",s=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(e=0;e<t.length;e++)r+=(i=255&t.charCodeAt(e))>127?s[i-128]:String.fromCharCode(i);return r}function M(t){return decodeURIComponent(escape(t))}function x(t){var e,i="";for(e=0;e<t.length;e++)i+=String.fromCharCode(t[e]);return i}function w(t,e,i,r,s){t.version=e.view.getUint16(i,!0),t.bitFlag=e.view.getUint16(i+2,!0),t.compressionMethod=e.view.getUint16(i+4,!0),t.lastModDateRaw=e.view.getUint32(i+6,!0),t.lastModDate=function(t){var e=(4294901760&t)>>16,i=65535&t;try{return new Date(1980+((65024&e)>>9),((480&e)>>5)-1,31&e,(63488&i)>>11,(2016&i)>>5,2*(31&i),0)}catch(t){}}(t.lastModDateRaw),1!=(1&t.bitFlag)?((r||8!=(8&t.bitFlag))&&(t.crc32=e.view.getUint32(i+10,!0),t.compressedSize=e.view.getUint32(i+14,!0),t.uncompressedSize=e.view.getUint32(i+18,!0)),4294967295!==t.compressedSize&&4294967295!==t.uncompressedSize?(t.filenameLength=e.view.getUint16(i+22,!0),t.extraFieldLength=e.view.getUint16(i+24,!0)):s("File is using Zip64 (4gb+ file size).")):s("File contains encrypted entry.")}function E(e,o,a){var n=0;function l(){}l.prototype.getData=function(r,o,l,u){var c=this;function p(t,e){u&&!function(t){var e=h(4);return e.view.setUint32(0,t),c.crc32==e.view.getUint32(0)}(e)?a("CRC failed."):r.getData((function(t){o(t)}))}function d(t){a(t||s)}function f(t){a(t||"Error while writing file data.")}e.readUint8Array(c.offset,30,(function(s){var o,_=h(s.length,s);1347093252==_.view.getUint32(0)?(w(c,_,4,!1,a),o=c.offset+30+c.filenameLength+c.extraFieldLength,r.init((function(){0===c.compressionMethod?y(c._worker,n++,e,r,o,c.compressedSize,u,p,l,d,f):function(e,i,r,s,o,a,n,l,h,u,c){var p=n?"output":"none";t.zip.useWebWorkers?v(e,{sn:i,codecClass:"Inflater",crcType:p},r,s,o,a,h,l,u,c):b(new t.zip.Inflater,r,s,o,a,p,h,l,u,c)}(c._worker,n++,e,r,o,c.compressedSize,u,p,l,d,f)}),f)):a(i)}),d)};var u={getEntries:function(t){var s=this._worker;!function(t){e.size<22?a(i):s(22,(function(){s(Math.min(65558,e.size),(function(){a(i)}))}));function s(i,s){e.readUint8Array(e.size-i,i,(function(e){for(var i=e.length-22;i>=0;i--)if(80===e[i]&&75===e[i+1]&&5===e[i+2]&&6===e[i+3])return void t(new DataView(e.buffer,i,22));s()}),(function(){a(r)}))}}((function(o){var n,u;n=o.getUint32(16,!0),u=o.getUint16(8,!0),n<0||n>=e.size?a(i):e.readUint8Array(n,e.size-n,(function(e){var r,o,n,c,p=0,d=[],f=h(e.length,e);for(r=0;r<u;r++){if((o=new l)._worker=s,1347092738!=f.view.getUint32(p))return void a(i);w(o,f,p+6,!0,a),o.commentLength=f.view.getUint16(p+32,!0),o.directory=16==(16&f.view.getUint8(p+38)),o.offset=f.view.getUint32(p+42,!0),n=x(f.array.subarray(p+46,p+46+o.filenameLength)),o.filename=2048==(2048&o.bitFlag)?M(n):P(n),o.directory||"/"!=o.filename.charAt(o.filename.length-1)||(o.directory=!0),c=x(f.array.subarray(p+46+o.filenameLength+o.extraFieldLength,p+46+o.filenameLength+o.extraFieldLength+o.commentLength)),o.comment=2048==(2048&o.bitFlag)?M(c):P(c),d.push(o),p+=46+o.filenameLength+o.extraFieldLength+o.commentLength}t(d)}),(function(){a(r)}))}))},close:function(t){this._worker&&(this._worker.terminate(),this._worker=null),t&&t()},_worker:null};t.zip.useWebWorkers?L("inflater",(function(t){u._worker=t,o(u)}),(function(t){a(t)})):o(u)}function C(t){return unescape(encodeURIComponent(t))}function A(t){var e,i=[];for(e=0;e<t.length;e++)i.push(t.charCodeAt(e));return i}function S(e,i,r,o){var a={},n=[],l=0,u=0;function c(t){r(t||"Error while writing zip file.")}function p(t){r(t||s)}var d={add:function(i,s,d,f,_){var g,m,P,M=this._worker;function x(t,i){var r=h(16);l+=t||0,r.view.setUint32(0,1347094280),void 0!==i&&(g.view.setUint32(10,i,!0),r.view.setUint32(4,i,!0)),s&&(r.view.setUint32(8,t,!0),g.view.setUint32(14,t,!0),r.view.setUint32(12,s.size,!0),g.view.setUint32(18,s.size,!0)),e.writeUint8Array(r.array,(function(){l+=16,d()}),c)}function w(){_=_||{},i=i.trim(),_.directory&&"/"!=i.charAt(i.length-1)&&(i+="/"),a.hasOwnProperty(i)?r("File already exists."):(m=A(C(i)),n.push(i),function(t){var r;P=_.lastModDate||new Date,g=h(26),a[i]={headerArray:g.array,directory:_.directory,filename:m,offset:l,comment:A(C(_.comment||""))},g.view.setUint32(0,335546376),_.version&&g.view.setUint8(0,_.version),o||0===_.level||_.directory||g.view.setUint16(4,2048),g.view.setUint16(6,(P.getHours()<<6|P.getMinutes())<<5|P.getSeconds()/2,!0),g.view.setUint16(8,(P.getFullYear()-1980<<4|P.getMonth()+1)<<5|P.getDate(),!0),g.view.setUint16(22,m.length,!0),(r=h(30+m.length)).view.setUint32(0,1347093252),r.array.set(g.array,4),r.array.set(m,30),l+=r.array.length,e.writeUint8Array(r.array,t,c)}((function(){s?o||0===_.level?y(M,u++,s,e,0,s.size,!0,x,f,p,c):function(e,i,r,s,o,a,n,l,h){var u="input";t.zip.useWebWorkers?v(e,{sn:i,options:{level:o},codecClass:"Deflater",crcType:u},r,s,0,r.size,n,a,l,h):b(new t.zip.Deflater,r,s,0,r.size,u,n,a,l,h)}(M,u++,s,e,_.level,x,f,p,c):x()})))}s?s.init(w,p):w()},close:function(t){this._worker&&(this._worker.terminate(),this._worker=null);var i,r,s,o=0,u=0;for(r=0;r<n.length;r++)o+=46+(s=a[n[r]]).filename.length+s.comment.length;for(i=h(o+22),r=0;r<n.length;r++)s=a[n[r]],i.view.setUint32(u,1347092738),i.view.setUint16(u+4,5120),i.array.set(s.headerArray,u+6),i.view.setUint16(u+32,s.comment.length,!0),s.directory&&i.view.setUint8(u+38,16),i.view.setUint32(u+42,s.offset,!0),i.array.set(s.filename,u+46),i.array.set(s.comment,u+46+s.filename.length),u+=46+s.filename.length+s.comment.length;i.view.setUint32(u,1347093766),i.view.setUint16(u+8,n.length,!0),i.view.setUint16(u+10,n.length,!0),i.view.setUint32(u+12,o,!0),i.view.setUint32(u+16,l,!0),e.writeUint8Array(i.array,(function(){e.getData(t)}),c)},_worker:null};t.zip.useWebWorkers?L("deflater",(function(t){d._worker=t,i(d)}),(function(t){r(t)})):i(d)}n.prototype.append=function(t){for(var e=0|this.crc,i=this.table,r=0,s=0|t.length;r<s;r++)e=e>>>8^i[255&(e^t[r])];this.crc=e},n.prototype.get=function(){return~this.crc},n.prototype.table=function(){var t,e,i,r=[];for(t=0;t<256;t++){for(i=t,e=0;e<8;e++)1&i?i=i>>>1^3988292384:i>>>=1;r[t]=i}return r}(),l.prototype.append=function(t,e){return t},l.prototype.flush=function(){},c.prototype=new u,c.prototype.constructor=c,p.prototype=new u,p.prototype.constructor=p,d.prototype=new u,d.prototype.constructor=d,f.prototype.getData=function(t){t(this.data)},_.prototype=new f,_.prototype.constructor=_,g.prototype=new f,g.prototype.constructor=g,m.prototype=new f,m.prototype.constructor=m;var D={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};function L(e,i,r){if(null===t.zip.workerScripts||null===t.zip.workerScriptsPath){var s;if(t.zip.workerScripts){if(s=t.zip.workerScripts[e],!Array.isArray(s))return void r(new Error("zip.workerScripts."+e+" is not an array!"));s=function(t){var e=document.createElement("a");return t.map((function(t){return e.href=t,e.href}))}(s)}else(s=D[e].slice(0))[0]=(t.zip.workerScriptsPath||"")+s[0];var o=new Worker(s[0]);o.codecTime=o.crcTime=0,o.postMessage({type:"importScripts",scripts:s.slice(1)}),o.addEventListener("message",(function t(e){var s=e.data;if(s.error)return o.terminate(),void r(s.error);"importScripts"===s.type&&(o.removeEventListener("message",t),o.removeEventListener("error",a),i(o))})),o.addEventListener("error",a)}else r(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));function a(t){o.terminate(),r(t)}}function B(t){console.error(t)}t.zip={Reader:u,Writer:f,BlobReader:d,Data64URIReader:p,TextReader:c,BlobWriter:m,Data64URIWriter:g,TextWriter:_,createReader:function(t,e,i){i=i||B,t.init((function(){E(t,e,i)}),i)},createWriter:function(t,e,i,r){i=i||B,r=!!r,t.init((function(){S(t,e,i,r)}),i)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}}(Lh);var Bh=Lh.zip;!function(t){var e,i,r=t.Reader,s=t.Writer;try{i=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(t){}function o(t){var e=this;function i(i,r){var s;e.data?i():((s=new XMLHttpRequest).addEventListener("load",(function(){e.size||(e.size=Number(s.getResponseHeader("Content-Length"))||Number(s.response.byteLength)),e.data=new Uint8Array(s.response),i()}),!1),s.addEventListener("error",r,!1),s.open("GET",t),s.responseType="arraybuffer",s.send())}e.size=0,e.init=function(r,s){if(function(t){var e=document.createElement("a");return e.href=t,"http:"===e.protocol||"https:"===e.protocol}(t)){var o=new XMLHttpRequest;o.addEventListener("load",(function(){e.size=Number(o.getResponseHeader("Content-Length")),e.size?r():i(r,s)}),!1),o.addEventListener("error",s,!1),o.open("HEAD",t),o.send()}else i(r,s)},e.readUint8Array=function(t,r,s,o){i((function(){s(new Uint8Array(e.data.subarray(t,t+r)))}),o)}}function a(t){var e=this;e.size=0,e.init=function(i,r){var s=new XMLHttpRequest;s.addEventListener("load",(function(){e.size=Number(s.getResponseHeader("Content-Length")),"bytes"==s.getResponseHeader("Accept-Ranges")?i():r("HTTP Range not supported.")}),!1),s.addEventListener("error",r,!1),s.open("HEAD",t),s.send()},e.readUint8Array=function(e,i,r,s){!function(e,i,r,s){var o=new XMLHttpRequest;o.open("GET",t),o.responseType="arraybuffer",o.setRequestHeader("Range","bytes="+e+"-"+(e+i-1)),o.addEventListener("load",(function(){r(o.response)}),!1),o.addEventListener("error",s,!1),o.send()}(e,i,(function(t){r(new Uint8Array(t))}),s)}}function n(t){var e=this;e.size=0,e.init=function(i,r){e.size=t.byteLength,i()},e.readUint8Array=function(e,i,r,s){r(new Uint8Array(t.slice(e,e+i)))}}function l(){var t,e=this;e.init=function(e,i){t=new Uint8Array,e()},e.writeUint8Array=function(e,i,r){var s=new Uint8Array(t.length+e.length);s.set(t),s.set(e,t.length),t=s,i()},e.getData=function(e){e(t.buffer)}}function h(t,e){var r,s=this;s.init=function(e,i){t.createWriter((function(t){r=t,e()}),i)},s.writeUint8Array=function(t,s,o){var a=new Blob([i?t:t.buffer],{type:e});r.onwrite=function(){r.onwrite=null,s()},r.onerror=o,r.write(a)},s.getData=function(e){t.file(e)}}o.prototype=new r,o.prototype.constructor=o,a.prototype=new r,a.prototype.constructor=a,n.prototype=new r,n.prototype.constructor=n,l.prototype=new s,l.prototype.constructor=l,h.prototype=new s,h.prototype.constructor=h,t.FileWriter=h,t.HttpReader=o,t.HttpRangeReader=a,t.ArrayBufferReader=n,t.ArrayBufferWriter=l,t.fs&&((e=t.fs.ZipDirectoryEntry).prototype.addHttpContent=function(i,r,s){return function(i,r,s,o){if(i.directory)return o?new e(i.fs,r,s,i):new t.fs.ZipFileEntry(i.fs,r,s,i);throw"Parent entry is not a directory."}(this,i,{data:r,Reader:s?a:o})},e.prototype.importHttpContent=function(t,e,i,r){this.importZip(e?new a(t):new o(t),i,r)},t.fs.FS.prototype.importHttpContent=function(t,i,r,s){this.entries=[],this.root=new e(this),this.root.importHttpContent(t,i,r,s)})}(Bh);var Rh=["4.2"],Th=function(t,e){void 0===e&&(e={}),this.supportedSchemas=Rh,this._xrayOpacity=.7,this._src=null,this._options=e,this.viewpoint=null,e.workerScriptsPath?(Bh.workerScriptsPath=e.workerScriptsPath,this.src=e.src,this.xrayOpacity=.7,this.displayEffect=e.displayEffect,this.createMetaModel=e.createMetaModel):t.error("Config expected: workerScriptsPath")};Th.prototype.load=function(t,e,i,r,s,o){switch(r.materialType){case"MetallicMaterial":e._defaultMaterial=new En(e,{baseColor:[1,1,1],metallic:.6,roughness:.6});break;case"SpecularMaterial":e._defaultMaterial=new Sn(e,{diffuse:[1,1,1],specular:E.vec3([1,1,1]),glossiness:.5});break;default:e._defaultMaterial=new je(e,{reflectivity:.75,shiness:100,diffuse:[1,1,1]})}e._wireframeMaterial=new Dh(e,{color:[0,0,0],lineWidth:2});var a=e.scene.canvas.spinner;a.processes++,Fh(t,e,i,r,(function(){a.processes--,s&&s(),e.fire("loaded",!0,!1)}),(function(t){a.processes--,e.error(t),o&&o(t),e.fire("error",t)}),(function(t){console.log("Error, Will Robinson: "+t)}))};var Fh=function(t,e,i,r,s,o){!function(t,e,i){var r=new jh;r.load(t,(function(){e(r)}),(function(t){i("Error loading ZIP archive: "+t)}))}(i,(function(i){Nh(t,i,r,e,s,o)}),o)},Nh=function(){return function(e,i,r,s,o){var a={plugin:e,zip:i,edgeThreshold:30,materialType:r.materialType,scene:s.scene,modelNode:s,info:{references:{}},materials:{}};r.createMetaModel&&(a.metaModelData={modelId:s.id,metaObjects:[{name:s.id,type:"Default",id:s.id}]}),s.scene.loading++,function(e,i){e.zip.getFile("Manifest.xml",(function(r,s){for(var o=s.children,a=0,n=o.length;a<n;a++){var l=o[a];switch(l.type){case"Manifest":t(e,l,i)}}}))}(a,(function(){a.metaModelData&&e.viewer.metaScene.createMetaModel(s.id,a.metaModelData),s.scene.loading--,o()}))};function t(t,i,r){for(var s=i.children,o=0,a=s.length;o<a;o++){var n=s[o];switch(n.type){case"Root":var l=n.children[0];t.zip.getFile(l,(function(i,s){e(t,s,r)}))}}}function e(t,e,r){for(var s=e.children,o=0,a=s.length;o<a;o++){var n=s[o];switch(n.type){case"Model_3dxml":i(t,n,r)}}}function i(t,e,i){for(var s=e.children,n=0,l=s.length;n<l;n++){var h=s[n];switch(h.type){case"Header":r(t,h);break;case"ProductStructure":o(t,h,i);break;case"DefaultView":a(t,h)}}}function r(t,e){for(var i=e.children,r={},o=0,a=i.length;o<a;o++){var n=i[o];switch(n.type){case"SchemaVersion":r.schemaVersion=n.children[0],s(t,r.schemaVersion)||t.plugin.error("Schema version not supported: "+r.schemaVersion+" - supported versions are: "+t.modelNode.supportedSchemas.join(","));break;case"Title":r.title=n.children[0];break;case"Author":r.author=n.children[0];break;case"Created":r.created=n.children[0]}}t.modelNode.meta=r}function s(t,e){for(var i=0,r=Rh.length;i<r;i++)if(e===Rh[i])return!0;return!1}function o(t,e,i){!function(t,e,i){for(var r={},s=e.children,o=0,a=0,l=s.length;a<l;a++){"ReferenceRep"===(h=s[a]).type&&o++}for(a=0,l=s.length;a<l;a++){var h;switch((h=s[a]).type){case"ReferenceRep":if(h.associatedFile){var u=Gh(h.associatedFile);!function(){var e=h.id;t.zip.getFile(u,(function(s,a){var l=s.getElementsByTagName("MaterialId");Ih(t,l,(function(){var s={id:e};n(t,a,s),r[e]=s,0==--o&&i(r)}))}),(function(t){}))}()}}}}(t,e,(function(r){for(var s=e.children,o={},a={},n={},l=0,h=s.length;l<h;l++){var u=s[l];switch(u.type){case"Reference3D":o[u.id]={type:"Reference3D",id:u.id,name:u.name,instance3Ds:{},instanceReps:{}};break;case"InstanceRep":for(var c=0,p=u.children.length;c<p;c++){switch((m=u.children[c]).type){case"IsAggregatedBy":d=m.children[0];break;case"IsInstanceOf":f=m.children[0]}}a[u.id]={type:"InstanceRep",id:u.id,name:u.name,isAggregatedBy:d,isInstanceOf:f,referenceReps:{}};break;case"Instance3D":var d,f,g;for(c=0,p=u.children.length;c<p;c++){var m;switch((m=u.children[c]).type){case"IsAggregatedBy":d=m.children[0];break;case"IsInstanceOf":f=m.children[0];break;case"RelativeMatrix":g=m.children[0]}}n[u.id]={type:"Instance3D",id:u.id,name:u.name,isAggregatedBy:d,isInstanceOf:f,relativeMatrix:g,reference3Ds:{}}}}for(var v in n){(y=o[(b=n[v]).isAggregatedBy])?y.instance3Ds[b.id]=b:alert("foo")}for(var v in n){var b,y=o[(b=n[v]).isInstanceOf];b.reference3Ds[y.id]=y,y.instance3D=b}for(var v in a){var P=r[(M=a[v]).isInstanceOf];P&&(M.referenceReps[P.id]=P)}for(var v in a){var M;(y=o[(M=a[v]).isAggregatedBy])&&(y.instanceReps[M.id]=M)}function x(t,e,i){for(var r in e.instance3Ds)w(t,e.instance3Ds[r],i);for(var r in e.instanceReps)C(t,e.instanceReps[r],i)}function w(t,e,i){if(e.relativeMatrix){var r=_(e.relativeMatrix,12),s=[r[9],r[10],r[11]],o=r.slice(0,9),a=E.mat3ToMat4(o,E.identityMat4()),n=new mn(t.modelNode,{position:s});t.metaModelData&&t.metaModelData.metaObjects.push({id:n.id,type:"Default",name:e.name,parent:i?i.id:t.modelNode.id}),i?i.addChild(n,!0):t.modelNode.addChild(n,!0),i=n,n=new mn(t.modelNode,{matrix:a}),t.metaModelData&&t.metaModelData.metaObjects.push({id:n.id,type:"Default",name:e.name,parent:i?i.id:t.modelNode.id}),i.addChild(n,!0),i=n}else{n=new mn(t.modelNode,{});t.metaModelData&&t.metaModelData.metaObjects.push({id:n.id,type:"Default",name:e.name,parent:i?i.id:t.modelNode.id}),i?i.addChild(n,!0):t.modelNode.addChild(n,!0),i=n}for(var l in e.reference3Ds)x(t,e.reference3Ds[l],i)}function C(t,e,i){if(e.referenceReps)for(var r in e.referenceReps){var s=e.referenceReps[r];for(var o in s)if("id"!==o){var a=s[o],n="lines"===a.geometry.primitive?t.modelNode._wireframeMaterial:a.materialId?t.materials[a.materialId]:null,l=a.color,h=new Hi(t.modelNode,{isObject:!0,geometry:a.geometry,material:n||t.modelNode._defaultMaterial,colorize:l,backfaces:!1});t.metaModelData&&t.metaModelData.metaObjects.push({id:h.id,type:"Default",name:e.name,parent:i?i.id:t.modelNode.id}),i?i.addChild(h,!0):t.modelNode.addChild(h,!0),h.colorize=l}}}for(var v in o){if(!(y=o[v]).instance3D)return x(t,y,null),void i()}alert("No root Reference3D element found in this modelNode - can't load."),i()}))}function a(t,e){for(var i=e.children,r=0,s=i.length;r<s;r++){var o=i[r];switch(o.type){case"Viewpoint":var a=o.children;t.modelNode.viewpoint={};for(var n=0,l=a.length;n<l;n++){var h=a[r];switch(h.type){case"Position":t.modelNode.viewpoint.eye=_(h.children[0],3);break;case"Sight":t.modelNode.viewpoint.look=_(h.children[0],3);break;case"Up":t.modelNode.viewpoint.up=_(h.children[0],3)}}}}}function n(t,e,i){for(var r=e.children,s=0,o=r.length;s<o;s++){var a=r[s];switch(a.type){case"XMLRepresentation":l(t,a,i)}}}function l(t,e,i){for(var r=e.children,s=0,o=r.length;s<o;s++){var a=r[s];switch(a.type){case"Root":h(t,a,i)}}}function h(t,e,i){e["xsi:type"];for(var r=e.children,s=0,o=r.length;s<o;s++){var a=r[s];switch(a.type){case"Rep":u(t,a,i)}}}function u(t,e,i){e["xsi:type"];for(var r={edgeThreshold:t.edgeThreshold||30,compressGeometry:!0},s=e.children,o=0,a=s.length;o<a;o++){var n=s[o];switch(n.type){case"Rep":u(t,n,i);break;case"Edges":break;case"Faces":r.primitive="triangles",c(t,n,r);break;case"VertexBuffer":f(t,n,r);break;case"SurfaceAttributes":g(t,n,r)}}if(r.positions){var l=new ke(t.modelNode,r);i[l.id]={geometry:l,color:r.color||[1,1,1,1],materialId:r.materialId}}}function c(t,e,i){for(var r=e.children,s=0,o=r.length;s<o;s++){var a=r[s];switch(a.type){case"Face":p(t,a,i)}}}function p(t,e,i){var r=e.strips;if(r){var s=function(t){for(var e=t.split(","),i=[],r=0,s=e.length;r<s;r++){var o=e[r].trim();if(o.length>0){for(var a=o.trim().split(" "),n=new Int16Array(a.length),l=0,h=0,u=a.length;h<u;h++)""!==a[h]&&(n[l++]=parseInt(a[h]));i.push(n)}}return i}(r);if(s.length>0){i.primitive="triangles";for(var o=[],a=0,n=s.length;a<n;a++)for(var l=d(s[a]),h=0,u=l.length;h<u;h++)o.push(l[h]);i.indices=o}}else{var c=e.triangles;c&&(i.primitive="triangles",i.indices=function(t){t=t.trim().split(" ");for(var e=new Int32Array(t.length),i=0,r=t.length;i<r;i++){var s=t[i];e[i]=parseInt(s)}return e}(c))}var p=e.children;for(a=0,n=p.length;a<n;a++){var f=p[a];switch(f.type){case"SurfaceAttributes":g(t,f,i)}}}function d(t){for(var e=[],i=0,r=t.length;i<r-2;i++)1&i?(e.push(t[i]),e.push(t[i+2]),e.push(t[i+1])):(e.push(t[i]),e.push(t[i+1]),e.push(t[i+2]));return e}function f(t,e,i){for(var r=e.children,s=0,o=r.length;s<o;s++){var a=r[s];switch(a.type){case"Positions":i.positions=_(a.children[0],3);break;case"Normals":i.normals=_(a.children[0],3);break;case"TextureCoordinates":i.uv=_(a.children[0],2)}}}function _(t,e){t=t.split(",");for(var i=new Float32Array(t.length*e),r=0,s=0,o=t.length;s<o;s++)for(var a=t[s],n=0,l=(a=a.split(" ")).length;n<l;n++)""!==a[n]&&(i[r++]=parseFloat(a[n]));return i}function g(t,e,i){i.color=[1,1,1,1];for(var r,s,o=e.children,a=0,n=o.length;a<n;a++){var l=o[a];switch(l.type){case"Color":i.color[0]=l.red,i.color[1]=l.green,i.color[2]=l.blue,i.color[3]=l.alpha;break;case"MaterialApplication":for(var h=l.children,u=0,c=h.length;u<c;u++){var p=h[u];switch(p.type){case"MaterialId":var d=(r=p.id,s=void 0,-1!==(s=r.lastIndexOf("#"))?r.substring(s+1):r);t.materials[d]||t.plugin.error("material  not found: "+d),i.materialId=d}}}}}}();function Ih(t,e,i){var r={};!function s(o,a){if(o>=e.length)i();else{var n=e[o].id,l=n.lastIndexOf(":");l>0&&(n=n.substring(l+1));var h=n.lastIndexOf("#");h>0&&(n=n.substring(0,h)),r[n]?s(o+1):function(t,e,i){t.zip.getFile(e,(function(e,r){!function(t,e,i){for(var r,s=e.children,o=0,a=s.length;o<a;o++)"Model_3dxml"===(r=s[o]).type&&kh(t,r,i)}(t,r,i)}))}(t,n,(function(){r[n]=!0,s(o+1)}))}}(0)}function kh(t,e,i){for(var r,s=e.children,o=0,a=s.length;o<a;o++)"CATMaterialRef"===(r=s[o]).type&&Oh(t,r,i)}function Oh(t,e,i){for(var r={},s=e.children,o=0,a=0,n=s.length;a<n;a++){switch((d=s[a]).type){case"MaterialDomainInstance":for(var l,h,u=0,c=d.children.length;u<c;u++){var p=d.children[u];switch(p.type){case"IsAggregatedBy":l=p.children[0];break;case"IsInstanceOf":h=p.children[0]}}r[h]=l}}for(a=0,n=s.length;a<n;a++){switch((d=s[a]).type){case"MaterialDomain":o++}}for(a=0,n=s.length;a<n;a++){var d;switch((d=s[a]).type){case"MaterialDomain":d.associatedFile&&function(){var e=d.id,s=Gh(d.associatedFile);t.zip.getFile(s,(function(s,a){t.materials[r[e]]=Vh(t,a),0==--o&&i()}),(function(t){}))}()}}}function Vh(t,e){for(var i=e.children,r=0,s=i.length;r<s;r++){var o=i[r];switch(o.type){case"Osm":return zh(t,o)}}}function zh(t,e){for(var i=e.children,r=0,s=i.length;r<s;r++){var o=i[r];switch(o.type){case"RenderingRootFeature":break;case"Feature":if("RenderingFeature"===o.Alias){var a,n,l,h,u={},c={},p=o.children;for(a=0,n=p.length;a<n;a++)switch((l=p[a]).Name){case"AmbientCoef":u.ambient=parseFloat(l.Value);break;case"DiffuseCoef":u.diffuse=parseFloat(l.Value);break;case"EmissiveCoef":u.emissive=parseFloat(l.Value);break;case"SpecularExponent":u.specular=parseFloat(l.Value)}for(a=0,n=p.length;a<n;a++)switch((l=p[a]).Name){case"AmbientColor":c.ambient=Uh(l.Value,u.ambient);break;case"DiffuseColor":c.diffuse=Uh(l.Value,u.diffuse);break;case"EmissiveColor":c.emissive=Uh(l.Value,u.emissive);break;case"SpecularColor":c.specular=Uh(l.Value,u.specular);break;case"Transparency":var d=1-parseFloat(l.Value);d<1&&(c.alpha=d,c.alphaMode="blend")}switch(t.materialType){case"MetallicMaterial":h=new En(t.modelNode,{baseColor:c.diffuse,metallic:.7,roughness:.5,emissive:c.emissive,alpha:c.alpha,alphaMode:c.alphaMode});break;case"SpecularMaterial":h=new Sn(t.modelNode,{diffuse:c.diffuse,specular:c.specular,glossiness:.5,emissive:c.emissive,alpha:c.alpha,alphaMode:c.alphaMode});break;default:h=new je(t.modelNode,{reflectivity:.5,ambient:c.ambient,diffuse:c.diffuse,specular:c.specular,emissive:c.emissive,alphaMode:c.alphaMode,alpha:e.alpha})}return h}}}}function Uh(t,e){e=void 0!==e?e:.5;var i=t.indexOf("["),r=t.indexOf("]");t=(t=t.substring(i+1,r-i)).split(",");for(var s=new Float32Array(t.length),o=0,a=0,n=t.length;a<n;a++)for(var l=t[a],h=0,u=(l=l.trim().split(" ")).length;h<u;h++)""!==l[h]&&(s[o++]=parseFloat(l[h])*e);return s}var jh=function(){var t={};function e(t,i){if(t.nodeType===t.TEXT_NODE){var r=t.nodeValue;if(null===r.match(/^\s+$/))return r}else if(t.nodeType===t.ELEMENT_NODE||t.nodeType===t.DOCUMENT_NODE){var s={type:t.nodeName,children:[]};if(t.nodeType===t.ELEMENT_NODE)for(var o=0;o<t.attributes.length;o++){var a=t.attributes[o];s[i[a.nodeName]||a.nodeName]=a.nodeValue}for(var n=0;n<t.childNodes.length;n++){(o=e(t.childNodes[n],i))&&s.children.push(o)}return s}}this.load=function(e,i,r){Bh.createReader(new Bh.HttpReader(e),(function(e){e.getEntries((function(e){if(e.length>0)for(var r=0,s=e.length;r<s;r++){var o=e[r];t[o.filename]=o}i()}))}),r)},this.getFile=function(i,r,s){var o=t[i];if(!o){var a="ZIP entry not found: "+i;return console.error(a),void(s&&s(a))}o.getData(new Bh.TextWriter,(function(t){var i=(new DOMParser).parseFromString(t,"text/xml"),s=e(i,{});r(i,s)}))},this.destroy=function(){undefined.close((function(){}))}};function Gh(t){var e="urn:3DXML:";return 0===t.indexOf(e)?t.substring(e.length):t}var Xh=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,"XML3DLoader",e,i),i.workerScriptsPath?(this._workerScriptsPath=i.workerScriptsPath,this._loader=new Th(this,i),this.supportedSchemas=this._loader.supportedSchemas):this.error("Config expected: workerScriptsPath")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.load=function(t){void 0===t&&(t={}),t.workerScriptsPath=this._workerScriptsPath,t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);var e=new mn(this.viewer.scene,B.apply(t,{isModel:!0})),i=t.src;return i?(this._loader.load(this,e,i,t),e):(this.error("load() param expected: src"),e)},e}(n),Wh=function(t){void 0===t&&(t={}),this._eventSubIDMap=null,this._eventSubEvents=null,this._eventSubs=null,this._events=null,this._locale="en",this._messages={},this._locales=[],this._locale="en",this.messages=t.messages,this.locale=t.locale},Hh={messages:{configurable:!0},locales:{configurable:!0},locale:{configurable:!0}};function Yh(t,e){if(e[t])return e[t];for(var i=t.split("."),r=e,s=0,o=i.length;r&&s<o;s++){r=r[i[s]]}return r}function Kh(t,e){return void 0===e&&(e=[]),t.replace(/\{\{|\}\}|\{(\d+)\}/g,(function(t,i){return"{{"===t?"{":"}}"===t?"}":e[i]}))}Hh.messages.set=function(t){this._messages=t||{},this._locales=Object.keys(this._messages),this.fire("updated",this)},Wh.prototype.loadMessages=function(t){for(var e in void 0===t&&(t={}),t)this._messages[e]=t[e];this.messages=this._messages},Wh.prototype.clearMessages=function(){this.messages={}},Hh.locales.get=function(){return this._locales},Hh.locale.set=function(t){t=t||"de",this._locale!==t&&(this._locale=t,this.fire("updated",t))},Hh.locale.get=function(){return this._locale},Wh.prototype.translate=function(t,e){var i=this._messages[this._locale];if(!i)return null;var r=Yh(t,i);return r?e?Kh(r,e):r:null},Wh.prototype.translatePlurals=function(t,e,i){var r=this._messages[this._locale];if(!r)return null;var s=Yh(t,r);return(s=0===(e=parseInt(""+e,10))?s.zero:e>1?s.other:s.one)?(s=Kh(s,[e]),i&&(s=Kh(s,i)),s):null},Wh.prototype.fire=function(t,e,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[t]=e||!0);var r=this._eventSubs[t];if(r)for(var s in r){if(r.hasOwnProperty(s))r[s].callback(e)}},Wh.prototype.on=function(e,i){this._events||(this._events={}),this._eventSubIDMap||(this._eventSubIDMap=new t),this._eventSubEvents||(this._eventSubEvents={}),this._eventSubs||(this._eventSubs={});var r=this._eventSubs[e];r||(r={},this._eventSubs[e]=r);var s=this._eventSubIDMap.addItem();r[s]={callback:i},this._eventSubEvents[s]=e;var o=this._events[e];return void 0!==o&&i(o),s},Wh.prototype.off=function(t){if(null!=t&&this._eventSubEvents){var e=this._eventSubEvents[t];if(e){delete this._eventSubEvents[t];var i=this._eventSubs[e];i&&delete i[t],this._eventSubIDMap.removeItem(t)}}},Object.defineProperties(Wh.prototype,Hh);var qh=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this.t=i.t}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={t:{configurable:!0},tangent:{configurable:!0},length:{configurable:!0}};return i.t.set=function(t){t=t||0,this._t=t<0?0:t>1?1:t},i.t.get=function(){return this._t},i.tangent.get=function(){return this.getTangent(this._t)},i.length.get=function(){var t=this._getLengths();return t[t.length-1]},e.prototype.getTangent=function(t){var e=1e-4;void 0===t&&(t=this._t);var i=t-e,r=t+e;i<0&&(i=0),r>1&&(r=1);var s=this.getPoint(i),o=this.getPoint(r),a=E.subVec3(o,s,[]);return E.normalizeVec3(a,[])},e.prototype.getPointAt=function(t){var e=this.getUToTMapping(t);return this.getPoint(e)},e.prototype.getPoints=function(t){t||(t=5);var e,i=[];for(e=0;e<=t;e++)i.push(this.getPoint(e/t));return i},e.prototype._getLengths=function(t){if(t||(t=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var e,i,r=[],s=this.getPoint(0),o=0;for(r.push(0),i=1;i<=t;i++)e=this.getPoint(i/t),o+=E.lenVec3(E.subVec3(e,s,[])),r.push(o),s=e;return this.cacheArcLengths=r,r},e.prototype._updateArcLengths=function(){this.needsUpdate=!0,this._getLengths()},e.prototype.getUToTMapping=function(t,e){var i,r=this._getLengths(),s=0,o=r.length;i=e||t*r[o-1];for(var a,n=0,l=o-1;n<=l;)if((a=r[s=Math.floor(n+(l-n)/2)]-i)<0)n=s+1;else{if(!(a>0)){l=s;break}l=s-1}if(r[s=l]===i)return s/(o-1);var h=r[s];return(s+(i-h)/(r[s+1]-h))/(o-1)},Object.defineProperties(e.prototype,i),e}(U),Zh=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this.points=i.points,this.t=i.t}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={points:{configurable:!0},t:{configurable:!0},point:{configurable:!0}};return i.points.set=function(t){this._points=t||[]},i.points.get=function(){return this._points},i.t.set=function(t){t=t||0,this._t=t<0?0:t>1?1:t},i.t.get=function(){return this._t},i.point.get=function(){return this.getPoint(this._t)},e.prototype.getPoint=function(t){var e=this.points;if(!(e.length<3)){var i=(e.length-1)*t,r=Math.floor(i),s=i-r,o=e[0===r?r:r-1],a=e[r],n=e[r>e.length-2?e.length-1:r+1],l=e[r>e.length-3?e.length-1:r+2],h=E.vec3();return h[0]=E.catmullRomInterpolate(o[0],a[0],n[0],l[0],s),h[1]=E.catmullRomInterpolate(o[1],a[1],n[1],l[1],s),h[2]=E.catmullRomInterpolate(o[2],a[2],n[2],l[2],s),h}this.error("Can't sample point from SplineCurve - not enough points on curve - returning [0,0,0].")},e.prototype.getJSON=function(){return{points:points,t:this._t}},Object.defineProperties(e.prototype,i),e}(qh),Qh=E.vec3(),Jh=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._frames=[],this._eyeCurve=new Zh(this),this._lookCurve=new Zh(this),this._upCurve=new Zh(this),i.frames&&(this.addFrames(i.frames),this.smoothFrameTimes(1))}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},frames:{configurable:!0},eyeCurve:{configurable:!0},lookCurve:{configurable:!0},upCurve:{configurable:!0}};return i.type.get=function(){return"CameraPath"},i.frames.get=function(){return this._frames},i.eyeCurve.get=function(){return this._eyeCurve},i.lookCurve.get=function(){return this._lookCurve},i.upCurve.get=function(){return this._upCurve},e.prototype.saveFrame=function(t){var e=this.scene.camera;this.addFrame(t,e.eye,e.look,e.up)},e.prototype.addFrame=function(t,e,i,r){var s={t:t,eye:e.slice(0),look:i.slice(0),up:r.slice(0)};this._frames.push(s),this._eyeCurve.points.push(s.eye),this._lookCurve.points.push(s.look),this._upCurve.points.push(s.up)},e.prototype.addFrames=function(t){for(var e,i=0,r=t.length;i<r;i++)e=t[i],this.addFrame(e.t||0,e.eye,e.look,e.up)},e.prototype.loadFrame=function(t){var e=this.scene.camera;t=(t/=this._frames[this._frames.length-1].t-this._frames[0].t)<0?0:t>1?1:t,e.eye=this._eyeCurve.getPoint(t,Qh),e.look=this._lookCurve.getPoint(t,Qh),e.up=this._upCurve.getPoint(t,Qh)},e.prototype.sampleFrame=function(t,e,i,r){t=t<0?0:t>1?1:t,this._eyeCurve.getPoint(t,e),this._lookCurve.getPoint(t,i),this._upCurve.getPoint(t,r)},e.prototype.smoothFrameTimes=function(t){if(0!==this._frames.length){var e=E.vec3(),i=0;this._frames[0].t=0;for(var r=[],s=1,o=this._frames.length;s<o;s++){var a=E.lenVec3(E.subVec3(this._frames[s].eye,this._frames[s-1].eye,e));r[s]=a,i+=a}for(var n=1,l=this._frames.length;n<l;n++){var h=r[n]/i*t;this._frames[n].t=this._frames[n-1].t+h}}},e.prototype.clearFrames=function(){this._frames=[],this._eyeCurve.points=[],this._lookCurve.points=[],this._upCurve.points=[]},Object.defineProperties(e.prototype,i),e}(U),$h=E.vec3(),tu=E.vec3(),eu=E.vec3(),iu=E.vec3(),ru=E.vec3(),su=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._look1=E.vec3(),this._eye1=E.vec3(),this._up1=E.vec3(),this._look2=E.vec3(),this._eye2=E.vec3(),this._up2=E.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=!1!==i.easing,this.duration=i.duration,this.fit=i.fit,this.fitFOV=i.fitFOV,this.trail=i.trail}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},duration:{configurable:!0},fit:{configurable:!0},fitFOV:{configurable:!0},trail:{configurable:!0}};return i.type.get=function(){return"CameraFlightAnimation"},e.prototype.flyTo=function(t,e,i){t=t||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=e,this._callbackScope=i;var r,s,o,a,n,l=this.scene.camera,h=!!t.projection&&t.projection!==l.projection;if(this._eye1[0]=l.eye[0],this._eye1[1]=l.eye[1],this._eye1[2]=l.eye[2],this._look1[0]=l.look[0],this._look1[1]=l.look[1],this._look1[2]=l.look[2],this._up1[0]=l.up[0],this._up1[1]=l.up[1],this._up1[2]=l.up[2],this._orthoScale1=l.ortho.scale,this._orthoScale2=t.orthoScale||this._orthoScale1,t.aabb)r=t.aabb;else if(6===t.length)r=t;else if(t.eye&&t.look||t.up)s=t.eye,o=t.look,a=t.up;else if(t.eye)s=t.eye;else if(t.look)o=t.look;else{var u=t;if((B.isNumeric(u)||B.isString(u))&&(n=u,!(u=this.scene.components[n])))return this.error("Component not found: "+B.inQuotes(n)),void(e&&(i?e.call(i):e()));h||(r=u.aabb||this.scene.aabb)}var c=t.poi;if(r){if(r[3]<r[0]||r[4]<r[1]||r[5]<r[2])return;if(r[3]===r[0]&&r[4]===r[1]&&r[5]===r[2])return;r=r.slice();var p=E.getAABB3Center(r);this._look2=c||p;var d=E.subVec3(this._eye1,this._look1,$h),f=E.normalizeVec3(d),_=c?E.getAABB3DiagPoint(r,c):E.getAABB3Diag(r),g=t.fitFOV||this._fitFOV,m=Math.abs(_/Math.tan(g*E.DEGTORAD));this._orthoScale2=1.1*_,this._eye2[0]=this._look2[0]+f[0]*m,this._eye2[1]=this._look2[1]+f[1]*m,this._eye2[2]=this._look2[2]+f[2]*m,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(s||o||a)&&(this._flyingEyeLookUp=!!s&&!!o&&!!a,this._flyingEye=!!s&&!o,this._flyingLook=!!o&&!s,s&&(this._eye2[0]=s[0],this._eye2[1]=s[1],this._eye2[2]=s[2]),o&&(this._look2[0]=o[0],this._look2[1]=o[1],this._look2[2]=o[2]),a&&(this._up2[0]=a[0],this._up2[1]=a[1],this._up2[2]=a[2]));h?("ortho"===t.projection&&"ortho"!==l.projection&&(this._projection2="ortho",this._projMatrix1=l.projMatrix.slice(),this._projMatrix2=l.ortho.matrix.slice(),l.projection="customProjection"),"perspective"===t.projection&&"perspective"!==l.projection&&(this._projection2="perspective",this._projMatrix1=l.projMatrix.slice(),this._projMatrix2=l.perspective.matrix.slice(),l.projection="customProjection")):this._projection2=null,this.fire("started",t,!0),this._time1=Date.now(),this._time2=this._time1+(t.duration?1e3*t.duration:this._duration),this._flying=!0,V.scheduleTask(this._update,this)},e.prototype.jumpTo=function(t){this._jumpTo(t)},e.prototype._jumpTo=function(t){this._flying&&this.stop();var e,i,r,s,o,a=this.scene.camera;if(t.aabb)e=t.aabb;else if(6===t.length)e=t;else if(t.eye||t.look||t.up)r=t.eye,s=t.look,o=t.up;else{var n=t;if((B.isNumeric(n)||B.isString(n))&&(i=n,!(n=this.scene.components[i])))return void this.error("Component not found: "+B.inQuotes(i));e=n.aabb||this.scene.aabb}var l=t.poi;if(e){if(e[3]<=e[0]||e[4]<=e[1]||e[5]<=e[2])return;var h,u=l?E.getAABB3DiagPoint(e,l):E.getAABB3Diag(e);s=l||E.getAABB3Center(e,s),this._trail?E.subVec3(a.look,s,ru):E.subVec3(a.eye,a.look,ru),E.normalizeVec3(ru),h=(void 0!==t.fit?t.fit:this._fit)?Math.abs(u/Math.tan((t.fitFOV||this._fitFOV)*E.DEGTORAD)):E.lenVec3(E.subVec3(a.eye,a.look,$h)),E.mulVec3Scalar(ru,h),a.eye=E.addVec3(s,ru,$h),a.look=s,this.scene.camera.ortho.scale=1.1*u}else(r||s||o)&&(r&&(a.eye=r),s&&(a.look=s),o&&(a.up=o));t.projection&&(a.projection=t.projection)},e.prototype._update=function(){if(this._flying){var t=(Date.now()-this._time1)/(this._time2-this._time1),i=t>=1;t>1&&(t=1);var r=this.easing?e._ease(t,0,1,1):t,s=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(E.subVec3(s.eye,s.look,ru),s.eye=E.lerpVec3(r,0,1,this._eye1,this._eye2,eu),s.look=E.subVec3(eu,ru,tu)):this._flyingLook&&(s.look=E.lerpVec3(r,0,1,this._look1,this._look2,tu),s.up=E.lerpVec3(r,0,1,this._up1,this._up2,iu)):this._flyingEyeLookUp&&(s.eye=E.lerpVec3(r,0,1,this._eye1,this._eye2,eu),s.look=E.lerpVec3(r,0,1,this._look1,this._look2,tu),s.up=E.lerpVec3(r,0,1,this._up1,this._up2,iu)),this._projection2){var o="ortho"===this._projection2?e._easeOutExpo(t,0,1,1):e._easeInCubic(t,0,1,1);s.customProjection.matrix=E.lerpMat4(o,0,1,this._projMatrix1,this._projMatrix2)}else s.ortho.scale=this._orthoScale1+t*(this._orthoScale2-this._orthoScale1);if(i)return s.ortho.scale=this._orthoScale2,void this.stop();V.scheduleTask(this._update,this)}},e._ease=function(t,e,i,r){return-i*(t/=r)*(t-2)+e},e._easeInCubic=function(t,e,i,r){return i*(t/=r)*t*t+e},e._easeOutExpo=function(t,e,i,r){return i*(1-Math.pow(2,-10*t/r))+e},e.prototype.stop=function(){if(this._flying){this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);var t=this._callback;t&&(this._callback=null,this._callbackScope?t.call(this._callbackScope):t()),this.fire("stopped",!0,!0)}},e.prototype.cancel=function(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))},i.duration.set=function(t){this._duration=t?1e3*t:500,this.stop()},i.duration.get=function(){return this._duration/1e3},i.fit.set=function(t){this._fit=!1!==t},i.fit.get=function(){return this._fit},i.fitFOV.set=function(t){this._fitFOV=t||45},i.fitFOV.get=function(){return this._fitFOV},i.trail.set=function(t){this._trail=!!t},i.trail.get=function(){return this._trail},e.prototype.destroy=function(){this.stop(),t.prototype.destroy.call(this)},Object.defineProperties(e.prototype,i),e}(U),ou=function(t){function e(i,r){void 0===r&&(r={}),t.call(this,i,r),this._cameraFlightAnimation=new su(this),this._t=0,this.state=e.SCRUBBING,this._playingFromT=0,this._playingToT=0,this._playingRate=r.playingRate||1,this._playingDir=1,this._lastTime=null,this.cameraPath=r.cameraPath,this._tick=this.scene.on("tick",this._updateT,this)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},cameraPath:{configurable:!0},rate:{configurable:!0}};return i.type.get=function(){return"CameraPathAnimation"},e.prototype._updateT=function(){var t=this._cameraPath;if(t){var i,r,s=performance.now(),o=this._lastTime?.001*(s-this._lastTime):0;if(this._lastTime=s,0!==o)switch(this.state){case e.SCRUBBING:return;case e.PLAYING:if(this._t+=this._playingRate*o,0===(i=this._cameraPath.frames.length)||this._playingDir<0&&this._t<=0||this._playingDir>0&&this._t>=this._cameraPath.frames[i-1].t)return this.state=e.SCRUBBING,this._t=this._cameraPath.frames[i-1].t,void this.fire("stopped");t.loadFrame(this._t);break;case e.PLAYING_TO:r=this._t+this._playingRate*o*this._playingDir,(this._playingDir<0&&r<=this._playingToT||this._playingDir>0&&r>=this._playingToT)&&(r=this._playingToT,this.state=e.SCRUBBING,this.fire("stopped")),this._t=r,t.loadFrame(this._t)}}},e.prototype._ease=function(t,e,i,r){return-i*(t/=r)*(t-2)+e},i.cameraPath.set=function(t){this._cameraPath=t},i.cameraPath.get=function(){return this._cameraPath},i.rate.set=function(t){this._playingRate=t},i.rate.get=function(){return this._playingRate},e.prototype.play=function(){this._cameraPath&&(this._lastTime=null,this.state=e.PLAYING)},e.prototype.playToT=function(t){this._cameraPath&&(this._playingFromT=this._t,this._playingToT=t,this._playingDir=this._playingToT-this._playingFromT<0?-1:1,this._lastTime=null,this.state=e.PLAYING_TO)},e.prototype.playToFrame=function(t){var e=this._cameraPath;if(e){var i=e.frames[t];i?this.playToT(i.t):this.error("playToFrame - frame index out of range: "+t)}},e.prototype.flyToFrame=function(t,i){var r=this._cameraPath;if(r){var s=r.frames[t];s?(this.state=e.SCRUBBING,this._cameraFlightAnimation.flyTo(s,i)):this.error("flyToFrame - frame index out of range: "+t)}},e.prototype.scrubToT=function(t){var i=this._cameraPath;i&&(this.scene.camera&&(this._t=t,i.loadFrame(this._t),this.state=e.SCRUBBING))},e.prototype.scrubToFrame=function(t){var i=this._cameraPath;i&&(this.scene.camera&&(i.frames[t]?(i.loadFrame(this._t),this.state=e.SCRUBBING):this.error("playToFrame - frame index out of range: "+t)))},e.prototype.stop=function(){this.state=e.SCRUBBING,this.fire("stopped")},e.prototype.destroy=function(){t.prototype.destroy.call(this),this.scene.off(this._tick)},Object.defineProperties(e.prototype,i),e}(U);ou.STOPPED=0,ou.SCRUBBING=1,ou.PLAYING=2,ou.PLAYING_TO=3;var au={};function nu(t,e){return void 0===e&&(e={}),new Promise((function(i,r){e.src||(console.error("load3DSGeometry: Parameter expected: src"),r());var s=t.canvas.spinner;s.processes++,B.loadArraybuffer(e.src,(function(t){t.byteLength||(console.error("load3DSGeometry: no data loaded"),s.processes--,r());var o=au.parse.from3DS(t).edit.objects[0].mesh,a=o.vertices,n=o.uvt,l=o.indices;s.processes--,i(B.apply(e,{primitive:"triangles",positions:a,normals:null,uv:n,indices:l}))}),(function(t){console.error("load3DSGeometry: "+t),s.processes--,r()}))}))}function lu(t,e){return void 0===e&&(e={}),new Promise((function(i,r){e.src||(console.error("loadOBJGeometry: Parameter expected: src"),r());var s=t.canvas.spinner;s.processes++,B.loadArraybuffer(e.src,(function(t){t.byteLength||(console.error("loadOBJGeometry: no data loaded"),s.processes--,r());for(var o=au.parse.fromOBJ(t),a=au.edit.unwrap(o.i_verts,o.c_verts,3),n=au.edit.unwrap(o.i_norms,o.c_norms,3),l=au.edit.unwrap(o.i_uvt,o.c_uvt,2),h=new Int32Array(o.i_verts.length),u=0;u<o.i_verts.length;u++)h[u]=u;s.processes--,i(B.apply(e,{primitive:"triangles",positions:a,normals:n.length>0?n:null,autoNormals:0===n.length,uv:l,indices:h}))}),(function(t){console.error("loadOBJGeometry: "+t),s.processes--,r()}))}))}function hu(t){void 0===t&&(t={});var e=t.xSize||1;e<0&&(console.error("negative xSize not allowed - will invert"),e*=-1);var i=t.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);var r=t.zSize||1;r<0&&(console.error("negative zSize not allowed - will invert"),r*=-1);var s=t.center,o=s?s[0]:0,a=s?s[1]:0,n=s?s[2]:0,l=-e+o,h=-i+a,u=-r+n,c=e+o,p=i+a,d=r+n;return B.apply(t,{primitive:"lines",positions:[l,h,u,l,h,d,l,p,u,l,p,d,c,h,u,c,h,d,c,p,u,c,p,d],indices:[0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,2,6,3,7]})}function uu(t){void 0===t&&(t={});var e=t.size||1;e<0&&(console.error("negative size not allowed - will invert"),e*=-1);var i=t.divisions||1;i<0&&(console.error("negative divisions not allowed - will invert"),i*=-1),i<1&&(i=1);for(var r=(e=e||10)/(i=i||10),s=e/2,o=[],a=[],n=0,l=0,h=-s;l<=i;l++,h+=r)o.push(-s),o.push(0),o.push(h),o.push(s),o.push(0),o.push(h),o.push(h),o.push(0),o.push(-s),o.push(h),o.push(0),o.push(s),a.push(n++),a.push(n++),a.push(n++),a.push(n++);return B.apply(t,{primitive:"lines",positions:o,indices:a})}function cu(t){void 0===t&&(t={});var e=t.xSize||1;e<0&&(console.error("negative xSize not allowed - will invert"),e*=-1);var i=t.zSize||1;i<0&&(console.error("negative zSize not allowed - will invert"),i*=-1);var r=t.xSegments||1;r<0&&(console.error("negative xSegments not allowed - will invert"),r*=-1),r<1&&(r=1);var s=t.xSegments||1;s<0&&(console.error("negative zSegments not allowed - will invert"),s*=-1),s<1&&(s=1);var o,a,n,l,h,u,c,p=t.center,d=p?p[0]:0,f=p?p[1]:0,_=p?p[2]:0,g=e/2,m=i/2,v=Math.floor(r)||1,b=Math.floor(s)||1,y=v+1,P=b+1,M=e/v,x=i/b,w=new Float32Array(y*P*3),E=new Float32Array(y*P*3),C=new Float32Array(y*P*2),A=0,S=0;for(o=0;o<P;o++){var D=o*x-m;for(a=0;a<y;a++)n=a*M-g,w[A]=n+d,w[A+1]=f,w[A+2]=-D+_,E[A+2]=-1,C[S]=a/v,C[S+1]=(b-o)/b,A+=3,S+=2}A=0;var L=new(w.length/3>65535?Uint32Array:Uint16Array)(v*b*6);for(o=0;o<b;o++)for(a=0;a<v;a++)l=a+y*o,h=a+y*(o+1),u=a+1+y*(o+1),c=a+1+y*o,L[A]=c,L[A+1]=h,L[A+2]=l,L[A+3]=c,L[A+4]=u,L[A+5]=h,A+=6;return B.apply(t,{positions:w,normals:E,uv:C,indices:L})}au.load=function(t,e){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(t){e(t.target.response)},i.send()},au.save=function(t,e){var i="data:application/octet-stream;base64,"+btoa(au.parse._buffToStr(t));window.location.href=i},au.clone=function(t){return JSON.parse(JSON.stringify(t))},au.bin={},au.bin.f=new Float32Array(1),au.bin.fb=new Uint8Array(au.bin.f.buffer),au.bin.rf=function(t,e){for(var i=au.bin.f,r=au.bin.fb,s=0;s<4;s++)r[s]=t[e+s];return i[0]},au.bin.rsl=function(t,e){return t[e]|t[e+1]<<8},au.bin.ril=function(t,e){return t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24},au.bin.rASCII0=function(t,e){for(var i="";0!=t[e];)i+=String.fromCharCode(t[e++]);return i},au.bin.wf=function(t,e,i){new Float32Array(t.buffer,e,1)[0]=i},au.bin.wsl=function(t,e,i){t[e]=i,t[e+1]=i>>8},au.bin.wil=function(t,e,i){t[e]=i,t[e+1]=i>>8,t[e+2]=i>>16,t[e+3]},au.parse={},au.parse._buffToStr=function(t){for(var e=new Uint8Array(t),i="",r=0;r<e.length;r++)i=i.concat(String.fromCharCode(e[r]));return i},au.parse._strToBuff=function(t){for(var e=new ArrayBuffer(t.length),i=new Uint8Array(e),r=0;r<t.length;r++)i[r]=t.charCodeAt(r);return e},au.parse._readLine=function(t,e){for(var i="";10!=t[e];)i+=String.fromCharCode(t[e++]);return i},au.parse.fromJSON=function(t){return JSON.parse(au.parse._buffToStr(t))},au.parse.toJSON=function(t){var e=JSON.stringify(t);return au.parse._strToBuff(e)},au.parse.fromOBJ=function(t){for(var e={groups:{},c_verts:[],c_uvt:[],c_norms:[],i_verts:[],i_uvt:[],i_norms:[]},i={from:0,to:0},r=0,s=new Uint8Array(t);r<s.length;){var o=au.parse._readLine(s,r);r+=o.length+1;var a=(o=(o=o.replace(/ +(?= )/g,"")).replace(/(^\s+|\s+$)/g,"")).split(" ");if("g"==a[0]&&(i.to=e.i_verts.length,null==e.groups[a[1]]&&(e.groups[a[1]]={from:e.i_verts.length,to:0}),i=e.groups[a[1]]),"v"==a[0]){var n=parseFloat(a[1]),l=parseFloat(a[2]),h=parseFloat(a[3]);e.c_verts.push(n,l,h)}if("vt"==a[0]){n=parseFloat(a[1]),l=1-parseFloat(a[2]);e.c_uvt.push(n,l)}if("vn"==a[0]){n=parseFloat(a[1]),l=parseFloat(a[2]),h=parseFloat(a[3]);e.c_norms.push(n,l,h)}if("f"==a[0]){var u=a[1].split("/"),c=a[2].split("/"),p=a[3].split("/"),d=parseInt(u[0])-1,f=parseInt(c[0])-1,_=parseInt(p[0])-1,g=parseInt(u[1])-1,m=parseInt(c[1])-1,v=parseInt(p[1])-1,b=parseInt(u[2])-1,y=parseInt(c[2])-1,P=parseInt(p[2])-1,M=e.c_verts.length/3,x=e.c_uvt.length/2,w=e.c_norms.length/3;if(d<0&&(d=M+d+1),f<0&&(f=M+f+1),_<0&&(_=M+_+1),g<0&&(g=x+g+1),m<0&&(m=x+m+1),v<0&&(v=x+v+1),b<0&&(b=w+b+1),y<0&&(y=w+y+1),P<0&&(P=w+P+1),e.i_verts.push(d,f,_),e.i_uvt.push(g,m,v),e.i_norms.push(b,y,P),5==a.length){var E=a[4].split("/"),C=parseInt(E[0])-1,A=parseInt(E[1])-1,S=parseInt(E[2])-1;C<0&&(C=M+C+1),A<0&&(A=x+A+1),S<0&&(S=w+S+1),e.i_verts.push(d,_,C),e.i_uvt.push(g,v,A),e.i_norms.push(b,P,S)}}}return i.to=e.i_verts.length,e},au.parse.fromMD2=function(t){t=new Uint8Array(t);var e={},i={};i.ident=au.bin.ril(t,0),i.version=au.bin.ril(t,4),i.skinwidth=au.bin.ril(t,8),i.skinheight=au.bin.ril(t,12),i.framesize=au.bin.ril(t,16),i.num_skins=au.bin.ril(t,20),i.num_vertices=au.bin.ril(t,24),i.num_st=au.bin.ril(t,28),i.num_tris=au.bin.ril(t,32),i.num_glcmds=au.bin.ril(t,36),i.num_frames=au.bin.ril(t,40),i.offset_skins=au.bin.ril(t,44),i.offset_st=au.bin.ril(t,48),i.offset_tris=au.bin.ril(t,52),i.offset_frames=au.bin.ril(t,56),i.offset_glcmds=au.bin.ril(t,60),i.offset_end=au.bin.ril(t,64);var r=i.offset_st;e.c_uvt=[];for(var s=0;s<i.num_st;s++){var o=au.bin.rsl(t,r)/i.skinwidth,a=au.bin.rsl(t,r+2)/i.skinheight;e.c_uvt.push(o,a),r+=4}r=i.offset_tris;var n=[],l=[];e.i_verts=n,e.i_uvt=l;for(s=0;s<i.num_tris;s++)n.push(au.bin.rsl(t,r),au.bin.rsl(t,r+2),au.bin.rsl(t,r+4)),l.push(au.bin.rsl(t,r+6),au.bin.rsl(t,r+8),au.bin.rsl(t,r+10)),r+=12;r=i.offset_skins;e.skins=[];for(s=0;s<i.num_skins;s++)e.skins.push(au.bin.rASCII0(t,r)),r+=64;r=i.offset_frames;e.frames=[];var h=au.parse.fromMD2._normals;for(s=0;s<i.num_frames;s++){var u={},c=au.bin.rf(t,r),p=au.bin.rf(t,r+4),d=au.bin.rf(t,r+8);r+=12;var f=au.bin.rf(t,r),_=au.bin.rf(t,r+4),g=au.bin.rf(t,r+8);r+=12,u.name=au.bin.rASCII0(t,r),r+=16,u.verts=[],u.norms=[];for(var m=0;m<i.num_vertices;m++)u.verts.push(t[r]*c+f,t[r+1]*p+_,t[r+2]*d+g),u.norms.push(h[3*t[r+3]],h[3*t[r+3]+1],h[3*t[r+3]+2]),r+=4;e.frames.push(u)}return e},au.parse.fromMD2._normals=[-.525731,0,.850651,-.442863,.238856,.864188,-.295242,0,.955423,-.309017,.5,.809017,-.16246,.262866,.951056,0,0,1,0,.850651,.525731,-.147621,.716567,.681718,.147621,.716567,.681718,0,.525731,.850651,.309017,.5,.809017,.525731,0,.850651,.295242,0,.955423,.442863,.238856,.864188,.16246,.262866,.951056,-.681718,.147621,.716567,-.809017,.309017,.5,-.587785,.425325,.688191,-.850651,.525731,0,-.864188,.442863,.238856,-.716567,.681718,.147621,-.688191,.587785,.425325,-.5,.809017,.309017,-.238856,.864188,.442863,-.425325,.688191,.587785,-.716567,.681718,-.147621,-.5,.809017,-.309017,-.525731,.850651,0,0,.850651,-.525731,-.238856,.864188,-.442863,0,.955423,-.295242,-.262866,.951056,-.16246,0,1,0,0,.955423,.295242,-.262866,.951056,.16246,.238856,.864188,.442863,.262866,.951056,.16246,.5,.809017,.309017,.238856,.864188,-.442863,.262866,.951056,-.16246,.5,.809017,-.309017,.850651,.525731,0,.716567,.681718,.147621,.716567,.681718,-.147621,.525731,.850651,0,.425325,.688191,.587785,.864188,.442863,.238856,.688191,.587785,.425325,.809017,.309017,.5,.681718,.147621,.716567,.587785,.425325,.688191,.955423,.295242,0,1,0,0,.951056,.16246,.262866,.850651,-.525731,0,.955423,-.295242,0,.864188,-.442863,.238856,.951056,-.16246,.262866,.809017,-.309017,.5,.681718,-.147621,.716567,.850651,0,.525731,.864188,.442863,-.238856,.809017,.309017,-.5,.951056,.16246,-.262866,.525731,0,-.850651,.681718,.147621,-.716567,.681718,-.147621,-.716567,.850651,0,-.525731,.809017,-.309017,-.5,.864188,-.442863,-.238856,.951056,-.16246,-.262866,.147621,.716567,-.681718,.309017,.5,-.809017,.425325,.688191,-.587785,.442863,.238856,-.864188,.587785,.425325,-.688191,.688191,.587785,-.425325,-.147621,.716567,-.681718,-.309017,.5,-.809017,0,.525731,-.850651,-.525731,0,-.850651,-.442863,.238856,-.864188,-.295242,0,-.955423,-.16246,.262866,-.951056,0,0,-1,.295242,0,-.955423,.16246,.262866,-.951056,-.442863,-.238856,-.864188,-.309017,-.5,-.809017,-.16246,-.262866,-.951056,0,-.850651,-.525731,-.147621,-.716567,-.681718,.147621,-.716567,-.681718,0,-.525731,-.850651,.309017,-.5,-.809017,.442863,-.238856,-.864188,.16246,-.262866,-.951056,.238856,-.864188,-.442863,.5,-.809017,-.309017,.425325,-.688191,-.587785,.716567,-.681718,-.147621,.688191,-.587785,-.425325,.587785,-.425325,-.688191,0,-.955423,-.295242,0,-1,0,.262866,-.951056,-.16246,0,-.850651,.525731,0,-.955423,.295242,.238856,-.864188,.442863,.262866,-.951056,.16246,.5,-.809017,.309017,.716567,-.681718,.147621,.525731,-.850651,0,-.238856,-.864188,-.442863,-.5,-.809017,-.309017,-.262866,-.951056,-.16246,-.850651,-.525731,0,-.716567,-.681718,-.147621,-.716567,-.681718,.147621,-.525731,-.850651,0,-.5,-.809017,.309017,-.238856,-.864188,.442863,-.262866,-.951056,.16246,-.864188,-.442863,.238856,-.809017,-.309017,.5,-.688191,-.587785,.425325,-.681718,-.147621,.716567,-.442863,-.238856,.864188,-.587785,-.425325,.688191,-.309017,-.5,.809017,-.147621,-.716567,.681718,-.425325,-.688191,.587785,-.16246,-.262866,.951056,.442863,-.238856,.864188,.16246,-.262866,.951056,.309017,-.5,.809017,.147621,-.716567,.681718,0,-.525731,.850651,.425325,-.688191,.587785,.587785,-.425325,.688191,.688191,-.587785,.425325,-.955423,.295242,0,-.951056,.16246,.262866,-1,0,0,-.850651,0,.525731,-.955423,-.295242,0,-.951056,-.16246,.262866,-.864188,.442863,-.238856,-.951056,.16246,-.262866,-.809017,.309017,-.5,-.864188,-.442863,-.238856,-.951056,-.16246,-.262866,-.809017,-.309017,-.5,-.681718,.147621,-.716567,-.681718,-.147621,-.716567,-.850651,0,-.525731,-.688191,.587785,-.425325,-.587785,.425325,-.688191,-.425325,.688191,-.587785,-.425325,-.688191,-.587785,-.587785,-.425325,-.688191,-.688191,-.587785,-.425325],au.parse.fromCollada=function(t){var e=au.parse._buffToStr(t),i=(new DOMParser).parseFromString(e,"text/xml"),r={},s=(i=i.childNodes[0]).getElementsByTagName("asset")[0],o=i.getElementsByTagName("library_geometries")[0],a=i.getElementsByTagName("library_images")[0],n=i.getElementsByTagName("library_materials")[0],l=i.getElementsByTagName("library_effects")[0];return s&&(r.asset=au.parse.fromCollada._asset(s)),o&&(r.geometries=au.parse.fromCollada._libGeometries(o)),a&&(r.images=au.parse.fromCollada._libImages(a)),n&&(r.materials=au.parse.fromCollada._libMaterials(n)),l&&(r.effects=au.parse.fromCollada._libEffects(l)),r},au.parse.fromCollada._asset=function(t){return{created:t.getElementsByTagName("created")[0].textContent,modified:t.getElementsByTagName("modified")[0].textContent,up_axis:t.getElementsByTagName("up_axis")[0].textContent}},au.parse.fromCollada._libGeometries=function(t){t=t.getElementsByTagName("geometry");for(var e=[],i=0;i<t.length;i++){var r=t[i],s=au.parse.fromCollada._getMesh(r.getElementsByTagName("mesh")[0]);e.push(s)}return e},au.parse.fromCollada._getMesh=function(t){for(var e={},i=t.getElementsByTagName("source"),r=e.sources={},s=0;s<i.length;s++){for(var o=i[s].getElementsByTagName("float_array")[0].textContent.split(" "),a=o.length-(""==o[o.length-1]?1:0),n=new Array(a),l=0;l<a;l++)n[l]=parseFloat(o[l]);r[i[s].getAttribute("id")]=n}e.triangles=[];var h=t.getElementsByTagName("triangles");if(null==h)return e;for(s=0;s<h.length;s++){var u={},c=h[s];u.material=c.getAttribute("material");var p=c.getElementsByTagName("input"),d=[];for(l=0;l<p.length;l++){var f=p[l];n=[];d[parseInt(f.getAttribute("offset"))]=n;var _=f.getAttribute("semantic");u["s_"+_]="VERTEX"==_?t.getElementsByTagName("vertices")[0].getElementsByTagName("input")[0].getAttribute("source").substring(1):f.getAttribute("source").substring(1),u["i_"+_]=n,r[u["s_"+_]]}var g=c.getElementsByTagName("p")[0].textContent.split(" "),m=3*Math.floor(g.length/3);for(l=0;l<m;l++)d[l%p.length].push(parseInt(g[l]));e.triangles.push(u)}return e},au.parse.fromCollada._libImages=function(t){t=t.getElementsByTagName("image");for(var e={},i=0;i<t.length;i++)e[t[i].getAttribute("id")]=t[i].getElementsByTagName("init_from")[0].textContent;return e},au.parse.fromCollada._libMaterials=function(t){t=t.getElementsByTagName("material");for(var e={},i=0;i<t.length;i++)e[t[i].getAttribute("name")]=t[i].getElementsByTagName("instance_effect")[0].getAttribute("url").substring(1);return e},au.parse.fromCollada._libEffects=function(t){t=t.getElementsByTagName("effect");for(var e={},i=0;i<t.length;i++){for(var r={},s=t[i].getElementsByTagName("newparam"),o=0;o<s.length;o++){var a=s[o].getElementsByTagName("surface")[0];a&&(r.surface=a.getElementsByTagName("init_from")[0].textContent)}e[t[i].getAttribute("id")]=r}return e},au.parse.from3DS=function(t){t=new Uint8Array(t);var e={};if(19789!=au.bin.rsl(t,0))return null;for(var i=au.bin.ril(t,2),r=6;r<i;){var s=au.bin.rsl(t,r),o=au.bin.ril(t,r+2);15677==s&&(e.edit=au.parse.from3DS._edit3ds(t,r,o)),45056==s&&(e.keyf=au.parse.from3DS._keyf3ds(t,r,o)),r+=o}return e},au.parse.from3DS._edit3ds=function(t,e,i){for(var r={},s=e+6;s<e+i;){var o=au.bin.rsl(t,s),a=au.bin.ril(t,s+2);16384==o&&(null==r.objects&&(r.objects=[]),r.objects.push(au.parse.from3DS._edit_object(t,s,a))),s+=a}return r},au.parse.from3DS._keyf3ds=function(t,e,i){for(var r={},s=e+6;s<e+i;){var o=au.bin.rsl(t,s),a=au.bin.ril(t,s+2);45058==o&&(null==r.desc&&(r.desc=[]),r.desc.push(au.parse.from3DS._keyf_objdes(t,s,a))),s+=a}return r},au.parse.from3DS._keyf_objdes=function(t,e,i){for(var r={},s=e+6;s<e+i;){var o=au.bin.rsl(t,s),a=au.bin.ril(t,s+2);45072==o&&(r.hierarchy=au.parse.from3DS._keyf_objhierarch(t,s,a)),45073==o&&(r.dummy_name=au.bin.rASCII0(t,s+6)),s+=a}return r},au.parse.from3DS._keyf_objhierarch=function(t,e,i){var r={},s=e+6;return r.name=au.bin.rASCII0(t,s),s+=r.name.length+1,r.hierarchy=au.bin.rsl(t,s+4),r},au.parse.from3DS._edit_object=function(t,e,i){var r={},s=e+6;for(r.name=au.bin.rASCII0(t,s),s+=r.name.length+1;s<e+i;){var o=au.bin.rsl(t,s),a=au.bin.ril(t,s+2);16640==o&&(r.mesh=au.parse.from3DS._obj_trimesh(t,s,a)),s+=a}return r},au.parse.from3DS._obj_trimesh=function(t,e,i){for(var r={},s=e+6;s<e+i;){var o=au.bin.rsl(t,s),a=au.bin.ril(t,s+2);16656==o&&(r.vertices=au.parse.from3DS._tri_vertexl(t,s,a)),16672==o&&(r.indices=au.parse.from3DS._tri_facel1(t,s,a)),16704==o&&(r.uvt=au.parse.from3DS._tri_mappingcoors(t,s,a)),16736==o&&(r.local=au.parse.from3DS._tri_local(t,s,a)),s+=a}return r},au.parse.from3DS._tri_vertexl=function(t,e,i){var r=[],s=e+6,o=au.bin.rsl(t,s);s+=2;for(var a=0;a<o;a++)r.push(au.bin.rf(t,s)),r.push(au.bin.rf(t,s+4)),r.push(au.bin.rf(t,s+8)),s+=12;return r},au.parse.from3DS._tri_facel1=function(t,e,i){var r=[],s=e+6,o=au.bin.rsl(t,s);s+=2;for(var a=0;a<o;a++)r.push(au.bin.rsl(t,s)),r.push(au.bin.rsl(t,s+2)),r.push(au.bin.rsl(t,s+4)),s+=8;return r},au.parse.from3DS._tri_mappingcoors=function(t,e,i){var r=[],s=e+6,o=au.bin.rsl(t,s);s+=2;for(var a=0;a<o;a++)r.push(au.bin.rf(t,s)),r.push(1-au.bin.rf(t,s+4)),s+=8;return r},au.parse.from3DS._tri_local=function(t,e,i){var r={},s=e+6;return r.X=[au.bin.rf(t,s),au.bin.rf(t,s+4),au.bin.rf(t,s+8)],s+=12,r.Y=[au.bin.rf(t,s),au.bin.rf(t,s+4),au.bin.rf(t,s+8)],s+=12,r.Z=[au.bin.rf(t,s),au.bin.rf(t,s+4),au.bin.rf(t,s+8)],s+=12,r.C=[au.bin.rf(t,s),au.bin.rf(t,s+4),au.bin.rf(t,s+8)],s+=12,r},au.parse.fromBIV=function(t){t=new Uint8Array(t);var e={},i={};return i.id=au.bin.ril(t,0),i.verS=au.bin.ril(t,4),i.texS=au.bin.ril(t,8),i.indS=au.bin.ril(t,12),i.verO=au.bin.ril(t,16),i.verL=au.bin.ril(t,20),i.texO=au.bin.ril(t,24),i.texL=au.bin.ril(t,28),i.indO=au.bin.ril(t,32),i.indL=au.bin.ril(t,36),0!=i.verO&&(e.vertices=au.parse.fromBIV._readFloats(t,i.verO,i.verL)),0!=i.texO&&(e.uvt=au.parse.fromBIV._readFloats(t,i.texO,i.texL)),0!=i.indO&&(e.indices=au.parse.fromBIV._readInts(t,i.indO,i.indL,i.indS)),e},au.parse.toBIV=function(t){for(var e=0,i=0;i<t.indices.length;i++)e=Math.max(e,t.indices[i]);var r=32;e<=65535&&(r=16);var s=40;t.vertices&&(s+=4*t.vertices.length),t.uvt&&(s+=4*t.uvt.length),t.indices&&(s+=t.indices.length*r/8);var o=new Uint8Array(s);au.bin.wil(o,0,1769365870),au.bin.wil(o,4,32),au.bin.wil(o,8,32),au.bin.wil(o,12,r);var a=40;return t.vertices&&(au.bin.wil(o,16,a),au.bin.wil(o,20,4*t.vertices.length),au.parse.fromBIV._writeFloats(o,a,t.vertices),a+=4*t.vertices.length),t.uvt&&(au.bin.wil(o,24,a),au.bin.wil(o,28,4*t.uvt.length),au.parse.fromBIV._writeFloats(o,a,t.uvt),a+=4*t.uvt.length),t.indices&&(au.bin.wil(o,32,a),au.bin.wil(o,36,4*t.indices.length),au.parse.fromBIV._writeInts(o,a,t.indices,r)),o.buffer},au.parse.fromBIV._readFloats=function(t,e,i){for(var r=[],s=0;s<i/4;s++)r.push(au.bin.rf(t,e+4*s));return r},au.parse.fromBIV._writeFloats=function(t,e,i){for(var r=0;r<i.length;r++)au.bin.wf(t,e+4*r,i[r])},au.parse.fromBIV._readInts=function(t,e,i,r){for(var s=[],o=0;o<i/4;o++)16==r&&s.push(au.bin.rsl(t,e+2*o)),32==r&&s.push(au.bin.ril(t,e+4*o));return s},au.parse.fromBIV._writeInts=function(t,e,i,r){for(var s=0;s<i.length;s++)16==r&&au.bin.wsl(t,e+2*s,i[s]),32==r&&au.bin.wil(t,e+4*s,i[s])},au.gen={},au.gen.Plane=function(t,e,i,r){i||(i=1),r||(r=1);for(var s={verts:[],inds:[],uvt:[]},o=t+1,a=e+1,n=0;n<a;n++)for(var l=0;l<o;l++){var h=l*(2/t)-1,u=n*(2/e)-1;s.verts.push(h,u,0),s.uvt.push(i*l/t,r*n/e),n<e&&l<t&&s.inds.push(n*o+l,n*o+l+1,(n+1)*o+l,n*o+l+1,(n+1)*o+l,(n+1)*o+l+1)}return s},au.gen.Cube=function(){return{verts:[-1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],inds:[0,1,2,1,2,3,4,5,6,5,6,7,8,9,10,9,10,11,12,13,14,13,14,15,16,17,18,17,18,19,20,21,22,21,22,23],uvt:[1/4,1/4,.5,1/4,1/4,.5,.5,.5,1,1/4,3/4,1/4,1,.5,3/4,.5,0,1/4,1/4,1/4,0,.5,1/4,.5,3/4,1/4,.5,1/4,3/4,.5,.5,.5,1/4,1/4,.5,1/4,1/4,0,.5,0,1/4,.5,.5,.5,1/4,3/4,.5,3/4]}},au.gen.Sphere=function(t,e){for(var i={verts:[],inds:[],uvt:[]},r=t+1,s=e+1,o=0;o<s;o++)for(var a=0;a<r;a++){var n=-Math.PI/2+o*Math.PI/e,l=2*a*Math.PI/t,h=Math.cos(n)*Math.cos(l),u=Math.sin(n),c=Math.cos(n)*Math.sin(l);i.verts.push(h,u,c),i.uvt.push(a/t,o/e),o<e&&a<t&&i.inds.push(r*o+a,r*o+a+1,r*(o+1)+a,r*o+a+1,r*(o+1)+a,r*(o+1)+a+1)}return i},au.mat={},au.mat.scale=function(t,e,i){return[t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1]},au.mat.translate=function(t,e,i){return[1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1]},au.mat.rotateDeg=function(t,e,i){var r=Math.PI/180;return au.mat.rotate(t*r,e*r,i*r)},au.mat.rotate=function(t,e,i){var r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],s=t,o=e,a=i,n=Math.cos(s),l=Math.cos(o),h=Math.cos(a),u=Math.sin(s),c=Math.sin(o),p=Math.sin(a);return r[0]=l*h,r[1]=-l*p,r[2]=c,r[4]=n*p+u*c*h,r[5]=n*h-u*c*p,r[6]=-u*l,r[8]=u*p-n*c*h,r[9]=u*h+n*c*p,r[10]=n*l,r},au.edit={},au.edit.interpolate=function(t,e,i,r){for(var s=0;s<t.length;s++)i[s]=t[s]+r*(e[s]-t[s])},au.edit.transform=function(t,e){for(var i=0;i<t.length;i+=3){var r=t[i],s=t[i+1],o=t[i+2];t[i+0]=e[0]*r+e[4]*s+e[8]*o+e[12],t[i+1]=e[1]*r+e[5]*s+e[9]*o+e[13],t[i+2]=e[2]*r+e[6]*s+e[10]*o+e[14]}},au.edit.unwrap=function(t,e,i){for(var r=new Array(Math.floor(t.length/3)*i),s=0;s<t.length;s++)for(var o=0;o<i;o++)r[s*i+o]=e[t[s]*i+o];return r},au.edit.remap=function(t,e,i,r){for(var s=new Array(i.length),o=0;o<t.length;o++)for(var a=0;a<r;a++)s[e[o]*r+a]=i[t[o]*r+a];return s},au.utils={},au.utils.getAABB=function(t){var e,i,r,s,o,a;s=o=a=-(e=i=r=999999999);for(var n=0;n<t.length;n+=3){var l=t[n+0],h=t[n+1],u=t[n+2];l<e&&(e=l),l>s&&(s=l),h<i&&(i=h),h>o&&(o=h),u<r&&(r=u),h>a&&(a=u)}return{min:{x:e,y:i,z:r},max:{x:s,y:o,z:a}}};var pu=E.vec3(),du=E.vec3();E.vec3();var fu=E.vec3([0,-1,0]),_u=E.vec4([0,0,0,1]),gu=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._src=null,this._image=null,this._pos=E.vec3(),this._rtcCenter=E.vec3(),this._rtcPos=E.vec3(),this._dir=E.vec3(),this._size=1,this._imageSize=E.vec2(),this._texture=new In(this),this._plane=new Hi(this,{geometry:new ke(this,cu({center:[0,0,0],xSize:1,zSize:1,xSegments:10,zSegments:10})),material:new je(this,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],diffuseMap:this._texture,emissiveMap:this._texture,backfaces:!0}),clippable:i.clippable}),this._grid=new Hi(this,{geometry:new ke(this,uu({size:1,divisions:10})),material:new je(this,{diffuse:[0,0,0],ambient:[0,0,0],emissive:[.2,.8,.2]}),position:[0,.001,0],clippable:i.clippable}),this._node=new mn(this,{rotation:[0,0,0],position:[0,0,0],scale:[1,1,1],clippable:!1,children:[this._plane,this._grid]}),this._gridVisible=!1,this.visible=!0,this.gridVisible=i.gridVisible,this.position=i.position,this.rotation=i.rotation,this.dir=i.dir,this.size=i.size,this.collidable=i.collidable,this.clippable=i.clippable,this.pickable=i.pickable,this.opacity=i.opacity,i.image?this.image=i.image:this.src=i.src}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={visible:{configurable:!0},gridVisible:{configurable:!0},image:{configurable:!0},src:{configurable:!0},position:{configurable:!0},rotation:{configurable:!0},size:{configurable:!0},dir:{configurable:!0},collidable:{configurable:!0},clippable:{configurable:!0},pickable:{configurable:!0},opacity:{configurable:!0}};return i.visible.set=function(t){this._plane.visible=t,this._grid.visible=this._gridVisible&&t},i.visible.get=function(){return this._plane.visible},i.gridVisible.set=function(t){t=!1!==t,this._gridVisible=t,this._grid.visible=this._gridVisible&&this.visible},i.gridVisible.get=function(){return this._gridVisible},i.image.set=function(t){this._image=t,this._image&&(this._imageSize[0]=t.width,this._imageSize[1]=t.height,this._updatePlaneSizeFromImage(),this._src=null,this._texture.image=this._image)},i.image.get=function(){return this._image},i.src.set=function(t){var e=this;if(this._src=t,this._src){this._image=null;var i=new Image;i.onload=function(){e._texture.image=i,e._imageSize[0]=i.width,e._imageSize[1]=i.height,e._updatePlaneSizeFromImage()},i.src=this._src}},i.src.get=function(){return this._src},i.position.set=function(t){this._pos.set(t||[0,0,0]),st(this._pos,this._rtcCenter,this._rtcPos),this._node.rtcCenter=this._rtcCenter,this._node.position=this._rtcPos},i.position.get=function(){return this._pos},i.rotation.set=function(t){this._node.rotation=t},i.rotation.get=function(){return this._node.rotation},i.size.set=function(t){this._size=null==t?1:t,this._image&&this._updatePlaneSizeFromImage()},i.size.get=function(){return this._size},i.dir.set=function(t){if(this._dir.set(t||[0,0,-1]),t){var e=this.scene.center,i=[-this._dir[0],-this._dir[1],-this._dir[2]];E.subVec3(e,this.position,pu);var r=-E.dotVec3(i,pu);E.normalizeVec3(i),E.mulVec3Scalar(i,r,du),E.vec3PairToQuaternion(fu,t,_u),this._node.quaternion=_u}},i.dir.get=function(){return this._dir},i.collidable.set=function(t){this._node.collidable=!1!==t},i.collidable.get=function(){return this._node.collidable},i.clippable.set=function(t){this._node.clippable=!1!==t},i.clippable.get=function(){return this._node.clippable},i.pickable.set=function(t){this._node.pickable=!1!==t},i.pickable.get=function(){return this._node.pickable},i.opacity.set=function(t){this._node.opacity=t},i.opacity.get=function(){return this._node.opacity},e.prototype.destroy=function(){this._state.destroy(),t.prototype.destroy.call(this)},e.prototype._updatePlaneSizeFromImage=function(){var t=this._size,e=this._imageSize[0],i=this._imageSize[1],r=i/e;this._node.scale=e>i?[t,1,t*r]:[t*r,1,t]},Object.defineProperties(e.prototype,i),e}(U),mu=function(t){function e(e,i){var r=this;void 0===i&&(i={}),t.call(this,e,i);var s=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;var o=this.scene.camera,a=this.scene.canvas;this._onCameraViewMatrix=o.on("viewMatrix",(function(){r._shadowViewMatrixDirty=!0})),this._onCameraProjMatrix=o.on("projMatrix",(function(){r._shadowProjMatrixDirty=!0})),this._onCanvasBoundary=a.on("boundary",(function(){r._shadowProjMatrixDirty=!0})),this._state=new oe({type:"point",pos:E.vec3([1,1,1]),color:E.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:i.space||"view",castsShadow:!1,getShadowViewMatrix:function(){if(s._shadowViewMatrixDirty){s._shadowViewMatrix||(s._shadowViewMatrix=E.identityMat4());var t=s._state.pos,e=o.look,i=o.up;E.lookAtMat4v(t,e,i,s._shadowViewMatrix),s._shadowViewMatrixDirty=!1}return s._shadowViewMatrix},getShadowProjMatrix:function(){if(s._shadowProjMatrixDirty){s._shadowProjMatrix||(s._shadowProjMatrix=E.identityMat4());var t=s.scene.canvas.canvas;E.perspectiveMat4(Math.PI/180*70,t.clientWidth/t.clientHeight,.1,500,s._shadowProjMatrix),s._shadowProjMatrixDirty=!1}return s._shadowProjMatrix},getShadowRenderBuf:function(){return s._shadowRenderBuf||(s._shadowRenderBuf=new Bt(s.scene.canvas.canvas,s.scene.canvas.gl,{size:[1024,1024]})),s._shadowRenderBuf}}),this.pos=i.pos,this.color=i.color,this.intensity=i.intensity,this.constantAttenuation=i.constantAttenuation,this.linearAttenuation=i.linearAttenuation,this.quadraticAttenuation=i.quadraticAttenuation,this.castsShadow=i.castsShadow,this.scene._lightCreated(this)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},pos:{configurable:!0},color:{configurable:!0},intensity:{configurable:!0},constantAttenuation:{configurable:!0},linearAttenuation:{configurable:!0},quadraticAttenuation:{configurable:!0},castsShadow:{configurable:!0}};return i.type.get=function(){return"PointLight"},i.pos.set=function(t){this._state.pos.set(t||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()},i.pos.get=function(){return this._state.pos},i.color.set=function(t){this._state.color.set(t||[.7,.7,.8]),this.glRedraw()},i.color.get=function(){return this._state.color},i.intensity.set=function(t){t=void 0!==t?t:1,this._state.intensity=t,this.glRedraw()},i.intensity.get=function(){return this._state.intensity},i.constantAttenuation.set=function(t){this._state.attenuation[0]=t||0,this.glRedraw()},i.constantAttenuation.get=function(){return this._state.attenuation[0]},i.linearAttenuation.set=function(t){this._state.attenuation[1]=t||0,this.glRedraw()},i.linearAttenuation.get=function(){return this._state.attenuation[1]},i.quadraticAttenuation.set=function(t){this._state.attenuation[2]=t||0,this.glRedraw()},i.quadraticAttenuation.get=function(){return this._state.attenuation[2]},i.castsShadow.set=function(t){t=!!t,this._state.castsShadow!==t&&(this._state.castsShadow=t,this._shadowViewMatrixDirty=!0,this.glRedraw())},i.castsShadow.get=function(){return this._state.castsShadow},e.prototype.destroy=function(){var e=this.scene.camera,i=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),i.off(this._onCanvasBoundary),t.prototype.destroy.call(this),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()},Object.defineProperties(e.prototype,i),e}(we);function vu(t){return 0==(t&t-1)}function bu(t){--t;for(var e=1;e<32;e<<=1)t|=t>>e;return t+1}var yu=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i);var r=this.scene.canvas.gl;this._state=new oe({texture:new Rn(r,r.TEXTURE_CUBE_MAP),flipY:this._checkFlipY(i.minFilter),encoding:this._checkEncoding(i.encoding),minFilter:"linearMipmapLinear",magFilter:"linear",wrapS:"clampToEdge",wrapT:"clampToEdge",mipmaps:!0}),this._src=i.src,this._images=[],this._loadSrc(i.src),S.memory.textures++}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0}};return i.type.get=function(){return"CubeTexture"},e.prototype._checkFlipY=function(t){return!!t},e.prototype._checkEncoding=function(t){return"linear"!==(t=t||"linear")&&"sRGB"!==t&&"gamma"!==t&&(this.error("Unsupported value for 'encoding': '"+t+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),t="linear"),t},e.prototype._webglContextRestored=function(){this.scene.canvas.gl,this._state.texture=null,this._src&&this._loadSrc(this._src)},e.prototype._loadSrc=function(t){var e=this,i=this.scene.canvas.gl;this._images=[];for(var r=!1,s=0,o=function(o){var a,n,l=new Image;l.onload=(a=l,n=o,function(){if(!r&&(a=function(t){if(!vu(t.width)||!vu(t.height)){var e=document.createElement("canvas");e.width=bu(t.width),e.height=bu(t.height),e.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e.width,e.height),t=e}return t}(a),e._images[n]=a,6==++s)){var t=e._state.texture;t||(t=new Rn(i,i.TEXTURE_CUBE_MAP),e._state.texture=t),t.setImage(e._images,e._state),t.setProps(e._state),e.fire("loaded",e._src,!1),e.glRedraw()}}),l.onerror=function(){r=!0},l.src=t[o]},a=0;a<t.length;a++)o(a)},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.texture&&this._state.texture.destroy(),S.memory.textures--,this._state.destroy()},Object.defineProperties(e.prototype,i),e}(U),Pu=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this.scene._lightsState.addReflectionMap(this._state),this.scene._reflectionMapCreated(this)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0}};return i.type.get=function(){return"ReflectionMap"},e.prototype.destroy=function(){t.prototype.destroy.call(this),this.scene._reflectionMapDestroyed(this)},Object.defineProperties(e.prototype,i),e}(yu),Mu=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this.scene._lightMapCreated(this)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0}};return i.type.get=function(){return"LightMap"},e.prototype.destroy=function(){t.prototype.destroy.call(this),this.scene._lightMapDestroyed(this)},Object.defineProperties(e.prototype,i),e}(yu),xu=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._state=new oe({edgeColor:E.vec3([0,0,0]),centerColor:E.vec3([1,1,1]),edgeBias:0,centerBias:1,power:1}),this.edgeColor=i.edgeColor,this.centerColor=i.centerColor,this.edgeBias=i.edgeBias,this.centerBias=i.centerBias,this.power=i.power}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={type:{configurable:!0},edgeColor:{configurable:!0},centerColor:{configurable:!0},edgeBias:{configurable:!0},centerBias:{configurable:!0},power:{configurable:!0}};return i.type.get=function(){return"Fresnel"},i.edgeColor.set=function(t){this._state.edgeColor.set(t||[0,0,0]),this.glRedraw()},i.edgeColor.get=function(){return this._state.edgeColor},i.centerColor.set=function(t){this._state.centerColor.set(t||[1,1,1]),this.glRedraw()},i.centerColor.get=function(){return this._state.centerColor},i.edgeBias.set=function(t){this._state.edgeBias=t||0,this.glRedraw()},i.edgeBias.get=function(){return this._state.edgeBias},i.centerBias.set=function(t){this._state.centerBias=null!=t?t:1,this.glRedraw()},i.centerBias.get=function(){return this._state.centerBias},i.power.set=function(t){this._state.power=null!=t?t:1,this.glRedraw()},i.power.get=function(){return this._state.power},e.prototype.destroy=function(){t.prototype.destroy.call(this),this._state.destroy()},Object.defineProperties(e.prototype,i),e}(U),wu=E.vec3(),Eu=function(t){if(this.objectsVisible=[],this.objectsEdges=[],this.objectsXrayed=[],this.objectsHighlighted=[],this.objectsSelected=[],this.objectsClippable=[],this.objectsPickable=[],this.objectsColorize=[],this.objectsOpacity=[],this.numObjects=0,t){var e=t.metaScene.scene;this.saveObjects(e,t)}};Eu.prototype.saveObjects=function(t,e,i){var r=e.rootMetaObject;if(r){var s=r.getObjectIDsInSubtree();this.numObjects=0,this._mask=i?B.apply(i,{}):null;for(var o=t.objects,a=!i||i.visible,n=!i||i.edges,l=!i||i.xrayed,h=!i||i.highlighted,u=!i||i.selected,c=!i||i.clippable,p=!i||i.pickable,d=!i||i.colorize,f=!i||i.opacity,_=0,g=s.length;_<g;_++){var m=o[s[_]];if(m){if(a&&(this.objectsVisible[_]=m.visible),n&&(this.objectsEdges[_]=m.edges),l&&(this.objectsXrayed[_]=m.xrayed),h&&(this.objectsHighlighted[_]=m.highlighted),u&&(this.objectsSelected[_]=m.selected),c&&(this.objectsClippable[_]=m.clippable),p&&(this.objectsPickable[_]=m.pickable),d){var v=m.colorize;this.objectsColorize[3*_+0]=v[0],this.objectsColorize[3*_+1]=v[1],this.objectsColorize[3*_+2]=v[2]}f&&(this.objectsOpacity[_]=m.opacity),this.numObjects++}}}},Eu.prototype.restoreObjects=function(t,e){var i=e.rootMetaObject;if(i)for(var r=i.getObjectIDsInSubtree(),s=this._mask,o=!s||s.visible,a=!s||s.edges,n=!s||s.xrayed,l=!s||s.highlighted,h=!s||s.selected,u=!s||s.clippable,c=!s||s.pickable,p=!s||s.colorize,d=!s||s.opacity,f=t.objects,_=0,g=r.length;_<g;_++){var m=f[r[_]];m&&(o&&(m.visible=this.objectsVisible[_]),a&&(m.edges=this.objectsEdges[_]),n&&(m.xrayed=this.objectsXrayed[_]),l&&(m.highlighted=this.objectsHighlighted[_]),h&&(m.selected=this.objectsSelected[_]),u&&(m.clippable=this.objectsClippable[_]),c&&(m.pickable=this.objectsPickable[_]),p&&(wu[0]=this.objectsColorize[3*_+0],wu[1]=this.objectsColorize[3*_+1],wu[2]=this.objectsColorize[3*_+2],m.colorize=wu),d&&(m.opacity=this.objectsOpacity[_]))}};var Cu=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this.v0=i.v0,this.v1=i.v1,this.v2=i.v2,this.v3=i.v3,this.t=i.t}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={v0:{configurable:!0},v1:{configurable:!0},v2:{configurable:!0},v3:{configurable:!0},t:{configurable:!0},point:{configurable:!0}};return i.v0.set=function(t){this._v0=t||E.vec3([0,0,0])},i.v0.get=function(){return this._v0},i.v1.set=function(t){this._v1=t||E.vec3([0,0,0])},i.v1.get=function(){return this._v1},i.v2.set=function(t){this._v2=t||E.vec3([0,0,0])},i.v2.get=function(){return this._v2},i.v3.set=function(t){this.fire("v3",this._v3=t||E.vec3([0,0,0]))},i.v3.get=function(){return this._v3},i.t.set=function(t){t=t||0,this._t=t<0?0:t>1?1:t},i.t.get=function(){return this._t},i.point.get=function(){return this.getPoint(this._t)},e.prototype.getPoint=function(t){var e=E.vec3();return e[0]=E.b3(t,this._v0[0],this._v1[0],this._v2[0],this._v3[0]),e[1]=E.b3(t,this._v0[1],this._v1[1],this._v2[1],this._v3[1]),e[2]=E.b3(t,this._v0[2],this._v1[2],this._v2[2],this._v3[2]),e},e.prototype.getJSON=function(){return{v0:this._v0,v1:this._v1,v2:this._v2,v3:this._v3,t:this._t}},Object.defineProperties(e.prototype,i),e}(qh),Au=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this._cachedLengths=[],this._dirty=!0,this._curves=[],this._t=0,this._dirtySubs=[],this._destroyedSubs=[],this.curves=i.curves||[],this.t=i.t}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={curves:{configurable:!0},t:{configurable:!0},point:{configurable:!0},length:{configurable:!0}};return e.prototype.addCurve=function(t){this._curves.push(t),this._dirty=!0},i.curves.set=function(t){var e,i,r;for(t=t||[],i=0,r=this._curves.length;i<r;i++)(e=this._curves[i]).off(this._dirtySubs[i]),e.off(this._destroyedSubs[i]);this._curves=[],this._dirtySubs=[],this._destroyedSubs=[];var s=this;function o(){s._dirty=!0}function a(){var t=this.id;for(i=0,r=s._curves.length;i<r;i++)if(s._curves[i].id===t)return s._curves=s._curves.slice(i,i+1),s._dirtySubs=s._dirtySubs.slice(i,i+1),s._destroyedSubs=s._destroyedSubs.slice(i,i+1),void(s._dirty=!0)}for(i=0,r=t.length;i<r;i++){if(e=t[i],B.isNumeric(e)||B.isString(e)){var n=e;if(!(e=this.scene.components[n])){this.error("Component not found: "+_inQuotes(n));continue}}var l=e.type;"xeokit.SplineCurve"===l||"xeokit.Path"===l||"xeokit.CubicBezierCurve"===l||"xeokit.QuadraticBezierCurve"===l?(this._curves.push(e),this._dirtySubs.push(e.on("dirty",o)),this._destroyedSubs.push(e.once("destroyed",a))):this.error("Component "+_inQuotes(e.id)+" is not a xeokit.SplineCurve, xeokit.Path or xeokit.QuadraticBezierCurve")}this._dirty=!0},i.curves.get=function(){return this._curves},i.t.set=function(t){t=t||0,this._t=t<0?0:t>1?1:t},i.t.get=function(){return this._t},i.point.get=function(){return this.getPoint(this._t)},i.length.get=function(){var t=this._getCurveLengths();return t[t.length-1]},e.prototype.getPoint=function(t){for(var e,i=t*this.length,r=this._getCurveLengths(),s=0;s<r.length;){if(r[s]>=i){var o=1-(r[s]-i)/(e=this._curves[s]).length;return e.getPointAt(o)}s++}return null},e.prototype._getCurveLengths=function(){if(!this._dirty)return this._cachedLengths;var t,e=[],i=0,r=this._curves.length;for(t=0;t<r;t++)i+=this._curves[t].length,e.push(i);return this._cachedLengths=e,this._dirty=!1,e},e.prototype._getJSON=function(){for(var t=[],e=0,i=this._curves.length;e<i;e++)t.push(this._curves[e].id);return{curves:t,t:this._t}},e.prototype.destroy=function(){var e,i,r;for(t.prototype.destroy.call(this),e=0,i=this._curves.length;e<i;e++)(r=this._curves[e]).off(this._dirtySubs[e]),r.off(this._destroyedSubs[e])},Object.defineProperties(e.prototype,i),e}(qh),Su=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this.v0=i.v0,this.v1=i.v1,this.v2=i.v2,this.t=i.t}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={v0:{configurable:!0},v1:{configurable:!0},v2:{configurable:!0},t:{configurable:!0},point:{configurable:!0}};return i.v0.set=function(t){this._v0=t||E.vec3([0,0,0])},i.v0.get=function(){return this._v0},i.v1.set=function(t){this._v1=t||E.vec3([0,0,0])},i.v1.get=function(){return this._v1},i.v2.set=function(t){this._v2=t||E.vec3([0,0,0])},i.v2.get=function(){return this._v2},i.t.set=function(t){t=t||0,this._t=t<0?0:t>1?1:t},i.t.get=function(){return this._t},i.point.get=function(){return this.getPoint(this._t)},e.prototype.getPoint=function(t){var e=E.vec3();return e[0]=E.b2(t,this._v0[0],this._v1[0],this._v2[0]),e[1]=E.b2(t,this._v0[1],this._v1[1],this._v2[1]),e[2]=E.b2(t,this._v0[2],this._v1[2],this._v2[2]),e},e.prototype.getJSON=function(){return{v0:this._v0,v1:this._v1,v2:this._v2,t:this._t}},Object.defineProperties(e.prototype,i),e}(qh),Du=E.vec4(),Lu=E.vec4(),Bu=E.vec3(),Ru=E.vec3(),Tu=E.vec3(),Fu=E.vec4(),Nu=E.vec4(),Iu=E.vec4(),ku=function(t){this._scene=t};ku.prototype.dollyToCanvasPos=function(t,e,i){var r=!1,s=this._scene.camera;if(t){var o=E.subVec3(t,s.eye,Bu);r=E.lenVec3(o)<i}if("perspective"===s.projection){s.ortho.scale=s.ortho.scale-i;var a=this._unproject(e,Fu),n=E.subVec3(a,s.eye,Iu),l=E.mulVec3Scalar(E.normalizeVec3(n),-i,[]);if(s.eye=[s.eye[0]-l[0],s.eye[1]-l[1],s.eye[2]-l[2]],s.look=[s.look[0]-l[0],s.look[1]-l[1],s.look[2]-l[2]],t){var h=E.subVec3(t,s.eye,Bu),u=E.lenVec3(h),c=E.mulVec3Scalar(E.normalizeVec3(E.subVec3(s.look,s.eye,Ru)),u);s.look=[s.eye[0]+c[0],s.eye[1]+c[1],s.eye[2]+c[2]]}}else if("ortho"===s.projection){var p=this._unproject(e,Fu);s.ortho.scale=s.ortho.scale-i,s.ortho._update();var d=this._unproject(e,Nu),f=E.subVec3(d,p,Iu),_=E.mulVec3Scalar(E.normalizeVec3(E.subVec3(s.look,s.eye,Bu)),-i,Ru),g=E.addVec3(f,_,Tu);s.eye=[s.eye[0]-g[0],s.eye[1]-g[1],s.eye[2]-g[2]],s.look=[s.look[0]-g[0],s.look[1]-g[1],s.look[2]-g[2]]}return r},ku.prototype._unproject=function(t,e){var i=this._scene.camera,r=i.project.transposedMatrix,s=r.subarray(8,12),o=r.subarray(12),a=[0,0,-1,1],n=E.dotVec4(a,s)/E.dotVec4(a,o);return i.project.unproject(t,n,Du,Lu,e),e},ku.prototype.destroy=function(){};var Ou=E.vec3(),Vu=E.vec3(),zu=E.vec3(),Uu=E.vec4(),ju=E.vec4(),Gu=E.vec4(),Xu=function(t,e){var i=this;this._scene=t,this._configs=e,this._pivotWorldPos=E.vec3(),this._cameraOffset=E.vec3(),this._azimuth=0,this._polar=0,this._radius=0,this._pivotPosSet=!1,this._pivoting=!1,this._shown=!1,this._pivotViewPos=E.vec4(),this._pivotProjPos=E.vec4(),this._pivotCanvasPos=E.vec2(),this._cameraDirty=!0,this._onViewMatrix=this._scene.camera.on("viewMatrix",(function(){i._cameraDirty=!0})),this._onProjMatrix=this._scene.camera.on("projMatrix",(function(){i._cameraDirty=!0})),this._onTick=this._scene.on("tick",(function(){i.updatePivotElement()}))};Xu.prototype.updatePivotElement=function(){var t=this._scene.camera,e=this._scene.canvas;if(this._pivoting&&this._cameraDirty){E.transformPoint3(t.viewMatrix,this.getPivotPos(),this._pivotViewPos),this._pivotViewPos[3]=1,E.transformPoint4(t.projMatrix,this._pivotViewPos,this._pivotProjPos);var i=e.boundary,r=i[2],s=i[3];this._pivotCanvasPos[0]=Math.floor((1+this._pivotProjPos[0]/this._pivotProjPos[3])*r/2),this._pivotCanvasPos[1]=Math.floor((1-this._pivotProjPos[1]/this._pivotProjPos[3])*s/2);var o=e.canvas.getBoundingClientRect();this._pivotElement&&(this._pivotElement.style.left=Math.floor(o.left+this._pivotCanvasPos[0])-this._pivotElement.clientWidth/2+window.scrollX+"px",this._pivotElement.style.top=Math.floor(o.top+this._pivotCanvasPos[1])-this._pivotElement.clientHeight/2+window.scrollY+"px"),this._cameraDirty=!1}},Xu.prototype.setPivotElement=function(t){this._pivotElement=t},Xu.prototype.startPivot=function(){if(this._cameraLookingDownwards())return this._pivoting=!1,!1;var t=this._scene.camera,e=E.lookAtMat4v(t.eye,t.look,t.worldUp);E.transformPoint3(e,this.getPivotPos(),this._cameraOffset);var i=this.getPivotPos();this._cameraOffset[2]+=E.distVec3(t.eye,i),e=E.inverseMat4(e);var r=E.transformVec3(e,this._cameraOffset),s=E.vec3();if(E.subVec3(t.eye,i,s),E.addVec3(s,r),t.zUp){var o=s[1];s[1]=s[2],s[2]=o}this._radius=E.lenVec3(s),this._polar=Math.acos(s[1]/this._radius),this._azimuth=Math.atan2(s[0],s[2]),this._pivoting=!0},Xu.prototype._cameraLookingDownwards=function(){var t=this._scene.camera,e=E.normalizeVec3(E.subVec3(t.look,t.eye,Ou)),i=E.cross3Vec3(e,t.worldUp,Vu);return E.sqLenVec3(i)<=1e-4},Xu.prototype.getPivoting=function(){return this._pivoting},Xu.prototype.setPivotPos=function(t){this._pivotWorldPos.set(t),this._pivotPosSet=!0},Xu.prototype.setCanvasPivotPos=function(t){var e=this._scene.camera,i=Math.abs(E.distVec3(this._scene.center,e.eye)),r=e.project.transposedMatrix,s=r.subarray(8,12),o=r.subarray(12),a=[0,0,-1,1],n=E.dotVec4(a,s)/E.dotVec4(a,o),l=Uu;e.project.unproject(t,n,ju,Gu,l);var h=E.normalizeVec3(E.subVec3(l,e.eye,Ou)),u=E.addVec3(e.eye,E.mulVec3Scalar(h,i,Vu),zu);this.setPivotPos(u)},Xu.prototype.getPivotPos=function(){return this._pivotPosSet?this._pivotWorldPos:this._scene.camera.look},Xu.prototype.continuePivot=function(t,e){if(this._pivoting&&(0!==t||0!==e)){var i=this._scene.camera,r=-t,s=-e;1===i.worldUp[2]&&(r=-r),this._azimuth+=.01*-r,this._polar+=.01*s,this._polar=E.clamp(this._polar,.001,Math.PI-.001);var o=[this._radius*Math.sin(this._polar)*Math.sin(this._azimuth),this._radius*Math.cos(this._polar),this._radius*Math.sin(this._polar)*Math.cos(this._azimuth)];if(1===i.worldUp[2]){var a=o[1];o[1]=o[2],o[2]=a}var n=E.lenVec3(E.subVec3(i.look,i.eye,E.vec3())),l=this.getPivotPos();E.addVec3(o,l);var h=E.lookAtMat4v(o,l,i.worldUp);h=E.inverseMat4(h);var u=E.transformVec3(h,this._cameraOffset);h[12]-=u[0],h[13]-=u[1],h[14]-=u[2];var c=[h[8],h[9],h[10]];i.eye=[h[12],h[13],h[14]],E.subVec3(i.eye,E.mulVec3Scalar(c,n),i.look),i.up=[h[4],h[5],h[6]],this.showPivot()}},Xu.prototype.showPivot=function(){var t=this;this._shown||(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this.updatePivotElement(),this._pivotElement.style.visibility="visible",this._shown=!0,this._hideTimeout=window.setTimeout((function(){t.hidePivot()}),1e3)))},Xu.prototype.hidePivot=function(){this._shown&&(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this._pivotElement.style.visibility="hidden"),this._shown=!1)},Xu.prototype.endPivot=function(){this._pivoting=!1},Xu.prototype.destroy=function(){this._scene.camera.off(this._onViewMatrix),this._scene.camera.off(this._onProjMatrix),this._scene.off(this._onTick)};var Wu=function(t,e){this._scene=t.scene,this._cameraControl=t,this._scene.canvas.canvas.oncontextmenu=function(t){t.preventDefault()},this._configs=e,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.pickCursorPos=E.vec2(),this.picked=!1,this.pickedSurface=!1,this.pickResult=null,this._lastPickedEntityId=null,this._needFireEvents=!1};Wu.prototype.update=function(){if(this._configs.pointerEnabled&&(this.schedulePickEntity||this.schedulePickSurface)){this.picked=!1,this.pickedSurface=!1,this._needFireEvents=!1;var t=this._cameraControl.hasSubs("hoverSurface");if(this.schedulePickSurface&&this.pickResult&&this.pickResult.worldPos){var e=this.pickResult.canvasPos;if(e[0]===this.pickCursorPos[0]&&e[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!0,this._needFireEvents=t,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}if(this.schedulePickEntity&&this.pickResult){var i=this.pickResult.canvasPos;if(i[0]===this.pickCursorPos[0]&&i[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!1,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}this.schedulePickSurface?(this.pickResult=this._scene.pick({pickSurface:!0,pickSurfaceNormal:!1,canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!0,this._needFireEvents=!0)):(this.pickResult=this._scene.pick({canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!0)),this.schedulePickEntity=!1,this.schedulePickSurface=!1}},Wu.prototype.fireEvents=function(){if(this._needFireEvents){if(this.picked&&this.pickResult&&this.pickResult.entity){var t=this.pickResult.entity.id;this._lastPickedEntityId!==t&&(void 0!==this._lastPickedEntityId&&this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._cameraControl.fire("hoverEnter",this.pickResult,!0),this._lastPickedEntityId=t),this._cameraControl.fire("hover",this.pickResult,!0),this.pickResult.worldPos&&(this.pickedSurface=!0,this._cameraControl.fire("hoverSurface",this.pickResult,!0))}else void 0!==this._lastPickedEntityId&&(this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),this._cameraControl.fire("hoverOff",{canvasPos:this.pickCursorPos},!0);this.pickResult=null,this._needFireEvents=!1}},Wu.prototype.destroy=function(){};var Hu=E.vec2(),Yu=function(t,e,i,r,s){this._scene=t;var o,a,n,l=e.pickController,h=0,u=0,c=0,p=0,d=!1,f=E.vec3(),_=!0,g=this._scene.canvas.canvas,m=[];function v(t){void 0===t&&(t=!0),g.style.cursor="move",h=r.pointerCanvasPos[0],u=r.pointerCanvasPos[1],c=r.pointerCanvasPos[0],p=r.pointerCanvasPos[1],t&&(l.pickCursorPos=r.pointerCanvasPos,l.schedulePickSurface=!0,l.update(),l.picked&&l.pickedSurface&&l.pickResult&&l.pickResult.worldPos?(d=!0,f.set(l.pickResult.worldPos)):d=!1)}document.addEventListener("keydown",this._documentKeyDownHandler=function(e){if(i.active&&i.pointerEnabled&&t.input.keyboardEnabled){var r=e.keyCode;m[r]=!0}}),document.addEventListener("keyup",this._documentKeyUpHandler=function(e){if(i.active&&i.pointerEnabled&&t.input.keyboardEnabled){var r=e.keyCode;m[r]=!1}}),g.addEventListener("mousedown",this._mouseDownHandler=function(e){if(i.active&&i.pointerEnabled)switch(e.which){case 1:m[t.input.KEY_SHIFT]||i.planView?(o=!0,v()):(o=!0,v(!1));break;case 2:a=!0,v();break;case 3:n=!0,i.panRightClick&&v()}}),document.addEventListener("mousemove",this._documentMouseMoveHandler=function(){if(i.active&&i.pointerEnabled&&(o||a||n)){var e=t.canvas.boundary,l=e[2]-e[0],c=e[3]-e[1],p=r.pointerCanvasPos[0],_=r.pointerCanvasPos[1];if(m[t.input.KEY_SHIFT]||i.planView||!i.panRightClick&&a||i.panRightClick&&n){var g=p-h,v=_-u,b=t.camera;if("perspective"===b.projection){var y=Math.abs(d?E.lenVec3(E.subVec3(f,t.camera.eye,[])):t.camera.eyeLookDist)*Math.tan(b.perspective.fov/2*Math.PI/180);s.panDeltaX+=1.5*g*y/c,s.panDeltaY+=1.5*v*y/c}else s.panDeltaX+=.5*b.ortho.scale*(g/c),s.panDeltaY+=.5*b.ortho.scale*(v/c)}else!o||a||n||i.planView||(i.firstPerson?(s.rotateDeltaY-=(p-h)/l*i.dragRotationRate/2,s.rotateDeltaX+=(_-u)/c*(i.dragRotationRate/4)):(s.rotateDeltaY-=(p-h)/l*(1.5*i.dragRotationRate),s.rotateDeltaX+=(_-u)/c*(1.5*i.dragRotationRate)));h=p,u=_}}),g.addEventListener("mousemove",this._canvasMouseMoveHandler=function(t){i.active&&i.pointerEnabled&&r.mouseover&&(_=!0)}),document.addEventListener("mouseup",this._documentMouseUpHandler=function(t){if(i.active&&i.pointerEnabled)switch(t.which){case 1:case 2:case 3:o=!1,a=!1,n=!1}}),g.addEventListener("mouseup",this._mouseUpHandler=function(t){if(i.active&&i.pointerEnabled){switch(t.which){case 3:!function(t,e){if(t){for(var i=t.target,r=0,s=0;i.offsetParent;)r+=i.offsetLeft,s+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-r,e[1]=t.pageY-s}else t=window.event,e[0]=t.x,e[1]=t.y}(t,Hu);var r=Hu[0],s=Hu[1];Math.abs(r-c)<3&&Math.abs(s-p)<3&&e.cameraControl.fire("rightClick",{pagePos:[Math.round(t.pageX),Math.round(t.pageY)],canvasPos:Hu,event:t},!0)}g.style.removeProperty("cursor")}}),g.addEventListener("mouseenter",this._mouseEnterHandler=function(){i.active&&i.pointerEnabled});var b=1/60,y=null;g.addEventListener("wheel",this._mouseWheelHandler=function(t){if(i.active&&i.pointerEnabled){var e=performance.now()/1e3,o=null!==y?e-y:0;y=e,o>.05&&(o=.05),o<b&&(o=b);var a=Math.max(-1,Math.min(1,40*-t.deltaY));if(0!==a){var n=a/Math.abs(a);s.dollyDelta+=-n*o*i.mouseWheelDollyRate,_&&(r.followPointerDirty=!0,_=!1),t.preventDefault()}}})};Yu.prototype.reset=function(){},Yu.prototype.destroy=function(){var t=this._scene.canvas.canvas;document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler),t.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mousemove",this._documentMouseMoveHandler),t.removeEventListener("mousemove",this._canvasMouseMoveHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),t.removeEventListener("mouseup",this._mouseUpHandler),t.removeEventListener("mouseenter",this._mouseEnterHandler),t.removeEventListener("wheel",this._mouseWheelHandler)};var Ku=E.vec3(),qu=E.vec3(),Zu=E.vec3(),Qu=E.vec3(),Ju=E.vec3(),$u={eye:E.vec3(),look:E.vec3(),up:E.vec3()},tc=function(t,e,i,r,s){this._scene=t;var o=e.cameraControl,a=t.camera;t.input.on("keydown",this._documentKeyDownHandler=function(s){if(i.active&&i.pointerEnabled&&t.input.keyboardEnabled&&r.mouseover){var n=o._isKeyDownForAction(o.AXIS_VIEW_RIGHT),l=o._isKeyDownForAction(o.AXIS_VIEW_BACK),h=o._isKeyDownForAction(o.AXIS_VIEW_LEFT),u=o._isKeyDownForAction(o.AXIS_VIEW_FRONT),c=o._isKeyDownForAction(o.AXIS_VIEW_TOP),p=o._isKeyDownForAction(o.AXIS_VIEW_BOTTOM);if(n||l||h||u||c||p){var d=t.aabb,f=E.getAABB3Diag(d);E.getAABB3Center(d,Ku);var _=Math.abs(f/Math.tan(e.cameraFlight.fitFOV*E.DEGTORAD)),g=1.1*f;$u.orthoScale=g,n?($u.eye.set(E.addVec3(Ku,E.mulVec3Scalar(a.worldRight,_,qu),Ju)),$u.look.set(Ku),$u.up.set(a.worldUp)):l?($u.eye.set(E.addVec3(Ku,E.mulVec3Scalar(a.worldForward,_,qu),Ju)),$u.look.set(Ku),$u.up.set(a.worldUp)):h?($u.eye.set(E.addVec3(Ku,E.mulVec3Scalar(a.worldRight,-_,qu),Ju)),$u.look.set(Ku),$u.up.set(a.worldUp)):u?($u.eye.set(E.addVec3(Ku,E.mulVec3Scalar(a.worldForward,-_,qu),Ju)),$u.look.set(Ku),$u.up.set(a.worldUp)):c?($u.eye.set(E.addVec3(Ku,E.mulVec3Scalar(a.worldUp,_,qu),Ju)),$u.look.set(Ku),$u.up.set(E.normalizeVec3(E.mulVec3Scalar(a.worldForward,1,Zu),Qu))):p&&($u.eye.set(E.addVec3(Ku,E.mulVec3Scalar(a.worldUp,-_,qu),Ju)),$u.look.set(Ku),$u.up.set(E.normalizeVec3(E.mulVec3Scalar(a.worldForward,-1,Zu)))),!i.firstPerson&&i.followPointer&&e.pivotController.setPivotPos(Ku),e.cameraFlight.duration>0?e.cameraFlight.flyTo($u,(function(){e.pivotController.getPivoting()&&i.followPointer&&e.pivotController.showPivot()})):(e.cameraFlight.jumpTo($u),e.pivotController.getPivoting()&&i.followPointer&&e.pivotController.showPivot())}}})};tc.prototype.reset=function(){},tc.prototype.destroy=function(){document.removeEventListener("keydown",this._documentKeyDownHandler)};var ec=function(t,e,i,r,s){var o=this;this._scene=t;var a=e.pickController,n=e.pivotController,l=e.cameraControl;this._clicks=0,this._timeout=null,this._lastPickedEntityId=null;var h=!1,u=!1,c=this._scene.canvas.canvas,p=function(i){var r;i&&i.worldPos&&(r=i.worldPos);var s=i&&i.entity?i.entity.aabb:t.aabb;if(r){var o=t.camera;E.subVec3(o.eye,o.look,[]),e.cameraFlight.flyTo({aabb:s})}else e.cameraFlight.flyTo({aabb:s})};c.addEventListener("mousemove",this._canvasMouseMoveHandler=function(e){if(i.active&&i.pointerEnabled&&!h&&!u){var s=l.hasSubs("hover"),n=l.hasSubs("hoverOut"),c=l.hasSubs("hoverOff"),p=l.hasSubs("hoverSurface");if(s||n||c||p)if(a.pickCursorPos=r.pointerCanvasPos,a.schedulePickEntity=!0,a.schedulePickSurface=p,a.update(),a.pickResult){var d=a.pickResult.entity.id;o._lastPickedEntityId!==d&&(void 0!==o._lastPickedEntityId&&l.fire("hoverOut",{entity:t.objects[o._lastPickedEntityId]},!0),l.fire("hoverEnter",a.pickResult,!0),o._lastPickedEntityId=d),l.fire("hover",a.pickResult,!0),a.pickResult.worldPos&&l.fire("hoverSurface",a.pickResult,!0)}else void 0!==o._lastPickedEntityId&&(l.fire("hoverOut",{entity:t.objects[o._lastPickedEntityId]},!0),o._lastPickedEntityId=void 0),l.fire("hoverOff",{canvasPos:a.pickCursorPos},!0)}}),c.addEventListener("mousedown",this._canvasMouseDownHandler=function(e){if(1===e.which&&(h=!0),3===e.which&&(u=!0),1===e.which&&i.active&&i.pointerEnabled&&(r.mouseDownClientX=e.clientX,r.mouseDownClientY=e.clientY,r.mouseDownCursorX=r.pointerCanvasPos[0],r.mouseDownCursorY=r.pointerCanvasPos[1],!i.firstPerson&&i.followPointer&&(a.pickCursorPos=r.pointerCanvasPos,a.schedulePickSurface=!0,a.update(),1===e.which))){var s=a.pickResult;s&&s.worldPos?(n.setPivotPos(s.worldPos),n.startPivot()):(i.smartPivot?n.setCanvasPivotPos(r.pointerCanvasPos):n.setPivotPos(t.camera.look),n.startPivot())}}),document.addEventListener("mouseup",this._documentMouseUpHandler=function(t){1===t.which&&(h=!1),3===t.which&&(u=!1)}),c.addEventListener("mouseup",this._canvasMouseUpHandler=function(s){if(i.active&&i.pointerEnabled&&(1===s.which&&(n.hidePivot(),!(Math.abs(s.clientX-r.mouseDownClientX)>3||Math.abs(s.clientY-r.mouseDownClientY)>3)))){var h=l.hasSubs("picked"),u=l.hasSubs("pickedNothing"),c=l.hasSubs("pickedSurface"),d=l.hasSubs("doublePicked"),f=l.hasSubs("doublePickedSurface"),_=l.hasSubs("doublePickedNothing");if(!(i.doublePickFlyTo||d||f||_))return(h||u||c)&&(a.pickCursorPos=r.pointerCanvasPos,a.schedulePickEntity=!0,a.schedulePickSurface=c,a.update(),a.pickResult?(l.fire("picked",a.pickResult,!0),a.pickedSurface&&l.fire("pickedSurface",a.pickResult,!0)):l.fire("pickedNothing",{canvasPos:r.pointerCanvasPos},!0)),void(o._clicks=0);if(o._clicks++,1===o._clicks)o._timeout=setTimeout((function(){a.pickCursorPos=r.pointerCanvasPos,a.schedulePickEntity=i.doublePickFlyTo,a.schedulePickSurface=c,a.update(),a.pickResult?(l.fire("picked",a.pickResult,!0),a.pickedSurface&&(l.fire("pickedSurface",a.pickResult,!0),!i.firstPerson&&i.followPointer&&(e.pivotController.setPivotPos(a.pickResult.worldPos),e.pivotController.startPivot()&&e.pivotController.showPivot()))):l.fire("pickedNothing",{canvasPos:r.pointerCanvasPos},!0),o._clicks=0}),250);else{if(null!==o._timeout&&(window.clearTimeout(o._timeout),o._timeout=null),a.pickCursorPos=r.pointerCanvasPos,a.schedulePickEntity=i.doublePickFlyTo||d||f,a.schedulePickSurface=a.schedulePickEntity&&f,a.update(),a.pickResult){if(l.fire("doublePicked",a.pickResult,!0),a.pickedSurface&&l.fire("doublePickedSurface",a.pickResult,!0),i.doublePickFlyTo&&(p(a.pickResult),!i.firstPerson&&i.followPointer)){var g=a.pickResult.entity.aabb,m=E.getAABB3Center(g);e.pivotController.setPivotPos(m),e.pivotController.startPivot()&&e.pivotController.showPivot()}}else if(l.fire("doublePickedNothing",{canvasPos:r.pointerCanvasPos},!0),i.doublePickFlyTo&&(p(),!i.firstPerson&&i.followPointer)){var v=t.aabb,b=E.getAABB3Center(v);e.pivotController.setPivotPos(b),e.pivotController.startPivot()&&e.pivotController.showPivot()}o._clicks=0}}},!1)};ec.prototype.reset=function(){this._clicks=0,this._lastPickedEntityId=null,this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)},ec.prototype.destroy=function(){var t=this._scene.canvas.canvas;t.removeEventListener("mousemove",this._canvasMouseMoveHandler),t.removeEventListener("mousedown",this._canvasMouseDownHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),t.removeEventListener("mouseup",this._canvasMouseUpHandler),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)};var ic=function(t,e,i,r,s){this._scene=t;var o=t.input,a=[],n=t.canvas.canvas;e.pickController;var l=!0;document.addEventListener("mousemove",this._documentMouseMoveHandler=function(){l=!0}),document.addEventListener("keydown",this._documentKeyDownHandler=function(e){if(i.active&&i.pointerEnabled&&t.input.keyboardEnabled&&r.mouseover){var s=e.keyCode;a[s]=!0,s===o.KEY_SHIFT&&(n.style.cursor="move")}}),document.addEventListener("keyup",this._documentKeyUpHandler=function(e){if(i.active&&i.pointerEnabled&&t.input.keyboardEnabled&&r.mouseover){var s=e.keyCode;a[s]=!1,s===o.KEY_SHIFT&&(n.style.cursor=null)}}),this._onTick=t.on("tick",(function(n){if(i.active&&i.pointerEnabled&&t.input.keyboardEnabled&&r.mouseover){var h=e.cameraControl,u=n.deltaTime/1e3;if(!i.planView){var c=h._isKeyDownForAction(h.ROTATE_Y_POS,a),p=h._isKeyDownForAction(h.ROTATE_Y_NEG,a),d=h._isKeyDownForAction(h.ROTATE_X_POS,a),f=h._isKeyDownForAction(h.ROTATE_X_NEG,a),_=u*i.keyboardRotationRate;(c||p||d||f)&&(!i.firstPerson&&i.followPointer&&e.pivotController.startPivot(),c?s.rotateDeltaY+=_:p&&(s.rotateDeltaY-=_),d?s.rotateDeltaX+=_:f&&(s.rotateDeltaX-=_),!i.firstPerson&&i.followPointer&&e.pivotController.startPivot())}if(!a[o.KEY_CTRL]&&!a[o.KEY_ALT]){var g=h._isKeyDownForAction(h.DOLLY_BACKWARDS,a),m=h._isKeyDownForAction(h.DOLLY_FORWARDS,a);if(g||m){var v=u*i.keyboardDollyRate;!i.firstPerson&&i.followPointer&&e.pivotController.startPivot(),m?s.dollyDelta-=v:g&&(s.dollyDelta+=v),l&&(r.followPointerDirty=!0,l=!1)}}var b=h._isKeyDownForAction(h.PAN_FORWARDS,a),y=h._isKeyDownForAction(h.PAN_BACKWARDS,a),P=h._isKeyDownForAction(h.PAN_LEFT,a),M=h._isKeyDownForAction(h.PAN_RIGHT,a),x=h._isKeyDownForAction(h.PAN_UP,a),w=h._isKeyDownForAction(h.PAN_DOWN,a),E=(a[o.KEY_ALT]?.3:1)*u*i.keyboardPanRate;(b||y||P||M||x||w)&&(!i.firstPerson&&i.followPointer&&e.pivotController.startPivot(),w?s.panDeltaY+=E:x&&(s.panDeltaY+=-E),M?s.panDeltaX+=-E:P&&(s.panDeltaX+=E),y?s.panDeltaZ+=E:b&&(s.panDeltaZ+=-E))}}))};ic.prototype.reset=function(){},ic.prototype.destroy=function(){this._scene.off(this._onTick),document.removeEventListener("mousemove",this._documentMouseMoveHandler),document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler)};var rc=E.vec3(),sc=function(t,e,i,r,s){this._scene=t;var o=t.camera,a=e.pickController,n=e.pivotController,l=e.panController,h=1,u=1,c=null;this._onTick=t.on("tick",(function(){if(i.active&&i.pointerEnabled){var e="default";if(Math.abs(s.dollyDelta)<.001&&(s.dollyDelta=0),Math.abs(s.rotateDeltaX)<.001&&(s.rotateDeltaX=0),Math.abs(s.rotateDeltaY)<.001&&(s.rotateDeltaY=0),0===s.rotateDeltaX&&0===s.rotateDeltaY||(s.dollyDelta=0),i.followPointer&&--h<=0&&(h=1,0!==s.dollyDelta)){if(0===s.rotateDeltaY&&0===s.rotateDeltaX&&i.followPointer&&r.followPointerDirty&&(a.pickCursorPos=r.pointerCanvasPos,a.schedulePickSurface=!0,a.update(),a.pickResult&&a.pickResult.worldPos?c=a.pickResult.worldPos:(u=1,c=null),r.followPointerDirty=!1),c){var p=Math.abs(E.lenVec3(E.subVec3(c,t.camera.eye,rc)));u=p/i.dollyProximityThreshold}u<i.dollyMinSpeed&&(u=i.dollyMinSpeed)}var d=s.dollyDelta*u;if(0===s.rotateDeltaY&&0===s.rotateDeltaX||(!i.firstPerson&&i.followPointer&&n.getPivoting()?(n.continuePivot(s.rotateDeltaY,s.rotateDeltaX),n.showPivot()):(0!==s.rotateDeltaX&&(i.firstPerson?o.pitch(-s.rotateDeltaX):o.orbitPitch(s.rotateDeltaX)),0!==s.rotateDeltaY&&(i.firstPerson?o.yaw(s.rotateDeltaY):o.orbitYaw(s.rotateDeltaY))),s.rotateDeltaX*=i.rotationInertia,s.rotateDeltaY*=i.rotationInertia,e="grabbing"),Math.abs(s.panDeltaX)<.001&&(s.panDeltaX=0),Math.abs(s.panDeltaY)<.001&&(s.panDeltaY=0),Math.abs(s.panDeltaZ)<.001&&(s.panDeltaZ=0),0!==s.panDeltaX||0!==s.panDeltaY||0!==s.panDeltaZ){var f,_,g=E.vec3();if(g[0]=s.panDeltaX,g[1]=s.panDeltaY,g[2]=s.panDeltaZ,i.constrainVertical){o.xUp?(f=o.eye[0],_=o.look[0]):o.yUp?(f=o.eye[1],_=o.look[1]):o.zUp&&(f=o.eye[2],_=o.look[2]),o.pan(g);var m=o.eye,v=o.look;o.xUp?(m[0]=f,v[0]=_):o.yUp?(m[1]=f,v[1]=_):o.zUp&&(m[2]=f,v[2]=_),o.eye=m,o.look=v}else o.pan(g);e="grabbing"}if(s.panDeltaX*=i.panInertia,s.panDeltaY*=i.panInertia,s.panDeltaZ*=i.panInertia,0!==d){if(e=d<0?"zoom-in":"zoom-out",i.firstPerson){var b,y;if(i.constrainVertical&&(o.xUp?(b=o.eye[0],y=o.look[0]):o.yUp?(b=o.eye[1],y=o.look[1]):o.zUp&&(b=o.eye[2],y=o.look[2])),i.followPointer)l.dollyToCanvasPos(c,r.pointerCanvasPos,-d)&&(r.followPointerDirty=!0);else o.pan([0,0,d]),o.ortho.scale=o.ortho.scale-d;if(i.constrainVertical){var P=o.eye,M=o.look;o.xUp?(P[0]=b,M[0]=y):o.yUp?(P[1]=b,M[1]=y):o.zUp&&(P[2]=b,M[2]=y),o.eye=P,o.look=M}}else if(i.planView){if(i.followPointer)l.dollyToCanvasPos(c,r.pointerCanvasPos,-d)&&(r.followPointerDirty=!0);else o.ortho.scale=o.ortho.scale+d,o.zoom(d)}else{if(i.followPointer)l.dollyToCanvasPos(c,r.pointerCanvasPos,-d)&&(r.followPointerDirty=!0);else o.ortho.scale=o.ortho.scale+d,o.zoom(d)}s.dollyDelta*=i.dollyInertia}a.fireEvents(),document.body.style.cursor=e}}))};sc.prototype.destroy=function(){this._scene.off(this._onTick)};var oc=function(t,e,i,r,s){this._scene=t;var o=this._scene.canvas.canvas;o.addEventListener("mouseenter",this._mouseEnterHandler=function(){r.mouseover=!0}),o.addEventListener("mouseleave",this._mouseLeaveHandler=function(){r.mouseover=!1,o.style.cursor=null}),document.addEventListener("mousemove",this._mouseMoveHandler=function(t){ac(t,o,r.pointerCanvasPos)}),o.addEventListener("mousedown",this._mouseDownHandler=function(t){i.active&&i.pointerEnabled&&(ac(t,o,r.pointerCanvasPos),r.mouseover=!0)}),o.addEventListener("mouseup",this._mouseUpHandler=function(t){i.active&&i.pointerEnabled})};function ac(t,e,i){if(t){var r=e.getBoundingClientRect(),s=r.x,o=r.y;i[0]=t.clientX-s,i[1]=t.clientY-o}else t=window.event,i[0]=t.x,i[1]=t.y;return i}oc.prototype.reset=function(){},oc.prototype.destroy=function(){var t=this._scene.canvas.canvas;document.removeEventListener("mousemove",this._mouseMoveHandler),t.removeEventListener("mouseenter",this._mouseEnterHandler),t.removeEventListener("mouseleave",this._mouseLeaveHandler),t.removeEventListener("mousedown",this._mouseDownHandler),t.removeEventListener("mouseup",this._mouseUpHandler)};var nc=function(t,e){if(t){for(var i=t.target,r=0,s=0;i.offsetParent;)r+=i.offsetLeft,s+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-r,e[1]=t.pageY-s}else t=window.event,e[0]=t.x,e[1]=t.y;return e},lc=function(t,e,i,r,s){this._scene=t;var o=e.pickController,a=e.pivotController,n=E.vec2(),l=E.vec2(),h=E.vec2(),u=E.vec2(),c=[],p=this._scene.canvas.canvas,d=0,f=!1;this._onTick=t.on("tick",(function(){f=!1})),p.addEventListener("touchstart",this._canvasTouchStartHandler=function(e){if(i.active&&i.pointerEnabled){e.preventDefault();var s=e.touches,l=e.changedTouches;for(r.touchStartTime=Date.now(),1===s.length&&1===l.length&&(r.touchStartTime,nc(s[0],n),i.followPointer&&(o.pickCursorPos=n,o.schedulePickSurface=!0,o.update(),i.planView||(o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(a.setPivotPos(o.pickResult.worldPos),!i.firstPerson&&a.startPivot()&&a.showPivot()):(i.smartPivot?a.setCanvasPivotPos(r.pointerCanvasPos):a.setPivotPos(t.camera.look),!i.firstPerson&&a.startPivot()&&a.showPivot()))));c.length<s.length;)c.push(E.vec2());for(var h=0,u=s.length;h<u;++h)nc(s[h],c[h]);d=s.length}}),p.addEventListener("touchmove",this._canvasTouchMoveHandler=function(e){if(i.active&&i.pointerEnabled&&(e.stopPropagation(),e.preventDefault(),!f)){f=!0;var a=t.canvas.boundary,n=a[2]-a[0],p=a[3]-a[1],_=e.touches;if(e.touches.length===d){if(1===d){nc(_[0],l),E.subVec2(l,c[0],u);var g=u[0],m=u[1];if(null!==r.longTouchTimeout&&(Math.abs(g)>i.longTapRadius||Math.abs(m)>i.longTapRadius)&&(clearTimeout(r.longTouchTimeout),r.longTouchTimeout=null),i.planView){var v=t.camera;if("perspective"===v.projection){var b=Math.abs(t.camera.eyeLookDist)*Math.tan(v.perspective.fov/2*Math.PI/180);s.panDeltaX+=g*b/p*i.touchPanRate,s.panDeltaY+=m*b/p*i.touchPanRate}else s.panDeltaX+=.5*v.ortho.scale*(g/p)*i.touchPanRate,s.panDeltaY+=.5*v.ortho.scale*(m/p)*i.touchPanRate}else s.rotateDeltaY-=g/n*(1*i.dragRotationRate),s.rotateDeltaX+=m/p*(1.5*i.dragRotationRate)}else if(2===d){var y=_[0],P=_[1];nc(y,l),nc(P,h);var M=E.geometricMeanVec2(c[0],c[1]),x=E.geometricMeanVec2(l,h),w=E.vec2();E.subVec2(M,x,w);var C=w[0],A=w[1],S=t.camera,D=E.distVec2([y.pageX,y.pageY],[P.pageX,P.pageY]),L=(E.distVec2(c[0],c[1])-D)*i.touchDollyRate;if(s.dollyDelta=L,Math.abs(L)<1)if("perspective"===S.projection){var B=o.pickResult?o.pickResult.worldPos:t.center,R=Math.abs(E.lenVec3(E.subVec3(B,t.camera.eye,[])))*Math.tan(S.perspective.fov/2*Math.PI/180);s.panDeltaX-=C*R/p*i.touchPanRate,s.panDeltaY-=A*R/p*i.touchPanRate}else s.panDeltaX-=.5*S.ortho.scale*(C/p)*i.touchPanRate,s.panDeltaY-=.5*S.ortho.scale*(A/p)*i.touchPanRate;r.pointerCanvasPos=x}for(var T=0;T<d;++T)nc(_[T],c[T])}}})};lc.prototype.reset=function(){},lc.prototype.destroy=function(){var t=this._scene.canvas.canvas;t.removeEventListener("touchstart",this._canvasTouchStartHandler),t.removeEventListener("touchmove",this._canvasTouchMoveHandler),this._scene.off(this._onTick)};var hc=function(t,e,i,r,s){this._scene=t;var o,a=e.pickController,n=e.cameraControl,l=[],h=new Float32Array(2),u=-1,c=-1,p=this._scene.canvas.canvas,d=function(i){var r;i&&i.worldPos&&(r=i.worldPos);var s=i?i.entity.aabb:t.aabb;if(r){var o=t.camera;E.subVec3(o.eye,o.look,[]),e.cameraFlight.flyTo({aabb:s})}else e.cameraFlight.flyTo({aabb:s})};p.addEventListener("touchstart",this._canvasTouchStartHandler=function(t){if(i.active&&i.pointerEnabled){null!==r.longTouchTimeout&&(clearTimeout(r.longTouchTimeout),r.longTouchTimeout=null);var s=t.touches,a=t.changedTouches;if(o=Date.now(),1===s.length&&1===a.length){u=o,h[0]=s[0].pageX,h[1]=s[0].pageY;var n=s[0].clientX,c=s[0].clientY,p=s[0].pageX,d=s[0].pageY;r.longTouchTimeout=setTimeout((function(){e.cameraControl.fire("rightClick",{pagePos:[Math.round(p),Math.round(d)],canvasPos:[Math.round(n),Math.round(c)],event:t},!0),r.longTouchTimeout=null}),i.longTapTimeout)}else u=-1;for(;l.length<s.length;)l.push(new Float32Array(2));for(var f=0,_=s.length;f<_;++f)l[f][0]=s[f].pageX,l[f][1]=s[f].pageY;l.length=s.length}},{passive:!0}),p.addEventListener("touchend",this._canvasTouchEndHandler=function(t){if(i.active&&i.pointerEnabled){var e=Date.now(),s=t.touches,o=t.changedTouches,p=n.hasSubs("pickedSurface");null!==r.longTouchTimeout&&(clearTimeout(r.longTouchTimeout),r.longTouchTimeout=null),0===s.length&&1===o.length&&u>-1&&e-u<150&&(c>-1&&u-c<325?(a.pickCursorPos[0]=Math.round(o[0].clientX),a.pickCursorPos[1]=Math.round(o[0].clientY),a.schedulePickEntity=!0,a.schedulePickSurface=p,a.update(),a.pickResult?(n.fire("doublePicked",a.pickResult),a.pickedSurface&&n.fire("doublePickedSurface",a.pickResult),i.doublePickFlyTo&&d(a.pickResult)):(n.fire("doublePickedNothing"),i.doublePickFlyTo&&d()),c=-1):E.distVec2(l[0],h)<4&&(a.pickCursorPos[0]=Math.round(o[0].clientX),a.pickCursorPos[1]=Math.round(o[0].clientY),a.schedulePickEntity=!0,a.schedulePickSurface=p,a.update(),a.pickResult?(n.fire("picked",a.pickResult),a.pickedSurface&&n.fire("pickedSurface",a.pickResult)):n.fire("pickedNothing"),c=e),u=-1),l.length=s.length;for(var f=0,_=s.length;f<_;++f)l[f][0]=s[f].pageX,l[f][1]=s[f].pageY;t.stopPropagation()}},{passive:!0})};hc.prototype.reset=function(){},hc.prototype.destroy=function(){var t=this._scene.canvas.canvas;t.removeEventListener("touchstart",this._canvasTouchStartHandler),t.removeEventListener("touchend",this._canvasTouchEndHandler)};var uc=function(t){function e(e,i){void 0===i&&(i={}),t.call(this,e,i),this.PAN_LEFT=0,this.PAN_RIGHT=1,this.PAN_UP=2,this.PAN_DOWN=3,this.PAN_FORWARDS=4,this.PAN_BACKWARDS=5,this.ROTATE_X_POS=6,this.ROTATE_X_NEG=7,this.ROTATE_Y_POS=8,this.ROTATE_Y_NEG=9,this.DOLLY_FORWARDS=10,this.DOLLY_BACKWARDS=11,this.AXIS_VIEW_RIGHT=12,this.AXIS_VIEW_BACK=13,this.AXIS_VIEW_LEFT=14,this.AXIS_VIEW_FRONT=15,this.AXIS_VIEW_TOP=16,this.AXIS_VIEW_BOTTOM=17,this._keyMap={},this.scene.canvas.canvas.oncontextmenu=function(t){t.preventDefault()},this._configs={longTapTimeout:600,longTapRadius:5,active:!0,keyboardLayout:"qwerty",navMode:"orbit",planView:!1,firstPerson:!1,followPointer:!0,doublePickFlyTo:!0,panRightClick:!0,showPivot:!1,pointerEnabled:!0,constrainVertical:!1,smartPivot:!1,dragRotationRate:360,keyboardRotationRate:90,rotationInertia:0,keyboardPanRate:1,touchPanRate:1,panInertia:.5,keyboardDollyRate:10,mouseWheelDollyRate:100,touchDollyRate:.2,dollyInertia:0,dollyProximityThreshold:30,dollyMinSpeed:.04},this._states={pointerCanvasPos:E.vec2(),mouseover:!1,followPointerDirty:!0,mouseDownClientX:0,mouseDownClientY:0,mouseDownCursorX:0,mouseDownCursorY:0,touchStartTime:null,activeTouches:[],tapStartPos:E.vec2(),tapStartTime:-1,lastTapTime:-1,longTouchTimeout:null},this._updates={rotateDeltaX:0,rotateDeltaY:0,panDeltaX:0,panDeltaY:0,panDeltaZ:0,dollyDelta:0};var r=this.scene;this._controllers={cameraControl:this,pickController:new Wu(this,this._configs),pivotController:new Xu(r,this._configs),panController:new ku(r),cameraFlight:new su(this,{duration:.5})},this._handlers=[new oc(this.scene,this._controllers,this._configs,this._states,this._updates),new lc(this.scene,this._controllers,this._configs,this._states,this._updates),new Yu(this.scene,this._controllers,this._configs,this._states,this._updates),new tc(this.scene,this._controllers,this._configs,this._states,this._updates),new ec(this.scene,this._controllers,this._configs,this._states,this._updates),new hc(this.scene,this._controllers,this._configs,this._states,this._updates),new ic(this.scene,this._controllers,this._configs,this._states,this._updates)],this._cameraUpdater=new sc(this.scene,this._controllers,this._configs,this._states,this._updates),this.navMode=i.navMode,i.planView&&(this.planView=i.planView),this.constrainVertical=i.constrainVertical,i.keyboardLayout?this.keyboardLayout=i.keyboardLayout:this.keyMap=i.keyMap,this.doublePickFlyTo=i.doublePickFlyTo,this.panRightClick=i.panRightClick,this.active=i.active,this.followPointer=i.followPointer,this.rotationInertia=i.rotationInertia,this.keyboardPanRate=i.keyboardPanRate,this.touchPanRate=i.touchPanRate,this.keyboardRotationRate=i.keyboardRotationRate,this.dragRotationRate=i.dragRotationRate,this.touchDollyRate=i.touchDollyRate,this.dollyInertia=i.dollyInertia,this.dollyProximityThreshold=i.dollyProximityThreshold,this.dollyMinSpeed=i.dollyMinSpeed,this.panInertia=i.panInertia,this.pointerEnabled=!0,this.keyboardDollyRate=i.keyboardDollyRate,this.mouseWheelDollyRate=i.mouseWheelDollyRate}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var i={keyMap:{configurable:!0},pivotElement:{configurable:!0},active:{configurable:!0},navMode:{configurable:!0},pointerEnabled:{configurable:!0},followPointer:{configurable:!0},pivotPos:{configurable:!0},dollyToPointer:{configurable:!0},panToPointer:{configurable:!0},planView:{configurable:!0},firstPerson:{configurable:!0},constrainVertical:{configurable:!0},doublePickFlyTo:{configurable:!0},panRightClick:{configurable:!0},rotationInertia:{configurable:!0},keyboardPanRate:{configurable:!0},touchPanRate:{configurable:!0},keyboardRotationRate:{configurable:!0},dragRotationRate:{configurable:!0},keyboardDollyRate:{configurable:!0},touchDollyRate:{configurable:!0},mouseWheelDollyRate:{configurable:!0},dollyInertia:{configurable:!0},dollyProximityThreshold:{configurable:!0},dollyMinSpeed:{configurable:!0},panInertia:{configurable:!0},keyboardLayout:{configurable:!0},smartPivot:{configurable:!0}};return i.keyMap.set=function(t){if(t=t||"qwerty",B.isString(t)){var e=this.scene.input,i={};switch(t){default:this.error("Unsupported value for 'keyMap': "+t+" defaulting to 'qwerty'");case"qwerty":i[this.PAN_LEFT]=[e.KEY_A],i[this.PAN_RIGHT]=[e.KEY_D],i[this.PAN_UP]=[e.KEY_Z],i[this.PAN_DOWN]=[e.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[e.KEY_W,e.KEY_ADD],i[this.DOLLY_BACKWARDS]=[e.KEY_S,e.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[e.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[e.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[e.KEY_Q,e.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[e.KEY_E,e.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[e.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[e.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[e.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[e.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[e.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[e.KEY_NUM_6];break;case"azerty":i[this.PAN_LEFT]=[e.KEY_Q],i[this.PAN_RIGHT]=[e.KEY_D],i[this.PAN_UP]=[e.KEY_W],i[this.PAN_DOWN]=[e.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[e.KEY_Z,e.KEY_ADD],i[this.DOLLY_BACKWARDS]=[e.KEY_S,e.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[e.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[e.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[e.KEY_A,e.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[e.KEY_E,e.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[e.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[e.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[e.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[e.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[e.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[e.KEY_NUM_6]}this._keyMap=i}else{var r=t;this._keyMap=r}},i.keyMap.get=function(){return this._keyMap},e.prototype._isKeyDownForAction=function(t,e){var i=this._keyMap[t];if(!i)return!1;e||(e=this.scene.input.keyDown);for(var r=0,s=i.length;r<s;r++){if(e[i[r]])return!0}return!1},i.pivotElement.set=function(t){this._controllers.pivotController.setPivotElement(t)},i.active.set=function(t){this._configs.active=!1!==t},i.active.get=function(){return this._configs.active},i.navMode.set=function(t){"firstPerson"!==(t=t||"orbit")&&"orbit"!==t&&"planView"!==t&&(this.error("Unsupported value for navMode: "+t+" - supported values are 'orbit', 'firstPerson' and 'planView' - defaulting to 'orbit'"),t="orbit"),this._configs.firstPerson="firstPerson"===t,this._configs.planView="planView"===t,(this._configs.firstPerson||this._configs.planView)&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this._configs.navMode=t},i.navMode.get=function(){return this._configs.navMode},i.pointerEnabled.set=function(t){this._reset(),this._configs.pointerEnabled=!!t},e.prototype._reset=function(){for(var t=0,e=this._handlers.length;t<e;t++){var i=this._handlers[t];i.reset&&i.reset()}this._updates.panDeltaX=0,this._updates.panDeltaY=0,this._updates.rotateDeltaX=0,this._updates.rotateDeltaY=0,this._updates.dolyDelta=0},i.pointerEnabled.get=function(){return this._configs.pointerEnabled},i.followPointer.set=function(t){this._configs.followPointer=!1!==t},i.followPointer.get=function(){return this._configs.followPointer},i.pivotPos.set=function(t){this._controllers.pivotController.setPivotPos(t)},i.pivotPos.get=function(){return this._controllers.pivotController.getPivotPos()},i.dollyToPointer.set=function(t){this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer=t},i.dollyToPointer.get=function(){return this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer},i.panToPointer.set=function(t){this.warn("panToPointer property is deprecated - replaced with followPointer")},i.panToPointer.get=function(){return this.warn("panToPointer property is deprecated - replaced with followPointer"),!1},i.planView.set=function(t){this._configs.planView=!!t,this._configs.firstPerson=!1,this._configs.planView&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this.warn("planView property is deprecated - replaced with navMode")},i.planView.get=function(){return this.warn("planView property is deprecated - replaced with navMode"),this._configs.planView},i.firstPerson.set=function(t){this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson=!!t,this._configs.planView=!1,this._configs.firstPerson&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot())},i.firstPerson.get=function(){return this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson},i.constrainVertical.set=function(t){this._configs.constrainVertical=!!t},i.constrainVertical.get=function(){return this._configs.constrainVertical},i.doublePickFlyTo.set=function(t){this._configs.doublePickFlyTo=!1!==t},i.doublePickFlyTo.get=function(){return this._configs.doublePickFlyTo},i.panRightClick.set=function(t){this._configs.panRightClick=!1!==t},i.panRightClick.get=function(){return this._configs.panRightClick},i.rotationInertia.set=function(t){this._configs.rotationInertia=null!=t?t:0},i.rotationInertia.get=function(){return this._configs.rotationInertia},i.keyboardPanRate.set=function(t){this._configs.keyboardPanRate=null!=t?t:5},i.touchPanRate.set=function(t){this._configs.touchPanRate=null!=t?t:1},i.touchPanRate.get=function(){return this._configs.touchPanRate},i.keyboardPanRate.get=function(){return this._configs.keyboardPanRate},i.keyboardRotationRate.set=function(t){this._configs.keyboardRotationRate=null!=t?t:90},i.keyboardRotationRate.get=function(){return this._configs.keyboardRotationRate},i.dragRotationRate.set=function(t){this._configs.dragRotationRate=null!=t?t:360},i.dragRotationRate.get=function(){return this._configs.dragRotationRate},i.keyboardDollyRate.set=function(t){this._configs.keyboardDollyRate=null!=t?t:15},i.keyboardDollyRate.get=function(){return this._configs.keyboardDollyRate},i.touchDollyRate.set=function(t){this._configs.touchDollyRate=null!=t?t:.2},i.touchDollyRate.get=function(){return this._configs.touchDollyRate},i.mouseWheelDollyRate.set=function(t){this._configs.mouseWheelDollyRate=null!=t?t:100},i.mouseWheelDollyRate.get=function(){return this._configs.mouseWheelDollyRate},i.dollyInertia.set=function(t){this._configs.dollyInertia=null!=t?t:0},i.dollyInertia.get=function(){return this._configs.dollyInertia},i.dollyProximityThreshold.set=function(t){this._configs.dollyProximityThreshold=null!=t?t:35},i.dollyProximityThreshold.get=function(){return this._configs.dollyProximityThreshold},i.dollyMinSpeed.set=function(t){this._configs.dollyMinSpeed=null!=t?t:.04},i.dollyMinSpeed.get=function(){return this._configs.dollyMinSpeed},i.panInertia.set=function(t){this._configs.panInertia=null!=t?t:.5},i.panInertia.get=function(){return this._configs.panInertia},i.keyboardLayout.set=function(t){"qwerty"!==(t=t||"qwerty")&&"azerty"!==t&&(this.error("Unsupported value for keyboardLayout - defaulting to 'qwerty'"),t="qwerty"),this._configs.keyboardLayout=t,this.keyMap=this._configs.keyboardLayout},i.keyboardLayout.get=function(){return this._configs.keyboardLayout},i.smartPivot.set=function(t){this._configs.smartPivot=!1!==t},i.smartPivot.get=function(){return this._configs.smartPivot},e.prototype.destroy=function(){this._destroyHandlers(),this._destroyControllers(),this._cameraUpdater.destroy(),t.prototype.destroy.call(this)},e.prototype._destroyHandlers=function(){for(var t=0,e=this._handlers.length;t<e;t++){var i=this._handlers[t];i.destroy&&i.destroy()}},e.prototype._destroyControllers=function(){for(var t=0,e=this._controllers.length;t<e;t++){var i=this._controllers[t];i.destroy&&i.destroy()}},Object.defineProperties(e.prototype,i),e}(U),cc=function(t,e,i,r,s,o,a,n,l,h){this.id=e,this.projectId=i,this.revisionId=r,this.author=s,this.createdAt=o,this.creatingApplication=a,this.schema=n,this.metaScene=t,this.propertySets=l,this.rootMetaObject=h};cc.prototype.getJSON=function(){var t=[];return function e(i){var r={id:i.id,extId:i.extId,type:i.type,name:i.name};i.parent&&(r.parent=i.parent.id),t.push(r);var s=i.children;if(s)for(var o=0,a=s.length;o<a;o++)e(s[o])}(this.rootMetaObject),{id:this.id,projectId:this.projectId,revisionId:this.revisionId,metaObjects:t}};var pc=function(t,e,i,r,s,o,a,n,l){this.metaModel=t,this.id=e,this.originalSystemId=i,this.name=r,this.type=s,this.propertySets=o,null!=a&&(this.parent=a),null!=n&&(this.children=n),null!=l&&(this.external=l)};pc.prototype.getObjectIDsInSubtree=function(){var t=[];return function e(i){if(i){t.push(i.id);var r=i.children;if(r)for(var s=0,o=r.length;s<o;s++)e(r[s])}}(this),t},pc.prototype.withMetaObjectsInSubtree=function(t){!function e(i){if(i){t(i);var r=i.children;if(r)for(var s=0,o=r.length;s<o;s++)e(r[s])}}(this)},pc.prototype.getObjectIDsInSubtreeByType=function(t){for(var e={},i=0,r=t.length;i<r;i++)e[t[i]]=t[i];var s=[];return function t(i){if(i){e[i.type]&&s.push(i.id);var r=i.children;if(r)for(var o=0,a=r.length;o<a;o++)t(r[o])}}(this),s},pc.prototype.getJSON=function(){var t={id:this.id,type:this.type,name:this.name};return this.parent&&(t.parent=this.parent.id),t};var dc=function(t,e,i,r,s){this.name=t,this.type=i,this.value=e,this.valueType=r,this.description=s},fc=function(t,e,i,r,s){if(this.id=t,this.originalSystemId=e,this.name=i,this.type=r,this.properties=[],s)for(var o=0,a=s.length;o<a;o++){var n=s[o];this.properties.push(new dc(n.label,n.value,n.type,n.valueType,n.description))}},_c=function(t,e){this.viewer=t,this.scene=e,this.metaModels={},this.propertySets={},this.metaObjects={},this.metaObjectsByType={},this._typeCounts={},this._eventSubs={}};function gc(t){for(var e={},i=0,r=t.length;i<r;i++)e[t[i]]=!0;return e}_c.prototype.on=function(t,e){var i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)},_c.prototype.fire=function(t,e){var i=this._eventSubs[t];if(i)for(var r=0,s=i.length;r<s;r++)i[r](e)},_c.prototype.off=function(t){},_c.prototype.createMetaModel=function(t,e,i){void 0===i&&(i={});var r=e.projectId||"none",s=e.revisionId||"none",o=e.propertySets||[],a=e.metaObjects||[],n=e.author,l=e.createdAt,h=e.creatingApplication,u=e.schema,c=new cc(this,t,r,s,n,l,h,u,[],null);this.metaModels[t]=c;for(var p=0,d=o.length;p<d;p++){var f=o[p],_=f.id,g=new fc(_,f.originalSystemId,f.name,f.type,f.properties);c.propertySets[_]=g,this.propertySets[_]=g}for(var m=[],v=0,b=a.length;v<b;v++){var y=a[v];void 0!==y.parent&&null!==y.parent||m.push(y)}if(0===m.length){this.scene.error("Cyclic containment hierarchy found in metamodel - will flatten the hierarchy and insert fake 'Model' root");for(var P={id:t+".fakeRoot",name:t,type:"Model",parent:null},M=0,x=a.length;M<x;M++)a[M].parent=P.id;a.push(P)}if(m.length>1){this.scene.error("Multiple containment hierarchy root found in metamodel - will insert fake 'Model' root");var w={id:t+".fakeRoot",name:t,type:"Model",parent:null};a.push(w);for(var C=0,A=m.length;C<A;C++)m[C].parent=w.id}for(var S=0,D=a.length;S<D;S++){var L=a[S],B=L.type,R=i.globalizeObjectIds?E.globalizeObjectId(t,L.id):L.id,T=L.id,F=L.name,N=[];if(L.propertySetIds&&L.propertySetIds.length>0)for(var I=0,k=L.propertySetIds.length;I<k;I++){var O=L.propertySetIds[I],V=c.propertySets[O];V&&N.push(V)}var z=L.external,U=new pc(c,R,T,F,B,N,null,null,z);this.metaObjects[R]=U,(this.metaObjectsByType[B]||(this.metaObjectsByType[B]={}))[R]=U,void 0===this._typeCounts[B]?this._typeCounts[B]=1:this._typeCounts[B]++}for(var j=0,G=a.length;j<G;j++){var X=a[j],W=i.globalizeObjectIds?E.globalizeObjectId(t,X.id):X.id,H=this.metaObjects[W];if(H)if(void 0===X.parent||null===X.parent)c.rootMetaObject=H;else if(X.parent){var Y=i.globalizeObjectIds?E.globalizeObjectId(t,X.parent):X.parent,K=this.metaObjects[Y];K&&(H.parent=K,K.children=K.children||[],K.children.push(H))}}return this.fire("metaModelCreated",t),c},_c.prototype.destroyMetaModel=function(t){var e=this.metaModels[t];e&&(this._removeMetaModel(e),this.fire("metaModelDestroyed",t))},_c.prototype._removeMetaModel=function(t){var e=this,i=this.metaObjects,r=this.metaObjectsByType,s=function(t){delete i[t.id];var o=r[t.type];o&&o[t.id]&&(delete o[t.id],0==--e._typeCounts[t.type]&&(delete e._typeCounts[t.type],delete r[t.type]));var a=t.children;if(a)for(var n=0,l=a.length;n<l;n++){var h=a[n];s(h)}};for(var o in s(t.rootMetaObject),t.propertySets)t.propertySets.hasOwnProperty(o)&&delete this.propertySets[o];delete this.metaModels[t.id]},_c.prototype.getObjectIDsByType=function(t){var e=this.metaObjectsByType[t];return e?Object.keys(e):[]},_c.prototype.getObjectIDsInSubtree=function(t,e,i){var r=[],s=this.metaObjects[t],o=e&&e.length>0?gc(e):null,a=i&&i.length>0?gc(i):null;return function t(e){if(e){var i=!0;(a&&a[e.type]||o&&!o[e.type])&&(i=!1),i&&r.push(e.id);var s=e.children;if(s)for(var n=0,l=s.length;n<l;n++)t(s[n])}}(s),r},_c.prototype.withMetaObjectsInSubtree=function(t,e){var i=this.metaObjects[t];i&&i.withMetaObjectsInSubtree(e)};var mc=function(t){this.language="en",this.localeService=t.localeService||new Wh,this.scene=new ei(this,{canvasId:t.canvasId,canvasElement:t.canvasElement,webgl2:!1,contextAttr:{preserveDrawingBuffer:!1!==t.preserveDrawingBuffer,premultipliedAlpha:!!t.premultipliedAlpha,antialias:!1!==t.antialias},spinnerElementId:t.spinnerElementId,transparent:!1!==t.transparent,gammaInput:!0,gammaOutput:!1,backgroundColor:t.backgroundColor,backgroundColorFromAmbientLight:t.backgroundColorFromAmbientLight,ticksPerRender:1,ticksPerOcclusionTest:20,units:t.units,scale:t.scale,origin:t.origin,saoEnabled:t.saoEnabled,alphaDepthMask:!1!==t.alphaDepthMask,entityOffsetsEnabled:!!t.entityOffsetsEnabled,pickSurfacePrecisionEnabled:!!t.pickSurfacePrecisionEnabled,logarithmicDepthBufferEnabled:!!t.logarithmicDepthBufferEnabled,pbrEnabled:!!t.pbrEnabled}),this.metaScene=new _c(this,this.scene),this.id=t.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new su(this.scene,{duration:.5}),this.cameraControl=new uc(this.scene,{doublePickFlyTo:!0}),this._plugins=[],this._eventSubs={}};mc.prototype.on=function(t,e){var i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)},mc.prototype.fire=function(t,e){var i=this._eventSubs[t];if(i)for(var r=0,s=i.length;r<s;r++)i[r](e)},mc.prototype.off=function(t){},mc.prototype.log=function(t){console.log("[xeokit viewer "+this.id+"]: "+t)},mc.prototype.error=function(t){console.error("[xeokit viewer "+this.id+"]: "+t)},mc.prototype.addPlugin=function(t){this._plugins.push(t)},mc.prototype.removePlugin=function(t){for(var e=0,i=this._plugins.length;e<i;e++){var r=this._plugins[e];if(r===t)return r.clear&&r.clear(),void this._plugins.splice(e,1)}},mc.prototype.sendToPlugins=function(t,e){for(var i=0,r=this._plugins.length;i<r;i++){var s=this._plugins[i];s.send&&s.send(t,e)}},mc.prototype.clear=function(){throw'Viewer#clear() no longer implemented - use \'#sendToPlugins("clear") instead'},mc.prototype.resetView=function(){throw"Viewer#resetView() no longer implemented - use CameraMemento & ObjectsMemento classes instead"},mc.prototype.beginSnapshot=function(){this._snapshotBegun||(this.scene._renderer.beginSnapshot(),this._snapshotBegun=!0)},mc.prototype.getSnapshot=function(t){void 0===t&&(t={});var e=!this._snapshotBegun;this._snapshotBegun||this.beginSnapshot(),t.includeGizmos||this.sendToPlugins("snapshotStarting");var i=void 0!==t.width&&void 0!==t.height,r=this.scene.canvas.canvas,s=r.clientWidth,o=r.clientHeight,a=r.style.width,n=r.style.height,l=t.width?Math.floor(t.width):r.width,h=t.height?Math.floor(t.height):r.height;i&&(r.style.width=l+"px",r.style.height=h+"px"),this.scene._renderer.renderSnapshot();var u=this.scene._renderer.readSnapshot(t);return i&&(r.style.width=a,r.style.height=n,r.width=s,r.height=o,this.scene.glRedraw()),t.includeGizmos||this.sendToPlugins("snapshotFinished"),e&&this.endSnapshot(),u},mc.prototype.endSnapshot=function(){this._snapshotBegun&&(this.scene._renderer.endSnapshot(),this.scene._renderer.render({force:!0}),this._snapshotBegun=!1)},mc.prototype.destroy=function(){for(var t=this._plugins.slice(),e=0,i=t.length;e<i;e++){t[e].destroy()}this.scene.destroy()};export{Ce as AmbientLight,mt as AngleMeasurementsPlugin,Mt as AnnotationsPlugin,Ji as AxisGizmoPlugin,er as BCFViewpointsPlugin,Sl as CameraMemento,Jh as CameraPath,ou as CameraPathAnimation,U as Component,o as ContextMenu,Cu as CubicBezierCurve,qh as Curve,Ee as DirLight,ur as DistanceMeasurementsPlugin,He as EdgeMaterial,Xe as EmphasisMaterial,cr as FastNavPlugin,xu as Fresnel,dr as GLTFDefaultDataSource,Xn as GLTFLoaderPlugin,gu as ImagePlane,Dh as LambertMaterial,Mu as LightMap,Wh as LocaleService,t as Map,ht as Marker,Hi as Mesh,En as MetallicMaterial,Eu as ModelMemento,Hn as NavCubePlugin,mn as Node,el as OBJLoaderPlugin,Al as ObjectsMemento,Au as Path,nn as PerformanceModel,je as PhongMaterial,n as Plugin,mu as PointLight,Su as QuadraticBezierCurve,C as Queue,ke as ReadableGeometry,Pu as ReflectionMap,fl as STLDefaultDataSource,xl as STLLoaderPlugin,$i as SectionPlane,cl as SectionPlanesPlugin,pl as Skybox,dl as SkyboxesPlugin,Sn as SpecularMaterial,Zh as SplineCurve,Rl as StoreyViewsPlugin,In as Texture,kl as TreeViewPlugin,Mn as VBOGeometry,Yl as ViewCullPlugin,mc as Viewer,Kl as XKTDefaultDataSource,Sh as XKTLoaderPlugin,Xh as XML3DLoaderPlugin,Oe as buildBoxGeometry,hu as buildBoxLinesGeometry,Ki as buildCylinderGeometry,uu as buildGridGeometry,cu as buildPlaneGeometry,qi as buildSphereGeometry,il as buildTorusGeometry,Qi as buildVectorTextGeometry,nu as load3DSGeometry,lu as loadOBJGeometry,E as math,B as utils};
